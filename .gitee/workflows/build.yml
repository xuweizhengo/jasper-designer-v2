name: "Build Jasper Designer V2"

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target platform'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - linux
        - macos

env:
  WORKING_DIR: v2-tauri
  NODE_VERSION: '18'
  RUST_VERSION: 'stable'

jobs:
  # ===============================================
  # Windows æž„å»ºä»»åŠ¡
  # ===============================================
  build-windows:
    name: "Build for Windows"
    runs-on: windows-latest
    if: github.event.inputs.target == 'windows' || github.event.inputs.target == 'all' || github.event.inputs.target == ''
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: "ðŸ¦€ Setup Rust toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-msvc

      - name: "ðŸŽ¯ Install Rust targets"
        run: rustup target add x86_64-pc-windows-msvc

      - name: "ðŸ“‹ Cache Cargo dependencies"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ env.WORKING_DIR }}/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles(format('{0}/src-tauri/Cargo.lock', env.WORKING_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: "ðŸ“¦ Install Node.js dependencies"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: "ðŸ”¨ Build Tauri application"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run tauri build -- --target x86_64-pc-windows-msvc

      - name: "ðŸ“ List build artifacts"
        working-directory: ${{ env.WORKING_DIR }}/src-tauri/target/x86_64-pc-windows-msvc/release
        run: |
          echo "=== Build Artifacts ==="
          dir /s *.exe
          dir /s *.msi 2>nul || echo "No MSI files found"
          dir /s *.nsis 2>nul || echo "No NSIS files found"

      - name: "ðŸš€ Upload Windows artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: jasper-designer-windows-x64
          path: |
            ${{ env.WORKING_DIR }}/src-tauri/target/x86_64-pc-windows-msvc/release/*.exe
            ${{ env.WORKING_DIR }}/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
            ${{ env.WORKING_DIR }}/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          retention-days: 30

  # ===============================================
  # Linux æž„å»ºä»»åŠ¡
  # ===============================================
  build-linux:
    name: "Build for Linux"
    runs-on: ubuntu-latest
    if: github.event.inputs.target == 'linux' || github.event.inputs.target == 'all' || github.event.inputs.target == ''
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libayatana-appindicator3-dev

      - name: "ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: "ðŸ¦€ Setup Rust toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: "ðŸ“‹ Cache Cargo dependencies"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ env.WORKING_DIR }}/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles(format('{0}/src-tauri/Cargo.lock', env.WORKING_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: "ðŸ“¦ Install Node.js dependencies"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: "ðŸ”¨ Build Tauri application"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run tauri build

      - name: "ðŸ“ List build artifacts"
        working-directory: ${{ env.WORKING_DIR }}/src-tauri/target/release
        run: |
          echo "=== Build Artifacts ==="
          find . -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" | head -20
          ls -la bundle/ 2>/dev/null || echo "No bundle directory found"

      - name: "ðŸš€ Upload Linux artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: jasper-designer-linux-x64
          path: |
            ${{ env.WORKING_DIR }}/src-tauri/target/release/bundle/deb/*.deb
            ${{ env.WORKING_DIR }}/src-tauri/target/release/bundle/appimage/*.AppImage
            ${{ env.WORKING_DIR }}/src-tauri/target/release/bundle/rpm/*.rpm
            ${{ env.WORKING_DIR }}/src-tauri/target/release/jasper-designer
          retention-days: 30

  # ===============================================
  # macOS æž„å»ºä»»åŠ¡
  # ===============================================
  build-macos:
    name: "Build for macOS"
    runs-on: macos-latest
    if: github.event.inputs.target == 'macos' || github.event.inputs.target == 'all' || github.event.inputs.target == ''
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: "ðŸ¦€ Setup Rust toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: "ðŸ“‹ Cache Cargo dependencies"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ env.WORKING_DIR }}/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles(format('{0}/src-tauri/Cargo.lock', env.WORKING_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: "ðŸ“¦ Install Node.js dependencies"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: "ðŸ”¨ Build Tauri application (Intel)"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run tauri build -- --target x86_64-apple-darwin

      - name: "ðŸ”¨ Build Tauri application (Apple Silicon)"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run tauri build -- --target aarch64-apple-darwin

      - name: "ðŸ“ List build artifacts"
        working-directory: ${{ env.WORKING_DIR }}/src-tauri/target
        run: |
          echo "=== Intel Build Artifacts ==="
          find x86_64-apple-darwin/release -name "*.dmg" -o -name "*.app" 2>/dev/null || echo "No Intel artifacts found"
          echo "=== Apple Silicon Build Artifacts ==="
          find aarch64-apple-darwin/release -name "*.dmg" -o -name "*.app" 2>/dev/null || echo "No ARM artifacts found"

      - name: "ðŸš€ Upload macOS artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: jasper-designer-macos-universal
          path: |
            ${{ env.WORKING_DIR }}/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            ${{ env.WORKING_DIR }}/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            ${{ env.WORKING_DIR }}/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
            ${{ env.WORKING_DIR }}/src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
          retention-days: 30

  # ===============================================
  # åˆ›å»º Releaseï¼ˆä»…åœ¨æ‰“æ ‡ç­¾æ—¶ï¼‰
  # ===============================================
  create-release:
    name: "Create Release"
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v3

      - name: "ðŸ“¦ Download all artifacts"
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: "ðŸ“ List downloaded artifacts"
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f | head -20

      - name: "ðŸš€ Create Release"
        uses: softprops/action-gh-release@v1
        with:
          name: "Jasper Designer V2 ${{ github.ref_name }}"
          body: |
            ## ðŸŽ‰ Jasper Designer V2 ${{ github.ref_name }}
            
            ### ðŸ“¦ å®‰è£…åŒ…ä¸‹è½½
            
            **Windows:**
            - `*.exe` - ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
            - `*.msi` - Windows å®‰è£…åŒ…
            
            **Linux:**
            - `*.deb` - Debian/Ubuntu å®‰è£…åŒ…
            - `*.AppImage` - é€šç”¨ Linux åº”ç”¨
            - `*.rpm` - RedHat/CentOS å®‰è£…åŒ…
            
            **macOS:**
            - `*.dmg` - macOS å®‰è£…åŒ…
            - Intel å’Œ Apple Silicon é€šç”¨æ”¯æŒ
            
            ### ðŸ”§ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (x64)
            - Linux (x64) with GTK3
            - macOS 10.15+ (Intel/Apple Silicon)
            
            ### ðŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡é—®é¢˜è¯·åœ¨ [Issues](../../issues) ä¸­åé¦ˆ
            
            ---
            
            **æž„å»ºä¿¡æ¯:**
            - æž„å»ºæ—¶é—´: ${{ steps.date.outputs.date }}
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          files: |
            artifacts/jasper-designer-windows-x64/*
            artifacts/jasper-designer-linux-x64/*
            artifacts/jasper-designer-macos-universal/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ“… Get current date"
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  # ===============================================
  # æž„å»ºçŠ¶æ€é€šçŸ¥
  # ===============================================
  notify:
    name: "Build Status Notification"
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: "ðŸ“Š Collect build results"
        run: |
          echo "Windows Build: ${{ needs.build-windows.result }}"
          echo "Linux Build: ${{ needs.build-linux.result }}"
          echo "macOS Build: ${{ needs.build-macos.result }}"
          
          if [[ "${{ needs.build-windows.result }}" == "success" && "${{ needs.build-linux.result }}" == "success" && "${{ needs.build-macos.result }}" == "success" ]]; then
            echo "ðŸŽ‰ All builds successful!"
            echo "build_status=success" >> $GITHUB_ENV
          else
            echo "âŒ Some builds failed"
            echo "build_status=failure" >> $GITHUB_ENV
          fi