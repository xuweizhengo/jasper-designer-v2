name: Deploy and Notify

on:
  workflow_run:
    workflows: ["Build Windows and Notify Server"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Download artifacts from build
      uses: actions/github-script@v7
      with:
        script: |
          let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
          });
          let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
            return artifact.name.startsWith("jasper-designer-windows")
          })[0];
          if (matchArtifact) {
            let download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id,
                archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/build.zip`, Buffer.from(download.data));
            console.log(`Downloaded ${matchArtifact.name}`);
            core.setOutput('artifact_name', matchArtifact.name);
          }

    - name: Extract build package
      run: |
        unzip build.zip -d ./
        ls -la

    - name: Upload to server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "*.zip"
        target: "/root/project/jasper/builds/github-actions/"

    - name: Create notification on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # è·å–æœ€æ–°çš„æ„å»ºæ–‡ä»¶
          cd /root/project/jasper/builds/github-actions/
          LATEST_BUILD=$(ls -t jasper-designer-*.zip 2>/dev/null | head -1)

          # åˆ›å»ºé€šçŸ¥æ–‡ä»¶
          cat > /root/NEW_GITHUB_BUILD_READY.txt << EOF
          =====================================
          ğŸ‰ GitHub Actions æ„å»ºå®Œæˆï¼
          =====================================
          é¡¹ç›®: Jasper Designer V2
          æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          æ„å»ºæ–‡ä»¶: $LATEST_BUILD
          åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}
          æäº¤: ${{ github.event.workflow_run.head_sha }}

          ğŸ“¦ ä¸‹è½½å‘½ä»¤:
          scp root@43.160.200.239:/root/project/jasper/builds/github-actions/$LATEST_BUILD ./

          âœ… æ„å»ºçŠ¶æ€: æˆåŠŸ
          =====================================
          EOF

          echo "Build deployed: $LATEST_BUILD"

    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: âœ… Jasper Designer æ„å»ºæˆåŠŸ - ${{ github.event.workflow_run.head_branch }}
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
        body: |
          æ„å»ºæˆåŠŸå®Œæˆï¼

          ğŸ“¦ æ„å»ºä¿¡æ¯ï¼š
          - åˆ†æ”¯ï¼š${{ github.event.workflow_run.head_branch }}
          - æäº¤ï¼š${{ github.event.workflow_run.head_sha }}
          - è¿è¡ŒIDï¼š${{ github.event.workflow_run.id }}
          - æ—¶é—´ï¼š${{ github.event.workflow_run.created_at }}

          ğŸ“¥ ä¸‹è½½åœ°å€ï¼š
          æœåŠ¡å™¨è·¯å¾„ï¼š/root/project/jasper/builds/github-actions/

          ä¸‹è½½å‘½ä»¤ï¼š
          scp root@43.160.200.239:/root/project/jasper/builds/github-actions/jasper-designer-*.zip ./

          ğŸ”— æŸ¥çœ‹è¯¦æƒ…ï¼š
          ${{ github.event.workflow_run.html_url }}

          ---
          è‡ªåŠ¨æ„å»ºç³»ç»Ÿ