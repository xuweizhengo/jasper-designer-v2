(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const Fr=!1,Gr=(n,e)=>n===e,Dt=Symbol("solid-proxy"),vi=Symbol("solid-track"),Nn={equals:Gr};let Ls=Fs;const wt=1,zn=2,Ms={owned:null,cleanups:null,context:null,owner:null};var Ge=null;let Zn=null,Br=null,He=null,Ve=null,ft=null,Yn=0;function Dn(n,e){const t=He,i=Ge,s=n.length===0,r=e===void 0?i:e,a=s?Ms:{owned:null,cleanups:null,context:r?r.context:null,owner:r},l=s?n:()=>n(()=>it(()=>gn(a)));Ge=a,He=null;try{return Vt(l,!0)}finally{He=t,Ge=i}}function J(n,e){e=e?Object.assign({},Nn,e):Nn;const t={value:n,observers:null,observerSlots:null,comparator:e.equals||void 0},i=s=>(typeof s=="function"&&(s=s(t.value)),zs(t,s));return[Ns.bind(t),i]}function G(n,e,t){const i=Ri(n,e,!1,wt);bn(i)}function mn(n,e,t){Ls=Wr;const i=Ri(n,e,!1,wt);i.user=!0,ft?ft.push(i):bn(i)}function Me(n,e,t){t=t?Object.assign({},Nn,t):Nn;const i=Ri(n,e,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=t.equals||void 0,bn(i),Ns.bind(i)}function Ur(n){return Vt(n,!1)}function it(n){if(He===null)return n();const e=He;He=null;try{return n()}finally{He=e}}function et(n){mn(()=>it(n))}function $t(n){return Ge===null||(Ge.cleanups===null?Ge.cleanups=[n]:Ge.cleanups.push(n)),n}function pi(){return He}const[x0,S0]=J(!1);function Ds(n,e){const t=Symbol("context");return{id:t,Provider:Yr(t),defaultValue:n}}function Os(n){let e;return Ge&&Ge.context&&(e=Ge.context[n.id])!==void 0?e:n.defaultValue}function Is(n){const e=Me(n),t=Me(()=>mi(e()));return t.toArray=()=>{const i=t();return Array.isArray(i)?i:i!=null?[i]:[]},t}function Ns(){if(this.sources&&this.state)if(this.state===wt)bn(this);else{const n=Ve;Ve=null,Vt(()=>Gn(this),!1),Ve=n}if(He){const n=this.observers?this.observers.length:0;He.sources?(He.sources.push(this),He.sourceSlots.push(n)):(He.sources=[this],He.sourceSlots=[n]),this.observers?(this.observers.push(He),this.observerSlots.push(He.sources.length-1)):(this.observers=[He],this.observerSlots=[He.sources.length-1])}return this.value}function zs(n,e,t){let i=n.value;return(!n.comparator||!n.comparator(i,e))&&(n.value=e,n.observers&&n.observers.length&&Vt(()=>{for(let s=0;s<n.observers.length;s+=1){const r=n.observers[s],a=Zn&&Zn.running;a&&Zn.disposed.has(r),(a?!r.tState:!r.state)&&(r.pure?Ve.push(r):ft.push(r),r.observers&&Gs(r)),a||(r.state=wt)}if(Ve.length>1e6)throw Ve=[],new Error},!1)),e}function bn(n){if(!n.fn)return;gn(n);const e=Yn;Hr(n,n.value,e)}function Hr(n,e,t){let i;const s=Ge,r=He;He=Ge=n;try{i=n.fn(e)}catch(a){return n.pure&&(n.state=wt,n.owned&&n.owned.forEach(gn),n.owned=null),n.updatedAt=t+1,Bs(a)}finally{He=r,Ge=s}(!n.updatedAt||n.updatedAt<=t)&&(n.updatedAt!=null&&"observers"in n?zs(n,i):n.value=i,n.updatedAt=t)}function Ri(n,e,t,i=wt,s){const r={fn:n,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:Ge,context:Ge?Ge.context:null,pure:t};return Ge===null||Ge!==Ms&&(Ge.owned?Ge.owned.push(r):Ge.owned=[r]),r}function Fn(n){if(n.state===0)return;if(n.state===zn)return Gn(n);if(n.suspense&&it(n.suspense.inFallback))return n.suspense.effects.push(n);const e=[n];for(;(n=n.owner)&&(!n.updatedAt||n.updatedAt<Yn);)n.state&&e.push(n);for(let t=e.length-1;t>=0;t--)if(n=e[t],n.state===wt)bn(n);else if(n.state===zn){const i=Ve;Ve=null,Vt(()=>Gn(n,e[0]),!1),Ve=i}}function Vt(n,e){if(Ve)return n();let t=!1;e||(Ve=[]),ft?t=!0:ft=[],Yn++;try{const i=n();return qr(t),i}catch(i){t||(ft=null),Ve=null,Bs(i)}}function qr(n){if(Ve&&(Fs(Ve),Ve=null),n)return;const e=ft;ft=null,e.length&&Vt(()=>Ls(e),!1)}function Fs(n){for(let e=0;e<n.length;e++)Fn(n[e])}function Wr(n){let e,t=0;for(e=0;e<n.length;e++){const i=n[e];i.user?n[t++]=i:Fn(i)}for(e=0;e<t;e++)Fn(n[e])}function Gn(n,e){n.state=0;for(let t=0;t<n.sources.length;t+=1){const i=n.sources[t];if(i.sources){const s=i.state;s===wt?i!==e&&(!i.updatedAt||i.updatedAt<Yn)&&Fn(i):s===zn&&Gn(i,e)}}}function Gs(n){for(let e=0;e<n.observers.length;e+=1){const t=n.observers[e];t.state||(t.state=zn,t.pure?Ve.push(t):ft.push(t),t.observers&&Gs(t))}}function gn(n){let e;if(n.sources)for(;n.sources.length;){const t=n.sources.pop(),i=n.sourceSlots.pop(),s=t.observers;if(s&&s.length){const r=s.pop(),a=t.observerSlots.pop();i<s.length&&(r.sourceSlots[a]=i,s[i]=r,t.observerSlots[i]=a)}}if(n.tOwned){for(e=n.tOwned.length-1;e>=0;e--)gn(n.tOwned[e]);delete n.tOwned}if(n.owned){for(e=n.owned.length-1;e>=0;e--)gn(n.owned[e]);n.owned=null}if(n.cleanups){for(e=n.cleanups.length-1;e>=0;e--)n.cleanups[e]();n.cleanups=null}n.state=0}function jr(n){return n instanceof Error?n:new Error(typeof n=="string"?n:"Unknown error",{cause:n})}function Bs(n,e=Ge){throw jr(n)}function mi(n){if(typeof n=="function"&&!n.length)return mi(n());if(Array.isArray(n)){const e=[];for(let t=0;t<n.length;t++){const i=mi(n[t]);Array.isArray(i)?e.push.apply(e,i):e.push(i)}return e}return n}function Yr(n,e){return function(i){let s;return G(()=>s=it(()=>(Ge.context={...Ge.context,[n]:i.value},Is(()=>i.children))),void 0),s}}const Vr=Symbol("fallback");function Fi(n){for(let e=0;e<n.length;e++)n[e]()}function Xr(n,e,t={}){let i=[],s=[],r=[],a=0,l=e.length>1?[]:null;return $t(()=>Fi(r)),()=>{let o=n()||[],c=o.length,d,h;return o[vi],it(()=>{let v,u,p,m,b,_,w,S,C;if(c===0)a!==0&&(Fi(r),r=[],i=[],s=[],a=0,l&&(l=[])),t.fallback&&(i=[Vr],s[0]=Dn(A=>(r[0]=A,t.fallback())),a=1);else if(a===0){for(s=new Array(c),h=0;h<c;h++)i[h]=o[h],s[h]=Dn(g);a=c}else{for(p=new Array(c),m=new Array(c),l&&(b=new Array(c)),_=0,w=Math.min(a,c);_<w&&i[_]===o[_];_++);for(w=a-1,S=c-1;w>=_&&S>=_&&i[w]===o[S];w--,S--)p[S]=s[w],m[S]=r[w],l&&(b[S]=l[w]);for(v=new Map,u=new Array(S+1),h=S;h>=_;h--)C=o[h],d=v.get(C),u[h]=d===void 0?-1:d,v.set(C,h);for(d=_;d<=w;d++)C=i[d],h=v.get(C),h!==void 0&&h!==-1?(p[h]=s[d],m[h]=r[d],l&&(b[h]=l[d]),h=u[h],v.set(C,h)):r[d]();for(h=_;h<c;h++)h in p?(s[h]=p[h],r[h]=m[h],l&&(l[h]=b[h],l[h](h))):s[h]=Dn(g);s=s.slice(0,a=c),i=o.slice(0)}return s});function g(v){if(r[h]=v,l){const[u,p]=J(h);return l[h]=p,e(o[h],u)}return e(o[h])}}}function y(n,e){return it(()=>n(e||{}))}const Us=n=>`Stale read from <${n}>.`;function pe(n){const e="fallback"in n&&{fallback:()=>n.fallback};return Me(Xr(()=>n.each,n.children,e||void 0))}function W(n){const e=n.keyed,t=Me(()=>n.when,void 0,void 0),i=e?t:Me(t,void 0,{equals:(s,r)=>!s==!r});return Me(()=>{const s=i();if(s){const r=n.children;return typeof r=="function"&&r.length>0?it(()=>r(e?s:()=>{if(!it(i))throw Us("Show");return t()})):r}return n.fallback},void 0,void 0)}function Hs(n){const e=Is(()=>n.children),t=Me(()=>{const i=e(),s=Array.isArray(i)?i:[i];let r=()=>{};for(let a=0;a<s.length;a++){const l=a,o=s[a],c=r,d=Me(()=>c()?void 0:o.when,void 0,void 0),h=o.keyed?d:Me(d,void 0,{equals:(g,v)=>!g==!v});r=()=>c()||(h()?[l,d,o]:void 0)}return r});return Me(()=>{const i=t()();if(!i)return n.fallback;const[s,r,a]=i,l=a.children;return typeof l=="function"&&l.length>0?it(()=>l(a.keyed?r():()=>{if(it(t)()?.[0]!==s)throw Us("Match");return r()})):l},void 0,void 0)}function xt(n){return n}const Ce=n=>Me(()=>n());function Qr(n,e,t){let i=t.length,s=e.length,r=i,a=0,l=0,o=e[s-1].nextSibling,c=null;for(;a<s||l<r;){if(e[a]===t[l]){a++,l++;continue}for(;e[s-1]===t[r-1];)s--,r--;if(s===a){const d=r<i?l?t[l-1].nextSibling:t[r-l]:o;for(;l<r;)n.insertBefore(t[l++],d)}else if(r===l)for(;a<s;)(!c||!c.has(e[a]))&&e[a].remove(),a++;else if(e[a]===t[r-1]&&t[l]===e[s-1]){const d=e[--s].nextSibling;n.insertBefore(t[l++],e[a++].nextSibling),n.insertBefore(t[--r],d),e[s]=t[r]}else{if(!c){c=new Map;let h=l;for(;h<r;)c.set(t[h],h++)}const d=c.get(e[a]);if(d!=null)if(l<d&&d<r){let h=a,g=1,v;for(;++h<s&&h<r&&!((v=c.get(e[h]))==null||v!==d+g);)g++;if(g>d-l){const u=e[a];for(;l<d;)n.insertBefore(t[l++],u)}else n.replaceChild(t[l++],e[a++])}else a++;else e[a++].remove()}}}const Gi="_$DX_DELEGATE";function Kr(n,e,t,i={}){let s;return Dn(r=>{s=r,e===document?n():f(e,n(),e.firstChild?null:void 0,t)},i.owner),()=>{s(),e.textContent=""}}function x(n,e,t,i){let s;const r=()=>{const l=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return l.innerHTML=n,t?l.content.firstChild.firstChild:i?l.firstChild:l.content.firstChild},a=e?()=>it(()=>document.importNode(s||(s=r()),!0)):()=>(s||(s=r())).cloneNode(!0);return a.cloneNode=a,a}function Ue(n,e=window.document){const t=e[Gi]||(e[Gi]=new Set);for(let i=0,s=n.length;i<s;i++){const r=n[i];t.has(r)||(t.add(r),e.addEventListener(r,Jr))}}function Q(n,e,t){t==null?n.removeAttribute(e):n.setAttribute(e,t)}function Se(n,e){e==null?n.removeAttribute("class"):n.className=e}function Ae(n,e,t,i){Array.isArray(t)?(n[`$$${e}`]=t[0],n[`$$${e}Data`]=t[1]):n[`$$${e}`]=t}function qs(n,e,t){if(!e)return t?Q(n,"style"):e;const i=n.style;if(typeof e=="string")return i.cssText=e;typeof t=="string"&&(i.cssText=t=void 0),t||(t={}),e||(e={});let s,r;for(r in t)e[r]==null&&i.removeProperty(r),delete t[r];for(r in e)s=e[r],s!==t[r]&&(i.setProperty(r,s),t[r]=s);return t}function Vn(n,e,t){return it(()=>n(e,t))}function f(n,e,t,i){if(t!==void 0&&!i&&(i=[]),typeof e!="function")return Bn(n,e,i,t);G(s=>Bn(n,e(),s,t),i)}function Jr(n){let e=n.target;const t=`$$${n.type}`,i=n.target,s=n.currentTarget,r=o=>Object.defineProperty(n,"target",{configurable:!0,value:o}),a=()=>{const o=e[t];if(o&&!e.disabled){const c=e[`${t}Data`];if(c!==void 0?o.call(e,c,n):o.call(e,n),n.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(n.target)&&r(e.host),!0},l=()=>{for(;a()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(n,"currentTarget",{configurable:!0,get(){return e||document}}),n.composedPath){const o=n.composedPath();r(o[0]);for(let c=0;c<o.length-2&&(e=o[c],!!a());c++){if(e._$host){e=e._$host,l();break}if(e.parentNode===s)break}}else l();r(i)}function Bn(n,e,t,i,s){for(;typeof t=="function";)t=t();if(e===t)return t;const r=typeof e,a=i!==void 0;if(n=a&&t[0]&&t[0].parentNode||n,r==="string"||r==="number"){if(r==="number"&&(e=e.toString(),e===t))return t;if(a){let l=t[0];l&&l.nodeType===3?l.data!==e&&(l.data=e):l=document.createTextNode(e),t=Gt(n,t,i,l)}else t!==""&&typeof t=="string"?t=n.firstChild.data=e:t=n.textContent=e}else if(e==null||r==="boolean")t=Gt(n,t,i);else{if(r==="function")return G(()=>{let l=e();for(;typeof l=="function";)l=l();t=Bn(n,l,t,i)}),()=>t;if(Array.isArray(e)){const l=[],o=t&&Array.isArray(t);if(bi(l,e,t,s))return G(()=>t=Bn(n,l,t,i,!0)),()=>t;if(l.length===0){if(t=Gt(n,t,i),a)return t}else o?t.length===0?Bi(n,l,i):Qr(n,t,l):(t&&Gt(n),Bi(n,l));t=l}else if(e.nodeType){if(Array.isArray(t)){if(a)return t=Gt(n,t,i,e);Gt(n,t,null,e)}else t==null||t===""||!n.firstChild?n.appendChild(e):n.replaceChild(e,n.firstChild);t=e}}return t}function bi(n,e,t,i){let s=!1;for(let r=0,a=e.length;r<a;r++){let l=e[r],o=t&&t[n.length],c;if(!(l==null||l===!0||l===!1))if((c=typeof l)=="object"&&l.nodeType)n.push(l);else if(Array.isArray(l))s=bi(n,l,o)||s;else if(c==="function")if(i){for(;typeof l=="function";)l=l();s=bi(n,Array.isArray(l)?l:[l],Array.isArray(o)?o:[o])||s}else n.push(l),s=!0;else{const d=String(l);o&&o.nodeType===3&&o.data===d?n.push(o):n.push(document.createTextNode(d))}}return s}function Bi(n,e,t=null){for(let i=0,s=e.length;i<s;i++)n.insertBefore(e[i],t)}function Gt(n,e,t,i){if(t===void 0)return n.textContent="";const s=i||document.createTextNode("");if(e.length){let r=!1;for(let a=e.length-1;a>=0;a--){const l=e[a];if(s!==l){const o=l.parentNode===n;!r&&!a?o?n.replaceChild(s,l):n.insertBefore(s,t):o&&l.remove()}else r=!0}}else n.insertBefore(s,t);return[s]}var Zr=x("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),ea=x("<span class=loading-indicator>⏳"),ta=x("<button><span class=button-icon></span><span class=button-text>"),na=x("<div class=error-indicator>❌");const Ws=Ds(),ia=n=>{const[e,t]=J({mode:"design",loading:!1,error:void 0}),i=h=>{t(g=>({...g,mode:h,error:void 0})),console.log(`🎯 预览模式切换: ${h==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:h,timestamp:Date.now()}}))},d={state:e,actions:{setMode:i,toggleMode:()=>{const h=e().mode;i(h==="design"?"data":h==="data"?"preview":"design")},setLoading:h=>{t(g=>({...g,loading:h}))},setError:h=>{t(g=>({...g,error:h,loading:!1}))},isDesignMode:()=>e().mode==="design",isDataMode:()=>e().mode==="data",isPreviewMode:()=>e().mode==="preview"}};return y(Ws.Provider,{value:d,get children(){return n.children}})},Xn=()=>{const n=Os(Ws);if(!n)throw new Error("usePreview必须在PreviewProvider内使用");return n},sa=()=>{const{state:n,actions:e}=Xn(),t=s=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[s],i=()=>t(n().mode);return(()=>{var s=Zr(),r=s.firstChild,a=r.firstChild,l=a.nextSibling,o=r.nextSibling;return f(a,()=>i().icon),f(l,()=>i().text),f(r,(()=>{var c=Ce(()=>!!n().loading);return()=>c()&&ea()})(),null),f(o,()=>["design","data","preview"].map(c=>{const d=t(c),h=n().mode===c;return(()=>{var g=ta(),v=g.firstChild,u=v.nextSibling;return g.$$click=()=>e.setMode(c),Se(g,`mode-btn ${h?"active":""}`),f(v,()=>d.icon),f(u,()=>d.text),G(p=>{var m=n().loading,b=`切换到${d.text}`;return m!==p.e&&(g.disabled=p.e=m),b!==p.t&&Q(g,"title",p.t=b),p},{e:void 0,t:void 0}),g})()})),f(s,(()=>{var c=Ce(()=>!!n().error);return()=>c()&&(()=>{var d=na();return G(()=>Q(d,"title",n().error)),d})()})(),null),s})()},ei={getModeDisplayText:n=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[n],getModeIcon:n=>({design:"🎨",data:"🔗",preview:"🔍"})[n],shouldShowExpression:n=>n==="design",shouldEvaluateExpression:n=>n==="data"||n==="preview",shouldShowDesignAids:n=>n==="design"||n==="data",shouldAllowInteraction:n=>n==="design"||n==="data",isReadOnlyMode:n=>n==="preview",getModeTransitionClass:n=>`mode-${n}-active`};Ue(["click"]);const yi=Symbol("store-raw"),jt=Symbol("store-node"),ut=Symbol("store-has"),js=Symbol("store-self");function Ys(n){let e=n[Dt];if(!e&&(Object.defineProperty(n,Dt,{value:e=new Proxy(n,la)}),!Array.isArray(n))){const t=Object.keys(n),i=Object.getOwnPropertyDescriptors(n);for(let s=0,r=t.length;s<r;s++){const a=t[s];i[a].get&&Object.defineProperty(n,a,{enumerable:i[a].enumerable,get:i[a].get.bind(e)})}}return e}function Un(n){let e;return n!=null&&typeof n=="object"&&(n[Dt]||!(e=Object.getPrototypeOf(n))||e===Object.prototype||Array.isArray(n))}function fn(n,e=new Set){let t,i,s,r;if(t=n!=null&&n[yi])return t;if(!Un(n)||e.has(n))return n;if(Array.isArray(n)){Object.isFrozen(n)?n=n.slice(0):e.add(n);for(let a=0,l=n.length;a<l;a++)s=n[a],(i=fn(s,e))!==s&&(n[a]=i)}else{Object.isFrozen(n)?n=Object.assign({},n):e.add(n);const a=Object.keys(n),l=Object.getOwnPropertyDescriptors(n);for(let o=0,c=a.length;o<c;o++)r=a[o],!l[r].get&&(s=n[r],(i=fn(s,e))!==s&&(n[r]=i))}return n}function Hn(n,e){let t=n[e];return t||Object.defineProperty(n,e,{value:t=Object.create(null)}),t}function vn(n,e,t){if(n[e])return n[e];const[i,s]=J(t,{equals:!1,internal:!0});return i.$=s,n[e]=i}function ra(n,e){const t=Reflect.getOwnPropertyDescriptor(n,e);return!t||t.get||!t.configurable||e===Dt||e===jt||(delete t.value,delete t.writable,t.get=()=>n[Dt][e]),t}function Vs(n){pi()&&vn(Hn(n,jt),js)()}function aa(n){return Vs(n),Reflect.ownKeys(n)}const la={get(n,e,t){if(e===yi)return n;if(e===Dt)return t;if(e===vi)return Vs(n),t;const i=Hn(n,jt),s=i[e];let r=s?s():n[e];if(e===jt||e===ut||e==="__proto__")return r;if(!s){const a=Object.getOwnPropertyDescriptor(n,e);pi()&&(typeof r!="function"||n.hasOwnProperty(e))&&!(a&&a.get)&&(r=vn(i,e,r)())}return Un(r)?Ys(r):r},has(n,e){return e===yi||e===Dt||e===vi||e===jt||e===ut||e==="__proto__"?!0:(pi()&&vn(Hn(n,ut),e)(),e in n)},set(){return!0},deleteProperty(){return!0},ownKeys:aa,getOwnPropertyDescriptor:ra};function qn(n,e,t,i=!1){if(!i&&n[e]===t)return;const s=n[e],r=n.length;t===void 0?(delete n[e],n[ut]&&n[ut][e]&&s!==void 0&&n[ut][e].$()):(n[e]=t,n[ut]&&n[ut][e]&&s===void 0&&n[ut][e].$());let a=Hn(n,jt),l;if((l=vn(a,e,s))&&l.$(()=>t),Array.isArray(n)&&n.length!==r){for(let o=n.length;o<r;o++)(l=a[o])&&l.$();(l=vn(a,"length",r))&&l.$(n.length)}(l=a[js])&&l.$()}function Xs(n,e){const t=Object.keys(e);for(let i=0;i<t.length;i+=1){const s=t[i];qn(n,s,e[s])}}function oa(n,e){if(typeof e=="function"&&(e=e(n)),e=fn(e),Array.isArray(e)){if(n===e)return;let t=0,i=e.length;for(;t<i;t++){const s=e[t];n[t]!==s&&qn(n,t,s)}qn(n,"length",i)}else Xs(n,e)}function nn(n,e,t=[]){let i,s=n;if(e.length>1){i=e.shift();const a=typeof i,l=Array.isArray(n);if(Array.isArray(i)){for(let o=0;o<i.length;o++)nn(n,[i[o]].concat(e),t);return}else if(l&&a==="function"){for(let o=0;o<n.length;o++)i(n[o],o)&&nn(n,[o].concat(e),t);return}else if(l&&a==="object"){const{from:o=0,to:c=n.length-1,by:d=1}=i;for(let h=o;h<=c;h+=d)nn(n,[h].concat(e),t);return}else if(e.length>1){nn(n[i],e,[i].concat(t));return}s=n[i],t=[i].concat(t)}let r=e[0];typeof r=="function"&&(r=r(s,t),r===s)||i===void 0&&r==null||(r=fn(r),i===void 0||Un(s)&&Un(r)&&!Array.isArray(r)?Xs(s,r):qn(n,i,r))}function ca(...[n,e]){const t=fn(n||{}),i=Array.isArray(t),s=Ys(t);function r(...a){Ur(()=>{i&&a.length===1?oa(t,a[0]):nn(t,a)})}return[s,r]}function da(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Ui(n,e=!1){const t=da(),i=`_${t}`;return Object.defineProperty(window,i,{value:s=>(e&&Reflect.deleteProperty(window,i),n?.(s)),writable:!1,configurable:!0}),t}async function ye(n,e={}){return new Promise((t,i)=>{const s=Ui(a=>{t(a),Reflect.deleteProperty(window,`_${r}`)},!0),r=Ui(a=>{i(a),Reflect.deleteProperty(window,`_${s}`)},!0);window.__TAURI_IPC__({cmd:n,callback:s,error:r,...e})})}const Qs=Ds(),ha=n=>{const[e,t]=ca({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[i,s]=J(!1),[r,a]=J(null),[l,o]=J(!1),c=async()=>{try{s(!0),console.log("🔄 Loading app state...");const $=await ye("get_app_state");console.log("🔄 App state loaded, selected_ids:",$.selected_ids),t($)}catch($){console.error("Failed to load app state:",$)}finally{s(!1)}};et(()=>{c()});const d=async($,P,X,F={})=>{try{s(!0);const O=await ye("create_element",{request:{element_type:$,position:P,size:X,content_data:F}});return await c(),O}catch(O){throw console.error("Failed to create element:",O),O}finally{s(!1)}},h=async($,P)=>{try{s(!0),await ye("update_element",{request:{id:$,updates:P}}),await c()}catch(X){throw console.error("Failed to update element:",X),X}finally{s(!1)}},g=async $=>{try{s(!0),await ye("batch_update_positions",{request:{updates:$}}),t(P=>{const X=P.elements.map(F=>{const O=$.find(V=>V.element_id===F.id);return O?{...F,position:O.new_position}:F});return{...P,elements:X,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(P){throw console.error("Failed to batch update positions:",P),await c(),P}finally{s(!1)}},v=async $=>{try{s(!0),await ye("delete_element",{elementId:$}),await c()}catch(P){throw console.error("Failed to delete element:",P),P}finally{s(!1)}},u=async $=>{try{console.log("Selecting element:",$),await ye("select_element",{elementId:$}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",e.selected_ids)}catch(P){throw console.error("Failed to select element:",P),P}},p=async $=>{try{console.log("Selecting multiple elements:",$),$.length>0?(await ye("select_multiple",{elementIds:$}),console.log("✅ Multi-select completed for:",$.length,"elements")):await ye("clear_selection"),await c()}catch(P){throw console.error("Failed to select multiple elements:",P),P}},m=async $=>{try{console.log("Adding to selection:",$),await ye("add_to_selection",{elementId:$}),await c()}catch(P){throw console.error("Failed to add to selection:",P),P}},b=async $=>{try{console.log("Removing from selection:",$),await ye("remove_from_selection",{elementId:$}),await c()}catch(P){throw console.error("Failed to remove from selection:",P),P}},_=async $=>{try{console.log("Toggling selection:",$),await ye("toggle_selection",{elementId:$}),await c()}catch(P){throw console.error("Failed to toggle selection:",P),P}},w=async()=>{try{await ye("clear_selection"),await c()}catch($){throw console.error("Failed to clear selection:",$),$}},S=async()=>{try{await ye("copy_selected")}catch($){throw console.error("Failed to copy selected elements:",$),$}},N={state:e,setState:t,createElement:d,updateElement:h,batchUpdatePositions:g,deleteElement:v,selectElement:u,selectMultiple:p,addToSelection:m,removeFromSelection:b,toggleSelection:_,clearSelection:w,copySelected:S,copySelectedElements:async()=>S(),pasteElements:async($,P)=>{try{s(!0);const X=await ye("paste_elements",{offsetX:$,offsetY:P});return await c(),X}catch(X){throw console.error("Failed to paste elements:",X),X}finally{s(!1)}},deleteElements:async $=>{try{s(!0);for(const P of $)await ye("delete_element",{elementId:P});await c()}catch(P){throw console.error("Failed to delete elements:",P),P}finally{s(!1)}},selectAllElements:async()=>{try{const $=e.elements.map(P=>P.id);await p($)}catch($){throw console.error("Failed to select all elements:",$),$}},moveElements:async($,P,X)=>{try{s(!0);const F=e.elements.filter(O=>$.includes(O.id)).map(O=>({element_id:O.id,new_position:{x:O.position.x+P,y:O.position.y+X}}));F.length>0&&await g(F)}catch(F){throw console.error("Failed to move elements:",F),F}finally{s(!1)}},undo:async()=>{try{s(!0),await ye("undo"),await c()}catch($){throw console.error("Failed to undo:",$),$}finally{s(!1)}},redo:async()=>{try{s(!0),await ye("redo"),await c()}catch($){throw console.error("Failed to redo:",$),$}finally{s(!1)}},updateCanvasConfig:async $=>{try{s(!0),await ye("update_canvas_config",{request:$}),await c()}catch(P){throw console.error("Failed to update canvas config:",P),P}finally{s(!1)}},getElementsAtPoint:async($,P)=>{try{return await ye("get_elements_at_point",{x:$,y:P})}catch(X){return console.error("Failed to get elements at point:",X),[]}},isLoading:i,setLoading:s,dragOperation:r,setDragOperation:a,resizeOperation:l,setResizeOperation:o};return y(Qs.Provider,{value:N,get children(){return n.children}})},at=()=>{const n=Os(Qs);if(!n)throw new Error("useAppContext must be used within an AppProvider");return n};async function Ks(n){return ye("tauri",n)}async function ua(n={}){return typeof n=="object"&&Object.freeze(n),Ks({__tauriModule:"Dialog",message:{cmd:"openDialog",options:n}})}async function Js(n={}){return typeof n=="object"&&Object.freeze(n),Ks({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:n}})}class ti{static async loadTemplate(e){return await ye("load_jasper_template",{filePath:e})}static async saveTemplate(e,t){await ye("save_jasper_template",{template:e,filePath:t})}static async saveTemplateAs(e,t,i){await ye("save_template_as",{template:e,filePath:t,format:i})}static async validateTemplate(e){return await ye("validate_template",{template:e})}static async createEmptyTemplate(){return await ye("create_empty_template")}static async getTemplateInfo(e){return await ye("get_template_info",{filePath:e})}static async detectTemplateFormat(e){return await ye("detect_template_format",{filePath:e})}static async generateTemplatePreview(e){return await ye("generate_template_preview",{template:e})}static async exportTemplateJson(e){return await ye("export_template_json",{template:e})}static async importTemplateJson(e){return await ye("import_template_json",{jsonData:e})}static async cloneTemplate(e){return await ye("clone_template",{template:e})}static async mergeTemplates(e,t){return await ye("merge_templates",{baseTemplate:e,overlayTemplate:t})}static async extractTemplateElements(e,t){return await ye("extract_template_elements",{template:e,elementIds:t})}}const ga="modulepreload",fa=function(n){return"/"+n},Hi={},va=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");s=Promise.allSettled(t.map(o=>{if(o=fa(o),o in Hi)return;Hi[o]=!0;const c=o.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${d}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":ga,c||(h.as="script"),h.crossOrigin="",h.href=o,l&&h.setAttribute("nonce",l),document.head.appendChild(h),c)return new Promise((g,v)=>{h.addEventListener("load",g),h.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${o}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return s.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return e().catch(r)})},pa=()=>({metadata:{version:"2.0.0",format_version:"1.0.0",created_at:new Date().toISOString(),last_modified:new Date().toISOString(),created_by:"jasper-designer-v2",tags:[],compatibility:{min_jasper_version:"2.0.0",jasperreports_version:"6.20.0"}},canvas:{width:595,height:842,unit:"pt",orientation:"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:!0,size:10,snap:!0,visible:!0},background:{color:"#ffffff"}},data_sources:[],elements:[],parameters:[],variables:[],groups:[]});class ni{static toJasperTemplate(e,t){const i={...pa()},s={...i.metadata,...t,last_modified:new Date().toISOString()},r=this.convertCanvasConfig(e.canvas_config),a=e.elements.map(l=>this.convertReportElementToTemplateElement(l));return{...i,metadata:s,canvas:r,elements:a}}static convertCanvasConfig(e){return{width:e.width,height:e.height,unit:"pt",orientation:e.width>e.height?"landscape":"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:e.show_grid,size:e.grid_size,snap:e.snap_to_grid,visible:e.show_grid},background:{color:e.background_color}}}static convertReportElementToTemplateElement(e){const t=this.getElementType(e.content),i=this.convertElementContent(e.content),s=this.convertElementStyle(e.content);return{id:e.id,element_type:t,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},z_index:e.z_index,visible:e.visible,content:i,style:s,data_binding:this.extractDataBinding(e.content)}}static getElementType(e){switch(e.type){case"Text":return"Text";case"DataField":return"DataField";case"Rectangle":return"Rectangle";case"Line":return"Line";case"Image":return"Image";default:return"Text"}}static convertElementContent(e){switch(e.type){case"Text":return{text:e.content,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"DataField":return{expression:e.expression,format:e.format,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"Rectangle":return{color:e.fill_color};case"Line":return{color:e.color};case"Image":return{expression:e.src,text:e.alt};default:return{}}}static convertTextStyleToFont(e){return{family:e.font_family||"Arial",size:e.font_size||12,weight:this.mapFontWeight(e.font_weight),style:"normal"}}static convertTextStyleToAlignment(e){return{horizontal:this.mapTextAlign(e.align),vertical:"middle"}}static convertElementStyle(e){const t={};switch(e.type){case"Rectangle":e.fill_color&&(t.background={color:e.fill_color}),e.border&&(t.border={width:e.border.width,color:e.border.color,style:this.mapBorderStyle(e.border.style)});break;case"Text":case"DataField":e.style.background&&(t.background={color:e.style.background.color}),e.style.border&&(t.border={width:e.style.border.width,color:e.style.border.color,style:this.mapBorderStyle(e.style.border.style)});break}return t}static extractDataBinding(e){if(e.type==="DataField"&&e.data_source_id)return{source_id:e.data_source_id,field_name:this.extractFieldNameFromExpression(e.expression)}}static extractFieldNameFromExpression(e){return e.match(/^\{([^}]+)\}$/)?.[1]??e}static toAppState(e){const t=e.metadata.description||void 0;return{elements:e.elements.map(i=>this.convertTemplateElementToReportElement(i)),canvas_config:this.convertCanvasToCanvasConfig(e.canvas),selected_ids:[],can_undo:!1,can_redo:!1,dirty:!1,...t&&{template_name:t}}}static convertCanvasToCanvasConfig(e){return{width:e.width,height:e.height,zoom:1,offset_x:0,offset_y:0,show_grid:e.grid.enabled,show_rulers:!0,grid_size:e.grid.size,snap_to_grid:e.grid.snap,background_color:e.background.color}}static convertTemplateElementToReportElement(e){const t=this.convertTemplateContentToElementContent(e);return{id:e.id,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},content:t,z_index:e.z_index,visible:e.visible,locked:!1}}static convertTemplateContentToElementContent(e){switch(e.element_type){case"Text":return{type:"Text",content:e.content.text||"",style:this.convertTemplateStyleToTextStyle(e)};case"DataField":return{type:"DataField",expression:e.content.expression||"{data}",...e.content.format&&{format:e.content.format},style:this.convertTemplateStyleToTextStyle(e),...e.data_binding?.source_id&&{data_source_id:e.data_binding.source_id}};case"Rectangle":return{type:"Rectangle",...e.style?.background?.color&&{fill_color:e.style.background.color},...e.content.color&&!e.style?.background?.color&&{fill_color:e.content.color},...e.style?.border&&{border:{color:e.style.border.color,width:e.style.border.width,style:this.mapTemplateBorderStyle(e.style.border.style)}},corner_radius:0,opacity:1};case"Line":return{type:"Line",color:e.content.color||"#000000",width:1,line_style:"Solid",opacity:1};case"Image":return{type:"Image",src:e.content.expression||"",...e.content.text&&{alt:e.content.text}};default:return{type:"Text",content:"Unknown Element",style:this.createDefaultTextStyle()}}}static convertTemplateStyleToTextStyle(e){const t=e.content.font,i=e.content.alignment,s=e.style;return{font_family:t?.family||"Arial",font_size:t?.size||12,font_weight:this.mapTemplateFont(t?.weight),color:e.content.color||"#000000",align:this.mapTemplateAlignment(i?.horizontal),background:s?.background?{color:s.background.color||"",opacity:1,padding:0}:void 0,border:s?.border?{color:s.border.color,width:s.border.width,style:this.mapTemplateBorderStyle(s.border.style),radius:0}:void 0}}static createDefaultTextStyle(){return{font_family:"Arial",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}}static mapFontWeight(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTemplateFont(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTextAlign(e){switch(e){case"Center":return"center";case"Right":return"right";default:return"left"}}static mapTemplateAlignment(e){switch(e){case"center":return"Center";case"right":return"Right";default:return"Left"}}static mapBorderStyle(e){switch(e){case"Dashed":return"dashed";case"Dotted":return"dotted";default:return"solid"}}static mapTemplateBorderStyle(e){switch(e){case"dashed":return"Dashed";case"dotted":return"Dotted";default:return"Solid"}}}var ma=x("<span class=text-warning>●"),ba=x("<span class=ml-2> 个元素"),ya=x('<span class="ml-2 text-primary">已选择 <!> 个'),_a=x('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建模板 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开模板 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存模板 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class=toolbar-btn title="导出 (PDF/PNG/Excel)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>导出</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const xa=n=>{const{state:e,undo:t,redo:i,updateCanvasConfig:s,setState:r}=at(),[a,l]=J(e.canvas_config.zoom*100),o=async()=>{try{const b=await ti.createEmptyTemplate(),_=ni.toAppState(b);r(_),console.log("✅ 新建模板成功")}catch(b){console.error("❌ 新建模板失败:",b),alert("新建模板失败")}},c=async()=>{try{const b=await ua({title:"打开模板文件",filters:[{name:"Jasper模板",extensions:["jasper","jbin","jrxml"]}],multiple:!1});if(b&&typeof b=="string"){const _=await ti.loadTemplate(b),w=ni.toAppState(_);r({...w,template_name:_.metadata.description||"未命名模板"}),console.log("✅ 模板加载成功:",b)}}catch(b){console.error("❌ 加载模板失败:",b),alert("加载模板失败")}},d=async()=>{try{const b=await Js({title:"保存模板文件",filters:[{name:"Jasper模板",extensions:["jasper"]}],defaultPath:e.template_name||"未命名模板"});if(b){const _=ni.toJasperTemplate(e,{description:e.template_name||"未命名模板"});await ti.saveTemplate(_,b),console.log("✅ 模板保存成功:",b)}}catch(b){console.error("❌ 保存模板失败:",b),alert("保存模板失败")}},h=async b=>{const _=b/100;l(b);try{await s({zoom:_})}catch(w){console.error("Failed to update zoom:",w)}},g=()=>{const b=Math.min(a()+25,500);h(b)},v=()=>{const b=Math.max(a()-25,25);h(b)},u=async()=>{try{await s({show_grid:!e.canvas_config.show_grid})}catch(b){console.error("Failed to toggle grid:",b)}},p=async()=>{try{await s({show_rulers:!e.canvas_config.show_rulers})}catch(b){console.error("Failed to toggle rulers:",b)}},m=async()=>{try{await ye("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(b){console.error("Failed to toggle DevTools:",b)}};return(()=>{var b=_a(),_=b.firstChild,w=_.firstChild,S=w.nextSibling,C=S.nextSibling,A=C.nextSibling,M=A.nextSibling,D=M.nextSibling,z=_.nextSibling,E=z.firstChild,R=E.nextSibling,k=R.nextSibling,q=k.nextSibling,N=q.nextSibling,$=N.nextSibling,P=$.nextSibling,X=P.nextSibling,F=X.nextSibling,O=F.nextSibling,V=O.nextSibling,B=z.nextSibling,H=B.firstChild;return w.$$click=o,S.$$click=c,C.$$click=d,f(_,y(sa,{}),M),M.$$click=()=>{console.log("🔄 数据源按钮被点击！"),n.onOpenDataSources()},D.$$click=()=>{console.log("📤 导出按钮被点击！"),n.onOpenExport?.()},Ae(E,"click",t),Ae(R,"click",i),q.$$click=v,N.addEventListener("change",j=>{const de=j.target.value;if(de==="fit")console.log("Fit to window");else{const me=parseInt(de.replace("%",""));h(me)}}),$.$$click=g,X.$$click=u,F.$$click=p,V.$$click=m,f(B,y(W,{get when(){return e.dirty},get children(){return ma()}}),H),f(H,()=>e.template_name||"未命名模板"),f(B,y(W,{get when(){return e.elements.length>0},get children(){var j=ba(),de=j.firstChild;return f(j,()=>e.elements.length,de),j}}),null),f(B,y(W,{get when(){return e.selected_ids.length>0},get children(){var j=ya(),de=j.firstChild,me=de.nextSibling;return me.nextSibling,f(j,()=>e.selected_ids.length,me),j}}),null),G(j=>{var de=`toolbar-btn-icon ${e.can_undo?"":"opacity-50 cursor-not-allowed"}`,me=!e.can_undo,fe=`撤销${e.undo_description?` (${e.undo_description})`:""} (Ctrl+Z)`,ee=`toolbar-btn-icon ${e.can_redo?"":"opacity-50 cursor-not-allowed"}`,oe=!e.can_redo,ge=`重做${e.redo_description?` (${e.redo_description})`:""} (Ctrl+Y)`,he=`toolbar-btn-icon ${e.canvas_config.show_grid?"active":""}`,te=`toolbar-btn-icon ${e.canvas_config.show_rulers?"active":""}`;return de!==j.e&&Se(E,j.e=de),me!==j.t&&(E.disabled=j.t=me),fe!==j.a&&Q(E,"title",j.a=fe),ee!==j.o&&Se(R,j.o=ee),oe!==j.i&&(R.disabled=j.i=oe),ge!==j.n&&Q(R,"title",j.n=ge),he!==j.s&&Se(X,j.s=he),te!==j.h&&Se(F,j.h=te),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),G(()=>N.value=`${Math.round(a())}%`),b})()};Ue(["click"]);var Sa=x('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),wa=x('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const qi=()=>{const{createElement:n}=at(),[e,t]=J(""),i=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:c?.text||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:c?.expression||"${fieldName}",format:c?.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:c?.fill_color||"transparent",border:{color:c?.border_color||"#000000",width:c?.border_width||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:c?.color||"#000000",width:c?.width||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:c?.src||"",alt:c?.alt||"图片"})}],s=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],r=[...i,...s],a=()=>{const c=e().toLowerCase();return c?r.filter(d=>d.name.toLowerCase().includes(c)||d.description.toLowerCase().includes(c)):r},l=(c,d)=>{if(console.log("Starting drag for component:",c.id),d.dataTransfer){d.dataTransfer.effectAllowed="copy",d.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const h=document.createElement("div");h.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,h.style.position="absolute",h.style.top="-1000px",document.body.appendChild(h),d.dataTransfer.setDragImage(h,50,20),setTimeout(()=>{document.body.removeChild(h)},0)}},o=async c=>{try{const d=await n(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",d)}catch(d){console.error("Failed to create element:",d)}};return(()=>{var c=Sa(),d=c.firstChild,h=d.firstChild,g=h.nextSibling,v=d.nextSibling,u=v.firstChild,p=u.firstChild,m=p.firstChild,b=m.nextSibling,_=p.nextSibling,w=_.firstChild,S=w.nextSibling,C=_.nextSibling,A=C.firstChild,M=A.nextSibling;return g.$$input=D=>t(D.target.value),f(b,y(pe,{get each(){return a().filter(D=>D.category==="basic")},children:D=>y(ii,{component:D,onDrag:z=>l(D,z),onClick:()=>o(D)})})),f(S,y(pe,{get each(){return a().filter(D=>D.category==="data")},children:D=>y(ii,{component:D,onDrag:z=>l(D,z),onClick:()=>o(D)})})),f(M,y(pe,{get each(){return a().filter(D=>D.category==="bank")},children:D=>y(ii,{component:D,onDrag:z=>l(D,z),onClick:()=>o(D)})})),G(()=>g.value=e()),c})()},ii=n=>(()=>{var e=wa(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(e,"click",n.onClick),e.addEventListener("dragstart",r=>n.onDrag(r)),Q(e,"draggable",!0),f(i,()=>n.component.icon),f(s,()=>n.component.name),G(()=>Q(e,"title",n.component.description)),e})();Ue(["input","click"]);class Re{static async listDataSources(){return ye("list_data_sources")}static async deleteDataSource(e){return ye("delete_data_source",{req:{sourceId:e}})}static async updateConfig(e,t){return ye("update_data_source_config",{req:{sourceId:e,config:t}})}static async queryDataSource(e,t){return ye("query_data_source",{req:{sourceId:e,query:t}})}static async getDataPreview(e,t){return ye("get_data_preview",{req:{sourceId:e,limit:t}})}static async testConnection(e,t){return ye("test_data_source_connection",{req:{providerType:e,config:t}})}static async discoverSchema(e,t){return ye("discover_schema",{req:{providerType:e,config:t}})}static async testDatabaseConnection(e){return ye("test_database_connection",{config:e})}static async loadDatabaseSchema(e){return ye("load_database_schema",{config:e})}static async executeDatabasePreview(e,t,i){return ye("execute_database_preview",{req:{config:e,sql:t,limit:i}})}static async validateSqlSyntax(e,t){if(console.log("🔍 验证SQL语法 - 参数:",{sql:e.length+" 字符",databaseType:t}),!e||e.trim().length===0)throw new Error("SQL不能为空");if(!t)throw console.error("❌ databaseType参数为空或未定义:",t),new Error("数据库类型不能为空");try{const i={sql:e,databaseType:t};return console.log("🔍 将传递给Rust的参数:",i),console.log("🔍 参数对象的键:",Object.keys(i)),console.log("🔍 参数JSON:",JSON.stringify(i)),await ye("validate_sql_syntax",{req:i})}catch(i){throw console.error("❌ 调用失败:",i),i}}static async formatSql(e,t){return ye("format_sql",{req:{sql:e,databaseType:t}})}static async saveDataSource(e){try{const t=e.config;console.log("🔍 saveDataSource 请求参数:",{name:e.name,selected_tables:e.selected_tables,selected_tables_type:typeof e.selected_tables,selected_tables_length:e.selected_tables?.length,sql_length:e.sql?.length});const i=e.selected_tables||[];console.log("🔍 实际传递的 selectedTables:",i);const s=await ye("create_database_source",{req:{name:e.name,description:e.description||null,databaseType:t.database_type,host:t.host,port:t.port,database:t.database,username:t.username,password:t.password||null,sql:e.sql,selectedTables:i,tags:e.tags?e.tags:null}});return{success:!0,data_source_id:String(s),message:`数据源 "${e.name}" 创建成功`,warnings:[],errors:[]}}catch(t){return{success:!1,data_source_id:"",message:`保存数据源失败: ${t}`,warnings:[],errors:[String(t)]}}}static async createDataSource(e,t,i){return ye("create_data_source",{req:{name:e,providerType:t,config:i}})}static async getPreview(e,t,i){return this.getDataPreview(e,i)}static async queryData(e,t){return this.queryDataSource(e,t||{})}static async evaluateExpression(e,t,i){return ye("evaluate_expression",{req:{sourceId:e,expression:t,context:i}})}static async getAvailableTypes(){return ye("get_available_data_source_types")}static async getSchema(e){return ye("get_data_source_schema",{req:{sourceId:e}})}static async getConfigSchema(e){return ye("get_config_schema",{req:{providerType:e}})}static async getDefaultConfig(e){return ye("get_default_config",{req:{providerType:e}})}static async validateConfig(e,t){return ye("validate_config",{req:{providerType:e,config:t}})}static async captureDataPreview(e,t){return this.executeDatabasePreview(e,t,50)}static async validateDataSourceBeforeSave(e){try{console.log("🔍 开始验证数据源保存前检查"),console.log("🔍 请求配置:",e.config),console.log("🔍 数据库类型:",e.config.database_type);const t=await this.testDatabaseConnection(e.config),i=await this.validateSqlSyntax(e.sql,e.config.database_type),s=await this.performSecurityCheck(e.config,e.sql);return{connection_valid:t.success,sql_valid:i.valid,security_passed:s.is_safe,performance_acceptable:!0,warnings:[...i.warnings||[],...s.warnings||[]],errors:[]}}catch(t){return{connection_valid:!1,sql_valid:!1,security_passed:!1,performance_acceptable:!1,warnings:[],errors:[String(t)]}}}static async performSecurityCheck(e,t){const i=[],s=[],r=[/drop\s+table/i,/truncate\s+table/i,/delete\s+from/i,/update\s+.*set/i,/insert\s+into/i,/alter\s+table/i];for(const a of r)if(a.test(t)){i.push("包含可能危险的SQL操作");break}return{is_safe:i.length===0,security_issues:i,warnings:s}}}class $a{styles=new Map;elementStyleMap=new Map;observers=new Set;initialized=!1;constructor(){console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(e){throw console.error("❌ TextStyleManager 初始化失败:",e),e}}createStyle(e){const t=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={...e,id:t,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(t,i),this.notifyObservers("style-created",t),this.saveUserStyles(),console.log(`🎨 创建新样式: ${i.name} (${t})`),t}getStyle(e){return this.styles.get(e)||null}updateStyle(e,t){const i=this.styles.get(e);if(!i)return console.warn(`⚠️ 样式 ${e} 不存在`),!1;if(i.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${e}`),!1;const s={...i,style:{...i.style,...t},metadata:{...i.metadata,lastModified:new Date}};return this.styles.set(e,s),this.syncAllStyleInstances(e),this.saveUserStyles(),this.notifyObservers("style-updated",e),console.log(`🔄 样式已更新: ${i.name} (${e})`),!0}deleteStyle(e){const t=this.styles.get(e);if(!t)return!1;if(t.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${e}`),!1;const i=Array.from(this.elementStyleMap.entries()).filter(([s,r])=>r===e).map(([s,r])=>s);return i.length>0?(console.warn(`⚠️ 无法删除样式 ${e}，仍有 ${i.length} 个元素在使用`),!1):(this.styles.delete(e),this.saveUserStyles(),this.notifyObservers("style-deleted",e),console.log(`🗑️ 样式已删除: ${t.name} (${e})`),!0)}applyStyleToElement(e,t){const i=this.styles.get(t);if(!i)return{success:!1,elementId:e,styleId:t,appliedAt:new Date,error:`样式 ${t} 不存在`};try{const s=this.elementStyleMap.get(e);if(this.elementStyleMap.set(e,t),i.metadata.usageCount++,s&&s!==t){const r=this.styles.get(s);r&&(r.metadata.usageCount=Math.max(0,r.metadata.usageCount-1))}return this.applyStyleToDOM(e,i.style),this.notifyObservers("style-applied",{elementId:e,styleId:t}),console.log(`🎯 应用样式: ${i.name} → 元素 ${e}`),{success:!0,elementId:e,styleId:t,appliedAt:new Date}}catch(s){return console.error(`❌ 应用样式失败: ${s}`),{success:!1,elementId:e,styleId:t,appliedAt:new Date,error:s instanceof Error?s.message:String(s)}}}getElementStyleId(e){return this.elementStyleMap.get(e)||null}removeElementStyle(e){const t=this.elementStyleMap.get(e);if(t){this.elementStyleMap.delete(e);const i=this.styles.get(t);i&&(i.metadata.usageCount=Math.max(0,i.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${e}`)}}getStylesByCategory(e){const t=Array.from(this.styles.values());return(e?t.filter(s=>s.category===e):t).sort((s,r)=>s.metadata.isSystemStyle!==r.metadata.isSystemStyle?s.metadata.isSystemStyle?-1:1:r.metadata.usageCount-s.metadata.usageCount)}searchStyles(e,t){const i=this.getStylesByCategory(t),s=e.toLowerCase().trim();return s?i.filter(r=>r.name.toLowerCase().includes(s)||r.description.toLowerCase().includes(s)||r.metadata.tags.some(a=>a.toLowerCase().includes(s))):i}getStyleUsageStats(){const e=[];for(const[t,i]of this.styles){const s=Array.from(this.elementStyleMap.entries()).filter(([r,a])=>a===t).map(([r,a])=>r);e.push({styleId:t,usageCount:s.length,elements:s,lastUsed:i.metadata.lastModified})}return e.sort((t,i)=>i.usageCount-t.usageCount)}cleanupUnusedStyles(){const e=new Set(this.elementStyleMap.values()),t=[];for(const[i,s]of this.styles)!e.has(i)&&!s.metadata.isSystemStyle&&(this.styles.delete(i),t.push(i),console.log(`🧹 清理未使用样式: ${s.name} (${i})`));return t.length>0&&this.saveUserStyles(),t}exportStyles(e){const t=e?e.map(s=>this.styles.get(s)).filter(Boolean):Array.from(this.styles.values()),i=new Set(t.map(s=>s.category));return{version:"2.0.0",exportedAt:new Date,styles:t,metadata:{totalStyles:t.length,categories:Array.from(i),author:"user"}}}async importStyles(e){const t=[];for(const i of e.styles){if(Array.from(this.styles.values()).find(a=>a.name===i.name&&a.category===i.category)){console.warn(`⚠️ 跳过已存在的样式: ${i.name}`);continue}const r=this.createStyle({name:i.name,description:i.description,category:i.category,style:i.style,...i.inheritance&&{inheritance:i.inheritance}});t.push(r)}return console.log(`📦 导入完成，共导入 ${t.length} 个样式`),t}addObserver(e){this.observers.add(e)}removeObserver(e){this.observers.delete(e)}syncAllStyleInstances(e){const t=this.styles.get(e);if(!t)return;const i=[];for(const[s,r]of this.elementStyleMap)r===e&&(this.applyStyleToDOM(s,t.style),i.push(s));this.notifyObservers("styles-synced",{styleId:e,affectedElements:i}),console.log(`🔄 样式同步完成: ${e} → ${i.length} 个元素`)}applyStyleToDOM(e,t){console.log(`🎨 应用样式到DOM: 元素 ${e}`,{font_family:t.font_family,font_size:t.font_size,typography:t.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:e}=await va(async()=>{const{BANK_TEXT_STYLES:t}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:t}},[]);for(const t of e)this.styles.set(t.id,t);console.log(`🏦 加载了 ${e.length} 个银行预设样式`)}catch(e){console.warn("⚠️ 加载系统样式失败:",e)}}async loadUserStyles(){try{const e=localStorage.getItem("jasper-text-styles");if(e){const t=JSON.parse(e);for(const i of t)i.metadata.createdAt=new Date(i.metadata.createdAt),i.metadata.lastModified=new Date(i.metadata.lastModified),this.styles.set(i.id,i);console.log(`👤 加载了 ${t.length} 个用户自定义样式`)}}catch(e){console.warn("⚠️ 加载用户样式失败:",e)}}saveUserStyles(){try{const e=Array.from(this.styles.values()).filter(t=>!t.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(e)),console.log(`💾 保存了 ${e.length} 个用户自定义样式`)}catch(e){console.error("❌ 保存用户样式失败:",e)}}notifyObservers(e,t){for(const i of this.observers)try{i.onStyleChange(e,t)}catch(s){console.error("❌ 观察者通知失败:",s)}}}const Xe=new $a;class Ca{calculateUnifiedBounds(e,t,i){const s=this.calculateFontMetrics(t),r=this.measureTextContent(e,t,i.width),a=this.calculateContainerHeight(r,s,i.height),l=this.calculateTextPositioning(t,i,a,s),o={containerBounds:{x:0,y:0,width:i.width,height:a},contentBounds:r.bounds,fontMetrics:s,positioning:l};return r.wrappedLines&&(o.textLayout={wrappedLines:r.wrappedLines,isWrapped:!0,originalLineCount:e.split(`
`).length,wrappedLineCount:r.wrappedLines.length}),o}calculateFontMetrics(e){const t=e.font_size,i=1.2,s=.75,r=.25,a=t*s,l=t*r;return{fontSize:t,lineHeight:t*i,ascender:a,descender:l,baseline:a}}getCharacterWidth(e,t){const i=t.font_size,s=t.font_family,r=/[\u4e00-\u9fa5]/.test(e),a={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},l=s.toLowerCase();let o=a.default;for(const[d,h]of Object.entries(a))if(l.includes(d.toLowerCase())||d.toLowerCase().includes(l)){o=h;break}const c=r?o.chinese:o.english;return i*c}calculateTextWidth(e,t){let i=0;for(const s of e)s!==`
`&&(i+=this.getCharacterWidth(s,t));return i}measureTextContent(e,t,i=0){const s=e.split(`
`),r=s.length;let a=0;for(const c of s){const d=this.calculateTextWidth(c,t);a=Math.max(a,d)}if(i>0&&a>i)return this.calculateWrappedText(e,t,i);const l=i>0?Math.min(a,i):a,o=r*t.font_size*1.2;return{bounds:{x:0,y:0,width:l,height:o},lineCount:r,actualHeight:o}}calculateWrappedText(e,t,i){const s=this.getCharacterWidth("测",t);if(Math.floor(i/s)<1||i<s)return{bounds:{x:0,y:0,width:i,height:t.font_size*1.2},lineCount:1,actualHeight:t.font_size*1.2,wrappedLines:["..."]};const a=this.smartSegmentation(e);let l=[],o="",c=0;for(const h of a){const g=this.calculateTextWidth(h,t),v=c+g;if(v>i)if(o.trim())l.push(o.trim()),o=h,c=g;else{const{truncated:u,remaining:p}=this.forceTruncateSegment(h,i,t);l.push(u),o=p,c=this.calculateTextWidth(p,t)}else o+=h,c=v}o.trim()&&l.push(o.trim());const d=l.length*t.font_size*1.2;return{bounds:{x:0,y:0,width:i,height:d},lineCount:l.length,actualHeight:d,wrappedLines:l}}forceTruncateSegment(e,t,i){let s="",r=0,a=0;for(a=0;a<e.length;a++){const o=e[a];if(!o)break;const c=this.getCharacterWidth(o,i);if(r+c>t)break;s+=o,r+=c}const l=e.substring(a);return{truncated:s,remaining:l}}smartSegmentation(e){const t=[];let i="";for(let s=0;s<e.length;s++){const r=e[s];r&&(/[\u4e00-\u9fa5]/.test(r)?(i&&(t.push(i),i=""),t.push(r)):r===`
`?(i&&(t.push(i),i=""),t.push(`
`)):r===" "?i?(t.push(i+" "),i=""):t.push(" "):i+=r)}return i&&t.push(i),t.filter(s=>s.length>0)}calculateContainerHeight(e,t,i){const s=t.lineHeight*e.lineCount,r=t.ascender+t.descender,a=t.lineHeight,l=Math.max(s,r,a);return Math.max(l,i)}calculateTextPositioning(e,t,i,s){const r=this.calculateHorizontalAnchor(e.align,t.width),a=s.baseline,l=e.background?.padding||0,o=-l,c=-l;return{textAnchorX:r,textAnchorY:a,backgroundX:o,backgroundY:c}}calculateHorizontalAnchor(e,t){switch(e){case"Left":return 0;case"Center":return t/2;case"Right":return t;default:return 0}}getTextAnchor(e){switch(e){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(e,t){}}const qt=new Ca;class ka{initialized=!1;constructor(){this.initialize()}async initialize(){if(!this.initialized)try{await Xe.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(e){console.error("❌ ProfessionalTextRenderer 初始化失败:",e)}}isElementUsingProfessionalStyle(e){return Xe.getElementStyleId(e)!==null}adaptLegacyTextStyle(e){return{...e,font_weight:e.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:e.color}}],effects:[]}}renderProfessionalText(e,t=!1){if(e.content.type!=="Text"&&e.content.type!=="DataField")return null;const i=Xe.getElementStyleId(e.id);let s;if(i){const l=Xe.getStyle(i);if(!l)return console.warn(`⚠️ 找不到样式定义: ${i}`),null;s=l.style,console.log(`🎨 使用专业样式渲染: ${l.name} (${i})`)}else{const l=e.content.type==="Text"||e.content.type==="DataField"?e.content.style:null;if(!l)return null;s=this.adaptLegacyTextStyle(l),console.log("🔄 适配传统样式到专业排版系统")}const r=this.calculateEnhancedBounds(e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",s,e.size);return{element:this.createProfessionalTextElement(r,e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",s,!1),bounds:r,style:s}}calculateEnhancedBounds(e,t,i){const s=qt.calculateUnifiedBounds(e,t,i),r=t.typography,a=this.calculateLetterSpacingEffect(e,r.letterSpacing),l=this.calculateLineHeightEffect(e,t.font_size,r.lineHeight),o=this.calculateParagraphSpacingEffect(e,r.paragraphSpacing);return{containerBounds:s.containerBounds,positioning:s.positioning,fontMetrics:s.fontMetrics,typography:{adjustedWidth:s.containerBounds.width+a.widthIncrease,adjustedHeight:s.containerBounds.height+l.heightIncrease+o.heightIncrease,letterSpacingData:a,lineHeightData:l,paragraphData:o}}}calculateLetterSpacingEffect(e,t){const i=e.split(`
`),s=i.reduce((a,l)=>a+l.length,0),r=Math.max(0,s-i.length);return{spacingValue:t,totalSpaces:r,widthIncrease:r*t,charPositions:[]}}calculateLineHeightEffect(e,t,i){const r=e.split(`
`).length,a=t*i,l=t*1.2,o=a-l;return{lineHeightRatio:i,actualLineHeight:a,lineCount:r,heightIncrease:o*Math.max(0,r-1),baselinePositions:[]}}calculateParagraphSpacingEffect(e,t){const s=e.split(`

`).length;return{spacing:t,paragraphCount:s,heightIncrease:t*Math.max(0,s-1),paragraphPositions:[]}}createProfessionalTextElement(e,t,i,s){const r=document.createElementNS("http://www.w3.org/2000/svg","g");return r.setAttribute("class","professional-text-container"),this.renderMultipleFills(r,e,i.fills),this.renderEffects(r,e,i.effects),this.renderTypographyText(r,e,t,i),this.renderTextDecorations(r,e,t,i.typography.decoration),r}renderMultipleFills(e,t,i){if(i&&i.length>0&&i[0].enabled){const s=i[0];s.type==="solid"&&s.solid&&console.log("🎨 应用纯色填充:",s.solid.color)}}renderEffects(e,t,i){if(!i||i.length===0)return;const s=document.createElementNS("http://www.w3.org/2000/svg","defs"),r=document.createElementNS("http://www.w3.org/2000/svg","filter"),a=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;r.id=a;for(const l of i)if(l.enabled&&l.type==="drop-shadow"&&l.dropShadow){const o=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");o.setAttribute("dx",l.dropShadow.offsetX.toString()),o.setAttribute("dy",l.dropShadow.offsetY.toString()),o.setAttribute("stdDeviation",l.dropShadow.blur.toString()),o.setAttribute("flood-color",l.dropShadow.color),o.setAttribute("flood-opacity",l.dropShadow.opacity.toString()),r.appendChild(o),console.log("✨ 应用投影效果")}r.children.length>0&&(s.appendChild(r),e.appendChild(s),e.setAttribute("filter",`url(#${a})`))}renderTypographyText(e,t,i,s){const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("font-family",s.font_family),r.setAttribute("font-size",s.font_size.toString()),r.setAttribute("font-weight",s.font_weight),r.setAttribute("fill",s.fills[0]?.solid?.color||s.color),r.setAttribute("text-anchor",this.getTextAnchor(s.align));const a=i.split(`
`),l=s.typography;a.forEach((o,c)=>{const d=document.createElementNS("http://www.w3.org/2000/svg","tspan");l.letterSpacing!==0&&d.setAttribute("letter-spacing",`${l.letterSpacing}px`);const h=t.positioning.textAnchorY+c*t.typography.lineHeightData.actualLineHeight;if(d.setAttribute("x",t.positioning.textAnchorX.toString()),d.setAttribute("y",h.toString()),c===0&&l.textIndent!==0){const g=t.positioning.textAnchorX+l.textIndent;d.setAttribute("x",g.toString())}l.textTransform&&l.textTransform!=="none"?d.textContent=this.applyTextTransform(o,l.textTransform):d.textContent=o,r.appendChild(d)}),e.appendChild(r)}renderTextDecorations(e,t,i,s){if(!s.underline&&!s.strikethrough&&!s.overline)return;const r=i.split(`
`),a=s.decorationColor||"#000000",l=s.decorationThickness||1,o=s.decorationStyle==="dashed"?"4,2":s.decorationStyle==="dotted"?"1,1":"none";r.forEach((c,d)=>{if(!c.trim())return;const h=t.positioning.textAnchorY+d*t.typography.lineHeightData.actualLineHeight,g=c.length*t.fontMetrics.fontSize*.6,v=t.positioning.textAnchorX,u=v+g;if(s.underline){const p=h+t.fontMetrics.fontSize*.1;this.createDecorationLine(e,v,p,u,p,a,l,o,"underline")}if(s.strikethrough){const p=h-t.fontMetrics.fontSize*.3;this.createDecorationLine(e,v,p,u,p,a,l,o,"strikethrough")}if(s.overline){const p=h-t.fontMetrics.fontSize*.8;this.createDecorationLine(e,v,p,u,p,a,l,o,"overline")}})}createDecorationLine(e,t,i,s,r,a,l,o,c){const d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",t.toString()),d.setAttribute("y1",i.toString()),d.setAttribute("x2",s.toString()),d.setAttribute("y2",r.toString()),d.setAttribute("stroke",a),d.setAttribute("stroke-width",l.toString()),d.setAttribute("stroke-dasharray",o),d.setAttribute("class",`text-decoration-${c}`),e.appendChild(d)}getTextAnchor(e){switch(e){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(e,t){switch(t){case"uppercase":return e.toUpperCase();case"lowercase":return e.toLowerCase();case"capitalize":return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase();default:return e}}}const Ta=new ka;var Ea=x("<button class=search-clear title=清除搜索>✕"),Pa=x('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),Aa=x("<button><span class=category-icon></span><span class=category-label>"),Ra=x("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),La=x("<span class=usage-count>"),Ma=x("<button class=edit-button title=编辑样式>✏️"),Da=x("<span class=system-badge title=系统预设样式>🔒"),Oa=x("<div class=selection-indicator>✓");const Ia=n=>{const[e,t]=J("bank-special"),[i,s]=J(""),[r,a]=J([]);(async()=>{await Xe.initialize();const g=Xe.getStylesByCategory();a(g)})();const o=Me(()=>{let g=r();e()&&(g=g.filter(u=>u.category===e()));const v=i().toLowerCase().trim();return v&&(g=g.filter(u=>u.name.toLowerCase().includes(v)||u.description.toLowerCase().includes(v)||u.metadata.tags.some(p=>p.toLowerCase().includes(v)))),g}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],d=g=>{console.log("🎯 选择样式:",g),n.onStyleSelect(g)},h=g=>{t(g),console.log("📂 切换分类:",g)};return(()=>{var g=Pa(),v=g.firstChild,u=v.nextSibling,p=u.firstChild,m=p.firstChild,b=m.nextSibling,_=u.nextSibling,w=_.firstChild,S=_.nextSibling,C=S.firstChild,A=C.firstChild;return f(v,y(pe,{each:c,children:M=>(()=>{var D=Aa(),z=D.firstChild,E=z.nextSibling;return D.$$click=()=>h(M.key),f(z,()=>M.icon),f(E,()=>M.label),G(R=>{var k=`category-button ${e()===M.key?"active":""}`,q=M.label;return k!==R.e&&Se(D,R.e=k),q!==R.t&&Q(D,"title",R.t=q),R},{e:void 0,t:void 0}),D})()})),b.$$input=M=>s(M.target.value),f(p,y(W,{get when(){return i()},get children(){var M=Ea();return M.$$click=()=>s(""),M}}),null),f(_,y(pe,{get each(){return o()},children:M=>y(Na,{style:M,get selected(){return n.selectedStyleId===M.id},onClick:()=>d(M.id),onEdit:()=>n.onStyleEdit(M.id)})}),w),Ae(w,"click",n.onStyleCreate),f(C,()=>o().length,A),f(C,(()=>{var M=Ce(()=>!!i());return()=>M()&&` (搜索: "${i()}")`})(),null),G(()=>b.value=i()),g})()},Na=n=>{const e=()=>{switch(n.style.category){case"bank-special":return n.style.id.includes("amount")?"¥123,456.78":n.style.id.includes("account")?"6222 0012 3456 7890":n.style.id.includes("institution")?n.style.name:n.style.id.includes("date")?"2025-08-19":n.style.name;case"heading":return n.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return n.style.name}},t=Me(()=>{const r=n.style.style;return{fontFamily:r.font_family,fontSize:`${Math.min(r.font_size,14)}px`,fontWeight:r.font_weight,color:r.fills?.[0]?.solid?.color||r.color,textAlign:r.align.toLowerCase(),letterSpacing:`${r.typography?.letterSpacing||0}px`,textDecoration:r.typography?.decoration?.underline?"underline":r.typography?.decoration?.strikethrough?"line-through":"none"}}),i=r=>{r.preventDefault(),n.onClick()},s=r=>{r.preventDefault(),r.stopPropagation(),n.onEdit()};return(()=>{var r=Ra(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.nextSibling,d=c.firstChild,h=l.nextSibling;return r.$$click=i,f(a,e),f(o,()=>n.style.name),f(d,()=>za(n.style.category)),f(c,(()=>{var g=Ce(()=>n.style.metadata.usageCount>0);return()=>g()&&(()=>{var v=La();return f(v,()=>n.style.metadata.usageCount),G(()=>Q(v,"title",`使用次数: ${n.style.metadata.usageCount}`)),v})()})(),null),f(h,(()=>{var g=Ce(()=>!n.style.metadata.isSystemStyle);return()=>g()&&(()=>{var v=Ma();return v.$$click=s,v})()})(),null),f(h,(()=>{var g=Ce(()=>!!n.style.metadata.isSystemStyle);return()=>g()&&Da()})(),null),f(r,(()=>{var g=Ce(()=>!!n.selected);return()=>g()&&Oa()})(),null),G(g=>{var v=`style-card ${n.selected?"selected":""} ${n.style.metadata.isSystemStyle?"system-style":"user-style"}`,u=t();return v!==g.e&&Se(r,g.e=v),g.t=qs(a,u,g.t),g},{e:void 0,t:void 0}),r})()};function za(n){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[n]||n}Ue(["input","click"]);var Fa=x("<button class=style-picker-toggle>"),Ga=x("<button class=style-reload-btn title=重新加载样式系统>🔄"),Ba=x("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),Ua=x("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),Ha=x("<div class=style-picker-panel>"),qa=x("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),Wa=x("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),ja=x('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),Ya=x("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),Va=x('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const Wi=n=>{const[e,t]=J(null),[i,s]=J(!1),[r,a]=J([]),[l,o]=J(!1);et(async()=>{try{await Xe.initialize();const b=Xe.getElementStyleId(n.element.id);t(b);const _=Xe.getStylesByCategory();a(_),o(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch(b){console.error("❌ 专业文字属性面板初始化失败:",b)}});const c=Me(()=>{const b=e();return b?Xe.getStyle(b):null}),d=Me(()=>n.element.content.type==="Text"||n.element.content.type==="DataField"),h=async b=>{try{const _=await Xe.applyStyleToElement(n.element.id,b);if(_.success){t(b);const w=Xe.getStyle(b);if(w){const S=g(w.style);n.onUpdate(n.element.id,"content",{...n.element.content,style:S})}console.log("✅ 样式应用成功:",_)}else console.error("❌ 样式应用失败:",_.error)}catch(_){console.error("❌ 样式选择处理失败:",_)}},g=b=>({font_family:b.font_family,font_size:b.font_size,font_weight:b.font_weight,color:b.fills?.[0]?.solid?.color||b.color,align:b.align}),v=()=>{console.log("🆕 创建新样式")},u=b=>{console.log("✏️ 编辑样式:",b)},p=()=>{s(!i())},m=()=>{e()&&(Xe.removeElementStyle(n.element.id),t(null),console.log("🗑️ 移除元素样式"))};return d()?(()=>{var b=Ya(),_=b.firstChild,w=_.firstChild,S=w.firstChild,C=S.nextSibling,A=C.nextSibling,M=w.nextSibling;return f(A,y(W,{get when(){return l()},get children(){var D=Fa();return D.$$click=p,f(D,()=>i()?"📝":"📚"),G(()=>Q(D,"title",i()?"隐藏样式库":"显示样式库")),D}}),null),f(A,y(W,{get when(){return!l()},get children(){var D=Ga();return D.$$click=()=>window.location.reload(),D}}),null),f(M,y(W,{get when(){return!l()},get children(){var D=Ba(),z=D.firstChild,E=z.firstChild,R=E.nextSibling,k=R.nextSibling,q=k.firstChild;return q.$$click=async()=>{try{await Xe.initialize();const N=Xe.getStylesByCategory();a(N),o(!0),console.log("🔄 样式系统重新初始化成功")}catch(N){console.error("❌ 重新初始化失败:",N)}},D}}),null),f(M,y(W,{get when(){return l()},get children(){return[y(W,{get when(){return c()},children:D=>(()=>{var z=Va(),E=z.firstChild,R=E.firstChild,k=R.firstChild,q=k.nextSibling,N=R.nextSibling,$=N.firstChild,P=$.nextSibling;return f(k,()=>D().name),f(q,()=>Xa(D().category)),$.$$click=()=>u(D().id),P.$$click=m,z})()}),y(W,{get when(){return!c()},get children(){var D=Ua(),z=D.firstChild,E=z.nextSibling;return z.$$click=p,E.$$click=v,D}}),y(W,{get when(){return i()},get children(){var D=Ha();return f(D,y(Ia,{get selectedStyleId(){return e()},onStyleSelect:h,onStyleCreate:v,onStyleEdit:u})),D}})]}}),null),f(b,y(W,{get when(){return c()},get children(){return qa()}}),null),f(b,y(W,{get when(){return c()},get children(){return Wa()}}),null),f(b,y(W,{get when(){return!1},get children(){var D=ja(),z=D.firstChild,E=z.nextSibling,R=E.firstChild,k=R.firstChild,q=k.firstChild,N=q.nextSibling,$=k.nextSibling,P=$.firstChild,X=P.nextSibling,F=$.nextSibling,O=F.firstChild,V=O.nextSibling,B=V.firstChild,H=F.nextSibling,j=H.firstChild,de=j.nextSibling;return f(N,()=>n.element.id),f(X,()=>e()||"无"),f(V,()=>r().length,B),f(de,()=>Ta.isElementUsingProfessionalStyle(n.element.id)?"是":"否"),D}}),null),b})():null};function Xa(n){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[n]||n}Ue(["click"]);var Qa=x('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),Ka=x('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),Ja=x("<span class=property-value>"),Za=x('<span class="property-value text-xs text-muted">'),Wn=x("<div class=space-y-2>"),Jt=x("<input type=number class=property-input>"),el=x('<div class="grid grid-cols-2 gap-2">'),ji=x("<input type=checkbox class=property-checkbox>"),tl=x('<div class="p-4 space-y-4">'),Yi=x("<div>"),nl=x("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),il=x("<div class=property-field><label class=property-label>"),sl=x("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),Zs=x('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),er=x("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),rl=x('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),tr=x("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),al=x('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),nr=x('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),ir=x('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),ll=x('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),ol=x("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),Vi=x("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),cl=x('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),dl=x("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),hl=x("<input type=text class=property-input placeholder=图片描述文字>"),ul=x("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),gl=x("<div class=space-y-3>"),fl=x("<img class=property-image>"),vl=x("<div class=property-loading>加载数据源..."),pl=x('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),ml=x('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),bl=x('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),yl=x('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),_l=x("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),xl=x("<div class=space-y-4>"),Sl=x("<select class=property-select><option value>选择数据源"),wl=x("<option> (<!>)"),$l=x('<div class=flex><input type=number class="property-input flex-1">'),Cl=x("<span class=property-unit>"),kl=x('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),Tl=x("<div class=property-alignment-group>"),El=x("<button>");const Xi=()=>{const{state:n,updateElement:e}=at(),t=Me(()=>{const r=new Set(n.selected_ids);return n.elements.filter(a=>r.has(a.id))}),i=Me(()=>t()[0]),s=async(r,a,l)=>{try{await e(r,{[a]:l})}catch(o){console.error("Failed to update element property:",o)}};return(()=>{var r=Qa(),a=r.firstChild,l=a.nextSibling;return f(l,y(W,{get when(){return i()},get fallback(){return Ka()},get children(){return y(Pl,{get element(){return i()},onUpdate:s})}})),r})()},Pl=n=>{const e=(i,s)=>{const r={...n.element.position,[i]:s};n.onUpdate(n.element.id,"position",r)},t=(i,s)=>{const r={...n.element.size,[i]:Math.max(1,s)};n.onUpdate(n.element.id,"size",r)};return(()=>{var i=tl();return f(i,y(vt,{title:"元素信息",icon:"ℹ️",get children(){var s=Wn();return f(s,y(we,{label:"类型",get children(){var r=Ja();return f(r,()=>n.element.content.type),r}}),null),f(s,y(we,{label:"ID",get children(){var r=Za();return f(r,()=>n.element.id),r}}),null),s}}),null),f(i,y(vt,{title:"位置和大小",icon:"📐",get children(){var s=el();return f(s,y(we,{label:"X",get children(){var r=Jt();return r.$$input=a=>e("x",parseFloat(a.target.value)||0),G(()=>r.value=n.element.position.x),r}}),null),f(s,y(we,{label:"Y",get children(){var r=Jt();return r.$$input=a=>e("y",parseFloat(a.target.value)||0),G(()=>r.value=n.element.position.y),r}}),null),f(s,y(we,{label:"宽度",get children(){var r=Jt();return r.$$input=a=>t("width",parseFloat(a.target.value)||1),G(()=>r.value=n.element.size.width),r}}),null),f(s,y(we,{label:"高度",get children(){var r=Jt();return r.$$input=a=>t("height",parseFloat(a.target.value)||1),G(()=>r.value=n.element.size.height),r}}),null),s}}),null),f(i,y(vt,{title:"状态",icon:"👁️",get children(){var s=Wn();return f(s,y(we,{label:"可见",get children(){var r=ji();return r.addEventListener("change",a=>n.onUpdate(n.element.id,"visible",a.target.checked)),G(()=>r.checked=n.element.visible),r}}),null),f(s,y(we,{label:"锁定",get children(){var r=ji();return r.addEventListener("change",a=>n.onUpdate(n.element.id,"locked",a.target.checked)),G(()=>r.checked=n.element.locked),r}}),null),f(s,y(we,{label:"层级",get children(){var r=Jt();return r.$$input=a=>n.onUpdate(n.element.id,"z_index",parseInt(a.target.value)||0),G(()=>r.value=n.element.z_index),r}}),null),s}}),null),f(i,y(Hs,{get children(){return[y(xt,{get when(){return n.element.content.type==="Text"&&n.element.content},children:s=>(()=>{var r=Yi();return f(r,y(Wi,{get element(){return n.element},get onUpdate(){return n.onUpdate}}),null),f(r,y(Al,{get content(){return s()},onUpdate:a=>{console.log("Text content update:",a),n.onUpdate(n.element.id,"content",a)}}),null),r})()}),y(xt,{get when(){return n.element.content.type==="Rectangle"&&n.element.content},children:s=>y(Rl,{get content(){return s()},onUpdate:r=>{console.log("Rectangle content update:",r),n.onUpdate(n.element.id,"content",r)}})}),y(xt,{get when(){return n.element.content.type==="Line"&&n.element.content},children:s=>y(Ll,{get content(){return s()},onUpdate:r=>{console.log("Line content update:",r),n.onUpdate(n.element.id,"content",r)}})}),y(xt,{get when(){return n.element.content.type==="Image"&&n.element.content},children:s=>y(Ml,{get content(){return s()},onUpdate:r=>{console.log("Image content update:",r),n.onUpdate(n.element.id,"content",r)}})}),y(xt,{get when(){return n.element.content.type==="DataField"&&n.element.content},children:s=>(()=>{var r=Yi();return f(r,y(Wi,{get element(){return n.element},get onUpdate(){return n.onUpdate}}),null),f(r,y(Dl,{get content(){return s()},onUpdate:a=>{console.log("🔍 [PropertiesPanel] DataField content update 接收到:",{更新内容:a,元素ID:n.element.id,当前content:s(),更新前data_source_id:s().data_source_id}),n.onUpdate(n.element.id,"content",a),console.log("🔍 [PropertiesPanel] 已调用 props.onUpdate")}}),null),r})()})]}}),null),i})()},vt=n=>(()=>{var e=nl(),t=e.firstChild,i=t.firstChild,s=i.nextSibling,r=t.nextSibling;return f(i,()=>n.icon),f(s,()=>n.title),f(r,()=>n.children),e})(),we=n=>(()=>{var e=il(),t=e.firstChild;return f(t,()=>n.label),f(e,()=>n.children,null),e})(),Al=n=>y(vt,{title:"文字样式",icon:"🔤",get children(){var e=nr(),t=e.firstChild,i=t.nextSibling;return f(e,y(we,{label:"内容",get children(){var s=sl();return s.$$input=r=>n.onUpdate({content:r.target.value}),G(()=>s.value=n.content.content),s}}),t),f(t,y(we,{label:"字体",get children(){var s=Zs();return s.addEventListener("change",r=>n.onUpdate({style:{...n.content.style,font_family:r.target.value}})),G(()=>s.value=n.content.style.font_family),s}}),null),f(t,y(we,{label:"大小",get children(){return y(gt,{get value(){return n.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:s=>n.onUpdate({style:{...n.content.style,font_size:s}})})}}),null),f(i,y(we,{label:"字重",get children(){var s=er();return s.addEventListener("change",r=>n.onUpdate({style:{...n.content.style,font_weight:r.target.value}})),G(()=>s.value=n.content.style.font_weight),s}}),null),f(i,y(we,{label:"对齐",get children(){return y(sr,{get value(){return n.content.style.align},onUpdate:s=>n.onUpdate({style:{...n.content.style,align:s}})})}}),null),f(e,y(we,{label:"颜色",get children(){return y(Mt,{get value(){return n.content.style.color},onUpdate:s=>n.onUpdate({style:{...n.content.style,color:s}})})}}),null),f(e,y(we,{label:"背景",get children(){var s=rl(),r=s.firstChild;return f(s,y(Mt,{get value(){return n.content.style.background?.color||"transparent"},onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,color:a}}})}),r),f(r,y(we,{label:"透明度",get children(){return y(gt,{get value(){return n.content.style.background?.opacity||1},min:0,max:1,step:.1,onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,opacity:a}}})})}}),null),f(r,y(we,{label:"内边距",get children(){return y(gt,{get value(){return n.content.style.background?.padding||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,padding:a}}})})}}),null),s}}),null),f(e,y(we,{label:"边框",get children(){var s=al(),r=s.firstChild;return f(s,y(Mt,{get value(){return n.content.style.border?.color||"#000000"},onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,color:a}}})}),r),f(r,y(we,{label:"宽度",get children(){return y(gt,{get value(){return n.content.style.border?.width||1},min:0,max:10,step:.5,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,width:a}}})})}}),null),f(r,y(we,{label:"样式",get children(){var a=tr();return a.addEventListener("change",l=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,style:l.target.value}}})),G(()=>a.value=n.content.style.border?.style||"Solid"),a}}),null),f(r,y(we,{label:"圆角",get children(){return y(gt,{get value(){return n.content.style.border?.radius||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,radius:a}}})})}}),null),s}}),null),e}}),Rl=n=>y(vt,{title:"矩形样式",icon:"▭",get children(){var e=ll(),t=e.firstChild,i=t.firstChild;return f(e,y(we,{label:"填充颜色",get children(){return y(Mt,{get value(){return n.content.fill_color||"#ffffff"},onUpdate:s=>n.onUpdate({fill_color:s})})}}),t),f(t,y(we,{label:"边框",get children(){var s=Wn();return f(s,y(Mt,{get value(){return n.content.border?.color||"#000000"},onUpdate:r=>n.onUpdate({border:{...n.content.border,color:r}})})),s}}),i),f(i,y(we,{label:"宽度",get children(){return y(gt,{get value(){return n.content.border?.width||1},min:0,max:20,step:.5,unit:"px",onUpdate:s=>n.onUpdate({border:{...n.content.border,width:s}})})}}),null),f(i,y(we,{label:"样式",get children(){var s=tr();return s.addEventListener("change",r=>n.onUpdate({border:{...n.content.border,style:r.target.value}})),G(()=>s.value=n.content.border?.style||"Solid"),s}}),null),f(e,y(we,{label:"圆角半径",get children(){return y(gt,{get value(){return n.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:s=>n.onUpdate({corner_radius:s})})}}),null),f(e,y(we,{label:"透明度",get children(){var s=ir(),r=s.firstChild,a=r.nextSibling,l=a.firstChild;return r.$$input=o=>n.onUpdate({opacity:parseFloat(o.target.value)/100}),f(a,()=>Math.round((n.content.opacity||1)*100),l),G(()=>r.value=(n.content.opacity||1)*100),s}}),null),e}}),Ll=n=>y(vt,{title:"线条样式",icon:"━",get children(){var e=cl(),t=e.firstChild;return f(e,y(we,{label:"颜色",get children(){return y(Mt,{get value(){return n.content.color},onUpdate:i=>n.onUpdate({color:i})})}}),t),f(e,y(we,{label:"宽度",get children(){return y(gt,{get value(){return n.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:i=>n.onUpdate({width:i})})}}),t),f(e,y(we,{label:"样式",get children(){var i=ol();return i.addEventListener("change",s=>n.onUpdate({line_style:s.target.value})),G(()=>i.value=n.content.line_style||"Solid"),i}}),t),f(t,y(we,{label:"起点",get children(){var i=Vi();return i.addEventListener("change",s=>n.onUpdate({start_cap:s.target.value})),G(()=>i.value=n.content.start_cap||"None"),i}}),null),f(t,y(we,{label:"终点",get children(){var i=Vi();return i.addEventListener("change",s=>n.onUpdate({end_cap:s.target.value})),G(()=>i.value=n.content.end_cap||"None"),i}}),null),f(e,y(we,{label:"透明度",get children(){var i=ir(),s=i.firstChild,r=s.nextSibling,a=r.firstChild;return s.$$input=l=>n.onUpdate({opacity:parseFloat(l.target.value)/100}),f(r,()=>Math.round((n.content.opacity||1)*100),a),G(()=>s.value=(n.content.opacity||1)*100),i}}),null),e}}),Ml=n=>y(vt,{title:"图片属性",icon:"🖼️",get children(){var e=gl();return f(e,y(we,{label:"图片地址",get children(){var t=dl();return t.$$input=i=>n.onUpdate({src:i.target.value}),G(()=>t.value=n.content.src),t}}),null),f(e,y(we,{label:"替代文本",get children(){var t=hl();return t.$$input=i=>n.onUpdate({alt:i.target.value}),G(()=>t.value=n.content.alt||""),t}}),null),f(e,y(we,{label:"预览",get children(){var t=ul(),i=t.firstChild;return f(t,(()=>{var s=Ce(()=>!!n.content.src);return()=>s()?(()=>{var r=fl();return r.addEventListener("load",a=>{const l=a.target,o=l.nextElementSibling;l&&(l.style.display="block"),o&&(o.style.display="none")}),r.addEventListener("error",a=>{const l=a.target,o=l.nextElementSibling;l&&(l.style.display="none"),o&&(o.style.display="flex")}),G(a=>{var l=n.content.src,o=n.content.alt||"图片预览";return l!==a.e&&Q(r,"src",a.e=l),o!==a.t&&Q(r,"alt",a.t=o),a},{e:void 0,t:void 0}),r})():null})(),i),G(s=>(s=n.content.src?"none":"flex")!=null?i.style.setProperty("display",s):i.style.removeProperty("display")),t}}),null),e}}),Dl=n=>{const[e,t]=J([]),[i,s]=J(!1);mn(()=>{console.log("🔍 [DataFieldProperties] props.content 变化:",{data_source_id:n.content.data_source_id,expression:n.content.expression,完整content:n.content})}),et(async()=>{try{s(!0);const l=await Re.listDataSources();t(l)}catch(l){console.error("Failed to load data sources:",l)}finally{s(!1)}});const r=l=>{console.log("🔍 [DataField] handleDataSourceChange 触发:",{新值:l,当前值:n.content.data_source_id,是否为空:l==="",将要更新的值:l===""?void 0:l}),n.onUpdate({data_source_id:l===""?void 0:l}),console.log("🔍 [DataField] onUpdate 已调用，等待父组件更新"),setTimeout(()=>{console.log("🔍 [DataField] 更新后检查:",{更新后的值:n.content.data_source_id,是否更新成功:n.content.data_source_id===(l===""?void 0:l)})},100)},a=Me(()=>n.content.data_source_id?e().find(l=>l.id===n.content.data_source_id):null);return(()=>{var l=xl();return f(l,y(vt,{title:"数据源配置",icon:"🔗",get children(){var o=Wn();return f(o,y(we,{label:"数据源",get children(){return y(W,{get when(){return i()},get fallback(){return(()=>{var c=Sl();return c.firstChild,c.$$input=d=>{console.log("🔍 [DataField] select onInput 事件触发:",d.currentTarget.value)},c.addEventListener("change",d=>{console.log("🔍 [DataField] select onChange 事件触发:",{target:d.target,currentTarget:d.currentTarget,value:d.currentTarget.value,selectedIndex:d.currentTarget.selectedIndex,selectedOption:d.currentTarget.options[d.currentTarget.selectedIndex]?.text}),r(d.currentTarget.value)}),f(c,y(pe,{get each(){return e()},children:d=>(console.log("🔍 [DataField] 渲染数据源选项:",{id:d.id,name:d.name,当前选中:n.content.data_source_id===d.id}),(()=>{var h=wl(),g=h.firstChild,v=g.nextSibling;return v.nextSibling,f(h,()=>d.name,g),f(h,()=>d.providerType||d.provider_type,v),G(()=>h.value=d.id),h})())}),null),G(()=>c.value=n.content.data_source_id||""),c})()},get children(){return vl()}})}}),null),f(o,y(W,{get when(){return a()},get children(){var c=pl(),d=c.firstChild,h=d.firstChild,g=h.firstChild,v=g.nextSibling,u=v.nextSibling,p=h.nextSibling,m=p.firstChild;m.nextSibling;var b=p.nextSibling,_=b.firstChild;return _.nextSibling,f(u,(()=>{var w=Ce(()=>a().status==="active");return()=>w()?"活跃":a().status==="error"?"错误":"禁用"})()),f(p,()=>a().providerType||a().provider_type,null),f(b,()=>new Date(a().lastUpdated||a().last_updated).toLocaleString("zh-CN"),null),G(()=>Se(u,a().status==="active"?"text-green-600":a().status==="error"?"text-red-600":"text-gray-600")),c}}),null),f(o,y(we,{label:"表达式",get children(){var c=ml();return c.$$input=d=>n.onUpdate({expression:d.currentTarget.value}),c.disabled=!1,G(()=>c.value=n.content.expression||""),c}}),null),f(o,y(W,{get when(){return!n.content.expression||!n.content.expression.trim()},get children(){return bl()}}),null),f(o,y(W,{get when(){return n.content.expression&&!n.content.data_source_id},get children(){return yl()}}),null),f(o,y(we,{label:"格式",get children(){var c=_l();return c.addEventListener("change",d=>n.onUpdate({format:d.currentTarget.value==="default"?void 0:d.currentTarget.value})),G(()=>c.value=n.content.format||"default"),c}}),null),o}}),null),f(l,y(vt,{title:"字段样式",icon:"🎨",get children(){var o=nr(),c=o.firstChild,d=c.nextSibling;return f(c,y(we,{label:"字体",get children(){var h=Zs();return h.addEventListener("change",g=>n.onUpdate({style:{...n.content.style,font_family:g.currentTarget.value}})),G(()=>h.value=n.content.style.font_family),h}}),null),f(c,y(we,{label:"大小",get children(){return y(gt,{get value(){return n.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:h=>n.onUpdate({style:{...n.content.style,font_size:h}})})}}),null),f(d,y(we,{label:"字重",get children(){var h=er();return h.addEventListener("change",g=>n.onUpdate({style:{...n.content.style,font_weight:g.currentTarget.value}})),G(()=>h.value=n.content.style.font_weight),h}}),null),f(d,y(we,{label:"对齐",get children(){return y(sr,{get value(){return n.content.style.align},onUpdate:h=>n.onUpdate({style:{...n.content.style,align:h}})})}}),null),f(o,y(we,{label:"颜色",get children(){return y(Mt,{get value(){return n.content.style.color},onUpdate:h=>n.onUpdate({style:{...n.content.style,color:h}})})}}),null),o}}),null),l})()},gt=n=>(()=>{var e=$l(),t=e.firstChild;return t.addEventListener("blur",i=>{const s=parseFloat(i.target.value)||n.value,r=Math.max(n.min||-1/0,Math.min(n.max||1/0,s));r!==s&&(i.target.value=r.toString(),n.onUpdate(r))}),t.$$input=i=>{const s=parseFloat(i.target.value);if(!isNaN(s)){const r=Math.max(n.min||-1/0,Math.min(n.max||1/0,s));n.onUpdate(r)}},f(e,(()=>{var i=Ce(()=>!!n.unit);return()=>i()&&(()=>{var s=Cl();return f(s,()=>n.unit),s})()})(),null),G(i=>{var s=n.min,r=n.max,a=n.step||1;return s!==i.e&&Q(t,"min",i.e=s),r!==i.t&&Q(t,"max",i.t=r),a!==i.a&&Q(t,"step",i.a=a),i},{e:void 0,t:void 0,a:void 0}),G(()=>t.value=n.value),e})(),Mt=n=>(()=>{var e=kl(),t=e.firstChild,i=t.firstChild,s=i.nextSibling,r=t.nextSibling;return i.$$input=a=>n.onUpdate(a.target.value),r.$$input=a=>{const l=a.target.value;(/^#[0-9A-Fa-f]{6}$/.test(l)||/^#[0-9A-Fa-f]{3}$/.test(l))&&n.onUpdate(l)},G(a=>(a=n.value)!=null?s.style.setProperty("background-color",a):s.style.removeProperty("background-color")),G(()=>i.value=n.value),G(()=>r.value=n.value),e})(),sr=n=>{const e=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var t=Tl();return f(t,()=>e.map(i=>(()=>{var s=El();return s.$$click=()=>n.onUpdate(i.value),f(s,()=>i.icon),G(r=>{var a=`property-alignment-btn ${n.value===i.value?"active":""}`,l=i.label;return a!==r.e&&Se(s,r.e=a),l!==r.t&&Q(s,"title",r.t=l),r},{e:void 0,t:void 0}),s})())),t})()};Ue(["input","click"]);var Ol=x("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),Il=x("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const Nl=n=>y(W,{get when(){return n.config.show_grid},get children(){return[(()=>{var e=Ol(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return G(r=>{var a=n.config.grid_size,l=n.config.grid_size,o=n.config.grid_size,c=n.config.grid_size,d=n.config.grid_size,h=n.config.grid_size,g=n.config.grid_size,v=n.config.grid_size;return a!==r.e&&Q(t,"width",r.e=a),l!==r.t&&Q(t,"height",r.t=l),o!==r.a&&Q(i,"x1",r.a=o),c!==r.o&&Q(i,"x2",r.o=c),d!==r.i&&Q(i,"y2",r.i=d),h!==r.n&&Q(s,"y1",r.n=h),g!==r.s&&Q(s,"x2",r.s=g),v!==r.h&&Q(s,"y2",r.h=v),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),e})(),(()=>{var e=Il();return G(t=>{var i=n.config.width,s=n.config.height;return i!==t.e&&Q(e,"width",t.e=i),s!==t.t&&Q(e,"height",t.t=s),t},{e:void 0,t:void 0}),e})()]}});class zl{expressionCache=new Map;maxCacheSize=1e3;async evaluateExpression(e,t){if(!e||!e.trim())return{success:!1,error:"表达式不能为空"};if(!t)return{success:!1,error:"没有可用的数据上下文"};try{const i=this.preprocessExpression(e),s=this.getCompiledExpression(i),r=await this.executeCompiledExpression(s,t);return{success:!0,value:r.value,type:this.inferValueType(r.value)}}catch(i){return{success:!1,error:i instanceof Error?i.message:String(i)}}}validateExpression(e,t){if(!e||!e.trim())return{valid:!1,error:"表达式不能为空"};try{const i=this.preprocessExpression(e),s=this.compileExpression(i);return this.staticValidation(s,t)}catch(i){return{valid:!1,error:i instanceof Error?i.message:"表达式格式错误"}}}getFieldSuggestions(e,t){if(!t)return[];const i=e.toLowerCase().replace(/[{}]/g,""),s=[];if(t.fields.forEach(r=>{r.name.toLowerCase().includes(i)&&s.push(`{${r.name}}`),r.displayName&&r.displayName.toLowerCase().includes(i)&&s.push(`{${r.name}}`)}),t.currentRecord.data){const r=this.getNestedFieldSuggestions(i,t.currentRecord.data,"");s.push(...r)}return Array.from(new Set(s)).sort((r,a)=>{const l=r.replace(/[{}]/g,""),o=a.replace(/[{}]/g,"");return l===i?-1:o===i?1:l.startsWith(i)?-1:o.startsWith(i)?1:l.localeCompare(o)}).slice(0,20)}preprocessExpression(e){let t=e.trim();return!t.startsWith("{")&&!t.endsWith("}")&&(t=`{${t}}`),t=t.replace(/^\{+/,"{").replace(/\}+$/,"}"),t}getCompiledExpression(e){let t=this.expressionCache.get(e);if(!t){if(t=this.compileExpression(e),this.expressionCache.size>=this.maxCacheSize){const i=this.expressionCache.keys().next().value;i&&this.expressionCache.delete(i)}this.expressionCache.set(e,t)}return t}compileExpression(e){const t=e.slice(1,-1),i=this.parsePath(t);return{original:e,path:i,type:this.determineExpressionType(i)}}parsePath(e){const t=[];let i="",s=!1;for(let r=0;r<e.length;r++){const a=e[r];if(a==="["&&!s)i&&(t.push({type:"field",value:i}),i=""),s=!0;else if(a==="]"&&s){const l=parseInt(i,10);if(isNaN(l))throw new Error(`无效的数组索引: ${i}`);t.push({type:"index",value:l}),i="",s=!1}else a==="."&&!s?i&&(t.push({type:"field",value:i}),i=""):i+=a}if(i){if(s)throw new Error("未闭合的数组索引");t.push({type:"field",value:i})}if(t.length===0)throw new Error("空的字段路径");return t}async executeCompiledExpression(e,t){let i=t.currentRecord.data;for(const s of e.path){if(i==null)throw new Error("无法访问 null/undefined 值的属性");if(s.type==="field"){if(typeof i!="object")throw new Error(`尝试访问非对象类型的字段: ${s.value}`);if(!(s.value in i))throw new Error(`字段不存在: ${s.value}`);i=i[s.value]}else if(s.type==="index"){if(!Array.isArray(i))throw new Error("尝试对非数组类型使用索引访问");const r=s.value;if(r<0||r>=i.length)throw new Error(`数组索引超出范围: ${r}`);i=i[r]}}return{value:i}}staticValidation(e,t){if(!t)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const i=[],s=e.path[0];if(s&&s.type==="field"){const a=s.value;if(!t.fields.some(o=>o.name===a)){const o=t.fields.filter(c=>c.name.toLowerCase().includes(a.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),a.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${a}`,suggestions:o}}}e.path.length>5&&i.push("表达式路径过深，可能影响性能");const r={valid:!0};return i.length>0&&(r.warnings=i),r}getNestedFieldSuggestions(e,t,i){const s=[];if(!t||typeof t!="object")return s;for(const r of Object.keys(t)){const a=i?`${i}.${r}`:r;a.toLowerCase().includes(e)&&s.push(`{${a}}`),i.split(".").length<3&&t[r]&&typeof t[r]=="object"&&s.push(...this.getNestedFieldSuggestions(e,t[r],a))}return s}inferValueType(e){return e==null?"object":typeof e=="string"?"string":typeof e=="number"?"number":typeof e=="boolean"?"boolean":e instanceof Date?"date":typeof e=="object"?"object":"string"}determineExpressionType(e){return e.length===1?"simple":e.length<=3&&e.every(t=>t.type==="field")?"nested":"complex"}levenshteinDistance(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const i=new Array(t.length+1);for(let s=0;s<=t.length;s++)i[s]=new Array(e.length+1),i[s][0]=s;for(let s=0;s<=e.length;s++)i[0][s]=s;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++){const a=e[r-1]===t[s-1]?0:1;i[s][r]=Math.min(i[s-1][r]+1,i[s][r-1]+1,i[s-1][r-1]+a)}return i[t.length][e.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const si=new zl;class Fl{context=J(null);subscribers=[];constructor(){this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(e){try{const i=(await Re.listDataSources()).find(d=>d.id===e);if(!i)throw new Error(`数据源不存在: ${e}`);console.log("🔍 找到数据源:",i);const s=i.providerType||i.provider_type||i.type_name||"json";console.log("🔍 推断的 providerType:",s);let r={rows:[],totalCount:0},a={columns:[]},l=null;try{r=await Re.getPreview(e,void 0,1),console.log("🔍 预览数据:",r)}catch(d){console.warn("⚠️  获取数据预览失败，继续构建上下文:",d),l=d}try{a=await Re.getSchema(e),console.log("🔍 Schema信息:",a)}catch(d){console.warn("⚠️  获取Schema失败，继续构建上下文:",d),l||(l=d)}const o=Array.isArray(a.columns)?a.columns.map(d=>({name:d.name,displayName:d.description||d.name,type:this.mapDataType(d.data_type),nullable:!!d.nullable,sample:d.default_value})):[],c={dataSource:{id:e,type:this.inferDataSourceType(s),name:i.name,status:this.mapDataSourceStatus(i.status)},currentRecord:{index:0,total:r.totalCount??r.total_rows??r.total_count??0,data:r&&r.rows&&r.rows[0]?r.rows[0]:{}},fields:o,...l?{error:{type:"system",message:String(l),details:l}}:{}};console.log("✅ 创建新的数据上下文:",c),this.context[1](c);try{typeof window<"u"&&window.localStorage&&window.localStorage.setItem("jasper.activeDataSourceId",e)}catch(d){console.warn("无法持久化激活数据源ID:",d)}this.notifySubscribers(c)}catch(t){console.error("设置数据源失败:",t);let i="",s;try{const l=(await Re.listDataSources()).find(o=>o.id===e);l&&(i=l.name,s=l.providerType||l.provider_type||l.type_name)}catch{}const r={dataSource:{id:e,type:this.inferDataSourceType(s||"json"),name:i||"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:t instanceof Error?t.message:"数据源加载失败",details:t}};this.context[1](r),this.notifySubscribers(r)}}async navigateToRecord(e){const t=this.getCurrentContext();if(!t||e<0||e>=t.currentRecord.total)return!1;try{const i=await Re.queryData(t.dataSource.id,{limit:1,offset:e});if(i.rows.length===0)return!1;const s={...t,currentRecord:{...t.currentRecord,index:e,data:i.rows[0]}};return this.context[1](s),this.notifySubscribers(s),!0}catch(i){return console.error("导航到记录失败:",i),!1}}async navigateNext(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index+1):!1}async navigatePrevious(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index-1):!1}async evaluateExpression(e){const t=this.getCurrentContext();return await si.evaluateExpression(e,t)}validateExpression(e){const t=this.getCurrentContext(),i=si.validateExpression(e,t);return{valid:i.valid,...i.error&&{error:i.error},...i.suggestions&&{suggestions:i.suggestions}}}getFieldSuggestions(e){const t=this.getCurrentContext();return si.getFieldSuggestions(e,t)}subscribe(e){return this.subscribers.push(e),()=>{const t=this.subscribers.indexOf(e);t>-1&&this.subscribers.splice(t,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(e){this.subscribers.forEach(t=>{try{t(e)}catch(i){console.error("数据上下文订阅回调错误:",i)}})}inferDataSourceType(e){if(!e)return console.warn("providerType is undefined, defaulting to json"),"json";const t=e.toLowerCase();return t==="json"?"json":t==="excel"?"excel":t==="sql"?"sql":t==="xml"?"xml":t==="csv"?"csv":t.startsWith("database")?"sql":"json"}mapDataType(e){switch(e){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(e){if(!e)return console.warn("status is undefined, defaulting to empty"),"empty";switch(e.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${e}, defaulting to empty`),"empty"}}}const Je=new Fl;var Gl=x("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),Qi=x("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),Bl=x("<svg><rect class=text-background-unified></svg>",!1,!0,!1),Ul=x("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),Hl=x("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),ql=x("<svg><tspan class=text-line-original></svg>",!1,!0,!1),Wl=x("<svg><rect x=0 y=0></svg>",!1,!0,!1),jl=x("<svg><line x1=0></svg>",!1,!0,!1),Yl=x("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),Vl=x('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),Xl=x("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),Ql=x("<svg><tspan dy=0></svg>",!1,!0,!1),Kl=x("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),Jl=x("<svg><g></svg>",!1,!0,!1);const Zl=n=>{const{state:e}=Xn(),[t,i]=J("[数据字段]");mn(()=>{if(n.element.content.type==="DataField"){const a=n.element.content.expression||"",l=e().mode;ei.shouldShowExpression(l)?i(a||"[数据字段]"):ei.shouldEvaluateExpression(l)&&Je.evaluateExpression(a).then(o=>{o.success?i(String(o.value||"")):i(`[错误: ${o.error}]`)}).catch(o=>{i(`[错误: ${o}]`)})}});const s=Me(()=>{const{position:a}=n.element;return{transform:`translate(${a.x}px, ${a.y}px)`,opacity:n.element.visible?1:.5}}),r=()=>{const{content:a,size:l}=n.element;if(a.type==="Text"&&a.content&&a.style){const o=qt.calculateUnifiedBounds(a.content,a.style,l),c=qt.getTextAnchor(a.style.align);return(()=>{var d=Gl(),h=d.firstChild;return f(d,(()=>{var g=Ce(()=>!!n.selected);return()=>g()&&(()=>{var v=Qi();return G(u=>{var p=o.containerBounds.x,m=o.containerBounds.y,b=o.containerBounds.width,_=o.containerBounds.height;return p!==u.e&&Q(v,"x",u.e=p),m!==u.t&&Q(v,"y",u.t=m),b!==u.a&&Q(v,"width",u.a=b),_!==u.o&&Q(v,"height",u.o=_),u},{e:void 0,t:void 0,a:void 0,o:void 0}),v})()})(),h),f(d,(()=>{var g=Ce(()=>!!a.style.background);return()=>g()&&(()=>{var v=Bl();return G(u=>{var p=o.positioning.backgroundX,m=o.positioning.backgroundY,b=o.containerBounds.width+(a.style.background.padding||0)*2,_=o.containerBounds.height+(a.style.background.padding||0)*2,w=a.style.background.color,S=a.style.background.opacity||1,C=a.style.border?.radius||0,A=a.style.border?.radius||0;return p!==u.e&&Q(v,"x",u.e=p),m!==u.t&&Q(v,"y",u.t=m),b!==u.a&&Q(v,"width",u.a=b),_!==u.o&&Q(v,"height",u.o=_),w!==u.i&&Q(v,"fill",u.i=w),S!==u.n&&Q(v,"fill-opacity",u.n=S),C!==u.s&&Q(v,"rx",u.s=C),A!==u.h&&Q(v,"ry",u.h=A),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),v})()})(),h),f(d,(()=>{var g=Ce(()=>!!a.style.border);return()=>g()&&(()=>{var v=Ul();return G(u=>{var p=o.positioning.backgroundX,m=o.positioning.backgroundY,b=o.containerBounds.width+(a.style.background?.padding||0)*2,_=o.containerBounds.height+(a.style.background?.padding||0)*2,w=a.style.border.color,S=a.style.border.width,C=a.style.border.style==="Dashed"?"5,5":a.style.border.style==="Dotted"?"2,2":"none",A=a.style.border.radius||0,M=a.style.border.radius||0;return p!==u.e&&Q(v,"x",u.e=p),m!==u.t&&Q(v,"y",u.t=m),b!==u.a&&Q(v,"width",u.a=b),_!==u.o&&Q(v,"height",u.o=_),w!==u.i&&Q(v,"stroke",u.i=w),S!==u.n&&Q(v,"stroke-width",u.n=S),C!==u.s&&Q(v,"stroke-dasharray",u.s=C),A!==u.h&&Q(v,"rx",u.h=A),M!==u.r&&Q(v,"ry",u.r=M),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),v})()})(),h),Q(h,"text-anchor",c),f(h,(()=>{var g=Ce(()=>!!o.textLayout?.isWrapped);return()=>g()?o.textLayout.wrappedLines.map((v,u)=>(()=>{var p=Hl();return f(p,v),G(m=>{var b=o.positioning.textAnchorX,_=u===0?0:o.fontMetrics.lineHeight;return b!==m.e&&Q(p,"x",m.e=b),_!==m.t&&Q(p,"dy",m.t=_),m},{e:void 0,t:void 0}),p})()):a.content.split(`
`).map((v,u)=>(()=>{var p=ql();return f(p,v),G(m=>{var b=o.positioning.textAnchorX,_=u===0?0:o.fontMetrics.lineHeight;return b!==m.e&&Q(p,"x",m.e=b),_!==m.t&&Q(p,"dy",m.t=_),m},{e:void 0,t:void 0}),p})())})()),G(g=>{var v=o.positioning.textAnchorX,u=o.positioning.textAnchorY,p=a.style.font_family,m=a.style.font_size.toString(),b=a.style.font_weight,_=a.style.color;return v!==g.e&&Q(h,"x",g.e=v),u!==g.t&&Q(h,"y",g.t=u),p!==g.a&&Q(h,"font-family",g.a=p),m!==g.o&&Q(h,"font-size",g.o=m),b!==g.i&&Q(h,"font-weight",g.i=b),_!==g.n&&Q(h,"fill",g.n=_),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),d})()}if(a.type==="Rectangle"){const o=a.opacity!==void 0?a.opacity:1,c=a.corner_radius||0;return(()=>{var d=Wl();return Q(d,"rx",c),Q(d,"ry",c),Q(d,"fill-opacity",o),Q(d,"stroke-opacity",o),G(h=>{var g=l.width,v=l.height,u=a.fill_color||"transparent",p=a.border?.color||"#000000",m=a.border?.width||1,b=a.border?.style==="Dashed"?"5,5":a.border?.style==="Dotted"?"2,2":"none";return g!==h.e&&Q(d,"width",h.e=g),v!==h.t&&Q(d,"height",h.t=v),u!==h.a&&Q(d,"fill",h.a=u),p!==h.o&&Q(d,"stroke",h.o=p),m!==h.i&&Q(d,"stroke-width",h.i=m),b!==h.n&&Q(d,"stroke-dasharray",h.n=b),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),d})()}if(a.type==="Line"){const o=a.opacity!==void 0?a.opacity:1,c=a.line_style||"Solid",d=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var h=jl();return Q(h,"stroke-opacity",o),Q(h,"stroke-dasharray",d),G(g=>{var v=l.height/2,u=l.width,p=l.height/2,m=a.color,b=a.width;return v!==g.e&&Q(h,"y1",g.e=v),u!==g.t&&Q(h,"x2",g.t=u),p!==g.a&&Q(h,"y2",g.a=p),m!==g.o&&Q(h,"stroke",g.o=m),b!==g.i&&Q(h,"stroke-width",g.i=b),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),h})()}if(a.type==="DataField"&&a.style){const o=t(),c=qt.calculateUnifiedBounds(o,a.style,l),d=qt.getTextAnchor(a.style.align);return(()=>{var h=Yl(),g=h.firstChild;return f(h,(()=>{var v=Ce(()=>!!n.selected);return()=>v()&&(()=>{var u=Qi();return G(p=>{var m=c.containerBounds.x,b=c.containerBounds.y,_=c.containerBounds.width,w=c.containerBounds.height;return m!==p.e&&Q(u,"x",p.e=m),b!==p.t&&Q(u,"y",p.t=b),_!==p.a&&Q(u,"width",p.a=_),w!==p.o&&Q(u,"height",p.o=w),p},{e:void 0,t:void 0,a:void 0,o:void 0}),u})()})(),g),f(h,(()=>{var v=Ce(()=>!!ei.shouldShowExpression(e().mode));return()=>v()&&(()=>{var u=Vl(),p=u.firstChild,m=p.nextSibling;return G(b=>{var _=c.containerBounds.x+c.containerBounds.width-8,w=c.containerBounds.y+8,S=c.containerBounds.x+c.containerBounds.width-8,C=c.containerBounds.y+8;return _!==b.e&&Q(p,"cx",b.e=_),w!==b.t&&Q(p,"cy",b.t=w),S!==b.a&&Q(m,"x",b.a=S),C!==b.o&&Q(m,"y",b.o=C),b},{e:void 0,t:void 0,a:void 0,o:void 0}),u})()})(),g),Q(g,"text-anchor",d),f(g,(()=>{var v=Ce(()=>!!c.textLayout?.isWrapped);return()=>v()?c.textLayout.wrappedLines.map((u,p)=>(()=>{var m=Xl();return f(m,u),G(b=>{var _=c.positioning.textAnchorX,w=p===0?0:c.fontMetrics.lineHeight;return _!==b.e&&Q(m,"x",b.e=_),w!==b.t&&Q(m,"dy",b.t=w),b},{e:void 0,t:void 0}),m})()):(()=>{var u=Ql();return f(u,o),G(()=>Q(u,"x",c.positioning.textAnchorX)),u})()})()),G(v=>{var u=e().mode,p=c.positioning.textAnchorX,m=c.positioning.textAnchorY,b=a.style.font_family,_=a.style.font_size.toString(),w=a.style.font_weight,S=o.startsWith("[错误:")?"#ff4d4f":a.style.color,C=`datafield-content-unified ${e().mode}-mode`;return u!==v.e&&Q(h,"data-preview-mode",v.e=u),p!==v.t&&Q(g,"x",v.t=p),m!==v.a&&Q(g,"y",v.a=m),b!==v.o&&Q(g,"font-family",v.o=b),_!==v.i&&Q(g,"font-size",v.i=_),w!==v.n&&Q(g,"font-weight",v.n=w),S!==v.s&&Q(g,"fill",v.s=S),C!==v.h&&Q(g,"class",v.h=C),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),h})()}return(()=>{var o=Kl();return G(c=>{var d=l.width,h=l.height;return d!==c.e&&Q(o,"width",c.e=d),h!==c.t&&Q(o,"height",c.t=h),c},{e:void 0,t:void 0}),o})()};return(()=>{var a=Jl();return f(a,r),G(l=>{var o=`element ${n.selected&&n.element.content.type!=="Text"&&n.element.content.type!=="DataField"?"element-selected":""}`,c=s(),d=n.element.id,h=n.element.content.type;return o!==l.e&&Q(a,"class",l.e=o),l.t=qs(a,c,l.t),d!==l.a&&Q(a,"data-element-id",l.a=d),h!==l.o&&Q(a,"data-element-type",l.o=h),l},{e:void 0,t:void 0,a:void 0,o:void 0}),a})()};var eo=x("<svg><g class=resize-handles></svg>",!1,!0,!1),to=x("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const no=n=>{const{updateElement:e,setResizeOperation:t}=at(),[i,s]=J(!1),[r,a]=J(null),[l,o]=J({x:0,y:0}),[c,d]=J({width:0,height:0}),[h,g]=J({x:0,y:0}),[v,u]=J({width:0,height:0}),[p,m]=J({x:0,y:0}),[b,_]=J(!1),w=Me(()=>{const{position:E,size:R,content:k}=n.element,N=8/2;let $={x:E.x,y:E.y,width:R.width,height:R.height};if((k.type==="Text"||k.type==="DataField")&&k.style){const H=k.type==="Text"?k.content:k.expression||"[数据字段]",j=qt.calculateUnifiedBounds(H,k.style,R);$={x:E.x+j.containerBounds.x,y:E.y+j.containerBounds.y,width:j.containerBounds.width,height:j.containerBounds.height}}const P=$.x,X=$.y,F=$.x+$.width,O=$.y+$.height,V=$.x+$.width/2,B=$.y+$.height/2;return[{position:"nw",cursor:"nw-resize",x:P-N,y:X-N},{position:"ne",cursor:"ne-resize",x:F-N,y:X-N},{position:"sw",cursor:"sw-resize",x:P-N,y:O-N},{position:"se",cursor:"se-resize",x:F-N,y:O-N},{position:"n",cursor:"n-resize",x:V-N,y:X-N},{position:"s",cursor:"s-resize",x:V-N,y:O-N},{position:"w",cursor:"w-resize",x:P-N,y:B-N},{position:"e",cursor:"e-resize",x:F-N,y:B-N}]}),S=(E,R,k,q=!1,N=!1)=>{const $=c(),P=h();let X=$.width,F=$.height,O=P.x,V=P.y;switch(E){case"nw":X=$.width-R,F=$.height-k,O=P.x+R,V=P.y+k;break;case"ne":X=$.width+R,F=$.height-k,V=P.y+k;break;case"sw":X=$.width-R,F=$.height+k,O=P.x+R;break;case"se":X=$.width+R,F=$.height+k;break;case"n":F=$.height-k,V=P.y+k;break;case"s":F=$.height+k;break;case"w":X=$.width-R,O=P.x+R;break;case"e":X=$.width+R;break}if(q&&(E==="nw"||E==="ne"||E==="sw"||E==="se")){const H=$.width/$.height;X/F>H?(X=F*H,(E==="nw"||E==="sw")&&(O=P.x+($.width-X))):(F=X/H,(E==="nw"||E==="ne")&&(V=P.y+($.height-F)))}if(N){const H=P.x+$.width/2,j=P.y+$.height/2;O=H-X/2,V=j-F/2}const B=20;return X=Math.max(B,X),F=Math.max(B,F),{size:{width:X,height:F},position:{x:O,y:V}}},C=E=>(E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation(),!1),A=(E,R)=>{t(!0),document.addEventListener("click",C,{capture:!0}),s(!0),a(E),o({x:R.clientX,y:R.clientY}),d({width:n.element.size.width,height:n.element.size.height}),g({x:n.element.position.x,y:n.element.position.y}),u(n.element.size),m(n.element.position),_(!1),document.addEventListener("mousemove",D),document.addEventListener("mouseup",z),document.body.style.cursor=w().find(k=>k.position===E)?.cursor||"default"};let M=0;const D=E=>{if(!i())return;const R=r();if(!R)return;const k=l(),q=E.clientX-k.x,N=E.clientY-k.y,$=S(R,q,N,E.shiftKey,E.altKey);u($.size),m($.position),_(Math.abs(q)>2||Math.abs(N)>2);const P=Date.now();if(P-M>50)try{e(n.element.id,{size:$.size,position:$.position}),M=P}catch{}},z=()=>{if(!i()||!r())return;const R=()=>{document.removeEventListener("click",C,{capture:!0}),t(!1),s(!1),a(null),document.body.style.cursor="default",document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",z)};if(b()){const k=v(),q=p();e(n.element.id,{size:k,position:q}).catch(N=>{e(n.element.id,{size:c(),position:h()}).catch($=>{})})}R()};return $t(()=>{t(!1),document.removeEventListener("click",C,{capture:!0}),document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",z),document.body.style.cursor="default"}),(()=>{var E=eo();return f(E,()=>w().map(R=>(()=>{var k=to(),q=k.firstChild,N=q.nextSibling;return N.addEventListener("mouseleave",$=>{i()||(document.body.style.cursor="default")}),N.addEventListener("mouseenter",$=>{i()||(document.body.style.cursor=R.cursor)}),N.$$mousedown=$=>{$.stopPropagation(),$.preventDefault(),A(R.position,$)},N.style.setProperty("pointer-events","all"),G($=>{var P=R.x+4,X=R.y+4,F=R.x,O=R.y,V=R.cursor;return P!==$.e&&Q(q,"cx",$.e=P),X!==$.t&&Q(q,"cy",$.t=X),F!==$.a&&Q(N,"x",$.a=F),O!==$.o&&Q(N,"y",$.o=O),V!==$.i&&(($.i=V)!=null?N.style.setProperty("cursor",V):N.style.removeProperty("cursor")),$},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),k})())),E})()};Ue(["mousedown"]);var tt=(n=>(n.IDLE="idle",n.HOVER="hover",n.SELECTING="selecting",n.DRAGGING="dragging",n))(tt||{});const io={dragThreshold:3,updateThrottle:16};var so=x("<div tabindex=0>"),ro=x("<div>"),ao=x("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),lo=x("<div>拖拽: <!>个元素"),oo=x("<div>[<!>]");const co=n=>{const{resizeOperation:e,setResizeOperation:t}=at(),i=io;let s;const[r,a]=J(tt.IDLE),[l,o]=J([]),[c,d]=J(null),[h,g]=J(null),[v,u]=J(null),p=(L,I)=>Math.sqrt(Math.pow(L.x-I.x,2)+Math.pow(L.y-I.y,2)),m=(L,I)=>L.length===I.length&&L.every((K,Y)=>K===I[Y]),b=()=>{u(null)},[_,w]=J(null);let S="default";const C=(L,I)=>{!s||S===L||(s.style.cursor=L,S=L)},A=(L,...I)=>{console.log(`🎯 [InteractionLayer] ${L}`,...I)},M=L=>{if(!s)return{x:0,y:0};const I=s.getBoundingClientRect();return{x:L.clientX-I.left,y:L.clientY-I.top}},D=(L,I)=>L.x>=I.position.x&&L.x<=I.position.x+I.size.width&&L.y>=I.position.y&&L.y<=I.position.y+I.size.height,z=L=>{const I=E(L);return I.length>0?I[0]??null:null},E=L=>{const I=n.getAllElements();return I.filter(Y=>Y&&Y.visible&&D(L,Y)).sort((Y,ie)=>{const ce=Y.z_index??I.indexOf(Y);return(ie.z_index??I.indexOf(ie))-ce})},R=L=>{const I=l();if(I.length===0)return null;const K=n.getAllElements();for(const Y of I){const ie=K.find(rt=>rt.id===Y);if(!ie||!ie.visible)continue;const ce=8,ae=ce/2,$e=ie.position.x,Ie=ie.position.y,Te=ie.position.x+ie.size.width,Ye=ie.position.y+ie.size.height,We=ie.position.x+ie.size.width/2,ot=ie.position.y+ie.size.height/2,Pt=[{direction:"nw",cursor:"nw-resize",x:$e-ae,y:Ie-ae},{direction:"ne",cursor:"ne-resize",x:Te-ae,y:Ie-ae},{direction:"sw",cursor:"sw-resize",x:$e-ae,y:Ye-ae},{direction:"se",cursor:"se-resize",x:Te-ae,y:Ye-ae},{direction:"n",cursor:"n-resize",x:We-ae,y:Ie-ae},{direction:"s",cursor:"s-resize",x:We-ae,y:Ye-ae},{direction:"w",cursor:"w-resize",x:$e-ae,y:ot-ae},{direction:"e",cursor:"e-resize",x:Te-ae,y:ot-ae}];for(const rt of Pt)if(L.x>=rt.x&&L.x<rt.x+ce&&L.y>=rt.y&&L.y<rt.y+ce)return{elementId:ie.id,direction:rt.direction,cursor:rt.cursor}}return null},k=L=>n.getAllElements().filter(K=>{if(!K.visible)return!1;const Y={x:K.position.x,y:K.position.y,width:K.size.width,height:K.size.height};return!(Y.x>L.x+L.width||Y.x+Y.width<L.x||Y.y>L.y+L.height||Y.y+Y.height<L.y)}),q=(L,I)=>{const K=E(L);return A("重叠选择检测",{elementsCount:K.length,isCtrlClick:I,elementIds:K.map(Y=>Y.id)}),K.length===0?null:K.length===1?(b(),K[0]?.id||null):I?N(L,K):(b(),A("普通点击选中最上层",{elementId:K[0]?.id}),K[0]?.id||null)},N=(L,I)=>{const K=v(),Y=Date.now();if(A("循环选择开始",{hasContext:!!K,elementIds:I.map(ce=>ce.id)}),!K||p(L,K.clickPoint)>5||Y-K.lastClickTime>3e3||!m(I.map(ce=>ce.id),K.overlappingElements.map(ce=>ce.id))){const ce=I.length>1?1:0;return u({clickPoint:L,overlappingElements:I,currentSelectedIndex:ce,lastClickTime:Y}),A("循环选择重置",{selectedIndex:ce,selectedId:I[ce]?.id,reason:K?p(L,K.clickPoint)>5?"position_changed":Y-K.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),$(ce+1,I.length,L),I[ce]?.id||null}else{const ce=(K.currentSelectedIndex+1)%I.length;return u({...K,currentSelectedIndex:ce,lastClickTime:Y}),A("循环选择继续",{selectedIndex:ce,selectedId:I[ce]?.id}),$(ce+1,I.length,L),I[ce]?.id||null}},$=(L,I,K)=>{const Y=document.querySelector(".overlap-indicator");Y?.parentNode&&Y.parentNode.removeChild(Y);const ie=document.createElement("div");ie.className="overlap-indicator",ie.textContent=`${L}/${I}`,Object.assign(ie.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${K.x+10}px`,top:`${K.y-20}px`}),document.body.appendChild(ie),A("显示重叠指示器",{current:L,total:I,point:K}),setTimeout(()=>{ie.parentNode&&(ie.parentNode.removeChild(ie),A("移除重叠指示器"))},1500)},P=L=>{const I=M(L);if(_()){ne(I);return}if(r()===tt.DRAGGING){he(I);return}if(r()===tt.SELECTING){te(I);return}if(r()===tt.IDLE&&c()&&!c()?.isDragging){fe(I);return}r()===tt.IDLE&&!c()&&!_()&&X(I)},X=L=>{const I=R(L);if(I){C(I.cursor);return}const K=z(L);if(K){const ie=l().includes(K.id)?"grab":"pointer";C(ie);return}C("default")},F=L=>{const I=M(L),K=R(I);if(K){A("点击ResizeHandle",{elementId:K.elementId,direction:K.direction}),O(K,I);return}if(e()){A("调整大小操作进行中，跳过交互处理");return}const Y=q(I,L.ctrlKey);if(A("鼠标按下",{point:I,selectedElementId:Y,currentMode:r(),isCtrlClick:L.ctrlKey}),Y){const ie=n.getAllElements().find(ce=>ce.id===Y);ie&&V(ie,I,L)}else B(I)},O=(L,I,K)=>{const Y=n.getAllElements().find(ie=>ie.id===L.elementId);Y&&(A("开始resize操作",{elementId:L.elementId,direction:L.direction}),t(!0),w({elementId:L.elementId,handlePosition:L.direction,startPoint:I,initialSize:{width:Y.size.width,height:Y.size.height},initialPosition:{x:Y.position.x,y:Y.position.y},cursor:L.cursor}),C(L.cursor),A("resize状态已设置",_()))},V=(L,I,K)=>{const Y=l().includes(L.id),ie=l(),ce=!!v();A("元素点击",{elementId:L.id,isSelected:Y,currentlySelected:ie,ctrlKey:K.ctrlKey,shiftKey:K.shiftKey,hasOverlapContext:ce}),K.ctrlKey&&!ce?H(L.id):K.shiftKey&&l().length>0?j(L.id):Y?(A("点击已选中元素，准备拖拽",{selectedCount:ie.length}),me(ie,I)):de(L.id,I)},B=(L,I)=>{A("开始框选",{point:L}),o([]),n.onElementsSelect?.([]),b(),a(tt.SELECTING),C("crosshair"),g({startPoint:L,currentPoint:L,selectedIds:[]})},H=L=>{const I=l(),K=I.includes(L)?I.filter(Y=>Y!==L):[...I,L];A("切换选择",{elementId:L,newSelection:K}),o(K),n.onElementsSelect?.(K)},j=L=>{const I=l();if(!I.includes(L)){const K=[...I,L];A("添加到选择",{elementId:L,newSelection:K}),o(K),n.onElementsSelect?.(K)}},de=(L,I,K)=>{A("选择并准备拖拽",{elementId:L,point:I}),o([L]),n.onElementsSelect?.([L]),me([L],I)},me=(L,I,K)=>{A("准备拖拽操作",{elementIds:L,startPoint:I});const Y=n.getAllElements(),ie=new Map;L.forEach(ce=>{const ae=Y.find($e=>$e.id===ce);ae&&ie.set(ce,{x:ae.position.x,y:ae.position.y})}),d({elementIds:L,startPoint:I,startPositions:ie,currentOffset:{x:0,y:0},isDragging:!1})},fe=L=>{const I=c();if(!I)return;const K=Math.sqrt(Math.pow(L.x-I.startPoint.x,2)+Math.pow(L.y-I.startPoint.y,2));K>i.dragThreshold&&(A("开始拖拽",{distance:K,threshold:i.dragThreshold}),a(tt.DRAGGING),C("grabbing"),d({...I,isDragging:!0}))};let ee=!1,oe=0;const ge=(L,I=!1)=>{if(I){L();return}Date.now()-oe>=i.updateThrottle&&!ee&&(ee=!0,requestAnimationFrame(()=>{L(),ee=!1,oe=Date.now()}))},he=L=>{const I=c();if(!I)return;const K={x:L.x-I.startPoint.x,y:L.y-I.startPoint.y};d({...I,currentOffset:K}),ge(()=>{if(n.onBatchUpdatePositions&&I.elementIds.length>1){const Y=I.elementIds.map(ie=>{const ce=I.startPositions.get(ie);return ce?{element_id:ie,new_position:{x:ce.x+K.x,y:ce.y+K.y}}:null}).filter(Boolean);Y.length>0&&n.onBatchUpdatePositions(Y).catch(()=>{})}else if(n.onElementMove){const Y=I.elementIds.map(ie=>{const ce=I.startPositions.get(ie);if(ce)return n.onElementMove(ie,{x:ce.x+K.x,y:ce.y+K.y})}).filter(Boolean);Promise.allSettled(Y).catch(()=>{})}})},te=L=>{const I=h();if(!I)return;const K={...I,currentPoint:L};g(K);const Y={x:Math.min(I.startPoint.x,L.x),y:Math.min(I.startPoint.y,L.y),width:Math.abs(L.x-I.startPoint.x),height:Math.abs(L.y-I.startPoint.y)},ce=k(Y).map(ae=>ae.id);g({...K,selectedIds:ce}),o(ce)},ne=L=>{const I=_();if(!I)return;const K=L.x-I.startPoint.x,Y=L.y-I.startPoint.y,ie=ve(I.handlePosition,K,Y,I.initialSize,I.initialPosition);ge(()=>{n.onElementResize&&n.onElementResize(I.elementId,ie.size,ie.position)})},ve=(L,I,K,Y,ie)=>{let ce=Y.width,ae=Y.height,$e=ie.x,Ie=ie.y;switch(L){case"nw":ce=Y.width-I,ae=Y.height-K,$e=ie.x+I,Ie=ie.y+K;break;case"ne":ce=Y.width+I,ae=Y.height-K,Ie=ie.y+K;break;case"sw":ce=Y.width-I,ae=Y.height+K,$e=ie.x+I;break;case"se":ce=Y.width+I,ae=Y.height+K;break;case"n":ae=Y.height-K,Ie=ie.y+K;break;case"s":ae=Y.height+K;break;case"w":ce=Y.width-I,$e=ie.x+I;break;case"e":ce=Y.width+I;break}const Te=10;return ce=Math.max(Te,ce),ae=Math.max(Te,ae),{size:{width:ce,height:ae},position:{x:$e,y:Ie}}},be=()=>{const L=r();if(A("鼠标释放",{currentMode:L,hasResizeState:!!_()}),_()){Pe();return}L===tt.DRAGGING?ke():L===tt.SELECTING&&_e(),ue()},ke=()=>{const L=c();if(!L||!L.isDragging&&L.currentOffset.x===0&&L.currentOffset.y===0){A("拖拽完成，无实际移动");return}if(n.onBatchUpdatePositions&&L.elementIds.length>1){const I=L.elementIds.map(K=>{const Y=L.startPositions.get(K);return Y?{element_id:K,new_position:{x:Y.x+L.currentOffset.x,y:Y.y+L.currentOffset.y}}:null}).filter(Boolean);I.length>0&&(A("拖拽完成 - 批量更新",{elementCount:I.length}),n.onBatchUpdatePositions(I).catch(K=>{console.warn("批量更新最终位置失败:",K)}))}},_e=()=>{const L=h();L&&(A("框选完成",{selectedCount:L.selectedIds.length}),n.onElementsSelect&&n.onElementsSelect(L.selectedIds))},Pe=()=>{const L=_();L&&(A("完成resize操作",{elementId:L.elementId}),t(!1),w(null))},ue=()=>{a(tt.IDLE),C("default"),d(null),g(null),w(null),t(!1),b(),A("状态重置完成")};et(async()=>{document.addEventListener("mousemove",P),document.addEventListener("mouseup",be),A("修复版交互层已初始化")}),$t(()=>{document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",be),A("修复版交互层已清理")});const xe=()=>{const L=h();if(!L||r()!==tt.SELECTING)return null;const{startPoint:I,currentPoint:K}=L;return{x:Math.min(I.x,K.x),y:Math.min(I.y,K.y),width:Math.abs(K.x-I.x),height:Math.abs(K.y-I.y)}};return(()=>{var L=so();L.$$mousedown=F;var I=s;return typeof I=="function"?Vn(I,L):s=L,L.style.setProperty("position","absolute"),L.style.setProperty("top","0"),L.style.setProperty("left","0"),L.style.setProperty("width","100%"),L.style.setProperty("height","100%"),L.style.setProperty("z-index","10"),L.style.setProperty("pointer-events","all"),L.style.setProperty("background","transparent"),L.style.setProperty("user-select","none"),f(L,(()=>{var K=Ce(()=>!!xe());return()=>K()&&(()=>{var Y=ro();return Y.style.setProperty("position","absolute"),Y.style.setProperty("border","1px dashed #007acc"),Y.style.setProperty("background","rgba(0, 122, 204, 0.1)"),Y.style.setProperty("pointer-events","none"),G(ie=>{var ce=`${xe().x}px`,ae=`${xe().y}px`,$e=`${xe().width}px`,Ie=`${xe().height}px`;return ce!==ie.e&&((ie.e=ce)!=null?Y.style.setProperty("left",ce):Y.style.removeProperty("left")),ae!==ie.t&&((ie.t=ae)!=null?Y.style.setProperty("top",ae):Y.style.removeProperty("top")),$e!==ie.a&&((ie.a=$e)!=null?Y.style.setProperty("width",$e):Y.style.removeProperty("width")),Ie!==ie.o&&((ie.o=Ie)!=null?Y.style.setProperty("height",Ie):Y.style.removeProperty("height")),ie},{e:void 0,t:void 0,a:void 0,o:void 0}),Y})()})(),null),f(L,(()=>{var K=Ce(()=>!!n.enableDebugMode);return()=>K()&&(()=>{var Y=ao(),ie=Y.firstChild,ce=ie.nextSibling;ce.firstChild;var ae=ce.nextSibling;ae.firstChild;var $e=ae.nextSibling;return $e.firstChild,Y.style.setProperty("position","fixed"),Y.style.setProperty("top","10px"),Y.style.setProperty("right","10px"),Y.style.setProperty("padding","8px"),Y.style.setProperty("background","rgba(0, 0, 0, 0.8)"),Y.style.setProperty("color","white"),Y.style.setProperty("font-family","monospace"),Y.style.setProperty("font-size","12px"),Y.style.setProperty("border-radius","4px"),Y.style.setProperty("z-index","9999"),Y.style.setProperty("pointer-events","none"),f(ce,r,null),f(ae,()=>l().length,null),f($e,S,null),f(Y,(()=>{var Ie=Ce(()=>!!c()?.isDragging);return()=>Ie()&&(()=>{var Te=lo(),Ye=Te.firstChild,We=Ye.nextSibling;return We.nextSibling,Te.style.setProperty("color","#ffeb3b"),f(Te,()=>c()?.elementIds.length,We),Te})()})(),null),f(Y,(()=>{var Ie=Ce(()=>l().length>0);return()=>Ie()&&(()=>{var Te=oo(),Ye=Te.firstChild,We=Ye.nextSibling;return We.nextSibling,Te.style.setProperty("font-size","10px"),Te.style.setProperty("color","#ccc"),f(Te,()=>l().slice(0,3).join(", "),We),f(Te,()=>l().length>3&&"...",We),Te})()})(),null),Y})()})(),null),L})()};Ue(["mousedown"]);var ho=x("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),uo=x("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),go=x('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),fo=x('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const vo=(n,e)=>{if(n.length<2)return[];const t=n.map(i=>({x:i.position.x,y:i.position.y,width:i.size.width,height:i.size.height}));return t.map((i,s)=>{let r=i.x,a=i.y;switch(e){case"left":r=Math.min(...t.map(h=>h.x));break;case"right":r=Math.max(...t.map(h=>h.x+h.width))-i.width;break;case"top":a=Math.min(...t.map(h=>h.y));break;case"bottom":a=Math.max(...t.map(h=>h.y+h.height))-i.height;break;case"h_center":r=t.reduce((h,g)=>h+g.x+g.width/2,0)/t.length-i.width/2;break;case"v_center":a=t.reduce((h,g)=>h+g.y+g.height/2,0)/t.length-i.height/2;break}return{element_id:n[s].id,new_position:{x:r,y:a}}})},po=n=>{const{batchUpdatePositions:e,state:t}=at(),[i,s]=J(!1),r=()=>n.selectedElementIds().length>=2,a=()=>{const d=n.selectedElementIds();return t.elements.filter(h=>d.includes(h.id))},l=async d=>{const h=a();if(h.length<2){console.warn("对齐功能需要至少2个元素");return}try{s(!0),console.log(`🎯 执行${d}对齐:`,h.length,"个元素");const g=vo(h,d);await e(g),console.log("✅ 对齐操作完成"),n.onAlignmentComplete&&n.onAlignmentComplete(g)}catch(g){console.error("❌ 对齐操作失败:",g)}finally{s(!1)}},o=()=>a().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>o();return(()=>{var d=fo(),h=d.firstChild,g=h.firstChild,v=g.nextSibling,u=v.firstChild,p=u.nextSibling,m=p.nextSibling,b=h.nextSibling,_=b.firstChild,w=_.nextSibling,S=w.firstChild,C=S.nextSibling,A=C.nextSibling,M=b.nextSibling,D=M.firstChild,z=D.nextSibling,E=z.firstChild,R=E.nextSibling;return u.$$click=()=>l("left"),p.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("h_center")),p.$$click=()=>l("h_center"),m.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("right")),m.$$click=()=>l("right"),S.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("top")),S.$$click=()=>l("top"),C.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("v_center")),C.$$click=()=>l("v_center"),A.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("bottom")),A.$$click=()=>l("bottom"),E.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("distribute_h")),E.$$click=()=>l("distribute_h"),R.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("distribute_v")),R.$$click=()=>l("distribute_v"),f(d,y(W,{get when(){return Ce(()=>!!r())()&&c()},get children(){var k=ho(),q=k.firstChild,N=q.nextSibling,$=N.firstChild,P=$.nextSibling,X=N.nextSibling;return N.$$click=()=>l(c().recommended),f(P,()=>c().recommended==="left"&&"左对齐",null),f(P,()=>c().recommended==="right"&&"右对齐",null),f(P,()=>c().recommended==="top"&&"顶对齐",null),f(P,()=>c().recommended==="bottom"&&"底对齐",null),f(P,()=>c().recommended==="h_center"&&"水平居中",null),f(P,()=>c().recommended==="v_center"&&"垂直居中",null),f(X,()=>c().reason),G(F=>{var O=i(),V=c().reason;return O!==F.e&&(N.disabled=F.e=O),V!==F.t&&Q(N,"title",F.t=V),F},{e:void 0,t:void 0}),k}}),null),f(d,y(W,{get when(){return!r()},get children(){var k=uo(),q=k.firstChild;return q.firstChild,f(q,()=>n.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),k}}),null),f(d,y(W,{get when(){return i()},get children(){return go()}}),null),G(k=>{var q=!r()||i(),N=!r()||i(),$=!r()||i(),P=!r()||i(),X=!r()||i(),F=!r()||i(),O=n.selectedElementIds().length<3||i(),V=n.selectedElementIds().length<3||i();return q!==k.e&&(u.disabled=k.e=q),N!==k.t&&(p.disabled=k.t=N),$!==k.a&&(m.disabled=k.a=$),P!==k.o&&(S.disabled=k.o=P),X!==k.i&&(C.disabled=k.i=X),F!==k.n&&(A.disabled=k.n=F),O!==k.s&&(E.disabled=k.s=O),V!==k.h&&(R.disabled=k.h=V),k},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d})()},mo=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const n=document.createElement("style");n.textContent=mo,document.head.appendChild(n)}Ue(["click"]);var bo=x("<div>"),yo=x('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),_o=x("<span class=ml-2>Zoom: <!>%");const Ki=()=>{const{state:n,selectElement:e,clearSelection:t,createElement:i,selectMultiple:s,updateElement:r,batchUpdatePositions:a}=at();let l;const[o,c]=J([]),d=Me(()=>n.elements.filter(w=>w.visible)),h=(w,S)=>{if(!l)return{x:0,y:0};const C=l.getBoundingClientRect(),A=(w-C.left)/n.canvas_config.zoom,M=(S-C.top)/n.canvas_config.zoom;return{x:A,y:M}},g=async w=>{console.log("🎯 选择元素",w),c([...w]);try{w.length===0?await t():w.length===1?await e(w[0]):await s([...w])}catch(S){console.error("❌ 选择元素失败:",S)}},v=async w=>{try{await a(w)}catch(S){console.error("❌ 批量更新位置失败:",S)}},u=async(w,S)=>{try{await r(w,{position:{x:S.x,y:S.y}})}catch(C){console.error("❌ 移动元素失败:",C)}},p=async(w,S,C)=>{try{await r(w,{size:S,position:C})}catch(A){console.error("❌ 调整大小失败:",A)}},m=async w=>{console.log("🖱️ 画布点击",w)},b=async w=>{w.preventDefault();try{const S=w.dataTransfer?.getData("application/json");if(!S)return;const{type:C,component:A}=JSON.parse(S);if(C==="component"){const{x:M,y:D}=h(w.clientX,w.clientY),z=Math.max(0,M-A.default_size.width/2),E=Math.max(0,D-A.default_size.height/2);console.log("🎯 通过拖放创建组件:",A.name,"at",z,E);const R=await i(A.id,{x:z,y:E},A.default_size,A.create_content());console.log("✅ 通过拖放创建元素成功:",R),c([R]),await e(R)}}catch(S){console.error("拖放处理失败:",S)}};et(()=>{c([...n.selected_ids])}),Me(()=>{c([...n.selected_ids])});const _=Me(()=>{const{width:w,height:S}=n.canvas_config;return`0 0 ${w} ${S}`});return(()=>{var w=yo(),S=w.firstChild,C=S.firstChild,A=C.firstChild,M=A.nextSibling,D=M.nextSibling,z=D.nextSibling,E=z.nextSibling,R=E.nextSibling,k=R.firstChild,q=k.nextSibling;q.nextSibling;var N=S.nextSibling,$=N.firstChild,P=$.firstChild,X=P.firstChild,F=X.firstChild,O=F.nextSibling,V=O.nextSibling,B=V.nextSibling;f(C,()=>n.canvas_config.width,M),f(C,()=>n.canvas_config.height,z),f(C,(()=>{var j=Ce(()=>n.canvas_config.zoom!==1);return()=>j()&&(()=>{var de=_o(),me=de.firstChild,fe=me.nextSibling;return fe.nextSibling,f(de,()=>Math.round(n.canvas_config.zoom*100),fe),de})()})(),R),f(R,()=>n.elements.length,q),f(R,()=>o().length,null),P.style.setProperty("position","relative"),X.addEventListener("drop",b),X.addEventListener("dragover",j=>{j.preventDefault(),j.dataTransfer.dropEffect="copy"}),X.$$contextmenu=j=>j.preventDefault();var H=l;return typeof H=="function"?Vn(H,X):l=X,f(X,y(Nl,{get config(){return n.canvas_config}}),O),f(V,y(pe,{get each(){return d()},children:j=>y(Zl,{element:j,get selected(){return o().includes(j.id)}})})),f(B,y(pe,{get each(){return d().filter(j=>o().includes(j.id))},children:j=>y(no,{element:j})})),f(P,y(co,{canvasRef:l,getAllElements:()=>[...n.elements],onElementsSelect:g,onElementMove:u,onBatchUpdatePositions:v,onElementResize:p,onCanvasClick:m,get enableDebugMode(){return!1}}),null),f(P,y(W,{get when(){return o().length>=2},get children(){var j=bo();return j.style.setProperty("position","fixed"),j.style.setProperty("top","80px"),j.style.setProperty("right","20px"),j.style.setProperty("z-index","1000"),j.style.setProperty("background","white"),j.style.setProperty("border-radius","8px"),j.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),j.style.setProperty("border","1px solid #e5e7eb"),f(j,y(po,{selectedElementIds:o,onAlignmentComplete:de=>{console.log("✅ 对齐操作完成:",de)},onAlignmentPreview:de=>{console.log("👁️ 对齐预览:",de)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),j}}),null),G(j=>{var de=n.canvas_config.width*n.canvas_config.zoom,me=n.canvas_config.height*n.canvas_config.zoom,fe=_(),ee=n.canvas_config.width,oe=n.canvas_config.height,ge=n.canvas_config.background_color,he=n.canvas_config.width,te=n.canvas_config.height;return de!==j.e&&Q(X,"width",j.e=de),me!==j.t&&Q(X,"height",j.t=me),fe!==j.a&&Q(X,"viewBox",j.a=fe),ee!==j.o&&Q(F,"width",j.o=ee),oe!==j.i&&Q(F,"height",j.i=oe),ge!==j.n&&Q(F,"fill",j.n=ge),he!==j.s&&Q(O,"width",j.s=he),te!==j.h&&Q(O,"height",j.h=te),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),w})()};Ue(["contextmenu"]);const xo=Math.PI/180;function So(){return typeof window<"u"&&({}.toString.call(window)==="[object Window]"||{}.toString.call(window)==="[object global]")}const Lt=typeof global<"u"?global:typeof window<"u"?window:typeof WorkerGlobalScope<"u"?self:{},le={_global:Lt,version:"10.0.2",isBrowser:So(),isUnminified:/param/.test(function(n){}.toString()),dblClickWindow:400,getAngle(n){return le.angleDeg?n*xo:n},enableTrace:!1,pointerEventsEnabled:!0,autoDrawEnabled:!0,hitOnDragEnabled:!1,capturePointerEventsEnabled:!1,_mouseListenClick:!1,_touchListenClick:!1,_pointerListenClick:!1,_mouseInDblClickWindow:!1,_touchInDblClickWindow:!1,_pointerInDblClickWindow:!1,_mouseDblClickPointerId:null,_touchDblClickPointerId:null,_pointerDblClickPointerId:null,_renderBackend:"web",legacyTextRendering:!1,pixelRatio:typeof window<"u"&&window.devicePixelRatio||1,dragDistance:3,angleDeg:!0,showWarnings:!0,dragButtons:[0,1],isDragging(){return le.DD.isDragging},isTransforming(){var n,e;return(e=(n=le.Transformer)===null||n===void 0?void 0:n.isTransforming())!==null&&e!==void 0?e:!1},isDragReady(){return!!le.DD.node},releaseCanvasOnDestroy:!0,document:Lt.document,_injectGlobal(n){typeof Lt.Konva<"u"&&console.error("Severa Konva instances detected. It is not recommended to use multiple Konva instances in the same environment."),Lt.Konva=n}},Be=n=>{le[n.prototype.getClassName()]=n};le._injectGlobal(le);const wo=`Konva.js unsupported environment.

Looks like you are trying to use Konva.js in Node.js environment. because "document" object is undefined.

To use Konva.js in Node.js environment, you need to use the "canvas-backend" or "skia-backend" module.

bash: npm install canvas
js: import "konva/canvas-backend";

or

bash: npm install skia-canvas
js: import "konva/skia-backend";
`,Ji=()=>{if(typeof document>"u")throw new Error(wo)};class Ke{constructor(e=[1,0,0,1,0,0]){this.dirty=!1,this.m=e&&e.slice()||[1,0,0,1,0,0]}reset(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=1,this.m[4]=0,this.m[5]=0}copy(){return new Ke(this.m)}copyInto(e){e.m[0]=this.m[0],e.m[1]=this.m[1],e.m[2]=this.m[2],e.m[3]=this.m[3],e.m[4]=this.m[4],e.m[5]=this.m[5]}point(e){const t=this.m;return{x:t[0]*e.x+t[2]*e.y+t[4],y:t[1]*e.x+t[3]*e.y+t[5]}}translate(e,t){return this.m[4]+=this.m[0]*e+this.m[2]*t,this.m[5]+=this.m[1]*e+this.m[3]*t,this}scale(e,t){return this.m[0]*=e,this.m[1]*=e,this.m[2]*=t,this.m[3]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),s=this.m[0]*t+this.m[2]*i,r=this.m[1]*t+this.m[3]*i,a=this.m[0]*-i+this.m[2]*t,l=this.m[1]*-i+this.m[3]*t;return this.m[0]=s,this.m[1]=r,this.m[2]=a,this.m[3]=l,this}getTranslation(){return{x:this.m[4],y:this.m[5]}}skew(e,t){const i=this.m[0]+this.m[2]*t,s=this.m[1]+this.m[3]*t,r=this.m[2]+this.m[0]*e,a=this.m[3]+this.m[1]*e;return this.m[0]=i,this.m[1]=s,this.m[2]=r,this.m[3]=a,this}multiply(e){const t=this.m[0]*e.m[0]+this.m[2]*e.m[1],i=this.m[1]*e.m[0]+this.m[3]*e.m[1],s=this.m[0]*e.m[2]+this.m[2]*e.m[3],r=this.m[1]*e.m[2]+this.m[3]*e.m[3],a=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],l=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];return this.m[0]=t,this.m[1]=i,this.m[2]=s,this.m[3]=r,this.m[4]=a,this.m[5]=l,this}invert(){const e=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),t=this.m[3]*e,i=-this.m[1]*e,s=-this.m[2]*e,r=this.m[0]*e,a=e*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),l=e*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=t,this.m[1]=i,this.m[2]=s,this.m[3]=r,this.m[4]=a,this.m[5]=l,this}getMatrix(){return this.m}decompose(){const e=this.m[0],t=this.m[1],i=this.m[2],s=this.m[3],r=this.m[4],a=this.m[5],l=e*s-t*i,o={x:r,y:a,rotation:0,scaleX:0,scaleY:0,skewX:0,skewY:0};if(e!=0||t!=0){const c=Math.sqrt(e*e+t*t);o.rotation=t>0?Math.acos(e/c):-Math.acos(e/c),o.scaleX=c,o.scaleY=l/c,o.skewX=(e*i+t*s)/l,o.skewY=0}else if(i!=0||s!=0){const c=Math.sqrt(i*i+s*s);o.rotation=Math.PI/2-(s>0?Math.acos(-i/c):-Math.acos(i/c)),o.scaleX=l/c,o.scaleY=c,o.skewX=0,o.skewY=(e*i+t*s)/l}return o.rotation=U._getRotation(o.rotation),o}}const $o="[object Array]",Co="[object Number]",ko="[object String]",To="[object Boolean]",Eo=Math.PI/180,Po=180/Math.PI,ri="#",Ao="",Ro="0",Lo="Konva warning: ",Zi="Konva error: ",Mo="rgb(",ai={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},Do=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;let Sn=[];const Oo=typeof requestAnimationFrame<"u"&&requestAnimationFrame||function(n){setTimeout(n,60)},U={_isElement(n){return!!(n&&n.nodeType==1)},_isFunction(n){return!!(n&&n.constructor&&n.call&&n.apply)},_isPlainObject(n){return!!n&&n.constructor===Object},_isArray(n){return Object.prototype.toString.call(n)===$o},_isNumber(n){return Object.prototype.toString.call(n)===Co&&!isNaN(n)&&isFinite(n)},_isString(n){return Object.prototype.toString.call(n)===ko},_isBoolean(n){return Object.prototype.toString.call(n)===To},isObject(n){return n instanceof Object},isValidSelector(n){if(typeof n!="string")return!1;const e=n[0];return e==="#"||e==="."||e===e.toUpperCase()},_sign(n){return n===0||n>0?1:-1},requestAnimFrame(n){Sn.push(n),Sn.length===1&&Oo(function(){const e=Sn;Sn=[],e.forEach(function(t){t()})})},createCanvasElement(){Ji();const n=document.createElement("canvas");try{n.style=n.style||{}}catch{}return n},createImageElement(){return Ji(),document.createElement("img")},_isInDocument(n){for(;n=n.parentNode;)if(n==document)return!0;return!1},_urlToImage(n,e){const t=U.createImageElement();t.onload=function(){e(t)},t.src=n},_rgbToHex(n,e,t){return((1<<24)+(n<<16)+(e<<8)+t).toString(16).slice(1)},_hexToRgb(n){n=n.replace(ri,Ao);const e=parseInt(n,16);return{r:e>>16&255,g:e>>8&255,b:e&255}},getRandomColor(){let n=(Math.random()*16777215<<0).toString(16);for(;n.length<6;)n=Ro+n;return ri+n},getRGB(n){let e;return n in ai?(e=ai[n],{r:e[0],g:e[1],b:e[2]}):n[0]===ri?this._hexToRgb(n.substring(1)):n.substr(0,4)===Mo?(e=Do.exec(n.replace(/ /g,"")),{r:parseInt(e[1],10),g:parseInt(e[2],10),b:parseInt(e[3],10)}):{r:0,g:0,b:0}},colorToRGBA(n){return n=n||"black",U._namedColorToRBA(n)||U._hex3ColorToRGBA(n)||U._hex4ColorToRGBA(n)||U._hex6ColorToRGBA(n)||U._hex8ColorToRGBA(n)||U._rgbColorToRGBA(n)||U._rgbaColorToRGBA(n)||U._hslColorToRGBA(n)},_namedColorToRBA(n){const e=ai[n.toLowerCase()];return e?{r:e[0],g:e[1],b:e[2],a:1}:null},_rgbColorToRGBA(n){if(n.indexOf("rgb(")===0){n=n.match(/rgb\(([^)]+)\)/)[1];const e=n.split(/ *, */).map(Number);return{r:e[0],g:e[1],b:e[2],a:1}}},_rgbaColorToRGBA(n){if(n.indexOf("rgba(")===0){n=n.match(/rgba\(([^)]+)\)/)[1];const e=n.split(/ *, */).map((t,i)=>t.slice(-1)==="%"?i===3?parseInt(t)/100:parseInt(t)/100*255:Number(t));return{r:e[0],g:e[1],b:e[2],a:e[3]}}},_hex8ColorToRGBA(n){if(n[0]==="#"&&n.length===9)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:parseInt(n.slice(7,9),16)/255}},_hex6ColorToRGBA(n){if(n[0]==="#"&&n.length===7)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:1}},_hex4ColorToRGBA(n){if(n[0]==="#"&&n.length===5)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:parseInt(n[4]+n[4],16)/255}},_hex3ColorToRGBA(n){if(n[0]==="#"&&n.length===4)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:1}},_hslColorToRGBA(n){if(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.test(n)){const[e,...t]=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(n),i=Number(t[0])/360,s=Number(t[1])/100,r=Number(t[2])/100;let a,l,o;if(s===0)return o=r*255,{r:Math.round(o),g:Math.round(o),b:Math.round(o),a:1};r<.5?a=r*(1+s):a=r+s-r*s;const c=2*r-a,d=[0,0,0];for(let h=0;h<3;h++)l=i+1/3*-(h-1),l<0&&l++,l>1&&l--,6*l<1?o=c+(a-c)*6*l:2*l<1?o=a:3*l<2?o=c+(a-c)*(2/3-l)*6:o=c,d[h]=o*255;return{r:Math.round(d[0]),g:Math.round(d[1]),b:Math.round(d[2]),a:1}}},haveIntersection(n,e){return!(e.x>n.x+n.width||e.x+e.width<n.x||e.y>n.y+n.height||e.y+e.height<n.y)},cloneObject(n){const e={};for(const t in n)this._isPlainObject(n[t])?e[t]=this.cloneObject(n[t]):this._isArray(n[t])?e[t]=this.cloneArray(n[t]):e[t]=n[t];return e},cloneArray(n){return n.slice(0)},degToRad(n){return n*Eo},radToDeg(n){return n*Po},_degToRad(n){return U.warn("Util._degToRad is removed. Please use public Util.degToRad instead."),U.degToRad(n)},_radToDeg(n){return U.warn("Util._radToDeg is removed. Please use public Util.radToDeg instead."),U.radToDeg(n)},_getRotation(n){return le.angleDeg?U.radToDeg(n):n},_capitalize(n){return n.charAt(0).toUpperCase()+n.slice(1)},throw(n){throw new Error(Zi+n)},error(n){console.error(Zi+n)},warn(n){le.showWarnings&&console.warn(Lo+n)},each(n,e){for(const t in n)e(t,n[t])},_inRange(n,e,t){return e<=n&&n<t},_getProjectionToSegment(n,e,t,i,s,r){let a,l,o;const c=(n-t)*(n-t)+(e-i)*(e-i);if(c==0)a=n,l=e,o=(s-t)*(s-t)+(r-i)*(r-i);else{const d=((s-n)*(t-n)+(r-e)*(i-e))/c;d<0?(a=n,l=e,o=(n-s)*(n-s)+(e-r)*(e-r)):d>1?(a=t,l=i,o=(t-s)*(t-s)+(i-r)*(i-r)):(a=n+d*(t-n),l=e+d*(i-e),o=(a-s)*(a-s)+(l-r)*(l-r))}return[a,l,o]},_getProjectionToLine(n,e,t){const i=U.cloneObject(n);let s=Number.MAX_VALUE;return e.forEach(function(r,a){if(!t&&a===e.length-1)return;const l=e[(a+1)%e.length],o=U._getProjectionToSegment(r.x,r.y,l.x,l.y,n.x,n.y),c=o[0],d=o[1],h=o[2];h<s&&(i.x=c,i.y=d,s=h)}),i},_prepareArrayForTween(n,e,t){const i=[],s=[];if(n.length>e.length){const a=e;e=n,n=a}for(let a=0;a<n.length;a+=2)i.push({x:n[a],y:n[a+1]});for(let a=0;a<e.length;a+=2)s.push({x:e[a],y:e[a+1]});const r=[];return s.forEach(function(a){const l=U._getProjectionToLine(a,i,t);r.push(l.x),r.push(l.y)}),r},_prepareToStringify(n){let e;n.visitedByCircularReferenceRemoval=!0;for(const t in n)if(n.hasOwnProperty(t)&&n[t]&&typeof n[t]=="object"){if(e=Object.getOwnPropertyDescriptor(n,t),n[t].visitedByCircularReferenceRemoval||U._isElement(n[t]))if(e.configurable)delete n[t];else return null;else if(U._prepareToStringify(n[t])===null)if(e.configurable)delete n[t];else return null}return delete n.visitedByCircularReferenceRemoval,n},_assign(n,e){for(const t in e)n[t]=e[t];return n},_getFirstPointerId(n){return n.touches?n.changedTouches[0].identifier:n.pointerId||999},releaseCanvas(...n){le.releaseCanvasOnDestroy&&n.forEach(e=>{e.width=0,e.height=0})},drawRoundedRectPath(n,e,t,i){let s=e<0?e:0,r=t<0?t:0;e=Math.abs(e),t=Math.abs(t);let a=0,l=0,o=0,c=0;typeof i=="number"?a=l=o=c=Math.min(i,e/2,t/2):(a=Math.min(i[0]||0,e/2,t/2),l=Math.min(i[1]||0,e/2,t/2),c=Math.min(i[2]||0,e/2,t/2),o=Math.min(i[3]||0,e/2,t/2)),n.moveTo(s+a,r),n.lineTo(s+e-l,r),n.arc(s+e-l,r+l,l,Math.PI*3/2,0,!1),n.lineTo(s+e,r+t-c),n.arc(s+e-c,r+t-c,c,0,Math.PI/2,!1),n.lineTo(s+o,r+t),n.arc(s+o,r+t-o,o,Math.PI/2,Math.PI,!1),n.lineTo(s,r+a),n.arc(s+a,r+a,a,Math.PI,Math.PI*3/2,!1)},drawRoundedPolygonPath(n,e,t,i,s){i=Math.abs(i);for(let r=0;r<t;r++){const a=e[(r-1+t)%t],l=e[r],o=e[(r+1)%t],c={x:l.x-a.x,y:l.y-a.y},d={x:o.x-l.x,y:o.y-l.y},h=Math.hypot(c.x,c.y),g=Math.hypot(d.x,d.y);let v;typeof s=="number"?v=s:v=r<s.length?s[r]:0,v=i*Math.cos(Math.PI/t)*Math.min(1,v/i*2);const p={x:c.x/h,y:c.y/h},m={x:d.x/g,y:d.y/g},b={x:l.x-p.x*v,y:l.y-p.y*v},_={x:l.x+m.x*v,y:l.y+m.y*v};r===0?n.moveTo(b.x,b.y):n.lineTo(b.x,b.y),n.arcTo(l.x,l.y,_.x,_.y,v)}}};function Io(n){const e=[],t=n.length,i=U;for(let s=0;s<t;s++){let r=n[s];i._isNumber(r)?r=Math.round(r*1e3)/1e3:i._isString(r)||(r=r+""),e.push(r)}return e}const es=",",No="(",zo=")",Fo="([",Go="])",Bo=";",Uo="()",Ho="=",ts=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","ellipse","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","roundRect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"],qo=["fillStyle","strokeStyle","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","letterSpacing","lineCap","lineDashOffset","lineJoin","lineWidth","miterLimit","direction","font","textAlign","textBaseline","globalAlpha","globalCompositeOperation","imageSmoothingEnabled","filter"],Wo=100;let wn=null;function ns(){if(wn!==null)return wn;try{const e=U.createCanvasElement().getContext("2d");return e?!!e&&"filter"in e:(wn=!1,!1)}catch{return wn=!1,!1}}class Qn{constructor(e){this.canvas=e,le.enableTrace&&(this.traceArr=[],this._enableTrace())}fillShape(e){e.fillEnabled()&&this._fill(e)}_fill(e){}strokeShape(e){e.hasStroke()&&this._stroke(e)}_stroke(e){}fillStrokeShape(e){e.attrs.fillAfterStrokeEnabled?(this.strokeShape(e),this.fillShape(e)):(this.fillShape(e),this.strokeShape(e))}getTrace(e,t){let i=this.traceArr,s=i.length,r="",a,l,o,c;for(a=0;a<s;a++)l=i[a],o=l.method,o?(c=l.args,r+=o,e?r+=Uo:U._isArray(c[0])?r+=Fo+c.join(es)+Go:(t&&(c=c.map(d=>typeof d=="number"?Math.floor(d):d)),r+=No+c.join(es)+zo)):(r+=l.property,e||(r+=Ho+l.val)),r+=Bo;return r}clearTrace(){this.traceArr=[]}_trace(e){let t=this.traceArr,i;t.push(e),i=t.length,i>=Wo&&t.shift()}reset(){const e=this.getCanvas().getPixelRatio();this.setTransform(1*e,0,0,1*e,0,0)}getCanvas(){return this.canvas}clear(e){const t=this.getCanvas();e?this.clearRect(e.x||0,e.y||0,e.width||0,e.height||0):this.clearRect(0,0,t.getWidth()/t.pixelRatio,t.getHeight()/t.pixelRatio)}_applyLineCap(e){const t=e.attrs.lineCap;t&&this.setAttr("lineCap",t)}_applyOpacity(e){const t=e.getAbsoluteOpacity();t!==1&&this.setAttr("globalAlpha",t)}_applyLineJoin(e){const t=e.attrs.lineJoin;t&&this.setAttr("lineJoin",t)}_applyMiterLimit(e){const t=e.attrs.miterLimit;t!=null&&this.setAttr("miterLimit",t)}setAttr(e,t){this._context[e]=t}arc(e,t,i,s,r,a){this._context.arc(e,t,i,s,r,a)}arcTo(e,t,i,s,r){this._context.arcTo(e,t,i,s,r)}beginPath(){this._context.beginPath()}bezierCurveTo(e,t,i,s,r,a){this._context.bezierCurveTo(e,t,i,s,r,a)}clearRect(e,t,i,s){this._context.clearRect(e,t,i,s)}clip(...e){this._context.clip.apply(this._context,e)}closePath(){this._context.closePath()}createImageData(e,t){const i=arguments;if(i.length===2)return this._context.createImageData(e,t);if(i.length===1)return this._context.createImageData(e)}createLinearGradient(e,t,i,s){return this._context.createLinearGradient(e,t,i,s)}createPattern(e,t){return this._context.createPattern(e,t)}createRadialGradient(e,t,i,s,r,a){return this._context.createRadialGradient(e,t,i,s,r,a)}drawImage(e,t,i,s,r,a,l,o,c){const d=arguments,h=this._context;d.length===3?h.drawImage(e,t,i):d.length===5?h.drawImage(e,t,i,s,r):d.length===9&&h.drawImage(e,t,i,s,r,a,l,o,c)}ellipse(e,t,i,s,r,a,l,o){this._context.ellipse(e,t,i,s,r,a,l,o)}isPointInPath(e,t,i,s){return i?this._context.isPointInPath(i,e,t,s):this._context.isPointInPath(e,t,s)}fill(...e){this._context.fill.apply(this._context,e)}fillRect(e,t,i,s){this._context.fillRect(e,t,i,s)}strokeRect(e,t,i,s){this._context.strokeRect(e,t,i,s)}fillText(e,t,i,s){s?this._context.fillText(e,t,i,s):this._context.fillText(e,t,i)}measureText(e){return this._context.measureText(e)}getImageData(e,t,i,s){return this._context.getImageData(e,t,i,s)}lineTo(e,t){this._context.lineTo(e,t)}moveTo(e,t){this._context.moveTo(e,t)}rect(e,t,i,s){this._context.rect(e,t,i,s)}roundRect(e,t,i,s,r){this._context.roundRect(e,t,i,s,r)}putImageData(e,t,i){this._context.putImageData(e,t,i)}quadraticCurveTo(e,t,i,s){this._context.quadraticCurveTo(e,t,i,s)}restore(){this._context.restore()}rotate(e){this._context.rotate(e)}save(){this._context.save()}scale(e,t){this._context.scale(e,t)}setLineDash(e){this._context.setLineDash?this._context.setLineDash(e):"mozDash"in this._context?this._context.mozDash=e:"webkitLineDash"in this._context&&(this._context.webkitLineDash=e)}getLineDash(){return this._context.getLineDash()}setTransform(e,t,i,s,r,a){this._context.setTransform(e,t,i,s,r,a)}stroke(e){e?this._context.stroke(e):this._context.stroke()}strokeText(e,t,i,s){this._context.strokeText(e,t,i,s)}transform(e,t,i,s,r,a){this._context.transform(e,t,i,s,r,a)}translate(e,t){this._context.translate(e,t)}_enableTrace(){let e=this,t=ts.length,i=this.setAttr,s,r;const a=function(l){let o=e[l],c;e[l]=function(){return r=Io(Array.prototype.slice.call(arguments,0)),c=o.apply(e,arguments),e._trace({method:l,args:r}),c}};for(s=0;s<t;s++)a(ts[s]);e.setAttr=function(){i.apply(e,arguments);const l=arguments[0];let o=arguments[1];(l==="shadowOffsetX"||l==="shadowOffsetY"||l==="shadowBlur")&&(o=o/this.canvas.getPixelRatio()),e._trace({property:l,val:o})}}_applyGlobalCompositeOperation(e){const t=e.attrs.globalCompositeOperation;!t||t==="source-over"||this.setAttr("globalCompositeOperation",t)}}qo.forEach(function(n){Object.defineProperty(Qn.prototype,n,{get(){return this._context[n]},set(e){this._context[n]=e}})});class jo extends Qn{constructor(e,{willReadFrequently:t=!1}={}){super(e),this._context=e._canvas.getContext("2d",{willReadFrequently:t})}_fillColor(e){const t=e.fill();this.setAttr("fillStyle",t),e._fillFunc(this)}_fillPattern(e){this.setAttr("fillStyle",e._getFillPattern()),e._fillFunc(this)}_fillLinearGradient(e){const t=e._getLinearGradient();t&&(this.setAttr("fillStyle",t),e._fillFunc(this))}_fillRadialGradient(e){const t=e._getRadialGradient();t&&(this.setAttr("fillStyle",t),e._fillFunc(this))}_fill(e){const t=e.fill(),i=e.getFillPriority();if(t&&i==="color"){this._fillColor(e);return}const s=e.getFillPatternImage();if(s&&i==="pattern"){this._fillPattern(e);return}const r=e.getFillLinearGradientColorStops();if(r&&i==="linear-gradient"){this._fillLinearGradient(e);return}const a=e.getFillRadialGradientColorStops();if(a&&i==="radial-gradient"){this._fillRadialGradient(e);return}t?this._fillColor(e):s?this._fillPattern(e):r?this._fillLinearGradient(e):a&&this._fillRadialGradient(e)}_strokeLinearGradient(e){const t=e.getStrokeLinearGradientStartPoint(),i=e.getStrokeLinearGradientEndPoint(),s=e.getStrokeLinearGradientColorStops(),r=this.createLinearGradient(t.x,t.y,i.x,i.y);if(s){for(let a=0;a<s.length;a+=2)r.addColorStop(s[a],s[a+1]);this.setAttr("strokeStyle",r)}}_stroke(e){const t=e.dash(),i=e.getStrokeScaleEnabled();if(e.hasStroke()){if(!i){this.save();const r=this.getCanvas().getPixelRatio();this.setTransform(r,0,0,r,0,0)}this._applyLineCap(e),t&&e.dashEnabled()&&(this.setLineDash(t),this.setAttr("lineDashOffset",e.dashOffset())),this.setAttr("lineWidth",e.strokeWidth()),e.getShadowForStrokeEnabled()||this.setAttr("shadowColor","rgba(0,0,0,0)"),e.getStrokeLinearGradientColorStops()?this._strokeLinearGradient(e):this.setAttr("strokeStyle",e.stroke()),e._strokeFunc(this),i||this.restore()}}_applyShadow(e){var t,i,s;const r=(t=e.getShadowRGBA())!==null&&t!==void 0?t:"black",a=(i=e.getShadowBlur())!==null&&i!==void 0?i:5,l=(s=e.getShadowOffset())!==null&&s!==void 0?s:{x:0,y:0},o=e.getAbsoluteScale(),c=this.canvas.getPixelRatio(),d=o.x*c,h=o.y*c;this.setAttr("shadowColor",r),this.setAttr("shadowBlur",a*Math.min(Math.abs(d),Math.abs(h))),this.setAttr("shadowOffsetX",l.x*d),this.setAttr("shadowOffsetY",l.y*h)}}class Yo extends Qn{constructor(e){super(e),this._context=e._canvas.getContext("2d",{willReadFrequently:!0})}_fill(e){this.save(),this.setAttr("fillStyle",e.colorKey),e._fillFuncHit(this),this.restore()}strokeShape(e){e.hasHitStroke()&&this._stroke(e)}_stroke(e){if(e.hasHitStroke()){const t=e.getStrokeScaleEnabled();if(!t){this.save();const r=this.getCanvas().getPixelRatio();this.setTransform(r,0,0,r,0,0)}this._applyLineCap(e);const i=e.hitStrokeWidth(),s=i==="auto"?e.strokeWidth():i;this.setAttr("lineWidth",s),this.setAttr("strokeStyle",e.colorKey),e._strokeFuncHit(this),t||this.restore()}}}let $n;function Vo(){if($n)return $n;const n=U.createCanvasElement(),e=n.getContext("2d");return $n=function(){const t=le._global.devicePixelRatio||1,i=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return t/i}(),U.releaseCanvas(n),$n}class Li{constructor(e){this.pixelRatio=1,this.width=0,this.height=0,this.isCache=!1;const i=(e||{}).pixelRatio||le.pixelRatio||Vo();this.pixelRatio=i,this._canvas=U.createCanvasElement(),this._canvas.style.padding="0",this._canvas.style.margin="0",this._canvas.style.border="0",this._canvas.style.background="transparent",this._canvas.style.position="absolute",this._canvas.style.top="0",this._canvas.style.left="0"}getContext(){return this.context}getPixelRatio(){return this.pixelRatio}setPixelRatio(e){const t=this.pixelRatio;this.pixelRatio=e,this.setSize(this.getWidth()/t,this.getHeight()/t)}setWidth(e){this.width=this._canvas.width=e*this.pixelRatio,this._canvas.style.width=e+"px";const t=this.pixelRatio;this.getContext()._context.scale(t,t)}setHeight(e){this.height=this._canvas.height=e*this.pixelRatio,this._canvas.style.height=e+"px";const t=this.pixelRatio;this.getContext()._context.scale(t,t)}getWidth(){return this.width}getHeight(){return this.height}setSize(e,t){this.setWidth(e||0),this.setHeight(t||0)}toDataURL(e,t){try{return this._canvas.toDataURL(e,t)}catch{try{return this._canvas.toDataURL()}catch(s){return U.error("Unable to get data URL. "+s.message+" For more info read https://konvajs.org/docs/posts/Tainted_Canvas.html."),""}}}}class St extends Li{constructor(e={width:0,height:0,willReadFrequently:!1}){super(e),this.context=new jo(this,{willReadFrequently:e.willReadFrequently}),this.setSize(e.width,e.height)}}function is(){const n=U.createCanvasElement();n.width=1,n.height=1;const e=n.getContext("2d",{willReadFrequently:!0});e.clearRect(0,0,1,1),e.fillStyle="rgba(255,0,255,1)",e.fillRect(0,0,1,1);const t=e.getImageData(0,0,1,1).data;return!(t[0]===255&&t[1]===0&&t[2]===255&&t[3]===255)}function ss(){var n,e;return typeof navigator>"u"?!1:(e=(n=navigator.brave)===null||n===void 0?void 0:n.isBrave())!==null&&e!==void 0?e:!1}let rs=!1;function Xo(){return ss()&&is()&&!rs&&(rs=!0,U.error('Looks like you have "Brave shield" enabled in your browser. It breaks KonvaJS internals. Please disable it. You may need to ask your users to do the same.')),ss()&&is()}class Mi extends Li{constructor(e={width:0,height:0}){super(e),this.hitCanvas=!0,this.context=new Yo(this),this.setSize(e.width,e.height),Xo()}}const Le={get isDragging(){let n=!1;return Le._dragElements.forEach(e=>{e.dragStatus==="dragging"&&(n=!0)}),n},justDragged:!1,get node(){let n;return Le._dragElements.forEach(e=>{n=e.node}),n},_dragElements:new Map,_drag(n){const e=[];Le._dragElements.forEach((t,i)=>{const{node:s}=t,r=s.getStage();r.setPointersPositions(n),t.pointerId===void 0&&(t.pointerId=U._getFirstPointerId(n));const a=r._changedPointerPositions.find(l=>l.id===t.pointerId);if(a){if(t.dragStatus!=="dragging"){const l=s.dragDistance();if(Math.max(Math.abs(a.x-t.startPointerPos.x),Math.abs(a.y-t.startPointerPos.y))<l||(s.startDrag({evt:n}),!s.isDragging()))return}s._setDragPosition(n,t),e.push(s)}}),e.forEach(t=>{t.fire("dragmove",{type:"dragmove",target:t,evt:n},!0)})},_endDragBefore(n){const e=[];Le._dragElements.forEach(t=>{const{node:i}=t,s=i.getStage();if(n&&s.setPointersPositions(n),!s._changedPointerPositions.find(l=>l.id===t.pointerId))return;(t.dragStatus==="dragging"||t.dragStatus==="stopped")&&(Le.justDragged=!0,le._mouseListenClick=!1,le._touchListenClick=!1,le._pointerListenClick=!1,t.dragStatus="stopped");const a=t.node.getLayer()||t.node instanceof le.Stage&&t.node;a&&e.indexOf(a)===-1&&e.push(a)}),e.forEach(t=>{t.draw()})},_endDragAfter(n){Le._dragElements.forEach((e,t)=>{e.dragStatus==="stopped"&&e.node.fire("dragend",{type:"dragend",target:e.node,evt:n},!0),e.dragStatus!=="dragging"&&Le._dragElements.delete(t)})}};le.isBrowser&&(window.addEventListener("mouseup",Le._endDragBefore,!0),window.addEventListener("touchend",Le._endDragBefore,!0),window.addEventListener("touchcancel",Le._endDragBefore,!0),window.addEventListener("mousemove",Le._drag),window.addEventListener("touchmove",Le._drag),window.addEventListener("mouseup",Le._endDragAfter,!1),window.addEventListener("touchend",Le._endDragAfter,!1),window.addEventListener("touchcancel",Le._endDragAfter,!1));function Ct(n){return U._isString(n)?'"'+n+'"':Object.prototype.toString.call(n)==="[object Number]"||U._isBoolean(n)?n:Object.prototype.toString.call(n)}function rr(n){return n>255?255:n<0?0:Math.round(n)}function re(){if(le.isUnminified)return function(n,e){return U._isNumber(n)||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a number.'),n}}function Kn(n){if(le.isUnminified)return function(e,t){let i=U._isNumber(e),s=U._isArray(e)&&e.length==n;return!i&&!s&&U.warn(Ct(e)+' is a not valid value for "'+t+'" attribute. The value should be a number or Array<number>('+n+")"),e}}function Di(){if(le.isUnminified)return function(n,e){return U._isNumber(n)||n==="auto"||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a number or "auto".'),n}}function Ot(){if(le.isUnminified)return function(n,e){return U._isString(n)||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a string.'),n}}function ar(){if(le.isUnminified)return function(n,e){const t=U._isString(n),i=Object.prototype.toString.call(n)==="[object CanvasGradient]"||n&&n.addColorStop;return t||i||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a string or a native gradient.'),n}}function Qo(){if(le.isUnminified)return function(n,e){const t=Int8Array?Object.getPrototypeOf(Int8Array):null;return t&&n instanceof t||(U._isArray(n)?n.forEach(function(i){U._isNumber(i)||U.warn('"'+e+'" attribute has non numeric element '+i+". Make sure that all elements are numbers.")}):U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a array of numbers.')),n}}function lt(){if(le.isUnminified)return function(n,e){return n===!0||n===!1||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a boolean.'),n}}function Ko(n){if(le.isUnminified)return function(e,t){return e==null||U.isObject(e)||U.warn(Ct(e)+' is a not valid value for "'+t+'" attribute. The value should be an object with properties '+n),e}}const Zt="get",en="set",T={addGetterSetter(n,e,t,i,s){T.addGetter(n,e,t),T.addSetter(n,e,i,s),T.addOverloadedGetterSetter(n,e)},addGetter(n,e,t){const i=Zt+U._capitalize(e);n.prototype[i]=n.prototype[i]||function(){const s=this.attrs[e];return s===void 0?t:s}},addSetter(n,e,t,i){const s=en+U._capitalize(e);n.prototype[s]||T.overWriteSetter(n,e,t,i)},overWriteSetter(n,e,t,i){const s=en+U._capitalize(e);n.prototype[s]=function(r){return t&&r!==void 0&&r!==null&&(r=t.call(this,r,e)),this._setAttr(e,r),i&&i.call(this),this}},addComponentsGetterSetter(n,e,t,i,s){const r=t.length,a=U._capitalize,l=Zt+a(e),o=en+a(e);n.prototype[l]=function(){const d={};for(let h=0;h<r;h++){const g=t[h];d[g]=this.getAttr(e+a(g))}return d};const c=Ko(t);n.prototype[o]=function(d){const h=this.attrs[e];i&&(d=i.call(this,d,e)),c&&c.call(this,d,e);for(const g in d)d.hasOwnProperty(g)&&this._setAttr(e+a(g),d[g]);return d||t.forEach(g=>{this._setAttr(e+a(g),void 0)}),this._fireChangeEvent(e,h,d),s&&s.call(this),this},T.addOverloadedGetterSetter(n,e)},addOverloadedGetterSetter(n,e){const t=U._capitalize(e),i=en+t,s=Zt+t;n.prototype[e]=function(){return arguments.length?(this[i](arguments[0]),this):this[s]()}},addDeprecatedGetterSetter(n,e,t,i){U.error("Adding deprecated "+e);const s=Zt+U._capitalize(e),r=e+" property is deprecated and will be removed soon. Look at Konva change log for more information.";n.prototype[s]=function(){U.error(r);const a=this.attrs[e];return a===void 0?t:a},T.addSetter(n,e,i,function(){U.error(r)}),T.addOverloadedGetterSetter(n,e)},backCompat(n,e){U.each(e,function(t,i){const s=n.prototype[i],r=Zt+U._capitalize(t),a=en+U._capitalize(t);function l(){s.apply(this,arguments),U.error('"'+t+'" method is deprecated and will be removed soon. Use ""'+i+'" instead.')}n.prototype[t]=l,n.prototype[r]=l,n.prototype[a]=l})},afterSetFilter(){this._filterUpToDate=!1}};function Jo(n){const e=/(\w+)\(([^)]+)\)/g;let t;for(;(t=e.exec(n))!==null;){const[,i,s]=t;switch(i){case"blur":{const r=parseFloat(s.replace("px",""));return function(a){this.blurRadius(r*.5);const l=le.Filters;l&&l.Blur&&l.Blur.call(this,a)}}case"brightness":{const r=s.includes("%")?parseFloat(s)/100:parseFloat(s);return function(a){this.brightness(r);const l=le.Filters;l&&l.Brightness&&l.Brightness.call(this,a)}}case"contrast":{const r=parseFloat(s);return function(a){const l=100*(Math.sqrt(r)-1);this.contrast(l);const o=le.Filters;o&&o.Contrast&&o.Contrast.call(this,a)}}case"grayscale":return function(r){const a=le.Filters;a&&a.Grayscale&&a.Grayscale.call(this,r)};case"sepia":return function(r){const a=le.Filters;a&&a.Sepia&&a.Sepia.call(this,r)};case"invert":return function(r){const a=le.Filters;a&&a.Invert&&a.Invert.call(this,r)};default:U.warn(`CSS filter "${i}" is not supported in fallback mode. Consider using function filters for better compatibility.`);break}}return()=>{}}const On="absoluteOpacity",Cn="allEventListeners",ht="absoluteTransform",as="absoluteScale",At="canvas",Zo="Change",ec="children",tc="konva",_i="listening",nc="mouseenter",ic="mouseleave",sc="pointerenter",rc="pointerleave",ac="touchenter",lc="touchleave",ls="set",os="Shape",In=" ",cs="stage",yt="transform",oc="Stage",xi="visible",cc=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(In);let dc=1;class se{constructor(e){this._id=dc++,this.eventListeners={},this.attrs={},this.index=0,this._allEventListeners=null,this.parent=null,this._cache=new Map,this._attachedDepsListeners=new Map,this._lastPos=null,this._batchingTransformChange=!1,this._needClearTransformCache=!1,this._filterUpToDate=!1,this._isUnderCache=!1,this._dragEventId=null,this._shouldFireChangeEvents=!1,this.setAttrs(e),this._shouldFireChangeEvents=!0}hasChildren(){return!1}_clearCache(e){(e===yt||e===ht)&&this._cache.get(e)?this._cache.get(e).dirty=!0:e?this._cache.delete(e):this._cache.clear()}_getCache(e,t){let i=this._cache.get(e);return(i===void 0||(e===yt||e===ht)&&i.dirty===!0)&&(i=t.call(this),this._cache.set(e,i)),i}_calculate(e,t,i){if(!this._attachedDepsListeners.get(e)){const s=t.map(r=>r+"Change.konva").join(In);this.on(s,()=>{this._clearCache(e)}),this._attachedDepsListeners.set(e,!0)}return this._getCache(e,i)}_getCanvasCache(){return this._cache.get(At)}_clearSelfAndDescendantCache(e){this._clearCache(e),e===ht&&this.fire("absoluteTransformChange")}clearCache(){if(this._cache.has(At)){const{scene:e,filter:t,hit:i,buffer:s}=this._cache.get(At);U.releaseCanvas(e,t,i,s),this._cache.delete(At)}return this._clearSelfAndDescendantCache(),this._requestDraw(),this}cache(e){const t=e||{};let i={};(t.x===void 0||t.y===void 0||t.width===void 0||t.height===void 0)&&(i=this.getClientRect({skipTransform:!0,relativeTo:this.getParent()||void 0}));let s=Math.ceil(t.width||i.width),r=Math.ceil(t.height||i.height),a=t.pixelRatio,l=t.x===void 0?Math.floor(i.x):t.x,o=t.y===void 0?Math.floor(i.y):t.y,c=t.offset||0,d=t.drawBorder||!1,h=t.hitCanvasPixelRatio||1;if(!s||!r){U.error("Can not cache the node. Width or height of the node equals 0. Caching is skipped.");return}const g=Math.abs(Math.round(i.x)-l)>.5?1:0,v=Math.abs(Math.round(i.y)-o)>.5?1:0;s+=c*2+g,r+=c*2+v,l-=c,o-=c;const u=new St({pixelRatio:a,width:s,height:r}),p=new St({pixelRatio:a,width:0,height:0,willReadFrequently:!0}),m=new Mi({pixelRatio:h,width:s,height:r}),b=u.getContext(),_=m.getContext(),w=new St({width:u.width/u.pixelRatio+Math.abs(l),height:u.height/u.pixelRatio+Math.abs(o),pixelRatio:u.pixelRatio}),S=w.getContext();return m.isCache=!0,u.isCache=!0,this._cache.delete(At),this._filterUpToDate=!1,t.imageSmoothingEnabled===!1&&(u.getContext()._context.imageSmoothingEnabled=!1,p.getContext()._context.imageSmoothingEnabled=!1),b.save(),_.save(),S.save(),b.translate(-l,-o),_.translate(-l,-o),S.translate(-l,-o),w.x=l,w.y=o,this._isUnderCache=!0,this._clearSelfAndDescendantCache(On),this._clearSelfAndDescendantCache(as),this.drawScene(u,this,w),this.drawHit(m,this),this._isUnderCache=!1,b.restore(),_.restore(),d&&(b.save(),b.beginPath(),b.rect(0,0,s,r),b.closePath(),b.setAttr("strokeStyle","red"),b.setAttr("lineWidth",5),b.stroke(),b.restore()),this._cache.set(At,{scene:u,filter:p,hit:m,buffer:w,x:l,y:o}),this._requestDraw(),this}isCached(){return this._cache.has(At)}getClientRect(e){throw new Error('abstract "getClientRect" method call')}_transformedRect(e,t){const i=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}];let s=1/0,r=1/0,a=-1/0,l=-1/0;const o=this.getAbsoluteTransform(t);return i.forEach(function(c){const d=o.point(c);s===void 0&&(s=a=d.x,r=l=d.y),s=Math.min(s,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y)}),{x:s,y:r,width:a-s,height:l-r}}_drawCachedSceneCanvas(e){e.save(),e._applyOpacity(this),e._applyGlobalCompositeOperation(this);const t=this._getCanvasCache();e.translate(t.x,t.y);const i=this._getCachedSceneCanvas(),s=i.pixelRatio;e.drawImage(i._canvas,0,0,i.width/s,i.height/s),e.restore()}_drawCachedHitCanvas(e){const t=this._getCanvasCache(),i=t.hit;e.save(),e.translate(t.x,t.y),e.drawImage(i._canvas,0,0,i.width/i.pixelRatio,i.height/i.pixelRatio),e.restore()}_getCachedSceneCanvas(){let e=this.filters(),t=this._getCanvasCache(),i=t.scene,s=t.filter,r=s.getContext(),a,l,o,c;if(!e||e.length===0)return i;if(this._filterUpToDate)return s;let d=!0;for(let g=0;g<e.length;g++)if(typeof e[g]=="string"&&ns(),typeof e[g]!="string"||!ns()){d=!1;break}const h=i.pixelRatio;if(s.setSize(i.width/i.pixelRatio,i.height/i.pixelRatio),d){const g=e.join(" ");return r.save(),r.setAttr("filter",g),r.drawImage(i._canvas,0,0,i.getWidth()/h,i.getHeight()/h),r.restore(),this._filterUpToDate=!0,s}try{for(a=e.length,r.clear(),r.drawImage(i._canvas,0,0,i.getWidth()/h,i.getHeight()/h),l=r.getImageData(0,0,s.getWidth(),s.getHeight()),o=0;o<a;o++)c=e[o],typeof c=="string"&&(c=Jo(c)),c.call(this,l),r.putImageData(l,0,0)}catch(g){U.error("Unable to apply filter. "+g.message+" This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.")}return this._filterUpToDate=!0,s}on(e,t){if(this._cache&&this._cache.delete(Cn),arguments.length===3)return this._delegate.apply(this,arguments);const i=e.split(In);for(let s=0;s<i.length;s++){const a=i[s].split("."),l=a[0],o=a[1]||"";this.eventListeners[l]||(this.eventListeners[l]=[]),this.eventListeners[l].push({name:o,handler:t})}return this}off(e,t){let i=(e||"").split(In),s=i.length,r,a,l,o,c,d;if(this._cache&&this._cache.delete(Cn),!e)for(a in this.eventListeners)this._off(a);for(r=0;r<s;r++)if(l=i[r],o=l.split("."),c=o[0],d=o[1],c)this.eventListeners[c]&&this._off(c,d,t);else for(a in this.eventListeners)this._off(a,d,t);return this}dispatchEvent(e){const t={target:this,type:e.type,evt:e};return this.fire(e.type,t),this}addEventListener(e,t){return this.on(e,function(i){t.call(this,i.evt)}),this}removeEventListener(e){return this.off(e),this}_delegate(e,t,i){const s=this;this.on(e,function(r){const a=r.target.findAncestors(t,!0,s);for(let l=0;l<a.length;l++)r=U.cloneObject(r),r.currentTarget=a[l],i.call(a[l],r)})}remove(){return this.isDragging()&&this.stopDrag(),Le._dragElements.delete(this._id),this._remove(),this}_clearCaches(){this._clearSelfAndDescendantCache(ht),this._clearSelfAndDescendantCache(On),this._clearSelfAndDescendantCache(as),this._clearSelfAndDescendantCache(cs),this._clearSelfAndDescendantCache(xi),this._clearSelfAndDescendantCache(_i)}_remove(){this._clearCaches();const e=this.getParent();e&&e.children&&(e.children.splice(this.index,1),e._setChildrenIndices(),this.parent=null)}destroy(){return this.remove(),this.clearCache(),this}getAttr(e){const t="get"+U._capitalize(e);return U._isFunction(this[t])?this[t]():this.attrs[e]}getAncestors(){let e=this.getParent(),t=[];for(;e;)t.push(e),e=e.getParent();return t}getAttrs(){return this.attrs||{}}setAttrs(e){return this._batchTransformChanges(()=>{let t,i;if(!e)return this;for(t in e)t!==ec&&(i=ls+U._capitalize(t),U._isFunction(this[i])?this[i](e[t]):this._setAttr(t,e[t]))}),this}isListening(){return this._getCache(_i,this._isListening)}_isListening(e){if(!this.listening())return!1;const i=this.getParent();return i&&i!==e&&this!==e?i._isListening(e):!0}isVisible(){return this._getCache(xi,this._isVisible)}_isVisible(e){if(!this.visible())return!1;const i=this.getParent();return i&&i!==e&&this!==e?i._isVisible(e):!0}shouldDrawHit(e,t=!1){if(e)return this._isVisible(e)&&this._isListening(e);const i=this.getLayer();let s=!1;Le._dragElements.forEach(a=>{a.dragStatus==="dragging"&&(a.node.nodeType==="Stage"||a.node.getLayer()===i)&&(s=!0)});const r=!t&&!le.hitOnDragEnabled&&(s||le.isTransforming());return this.isListening()&&this.isVisible()&&!r}show(){return this.visible(!0),this}hide(){return this.visible(!1),this}getZIndex(){return this.index||0}getAbsoluteZIndex(){let e=this.getDepth(),t=this,i=0,s,r,a,l;function o(d){for(s=[],r=d.length,a=0;a<r;a++)l=d[a],i++,l.nodeType!==os&&(s=s.concat(l.getChildren().slice())),l._id===t._id&&(a=r);s.length>0&&s[0].getDepth()<=e&&o(s)}const c=this.getStage();return t.nodeType!==oc&&c&&o(c.getChildren()),i}getDepth(){let e=0,t=this.parent;for(;t;)e++,t=t.parent;return e}_batchTransformChanges(e){this._batchingTransformChange=!0,e(),this._batchingTransformChange=!1,this._needClearTransformCache&&(this._clearCache(yt),this._clearSelfAndDescendantCache(ht)),this._needClearTransformCache=!1}setPosition(e){return this._batchTransformChanges(()=>{this.x(e.x),this.y(e.y)}),this}getPosition(){return{x:this.x(),y:this.y()}}getRelativePointerPosition(){const e=this.getStage();if(!e)return null;const t=e.getPointerPosition();if(!t)return null;const i=this.getAbsoluteTransform().copy();return i.invert(),i.point(t)}getAbsolutePosition(e){let t=!1,i=this.parent;for(;i;){if(i.isCached()){t=!0;break}i=i.parent}t&&!e&&(e=!0);const s=this.getAbsoluteTransform(e).getMatrix(),r=new Ke,a=this.offset();return r.m=s.slice(),r.translate(a.x,a.y),r.getTranslation()}setAbsolutePosition(e){const{x:t,y:i,...s}=this._clearTransform();this.attrs.x=t,this.attrs.y=i,this._clearCache(yt);const r=this._getAbsoluteTransform().copy();return r.invert(),r.translate(e.x,e.y),e={x:this.attrs.x+r.getTranslation().x,y:this.attrs.y+r.getTranslation().y},this._setTransform(s),this.setPosition({x:e.x,y:e.y}),this._clearCache(yt),this._clearSelfAndDescendantCache(ht),this}_setTransform(e){let t;for(t in e)this.attrs[t]=e[t]}_clearTransform(){const e={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,e}move(e){let t=e.x,i=e.y,s=this.x(),r=this.y();return t!==void 0&&(s+=t),i!==void 0&&(r+=i),this.setPosition({x:s,y:r}),this}_eachAncestorReverse(e,t){let i=[],s=this.getParent(),r,a;if(!(t&&t._id===this._id)){for(i.unshift(this);s&&(!t||s._id!==t._id);)i.unshift(s),s=s.parent;for(r=i.length,a=0;a<r;a++)e(i[a])}}rotate(e){return this.rotation(this.rotation()+e),this}moveToTop(){if(!this.parent)return U.warn("Node has no parent. moveToTop function is ignored."),!1;const e=this.index,t=this.parent.getChildren().length;return e<t-1?(this.parent.children.splice(e,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0):!1}moveUp(){if(!this.parent)return U.warn("Node has no parent. moveUp function is ignored."),!1;const e=this.index,t=this.parent.getChildren().length;return e<t-1?(this.parent.children.splice(e,1),this.parent.children.splice(e+1,0,this),this.parent._setChildrenIndices(),!0):!1}moveDown(){if(!this.parent)return U.warn("Node has no parent. moveDown function is ignored."),!1;const e=this.index;return e>0?(this.parent.children.splice(e,1),this.parent.children.splice(e-1,0,this),this.parent._setChildrenIndices(),!0):!1}moveToBottom(){if(!this.parent)return U.warn("Node has no parent. moveToBottom function is ignored."),!1;const e=this.index;return e>0?(this.parent.children.splice(e,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0):!1}setZIndex(e){if(!this.parent)return U.warn("Node has no parent. zIndex parameter is ignored."),this;(e<0||e>=this.parent.children.length)&&U.warn("Unexpected value "+e+" for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to "+(this.parent.children.length-1)+".");const t=this.index;return this.parent.children.splice(t,1),this.parent.children.splice(e,0,this),this.parent._setChildrenIndices(),this}getAbsoluteOpacity(){return this._getCache(On,this._getAbsoluteOpacity)}_getAbsoluteOpacity(){let e=this.opacity();const t=this.getParent();return t&&!t._isUnderCache&&(e*=t.getAbsoluteOpacity()),e}moveTo(e){return this.getParent()!==e&&(this._remove(),e.add(this)),this}toObject(){let e=this.getAttrs(),t,i,s,r,a;const l={attrs:{},className:this.getClassName()};for(t in e)i=e[t],a=U.isObject(i)&&!U._isPlainObject(i)&&!U._isArray(i),!a&&(s=typeof this[t]=="function"&&this[t],delete e[t],r=s?s.call(this):null,e[t]=i,r!==i&&(l.attrs[t]=i));return U._prepareToStringify(l)}toJSON(){return JSON.stringify(this.toObject())}getParent(){return this.parent}findAncestors(e,t,i){const s=[];t&&this._isMatch(e)&&s.push(this);let r=this.parent;for(;r;){if(r===i)return s;r._isMatch(e)&&s.push(r),r=r.parent}return s}isAncestorOf(e){return!1}findAncestor(e,t,i){return this.findAncestors(e,t,i)[0]}_isMatch(e){if(!e)return!1;if(typeof e=="function")return e(this);let t=e.replace(/ /g,"").split(","),i=t.length,s,r;for(s=0;s<i;s++)if(r=t[s],U.isValidSelector(r)||(U.warn('Selector "'+r+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),U.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),U.warn("Konva is awesome, right?")),r.charAt(0)==="#"){if(this.id()===r.slice(1))return!0}else if(r.charAt(0)==="."){if(this.hasName(r.slice(1)))return!0}else if(this.className===r||this.nodeType===r)return!0;return!1}getLayer(){const e=this.getParent();return e?e.getLayer():null}getStage(){return this._getCache(cs,this._getStage)}_getStage(){const e=this.getParent();return e?e.getStage():null}fire(e,t={},i){return t.target=t.target||this,i?this._fireAndBubble(e,t):this._fire(e,t),this}getAbsoluteTransform(e){return e?this._getAbsoluteTransform(e):this._getCache(ht,this._getAbsoluteTransform)}_getAbsoluteTransform(e){let t;if(e)return t=new Ke,this._eachAncestorReverse(function(i){const s=i.transformsEnabled();s==="all"?t.multiply(i.getTransform()):s==="position"&&t.translate(i.x()-i.offsetX(),i.y()-i.offsetY())},e),t;{t=this._cache.get(ht)||new Ke,this.parent?this.parent.getAbsoluteTransform().copyInto(t):t.reset();const i=this.transformsEnabled();if(i==="all")t.multiply(this.getTransform());else if(i==="position"){const s=this.attrs.x||0,r=this.attrs.y||0,a=this.attrs.offsetX||0,l=this.attrs.offsetY||0;t.translate(s-a,r-l)}return t.dirty=!1,t}}getAbsoluteScale(e){let t=this;for(;t;)t._isUnderCache&&(e=t),t=t.getParent();const s=this.getAbsoluteTransform(e).decompose();return{x:s.scaleX,y:s.scaleY}}getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation}getTransform(){return this._getCache(yt,this._getTransform)}_getTransform(){var e,t;const i=this._cache.get(yt)||new Ke;i.reset();const s=this.x(),r=this.y(),a=le.getAngle(this.rotation()),l=(e=this.attrs.scaleX)!==null&&e!==void 0?e:1,o=(t=this.attrs.scaleY)!==null&&t!==void 0?t:1,c=this.attrs.skewX||0,d=this.attrs.skewY||0,h=this.attrs.offsetX||0,g=this.attrs.offsetY||0;return(s!==0||r!==0)&&i.translate(s,r),a!==0&&i.rotate(a),(c!==0||d!==0)&&i.skew(c,d),(l!==1||o!==1)&&i.scale(l,o),(h!==0||g!==0)&&i.translate(-1*h,-1*g),i.dirty=!1,i}clone(e){let t=U.cloneObject(this.attrs),i,s,r,a,l;for(i in e)t[i]=e[i];const o=new this.constructor(t);for(i in this.eventListeners)for(s=this.eventListeners[i],r=s.length,a=0;a<r;a++)l=s[a],l.name.indexOf(tc)<0&&(o.eventListeners[i]||(o.eventListeners[i]=[]),o.eventListeners[i].push(l));return o}_toKonvaCanvas(e){e=e||{};const t=this.getClientRect(),i=this.getStage(),s=e.x!==void 0?e.x:Math.floor(t.x),r=e.y!==void 0?e.y:Math.floor(t.y),a=e.pixelRatio||1,l=new St({width:e.width||Math.ceil(t.width)||(i?i.width():0),height:e.height||Math.ceil(t.height)||(i?i.height():0),pixelRatio:a}),o=l.getContext(),c=new St({width:l.width/l.pixelRatio+Math.abs(s),height:l.height/l.pixelRatio+Math.abs(r),pixelRatio:l.pixelRatio});return e.imageSmoothingEnabled===!1&&(o._context.imageSmoothingEnabled=!1),o.save(),(s||r)&&o.translate(-1*s,-1*r),this.drawScene(l,void 0,c),o.restore(),l}toCanvas(e){return this._toKonvaCanvas(e)._canvas}toDataURL(e){e=e||{};const t=e.mimeType||null,i=e.quality||null,s=this._toKonvaCanvas(e).toDataURL(t,i);return e.callback&&e.callback(s),s}toImage(e){return new Promise((t,i)=>{try{const s=e?.callback;s&&delete e.callback,U._urlToImage(this.toDataURL(e),function(r){t(r),s?.(r)})}catch(s){i(s)}})}toBlob(e){return new Promise((t,i)=>{try{const s=e?.callback;s&&delete e.callback,this.toCanvas(e).toBlob(r=>{t(r),s?.(r)},e?.mimeType,e?.quality)}catch(s){i(s)}})}setSize(e){return this.width(e.width),this.height(e.height),this}getSize(){return{width:this.width(),height:this.height()}}getClassName(){return this.className||this.nodeType}getType(){return this.nodeType}getDragDistance(){return this.attrs.dragDistance!==void 0?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():le.dragDistance}_off(e,t,i){let s=this.eventListeners[e],r,a,l;for(r=0;r<s.length;r++)if(a=s[r].name,l=s[r].handler,(a!=="konva"||t==="konva")&&(!t||a===t)&&(!i||i===l)){if(s.splice(r,1),s.length===0){delete this.eventListeners[e];break}r--}}_fireChangeEvent(e,t,i){this._fire(e+Zo,{oldVal:t,newVal:i})}addName(e){if(!this.hasName(e)){const t=this.name(),i=t?t+" "+e:e;this.name(i)}return this}hasName(e){if(!e)return!1;const t=this.name();return t?(t||"").split(/\s/g).indexOf(e)!==-1:!1}removeName(e){const t=(this.name()||"").split(/\s/g),i=t.indexOf(e);return i!==-1&&(t.splice(i,1),this.name(t.join(" "))),this}setAttr(e,t){const i=this[ls+U._capitalize(e)];return U._isFunction(i)?i.call(this,t):this._setAttr(e,t),this}_requestDraw(){if(le.autoDrawEnabled){const e=this.getLayer()||this.getStage();e?.batchDraw()}}_setAttr(e,t){const i=this.attrs[e];i===t&&!U.isObject(t)||(t==null?delete this.attrs[e]:this.attrs[e]=t,this._shouldFireChangeEvents&&this._fireChangeEvent(e,i,t),this._requestDraw())}_setComponentAttr(e,t,i){let s;i!==void 0&&(s=this.attrs[e],s||(this.attrs[e]=this.getAttr(e)),this.attrs[e][t]=i,this._fireChangeEvent(e,s,i))}_fireAndBubble(e,t,i){t&&this.nodeType===os&&(t.target=this);const s=[nc,ic,sc,rc,ac,lc];if(!(s.indexOf(e)!==-1&&(i&&(this===i||this.isAncestorOf&&this.isAncestorOf(i))||this.nodeType==="Stage"&&!i))){this._fire(e,t);const a=s.indexOf(e)!==-1&&i&&i.isAncestorOf&&i.isAncestorOf(this)&&!i.isAncestorOf(this.parent);(t&&!t.cancelBubble||!t)&&this.parent&&this.parent.isListening()&&!a&&(i&&i.parent?this._fireAndBubble.call(this.parent,e,t,i):this._fireAndBubble.call(this.parent,e,t))}}_getProtoListeners(e){var t,i,s;const r=(t=this._cache.get(Cn))!==null&&t!==void 0?t:{};let a=r?.[e];if(a===void 0){a=[];let l=Object.getPrototypeOf(this);for(;l;){const o=(s=(i=l.eventListeners)===null||i===void 0?void 0:i[e])!==null&&s!==void 0?s:[];a.push(...o),l=Object.getPrototypeOf(l)}r[e]=a,this._cache.set(Cn,r)}return a}_fire(e,t){t=t||{},t.currentTarget=this,t.type=e;const i=this._getProtoListeners(e);if(i)for(let r=0;r<i.length;r++)i[r].handler.call(this,t);const s=this.eventListeners[e];if(s)for(let r=0;r<s.length;r++)s[r].handler.call(this,t)}draw(){return this.drawScene(),this.drawHit(),this}_createDragElement(e){const t=e?e.pointerId:void 0,i=this.getStage(),s=this.getAbsolutePosition();if(!i)return;const r=i._getPointerById(t)||i._changedPointerPositions[0]||s;Le._dragElements.set(this._id,{node:this,startPointerPos:r,offset:{x:r.x-s.x,y:r.y-s.y},dragStatus:"ready",pointerId:t})}startDrag(e,t=!0){Le._dragElements.has(this._id)||this._createDragElement(e);const i=Le._dragElements.get(this._id);i.dragStatus="dragging",this.fire("dragstart",{type:"dragstart",target:this,evt:e&&e.evt},t)}_setDragPosition(e,t){const i=this.getStage()._getPointerById(t.pointerId);if(!i)return;let s={x:i.x-t.offset.x,y:i.y-t.offset.y};const r=this.dragBoundFunc();if(r!==void 0){const a=r.call(this,s,e);a?s=a:U.warn("dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.")}(!this._lastPos||this._lastPos.x!==s.x||this._lastPos.y!==s.y)&&(this.setAbsolutePosition(s),this._requestDraw()),this._lastPos=s}stopDrag(e){const t=Le._dragElements.get(this._id);t&&(t.dragStatus="stopped"),Le._endDragBefore(e),Le._endDragAfter(e)}setDraggable(e){this._setAttr("draggable",e),this._dragChange()}isDragging(){const e=Le._dragElements.get(this._id);return e?e.dragStatus==="dragging":!1}_listenDrag(){this._dragCleanup(),this.on("mousedown.konva touchstart.konva",function(e){if(!(!(e.evt.button!==void 0)||le.dragButtons.indexOf(e.evt.button)>=0)||this.isDragging())return;let s=!1;Le._dragElements.forEach(r=>{this.isAncestorOf(r.node)&&(s=!0)}),s||this._createDragElement(e)})}_dragChange(){if(this.attrs.draggable)this._listenDrag();else{if(this._dragCleanup(),!this.getStage())return;const t=Le._dragElements.get(this._id),i=t&&t.dragStatus==="dragging",s=t&&t.dragStatus==="ready";i?this.stopDrag():s&&Le._dragElements.delete(this._id)}}_dragCleanup(){this.off("mousedown.konva"),this.off("touchstart.konva")}isClientRectOnScreen(e={x:0,y:0}){const t=this.getStage();if(!t)return!1;const i={x:-e.x,y:-e.y,width:t.width()+2*e.x,height:t.height()+2*e.y};return U.haveIntersection(i,this.getClientRect())}static create(e,t){return U._isString(e)&&(e=JSON.parse(e)),this._createNode(e,t)}static _createNode(e,t){let i=se.prototype.getClassName.call(e),s=e.children,r,a,l;t&&(e.attrs.container=t),le[i]||(U.warn('Can not find a node with class name "'+i+'". Fallback to "Shape".'),i="Shape");const o=le[i];if(r=new o(e.attrs),s)for(a=s.length,l=0;l<a;l++)r.add(se._createNode(s[l]));return r}}se.prototype.nodeType="Node";se.prototype._attrsAffectingSize=[];se.prototype.eventListeners={};se.prototype.on.call(se.prototype,cc,function(){if(this._batchingTransformChange){this._needClearTransformCache=!0;return}this._clearCache(yt),this._clearSelfAndDescendantCache(ht)});se.prototype.on.call(se.prototype,"visibleChange.konva",function(){this._clearSelfAndDescendantCache(xi)});se.prototype.on.call(se.prototype,"listeningChange.konva",function(){this._clearSelfAndDescendantCache(_i)});se.prototype.on.call(se.prototype,"opacityChange.konva",function(){this._clearSelfAndDescendantCache(On)});const Oe=T.addGetterSetter;Oe(se,"zIndex");Oe(se,"absolutePosition");Oe(se,"position");Oe(se,"x",0,re());Oe(se,"y",0,re());Oe(se,"globalCompositeOperation","source-over",Ot());Oe(se,"opacity",1,re());Oe(se,"name","",Ot());Oe(se,"id","",Ot());Oe(se,"rotation",0,re());T.addComponentsGetterSetter(se,"scale",["x","y"]);Oe(se,"scaleX",1,re());Oe(se,"scaleY",1,re());T.addComponentsGetterSetter(se,"skew",["x","y"]);Oe(se,"skewX",0,re());Oe(se,"skewY",0,re());T.addComponentsGetterSetter(se,"offset",["x","y"]);Oe(se,"offsetX",0,re());Oe(se,"offsetY",0,re());Oe(se,"dragDistance",void 0,re());Oe(se,"width",0,re());Oe(se,"height",0,re());Oe(se,"listening",!0,lt());Oe(se,"preventDefault",!0,lt());Oe(se,"filters",void 0,function(n){return this._filterUpToDate=!1,n});Oe(se,"visible",!0,lt());Oe(se,"transformsEnabled","all",Ot());Oe(se,"size");Oe(se,"dragBoundFunc");Oe(se,"draggable",!1,lt());T.backCompat(se,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"});class Ze extends se{constructor(){super(...arguments),this.children=[]}getChildren(e){const t=this.children||[];return e?t.filter(e):t}hasChildren(){return this.getChildren().length>0}removeChildren(){return this.getChildren().forEach(e=>{e.parent=null,e.index=0,e.remove()}),this.children=[],this._requestDraw(),this}destroyChildren(){return this.getChildren().forEach(e=>{e.parent=null,e.index=0,e.destroy()}),this.children=[],this._requestDraw(),this}add(...e){if(e.length===0)return this;if(e.length>1){for(let i=0;i<e.length;i++)this.add(e[i]);return this}const t=e[0];return t.getParent()?(t.moveTo(this),this):(this._validateAdd(t),t.index=this.getChildren().length,t.parent=this,t._clearCaches(),this.getChildren().push(t),this._fire("add",{child:t}),this._requestDraw(),this)}destroy(){return this.hasChildren()&&this.destroyChildren(),super.destroy(),this}find(e){return this._generalFind(e,!1)}findOne(e){const t=this._generalFind(e,!0);return t.length>0?t[0]:void 0}_generalFind(e,t){const i=[];return this._descendants(s=>{const r=s._isMatch(e);return r&&i.push(s),!!(r&&t)}),i}_descendants(e){let t=!1;const i=this.getChildren();for(const s of i){if(t=e(s),t)return!0;if(s.hasChildren()&&(t=s._descendants(e),t))return!0}return!1}toObject(){const e=se.prototype.toObject.call(this);return e.children=[],this.getChildren().forEach(t=>{e.children.push(t.toObject())}),e}isAncestorOf(e){let t=e.getParent();for(;t;){if(t._id===this._id)return!0;t=t.getParent()}return!1}clone(e){const t=se.prototype.clone.call(this,e);return this.getChildren().forEach(function(i){t.add(i.clone())}),t}getAllIntersections(e){const t=[];return this.find("Shape").forEach(i=>{i.isVisible()&&i.intersects(e)&&t.push(i)}),t}_clearSelfAndDescendantCache(e){var t;super._clearSelfAndDescendantCache(e),!this.isCached()&&((t=this.children)===null||t===void 0||t.forEach(function(i){i._clearSelfAndDescendantCache(e)}))}_setChildrenIndices(){var e;(e=this.children)===null||e===void 0||e.forEach(function(t,i){t.index=i}),this._requestDraw()}drawScene(e,t,i){const s=this.getLayer(),r=e||s&&s.getCanvas(),a=r&&r.getContext(),l=this._getCanvasCache(),o=l&&l.scene,c=r&&r.isCache;if(!this.isVisible()&&!c)return this;if(o){a.save();const d=this.getAbsoluteTransform(t).getMatrix();a.transform(d[0],d[1],d[2],d[3],d[4],d[5]),this._drawCachedSceneCanvas(a),a.restore()}else this._drawChildren("drawScene",r,t,i);return this}drawHit(e,t){if(!this.shouldDrawHit(t))return this;const i=this.getLayer(),s=e||i&&i.hitCanvas,r=s&&s.getContext(),a=this._getCanvasCache();if(a&&a.hit){r.save();const o=this.getAbsoluteTransform(t).getMatrix();r.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this._drawCachedHitCanvas(r),r.restore()}else this._drawChildren("drawHit",s,t);return this}_drawChildren(e,t,i,s){var r;const a=t&&t.getContext(),l=this.clipWidth(),o=this.clipHeight(),c=this.clipFunc(),d=typeof l=="number"&&typeof o=="number"||c,h=i===this;if(d){a.save();const v=this.getAbsoluteTransform(i);let u=v.getMatrix();a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),a.beginPath();let p;if(c)p=c.call(this,a,this);else{const m=this.clipX(),b=this.clipY();a.rect(m||0,b||0,l,o)}a.clip.apply(a,p),u=v.copy().invert().getMatrix(),a.transform(u[0],u[1],u[2],u[3],u[4],u[5])}const g=!h&&this.globalCompositeOperation()!=="source-over"&&e==="drawScene";g&&(a.save(),a._applyGlobalCompositeOperation(this)),(r=this.children)===null||r===void 0||r.forEach(function(v){v[e](t,i,s)}),g&&a.restore(),d&&a.restore()}getClientRect(e={}){var t;const i=e.skipTransform,s=e.relativeTo;let r,a,l,o,c={x:1/0,y:1/0,width:0,height:0};const d=this;(t=this.children)===null||t===void 0||t.forEach(function(v){if(!v.visible())return;const u=v.getClientRect({relativeTo:d,skipShadow:e.skipShadow,skipStroke:e.skipStroke});u.width===0&&u.height===0||(r===void 0?(r=u.x,a=u.y,l=u.x+u.width,o=u.y+u.height):(r=Math.min(r,u.x),a=Math.min(a,u.y),l=Math.max(l,u.x+u.width),o=Math.max(o,u.y+u.height)))});const h=this.find("Shape");let g=!1;for(let v=0;v<h.length;v++)if(h[v]._isVisible(this)){g=!0;break}return g&&r!==void 0?c={x:r,y:a,width:l-r,height:o-a}:c={x:0,y:0,width:0,height:0},i?c:this._transformedRect(c,s)}}T.addComponentsGetterSetter(Ze,"clip",["x","y","width","height"]);T.addGetterSetter(Ze,"clipX",void 0,re());T.addGetterSetter(Ze,"clipY",void 0,re());T.addGetterSetter(Ze,"clipWidth",void 0,re());T.addGetterSetter(Ze,"clipHeight",void 0,re());T.addGetterSetter(Ze,"clipFunc");const pn=new Map,lr=le._global.PointerEvent!==void 0;function li(n){return pn.get(n)}function Oi(n){return{evt:n,pointerId:n.pointerId}}function or(n,e){return pn.get(n)===e}function cr(n,e){cn(n),e.getStage()&&(pn.set(n,e),lr&&e._fire("gotpointercapture",Oi(new PointerEvent("gotpointercapture"))))}function cn(n,e){const t=pn.get(n);if(!t)return;const i=t.getStage();i&&i.content,pn.delete(n),lr&&t._fire("lostpointercapture",Oi(new PointerEvent("lostpointercapture")))}const hc="Stage",uc="string",ds="px",gc="mouseout",dr="mouseleave",hr="mouseover",ur="mouseenter",gr="mousemove",fr="mousedown",vr="mouseup",sn="pointermove",rn="pointerdown",Wt="pointerup",an="pointercancel",fc="lostpointercapture",kn="pointerout",ln="pointerleave",Tn="pointerover",En="pointerenter",Si="contextmenu",pr="touchstart",mr="touchend",br="touchmove",yr="touchcancel",wi="wheel",vc=5,pc=[[ur,"_pointerenter"],[fr,"_pointerdown"],[gr,"_pointermove"],[vr,"_pointerup"],[dr,"_pointerleave"],[pr,"_pointerdown"],[br,"_pointermove"],[mr,"_pointerup"],[yr,"_pointercancel"],[hr,"_pointerover"],[wi,"_wheel"],[Si,"_contextmenu"],[rn,"_pointerdown"],[sn,"_pointermove"],[Wt,"_pointerup"],[an,"_pointercancel"],[ln,"_pointerleave"],[fc,"_lostpointercapture"]],oi={mouse:{[kn]:gc,[ln]:dr,[Tn]:hr,[En]:ur,[sn]:gr,[rn]:fr,[Wt]:vr,[an]:"mousecancel",pointerclick:"click",pointerdblclick:"dblclick"},touch:{[kn]:"touchout",[ln]:"touchleave",[Tn]:"touchover",[En]:"touchenter",[sn]:br,[rn]:pr,[Wt]:mr,[an]:yr,pointerclick:"tap",pointerdblclick:"dbltap"},pointer:{[kn]:kn,[ln]:ln,[Tn]:Tn,[En]:En,[sn]:sn,[rn]:rn,[Wt]:Wt,[an]:an,pointerclick:"pointerclick",pointerdblclick:"pointerdblclick"}},on=n=>n.indexOf("pointer")>=0?"pointer":n.indexOf("touch")>=0?"touch":"mouse",Bt=n=>{const e=on(n);if(e==="pointer")return le.pointerEventsEnabled&&oi.pointer;if(e==="touch")return oi.touch;if(e==="mouse")return oi.mouse};function hs(n={}){return(n.clipFunc||n.clipWidth||n.clipHeight)&&U.warn("Stage does not support clipping. Please use clip for Layers or Groups."),n}const mc="Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);",dn=[];class Jn extends Ze{constructor(e){super(hs(e)),this._pointerPositions=[],this._changedPointerPositions=[],this._buildDOM(),this._bindContentEvents(),dn.push(this),this.on("widthChange.konva heightChange.konva",this._resizeDOM),this.on("visibleChange.konva",this._checkVisibility),this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",()=>{hs(this.attrs)}),this._checkVisibility()}_validateAdd(e){const t=e.getType()==="Layer",i=e.getType()==="FastLayer";t||i||U.throw("You may only add layers to the stage.")}_checkVisibility(){if(!this.content)return;const e=this.visible()?"":"none";this.content.style.display=e}setContainer(e){if(typeof e===uc){let t;if(e.charAt(0)==="."){const i=e.slice(1);e=document.getElementsByClassName(i)[0]}else e.charAt(0)!=="#"?t=e:t=e.slice(1),e=document.getElementById(t);if(!e)throw"Can not find container in document with id "+t}return this._setAttr("container",e),this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),e.appendChild(this.content)),this}shouldDrawHit(){return!0}clear(){const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].clear();return this}clone(e){return e||(e={}),e.container=typeof document<"u"&&document.createElement("div"),Ze.prototype.clone.call(this,e)}destroy(){super.destroy();const e=this.content;e&&U._isInDocument(e)&&this.container().removeChild(e);const t=dn.indexOf(this);return t>-1&&dn.splice(t,1),U.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas),this}getPointerPosition(){const e=this._pointerPositions[0]||this._changedPointerPositions[0];return e?{x:e.x,y:e.y}:(U.warn(mc),null)}_getPointerById(e){return this._pointerPositions.find(t=>t.id===e)}getPointersPositions(){return this._pointerPositions}getStage(){return this}getContent(){return this.content}_toKonvaCanvas(e){e={...e},e.x=e.x||0,e.y=e.y||0,e.width=e.width||this.width(),e.height=e.height||this.height();const t=new St({width:e.width,height:e.height,pixelRatio:e.pixelRatio||1}),i=t.getContext()._context,s=this.children;return(e.x||e.y)&&i.translate(-1*e.x,-1*e.y),s.forEach(function(r){if(!r.isVisible())return;const a=r._toKonvaCanvas(e);i.drawImage(a._canvas,e.x,e.y,a.getWidth()/a.getPixelRatio(),a.getHeight()/a.getPixelRatio())}),t}getIntersection(e){if(!e)return null;const t=this.children,i=t.length,s=i-1;for(let r=s;r>=0;r--){const a=t[r].getIntersection(e);if(a)return a}return null}_resizeDOM(){const e=this.width(),t=this.height();this.content&&(this.content.style.width=e+ds,this.content.style.height=t+ds),this.bufferCanvas.setSize(e,t),this.bufferHitCanvas.setSize(e,t),this.children.forEach(i=>{i.setSize({width:e,height:t}),i.draw()})}add(e,...t){if(arguments.length>1){for(let s=0;s<arguments.length;s++)this.add(arguments[s]);return this}super.add(e);const i=this.children.length;return i>vc&&U.warn("The stage has "+i+" layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group."),e.setSize({width:this.width(),height:this.height()}),e.draw(),le.isBrowser&&this.content.appendChild(e.canvas._canvas),this}getParent(){return null}getLayer(){return null}hasPointerCapture(e){return or(e,this)}setPointerCapture(e){cr(e,this)}releaseCapture(e){cn(e)}getLayers(){return this.children}_bindContentEvents(){le.isBrowser&&pc.forEach(([e,t])=>{this.content.addEventListener(e,i=>{this[t](i)},{passive:!1})})}_pointerenter(e){this.setPointersPositions(e);const t=Bt(e.type);t&&this._fire(t.pointerenter,{evt:e,target:this,currentTarget:this})}_pointerover(e){this.setPointersPositions(e);const t=Bt(e.type);t&&this._fire(t.pointerover,{evt:e,target:this,currentTarget:this})}_getTargetShape(e){let t=this[e+"targetShape"];return t&&!t.getStage()&&(t=null),t}_pointerleave(e){const t=Bt(e.type),i=on(e.type);if(!t)return;this.setPointersPositions(e);const s=this._getTargetShape(i),r=!(le.isDragging()||le.isTransforming())||le.hitOnDragEnabled;s&&r?(s._fireAndBubble(t.pointerout,{evt:e}),s._fireAndBubble(t.pointerleave,{evt:e}),this._fire(t.pointerleave,{evt:e,target:this,currentTarget:this}),this[i+"targetShape"]=null):r&&(this._fire(t.pointerleave,{evt:e,target:this,currentTarget:this}),this._fire(t.pointerout,{evt:e,target:this,currentTarget:this})),this.pointerPos=null,this._pointerPositions=[]}_pointerdown(e){const t=Bt(e.type),i=on(e.type);if(!t)return;this.setPointersPositions(e);let s=!1;this._changedPointerPositions.forEach(r=>{const a=this.getIntersection(r);if(Le.justDragged=!1,le["_"+i+"ListenClick"]=!0,!a||!a.isListening()){this[i+"ClickStartShape"]=void 0;return}le.capturePointerEventsEnabled&&a.setPointerCapture(r.id),this[i+"ClickStartShape"]=a,a._fireAndBubble(t.pointerdown,{evt:e,pointerId:r.id}),s=!0;const l=e.type.indexOf("touch")>=0;a.preventDefault()&&e.cancelable&&l&&e.preventDefault()}),s||this._fire(t.pointerdown,{evt:e,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id})}_pointermove(e){const t=Bt(e.type),i=on(e.type);if(!t)return;const s=e.type.indexOf("touch")>=0||e.pointerType==="touch";if(le.isDragging()&&Le.node.preventDefault()&&e.cancelable&&s&&e.preventDefault(),this.setPointersPositions(e),!(!(le.isDragging()||le.isTransforming())||le.hitOnDragEnabled))return;const a={};let l=!1;const o=this._getTargetShape(i);this._changedPointerPositions.forEach(c=>{const d=li(c.id)||this.getIntersection(c),h=c.id,g={evt:e,pointerId:h},v=o!==d;if(v&&o&&(o._fireAndBubble(t.pointerout,{...g},d),o._fireAndBubble(t.pointerleave,{...g},d)),d){if(a[d._id])return;a[d._id]=!0}d&&d.isListening()?(l=!0,v&&(d._fireAndBubble(t.pointerover,{...g},o),d._fireAndBubble(t.pointerenter,{...g},o),this[i+"targetShape"]=d),d._fireAndBubble(t.pointermove,{...g})):o&&(this._fire(t.pointerover,{evt:e,target:this,currentTarget:this,pointerId:h}),this[i+"targetShape"]=null)}),l||this._fire(t.pointermove,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id})}_pointerup(e){const t=Bt(e.type),i=on(e.type);if(!t)return;this.setPointersPositions(e);const s=this[i+"ClickStartShape"],r=this[i+"ClickEndShape"],a={};let l=!1;this._changedPointerPositions.forEach(o=>{const c=li(o.id)||this.getIntersection(o);if(c){if(c.releaseCapture(o.id),a[c._id])return;a[c._id]=!0}const d=o.id,h={evt:e,pointerId:d};let g=!1;le["_"+i+"InDblClickWindow"]?(g=!0,clearTimeout(this[i+"DblTimeout"])):Le.justDragged||(le["_"+i+"InDblClickWindow"]=!0,clearTimeout(this[i+"DblTimeout"])),this[i+"DblTimeout"]=setTimeout(function(){le["_"+i+"InDblClickWindow"]=!1},le.dblClickWindow),c&&c.isListening()?(l=!0,this[i+"ClickEndShape"]=c,c._fireAndBubble(t.pointerup,{...h}),le["_"+i+"ListenClick"]&&s&&s===c&&(c._fireAndBubble(t.pointerclick,{...h}),g&&r&&r===c&&c._fireAndBubble(t.pointerdblclick,{...h}))):(this[i+"ClickEndShape"]=null,l||(this._fire(t.pointerup,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),l=!0),le["_"+i+"ListenClick"]&&this._fire(t.pointerclick,{evt:e,target:this,currentTarget:this,pointerId:d}),g&&this._fire(t.pointerdblclick,{evt:e,target:this,currentTarget:this,pointerId:d}))}),l||this._fire(t.pointerup,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),le["_"+i+"ListenClick"]=!1,e.cancelable&&i!=="touch"&&i!=="pointer"&&e.preventDefault()}_contextmenu(e){this.setPointersPositions(e);const t=this.getIntersection(this.getPointerPosition());t&&t.isListening()?t._fireAndBubble(Si,{evt:e}):this._fire(Si,{evt:e,target:this,currentTarget:this})}_wheel(e){this.setPointersPositions(e);const t=this.getIntersection(this.getPointerPosition());t&&t.isListening()?t._fireAndBubble(wi,{evt:e}):this._fire(wi,{evt:e,target:this,currentTarget:this})}_pointercancel(e){this.setPointersPositions(e);const t=li(e.pointerId)||this.getIntersection(this.getPointerPosition());t&&t._fireAndBubble(Wt,Oi(e)),cn(e.pointerId)}_lostpointercapture(e){cn(e.pointerId)}setPointersPositions(e){const t=this._getContentPosition();let i=null,s=null;e=e||window.event,e.touches!==void 0?(this._pointerPositions=[],this._changedPointerPositions=[],Array.prototype.forEach.call(e.touches,r=>{this._pointerPositions.push({id:r.identifier,x:(r.clientX-t.left)/t.scaleX,y:(r.clientY-t.top)/t.scaleY})}),Array.prototype.forEach.call(e.changedTouches||e.touches,r=>{this._changedPointerPositions.push({id:r.identifier,x:(r.clientX-t.left)/t.scaleX,y:(r.clientY-t.top)/t.scaleY})})):(i=(e.clientX-t.left)/t.scaleX,s=(e.clientY-t.top)/t.scaleY,this.pointerPos={x:i,y:s},this._pointerPositions=[{x:i,y:s,id:U._getFirstPointerId(e)}],this._changedPointerPositions=[{x:i,y:s,id:U._getFirstPointerId(e)}])}_setPointerPosition(e){U.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.'),this.setPointersPositions(e)}_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect)return{top:0,left:0,scaleX:1,scaleY:1};const e=this.content.getBoundingClientRect();return{top:e.top,left:e.left,scaleX:e.width/this.content.clientWidth||1,scaleY:e.height/this.content.clientHeight||1}}_buildDOM(){if(this.bufferCanvas=new St({width:this.width(),height:this.height()}),this.bufferHitCanvas=new Mi({pixelRatio:1,width:this.width(),height:this.height()}),!le.isBrowser)return;const e=this.container();if(!e)throw"Stage has no container. A container is required.";e.innerHTML="",this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.userSelect="none",this.content.className="konvajs-content",this.content.setAttribute("role","presentation"),e.appendChild(this.content),this._resizeDOM()}cache(){return U.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes."),this}clearCache(){return this}batchDraw(){return this.getChildren().forEach(function(e){e.batchDraw()}),this}}Jn.prototype.nodeType=hc;Be(Jn);T.addGetterSetter(Jn,"container");le.isBrowser&&document.addEventListener("visibilitychange",()=>{dn.forEach(n=>{n.batchDraw()})});const _r="hasShadow",xr="shadowRGBA",Sr="patternImage",wr="linearGradient",$r="radialGradient";let Pn;function ci(){return Pn||(Pn=U.createCanvasElement().getContext("2d"),Pn)}const hn={};function bc(n){const e=this.attrs.fillRule;e?n.fill(e):n.fill()}function yc(n){n.stroke()}function _c(n){const e=this.attrs.fillRule;e?n.fill(e):n.fill()}function xc(n){n.stroke()}function Sc(){this._clearCache(_r)}function wc(){this._clearCache(xr)}function $c(){this._clearCache(Sr)}function Cc(){this._clearCache(wr)}function kc(){this._clearCache($r)}class Z extends se{constructor(e){super(e);let t;for(;t=U.getRandomColor(),!(t&&!(t in hn)););this.colorKey=t,hn[t]=this}getContext(){return U.warn("shape.getContext() method is deprecated. Please do not use it."),this.getLayer().getContext()}getCanvas(){return U.warn("shape.getCanvas() method is deprecated. Please do not use it."),this.getLayer().getCanvas()}getSceneFunc(){return this.attrs.sceneFunc||this._sceneFunc}getHitFunc(){return this.attrs.hitFunc||this._hitFunc}hasShadow(){return this._getCache(_r,this._hasShadow)}_hasShadow(){return this.shadowEnabled()&&this.shadowOpacity()!==0&&!!(this.shadowColor()||this.shadowBlur()||this.shadowOffsetX()||this.shadowOffsetY())}_getFillPattern(){return this._getCache(Sr,this.__getFillPattern)}__getFillPattern(){if(this.fillPatternImage()){const t=ci().createPattern(this.fillPatternImage(),this.fillPatternRepeat()||"repeat");if(t&&t.setTransform){const i=new Ke;i.translate(this.fillPatternX(),this.fillPatternY()),i.rotate(le.getAngle(this.fillPatternRotation())),i.scale(this.fillPatternScaleX(),this.fillPatternScaleY()),i.translate(-1*this.fillPatternOffsetX(),-1*this.fillPatternOffsetY());const s=i.getMatrix(),r=typeof DOMMatrix>"u"?{a:s[0],b:s[1],c:s[2],d:s[3],e:s[4],f:s[5]}:new DOMMatrix(s);t.setTransform(r)}return t}}_getLinearGradient(){return this._getCache(wr,this.__getLinearGradient)}__getLinearGradient(){const e=this.fillLinearGradientColorStops();if(e){const t=ci(),i=this.fillLinearGradientStartPoint(),s=this.fillLinearGradientEndPoint(),r=t.createLinearGradient(i.x,i.y,s.x,s.y);for(let a=0;a<e.length;a+=2)r.addColorStop(e[a],e[a+1]);return r}}_getRadialGradient(){return this._getCache($r,this.__getRadialGradient)}__getRadialGradient(){const e=this.fillRadialGradientColorStops();if(e){const t=ci(),i=this.fillRadialGradientStartPoint(),s=this.fillRadialGradientEndPoint(),r=t.createRadialGradient(i.x,i.y,this.fillRadialGradientStartRadius(),s.x,s.y,this.fillRadialGradientEndRadius());for(let a=0;a<e.length;a+=2)r.addColorStop(e[a],e[a+1]);return r}}getShadowRGBA(){return this._getCache(xr,this._getShadowRGBA)}_getShadowRGBA(){if(!this.hasShadow())return;const e=U.colorToRGBA(this.shadowColor());if(e)return"rgba("+e.r+","+e.g+","+e.b+","+e.a*(this.shadowOpacity()||1)+")"}hasFill(){return this._calculate("hasFill",["fillEnabled","fill","fillPatternImage","fillLinearGradientColorStops","fillRadialGradientColorStops"],()=>this.fillEnabled()&&!!(this.fill()||this.fillPatternImage()||this.fillLinearGradientColorStops()||this.fillRadialGradientColorStops()))}hasStroke(){return this._calculate("hasStroke",["strokeEnabled","strokeWidth","stroke","strokeLinearGradientColorStops"],()=>this.strokeEnabled()&&this.strokeWidth()&&!!(this.stroke()||this.strokeLinearGradientColorStops()))}hasHitStroke(){const e=this.hitStrokeWidth();return e==="auto"?this.hasStroke():this.strokeEnabled()&&!!e}intersects(e){const t=this.getStage();if(!t)return!1;const i=t.bufferHitCanvas;return i.getContext().clear(),this.drawHit(i,void 0,!0),i.context.getImageData(Math.round(e.x),Math.round(e.y),1,1).data[3]>0}destroy(){return se.prototype.destroy.call(this),delete hn[this.colorKey],delete this.colorKey,this}_useBufferCanvas(e){var t;if(!((t=this.attrs.perfectDrawEnabled)!==null&&t!==void 0?t:!0))return!1;const s=e||this.hasFill(),r=this.hasStroke(),a=this.getAbsoluteOpacity()!==1;if(s&&r&&a)return!0;const l=this.hasShadow(),o=this.shadowForStrokeEnabled();return!!(s&&r&&l&&o)}setStrokeHitEnabled(e){U.warn("strokeHitEnabled property is deprecated. Please use hitStrokeWidth instead."),e?this.hitStrokeWidth("auto"):this.hitStrokeWidth(0)}getStrokeHitEnabled(){return this.hitStrokeWidth()!==0}getSelfRect(){const e=this.size();return{x:this._centroid?-e.width/2:0,y:this._centroid?-e.height/2:0,width:e.width,height:e.height}}getClientRect(e={}){let t=!1,i=this.getParent();for(;i;){if(i.isCached()){t=!0;break}i=i.getParent()}const s=e.skipTransform,r=e.relativeTo||t&&this.getStage()||void 0,a=this.getSelfRect(),o=!e.skipStroke&&this.hasStroke()&&this.strokeWidth()||0,c=a.width+o,d=a.height+o,h=!e.skipShadow&&this.hasShadow(),g=h?this.shadowOffsetX():0,v=h?this.shadowOffsetY():0,u=c+Math.abs(g),p=d+Math.abs(v),m=h&&this.shadowBlur()||0,b=u+m*2,_=p+m*2,w={width:b,height:_,x:-(o/2+m)+Math.min(g,0)+a.x,y:-(o/2+m)+Math.min(v,0)+a.y};return s?w:this._transformedRect(w,r)}drawScene(e,t,i){const s=this.getLayer(),r=e||s.getCanvas(),a=r.getContext(),l=this._getCanvasCache(),o=this.getSceneFunc(),c=this.hasShadow();let d;const h=t===this;if(!this.isVisible()&&!h)return this;if(l){a.save();const g=this.getAbsoluteTransform(t).getMatrix();return a.transform(g[0],g[1],g[2],g[3],g[4],g[5]),this._drawCachedSceneCanvas(a),a.restore(),this}if(!o)return this;if(a.save(),this._useBufferCanvas()){d=this.getStage();const g=i||d.bufferCanvas,v=g.getContext();v.clear(),v.save(),v._applyLineJoin(this),v._applyMiterLimit(this);const u=this.getAbsoluteTransform(t).getMatrix();v.transform(u[0],u[1],u[2],u[3],u[4],u[5]),o.call(this,v,this),v.restore();const p=g.pixelRatio;c&&a._applyShadow(this),a._applyOpacity(this),a._applyGlobalCompositeOperation(this),a.drawImage(g._canvas,g.x||0,g.y||0,g.width/p,g.height/p)}else{if(a._applyLineJoin(this),a._applyMiterLimit(this),!h){const g=this.getAbsoluteTransform(t).getMatrix();a.transform(g[0],g[1],g[2],g[3],g[4],g[5]),a._applyOpacity(this),a._applyGlobalCompositeOperation(this)}c&&a._applyShadow(this),o.call(this,a,this)}return a.restore(),this}drawHit(e,t,i=!1){if(!this.shouldDrawHit(t,i))return this;const s=this.getLayer(),r=e||s.hitCanvas,a=r&&r.getContext(),l=this.hitFunc()||this.sceneFunc(),o=this._getCanvasCache(),c=o&&o.hit;if(this.colorKey||U.warn("Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()"),c){a.save();const h=this.getAbsoluteTransform(t).getMatrix();return a.transform(h[0],h[1],h[2],h[3],h[4],h[5]),this._drawCachedHitCanvas(a),a.restore(),this}if(!l)return this;if(a.save(),a._applyLineJoin(this),a._applyMiterLimit(this),!(this===t)){const h=this.getAbsoluteTransform(t).getMatrix();a.transform(h[0],h[1],h[2],h[3],h[4],h[5])}return l.call(this,a,this),a.restore(),this}drawHitFromCache(e=0){const t=this._getCanvasCache(),i=this._getCachedSceneCanvas(),s=t.hit,r=s.getContext(),a=s.getWidth(),l=s.getHeight();r.clear(),r.drawImage(i._canvas,0,0,a,l);try{const o=r.getImageData(0,0,a,l),c=o.data,d=c.length,h=U._hexToRgb(this.colorKey);for(let g=0;g<d;g+=4)c[g+3]>e?(c[g]=h.r,c[g+1]=h.g,c[g+2]=h.b,c[g+3]=255):c[g+3]=0;r.putImageData(o,0,0)}catch(o){U.error("Unable to draw hit graph from cached scene canvas. "+o.message)}return this}hasPointerCapture(e){return or(e,this)}setPointerCapture(e){cr(e,this)}releaseCapture(e){cn(e)}}Z.prototype._fillFunc=bc;Z.prototype._strokeFunc=yc;Z.prototype._fillFuncHit=_c;Z.prototype._strokeFuncHit=xc;Z.prototype._centroid=!1;Z.prototype.nodeType="Shape";Be(Z);Z.prototype.eventListeners={};Z.prototype.on.call(Z.prototype,"shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",Sc);Z.prototype.on.call(Z.prototype,"shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",wc);Z.prototype.on.call(Z.prototype,"fillPriorityChange.konva fillPatternImageChange.konva fillPatternRepeatChange.konva fillPatternScaleXChange.konva fillPatternScaleYChange.konva fillPatternOffsetXChange.konva fillPatternOffsetYChange.konva fillPatternXChange.konva fillPatternYChange.konva fillPatternRotationChange.konva",$c);Z.prototype.on.call(Z.prototype,"fillPriorityChange.konva fillLinearGradientColorStopsChange.konva fillLinearGradientStartPointXChange.konva fillLinearGradientStartPointYChange.konva fillLinearGradientEndPointXChange.konva fillLinearGradientEndPointYChange.konva",Cc);Z.prototype.on.call(Z.prototype,"fillPriorityChange.konva fillRadialGradientColorStopsChange.konva fillRadialGradientStartPointXChange.konva fillRadialGradientStartPointYChange.konva fillRadialGradientEndPointXChange.konva fillRadialGradientEndPointYChange.konva fillRadialGradientStartRadiusChange.konva fillRadialGradientEndRadiusChange.konva",kc);T.addGetterSetter(Z,"stroke",void 0,ar());T.addGetterSetter(Z,"strokeWidth",2,re());T.addGetterSetter(Z,"fillAfterStrokeEnabled",!1);T.addGetterSetter(Z,"hitStrokeWidth","auto",Di());T.addGetterSetter(Z,"strokeHitEnabled",!0,lt());T.addGetterSetter(Z,"perfectDrawEnabled",!0,lt());T.addGetterSetter(Z,"shadowForStrokeEnabled",!0,lt());T.addGetterSetter(Z,"lineJoin");T.addGetterSetter(Z,"lineCap");T.addGetterSetter(Z,"miterLimit");T.addGetterSetter(Z,"sceneFunc");T.addGetterSetter(Z,"hitFunc");T.addGetterSetter(Z,"dash");T.addGetterSetter(Z,"dashOffset",0,re());T.addGetterSetter(Z,"shadowColor",void 0,Ot());T.addGetterSetter(Z,"shadowBlur",0,re());T.addGetterSetter(Z,"shadowOpacity",1,re());T.addComponentsGetterSetter(Z,"shadowOffset",["x","y"]);T.addGetterSetter(Z,"shadowOffsetX",0,re());T.addGetterSetter(Z,"shadowOffsetY",0,re());T.addGetterSetter(Z,"fillPatternImage");T.addGetterSetter(Z,"fill",void 0,ar());T.addGetterSetter(Z,"fillPatternX",0,re());T.addGetterSetter(Z,"fillPatternY",0,re());T.addGetterSetter(Z,"fillLinearGradientColorStops");T.addGetterSetter(Z,"strokeLinearGradientColorStops");T.addGetterSetter(Z,"fillRadialGradientStartRadius",0);T.addGetterSetter(Z,"fillRadialGradientEndRadius",0);T.addGetterSetter(Z,"fillRadialGradientColorStops");T.addGetterSetter(Z,"fillPatternRepeat","repeat");T.addGetterSetter(Z,"fillEnabled",!0);T.addGetterSetter(Z,"strokeEnabled",!0);T.addGetterSetter(Z,"shadowEnabled",!0);T.addGetterSetter(Z,"dashEnabled",!0);T.addGetterSetter(Z,"strokeScaleEnabled",!0);T.addGetterSetter(Z,"fillPriority","color");T.addComponentsGetterSetter(Z,"fillPatternOffset",["x","y"]);T.addGetterSetter(Z,"fillPatternOffsetX",0,re());T.addGetterSetter(Z,"fillPatternOffsetY",0,re());T.addComponentsGetterSetter(Z,"fillPatternScale",["x","y"]);T.addGetterSetter(Z,"fillPatternScaleX",1,re());T.addGetterSetter(Z,"fillPatternScaleY",1,re());T.addComponentsGetterSetter(Z,"fillLinearGradientStartPoint",["x","y"]);T.addComponentsGetterSetter(Z,"strokeLinearGradientStartPoint",["x","y"]);T.addGetterSetter(Z,"fillLinearGradientStartPointX",0);T.addGetterSetter(Z,"strokeLinearGradientStartPointX",0);T.addGetterSetter(Z,"fillLinearGradientStartPointY",0);T.addGetterSetter(Z,"strokeLinearGradientStartPointY",0);T.addComponentsGetterSetter(Z,"fillLinearGradientEndPoint",["x","y"]);T.addComponentsGetterSetter(Z,"strokeLinearGradientEndPoint",["x","y"]);T.addGetterSetter(Z,"fillLinearGradientEndPointX",0);T.addGetterSetter(Z,"strokeLinearGradientEndPointX",0);T.addGetterSetter(Z,"fillLinearGradientEndPointY",0);T.addGetterSetter(Z,"strokeLinearGradientEndPointY",0);T.addComponentsGetterSetter(Z,"fillRadialGradientStartPoint",["x","y"]);T.addGetterSetter(Z,"fillRadialGradientStartPointX",0);T.addGetterSetter(Z,"fillRadialGradientStartPointY",0);T.addComponentsGetterSetter(Z,"fillRadialGradientEndPoint",["x","y"]);T.addGetterSetter(Z,"fillRadialGradientEndPointX",0);T.addGetterSetter(Z,"fillRadialGradientEndPointY",0);T.addGetterSetter(Z,"fillPatternRotation",0);T.addGetterSetter(Z,"fillRule",void 0,Ot());T.backCompat(Z,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"});const Tc="#",Ec="beforeDraw",Pc="draw",Cr=[{x:0,y:0},{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],Ac=Cr.length;class It extends Ze{constructor(e){super(e),this.canvas=new St,this.hitCanvas=new Mi({pixelRatio:1}),this._waitingForDraw=!1,this.on("visibleChange.konva",this._checkVisibility),this._checkVisibility(),this.on("imageSmoothingEnabledChange.konva",this._setSmoothEnabled),this._setSmoothEnabled()}createPNGStream(){return this.canvas._canvas.createPNGStream()}getCanvas(){return this.canvas}getNativeCanvasElement(){return this.canvas._canvas}getHitCanvas(){return this.hitCanvas}getContext(){return this.getCanvas().getContext()}clear(e){return this.getContext().clear(e),this.getHitCanvas().getContext().clear(e),this}setZIndex(e){super.setZIndex(e);const t=this.getStage();return t&&t.content&&(t.content.removeChild(this.getNativeCanvasElement()),e<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[e+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement())),this}moveToTop(){se.prototype.moveToTop.call(this);const e=this.getStage();return e&&e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.appendChild(this.getNativeCanvasElement())),!0}moveUp(){if(!se.prototype.moveUp.call(this))return!1;const t=this.getStage();return!t||!t.content?!1:(t.content.removeChild(this.getNativeCanvasElement()),this.index<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[this.index+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement()),!0)}moveDown(){if(se.prototype.moveDown.call(this)){const e=this.getStage();if(e){const t=e.children;e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.insertBefore(this.getNativeCanvasElement(),t[this.index+1].getCanvas()._canvas))}return!0}return!1}moveToBottom(){if(se.prototype.moveToBottom.call(this)){const e=this.getStage();if(e){const t=e.children;e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.insertBefore(this.getNativeCanvasElement(),t[1].getCanvas()._canvas))}return!0}return!1}getLayer(){return this}remove(){const e=this.getNativeCanvasElement();return se.prototype.remove.call(this),e&&e.parentNode&&U._isInDocument(e)&&e.parentNode.removeChild(e),this}getStage(){return this.parent}setSize({width:e,height:t}){return this.canvas.setSize(e,t),this.hitCanvas.setSize(e,t),this._setSmoothEnabled(),this}_validateAdd(e){const t=e.getType();t!=="Group"&&t!=="Shape"&&U.throw("You may only add groups and shapes to a layer.")}_toKonvaCanvas(e){return e={...e},e.width=e.width||this.getWidth(),e.height=e.height||this.getHeight(),e.x=e.x!==void 0?e.x:this.x(),e.y=e.y!==void 0?e.y:this.y(),se.prototype._toKonvaCanvas.call(this,e)}_checkVisibility(){this.visible()?this.canvas._canvas.style.display="block":this.canvas._canvas.style.display="none"}_setSmoothEnabled(){this.getContext()._context.imageSmoothingEnabled=this.imageSmoothingEnabled()}getWidth(){if(this.parent)return this.parent.width()}setWidth(){U.warn('Can not change width of layer. Use "stage.width(value)" function instead.')}getHeight(){if(this.parent)return this.parent.height()}setHeight(){U.warn('Can not change height of layer. Use "stage.height(value)" function instead.')}batchDraw(){return this._waitingForDraw||(this._waitingForDraw=!0,U.requestAnimFrame(()=>{this.draw(),this._waitingForDraw=!1})),this}getIntersection(e){if(!this.isListening()||!this.isVisible())return null;let t=1,i=!1;for(;;){for(let s=0;s<Ac;s++){const r=Cr[s],a=this._getIntersection({x:e.x+r.x*t,y:e.y+r.y*t}),l=a.shape;if(l)return l;if(i=!!a.antialiased,!a.antialiased)break}if(i)t+=1;else return null}}_getIntersection(e){const t=this.hitCanvas.pixelRatio,i=this.hitCanvas.context.getImageData(Math.round(e.x*t),Math.round(e.y*t),1,1).data,s=i[3];if(s===255){const r=U._rgbToHex(i[0],i[1],i[2]),a=hn[Tc+r];return a?{shape:a}:{antialiased:!0}}else if(s>0)return{antialiased:!0};return{}}drawScene(e,t,i){const s=this.getLayer(),r=e||s&&s.getCanvas();return this._fire(Ec,{node:this}),this.clearBeforeDraw()&&r.getContext().clear(),Ze.prototype.drawScene.call(this,r,t,i),this._fire(Pc,{node:this}),this}drawHit(e,t){const i=this.getLayer(),s=e||i&&i.hitCanvas;return i&&i.clearBeforeDraw()&&i.getHitCanvas().getContext().clear(),Ze.prototype.drawHit.call(this,s,t),this}enableHitGraph(){return this.hitGraphEnabled(!0),this}disableHitGraph(){return this.hitGraphEnabled(!1),this}setHitGraphEnabled(e){U.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening(e)}getHitGraphEnabled(e){return U.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening()}toggleHitCanvas(){if(!this.parent||!this.parent.content)return;const e=this.parent;!!this.hitCanvas._canvas.parentNode?e.content.removeChild(this.hitCanvas._canvas):e.content.appendChild(this.hitCanvas._canvas)}destroy(){return U.releaseCanvas(this.getNativeCanvasElement(),this.getHitCanvas()._canvas),super.destroy()}}It.prototype.nodeType="Layer";Be(It);T.addGetterSetter(It,"imageSmoothingEnabled",!0);T.addGetterSetter(It,"clearBeforeDraw",!0);T.addGetterSetter(It,"hitGraphEnabled",!0,lt());class Ii extends It{constructor(e){super(e),this.listening(!1),U.warn('Konva.Fast layer is deprecated. Please use "new Konva.Layer({ listening: false })" instead.')}}Ii.prototype.nodeType="FastLayer";Be(Ii);class Yt extends Ze{_validateAdd(e){const t=e.getType();t!=="Group"&&t!=="Shape"&&U.throw("You may only add groups and shapes to groups.")}}Yt.prototype.nodeType="Group";Be(Yt);const di=function(){return Lt.performance&&Lt.performance.now?function(){return Lt.performance.now()}:function(){return new Date().getTime()}}();class nt{constructor(e,t){this.id=nt.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:di(),frameRate:0},this.func=e,this.setLayers(t)}setLayers(e){let t=[];return e&&(t=Array.isArray(e)?e:[e]),this.layers=t,this}getLayers(){return this.layers}addLayer(e){const t=this.layers,i=t.length;for(let s=0;s<i;s++)if(t[s]._id===e._id)return!1;return this.layers.push(e),!0}isRunning(){const t=nt.animations,i=t.length;for(let s=0;s<i;s++)if(t[s].id===this.id)return!0;return!1}start(){return this.stop(),this.frame.timeDiff=0,this.frame.lastTime=di(),nt._addAnimation(this),this}stop(){return nt._removeAnimation(this),this}_updateFrameObject(e){this.frame.timeDiff=e-this.frame.lastTime,this.frame.lastTime=e,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}static _addAnimation(e){this.animations.push(e),this._handleAnimation()}static _removeAnimation(e){const t=e.id,i=this.animations,s=i.length;for(let r=0;r<s;r++)if(i[r].id===t){this.animations.splice(r,1);break}}static _runFrames(){const e={},t=this.animations;for(let i=0;i<t.length;i++){const s=t[i],r=s.layers,a=s.func;s._updateFrameObject(di());const l=r.length;let o;if(a?o=a.call(s,s.frame)!==!1:o=!0,!!o)for(let c=0;c<l;c++){const d=r[c];d._id!==void 0&&(e[d._id]=d)}}for(const i in e)e.hasOwnProperty(i)&&e[i].batchDraw()}static _animationLoop(){const e=nt;e.animations.length?(e._runFrames(),U.requestAnimFrame(e._animationLoop)):e.animRunning=!1}static _handleAnimation(){this.animRunning||(this.animRunning=!0,U.requestAnimFrame(this._animationLoop))}}nt.animations=[];nt.animIdCounter=0;nt.animRunning=!1;const Rc={node:1,duration:1,easing:1,onFinish:1,yoyo:1},Lc=1,us=2,gs=3,fs=["fill","stroke","shadowColor"];let Mc=0;class Dc{constructor(e,t,i,s,r,a,l){this.prop=e,this.propFunc=t,this.begin=s,this._pos=s,this.duration=a,this._change=0,this.prevPos=0,this.yoyo=l,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=i,this._change=r-this.begin,this.pause()}fire(e){const t=this[e];t&&t()}setTime(e){e>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():e<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=e,this.update())}getTime(){return this._time}setPosition(e){this.prevPos=this._pos,this.propFunc(e),this._pos=e}getPosition(e){return e===void 0&&(e=this._time),this.func(e,this.begin,this._change,this.duration)}play(){this.state=us,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")}reverse(){this.state=gs,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")}seek(e){this.pause(),this._time=e,this.update(),this.fire("onSeek")}reset(){this.pause(),this._time=0,this.update(),this.fire("onReset")}finish(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")}update(){this.setPosition(this.getPosition(this._time)),this.fire("onUpdate")}onEnterFrame(){const e=this.getTimer()-this._startTime;this.state===us?this.setTime(e):this.state===gs&&this.setTime(this.duration-e)}pause(){this.state=Lc,this.fire("onPause")}getTimer(){return new Date().getTime()}}class Ne{constructor(e){const t=this,i=e.node,s=i._id,r=e.easing||un.Linear,a=!!e.yoyo;let l,o;typeof e.duration>"u"?l=.3:e.duration===0?l=.001:l=e.duration,this.node=i,this._id=Mc++;const c=i.getLayer()||(i instanceof le.Stage?i.getLayers():null);c||U.error("Tween constructor have `node` that is not in a layer. Please add node into layer first."),this.anim=new nt(function(){t.tween.onEnterFrame()},c),this.tween=new Dc(o,function(d){t._tweenFunc(d)},r,0,1,l*1e3,a),this._addListeners(),Ne.attrs[s]||(Ne.attrs[s]={}),Ne.attrs[s][this._id]||(Ne.attrs[s][this._id]={}),Ne.tweens[s]||(Ne.tweens[s]={});for(o in e)Rc[o]===void 0&&this._addAttr(o,e[o]);this.reset(),this.onFinish=e.onFinish,this.onReset=e.onReset,this.onUpdate=e.onUpdate}_addAttr(e,t){const i=this.node,s=i._id;let r,a,l,o,c;const d=Ne.tweens[s][e];d&&delete Ne.attrs[s][d][e];let h=i.getAttr(e);if(U._isArray(t))if(r=[],a=Math.max(t.length,h.length),e==="points"&&t.length!==h.length&&(t.length>h.length?(o=h,h=U._prepareArrayForTween(h,t,i.closed())):(l=t,t=U._prepareArrayForTween(t,h,i.closed()))),e.indexOf("fill")===0)for(let g=0;g<a;g++)if(g%2===0)r.push(t[g]-h[g]);else{const v=U.colorToRGBA(h[g]);c=U.colorToRGBA(t[g]),h[g]=v,r.push({r:c.r-v.r,g:c.g-v.g,b:c.b-v.b,a:c.a-v.a})}else for(let g=0;g<a;g++)r.push(t[g]-h[g]);else fs.indexOf(e)!==-1?(h=U.colorToRGBA(h),c=U.colorToRGBA(t),r={r:c.r-h.r,g:c.g-h.g,b:c.b-h.b,a:c.a-h.a}):r=t-h;Ne.attrs[s][this._id][e]={start:h,diff:r,end:t,trueEnd:l,trueStart:o},Ne.tweens[s][e]=this._id}_tweenFunc(e){const t=this.node,i=Ne.attrs[t._id][this._id];let s,r,a,l,o,c,d,h;for(s in i){if(r=i[s],a=r.start,l=r.diff,h=r.end,U._isArray(a))if(o=[],d=Math.max(a.length,h.length),s.indexOf("fill")===0)for(c=0;c<d;c++)c%2===0?o.push((a[c]||0)+l[c]*e):o.push("rgba("+Math.round(a[c].r+l[c].r*e)+","+Math.round(a[c].g+l[c].g*e)+","+Math.round(a[c].b+l[c].b*e)+","+(a[c].a+l[c].a*e)+")");else for(c=0;c<d;c++)o.push((a[c]||0)+l[c]*e);else fs.indexOf(s)!==-1?o="rgba("+Math.round(a.r+l.r*e)+","+Math.round(a.g+l.g*e)+","+Math.round(a.b+l.b*e)+","+(a.a+l.a*e)+")":o=a+l*e;t.setAttr(s,o)}}_addListeners(){this.tween.onPlay=()=>{this.anim.start()},this.tween.onReverse=()=>{this.anim.start()},this.tween.onPause=()=>{this.anim.stop()},this.tween.onFinish=()=>{const e=this.node,t=Ne.attrs[e._id][this._id];t.points&&t.points.trueEnd&&e.setAttr("points",t.points.trueEnd),this.onFinish&&this.onFinish.call(this)},this.tween.onReset=()=>{const e=this.node,t=Ne.attrs[e._id][this._id];t.points&&t.points.trueStart&&e.points(t.points.trueStart),this.onReset&&this.onReset()},this.tween.onUpdate=()=>{this.onUpdate&&this.onUpdate.call(this)}}play(){return this.tween.play(),this}reverse(){return this.tween.reverse(),this}reset(){return this.tween.reset(),this}seek(e){return this.tween.seek(e*1e3),this}pause(){return this.tween.pause(),this}finish(){return this.tween.finish(),this}destroy(){const e=this.node._id,t=this._id,i=Ne.tweens[e];this.pause(),this.anim&&this.anim.stop();for(const s in i)delete Ne.tweens[e][s];delete Ne.attrs[e][t],Ne.tweens[e]&&(Object.keys(Ne.tweens[e]).length===0&&delete Ne.tweens[e],Object.keys(Ne.attrs[e]).length===0&&delete Ne.attrs[e])}}Ne.attrs={};Ne.tweens={};se.prototype.to=function(n){const e=n.onFinish;n.node=this,n.onFinish=function(){this.destroy(),e&&e()},new Ne(n).play()};const un={BackEaseIn(n,e,t,i){return t*(n/=i)*n*((1.70158+1)*n-1.70158)+e},BackEaseOut(n,e,t,i){return t*((n=n/i-1)*n*((1.70158+1)*n+1.70158)+1)+e},BackEaseInOut(n,e,t,i){let s=1.70158;return(n/=i/2)<1?t/2*(n*n*(((s*=1.525)+1)*n-s))+e:t/2*((n-=2)*n*(((s*=1.525)+1)*n+s)+2)+e},ElasticEaseIn(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i)===1?e+t:(r||(r=i*.3),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),-(s*Math.pow(2,10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r))+e)},ElasticEaseOut(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i)===1?e+t:(r||(r=i*.3),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),s*Math.pow(2,-10*n)*Math.sin((n*i-a)*(2*Math.PI)/r)+t+e)},ElasticEaseInOut(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i/2)===2?e+t:(r||(r=i*(.3*1.5)),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),n<1?-.5*(s*Math.pow(2,10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r))+e:s*Math.pow(2,-10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r)*.5+t+e)},BounceEaseOut(n,e,t,i){return(n/=i)<1/2.75?t*(7.5625*n*n)+e:n<2/2.75?t*(7.5625*(n-=1.5/2.75)*n+.75)+e:n<2.5/2.75?t*(7.5625*(n-=2.25/2.75)*n+.9375)+e:t*(7.5625*(n-=2.625/2.75)*n+.984375)+e},BounceEaseIn(n,e,t,i){return t-un.BounceEaseOut(i-n,0,t,i)+e},BounceEaseInOut(n,e,t,i){return n<i/2?un.BounceEaseIn(n*2,0,t,i)*.5+e:un.BounceEaseOut(n*2-i,0,t,i)*.5+t*.5+e},EaseIn(n,e,t,i){return t*(n/=i)*n+e},EaseOut(n,e,t,i){return-t*(n/=i)*(n-2)+e},EaseInOut(n,e,t,i){return(n/=i/2)<1?t/2*n*n+e:-t/2*(--n*(n-2)-1)+e},StrongEaseIn(n,e,t,i){return t*(n/=i)*n*n*n*n+e},StrongEaseOut(n,e,t,i){return t*((n=n/i-1)*n*n*n*n+1)+e},StrongEaseInOut(n,e,t,i){return(n/=i/2)<1?t/2*n*n*n*n*n+e:t/2*((n-=2)*n*n*n*n+2)+e},Linear(n,e,t,i){return t*n/i+e}},vs=U._assign(le,{Util:U,Transform:Ke,Node:se,Container:Ze,Stage:Jn,stages:dn,Layer:It,FastLayer:Ii,Group:Yt,DD:Le,Shape:Z,shapes:hn,Animation:nt,Tween:Ne,Easings:un,Context:Qn,Canvas:Li});class pt extends Z{_sceneFunc(e){const t=le.getAngle(this.angle()),i=this.clockwise();e.beginPath(),e.arc(0,0,this.outerRadius(),0,t,i),e.arc(0,0,this.innerRadius(),t,0,!i),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}getSelfRect(){const e=this.innerRadius(),t=this.outerRadius(),i=this.clockwise(),s=le.getAngle(i?360-this.angle():this.angle()),r=Math.cos(Math.min(s,Math.PI)),a=1,l=Math.sin(Math.min(Math.max(Math.PI,s),3*Math.PI/2)),o=Math.sin(Math.min(s,Math.PI/2)),c=r*(r>0?e:t),d=a*t,h=l*(l>0?e:t),g=o*(o>0?t:e);return{x:c,y:i?-1*g:h,width:d-c,height:g-h}}}pt.prototype._centroid=!0;pt.prototype.className="Arc";pt.prototype._attrsAffectingSize=["innerRadius","outerRadius","angle","clockwise"];Be(pt);T.addGetterSetter(pt,"innerRadius",0,re());T.addGetterSetter(pt,"outerRadius",0,re());T.addGetterSetter(pt,"angle",0,re());T.addGetterSetter(pt,"clockwise",!1,lt());function $i(n,e,t,i,s,r,a){const l=Math.sqrt(Math.pow(t-n,2)+Math.pow(i-e,2)),o=Math.sqrt(Math.pow(s-t,2)+Math.pow(r-i,2)),c=a*l/(l+o),d=a*o/(l+o),h=t-c*(s-n),g=i-c*(r-e),v=t+d*(s-n),u=i+d*(r-e);return[h,g,v,u]}function ps(n,e){const t=n.length,i=[];for(let s=2;s<t-2;s+=2){const r=$i(n[s-2],n[s-1],n[s],n[s+1],n[s+2],n[s+3],e);isNaN(r[0])||(i.push(r[0]),i.push(r[1]),i.push(n[s]),i.push(n[s+1]),i.push(r[2]),i.push(r[3]))}return i}class mt extends Z{constructor(e){super(e),this.on("pointsChange.konva tensionChange.konva closedChange.konva bezierChange.konva",function(){this._clearCache("tensionPoints")})}_sceneFunc(e){const t=this.points(),i=t.length,s=this.tension(),r=this.closed(),a=this.bezier();if(!i)return;let l=0;if(e.beginPath(),e.moveTo(t[0],t[1]),s!==0&&i>4){const o=this.getTensionPoints(),c=o.length;for(l=r?0:4,r||e.quadraticCurveTo(o[0],o[1],o[2],o[3]);l<c-2;)e.bezierCurveTo(o[l++],o[l++],o[l++],o[l++],o[l++],o[l++]);r||e.quadraticCurveTo(o[c-2],o[c-1],t[i-2],t[i-1])}else if(a)for(l=2;l<i;)e.bezierCurveTo(t[l++],t[l++],t[l++],t[l++],t[l++],t[l++]);else for(l=2;l<i;l+=2)e.lineTo(t[l],t[l+1]);r?(e.closePath(),e.fillStrokeShape(this)):e.strokeShape(this)}getTensionPoints(){return this._getCache("tensionPoints",this._getTensionPoints)}_getTensionPoints(){return this.closed()?this._getTensionPointsClosed():ps(this.points(),this.tension())}_getTensionPointsClosed(){const e=this.points(),t=e.length,i=this.tension(),s=$i(e[t-2],e[t-1],e[0],e[1],e[2],e[3],i),r=$i(e[t-4],e[t-3],e[t-2],e[t-1],e[0],e[1],i),a=ps(e,i);return[s[2],s[3]].concat(a).concat([r[0],r[1],e[t-2],e[t-1],r[2],r[3],s[0],s[1],e[0],e[1]])}getWidth(){return this.getSelfRect().width}getHeight(){return this.getSelfRect().height}getSelfRect(){let e=this.points();if(e.length<4)return{x:e[0]||0,y:e[1]||0,width:0,height:0};this.tension()!==0?e=[e[0],e[1],...this._getTensionPoints(),e[e.length-2],e[e.length-1]]:e=this.points();let t=e[0],i=e[0],s=e[1],r=e[1],a,l;for(let o=0;o<e.length/2;o++)a=e[o*2],l=e[o*2+1],t=Math.min(t,a),i=Math.max(i,a),s=Math.min(s,l),r=Math.max(r,l);return{x:t,y:s,width:i-t,height:r-s}}}mt.prototype.className="Line";mt.prototype._attrsAffectingSize=["points","bezier","tension"];Be(mt);T.addGetterSetter(mt,"closed",!1);T.addGetterSetter(mt,"bezier",!1);T.addGetterSetter(mt,"tension",0,re());T.addGetterSetter(mt,"points",[],Qo());const Oc=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],Ic=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],Nc=[[1],[1,1],[1,2,1],[1,3,3,1]],ms=(n,e,t)=>{let i,s;const a=t/2;i=0;for(let l=0;l<20;l++)s=a*Oc[20][l]+a,i+=Ic[20][l]*zc(n,e,s);return a*i},bs=(n,e,t)=>{t===void 0&&(t=1);const i=n[0]-2*n[1]+n[2],s=e[0]-2*e[1]+e[2],r=2*n[1]-2*n[0],a=2*e[1]-2*e[0],l=4*(i*i+s*s),o=4*(i*r+s*a),c=r*r+a*a;if(l===0)return t*Math.sqrt(Math.pow(n[2]-n[0],2)+Math.pow(e[2]-e[0],2));const d=o/(2*l),h=c/l,g=t+d,v=h-d*d,u=g*g+v>0?Math.sqrt(g*g+v):0,p=d*d+v>0?Math.sqrt(d*d+v):0,m=d+Math.sqrt(d*d+v)!==0?v*Math.log(Math.abs((g+u)/(d+p))):0;return Math.sqrt(l)/2*(g*u-d*p+m)};function zc(n,e,t){const i=Ci(1,t,n),s=Ci(1,t,e),r=i*i+s*s;return Math.sqrt(r)}const Ci=(n,e,t)=>{const i=t.length-1;let s,r;if(i===0)return 0;if(n===0){r=0;for(let a=0;a<=i;a++)r+=Nc[i][a]*Math.pow(1-e,i-a)*Math.pow(e,a)*t[a];return r}else{s=new Array(i);for(let a=0;a<i;a++)s[a]=i*(t[a+1]-t[a]);return Ci(n-1,e,s)}},ys=(n,e,t)=>{let i=1,s=n/e,r=(n-t(s))/e,a=0;for(;i>.001;){const l=t(s+r),o=Math.abs(n-l)/e;if(o<i)i=o,s+=r;else{const c=t(s-r),d=Math.abs(n-c)/e;d<i?(i=d,s-=r):r/=2}if(a++,a>500)break}return s};class ze extends Z{constructor(e){super(e),this.dataArray=[],this.pathLength=0,this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute()})}_readDataAttribute(){this.dataArray=ze.parsePathData(this.data()),this.pathLength=ze.getPathLength(this.dataArray)}_sceneFunc(e){const t=this.dataArray;e.beginPath();let i=!1;for(let s=0;s<t.length;s++){const r=t[s].command,a=t[s].points;switch(r){case"L":e.lineTo(a[0],a[1]);break;case"M":e.moveTo(a[0],a[1]);break;case"C":e.bezierCurveTo(a[0],a[1],a[2],a[3],a[4],a[5]);break;case"Q":e.quadraticCurveTo(a[0],a[1],a[2],a[3]);break;case"A":const l=a[0],o=a[1],c=a[2],d=a[3],h=a[4],g=a[5],v=a[6],u=a[7],p=c>d?c:d,m=c>d?1:c/d,b=c>d?d/c:1;e.translate(l,o),e.rotate(v),e.scale(m,b),e.arc(0,0,p,h,h+g,1-u),e.scale(1/m,1/b),e.rotate(-v),e.translate(-l,-o);break;case"z":i=!0,e.closePath();break}}!i&&!this.hasFill()?e.strokeShape(this):e.fillStrokeShape(this)}getSelfRect(){let e=[];this.dataArray.forEach(function(o){if(o.command==="A"){const c=o.points[4],d=o.points[5],h=o.points[4]+d;let g=Math.PI/180;if(Math.abs(c-h)<g&&(g=Math.abs(c-h)),d<0)for(let v=c-g;v>h;v-=g){const u=ze.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],v,0);e.push(u.x,u.y)}else for(let v=c+g;v<h;v+=g){const u=ze.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],v,0);e.push(u.x,u.y)}}else if(o.command==="C")for(let c=0;c<=1;c+=.01){const d=ze.getPointOnCubicBezier(c,o.start.x,o.start.y,o.points[0],o.points[1],o.points[2],o.points[3],o.points[4],o.points[5]);e.push(d.x,d.y)}else e=e.concat(o.points)});let t=e[0],i=e[0],s=e[1],r=e[1],a,l;for(let o=0;o<e.length/2;o++)a=e[o*2],l=e[o*2+1],isNaN(a)||(t=Math.min(t,a),i=Math.max(i,a)),isNaN(l)||(s=Math.min(s,l),r=Math.max(r,l));return{x:t,y:s,width:i-t,height:r-s}}getLength(){return this.pathLength}getPointAtLength(e){return ze.getPointAtLengthOfDataArray(e,this.dataArray)}static getLineLength(e,t,i,s){return Math.sqrt((i-e)*(i-e)+(s-t)*(s-t))}static getPathLength(e){let t=0;for(let i=0;i<e.length;++i)t+=e[i].pathLength;return t}static getPointAtLengthOfDataArray(e,t){let i,s=0,r=t.length;if(!r)return null;for(;s<r&&e>t[s].pathLength;)e-=t[s].pathLength,++s;if(s===r)return i=t[s-1].points.slice(-2),{x:i[0],y:i[1]};if(e<.01)return t[s].command==="M"?(i=t[s].points.slice(0,2),{x:i[0],y:i[1]}):{x:t[s].start.x,y:t[s].start.y};const a=t[s],l=a.points;switch(a.command){case"L":return ze.getPointOnLine(e,a.start.x,a.start.y,l[0],l[1]);case"C":return ze.getPointOnCubicBezier(ys(e,ze.getPathLength(t),p=>ms([a.start.x,l[0],l[2],l[4]],[a.start.y,l[1],l[3],l[5]],p)),a.start.x,a.start.y,l[0],l[1],l[2],l[3],l[4],l[5]);case"Q":return ze.getPointOnQuadraticBezier(ys(e,ze.getPathLength(t),p=>bs([a.start.x,l[0],l[2]],[a.start.y,l[1],l[3]],p)),a.start.x,a.start.y,l[0],l[1],l[2],l[3]);case"A":const o=l[0],c=l[1],d=l[2],h=l[3],g=l[5],v=l[6];let u=l[4];return u+=g*e/a.pathLength,ze.getPointOnEllipticalArc(o,c,d,h,u,v)}return null}static getPointOnLine(e,t,i,s,r,a,l){a=a??t,l=l??i;const o=this.getLineLength(t,i,s,r);if(o<1e-10)return{x:t,y:i};if(s===t)return{x:a,y:l+(r>i?e:-e)};const c=(r-i)/(s-t),d=Math.sqrt(e*e/(1+c*c))*(s<t?-1:1),h=c*d;if(Math.abs(l-i-c*(a-t))<1e-10)return{x:a+d,y:l+h};const g=((a-t)*(s-t)+(l-i)*(r-i))/(o*o),v=t+g*(s-t),u=i+g*(r-i),p=this.getLineLength(a,l,v,u),m=Math.sqrt(e*e-p*p),b=Math.sqrt(m*m/(1+c*c))*(s<t?-1:1),_=c*b;return{x:v+b,y:u+_}}static getPointOnCubicBezier(e,t,i,s,r,a,l,o,c){function d(m){return m*m*m}function h(m){return 3*m*m*(1-m)}function g(m){return 3*m*(1-m)*(1-m)}function v(m){return(1-m)*(1-m)*(1-m)}const u=o*d(e)+a*h(e)+s*g(e)+t*v(e),p=c*d(e)+l*h(e)+r*g(e)+i*v(e);return{x:u,y:p}}static getPointOnQuadraticBezier(e,t,i,s,r,a,l){function o(v){return v*v}function c(v){return 2*v*(1-v)}function d(v){return(1-v)*(1-v)}const h=a*o(e)+s*c(e)+t*d(e),g=l*o(e)+r*c(e)+i*d(e);return{x:h,y:g}}static getPointOnEllipticalArc(e,t,i,s,r,a){const l=Math.cos(a),o=Math.sin(a),c={x:i*Math.cos(r),y:s*Math.sin(r)};return{x:e+(c.x*l-c.y*o),y:t+(c.x*o+c.y*l)}}static parsePathData(e){if(!e)return[];let t=e;const i=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];t=t.replace(new RegExp(" ","g"),",");for(let h=0;h<i.length;h++)t=t.replace(new RegExp(i[h],"g"),"|"+i[h]);const s=t.split("|"),r=[],a=[];let l=0,o=0;const c=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;let d;for(let h=1;h<s.length;h++){let g=s[h],v=g.charAt(0);for(g=g.slice(1),a.length=0;d=c.exec(g);)a.push(d[0]);let u=[],p=v==="A"||v==="a"?0:-1;for(let m=0,b=a.length;m<b;m++){const _=a[m];if(_==="00"){u.push(0,0),p>=0&&(p+=2,p>=7&&(p-=7));continue}if(p>=0){if(p===3){if(/^[01]{2}\d+(?:\.\d+)?$/.test(_)){u.push(parseInt(_[0],10)),u.push(parseInt(_[1],10)),u.push(parseFloat(_.slice(2))),p+=3,p>=7&&(p-=7);continue}if(_==="11"||_==="10"||_==="01"){u.push(parseInt(_[0],10)),u.push(parseInt(_[1],10)),p+=2,p>=7&&(p-=7);continue}if(_==="0"||_==="1"){u.push(parseInt(_,10)),p+=1,p>=7&&(p-=7);continue}}else if(p===4){if(/^[01]\d+(?:\.\d+)?$/.test(_)){u.push(parseInt(_[0],10)),u.push(parseFloat(_.slice(1))),p+=2,p>=7&&(p-=7);continue}if(_==="0"||_==="1"){u.push(parseInt(_,10)),p+=1,p>=7&&(p-=7);continue}}const w=parseFloat(_);isNaN(w)?u.push(0):u.push(w),p+=1,p>=7&&(p-=7)}else{const w=parseFloat(_);isNaN(w)?u.push(0):u.push(w)}}for(;u.length>0&&!isNaN(u[0]);){let m="",b=[];const _=l,w=o;let S,C,A,M,D,z,E,R,k,q;switch(v){case"l":l+=u.shift(),o+=u.shift(),m="L",b.push(l,o);break;case"L":l=u.shift(),o=u.shift(),b.push(l,o);break;case"m":const N=u.shift(),$=u.shift();if(l+=N,o+=$,m="M",r.length>2&&r[r.length-1].command==="z"){for(let P=r.length-2;P>=0;P--)if(r[P].command==="M"){l=r[P].points[0]+N,o=r[P].points[1]+$;break}}b.push(l,o),v="l";break;case"M":l=u.shift(),o=u.shift(),m="M",b.push(l,o),v="L";break;case"h":l+=u.shift(),m="L",b.push(l,o);break;case"H":l=u.shift(),m="L",b.push(l,o);break;case"v":o+=u.shift(),m="L",b.push(l,o);break;case"V":o=u.shift(),m="L",b.push(l,o);break;case"C":b.push(u.shift(),u.shift(),u.shift(),u.shift()),l=u.shift(),o=u.shift(),b.push(l,o);break;case"c":b.push(l+u.shift(),o+u.shift(),l+u.shift(),o+u.shift()),l+=u.shift(),o+=u.shift(),m="C",b.push(l,o);break;case"S":C=l,A=o,S=r[r.length-1],S.command==="C"&&(C=l+(l-S.points[2]),A=o+(o-S.points[3])),b.push(C,A,u.shift(),u.shift()),l=u.shift(),o=u.shift(),m="C",b.push(l,o);break;case"s":C=l,A=o,S=r[r.length-1],S.command==="C"&&(C=l+(l-S.points[2]),A=o+(o-S.points[3])),b.push(C,A,l+u.shift(),o+u.shift()),l+=u.shift(),o+=u.shift(),m="C",b.push(l,o);break;case"Q":b.push(u.shift(),u.shift()),l=u.shift(),o=u.shift(),b.push(l,o);break;case"q":b.push(l+u.shift(),o+u.shift()),l+=u.shift(),o+=u.shift(),m="Q",b.push(l,o);break;case"T":C=l,A=o,S=r[r.length-1],S.command==="Q"&&(C=l+(l-S.points[0]),A=o+(o-S.points[1])),l=u.shift(),o=u.shift(),m="Q",b.push(C,A,l,o);break;case"t":C=l,A=o,S=r[r.length-1],S.command==="Q"&&(C=l+(l-S.points[0]),A=o+(o-S.points[1])),l+=u.shift(),o+=u.shift(),m="Q",b.push(C,A,l,o);break;case"A":M=u.shift(),D=u.shift(),z=u.shift(),E=u.shift(),R=u.shift(),k=l,q=o,l=u.shift(),o=u.shift(),m="A",b=this.convertEndpointToCenterParameterization(k,q,l,o,E,R,M,D,z);break;case"a":M=u.shift(),D=u.shift(),z=u.shift(),E=u.shift(),R=u.shift(),k=l,q=o,l+=u.shift(),o+=u.shift(),m="A",b=this.convertEndpointToCenterParameterization(k,q,l,o,E,R,M,D,z);break}r.push({command:m||v,points:b,start:{x:_,y:w},pathLength:this.calcLength(_,w,m||v,b)})}(v==="z"||v==="Z")&&r.push({command:"z",points:[],start:void 0,pathLength:0})}return r}static calcLength(e,t,i,s){let r,a,l,o;const c=ze;switch(i){case"L":return c.getLineLength(e,t,s[0],s[1]);case"C":return ms([e,s[0],s[2],s[4]],[t,s[1],s[3],s[5]],1);case"Q":return bs([e,s[0],s[2]],[t,s[1],s[3]],1);case"A":r=0;const d=s[4],h=s[5],g=s[4]+h;let v=Math.PI/180;if(Math.abs(d-g)<v&&(v=Math.abs(d-g)),a=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],d,0),h<0)for(o=d-v;o>g;o-=v)l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],o,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),a=l;else for(o=d+v;o<g;o+=v)l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],o,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),a=l;return l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],g,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),r}return 0}static convertEndpointToCenterParameterization(e,t,i,s,r,a,l,o,c){const d=c*(Math.PI/180),h=Math.cos(d)*(e-i)/2+Math.sin(d)*(t-s)/2,g=-1*Math.sin(d)*(e-i)/2+Math.cos(d)*(t-s)/2,v=h*h/(l*l)+g*g/(o*o);v>1&&(l*=Math.sqrt(v),o*=Math.sqrt(v));let u=Math.sqrt((l*l*(o*o)-l*l*(g*g)-o*o*(h*h))/(l*l*(g*g)+o*o*(h*h)));r===a&&(u*=-1),isNaN(u)&&(u=0);const p=u*l*g/o,m=u*-o*h/l,b=(e+i)/2+Math.cos(d)*p-Math.sin(d)*m,_=(t+s)/2+Math.sin(d)*p+Math.cos(d)*m,w=function(E){return Math.sqrt(E[0]*E[0]+E[1]*E[1])},S=function(E,R){return(E[0]*R[0]+E[1]*R[1])/(w(E)*w(R))},C=function(E,R){return(E[0]*R[1]<E[1]*R[0]?-1:1)*Math.acos(S(E,R))},A=C([1,0],[(h-p)/l,(g-m)/o]),M=[(h-p)/l,(g-m)/o],D=[(-1*h-p)/l,(-1*g-m)/o];let z=C(M,D);return S(M,D)<=-1&&(z=Math.PI),S(M,D)>=1&&(z=0),a===0&&z>0&&(z=z-2*Math.PI),a===1&&z<0&&(z=z+2*Math.PI),[b,_,l,o,A,z,d,a]}}ze.prototype.className="Path";ze.prototype._attrsAffectingSize=["data"];Be(ze);T.addGetterSetter(ze,"data");class Nt extends mt{_sceneFunc(e){super._sceneFunc(e);const t=Math.PI*2,i=this.points();let s=i;const r=this.tension()!==0&&i.length>4;r&&(s=this.getTensionPoints());const a=this.pointerLength(),l=i.length;let o,c;if(r){const g=[s[s.length-4],s[s.length-3],s[s.length-2],s[s.length-1],i[l-2],i[l-1]],v=ze.calcLength(s[s.length-4],s[s.length-3],"C",g),u=ze.getPointOnQuadraticBezier(Math.min(1,1-a/v),g[0],g[1],g[2],g[3],g[4],g[5]);o=i[l-2]-u.x,c=i[l-1]-u.y}else o=i[l-2]-i[l-4],c=i[l-1]-i[l-3];const d=(Math.atan2(c,o)+t)%t,h=this.pointerWidth();this.pointerAtEnding()&&(e.save(),e.beginPath(),e.translate(i[l-2],i[l-1]),e.rotate(d),e.moveTo(0,0),e.lineTo(-a,h/2),e.lineTo(-a,-h/2),e.closePath(),e.restore(),this.__fillStroke(e)),this.pointerAtBeginning()&&(e.save(),e.beginPath(),e.translate(i[0],i[1]),r?(o=(s[0]+s[2])/2-i[0],c=(s[1]+s[3])/2-i[1]):(o=i[2]-i[0],c=i[3]-i[1]),e.rotate((Math.atan2(-c,-o)+t)%t),e.moveTo(0,0),e.lineTo(-a,h/2),e.lineTo(-a,-h/2),e.closePath(),e.restore(),this.__fillStroke(e))}__fillStroke(e){const t=this.dashEnabled();t&&(this.attrs.dashEnabled=!1,e.setLineDash([])),e.fillStrokeShape(this),t&&(this.attrs.dashEnabled=!0)}getSelfRect(){const e=super.getSelfRect(),t=this.pointerWidth()/2;return{x:e.x,y:e.y-t,width:e.width,height:e.height+t*2}}}Nt.prototype.className="Arrow";Be(Nt);T.addGetterSetter(Nt,"pointerLength",10,re());T.addGetterSetter(Nt,"pointerWidth",10,re());T.addGetterSetter(Nt,"pointerAtBeginning",!1);T.addGetterSetter(Nt,"pointerAtEnding",!0);class Xt extends Z{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.attrs.radius||0,0,Math.PI*2,!1),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius()!==e/2&&this.radius(e/2)}setHeight(e){this.radius()!==e/2&&this.radius(e/2)}}Xt.prototype._centroid=!0;Xt.prototype.className="Circle";Xt.prototype._attrsAffectingSize=["radius"];Be(Xt);T.addGetterSetter(Xt,"radius",0,re());class kt extends Z{_sceneFunc(e){const t=this.radiusX(),i=this.radiusY();e.beginPath(),e.save(),t!==i&&e.scale(1,i/t),e.arc(0,0,t,0,Math.PI*2,!1),e.restore(),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radiusX()*2}getHeight(){return this.radiusY()*2}setWidth(e){this.radiusX(e/2)}setHeight(e){this.radiusY(e/2)}}kt.prototype.className="Ellipse";kt.prototype._centroid=!0;kt.prototype._attrsAffectingSize=["radiusX","radiusY"];Be(kt);T.addComponentsGetterSetter(kt,"radius",["x","y"]);T.addGetterSetter(kt,"radiusX",0,re());T.addGetterSetter(kt,"radiusY",0,re());class st extends Z{constructor(e){super(e),this._loadListener=()=>{this._requestDraw()},this.on("imageChange.konva",t=>{this._removeImageLoad(t.oldVal),this._setImageLoad()}),this._setImageLoad()}_setImageLoad(){const e=this.image();e&&e.complete||e&&e.readyState===4||e&&e.addEventListener&&e.addEventListener("load",this._loadListener)}_removeImageLoad(e){e&&e.removeEventListener&&e.removeEventListener("load",this._loadListener)}destroy(){return this._removeImageLoad(this.image()),super.destroy(),this}_useBufferCanvas(){const e=!!this.cornerRadius(),t=this.hasShadow();return e&&t?!0:super._useBufferCanvas(!0)}_sceneFunc(e){const t=this.getWidth(),i=this.getHeight(),s=this.cornerRadius(),r=this.attrs.image;let a;if(r){const l=this.attrs.cropWidth,o=this.attrs.cropHeight;l&&o?a=[r,this.cropX(),this.cropY(),l,o,0,0,t,i]:a=[r,0,0,t,i]}(this.hasFill()||this.hasStroke()||s)&&(e.beginPath(),s?U.drawRoundedRectPath(e,t,i,s):e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)),r&&(s&&e.clip(),e.drawImage.apply(e,a))}_hitFunc(e){const t=this.width(),i=this.height(),s=this.cornerRadius();e.beginPath(),s?U.drawRoundedRectPath(e,t,i,s):e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)}getWidth(){var e,t;return(e=this.attrs.width)!==null&&e!==void 0?e:(t=this.image())===null||t===void 0?void 0:t.width}getHeight(){var e,t;return(e=this.attrs.height)!==null&&e!==void 0?e:(t=this.image())===null||t===void 0?void 0:t.height}static fromURL(e,t,i=null){const s=U.createImageElement();s.onload=function(){const r=new st({image:s});t(r)},s.onerror=i,s.crossOrigin="Anonymous",s.src=e}}st.prototype.className="Image";Be(st);T.addGetterSetter(st,"cornerRadius",0,Kn(4));T.addGetterSetter(st,"image");T.addComponentsGetterSetter(st,"crop",["x","y","width","height"]);T.addGetterSetter(st,"cropX",0,re());T.addGetterSetter(st,"cropY",0,re());T.addGetterSetter(st,"cropWidth",0,re());T.addGetterSetter(st,"cropHeight",0,re());const kr=["fontFamily","fontSize","fontStyle","padding","lineHeight","text","width","height","pointerDirection","pointerWidth","pointerHeight"],Fc="Change.konva",Gc="none",ki="up",Ti="right",Ei="down",Pi="left",Bc=kr.length;class Ni extends Yt{constructor(e){super(e),this.on("add.konva",function(t){this._addListeners(t.child),this._sync()})}getText(){return this.find("Text")[0]}getTag(){return this.find("Tag")[0]}_addListeners(e){let t=this,i;const s=function(){t._sync()};for(i=0;i<Bc;i++)e.on(kr[i]+Fc,s)}getWidth(){return this.getText().width()}getHeight(){return this.getText().height()}_sync(){let e=this.getText(),t=this.getTag(),i,s,r,a,l,o,c;if(e&&t){switch(i=e.width(),s=e.height(),r=t.pointerDirection(),a=t.pointerWidth(),c=t.pointerHeight(),l=0,o=0,r){case ki:l=i/2,o=-1*c;break;case Ti:l=i+a,o=s/2;break;case Ei:l=i/2,o=s+c;break;case Pi:l=-1*a,o=s/2;break}t.setAttrs({x:-1*l,y:-1*o,width:i,height:s}),e.setAttrs({x:-1*l,y:-1*o})}}}Ni.prototype.className="Label";Be(Ni);class zt extends Z{_sceneFunc(e){const t=this.width(),i=this.height(),s=this.pointerDirection(),r=this.pointerWidth(),a=this.pointerHeight(),l=this.cornerRadius();let o=0,c=0,d=0,h=0;typeof l=="number"?o=c=d=h=Math.min(l,t/2,i/2):(o=Math.min(l[0]||0,t/2,i/2),c=Math.min(l[1]||0,t/2,i/2),h=Math.min(l[2]||0,t/2,i/2),d=Math.min(l[3]||0,t/2,i/2)),e.beginPath(),e.moveTo(o,0),s===ki&&(e.lineTo((t-r)/2,0),e.lineTo(t/2,-1*a),e.lineTo((t+r)/2,0)),e.lineTo(t-c,0),e.arc(t-c,c,c,Math.PI*3/2,0,!1),s===Ti&&(e.lineTo(t,(i-a)/2),e.lineTo(t+r,i/2),e.lineTo(t,(i+a)/2)),e.lineTo(t,i-h),e.arc(t-h,i-h,h,0,Math.PI/2,!1),s===Ei&&(e.lineTo((t+r)/2,i),e.lineTo(t/2,i+a),e.lineTo((t-r)/2,i)),e.lineTo(d,i),e.arc(d,i-d,d,Math.PI/2,Math.PI,!1),s===Pi&&(e.lineTo(0,(i+a)/2),e.lineTo(-1*r,i/2),e.lineTo(0,(i-a)/2)),e.lineTo(0,o),e.arc(o,o,o,Math.PI,Math.PI*3/2,!1),e.closePath(),e.fillStrokeShape(this)}getSelfRect(){let e=0,t=0,i=this.pointerWidth(),s=this.pointerHeight(),r=this.pointerDirection(),a=this.width(),l=this.height();return r===ki?(t-=s,l+=s):r===Ei?l+=s:r===Pi?(e-=i*1.5,a+=i):r===Ti&&(a+=i*1.5),{x:e,y:t,width:a,height:l}}}zt.prototype.className="Tag";Be(zt);T.addGetterSetter(zt,"pointerDirection",Gc);T.addGetterSetter(zt,"pointerWidth",0,re());T.addGetterSetter(zt,"pointerHeight",0,re());T.addGetterSetter(zt,"cornerRadius",0,Kn(4));class yn extends Z{_sceneFunc(e){const t=this.cornerRadius(),i=this.width(),s=this.height();e.beginPath(),t?U.drawRoundedRectPath(e,i,s,t):e.rect(0,0,i,s),e.closePath(),e.fillStrokeShape(this)}}yn.prototype.className="Rect";Be(yn);T.addGetterSetter(yn,"cornerRadius",0,Kn(4));class Tt extends Z{_sceneFunc(e){const t=this._getPoints(),i=this.radius(),s=this.sides(),r=this.cornerRadius();if(e.beginPath(),r)U.drawRoundedPolygonPath(e,t,s,i,r);else{e.moveTo(t[0].x,t[0].y);for(let a=1;a<t.length;a++)e.lineTo(t[a].x,t[a].y)}e.closePath(),e.fillStrokeShape(this)}_getPoints(){const e=this.attrs.sides,t=this.attrs.radius||0,i=[];for(let s=0;s<e;s++)i.push({x:t*Math.sin(s*2*Math.PI/e),y:-1*t*Math.cos(s*2*Math.PI/e)});return i}getSelfRect(){const e=this._getPoints();let t=e[0].x,i=e[0].y,s=e[0].x,r=e[0].y;return e.forEach(a=>{t=Math.min(t,a.x),i=Math.max(i,a.x),s=Math.min(s,a.y),r=Math.max(r,a.y)}),{x:t,y:s,width:i-t,height:r-s}}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius(e/2)}setHeight(e){this.radius(e/2)}}Tt.prototype.className="RegularPolygon";Tt.prototype._centroid=!0;Tt.prototype._attrsAffectingSize=["radius"];Be(Tt);T.addGetterSetter(Tt,"radius",0,re());T.addGetterSetter(Tt,"sides",0,re());T.addGetterSetter(Tt,"cornerRadius",0,Kn(4));const _s=Math.PI*2;class Ft extends Z{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.innerRadius(),0,_s,!1),e.moveTo(this.outerRadius(),0),e.arc(0,0,this.outerRadius(),_s,0,!0),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}}Ft.prototype.className="Ring";Ft.prototype._centroid=!0;Ft.prototype._attrsAffectingSize=["innerRadius","outerRadius"];Be(Ft);T.addGetterSetter(Ft,"innerRadius",0,re());T.addGetterSetter(Ft,"outerRadius",0,re());class dt extends Z{constructor(e){super(e),this._updated=!0,this.anim=new nt(()=>{const t=this._updated;return this._updated=!1,t}),this.on("animationChange.konva",function(){this.frameIndex(0)}),this.on("frameIndexChange.konva",function(){this._updated=!0}),this.on("frameRateChange.konva",function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())})}_sceneFunc(e){const t=this.animation(),i=this.frameIndex(),s=i*4,r=this.animations()[t],a=this.frameOffsets(),l=r[s+0],o=r[s+1],c=r[s+2],d=r[s+3],h=this.image();if((this.hasFill()||this.hasStroke())&&(e.beginPath(),e.rect(0,0,c,d),e.closePath(),e.fillStrokeShape(this)),h)if(a){const g=a[t],v=i*2;e.drawImage(h,l,o,c,d,g[v+0],g[v+1],c,d)}else e.drawImage(h,l,o,c,d,0,0,c,d)}_hitFunc(e){const t=this.animation(),i=this.frameIndex(),s=i*4,r=this.animations()[t],a=this.frameOffsets(),l=r[s+2],o=r[s+3];if(e.beginPath(),a){const c=a[t],d=i*2;e.rect(c[d+0],c[d+1],l,o)}else e.rect(0,0,l,o);e.closePath(),e.fillShape(this)}_useBufferCanvas(){return super._useBufferCanvas(!0)}_setInterval(){const e=this;this.interval=setInterval(function(){e._updateIndex()},1e3/this.frameRate())}start(){if(this.isRunning())return;const e=this.getLayer();this.anim.setLayers(e),this._setInterval(),this.anim.start()}stop(){this.anim.stop(),clearInterval(this.interval)}isRunning(){return this.anim.isRunning()}_updateIndex(){const e=this.frameIndex(),t=this.animation(),i=this.animations(),s=i[t],r=s.length/4;e<r-1?this.frameIndex(e+1):this.frameIndex(0)}}dt.prototype.className="Sprite";Be(dt);T.addGetterSetter(dt,"animation");T.addGetterSetter(dt,"animations");T.addGetterSetter(dt,"frameOffsets");T.addGetterSetter(dt,"image");T.addGetterSetter(dt,"frameIndex",0,re());T.addGetterSetter(dt,"frameRate",17,re());T.backCompat(dt,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"});class Et extends Z{_sceneFunc(e){const t=this.innerRadius(),i=this.outerRadius(),s=this.numPoints();e.beginPath(),e.moveTo(0,0-i);for(let r=1;r<s*2;r++){const a=r%2===0?i:t,l=a*Math.sin(r*Math.PI/s),o=-1*a*Math.cos(r*Math.PI/s);e.lineTo(l,o)}e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}}Et.prototype.className="Star";Et.prototype._centroid=!0;Et.prototype._attrsAffectingSize=["innerRadius","outerRadius"];Be(Et);T.addGetterSetter(Et,"numPoints",5,re());T.addGetterSetter(Et,"innerRadius",0,re());T.addGetterSetter(Et,"outerRadius",0,re());function _t(n){return[...n].reduce((e,t,i,s)=>{if(new RegExp("\\p{Emoji}","u").test(t)){const r=s[i+1];r&&new RegExp("\\p{Emoji_Modifier}|\\u200D","u").test(r)?(e.push(t+r),s[i+1]=""):e.push(t)}else new RegExp("\\p{Regional_Indicator}{2}","u").test(t+(s[i+1]||""))?e.push(t+s[i+1]):i>0&&new RegExp("\\p{Mn}|\\p{Me}|\\p{Mc}","u").test(t)?e[e.length-1]+=t:t&&e.push(t);return e},[])}const Ut="auto",Uc="center",Tr="inherit",Ht="justify",Hc="Change.konva",qc="2d",xs="-",Er="left",Wc="text",jc="Text",Yc="top",Vc="bottom",Ss="middle",Pr="normal",Xc="px ",An=" ",Qc="right",ws="rtl",Kc="word",Jc="char",$s="none",hi="…",Ar=["direction","fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],Zc=Ar.length;function ed(n){return n.split(",").map(e=>{e=e.trim();const t=e.indexOf(" ")>=0,i=e.indexOf('"')>=0||e.indexOf("'")>=0;return t&&!i&&(e=`"${e}"`),e}).join(", ")}let Rn;function ui(){return Rn||(Rn=U.createCanvasElement().getContext(qc),Rn)}function td(n){n.fillText(this._partialText,this._partialTextX,this._partialTextY)}function nd(n){n.setAttr("miterLimit",2),n.strokeText(this._partialText,this._partialTextX,this._partialTextY)}function id(n){return n=n||{},!n.fillLinearGradientColorStops&&!n.fillRadialGradientColorStops&&!n.fillPatternImage&&(n.fill=n.fill||"black"),n}class Fe extends Z{constructor(e){super(id(e)),this._partialTextX=0,this._partialTextY=0;for(let t=0;t<Zc;t++)this.on(Ar[t]+Hc,this._setTextData);this._setTextData()}_sceneFunc(e){var t,i;const s=this.textArr,r=s.length;if(!this.text())return;let a=this.padding(),l=this.fontSize(),o=this.lineHeight()*l,c=this.verticalAlign(),d=this.direction(),h=0,g=this.align(),v=this.getWidth(),u=this.letterSpacing(),p=this.charRenderFunc(),m=this.fill(),b=this.textDecoration(),_=b.indexOf("underline")!==-1,w=b.indexOf("line-through")!==-1,S;d=d===Tr?e.direction:d;let C=o/2,A=Ss;if(!le.legacyTextRendering){const M=this.measureSize("M");A="alphabetic";const D=(t=M.fontBoundingBoxAscent)!==null&&t!==void 0?t:M.actualBoundingBoxAscent,z=(i=M.fontBoundingBoxDescent)!==null&&i!==void 0?i:M.actualBoundingBoxDescent;C=(D-z)/2+o/2}for(d===ws&&e.setAttr("direction",d),e.setAttr("font",this._getContextFont()),e.setAttr("textBaseline",A),e.setAttr("textAlign",Er),c===Ss?h=(this.getHeight()-r*o-a*2)/2:c===Vc&&(h=this.getHeight()-r*o-a*2),e.translate(a,h+a),S=0;S<r;S++){let M=0,D=0;const z=s[S],E=z.text,R=z.width,k=z.lastInParagraph;if(e.save(),g===Qc?M+=v-R-a*2:g===Uc&&(M+=(v-R-a*2)/2),_){e.save(),e.beginPath();const q=le.legacyTextRendering?Math.round(l/2):Math.round(l/4),N=M,$=C+D+q;e.moveTo(N,$);const P=g===Ht&&!k?v-a*2:R;e.lineTo(N+Math.round(P),$),e.lineWidth=l/15;const X=this._getLinearGradient();e.strokeStyle=X||m,e.stroke(),e.restore()}if(d!==ws&&(u!==0||g===Ht||p)){const q=E.split(" ").length-1,N=_t(E);for(let $=0;$<N.length;$++){const P=N[$];if(P===" "&&!k&&g===Ht&&(M+=(v-a*2-R)/q),this._partialTextX=M,this._partialTextY=C+D,this._partialText=P,p){e.save();const F=s.slice(0,S).reduce((V,B)=>V+_t(B.text).length,0),O=$+F;p({char:P,index:O,x:M,y:C+D,lineIndex:S,column:$,isLastInLine:k,width:this.measureSize(P).width,context:e})}e.fillStrokeShape(this),p&&e.restore(),M+=this.measureSize(P).width+u}}else u!==0&&e.setAttr("letterSpacing",`${u}px`),this._partialTextX=M,this._partialTextY=C+D,this._partialText=E,e.fillStrokeShape(this);if(w){e.save(),e.beginPath();const q=le.legacyTextRendering?0:-Math.round(l/4),N=g===Ht?0:M;e.moveTo(N,C+D+q);const $=g===Ht&&!k?v-a*2:R;e.lineTo(N+Math.round($),C+D+q),e.lineWidth=l/15;const P=this._getLinearGradient();e.strokeStyle=P||m,e.stroke(),e.restore()}e.restore(),r>1&&(C+=o)}}_hitFunc(e){const t=this.getWidth(),i=this.getHeight();e.beginPath(),e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)}setText(e){const t=U._isString(e)?e:e==null?"":e+"";return this._setAttr(Wc,t),this}getWidth(){return this.attrs.width===Ut||this.attrs.width===void 0?this.getTextWidth()+this.padding()*2:this.attrs.width}getHeight(){return this.attrs.height===Ut||this.attrs.height===void 0?this.fontSize()*this.textArr.length*this.lineHeight()+this.padding()*2:this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return U.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(e){var t,i,s,r,a,l,o,c,d,h,g;let v=ui(),u=this.fontSize(),p;v.save(),v.font=this._getContextFont(),p=v.measureText(e),v.restore();const m=u/100;return{actualBoundingBoxAscent:(t=p.actualBoundingBoxAscent)!==null&&t!==void 0?t:71.58203125*m,actualBoundingBoxDescent:(i=p.actualBoundingBoxDescent)!==null&&i!==void 0?i:0,actualBoundingBoxLeft:(s=p.actualBoundingBoxLeft)!==null&&s!==void 0?s:-7.421875*m,actualBoundingBoxRight:(r=p.actualBoundingBoxRight)!==null&&r!==void 0?r:75.732421875*m,alphabeticBaseline:(a=p.alphabeticBaseline)!==null&&a!==void 0?a:0,emHeightAscent:(l=p.emHeightAscent)!==null&&l!==void 0?l:100*m,emHeightDescent:(o=p.emHeightDescent)!==null&&o!==void 0?o:-20*m,fontBoundingBoxAscent:(c=p.fontBoundingBoxAscent)!==null&&c!==void 0?c:91*m,fontBoundingBoxDescent:(d=p.fontBoundingBoxDescent)!==null&&d!==void 0?d:21*m,hangingBaseline:(h=p.hangingBaseline)!==null&&h!==void 0?h:72.80000305175781*m,ideographicBaseline:(g=p.ideographicBaseline)!==null&&g!==void 0?g:-21*m,width:p.width,height:u}}_getContextFont(){return this.fontStyle()+An+this.fontVariant()+An+(this.fontSize()+Xc)+ed(this.fontFamily())}_addTextLine(e){this.align()===Ht&&(e=e.trim());const i=this._getTextWidth(e);return this.textArr.push({text:e,width:i,lastInParagraph:!1})}_getTextWidth(e){const t=this.letterSpacing(),i=e.length;return ui().measureText(e).width+t*i}_setTextData(){let e=this.text().split(`
`),t=+this.fontSize(),i=0,s=this.lineHeight()*t,r=this.attrs.width,a=this.attrs.height,l=r!==Ut&&r!==void 0,o=a!==Ut&&a!==void 0,c=this.padding(),d=r-c*2,h=a-c*2,g=0,v=this.wrap(),u=v!==$s,p=v!==Jc&&u,m=this.ellipsis();this.textArr=[],ui().font=this._getContextFont();const b=m?this._getTextWidth(hi):0;for(let _=0,w=e.length;_<w;++_){let S=e[_],C=this._getTextWidth(S);if(l&&C>d)for(;S.length>0;){let A=0,M=_t(S).length,D="",z=0;for(;A<M;){const E=A+M>>>1,R=_t(S),k=R.slice(0,E+1).join(""),q=this._getTextWidth(k);(m&&o&&g+s>h?q+b:q)<=d?(A=E+1,D=k,z=q):M=E}if(D){if(p){const k=_t(S),q=_t(D),N=k[q.length],$=N===An||N===xs;let P;if($&&z<=d)P=q.length;else{const X=q.lastIndexOf(An),F=q.lastIndexOf(xs);P=Math.max(X,F)+1}P>0&&(A=P,D=k.slice(0,A).join(""),z=this._getTextWidth(D))}if(D=D.trimRight(),this._addTextLine(D),i=Math.max(i,z),g+=s,this._shouldHandleEllipsis(g)){this._tryToAddEllipsisToLastLine();break}if(S=_t(S).slice(A).join("").trimLeft(),S.length>0&&(C=this._getTextWidth(S),C<=d)){this._addTextLine(S),g+=s,i=Math.max(i,C);break}}else break}else this._addTextLine(S),g+=s,i=Math.max(i,C),this._shouldHandleEllipsis(g)&&_<w-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),o&&g+s>h)break}this.textHeight=t,this.textWidth=i}_shouldHandleEllipsis(e){const t=+this.fontSize(),i=this.lineHeight()*t,s=this.attrs.height,r=s!==Ut&&s!==void 0,a=this.padding(),l=s-a*2;return!(this.wrap()!==$s)||r&&e+i>l}_tryToAddEllipsisToLastLine(){const e=this.attrs.width,t=e!==Ut&&e!==void 0,i=this.padding(),s=e-i*2,r=this.ellipsis(),a=this.textArr[this.textArr.length-1];!a||!r||(t&&(this._getTextWidth(a.text+hi)<s||(a.text=a.text.slice(0,a.text.length-3))),this.textArr.splice(this.textArr.length-1,1),this._addTextLine(a.text+hi))}getStrokeScaleEnabled(){return!0}_useBufferCanvas(){const e=this.textDecoration().indexOf("underline")!==-1||this.textDecoration().indexOf("line-through")!==-1,t=this.hasShadow();return e&&t?!0:super._useBufferCanvas()}}Fe.prototype._fillFunc=td;Fe.prototype._strokeFunc=nd;Fe.prototype.className=jc;Fe.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"];Be(Fe);T.overWriteSetter(Fe,"width",Di());T.overWriteSetter(Fe,"height",Di());T.addGetterSetter(Fe,"direction",Tr);T.addGetterSetter(Fe,"fontFamily","Arial");T.addGetterSetter(Fe,"fontSize",12,re());T.addGetterSetter(Fe,"fontStyle",Pr);T.addGetterSetter(Fe,"fontVariant",Pr);T.addGetterSetter(Fe,"padding",0,re());T.addGetterSetter(Fe,"align",Er);T.addGetterSetter(Fe,"verticalAlign",Yc);T.addGetterSetter(Fe,"lineHeight",1,re());T.addGetterSetter(Fe,"wrap",Kc);T.addGetterSetter(Fe,"ellipsis",!1,lt());T.addGetterSetter(Fe,"letterSpacing",0,re());T.addGetterSetter(Fe,"text","",Ot());T.addGetterSetter(Fe,"textDecoration","");T.addGetterSetter(Fe,"charRenderFunc",void 0);const sd="",Rr="normal";function Lr(n){n.fillText(this.partialText,0,0)}function Mr(n){n.strokeText(this.partialText,0,0)}class qe extends Z{constructor(e){super(e),this.dummyCanvas=U.createCanvasElement(),this.dataArray=[],this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute(),this._setTextData()}),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_getTextPathLength(){return ze.getPathLength(this.dataArray)}_getPointAtLength(e){if(!this.attrs.data)return null;const t=this.pathLength;return e>t?null:ze.getPointAtLengthOfDataArray(e,this.dataArray)}_readDataAttribute(){this.dataArray=ze.parsePathData(this.attrs.data),this.pathLength=this._getTextPathLength()}_sceneFunc(e){e.setAttr("font",this._getContextFont()),e.setAttr("textBaseline",this.textBaseline()),e.setAttr("textAlign","left"),e.save();const t=this.textDecoration(),i=this.fill(),s=this.fontSize(),r=this.glyphInfo;t==="underline"&&e.beginPath();for(let a=0;a<r.length;a++){e.save();const l=r[a].p0;e.translate(l.x,l.y),e.rotate(r[a].rotation),this.partialText=r[a].text,e.fillStrokeShape(this),t==="underline"&&(a===0&&e.moveTo(0,s/2+1),e.lineTo(s,s/2+1)),e.restore()}t==="underline"&&(e.strokeStyle=i,e.lineWidth=s/20,e.stroke()),e.restore()}_hitFunc(e){e.beginPath();const t=this.glyphInfo;if(t.length>=1){const i=t[0].p0;e.moveTo(i.x,i.y)}for(let i=0;i<t.length;i++){const s=t[i].p1;e.lineTo(s.x,s.y)}e.setAttr("lineWidth",this.fontSize()),e.setAttr("strokeStyle",this.colorKey),e.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return U.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(e){return Fe.prototype.setText.call(this,e)}_getContextFont(){return Fe.prototype._getContextFont.call(this)}_getTextSize(e){const i=this.dummyCanvas.getContext("2d");i.save(),i.font=this._getContextFont();const s=i.measureText(e);return i.restore(),{width:s.width,height:parseInt(`${this.fontSize()}`,10)}}_setTextData(){const e=_t(this.text()),t=[];let i=0;for(let h=0;h<e.length;h++)t.push({char:e[h],width:this._getTextSize(e[h]).width}),i+=t[h].width;const{height:s}=this._getTextSize(this.attrs.text);if(this.textWidth=i,this.textHeight=s,this.glyphInfo=[],!this.attrs.data)return null;const r=this.letterSpacing(),a=this.align(),l=this.kerningFunc(),o=Math.max(this.textWidth+((this.attrs.text||"").length-1)*r,0);let c=0;a==="center"&&(c=Math.max(0,this.pathLength/2-o/2)),a==="right"&&(c=Math.max(0,this.pathLength-o));let d=c;for(let h=0;h<t.length;h++){const g=this._getPointAtLength(d);if(!g)return;const v=t[h].char;let u=t[h].width+r;if(v===" "&&a==="justify"){const S=this.text().split(" ").length-1;u+=(this.pathLength-o)/S}const p=this._getPointAtLength(d+u);if(!p)return;const m=ze.getLineLength(g.x,g.y,p.x,p.y);let b=0;if(l)try{b=l(t[h-1].char,v)*this.fontSize()}catch{b=0}g.x+=b,p.x+=b,this.textWidth+=b;const _=ze.getPointOnLine(b+m/2,g.x,g.y,p.x,p.y),w=Math.atan2(p.y-g.y,p.x-g.x);this.glyphInfo.push({transposeX:_.x,transposeY:_.y,text:e[h],rotation:w,p0:g,p1:p}),d+=u}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};const e=[];this.glyphInfo.forEach(function(c){e.push(c.p0.x),e.push(c.p0.y),e.push(c.p1.x),e.push(c.p1.y)});let t=e[0]||0,i=e[0]||0,s=e[1]||0,r=e[1]||0,a,l;for(let c=0;c<e.length/2;c++)a=e[c*2],l=e[c*2+1],t=Math.min(t,a),i=Math.max(i,a),s=Math.min(s,l),r=Math.max(r,l);const o=this.fontSize();return{x:t-o/2,y:s-o/2,width:i-t+o,height:r-s+o}}destroy(){return U.releaseCanvas(this.dummyCanvas),super.destroy()}}qe.prototype._fillFunc=Lr;qe.prototype._strokeFunc=Mr;qe.prototype._fillFuncHit=Lr;qe.prototype._strokeFuncHit=Mr;qe.prototype.className="TextPath";qe.prototype._attrsAffectingSize=["text","fontSize","data"];Be(qe);T.addGetterSetter(qe,"data");T.addGetterSetter(qe,"fontFamily","Arial");T.addGetterSetter(qe,"fontSize",12,re());T.addGetterSetter(qe,"fontStyle",Rr);T.addGetterSetter(qe,"align","left");T.addGetterSetter(qe,"letterSpacing",0,re());T.addGetterSetter(qe,"textBaseline","middle");T.addGetterSetter(qe,"fontVariant",Rr);T.addGetterSetter(qe,"text",sd);T.addGetterSetter(qe,"textDecoration","");T.addGetterSetter(qe,"kerningFunc",void 0);const Dr="tr-konva",rd=["resizeEnabledChange","rotateAnchorOffsetChange","rotateEnabledChange","enabledAnchorsChange","anchorSizeChange","borderEnabledChange","borderStrokeChange","borderStrokeWidthChange","borderDashChange","anchorStrokeChange","anchorStrokeWidthChange","anchorFillChange","anchorCornerRadiusChange","ignoreStrokeChange","anchorStyleFuncChange"].map(n=>n+`.${Dr}`).join(" "),Cs="nodesRect",ad=["widthChange","heightChange","scaleXChange","scaleYChange","skewXChange","skewYChange","rotationChange","offsetXChange","offsetYChange","transformsEnabledChange","strokeWidthChange","draggableChange"],ld={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135},od="ontouchstart"in le._global;function cd(n,e,t){if(n==="rotater")return t;e+=U.degToRad(ld[n]||0);const i=(U.radToDeg(e)%360+360)%360;return U._inRange(i,315+22.5,360)||U._inRange(i,0,22.5)?"ns-resize":U._inRange(i,45-22.5,45+22.5)?"nesw-resize":U._inRange(i,90-22.5,90+22.5)?"ew-resize":U._inRange(i,135-22.5,135+22.5)?"nwse-resize":U._inRange(i,180-22.5,180+22.5)?"ns-resize":U._inRange(i,225-22.5,225+22.5)?"nesw-resize":U._inRange(i,270-22.5,270+22.5)?"ew-resize":U._inRange(i,315-22.5,315+22.5)?"nwse-resize":(U.error("Transformer has unknown angle for cursor detection: "+i),"pointer")}const jn=["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"];function dd(n){return{x:n.x+n.width/2*Math.cos(n.rotation)+n.height/2*Math.sin(-n.rotation),y:n.y+n.height/2*Math.cos(n.rotation)+n.width/2*Math.sin(n.rotation)}}function Or(n,e,t){const i=t.x+(n.x-t.x)*Math.cos(e)-(n.y-t.y)*Math.sin(e),s=t.y+(n.x-t.x)*Math.sin(e)+(n.y-t.y)*Math.cos(e);return{...n,rotation:n.rotation+e,x:i,y:s}}function hd(n,e){const t=dd(n);return Or(n,e,t)}function ud(n,e,t){let i=e;for(let s=0;s<n.length;s++){const r=le.getAngle(n[s]),a=Math.abs(r-e)%(Math.PI*2);Math.min(a,Math.PI*2-a)<t&&(i=r)}return i}let Ai=0;class Ee extends Yt{constructor(e){super(e),this._movingAnchorName=null,this._transforming=!1,this._createElements(),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.update=this.update.bind(this),this.on(rd,this.update),this.getNode()&&this.update()}attachTo(e){return this.setNode(e),this}setNode(e){return U.warn("tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead."),this.setNodes([e])}getNode(){return this._nodes&&this._nodes[0]}_getEventNamespace(){return Dr+this._id}setNodes(e=[]){this._nodes&&this._nodes.length&&this.detach();const t=e.filter(s=>s.isAncestorOf(this)?(U.error("Konva.Transformer cannot be an a child of the node you are trying to attach"),!1):!0);return this._nodes=e=t,e.length===1&&this.useSingleNodeRotation()?this.rotation(e[0].getAbsoluteRotation()):this.rotation(0),this._nodes.forEach(s=>{const r=()=>{this.nodes().length===1&&this.useSingleNodeRotation()&&this.rotation(this.nodes()[0].getAbsoluteRotation()),this._resetTransformCache(),!this._transforming&&!this.isDragging()&&this.update()};if(s._attrsAffectingSize.length){const a=s._attrsAffectingSize.map(l=>l+"Change."+this._getEventNamespace()).join(" ");s.on(a,r)}s.on(ad.map(a=>a+`.${this._getEventNamespace()}`).join(" "),r),s.on(`absoluteTransformChange.${this._getEventNamespace()}`,r),this._proxyDrag(s)}),this._resetTransformCache(),!!this.findOne(".top-left")&&this.update(),this}_proxyDrag(e){let t;e.on(`dragstart.${this._getEventNamespace()}`,i=>{t=e.getAbsolutePosition(),!this.isDragging()&&e!==this.findOne(".back")&&this.startDrag(i,!1)}),e.on(`dragmove.${this._getEventNamespace()}`,i=>{if(!t)return;const s=e.getAbsolutePosition(),r=s.x-t.x,a=s.y-t.y;this.nodes().forEach(l=>{if(l===e||l.isDragging())return;const o=l.getAbsolutePosition();l.setAbsolutePosition({x:o.x+r,y:o.y+a}),l.startDrag(i)}),t=null})}getNodes(){return this._nodes||[]}getActiveAnchor(){return this._movingAnchorName}detach(){this._nodes&&this._nodes.forEach(e=>{e.off("."+this._getEventNamespace())}),this._nodes=[],this._resetTransformCache()}_resetTransformCache(){this._clearCache(Cs),this._clearCache("transform"),this._clearSelfAndDescendantCache("absoluteTransform")}_getNodeRect(){return this._getCache(Cs,this.__getNodeRect)}__getNodeShape(e,t=this.rotation(),i){const s=e.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),r=e.getAbsoluteScale(i),a=e.getAbsolutePosition(i),l=s.x*r.x-e.offsetX()*r.x,o=s.y*r.y-e.offsetY()*r.y,c=(le.getAngle(e.getAbsoluteRotation())+Math.PI*2)%(Math.PI*2),d={x:a.x+l*Math.cos(c)+o*Math.sin(-c),y:a.y+o*Math.cos(c)+l*Math.sin(c),width:s.width*r.x,height:s.height*r.y,rotation:c};return Or(d,-le.getAngle(t),{x:0,y:0})}__getNodeRect(){if(!this.getNode())return{x:-1e8,y:-1e8,width:0,height:0,rotation:0};const t=[];this.nodes().map(c=>{const d=c.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),h=[{x:d.x,y:d.y},{x:d.x+d.width,y:d.y},{x:d.x+d.width,y:d.y+d.height},{x:d.x,y:d.y+d.height}],g=c.getAbsoluteTransform();h.forEach(function(v){const u=g.point(v);t.push(u)})});const i=new Ke;i.rotate(-le.getAngle(this.rotation()));let s=1/0,r=1/0,a=-1/0,l=-1/0;t.forEach(function(c){const d=i.point(c);s===void 0&&(s=a=d.x,r=l=d.y),s=Math.min(s,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y)}),i.invert();const o=i.point({x:s,y:r});return{x:o.x,y:o.y,width:a-s,height:l-r,rotation:le.getAngle(this.rotation())}}getX(){return this._getNodeRect().x}getY(){return this._getNodeRect().y}getWidth(){return this._getNodeRect().width}getHeight(){return this._getNodeRect().height}_createElements(){this._createBack(),jn.forEach(e=>{this._createAnchor(e)}),this._createAnchor("rotater")}_createAnchor(e){const t=new yn({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:e+" _anchor",dragDistance:0,draggable:!0,hitStrokeWidth:od?10:"auto"}),i=this;t.on("mousedown touchstart",function(s){i._handleMouseDown(s)}),t.on("dragstart",s=>{t.stopDrag(),s.cancelBubble=!0}),t.on("dragend",s=>{s.cancelBubble=!0}),t.on("mouseenter",()=>{const s=le.getAngle(this.rotation()),r=this.rotateAnchorCursor(),a=cd(e,s,r);t.getStage().content&&(t.getStage().content.style.cursor=a),this._cursorChange=!0}),t.on("mouseout",()=>{t.getStage().content&&(t.getStage().content.style.cursor=""),this._cursorChange=!1}),this.add(t)}_createBack(){const e=new Z({name:"back",width:0,height:0,sceneFunc(t,i){const s=i.getParent(),r=s.padding();t.beginPath(),t.rect(-r,-r,i.width()+r*2,i.height()+r*2),t.moveTo(i.width()/2,-r),s.rotateEnabled()&&s.rotateLineVisible()&&t.lineTo(i.width()/2,-s.rotateAnchorOffset()*U._sign(i.height())-r),t.fillStrokeShape(i)},hitFunc:(t,i)=>{if(!this.shouldOverdrawWholeArea())return;const s=this.padding();t.beginPath(),t.rect(-s,-s,i.width()+s*2,i.height()+s*2),t.fillStrokeShape(i)}});this.add(e),this._proxyDrag(e),e.on("dragstart",t=>{t.cancelBubble=!0}),e.on("dragmove",t=>{t.cancelBubble=!0}),e.on("dragend",t=>{t.cancelBubble=!0}),this.on("dragmove",t=>{this.update()})}_handleMouseDown(e){if(this._transforming)return;this._movingAnchorName=e.target.name().split(" ")[0];const t=this._getNodeRect(),i=t.width,s=t.height,r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2));this.sin=Math.abs(s/r),this.cos=Math.abs(i/r),typeof window<"u"&&(window.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("touchmove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp,!0),window.addEventListener("touchend",this._handleMouseUp,!0)),this._transforming=!0;const a=e.target.getAbsolutePosition(),l=e.target.getStage().getPointerPosition();this._anchorDragOffset={x:l.x-a.x,y:l.y-a.y},Ai++,this._fire("transformstart",{evt:e.evt,target:this.getNode()}),this._nodes.forEach(o=>{o._fire("transformstart",{evt:e.evt,target:o})})}_handleMouseMove(e){let t,i,s;const r=this.findOne("."+this._movingAnchorName),a=r.getStage();a.setPointersPositions(e);const l=a.getPointerPosition();let o={x:l.x-this._anchorDragOffset.x,y:l.y-this._anchorDragOffset.y};const c=r.getAbsolutePosition();this.anchorDragBoundFunc()&&(o=this.anchorDragBoundFunc()(c,o,e)),r.setAbsolutePosition(o);const d=r.getAbsolutePosition();if(c.x===d.x&&c.y===d.y)return;if(this._movingAnchorName==="rotater"){const _=this._getNodeRect();t=r.x()-_.width/2,i=-r.y()+_.height/2;let w=Math.atan2(-i,t)+Math.PI/2;_.height<0&&(w-=Math.PI);const C=le.getAngle(this.rotation())+w,A=le.getAngle(this.rotationSnapTolerance()),D=ud(this.rotationSnaps(),C,A)-_.rotation,z=hd(_,D);this._fitNodesInto(z,e);return}const h=this.shiftBehavior();let g;h==="inverted"?g=this.keepRatio()&&!e.shiftKey:h==="none"?g=this.keepRatio():g=this.keepRatio()||e.shiftKey;let v=this.centeredScaling()||e.altKey;if(this._movingAnchorName==="top-left"){if(g){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()};s=Math.sqrt(Math.pow(_.x-r.x(),2)+Math.pow(_.y-r.y(),2));const w=this.findOne(".top-left").x()>_.x?-1:1,S=this.findOne(".top-left").y()>_.y?-1:1;t=s*this.cos*w,i=s*this.sin*S,this.findOne(".top-left").x(_.x-t),this.findOne(".top-left").y(_.y-i)}}else if(this._movingAnchorName==="top-center")this.findOne(".top-left").y(r.y());else if(this._movingAnchorName==="top-right"){if(g){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()};s=Math.sqrt(Math.pow(r.x()-_.x,2)+Math.pow(_.y-r.y(),2));const w=this.findOne(".top-right").x()<_.x?-1:1,S=this.findOne(".top-right").y()>_.y?-1:1;t=s*this.cos*w,i=s*this.sin*S,this.findOne(".top-right").x(_.x+t),this.findOne(".top-right").y(_.y-i)}var u=r.position();this.findOne(".top-left").y(u.y),this.findOne(".bottom-right").x(u.x)}else if(this._movingAnchorName==="middle-left")this.findOne(".top-left").x(r.x());else if(this._movingAnchorName==="middle-right")this.findOne(".bottom-right").x(r.x());else if(this._movingAnchorName==="bottom-left"){if(g){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()};s=Math.sqrt(Math.pow(_.x-r.x(),2)+Math.pow(r.y()-_.y,2));const w=_.x<r.x()?-1:1,S=r.y()<_.y?-1:1;t=s*this.cos*w,i=s*this.sin*S,r.x(_.x-t),r.y(_.y+i)}u=r.position(),this.findOne(".top-left").x(u.x),this.findOne(".bottom-right").y(u.y)}else if(this._movingAnchorName==="bottom-center")this.findOne(".bottom-right").y(r.y());else if(this._movingAnchorName==="bottom-right"){if(g){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()};s=Math.sqrt(Math.pow(r.x()-_.x,2)+Math.pow(r.y()-_.y,2));const w=this.findOne(".bottom-right").x()<_.x?-1:1,S=this.findOne(".bottom-right").y()<_.y?-1:1;t=s*this.cos*w,i=s*this.sin*S,this.findOne(".bottom-right").x(_.x+t),this.findOne(".bottom-right").y(_.y+i)}}else console.error(new Error("Wrong position argument of selection resizer: "+this._movingAnchorName));if(v=this.centeredScaling()||e.altKey,v){const _=this.findOne(".top-left"),w=this.findOne(".bottom-right"),S=_.x(),C=_.y(),A=this.getWidth()-w.x(),M=this.getHeight()-w.y();w.move({x:-S,y:-C}),_.move({x:A,y:M})}const p=this.findOne(".top-left").getAbsolutePosition();t=p.x,i=p.y;const m=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),b=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodesInto({x:t,y:i,width:m,height:b,rotation:le.getAngle(this.rotation())},e)}_handleMouseUp(e){this._removeEvents(e)}getAbsoluteTransform(){return this.getTransform()}_removeEvents(e){var t;if(this._transforming){this._transforming=!1,typeof window<"u"&&(window.removeEventListener("mousemove",this._handleMouseMove),window.removeEventListener("touchmove",this._handleMouseMove),window.removeEventListener("mouseup",this._handleMouseUp,!0),window.removeEventListener("touchend",this._handleMouseUp,!0));const i=this.getNode();Ai--,this._fire("transformend",{evt:e,target:i}),(t=this.getLayer())===null||t===void 0||t.batchDraw(),i&&this._nodes.forEach(s=>{var r;s._fire("transformend",{evt:e,target:s}),(r=s.getLayer())===null||r===void 0||r.batchDraw()}),this._movingAnchorName=null}}_fitNodesInto(e,t){const i=this._getNodeRect(),s=1;if(U._inRange(e.width,-this.padding()*2-s,s)){this.update();return}if(U._inRange(e.height,-this.padding()*2-s,s)){this.update();return}const r=new Ke;if(r.rotate(le.getAngle(this.rotation())),this._movingAnchorName&&e.width<0&&this._movingAnchorName.indexOf("left")>=0){const g=r.point({x:-this.padding()*2,y:0});e.x+=g.x,e.y+=g.y,e.width+=this.padding()*2,this._movingAnchorName=this._movingAnchorName.replace("left","right"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y}else if(this._movingAnchorName&&e.width<0&&this._movingAnchorName.indexOf("right")>=0){const g=r.point({x:this.padding()*2,y:0});this._movingAnchorName=this._movingAnchorName.replace("right","left"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y,e.width+=this.padding()*2}if(this._movingAnchorName&&e.height<0&&this._movingAnchorName.indexOf("top")>=0){const g=r.point({x:0,y:-this.padding()*2});e.x+=g.x,e.y+=g.y,this._movingAnchorName=this._movingAnchorName.replace("top","bottom"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y,e.height+=this.padding()*2}else if(this._movingAnchorName&&e.height<0&&this._movingAnchorName.indexOf("bottom")>=0){const g=r.point({x:0,y:this.padding()*2});this._movingAnchorName=this._movingAnchorName.replace("bottom","top"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y,e.height+=this.padding()*2}if(this.boundBoxFunc()){const g=this.boundBoxFunc()(i,e);g?e=g:U.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const a=1e7,l=new Ke;l.translate(i.x,i.y),l.rotate(i.rotation),l.scale(i.width/a,i.height/a);const o=new Ke,c=e.width/a,d=e.height/a;this.flipEnabled()===!1?(o.translate(e.x,e.y),o.rotate(e.rotation),o.translate(e.width<0?e.width:0,e.height<0?e.height:0),o.scale(Math.abs(c),Math.abs(d))):(o.translate(e.x,e.y),o.rotate(e.rotation),o.scale(c,d));const h=o.multiply(l.invert());this._nodes.forEach(g=>{var v;if(!g.getStage())return;const u=g.getParent().getAbsoluteTransform(),p=g.getTransform().copy();p.translate(g.offsetX(),g.offsetY());const m=new Ke;m.multiply(u.copy().invert()).multiply(h).multiply(u).multiply(p);const b=m.decompose();g.setAttrs(b),(v=g.getLayer())===null||v===void 0||v.batchDraw()}),this.rotation(U._getRotation(e.rotation)),this._nodes.forEach(g=>{this._fire("transform",{evt:t,target:g}),g._fire("transform",{evt:t,target:g})}),this._resetTransformCache(),this.update(),this.getLayer().batchDraw()}forceUpdate(){this._resetTransformCache(),this.update()}_batchChangeChild(e,t){this.findOne(e).setAttrs(t)}update(){var e;const t=this._getNodeRect();this.rotation(U._getRotation(t.rotation));const i=t.width,s=t.height,r=this.enabledAnchors(),a=this.resizeEnabled(),l=this.padding(),o=this.anchorSize(),c=this.find("._anchor");c.forEach(h=>{h.setAttrs({width:o,height:o,offsetX:o/2,offsetY:o/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius()})}),this._batchChangeChild(".top-left",{x:0,y:0,offsetX:o/2+l,offsetY:o/2+l,visible:a&&r.indexOf("top-left")>=0}),this._batchChangeChild(".top-center",{x:i/2,y:0,offsetY:o/2+l,visible:a&&r.indexOf("top-center")>=0}),this._batchChangeChild(".top-right",{x:i,y:0,offsetX:o/2-l,offsetY:o/2+l,visible:a&&r.indexOf("top-right")>=0}),this._batchChangeChild(".middle-left",{x:0,y:s/2,offsetX:o/2+l,visible:a&&r.indexOf("middle-left")>=0}),this._batchChangeChild(".middle-right",{x:i,y:s/2,offsetX:o/2-l,visible:a&&r.indexOf("middle-right")>=0}),this._batchChangeChild(".bottom-left",{x:0,y:s,offsetX:o/2+l,offsetY:o/2-l,visible:a&&r.indexOf("bottom-left")>=0}),this._batchChangeChild(".bottom-center",{x:i/2,y:s,offsetY:o/2-l,visible:a&&r.indexOf("bottom-center")>=0}),this._batchChangeChild(".bottom-right",{x:i,y:s,offsetX:o/2-l,offsetY:o/2-l,visible:a&&r.indexOf("bottom-right")>=0}),this._batchChangeChild(".rotater",{x:i/2,y:-this.rotateAnchorOffset()*U._sign(s)-l,visible:this.rotateEnabled()}),this._batchChangeChild(".back",{width:i,height:s,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),draggable:this.nodes().some(h=>h.draggable()),x:0,y:0});const d=this.anchorStyleFunc();d&&c.forEach(h=>{d(h)}),(e=this.getLayer())===null||e===void 0||e.batchDraw()}isTransforming(){return this._transforming}stopTransform(){if(this._transforming){this._removeEvents();const e=this.findOne("."+this._movingAnchorName);e&&e.stopDrag()}}destroy(){return this.getStage()&&this._cursorChange&&this.getStage().content&&(this.getStage().content.style.cursor=""),Yt.prototype.destroy.call(this),this.detach(),this._removeEvents(),this}toObject(){return se.prototype.toObject.call(this)}clone(e){return se.prototype.clone.call(this,e)}getClientRect(){return this.nodes().length>0?super.getClientRect():{x:0,y:0,width:0,height:0}}}Ee.isTransforming=()=>Ai>0;function gd(n){return n instanceof Array||U.warn("enabledAnchors value should be an array"),n instanceof Array&&n.forEach(function(e){jn.indexOf(e)===-1&&U.warn("Unknown anchor name: "+e+". Available names are: "+jn.join(", "))}),n||[]}Ee.prototype.className="Transformer";Be(Ee);T.addGetterSetter(Ee,"enabledAnchors",jn,gd);T.addGetterSetter(Ee,"flipEnabled",!0,lt());T.addGetterSetter(Ee,"resizeEnabled",!0);T.addGetterSetter(Ee,"anchorSize",10,re());T.addGetterSetter(Ee,"rotateEnabled",!0);T.addGetterSetter(Ee,"rotateLineVisible",!0);T.addGetterSetter(Ee,"rotationSnaps",[]);T.addGetterSetter(Ee,"rotateAnchorOffset",50,re());T.addGetterSetter(Ee,"rotateAnchorCursor","crosshair");T.addGetterSetter(Ee,"rotationSnapTolerance",5,re());T.addGetterSetter(Ee,"borderEnabled",!0);T.addGetterSetter(Ee,"anchorStroke","rgb(0, 161, 255)");T.addGetterSetter(Ee,"anchorStrokeWidth",1,re());T.addGetterSetter(Ee,"anchorFill","white");T.addGetterSetter(Ee,"anchorCornerRadius",0,re());T.addGetterSetter(Ee,"borderStroke","rgb(0, 161, 255)");T.addGetterSetter(Ee,"borderStrokeWidth",1,re());T.addGetterSetter(Ee,"borderDash");T.addGetterSetter(Ee,"keepRatio",!0);T.addGetterSetter(Ee,"shiftBehavior","default");T.addGetterSetter(Ee,"centeredScaling",!1);T.addGetterSetter(Ee,"ignoreStroke",!1);T.addGetterSetter(Ee,"padding",0,re());T.addGetterSetter(Ee,"nodes");T.addGetterSetter(Ee,"node");T.addGetterSetter(Ee,"boundBoxFunc");T.addGetterSetter(Ee,"anchorDragBoundFunc");T.addGetterSetter(Ee,"anchorStyleFunc");T.addGetterSetter(Ee,"shouldOverdrawWholeArea",!1);T.addGetterSetter(Ee,"useSingleNodeRotation",!0);T.backCompat(Ee,{lineEnabled:"borderEnabled",rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"});class bt extends Z{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.radius(),0,le.getAngle(this.angle()),this.clockwise()),e.lineTo(0,0),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius(e/2)}setHeight(e){this.radius(e/2)}}bt.prototype.className="Wedge";bt.prototype._centroid=!0;bt.prototype._attrsAffectingSize=["radius"];Be(bt);T.addGetterSetter(bt,"radius",0,re());T.addGetterSetter(bt,"angle",0,re());T.addGetterSetter(bt,"clockwise",!1);T.backCompat(bt,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"});function ks(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}const fd=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],vd=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function pd(n,e){const t=n.data,i=n.width,s=n.height;let r,a,l,o,c,d,h,g,v,u,p,m,b,_,w,S,C,A,M,D;const z=e+e+1,E=i-1,R=s-1,k=e+1,q=k*(k+1)/2,N=new ks,$=fd[e],P=vd[e];let X=null,F=N,O=null,V=null;for(let B=1;B<z;B++)F=F.next=new ks,B===k&&(X=F);F.next=N,l=a=0;for(let B=0;B<s;B++){m=b=_=w=o=c=d=h=0,g=k*(S=t[a]),v=k*(C=t[a+1]),u=k*(A=t[a+2]),p=k*(M=t[a+3]),o+=q*S,c+=q*C,d+=q*A,h+=q*M,F=N;for(let H=0;H<k;H++)F.r=S,F.g=C,F.b=A,F.a=M,F=F.next;for(let H=1;H<k;H++)r=a+((E<H?E:H)<<2),o+=(F.r=S=t[r])*(D=k-H),c+=(F.g=C=t[r+1])*D,d+=(F.b=A=t[r+2])*D,h+=(F.a=M=t[r+3])*D,m+=S,b+=C,_+=A,w+=M,F=F.next;O=N,V=X;for(let H=0;H<i;H++)t[a+3]=M=h*$>>P,M!==0?(M=255/M,t[a]=(o*$>>P)*M,t[a+1]=(c*$>>P)*M,t[a+2]=(d*$>>P)*M):t[a]=t[a+1]=t[a+2]=0,o-=g,c-=v,d-=u,h-=p,g-=O.r,v-=O.g,u-=O.b,p-=O.a,r=l+((r=H+e+1)<E?r:E)<<2,m+=O.r=t[r],b+=O.g=t[r+1],_+=O.b=t[r+2],w+=O.a=t[r+3],o+=m,c+=b,d+=_,h+=w,O=O.next,g+=S=V.r,v+=C=V.g,u+=A=V.b,p+=M=V.a,m-=S,b-=C,_-=A,w-=M,V=V.next,a+=4;l+=i}for(let B=0;B<i;B++){b=_=w=m=c=d=h=o=0,a=B<<2,g=k*(S=t[a]),v=k*(C=t[a+1]),u=k*(A=t[a+2]),p=k*(M=t[a+3]),o+=q*S,c+=q*C,d+=q*A,h+=q*M,F=N;for(let j=0;j<k;j++)F.r=S,F.g=C,F.b=A,F.a=M,F=F.next;let H=i;for(let j=1;j<=e;j++)a=H+B<<2,o+=(F.r=S=t[a])*(D=k-j),c+=(F.g=C=t[a+1])*D,d+=(F.b=A=t[a+2])*D,h+=(F.a=M=t[a+3])*D,m+=S,b+=C,_+=A,w+=M,F=F.next,j<R&&(H+=i);a=B,O=N,V=X;for(let j=0;j<s;j++)r=a<<2,t[r+3]=M=h*$>>P,M>0?(M=255/M,t[r]=(o*$>>P)*M,t[r+1]=(c*$>>P)*M,t[r+2]=(d*$>>P)*M):t[r]=t[r+1]=t[r+2]=0,o-=g,c-=v,d-=u,h-=p,g-=O.r,v-=O.g,u-=O.b,p-=O.a,r=B+((r=j+k)<R?r:R)*i<<2,o+=m+=O.r=t[r],c+=b+=O.g=t[r+1],d+=_+=O.b=t[r+2],h+=w+=O.a=t[r+3],O=O.next,g+=S=V.r,v+=C=V.g,u+=A=V.b,p+=M=V.a,m-=S,b-=C,_-=A,w-=M,V=V.next,a+=i}}const md=function(e){const t=Math.round(this.blurRadius());t>0&&pd(e,t)};T.addGetterSetter(se,"blurRadius",0,re(),T.afterSetFilter);const bd=function(n){const e=this.brightness()*255,t=n.data,i=t.length;for(let s=0;s<i;s+=4)t[s]+=e,t[s+1]+=e,t[s+2]+=e};T.addGetterSetter(se,"brightness",0,re(),T.afterSetFilter);const yd=function(n){const e=this.brightness(),t=n.data,i=t.length;for(let s=0;s<i;s+=4)t[s]=Math.min(255,t[s]*e),t[s+1]=Math.min(255,t[s+1]*e),t[s+2]=Math.min(255,t[s+2]*e)},_d=function(n){const e=Math.pow((this.contrast()+100)/100,2),t=n.data,i=t.length;let s=150,r=150,a=150;for(let l=0;l<i;l+=4)s=t[l],r=t[l+1],a=t[l+2],s/=255,s-=.5,s*=e,s+=.5,s*=255,r/=255,r-=.5,r*=e,r+=.5,r*=255,a/=255,a-=.5,a*=e,a+=.5,a*=255,s=s<0?0:s>255?255:s,r=r<0?0:r>255?255:r,a=a<0?0:a>255?255:a,t[l]=s,t[l+1]=r,t[l+2]=a};T.addGetterSetter(se,"contrast",0,re(),T.afterSetFilter);const xd=function(n){var e,t,i,s,r,a,l,o,c;const d=n.data,h=n.width,g=n.height,v=Math.min(1,Math.max(0,(t=(e=this.embossStrength)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:.5)),u=Math.min(1,Math.max(0,(s=(i=this.embossWhiteLevel)===null||i===void 0?void 0:i.call(this))!==null&&s!==void 0?s:.5)),m=(l={"top-left":315,top:270,"top-right":225,right:180,"bottom-right":135,bottom:90,"bottom-left":45,left:0}[(a=(r=this.embossDirection)===null||r===void 0?void 0:r.call(this))!==null&&a!==void 0?a:"top-left"])!==null&&l!==void 0?l:315,b=!!((c=(o=this.embossBlend)===null||o===void 0?void 0:o.call(this))!==null&&c!==void 0&&c),_=v*10,w=u*255,S=m*Math.PI/180,C=Math.cos(S),A=Math.sin(S),M=128/1020*_,D=new Uint8ClampedArray(d),z=new Float32Array(h*g);for(let N=0,$=0;$<d.length;$+=4,N++)z[N]=.2126*D[$]+.7152*D[$+1]+.0722*D[$+2];const E=[-1,0,1,-2,0,2,-1,0,1],R=[-1,-2,-1,0,0,0,1,2,1],k=[-h-1,-h,-h+1,-1,0,1,h-1,h,h+1],q=N=>N<0?0:N>255?255:N;for(let N=1;N<g-1;N++)for(let $=1;$<h-1;$++){const P=N*h+$;let X=0,F=0;X+=z[P+k[0]]*E[0],F+=z[P+k[0]]*R[0],X+=z[P+k[1]]*E[1],F+=z[P+k[1]]*R[1],X+=z[P+k[2]]*E[2],F+=z[P+k[2]]*R[2],X+=z[P+k[3]]*E[3],F+=z[P+k[3]]*R[3],X+=z[P+k[5]]*E[5],F+=z[P+k[5]]*R[5],X+=z[P+k[6]]*E[6],F+=z[P+k[6]]*R[6],X+=z[P+k[7]]*E[7],F+=z[P+k[7]]*R[7],X+=z[P+k[8]]*E[8],F+=z[P+k[8]]*R[8];const O=C*X+A*F,V=q(w+O*M),B=P*4;if(b){const H=V-w;d[B]=q(D[B]+H),d[B+1]=q(D[B+1]+H),d[B+2]=q(D[B+2]+H),d[B+3]=D[B+3]}else d[B]=d[B+1]=d[B+2]=V,d[B+3]=D[B+3]}for(let N=0;N<h;N++){let $=N*4,P=((g-1)*h+N)*4;d[$]=D[$],d[$+1]=D[$+1],d[$+2]=D[$+2],d[$+3]=D[$+3],d[P]=D[P],d[P+1]=D[P+1],d[P+2]=D[P+2],d[P+3]=D[P+3]}for(let N=1;N<g-1;N++){let $=N*h*4,P=(N*h+(h-1))*4;d[$]=D[$],d[$+1]=D[$+1],d[$+2]=D[$+2],d[$+3]=D[$+3],d[P]=D[P],d[P+1]=D[P+1],d[P+2]=D[P+2],d[P+3]=D[P+3]}return n};T.addGetterSetter(se,"embossStrength",.5,re(),T.afterSetFilter);T.addGetterSetter(se,"embossWhiteLevel",.5,re(),T.afterSetFilter);T.addGetterSetter(se,"embossDirection","top-left",void 0,T.afterSetFilter);T.addGetterSetter(se,"embossBlend",!1,void 0,T.afterSetFilter);function gi(n,e,t,i,s){const r=t-e,a=s-i;if(r===0)return i+a/2;if(a===0)return i;let l=(n-e)/r;return l=a*l+i,l}const Sd=function(n){const e=n.data,t=e.length;let i=e[0],s=i,r,a=e[1],l=a,o,c=e[2],d=c,h;const g=this.enhance();if(g===0)return;for(let w=0;w<t;w+=4)r=e[w+0],r<i?i=r:r>s&&(s=r),o=e[w+1],o<a?a=o:o>l&&(l=o),h=e[w+2],h<c?c=h:h>d&&(d=h);s===i&&(s=255,i=0),l===a&&(l=255,a=0),d===c&&(d=255,c=0);let v,u,p,m,b,_;if(g>0)v=s+g*(255-s),u=i-g*(i-0),p=l+g*(255-l),m=a-g*(a-0),b=d+g*(255-d),_=c-g*(c-0);else{const w=(s+i)*.5;v=s+g*(s-w),u=i+g*(i-w);const S=(l+a)*.5;p=l+g*(l-S),m=a+g*(a-S);const C=(d+c)*.5;b=d+g*(d-C),_=c+g*(c-C)}for(let w=0;w<t;w+=4)e[w+0]=gi(e[w+0],i,s,u,v),e[w+1]=gi(e[w+1],a,l,m,p),e[w+2]=gi(e[w+2],c,d,_,b)};T.addGetterSetter(se,"enhance",0,re(),T.afterSetFilter);const wd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4){const s=.34*e[i]+.5*e[i+1]+.16*e[i+2];e[i]=s,e[i+1]=s,e[i+2]=s}};T.addGetterSetter(se,"hue",0,re(),T.afterSetFilter);T.addGetterSetter(se,"saturation",0,re(),T.afterSetFilter);T.addGetterSetter(se,"luminance",0,re(),T.afterSetFilter);const $d=function(n){const e=n.data,t=e.length,i=1,s=Math.pow(2,this.saturation()),r=Math.abs(this.hue()+360)%360,a=this.luminance()*127,l=i*s*Math.cos(r*Math.PI/180),o=i*s*Math.sin(r*Math.PI/180),c=.299*i+.701*l+.167*o,d=.587*i-.587*l+.33*o,h=.114*i-.114*l-.497*o,g=.299*i-.299*l-.328*o,v=.587*i+.413*l+.035*o,u=.114*i-.114*l+.293*o,p=.299*i-.3*l+1.25*o,m=.587*i-.586*l-1.05*o,b=.114*i+.886*l-.2*o;let _,w,S,C;for(let A=0;A<t;A+=4)_=e[A+0],w=e[A+1],S=e[A+2],C=e[A+3],e[A+0]=c*_+d*w+h*S+a,e[A+1]=g*_+v*w+u*S+a,e[A+2]=p*_+m*w+b*S+a,e[A+3]=C},Cd=function(n){const e=n.data,t=e.length,i=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),r=Math.abs(this.hue()+360)%360,a=i*s*Math.cos(r*Math.PI/180),l=i*s*Math.sin(r*Math.PI/180),o=.299*i+.701*a+.167*l,c=.587*i-.587*a+.33*l,d=.114*i-.114*a-.497*l,h=.299*i-.299*a-.328*l,g=.587*i+.413*a+.035*l,v=.114*i-.114*a+.293*l,u=.299*i-.3*a+1.25*l,p=.587*i-.586*a-1.05*l,m=.114*i+.886*a-.2*l;for(let b=0;b<t;b+=4){const _=e[b+0],w=e[b+1],S=e[b+2],C=e[b+3];e[b+0]=o*_+c*w+d*S,e[b+1]=h*_+g*w+v*S,e[b+2]=u*_+p*w+m*S,e[b+3]=C}};T.addGetterSetter(se,"hue",0,re(),T.afterSetFilter);T.addGetterSetter(se,"saturation",0,re(),T.afterSetFilter);T.addGetterSetter(se,"value",0,re(),T.afterSetFilter);const kd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4)e[i]=255-e[i],e[i+1]=255-e[i+1],e[i+2]=255-e[i+2]},Td=function(n,e,t){const i=n.data,s=e.data,r=n.width,a=n.height,l=t.polarCenterX||r/2,o=t.polarCenterY||a/2;let c=Math.sqrt(l*l+o*o),d=r-l,h=a-o;const g=Math.sqrt(d*d+h*h);c=g>c?g:c;const v=a,u=r,p=360/u*Math.PI/180;for(let m=0;m<u;m+=1){const b=Math.sin(m*p),_=Math.cos(m*p);for(let w=0;w<v;w+=1){d=Math.floor(l+c*w/v*_),h=Math.floor(o+c*w/v*b);let S=(h*r+d)*4;const C=i[S+0],A=i[S+1],M=i[S+2],D=i[S+3];S=(m+w*r)*4,s[S+0]=C,s[S+1]=A,s[S+2]=M,s[S+3]=D}}},Ed=function(n,e,t){const i=n.data,s=e.data,r=n.width,a=n.height,l=t.polarCenterX||r/2,o=t.polarCenterY||a/2;let c=Math.sqrt(l*l+o*o),d=r-l,h=a-o;const g=Math.sqrt(d*d+h*h);c=g>c?g:c;const v=a,u=r,p=0;let m,b;for(d=0;d<r;d+=1)for(h=0;h<a;h+=1){const _=d-l,w=h-o,S=Math.sqrt(_*_+w*w)*v/c;let C=(Math.atan2(w,_)*180/Math.PI+360+p)%360;C=C*u/360,m=Math.floor(C),b=Math.floor(S);let A=(b*r+m)*4;const M=i[A+0],D=i[A+1],z=i[A+2],E=i[A+3];A=(h*r+d)*4,s[A+0]=M,s[A+1]=D,s[A+2]=z,s[A+3]=E}},Pd=function(n){const e=n.width,t=n.height;let i,s,r,a,l,o,c,d,h,g,v=Math.round(this.kaleidoscopePower());const u=Math.round(this.kaleidoscopeAngle()),p=Math.floor(e*(u%360)/360);if(v<1)return;const m=U.createCanvasElement();m.width=e,m.height=t;const b=m.getContext("2d").getImageData(0,0,e,t);U.releaseCanvas(m),Td(n,b,{polarCenterX:e/2,polarCenterY:t/2});let _=e/Math.pow(2,v);for(;_<=8;)_=_*2,v-=1;_=Math.ceil(_);let w=_,S=0,C=w,A=1;for(p+_>e&&(S=w,C=0,A=-1),s=0;s<t;s+=1)for(i=S;i!==C;i+=A)r=Math.round(i+p)%e,h=(e*s+r)*4,l=b.data[h+0],o=b.data[h+1],c=b.data[h+2],d=b.data[h+3],g=(e*s+i)*4,b.data[g+0]=l,b.data[g+1]=o,b.data[g+2]=c,b.data[g+3]=d;for(s=0;s<t;s+=1)for(w=Math.floor(_),a=0;a<v;a+=1){for(i=0;i<w+1;i+=1)h=(e*s+i)*4,l=b.data[h+0],o=b.data[h+1],c=b.data[h+2],d=b.data[h+3],g=(e*s+w*2-i-1)*4,b.data[g+0]=l,b.data[g+1]=o,b.data[g+2]=c,b.data[g+3]=d;w*=2}Ed(b,n,{})};T.addGetterSetter(se,"kaleidoscopePower",2,re(),T.afterSetFilter);T.addGetterSetter(se,"kaleidoscopeAngle",0,re(),T.afterSetFilter);function Ln(n,e,t){let i=(t*n.width+e)*4;const s=[];return s.push(n.data[i++],n.data[i++],n.data[i++],n.data[i++]),s}function tn(n,e){return Math.sqrt(Math.pow(n[0]-e[0],2)+Math.pow(n[1]-e[1],2)+Math.pow(n[2]-e[2],2))}function Ad(n){const e=[0,0,0];for(let t=0;t<n.length;t++)e[0]+=n[t][0],e[1]+=n[t][1],e[2]+=n[t][2];return e[0]/=n.length,e[1]/=n.length,e[2]/=n.length,e}function Rd(n,e){const t=Ln(n,0,0),i=Ln(n,n.width-1,0),s=Ln(n,0,n.height-1),r=Ln(n,n.width-1,n.height-1),a=e||10;if(tn(t,i)<a&&tn(i,r)<a&&tn(r,s)<a&&tn(s,t)<a){const l=Ad([i,t,r,s]),o=[];for(let c=0;c<n.width*n.height;c++){const d=tn(l,[n.data[c*4],n.data[c*4+1],n.data[c*4+2]]);o[c]=d<a?0:255}return o}}function Ld(n,e){for(let t=0;t<n.width*n.height;t++)n.data[4*t+3]=e[t]}function Md(n,e,t){const i=[1,1,1,1,0,1,1,1,1],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let h=0;h<s;h++)for(let g=0;g<s;g++){const v=l+h-r,u=o+g-r;if(v>=0&&v<t&&u>=0&&u<e){const p=v*e+u,m=i[h*s+g];d+=n[p]*m}}a[c]=d===255*8?255:0}return a}function Dd(n,e,t){const i=[1,1,1,1,1,1,1,1,1],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let h=0;h<s;h++)for(let g=0;g<s;g++){const v=l+h-r,u=o+g-r;if(v>=0&&v<t&&u>=0&&u<e){const p=v*e+u,m=i[h*s+g];d+=n[p]*m}}a[c]=d>=255*4?255:0}return a}function Od(n,e,t){const i=[.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let h=0;h<s;h++)for(let g=0;g<s;g++){const v=l+h-r,u=o+g-r;if(v>=0&&v<t&&u>=0&&u<e){const p=v*e+u,m=i[h*s+g];d+=n[p]*m}}a[c]=d}return a}const Id=function(n){const e=this.threshold();let t=Rd(n,e);return t&&(t=Md(t,n.width,n.height),t=Dd(t,n.width,n.height),t=Od(t,n.width,n.height),Ld(n,t)),n};T.addGetterSetter(se,"threshold",0,re(),T.afterSetFilter);const Nd=function(n){const e=this.noise()*255,t=n.data,i=t.length,s=e/2;for(let r=0;r<i;r+=4)t[r+0]+=s-2*s*Math.random(),t[r+1]+=s-2*s*Math.random(),t[r+2]+=s-2*s*Math.random()};T.addGetterSetter(se,"noise",.2,re(),T.afterSetFilter);const zd=function(n){let e=Math.ceil(this.pixelSize()),t=n.width,i=n.height,s=Math.ceil(t/e),r=Math.ceil(i/e),a=n.data;if(e<=0){U.error("pixelSize value can not be <= 0");return}for(let l=0;l<s;l+=1)for(let o=0;o<r;o+=1){let c=0,d=0,h=0,g=0;const v=l*e,u=v+e,p=o*e,m=p+e;let b=0;for(let _=v;_<u;_+=1)if(!(_>=t))for(let w=p;w<m;w+=1){if(w>=i)continue;const S=(t*w+_)*4;c+=a[S+0],d+=a[S+1],h+=a[S+2],g+=a[S+3],b+=1}c=c/b,d=d/b,h=h/b,g=g/b;for(let _=v;_<u;_+=1)if(!(_>=t))for(let w=p;w<m;w+=1){if(w>=i)continue;const S=(t*w+_)*4;a[S+0]=c,a[S+1]=d,a[S+2]=h,a[S+3]=g}}};T.addGetterSetter(se,"pixelSize",8,re(),T.afterSetFilter);const Fd=function(n){const e=Math.round(this.levels()*254)+1,t=n.data,i=t.length,s=255/e;for(let r=0;r<i;r+=1)t[r]=Math.floor(t[r]/s)*s};T.addGetterSetter(se,"levels",.5,re(),T.afterSetFilter);const Gd=function(n){const e=n.data,t=e.length,i=this.red(),s=this.green(),r=this.blue();for(let a=0;a<t;a+=4){const l=(.34*e[a]+.5*e[a+1]+.16*e[a+2])/255;e[a]=l*i,e[a+1]=l*s,e[a+2]=l*r,e[a+3]=e[a+3]}};T.addGetterSetter(se,"red",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"green",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"blue",0,rr,T.afterSetFilter);const Bd=function(n){const e=n.data,t=e.length,i=this.red(),s=this.green(),r=this.blue(),a=this.alpha();for(let l=0;l<t;l+=4){const o=1-a;e[l]=i*a+e[l]*o,e[l+1]=s*a+e[l+1]*o,e[l+2]=r*a+e[l+2]*o}};T.addGetterSetter(se,"red",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"green",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"blue",0,rr,T.afterSetFilter);T.addGetterSetter(se,"alpha",1,function(n){return this._filterUpToDate=!1,n>1?1:n<0?0:n});const Ud=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4){const s=e[i+0],r=e[i+1],a=e[i+2];e[i+0]=Math.min(255,s*.393+r*.769+a*.189),e[i+1]=Math.min(255,s*.349+r*.686+a*.168),e[i+2]=Math.min(255,s*.272+r*.534+a*.131)}},Hd=function(n){const t=n.data;for(let i=0;i<t.length;i+=4){const s=t[i],r=t[i+1],a=t[i+2];.2126*s+.7152*r+.0722*a>=128&&(t[i]=255-s,t[i+1]=255-r,t[i+2]=255-a)}return n},qd=function(n){const e=this.threshold()*255,t=n.data,i=t.length;for(let s=0;s<i;s+=1)t[s]=t[s]<e?0:255};T.addGetterSetter(se,"threshold",.5,re(),T.afterSetFilter);const Qe=vs.Util._assign(vs,{Arc:pt,Arrow:Nt,Circle:Xt,Ellipse:kt,Image:st,Label:Ni,Tag:zt,Line:mt,Path:ze,Rect:yn,RegularPolygon:Tt,Ring:Ft,Sprite:dt,Star:Et,Text:Fe,TextPath:qe,Transformer:Ee,Wedge:bt,Filters:{Blur:md,Brightness:yd,Brighten:bd,Contrast:_d,Emboss:xd,Enhance:Sd,Grayscale:wd,HSL:$d,HSV:Cd,Invert:kd,Kaleidoscope:Pd,Mask:Id,Noise:Nd,Pixelate:zd,Posterize:Fd,RGB:Gd,RGBA:Bd,Sepia:Ud,Solarize:Hd,Threshold:qd}});class Wd{stage;layer;elements;backgroundLayer;constructor(e,t={}){if(this.stage=new Qe.Stage({container:e,width:t.width||e.clientWidth,height:t.height||e.clientHeight}),this.backgroundLayer=new Qe.Layer,this.stage.add(this.backgroundLayer),t.background){const i=new Qe.Rect({x:0,y:0,width:this.stage.width(),height:this.stage.height(),fill:t.background});this.backgroundLayer.add(i)}this.layer=new Qe.Layer,this.stage.add(this.layer),this.elements=new Map}render(e){this.layer.destroyChildren(),this.elements.clear();const t=performance.now();e.forEach(s=>{const r=this.createElement(s);r&&(this.layer.add(r),this.elements.set(s.id,r))}),this.layer.batchDraw();const i=performance.now()-t;console.log(`✨ Konva渲染完成: ${e.length}个元素, 耗时${i.toFixed(2)}ms`)}createElement(e){const t=e.content.type;switch(t){case"Text":return this.createText(e);case"Rectangle":return this.createRectangle(e);case"Image":return this.createImage(e);case"Line":return this.createLine(e);case"DataField":return this.createDataField(e);default:return console.warn(`未知元素类型: ${t}`),null}}createText(e){if(e.content.type!=="Text")return new Qe.Text({});const t=e.content,i=t.style;return new Qe.Text({id:e.id,x:e.position.x,y:e.position.y,text:t.content||"文本",fontSize:i.font_size||14,fontFamily:i.font_family||"Arial",fontStyle:i.font_weight==="bold"?"bold":"normal",fill:i.color||"#000000",width:e.size.width,align:i.align==="Center"?"center":i.align==="Right"?"right":"left",verticalAlign:"top",wrap:"word",ellipsis:!0})}createRectangle(e){if(e.content.type!=="Rectangle")return new Qe.Rect({});const t=e.content;return new Qe.Rect({id:e.id,x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,fill:t.fill_color||"transparent",stroke:t.border?.color||"#000000",strokeWidth:t.border?.width||0,cornerRadius:t.corner_radius||0,opacity:t.opacity||1})}createImage(e){const t=new Qe.Rect({id:e.id+"_placeholder",x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,fill:"#f0f0f0",stroke:"#cccccc",strokeWidth:1});if(e.content.type==="Image"){const i=e.content,s=new window.Image;s.onload=()=>{const r=new Qe.Image({id:e.id,x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,image:s});t.destroy(),this.layer.add(r),this.elements.set(e.id,r),this.layer.batchDraw()},s.onerror=()=>{console.error(`图片加载失败: ${i.src}`)},s.src=i.src}return t}createLine(e){const i=e.size.height<e.size.width?[0,0,e.size.width,0]:[0,0,0,e.size.height];if(e.content.type!=="Line")return new Qe.Line({});const s=e.content,r=s.line_style==="Dashed"?[5,5]:s.line_style==="Dotted"?[2,2]:s.line_style==="DashDot"?[5,2,2,2]:void 0,a={id:e.id,x:e.position.x,y:e.position.y,points:i,stroke:s.color||"#000000",strokeWidth:s.width||1,lineCap:"round",lineJoin:"round"};return r&&(a.dash=r),new Qe.Line(a)}createDataField(e){if(e.content.type!=="DataField")return new Qe.Text({});const t=e.content,i=t.style;return new Qe.Text({id:e.id,x:e.position.x,y:e.position.y,text:t.expression||"[Data Field]",fontSize:i.font_size||14,fontFamily:i.font_family||"Arial",fontStyle:i.font_weight==="bold"?"bold":"normal",fill:i.color||"#000000",width:e.size.width,align:i.align==="Center"?"center":i.align==="Right"?"right":"left",verticalAlign:"top",wrap:"word",ellipsis:!0})}setScale(e){this.stage.scale({x:e,y:e}),this.stage.batchDraw()}getScale(){return this.stage.scaleX()}setPosition(e,t){this.stage.position({x:e,y:t}),this.stage.batchDraw()}getPosition(){return this.stage.position()}fitToContainer(){const t=this.stage.container().getBoundingClientRect();this.stage.width(t.width),this.stage.height(t.height);const i=this.backgroundLayer.findOne("Rect");i&&(i.width(t.width),i.height(t.height)),this.stage.batchDraw()}async toDataURL(e={}){return this.stage.toDataURL({pixelRatio:e.pixelRatio||2,mimeType:e.mimeType||"image/png"})}destroy(){this.elements.clear(),this.stage.destroy()}getStats(){return{elementsCount:this.elements.size,layersCount:this.stage.getLayers().length,stageSize:{width:this.stage.width(),height:this.stage.height()},scale:this.getScale(),position:this.getPosition()}}}var jd=x('<div class="floating-toolbar fixed top-4 left-1/2 transform -translate-x-1/2 z-50"><div class="toolbar-container flex items-center gap-2 px-4 py-2 bg-gray-900 rounded-lg shadow-2xl"><div class="page-nav flex items-center gap-1"><button class="nav-btn p-1 text-white hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"title=上一页><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 19l-7-7 7-7"></path></svg></button><div class="page-display flex items-center gap-1 text-white text-sm"><input type=number class="page-input w-12 px-1 py-0.5 bg-gray-800 text-center rounded outline-none focus:bg-gray-700"min=1><span>/</span><span></span></div><button class="nav-btn p-1 text-white hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"title=下一页><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"></path></svg></button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="zoom-controls flex items-center gap-1"><button class="zoom-btn p-1 text-white hover:bg-gray-700 rounded"title=缩小><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M20 12H4"></path></svg></button><div class="zoom-display flex items-center gap-1 text-white text-sm"><input type=number class="zoom-input w-14 px-1 py-0.5 bg-gray-800 text-center rounded outline-none focus:bg-gray-700"min=10 max=500 step=10><span>%</span></div><button class="zoom-btn p-1 text-white hover:bg-gray-700 rounded"title=放大><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M12 4v16m8-8H4"></path></svg></button><button class="fit-btn p-1 text-white hover:bg-gray-700 rounded"title=适应屏幕><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg></button><button class="actual-btn p-1 text-white hover:bg-gray-700 rounded"title=实际大小><span class="text-xs font-bold">1:1</span></button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="mode-controls flex items-center gap-1"><button title=演示模式>演示</button><button title=开发模式>开发</button><button title=打印模式>打印</button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="quick-actions flex items-center gap-1"><button class="action-btn p-1 text-white hover:bg-gray-700 rounded"title=导出><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button><button class="action-btn p-1 text-white hover:bg-gray-700 rounded"title=打印><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button><button class="exit-btn px-2 py-1 text-xs bg-red-600 text-white hover:bg-red-700 rounded"title="退出预览 (ESC)">退出');const Yd=n=>{const[e,t]=J(1),[i,s]=J(!1);let r=null;const a=()=>{r&&clearTimeout(r),r=window.setTimeout(()=>{i()||t(.3)},3e3)},l=()=>{r&&(clearTimeout(r),r=null),t(1)};et(()=>{a()}),$t(()=>{r&&clearTimeout(r)});const o=()=>{s(!0),l()},c=()=>{s(!1),a()},d=()=>{n.currentPage>1&&n.onPageChange(n.currentPage-1)},h=()=>{n.currentPage<n.totalPages&&n.onPageChange(n.currentPage+1)},g=()=>{const m=Math.min(500,n.zoom+25);n.onZoomChange(m)},v=()=>{const m=Math.max(10,n.zoom-25);n.onZoomChange(m)},u=m=>{const b=m.target,_=parseInt(b.value);!isNaN(_)&&_>=1&&_<=n.totalPages&&n.onPageChange(_)},p=m=>{const b=m.target,_=parseInt(b.value);!isNaN(_)&&_>=10&&_<=500&&n.onZoomChange(_)};return(()=>{var m=jd(),b=m.firstChild,_=b.firstChild,w=_.firstChild,S=w.nextSibling,C=S.firstChild,A=C.nextSibling,M=A.nextSibling,D=S.nextSibling,z=_.nextSibling,E=z.nextSibling,R=E.firstChild,k=R.nextSibling,q=k.firstChild,N=k.nextSibling,$=N.nextSibling,P=$.nextSibling,X=E.nextSibling,F=X.nextSibling,O=F.firstChild,V=O.nextSibling,B=V.nextSibling,H=F.nextSibling,j=H.nextSibling,de=j.firstChild,me=de.nextSibling,fe=me.nextSibling;return m.addEventListener("mouseleave",c),m.addEventListener("mouseenter",o),m.style.setProperty("transition","opacity 0.3s ease"),w.$$click=d,C.$$input=u,f(M,()=>n.totalPages),D.$$click=h,R.$$click=v,q.$$input=p,N.$$click=g,Ae($,"click",n.onFitScreen),Ae(P,"click",n.onActualSize),O.$$click=()=>n.onModeChange("presentation"),V.$$click=()=>n.onModeChange("development"),B.$$click=()=>n.onModeChange("print"),Ae(de,"click",n.onExport),Ae(me,"click",n.onPrint),Ae(fe,"click",n.onExit),G(ee=>{var oe=e(),ge=n.currentPage<=1,he=n.totalPages,te=n.currentPage>=n.totalPages,ne=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="presentation"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,ve=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="development"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,be=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="print"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`;return oe!==ee.e&&((ee.e=oe)!=null?m.style.setProperty("opacity",oe):m.style.removeProperty("opacity")),ge!==ee.t&&(w.disabled=ee.t=ge),he!==ee.a&&Q(C,"max",ee.a=he),te!==ee.o&&(D.disabled=ee.o=te),ne!==ee.i&&Se(O,ee.i=ne),ve!==ee.n&&Se(V,ee.n=ve),be!==ee.s&&Se(B,ee.s=be),ee},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),G(()=>C.value=n.currentPage),G(()=>q.value=n.zoom),m})()};Ue(["click","input"]);var Vd=x('<div class="preview-viewport w-full h-full bg-gray-100 relative overflow-hidden"><div class="preview-container w-full h-full"></div><div class="shortcuts-hint absolute bottom-4 left-1/2 transform -translate-x-1/2 text-gray-500 text-sm animate-fade-out"><span class="bg-white px-3 py-1 rounded shadow">ESC 退出 • Shift+拖动 平移 • Ctrl+滚轮 缩放 • F 适应屏幕');const Xd=n=>{let e,t=null;const{state:i}=at(),{actions:s}=Xn(),[r,a]=J(1),[l,o]=J(100),[c,d]=J("presentation"),[h,g]=J(!1),[v,u]=J({x:0,y:0}),[p,m]=J({x:0,y:0}),b=()=>n.elements||i.elements,_=()=>n.pageCount||1;et(()=>{e&&(console.log("🎨 初始化Konva渲染器"),t=new Wd(e,{width:n.pageSize?.width||794,height:n.pageSize?.height||1123,background:"#ffffff"}),w(),X(),window.addEventListener("resize",k))}),$t(()=>{t&&(t.destroy(),t=null),window.removeEventListener("resize",k),document.removeEventListener("keydown",F)}),mn(()=>{const O=b();t&&O&&w()});const w=()=>{if(!t)return;const O=b(),V=r();t.render([...O]),console.log(`📄 渲染第 ${V} 页，共 ${O.length} 个元素`)},S=O=>{a(O),w()},C=O=>{o(O),t&&t.setScale(O/100)},A=()=>{if(!t||!e)return;const O=e.getBoundingClientRect(),V=n.pageSize?.width||794,B=n.pageSize?.height||1123,H=(O.width-100)/V,j=(O.height-100)/B,de=Math.min(H,j,1);C(Math.round(de*100));const me=(O.width-V*de)/2,fe=(O.height-B*de)/2;t.setPosition(me,fe),m({x:me,y:fe})},M=()=>{C(100),t&&(t.setPosition(0,0),m({x:0,y:0}))},D=async()=>{if(console.log("📤 导出预览"),t)try{const O=await t.toDataURL({pixelRatio:2}),V=document.createElement("a");V.download=`preview-page-${r()}.png`,V.href=O,V.click()}catch(O){console.error("导出失败:",O)}},z=()=>{console.log("🖨️ 打印预览"),window.print()},E=()=>{console.log("🚪 退出预览模式"),s.setMode("design")},R=O=>{d(O),console.log(`🔄 切换到${O}模式`)},k=()=>{t&&t.fitToContainer()},q=O=>{O.button===0&&O.shiftKey&&(g(!0),u({x:O.clientX,y:O.clientY}),O.preventDefault())},N=O=>{if(!h()||!t)return;const V=O.clientX-v().x,B=O.clientY-v().y,H={x:p().x+V,y:p().y+B};t.setPosition(H.x,H.y),m(H),u({x:O.clientX,y:O.clientY})},$=()=>{g(!1)},P=O=>{if(!O.ctrlKey&&!O.metaKey)return;O.preventDefault();const V=O.deltaY>0?-10:10,B=Math.max(10,Math.min(500,l()+V));C(B)},X=()=>{document.addEventListener("keydown",F)},F=O=>{switch(O.key){case"Escape":E();break;case"f":case"F":!O.ctrlKey&&!O.metaKey&&A();break;case"1":!O.ctrlKey&&!O.metaKey&&M();break;case"+":case"=":C(Math.min(500,l()+25));break;case"-":case"_":C(Math.max(10,l()-25));break;case"ArrowLeft":r()>1&&S(r()-1);break;case"ArrowRight":r()<_()&&S(r()+1);break;case"Home":S(1);break;case"End":S(_());break;case"p":case"P":(O.ctrlKey||O.metaKey)&&(O.preventDefault(),z());break;case"e":case"E":(O.ctrlKey||O.metaKey)&&(O.preventDefault(),D());break;case"d":case"D":!O.ctrlKey&&!O.metaKey&&R("development");break}};return(()=>{var O=Vd(),V=O.firstChild;f(O,y(Yd,{get currentPage(){return r()},get totalPages(){return _()},get zoom(){return l()},get mode(){return c()},onPageChange:S,onZoomChange:C,onExport:D,onPrint:z,onModeChange:R,onFitScreen:A,onActualSize:M,onExit:E}),V),V.addEventListener("wheel",P),V.addEventListener("mouseleave",$),V.$$mouseup=$,V.$$mousemove=N,V.$$mousedown=q;var B=e;return typeof B=="function"?Vn(B,V):e=V,G(H=>(H=h()?"grabbing":"default")!=null?V.style.setProperty("cursor",H):V.style.removeProperty("cursor")),O})()};Ue(["mousedown","mousemove","mouseup"]);var Qd=x('<div class="preview-renderer w-full h-full relative">');const Kd=()=>{const{state:n}=at();return(()=>{var e=Qd();return f(e,y(Xd,{get elements(){return[...n.elements]},pageSize:{width:794,height:1123},pageCount:1})),e})()};var Jd=x("<div class=wizard-errors>"),Zd=x("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),eh=x("<div class=error-message>"),th=x("<div class=wizard-progress>"),nh=x("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),ih=x("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),sh=x("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),rh=x("<span class=feature-tag>"),ah=x("<div class=data-input-step><div class=step-header><h4></h4><p>"),lh=x("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),oh=x("<div class=file-error>"),ch=x('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),dh=x("<div class=field-error>"),hh=x("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),uh=x('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),gh=x('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),fh=x("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),vh=x("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),ph=x('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),mh=x("<span class=status-success>✅ JSON格式正确"),bh=x("<span class=status-error>❌ 格式错误"),yh=x("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),_h=x("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),xh=x(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),Sh=x("<div class=template-item><div class=template-name></div><div class=template-description>"),wh=x("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),$h=x("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Ch=x('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),kh=x("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),Th=x("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),Eh=x("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),Ph=x("<li>首次配置数据源时，建议先测试连接确保配置正确"),Ah=x("<li>测试过程会验证JSON格式和文件访问权限"),Rh=x("<li>预览功能可以帮助您确认数据结构是否符合预期"),Lh=x("<li>✅ 连接测试成功！您可以继续创建数据源"),Mh=x("<li>预览显示的是实际数据，创建后可用于报表设计"),Dh=x("<li>字段名称将用于数据绑定表达式"),Oh=x("<li>❌ 请检查JSON格式是否正确"),Ih=x("<li>如果是文件类型，请确认文件路径存在且可访问"),Nh=x("<li>可以返回上一步修改配置后重新测试"),zh=x("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),Fh=x("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),Gh=x("<span class=loading-spinner>⏳"),Bh=x("<span class=test-button-icon>🔌"),Uh=x("<div class=field-tag><span class=field-name>"),Hh=x("<th>"),qh=x("<tr>"),Wh=x("<td><div class=cell-content>"),jh=x("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),Yh=x('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),Vh=x('<button class="control-btn finish-btn">'),Xh=x("<span class=hint-text>选择您的JSON数据来源方式"),Ts=x("<span class=hint-text>"),Qh=x("<span class=hint-text>设置数据源名称和选项"),Kh=x('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),Jh=x("<span class=btn-loading>⏳"),Zh=x("<span class=btn-text>创建中..."),eu=x("<span class=btn-icon>✓"),tu=x("<span class=btn-text>创建数据源");function Ir(n){const[e,t]=J({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),i=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],s=Me(()=>{const u=e();switch(u.currentStep){case 1:return u.sourceType!==null;case 2:return r(u);case 3:return a(u);case 4:return l(u);default:return!1}}),r=u=>{if(u.sourceType==="file")return!!u.config.file_path?.trim();if(u.sourceType==="content"){const p=u.config.json_content?.trim();if(!p)return!1;try{return JSON.parse(p),!0}catch{return!1}}return!1},a=u=>{const p=u.name.trim();return!(p.length<2||p.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(p))},l=u=>!!u.testResult?.success,o=u=>{const p=e();t(m=>({...m,validation:{...m.validation,errors:[]}})),p.currentStep===1&&p.sourceType?t(m=>({...m,currentStep:u,config:{...m.config,source_type:p.sourceType}})):t(m=>({...m,currentStep:u}))},c=()=>{const u=e();u.currentStep<4&&s()&&o(u.currentStep+1)},d=()=>{const u=e();u.currentStep>1&&(u.currentStep===4?t(p=>({...p,currentStep:p.currentStep-1,testResult:null})):o(u.currentStep-1))},h=u=>{t(p=>({...p,...u}))},g=async()=>{const u=e();h({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const p={...u.config,source_type:u.sourceType};if(await Re.testConnection("json",p)){console.log("✅ 连接测试成功，获取预览数据...");const b=await Re.discoverSchema("json",p),_=`temp_${Date.now()}`,w=await Re.createDataSource(_,"json",p),S=await Re.getPreview(w,void 0,5);await Re.deleteDataSource(w),h({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:S.totalCount??S.total_rows??S.total_count??0,fields:b.columns.map(C=>C.name),sample_data:S.rows}},loading:!1})}}catch(p){console.error("❌ 连接测试失败:",p),h({testResult:{success:!1,message:"连接测试失败",error:p instanceof Error?p.message:String(p)},loading:!1})}},v=async()=>{const u=e();h({loading:!0});try{console.log("🔄 开始创建数据源...");const p={...u.config,source_type:u.sourceType},m=await Re.createDataSource(u.name,"json",p);console.log("✅ 数据源创建成功，ID:",m);try{await Je.setActiveDataSource(m),console.log("✅ 数据源自动激活成功")}catch(b){console.warn("⚠️ 数据源激活失败，但创建成功:",b)}n.onSuccess(),n.onBack()}catch(p){console.error("❌ 创建数据源失败:",p),h({validation:{isValid:!1,errors:[`创建失败: ${p}`],warnings:[]},loading:!1})}};return(()=>{var u=Zd(),p=u.firstChild,m=p.firstChild,b=m.nextSibling,_=b.firstChild,w=_.nextSibling,S=p.nextSibling;return Ae(m,"click",n.onBack),f(w,()=>i[e().currentStep-1]?.description),f(u,y(nu,{get currentStep(){return e().currentStep},stepInfo:i,onStepClick:o}),S),f(S,y(W,{get when(){return e().currentStep===1},get children(){return y(iu,{get selectedType(){return e().sourceType},onSelect:C=>h({sourceType:C,config:{...e().config,source_type:C}})})}}),null),f(S,y(W,{get when(){return e().currentStep===2},get children(){return y(su,{get sourceType(){return e().sourceType},get config(){return e().config},onConfigUpdate:C=>h({config:{...e().config,...C}})})}}),null),f(S,y(W,{get when(){return e().currentStep===3},get children(){return y(au,{get name(){return e().name},get config(){return e().config},onNameChange:C=>h({name:C}),onConfigUpdate:C=>h({config:{...e().config,...C}})})}}),null),f(S,y(W,{get when(){return e().currentStep===4},get children(){return y(ou,{get config(){return e().config},get testResult(){return e().testResult},get loading(){return e().loading},onTest:g})}}),null),f(u,y(cu,{get currentStep(){return e().currentStep},get canProceed(){return s()},get loading(){return e().loading},get testResult(){return e().testResult},onPrevious:d,onNext:c,onFinish:v}),null),f(u,y(W,{get when(){return e().validation.errors.length>0},get children(){var C=Jd();return f(C,y(pe,{get each(){return e().validation.errors},children:A=>(()=>{var M=eh();return f(M,A),M})()})),C}}),null),u})()}function nu(n){return(()=>{var e=th();return f(e,y(pe,{get each(){return n.stepInfo},children:t=>{const i=n.currentStep===t.step,s=n.currentStep>t.step,r=n.currentStep>=t.step;return(()=>{var a=nh(),l=a.firstChild,o=l.firstChild,c=l.nextSibling,d=c.firstChild,h=d.nextSibling;return a.$$click=()=>r&&n.onStepClick(t.step),Se(a,`progress-step ${i?"active":""} ${s?"completed":""}`),f(o,()=>s?"✓":t.step),f(d,()=>t.title),f(h,()=>t.description),a})()}})),e})()}function iu(n){const e=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var t=ih(),i=t.firstChild,s=i.nextSibling;return f(s,y(pe,{each:e,children:r=>(()=>{var a=sh(),l=a.firstChild,o=l.firstChild,c=o.nextSibling,d=l.nextSibling,h=d.nextSibling,g=h.nextSibling,v=g.firstChild;return a.$$click=()=>n.onSelect(r.type),f(o,()=>r.title),f(c,()=>r.description),f(d,y(pe,{get each(){return r.features},children:u=>(()=>{var p=rh();return f(p,u),p})()})),f(h,()=>r.example),v.addEventListener("change",()=>n.onSelect(r.type)),G(()=>Se(a,`source-option ${n.selectedType===r.type?"selected":""}`)),G(()=>v.checked=n.selectedType===r.type),a})()})),t})()}function su(n){return(()=>{var e=ah(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return f(i,()=>n.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),f(s,()=>n.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),f(e,y(W,{get when(){return n.sourceType==="file"},get children(){return y(ru,{get filePath(){return n.config.file_path||""},onFileSelect:r=>n.onConfigUpdate({file_path:r})})}}),null),f(e,y(W,{get when(){return n.sourceType==="content"},get children(){return y(lu,{get content(){return n.config.json_content||""},onContentChange:r=>n.onConfigUpdate({json_content:r})})}}),null),e})()}function ru(n){const[e,t]=J(!1),[i,s]=J(null),r=o=>{const d=o.target.files?.[0];d&&l(d)},a=o=>{o.preventDefault(),t(!1);const c=o.dataTransfer?.files?.[0];c&&l(c)},l=o=>{if(s(null),!o.name.endsWith(".json")){s("请选择JSON文件（.json格式）");return}if(o.size>10*1024*1024){s("文件大小不能超过10MB");return}const c=new FileReader;c.onload=d=>{try{const h=d.target?.result;JSON.parse(h),n.onFileSelect(o.name),console.log("✅ 文件选择成功:",o.name)}catch{s("文件内容不是有效的JSON格式")}},c.readAsText(o)};return(()=>{var o=ch(),c=o.firstChild,d=c.nextSibling,h=d.firstChild,g=h.firstChild,v=d.nextSibling;return c.addEventListener("drop",a),c.addEventListener("dragleave",()=>t(!1)),c.addEventListener("dragover",u=>{u.preventDefault(),t(!0)}),g.addEventListener("change",r),f(d,y(W,{get when(){return n.filePath},get children(){var u=lh(),p=u.firstChild,m=p.nextSibling,b=m.nextSibling;return f(m,()=>n.filePath),b.$$click=()=>n.onFileSelect(""),u}}),null),f(o,y(W,{get when(){return i()},get children(){var u=oh();return f(u,i),u}}),v),G(()=>Se(c,`file-drop-zone ${e()?"active":""}`)),o})()}function au(n){const[e,t]=J(null),i=r=>{n.onNameChange(r),r.trim().length===0?t("数据源名称不能为空"):r.trim().length<2?t("数据源名称至少需要2个字符"):r.trim().length>50?t("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(r.trim())?t(null):t("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},s=r=>{const a=parseInt(r);!isNaN(a)&&a>=10&&a<=3600&&n.onConfigUpdate({refresh_interval:a})};return(()=>{var r=ph(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.firstChild,d=c.nextSibling,h=d.firstChild,g=h.nextSibling,v=g.nextSibling,u=o.nextSibling,p=u.firstChild,m=p.nextSibling,b=m.firstChild,_=b.firstChild,w=_.nextSibling;return g.$$input=S=>i(S.currentTarget.value),f(d,y(W,{get when(){return e()},get children(){var S=dh();return f(S,e),S}}),v),f(l,y(W,{get when(){return n.config.source_type==="file"},get children(){var S=uh(),C=S.firstChild,A=C.nextSibling,M=A.firstChild,D=M.firstChild;return D.addEventListener("change",z=>n.onConfigUpdate({auto_refresh:z.currentTarget.checked})),f(S,y(W,{get when(){return n.config.auto_refresh},get children(){var z=hh(),E=z.firstChild,R=E.nextSibling,k=R.firstChild,q=k.nextSibling;return k.$$input=N=>s(N.currentTarget.value),q.addEventListener("change",N=>s(N.currentTarget.value)),G(()=>k.value=n.config.refresh_interval),G(()=>q.value=n.config.refresh_interval),z}}),null),G(()=>D.checked=n.config.auto_refresh),S}}),u),f(w,()=>n.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),f(m,y(W,{get when(){return n.config.source_type==="file"},get children(){return[(()=>{var S=gh(),C=S.firstChild,A=C.nextSibling;return f(A,()=>n.config.file_path||"(未选择文件)"),S})(),(()=>{var S=fh(),C=S.firstChild,A=C.nextSibling;return f(A,()=>n.config.auto_refresh?`✅ 每 ${n.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),S})()]}}),null),f(m,y(W,{get when(){return n.config.source_type==="content"},get children(){var S=vh(),C=S.firstChild,A=C.nextSibling,M=A.firstChild;return f(A,()=>n.config.json_content?.length||0,M),S}}),null),G(()=>Se(g,`name-input ${e()?"error":""}`)),G(()=>g.value=n.name),r})()}function lu(n){const[e,t]=J(null),[i,s]=J(!1),r=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],a=o=>{if(n.onContentChange(o),o.trim())try{JSON.parse(o),t(null)}catch(c){t(c instanceof Error?c.message:"无效的JSON格式")}else t(null)},l=o=>{n.onContentChange(o.content),t(null),s(!1)};return(()=>{var o=xh(),c=o.firstChild,d=c.firstChild,h=d.nextSibling,g=h.nextSibling,v=c.nextSibling,u=v.firstChild,p=v.nextSibling;return d.$$click=()=>s(!i()),h.$$click=()=>n.onContentChange(""),f(g,y(W,{get when(){return Ce(()=>!e())()&&n.content.trim()},get children(){return mh()}}),null),f(g,y(W,{get when(){return e()},get children(){return bh()}}),null),f(o,y(W,{get when(){return i()},get children(){var m=yh(),b=m.firstChild,_=b.nextSibling;return f(_,y(pe,{each:r,children:w=>(()=>{var S=Sh(),C=S.firstChild,A=C.nextSibling;return S.$$click=()=>l(w),f(C,()=>w.name),f(A,()=>w.description),S})()})),m}}),v),u.$$input=m=>a(m.currentTarget.value),f(o,y(W,{get when(){return e()},get children(){var m=_h(),b=m.firstChild,_=b.nextSibling;return f(_,e),m}}),p),G(m=>{var b=!n.content,_=`json-textarea ${e()?"error":""}`;return b!==m.e&&(h.disabled=m.e=b),_!==m.t&&Se(u,m.t=_),m},{e:void 0,t:void 0}),G(()=>u.value=n.content),o})()}function ou(n){const[e,t]=J(!1),i=()=>n.loading?"🔄":n.testResult?n.testResult.success?"✅":"❌":"⚡",s=()=>n.loading?"测试连接中...":n.testResult?n.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",r=()=>n.loading?"testing":n.testResult?n.testResult.success?"success":"error":"ready",a=l=>typeof l=="object"?JSON.stringify(l,null,2):String(l);return(()=>{var l=Fh(),o=l.firstChild,c=o.nextSibling,d=c.firstChild,h=d.firstChild,g=h.firstChild,v=g.firstChild,u=v.nextSibling,p=g.nextSibling,m=d.nextSibling,b=m.firstChild,_=b.nextSibling;return f(v,i),f(u,s),Ae(p,"click",n.onTest),f(p,(()=>{var w=Ce(()=>!!n.loading);return()=>w()?[Gh(),"测试中..."]:[Bh(),"测试连接"]})()),f(d,y(W,{get when(){return n.testResult},get children(){var w=$h(),S=w.firstChild,C=S.firstChild,A=C.nextSibling;return f(C,i),f(A,()=>n.testResult.message),f(w,y(W,{get when(){return n.testResult.error},get children(){var M=wh(),D=M.firstChild,z=D.nextSibling;return f(z,()=>n.testResult.error),M}}),null),G(()=>Se(w,`test-result ${r()}`)),w}}),null),f(c,y(W,{get when(){return n.testResult?.success&&n.testResult.preview},get children(){var w=Eh(),S=w.firstChild,C=S.firstChild,A=C.nextSibling,M=A.firstChild,D=M.firstChild,z=D.nextSibling,E=M.nextSibling,R=E.firstChild,k=R.nextSibling,q=S.nextSibling,N=q.firstChild,$=N.nextSibling,P=q.nextSibling,X=P.firstChild,F=X.nextSibling,O=F.firstChild,V=O.firstChild,B=V.firstChild,H=V.nextSibling,j=P.nextSibling,de=j.firstChild,me=de.firstChild;return f(z,()=>n.testResult.preview.record_count),f(k,()=>n.testResult.preview.fields.length),f($,y(pe,{get each(){return n.testResult.preview.fields},children:fe=>(()=>{var ee=Uh(),oe=ee.firstChild;return f(oe,fe),ee})()})),f(B,y(pe,{get each(){return n.testResult.preview.fields},children:fe=>(()=>{var ee=Hh();return f(ee,fe),ee})()})),f(H,y(pe,{get each(){return n.testResult.preview.sample_data},children:fe=>(()=>{var ee=qh();return f(ee,y(pe,{get each(){return n.testResult.preview.fields},children:oe=>(()=>{var ge=Wh(),he=ge.firstChild;return f(he,(()=>{var te=Ce(()=>fe[oe]!==void 0);return()=>te()?a(fe[oe]):"-"})()),ge})()})),ee})()})),de.$$click=()=>t(!e()),f(me,()=>e()?"▼":"▶"),f(j,y(W,{get when(){return e()},get children(){var fe=Th(),ee=fe.firstChild,oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling,te=oe.nextSibling;return f(he,()=>n.config.source_type==="file"?"JSON文件":"JSON内容"),f(ee,y(W,{get when(){return n.config.source_type==="file"},get children(){return[(()=>{var ne=Ch(),ve=ne.firstChild,be=ve.nextSibling;return f(be,()=>n.config.file_path),ne})(),(()=>{var ne=kh(),ve=ne.firstChild,be=ve.nextSibling;return f(be,()=>n.config.auto_refresh?"已启用":"已禁用"),ne})()]}}),te),fe}}),null),w}}),m),f(_,y(W,{get when(){return!n.testResult},get children(){return[Ph(),Ah(),Rh()]}}),null),f(_,y(W,{get when(){return n.testResult?.success},get children(){return[Lh(),Mh(),Dh()]}}),null),f(_,y(W,{get when(){return n.testResult&&!n.testResult.success},get children(){return[Oh(),Ih(),Nh()]}}),null),f(c,y(W,{get when(){return n.config.source_type==="file"},get children(){return zh()}}),null),G(w=>{var S=`test-button ${r()}`,C=n.loading;return S!==w.e&&Se(p,w.e=S),C!==w.t&&(p.disabled=w.t=C),w},{e:void 0,t:void 0}),l})()}function cu(n){const e=r=>{switch(r){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${r}`}},t=()=>n.currentStep>1,i=()=>n.currentStep<4&&n.canProceed,s=()=>n.currentStep===4&&n.canProceed;return(()=>{var r=Kh(),a=r.firstChild,l=a.firstChild,o=l.firstChild,c=o.nextSibling;c.nextSibling;var d=a.nextSibling,h=d.firstChild,g=d.nextSibling;return f(l,()=>n.currentStep,c),f(l,()=>e(n.currentStep),null),f(a,y(W,{get when(){return!n.canProceed&&n.currentStep<4},get children(){return jh()}}),null),Ae(h,"click",n.onPrevious),f(d,y(W,{get when(){return n.currentStep<4},get children(){var v=Yh();return Ae(v,"click",n.onNext),G(()=>v.disabled=!i()||n.loading),v}}),null),f(d,y(W,{get when(){return n.currentStep===4},get children(){var v=Vh();return Ae(v,"click",n.onFinish),f(v,(()=>{var u=Ce(()=>!!n.loading);return()=>u()?[Jh(),Zh()]:[eu(),tu()]})()),G(()=>v.disabled=!s()||n.loading),v}}),null),f(g,y(W,{get when(){return n.currentStep===1},get children(){return Xh()}}),null),f(g,y(W,{get when(){return n.currentStep===2},get children(){var v=Ts();return f(v,()=>n.testResult?.success?"数据格式验证成功":"请提供JSON数据内容"),v}}),null),f(g,y(W,{get when(){return n.currentStep===3},get children(){return Qh()}}),null),f(g,y(W,{get when(){return n.currentStep===4},get children(){var v=Ts();return f(v,()=>n.testResult?.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"),v}}),null),G(()=>h.disabled=!t()||n.loading),r})()}Ue(["click","input"]);var du=x("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),hu=x("<div class=error-message>"),uu=x("<div class=loading-message>加载中..."),gu=x("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),fu=x("<div class=sources-grid>"),vu=x("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),pu=x("<span class=active-badge title=当前激活>当前"),mu=x('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),bu=x("<span class=changes-indicator>● 有未保存的更改"),yu=x("<div class=error-details>"),_u=x("<div><div class=result-message> "),xu=x("<div class=error-message>❌ "),Su=x("<button type=button class=reset-btn>重置更改"),wu=x('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),$u=x("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),Cu=x("<th>"),ku=x("<tr>"),Tu=x("<td>");const Eu=n=>{const e=(n.type_name||n.provider_type||n.providerType||"").toLowerCase();return e.includes("database_mysql")?"MySQL":e.includes("database_postgresql")?"PostgreSQL":e==="json"?"JSON":e==="csv"?"CSV":e==="excel"?"Excel":e.startsWith("api")?"API":e.startsWith("database")?"Database":n.type_name||n.provider_type||n.providerType||"Unknown"};function Pu(n){const[e,t]=J([]),[i,s]=J([]),[r,a]=J("list"),[l,o]=J(null),[c,d]=J(null),[h,g]=J(!1),[v,u]=J(null),[p,m]=J(null);et(async()=>{try{await b(),await _();const z=Je.subscribe(E=>{m(E?.dataSource.id||null)});m(Je.getCurrentContext()?.dataSource.id||null),$t(z)}catch(z){console.error("🚨 DataSourcesPanel初始化失败:",z),u(`数据源模块初始化失败: ${z}`)}});const b=async()=>{try{g(!0),console.log("🔄 开始加载数据源列表...");const z=await Re.listDataSources();console.log("✅ 数据源列表加载成功:",z),t(z),u(null)}catch(z){console.error("❌ 加载数据源失败:",z),u(`加载数据源失败: ${z}`)}finally{g(!1)}},_=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const z=await Re.getAvailableTypes();console.log("✅ 数据源类型加载成功:",z),s(z)}catch(z){console.error("❌ 加载数据源类型失败:",z)}},w=()=>{a("add"),o(null)},S=z=>{o(z),a("edit")},C=async z=>{try{g(!0),u(null),o(z),console.log("🔄 开始预览数据源:",z.name),z.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",z.status),u(`数据源状态为 ${z.status}，可能无法预览数据`));const E=await Re.getPreview(z.id);d(E),a("preview"),console.log("✅ 数据预览加载成功:",E)}catch(E){console.error("❌ 数据预览失败:",E);const R=`预览数据源 "${z.name}" 失败: ${E}`;u(R);const k={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},q=String(E).toLowerCase(),N=Object.keys(k).find($=>q.includes($));N&&u(`预览失败: ${k[N]}`)}finally{g(!1)}},A=async z=>{if(confirm("确定要删除这个数据源吗？"))try{await Re.deleteDataSource(z),await b()}catch(E){u(`删除数据源失败: ${E}`)}},M=async z=>{try{g(!0),u(null),await Je.setActiveDataSource(z.id)}catch(E){console.error("❌ 激活数据源失败:",E),u(`激活数据源失败: ${E}`)}finally{g(!1)}},D=async z=>{try{g(!0),u(null),console.log("🔄 开始测试数据源连接:",z);const E=e().find(q=>q.id===z);if(!E){const q=`数据源不存在: ${z}`;console.error("❌",q),u(q);return}console.log("📋 数据源信息:",{id:E.id,name:E.name,providerType:E.providerType||E.provider_type,config:E.config});let R=E.providerType||E.provider_type||E.type_name;(E.name.includes("MySQL")||E.name.includes("数据库")||JSON.stringify(E.config).includes("mysql")||JSON.stringify(E.config).includes("3306"))&&(R="database",console.log("🗄️ 检测到数据库类型，使用provider_type: database")),console.log("🔍 调用测试连接API:",{providerType:R,config:E.config});const k=await Re.testConnection(R,E.config||{});console.log("📨 API返回结果:",k),k?(console.log("✅ 数据源连接测试成功:",z),alert(`✅ 数据源 "${E.name}" 连接测试成功！

🎉 数据库连接正常，可以正常使用`)):(console.log("❌ 数据源连接测试失败:",z),alert(`❌ 数据源 "${E.name}" 连接测试失败

请检查配置信息是否正确`))}catch(E){console.error("❌ 测试连接时发生错误:",E),console.error("❌ 错误详情:",{error:E,errorType:typeof E,errorString:String(E),errorJSON:JSON.stringify(E,null,2)});const R=e().find(q=>q.id===z),k=`测试连接失败: ${E}`;u(k),!E||String(E)===""||String(E)==="null"?alert(`❌ 数据源 "${R?.name||z}" 连接测试遇到未知错误

请检查：
• 开发者工具控制台的详细错误信息
• 后端服务是否正常运行
• 配置参数是否正确`):alert(`❌ 数据源 "${R?.name||z}" 连接测试失败:

${E}

💡 如果是空错误，请检查开发者工具控制台获取详细信息`)}finally{g(!1)}};return y(W,{get when(){return n.isOpen},get children(){var z=du(),E=z.firstChild,R=E.nextSibling,k=R.firstChild,q=k.nextSibling,N=q.nextSibling,$=R.nextSibling;return Ae(N,"click",n.onClose),f($,y(W,{get when(){return r()==="list"},get children(){return y(Au,{get dataSources(){return e()},get loading(){return h()},get error(){return v()},onAdd:w,onEdit:S,onPreview:C,onDelete:A,onActivate:M,onTestConnection:D,onRefresh:b,get activeId(){return p()}})}}),null),f($,y(W,{get when(){return r()==="add"},get children(){return y(Ir,{get availableTypes(){return i()},onBack:()=>a("list"),onSuccess:b})}}),null),f($,y(W,{get when(){return Ce(()=>r()==="edit")()&&l()},get children(){return y(Ru,{get dataSource(){return l()},onBack:()=>a("list"),onSuccess:b})}}),null),f($,y(W,{get when(){return Ce(()=>!!(r()==="preview"&&l()))()&&c()},get children(){return y(Lu,{get dataSource(){return l()},get data(){return c()},onBack:()=>a("list")})}}),null),z}})}function Au(n){const e=i=>{switch(i){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},t=i=>new Date(i).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var i=vu(),s=i.firstChild,r=s.firstChild,a=r.firstChild,l=a.firstChild,o=l.nextSibling;o.nextSibling;var c=a.nextSibling,d=r.nextSibling;return f(a,()=>n.dataSources.length,o),Ae(c,"click",n.onRefresh),Ae(d,"click",n.onAdd),f(i,y(W,{get when(){return n.error},get children(){var h=hu();return f(h,()=>n.error),h}}),null),f(i,y(W,{get when(){return n.loading},get children(){return uu()}}),null),f(i,y(W,{get when(){return!n.loading&&n.dataSources.length===0},get children(){var h=gu(),g=h.firstChild,v=g.nextSibling;return Ae(v,"click",n.onAdd),h}}),null),f(i,y(W,{get when(){return!n.loading&&n.dataSources.length>0},get children(){var h=fu();return f(h,y(pe,{get each(){return n.dataSources},children:g=>(()=>{var v=mu(),u=v.firstChild,p=u.firstChild,m=p.firstChild,b=m.nextSibling,_=p.nextSibling,w=u.nextSibling,S=w.firstChild,C=S.firstChild,A=C.nextSibling,M=S.nextSibling,D=M.firstChild,z=D.nextSibling,E=w.nextSibling,R=E.firstChild,k=R.nextSibling,q=k.nextSibling,N=q.nextSibling,$=N.nextSibling;return f(m,()=>g.name,null),f(m,y(W,{get when(){return n.activeId===g.id},get children(){return pu()}}),null),f(b,()=>Eu(g)),f(A,()=>t(g.createdAt||g.created_at)),f(z,()=>t(g.lastUpdated||g.last_updated)),R.$$click=()=>n.onPreview(g),k.$$click=()=>n.onActivate(g),q.$$click=()=>n.onTestConnection(g.id),N.$$click=()=>n.onEdit(g),$.$$click=()=>n.onDelete(g.id),G(P=>{var X=n.activeId===g.id?"true":"false",F=e(g.status),O=`状态: ${g.status}`,V=g.status!=="active",B=n.activeId===g.id;return X!==P.e&&Q(v,"data-active",P.e=X),F!==P.t&&((P.t=F)!=null?_.style.setProperty("background-color",F):_.style.removeProperty("background-color")),O!==P.a&&Q(_,"title",P.a=O),V!==P.o&&(R.disabled=P.o=V),B!==P.i&&(k.disabled=P.i=B),P},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),v})()})),h}}),null),G(h=>{var g=n.loading,v=n.loading?"正在刷新数据源列表":"刷新数据源列表",u=n.loading?"正在刷新...":"刷新数据源列表";return g!==h.e&&(c.disabled=h.e=g),v!==h.t&&Q(c,"aria-label",h.t=v),u!==h.a&&Q(c,"title",h.a=u),h},{e:void 0,t:void 0,a:void 0}),i})()}function Ru(n){const[e,t]=J({name:n.dataSource.name,config:n.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[i]=J(JSON.stringify(n.dataSource.config||{})),s=()=>{const d=e(),h=d.name!==n.dataSource.name,g=JSON.stringify(d.config)!==i();t(v=>({...v,hasChanges:h||g}))},r=d=>{t(h=>({...h,name:d})),s()},a=d=>{t(h=>({...h,config:d})),s()},l=async()=>{const d=e();t(h=>({...h,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await Re.testConnection(n.dataSource.providerType||n.dataSource.provider_type,d.config)&&(console.log("✅ 连接测试成功"),t(g=>({...g,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(h){console.error("❌ 连接测试失败:",h),t(g=>({...g,testResult:{success:!1,message:"连接测试失败",error:h instanceof Error?h.message:String(h)},loading:!1}))}},o=async()=>{const d=e();if(!d.hasChanges){n.onBack();return}if(!d.name.trim()){t(h=>({...h,error:"数据源名称不能为空"}));return}try{t(h=>({...h,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await Re.updateConfig(n.dataSource.id,d.config),d.name!==n.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),t(h=>({...h,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),n.onSuccess(),n.onBack()}catch(h){console.error("❌ 更新数据源失败:",h),t(g=>({...g,error:`更新失败: ${h}`,loading:!1}))}},c=()=>{t(d=>({...d,name:n.dataSource.name,config:n.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var d=wu(),h=d.firstChild,g=h.firstChild,v=g.nextSibling,u=v.firstChild,p=u.nextSibling,m=p.firstChild,b=m.nextSibling;b.firstChild;var _=h.nextSibling,w=_.firstChild,S=w.firstChild,C=S.nextSibling,A=C.firstChild,M=A.nextSibling,D=w.nextSibling,z=D.firstChild;z.firstChild;var E=z.nextSibling,R=E.firstChild,k=R.nextSibling,q=D.nextSibling,N=q.firstChild,$=N.firstChild,P=$.nextSibling,X=q.nextSibling,F=X.firstChild,O=F.nextSibling,V=O.firstChild,B=V.firstChild,H=B.nextSibling,j=V.nextSibling,de=j.firstChild,me=de.nextSibling,fe=j.nextSibling,ee=fe.firstChild,oe=ee.nextSibling,ge=X.nextSibling,he=ge.firstChild,te=he.nextSibling;return Ae(g,"click",n.onBack),f(m,()=>n.dataSource.providerType||n.dataSource.type_name),f(b,()=>n.dataSource.id,null),M.$$input=ne=>r(ne.currentTarget.value),f(z,y(W,{get when(){return e().hasChanges},get children(){return bu()}}),null),k.$$input=ne=>{try{const ve=JSON.parse(ne.currentTarget.value);a(ve),t(be=>({...be,error:null}))}catch{t(be=>({...be,error:"配置格式错误，请检查JSON语法"}))}},P.$$click=l,f(P,()=>e().loading?"测试中...":"测试连接"),f(q,y(W,{get when(){return e().testResult},get children(){var ne=_u(),ve=ne.firstChild,be=ve.firstChild;return f(ve,()=>e().testResult?.success?"✅":"❌",be),f(ve,()=>e().testResult?.message,null),f(ne,y(W,{get when(){return e().testResult?.error},get children(){var ke=yu();return f(ke,()=>e().testResult?.error),ke}}),null),G(()=>Se(ne,`test-result ${e().testResult?.success?"success":"error"}`)),ne}}),null),f(H,()=>n.dataSource.status==="active"?"✅ 活跃":n.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),f(me,()=>new Date(n.dataSource.createdAt||n.dataSource.created_at).toLocaleString("zh-CN")),f(oe,()=>new Date(n.dataSource.lastUpdated||n.dataSource.last_updated).toLocaleString("zh-CN")),f(_,y(W,{get when(){return e().error},get children(){var ne=xu();return ne.firstChild,f(ne,()=>e().error,null),ne}}),ge),Ae(he,"click",n.onBack),f(ge,y(W,{get when(){return e().hasChanges},get children(){var ne=Su();return ne.$$click=c,G(()=>ne.disabled=e().loading),ne}}),te),te.$$click=o,f(te,(()=>{var ne=Ce(()=>!!e().loading);return()=>ne()?"保存中...":e().hasChanges?"保存更改":"无更改"})()),G(ne=>{var ve=e().error&&!e().name.trim()?"error":"",be=e().error&&e().error?.includes("配置格式")?"error":"",ke=e().loading,_e=`status-value status-${n.dataSource.status}`,Pe=`save-btn ${e().hasChanges?"has-changes":""}`,ue=e().loading;return ve!==ne.e&&Se(M,ne.e=ve),be!==ne.t&&Se(k,ne.t=be),ke!==ne.a&&(P.disabled=ne.a=ke),_e!==ne.o&&Se(H,ne.o=_e),Pe!==ne.i&&Se(te,ne.i=Pe),ue!==ne.n&&(te.disabled=ne.n=ue),ne},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),G(()=>M.value=e().name),G(()=>k.value=JSON.stringify(e().config,null,2)),d})()}function Lu(n){return(()=>{var e=$u(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;s.firstChild;var r=s.nextSibling,a=r.firstChild,l=a.nextSibling,o=l.nextSibling,c=o.nextSibling;c.nextSibling;var d=t.nextSibling,h=d.firstChild,g=h.firstChild,v=g.firstChild,u=g.nextSibling;return Ae(i,"click",n.onBack),f(s,()=>n.dataSource.name,null),f(r,()=>n.data.totalCount??n.data.total_rows,l),f(r,()=>n.data.rows.length,c),f(v,y(pe,{get each(){return n.data.columns},children:p=>(()=>{var m=Cu();return f(m,p),m})()})),f(u,y(pe,{get each(){return n.data.rows.slice(0,50)},children:p=>(()=>{var m=ku();return f(m,y(pe,{get each(){return n.data.columns},children:b=>(()=>{var _=Tu();return f(_,(()=>{var w=Ce(()=>typeof p[b]=="object");return()=>w()?JSON.stringify(p[b]):String(p[b]||"")})()),_})()})),m})()})),e})()}Ue(["click","input"]);var Mu=x("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Du=x("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Ou=x("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),Iu=x("<div class=current-record>"),Nu=x("<div class=empty-record>暂无记录数据"),zu=x("<div class=available-fields>"),Fu=x("<div class=no-fields>暂无可用字段"),Gu=x('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),Bu=x("<div class=record-field><div class=field-key>:</div><div class=field-value>"),Uu=x("<div class=field-display-name>"),Hu=x("<div class=field-sample>示例: "),qu=x("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),Wu=x("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),ju=x('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const Es=()=>{const[n,e]=J(null),[t,i]=J(!1);mn(()=>{const c=Je.subscribe(d=>{e(d)});return e(Je.getCurrentContext()),c});const s=Me(()=>{const c=n();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),r=async()=>{i(!0);try{await Je.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{i(!1)}},a=async()=>{i(!0);try{await Je.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{i(!1)}},l=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),o=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Ou(),d=c.firstChild,h=d.firstChild,g=h.nextSibling,v=g.firstChild,u=v.nextSibling;return f(v,()=>s().icon),f(u,()=>s().text),f(c,y(W,{get when(){return n()},children:p=>(()=>{var m=Gu(),b=m.firstChild,_=b.firstChild,w=_.nextSibling,S=w.firstChild,C=S.firstChild,A=C.nextSibling,M=S.nextSibling,D=M.firstChild,z=D.nextSibling,E=M.nextSibling,R=E.firstChild,k=R.nextSibling,q=b.nextSibling,N=q.firstChild,$=N.nextSibling,P=$.firstChild,X=P.nextSibling,F=X.firstChild,O=X.nextSibling,V=q.nextSibling;V.firstChild;var B=V.nextSibling,H=B.firstChild,j=H.firstChild,de=j.nextSibling,me=de.firstChild,fe=me.nextSibling;return fe.nextSibling,f(A,()=>p().dataSource.name),f(z,()=>p().dataSource.type.toUpperCase()),f(k,()=>p().dataSource.id),P.$$click=a,f(X,()=>p().currentRecord.index+1,F),f(X,()=>p().currentRecord.total,null),O.$$click=r,f(V,y(W,{get when(){return Object.keys(p().currentRecord.data).length>0},get children(){var ee=Iu();return f(ee,y(pe,{get each(){return Object.entries(p().currentRecord.data)},children:([oe,ge])=>(()=>{var he=Bu(),te=he.firstChild,ne=te.firstChild,ve=te.nextSibling;return f(te,oe,ne),f(ve,()=>l(ge)),he})()})),ee}}),null),f(V,y(W,{get when(){return Object.keys(p().currentRecord.data).length===0},get children(){return Nu()}}),null),f(de,()=>p().fields.length,fe),f(B,y(W,{get when(){return p().fields.length>0},get children(){var ee=zu();return f(ee,y(pe,{get each(){return p().fields},children:oe=>(()=>{var ge=qu(),he=ge.firstChild,te=he.firstChild,ne=te.nextSibling,ve=ne.firstChild,be=ve.nextSibling;be.nextSibling;var ke=he.nextSibling,_e=ke.firstChild,Pe=_e.nextSibling;return f(te,()=>oe.name),f(ne,()=>o(oe.type),be),f(ge,y(W,{get when(){return oe.displayName&&oe.displayName!==oe.name},get children(){var ue=Uu();return f(ue,()=>oe.displayName),ue}}),ke),f(ge,y(W,{get when(){return oe.sample!==void 0},get children(){var ue=Hu();return ue.firstChild,f(ue,()=>l(oe.sample),null),ue}}),ke),f(Pe,()=>`{${oe.name}}`),ge})()})),ee}}),null),f(B,y(W,{get when(){return p().fields.length===0},get children(){return Fu()}}),null),f(m,y(W,{get when(){return p().error},children:ee=>(()=>{var oe=ju(),ge=oe.firstChild,he=ge.nextSibling,te=he.firstChild;te.firstChild;var ne=te.nextSibling;return ne.firstChild,f(te,()=>ee().type,null),f(ne,()=>ee().message,null),f(he,y(W,{get when(){return ee().details},get children(){var ve=Wu(),be=ve.firstChild,ke=be.nextSibling;return f(ke,()=>JSON.stringify(ee().details,null,2)),ve}}),null),oe})()}),null),G(ee=>{var oe=t()||p().currentRecord.index<=0,ge=t()||p().currentRecord.index>=p().currentRecord.total-1;return oe!==ee.e&&(P.disabled=ee.e=oe),ge!==ee.t&&(O.disabled=ee.t=ge),ee},{e:void 0,t:void 0}),m})()}),null),f(c,y(W,{get when(){return!n()},get children(){return Mu()}}),null),f(c,y(W,{get when(){return t()},get children(){return Du()}}),null),G(p=>(p=s().color)!=null?u.style.setProperty("color",p):u.style.removeProperty("color")),c})()};Ue(["click"]);var Yu=x(`<div class=sql-editor><div class=editor-toolbar><div class=toolbar-left><span class=editor-label>SQL编辑器</span><span class=database-type>(<!>)</span></div><div class=toolbar-right><span class=cursor-position>行 <!>, 列 </span><span class=character-count> 字符</span></div></div><div class=template-toolbar><span class=template-label>模板:</span></div><div><textarea class=sql-textarea placeholder="请输入SQL查询语句...\r
\r
示例:\r
SELECT u.username, u.email, COUNT(o.id) as order_count\r
FROM users u\r
LEFT JOIN orders o ON u.id = o.user_id\r
WHERE u.created_at >= '2024-01-01'\r
GROUP BY u.id, u.username, u.email\r
ORDER BY order_count DESC\r
LIMIT 10;"rows=15></textarea><div class=line-numbers></div></div><div class=editor-help><div class=help-item><kbd>Tab</kbd> 缩进</div><div class=help-item><kbd>Ctrl+F</kbd> 格式化</div><div class=help-item><kbd>Enter</kbd> 自动缩进</div></div><style>
        .sql-editor {
          display: flex;
          flex-direction: column;
          border: 1px solid #ddd;
          border-radius: 6px;
          background: white;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .editor-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          background: #f8f9fa;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .toolbar-left {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .editor-label {
          font-weight: bold;
          color: #2c3e50;
        }

        .database-type {
          background: #3498db;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
          gap: 12px;
          color: #666;
        }

        .template-toolbar {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f1f3f5;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .template-label {
          color: #666;
          font-weight: bold;
        }

        .template-btn {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 4px;
          padding: 4px 8px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .template-btn:hover:not(:disabled) {
          background: #dee2e6;
          border-color: #adb5bd;
        }

        .template-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .editor-container {
          position: relative;
          flex: 1;
          min-height: 300px;
        }

        .editor-container.focused {
          box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editor-container.disabled {
          opacity: 0.6;
          pointer-events: none;
        }

        .sql-textarea {
          width: 100%;
          height: 100%;
          padding: 12px 12px 12px 48px;
          border: none;
          outline: none;
          resize: vertical;
          font-family: inherit;
          font-size: 14px;
          line-height: 1.5;
          background: transparent;
        }

        .line-numbers {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 36px;
          background: #f8f9fa;
          border-right: 1px solid #e9ecef;
          padding: 12px 4px;
          user-select: none;
          overflow: hidden;
        }

        .line-number {
          text-align: right;
          font-size: 12px;
          color: #6c757d;
          line-height: 1.5;
          padding-right: 8px;
        }

        .editor-help {
          display: flex;
          justify-content: center;
          gap: 16px;
          padding: 6px;
          background: #f8f9fa;
          border-top: 1px solid #ddd;
          font-size: 11px;
          color: #666;
        }

        .help-item {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        kbd {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 3px;
          padding: 2px 4px;
          font-size: 10px;
          font-family: inherit;
        }
      `),Vu=x("<button class=template-btn>"),Xu=x("<div class=line-number>");function Qu(n){let e;const[t,i]=J(!1),[s,r]=J({line:1,column:1}),a=g=>{const v=g.target;n.onSQLChange(v.value),l()},l=()=>{if(!e)return;const g=e.selectionStart,u=n.sql.substring(0,g).split(`
`);r({line:u.length,column:(u[u.length-1]||"").length+1})},o=g=>{if(!e||n.disabled)return;const v=g.target,u=v.selectionStart,p=v.selectionEnd;if(g.key==="Tab"){g.preventDefault();const m=n.sql.substring(0,u)+"  "+n.sql.substring(p);n.onSQLChange(m),setTimeout(()=>{e&&(e.selectionStart=e.selectionEnd=u+2,l())},0)}else if(g.key==="Enter"){const m=n.sql.substring(0,u).split(`
`),b=m[m.length-1],_=b?.match(/^\s*/)?.[0]||"",w=b?.trim().toUpperCase()||"",C=["SELECT","FROM","WHERE","GROUP BY","ORDER BY","HAVING"].some(A=>w.endsWith(A)||w.includes(A+" "))?_+"  ":_;if(C){g.preventDefault();const A=n.sql.substring(0,u)+`
`+C+n.sql.substring(p);n.onSQLChange(A),setTimeout(()=>{if(e){const M=u+1+C.length;e.selectionStart=e.selectionEnd=M,l()}},0)}}},c=g=>{(g.ctrlKey||g.metaKey)&&g.key==="f"&&(g.preventDefault(),console.log("格式化快捷键触发"))},d=g=>{if(!e||n.disabled)return;const v=e.selectionStart,u=e.selectionEnd,p=n.sql.substring(0,v)+g+n.sql.substring(u);n.onSQLChange(p),setTimeout(()=>{e&&(e.focus(),e.selectionStart=e.selectionEnd=v+g.length,l())},0)};et(()=>{l(),e&&(e.addEventListener("selectionchange",l),e.addEventListener("click",l))});const h=[{name:"基础查询",template:"SELECT * FROM table_name WHERE condition;"},{name:"联表查询",template:`SELECT t1.*, t2.*
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.table1_id
WHERE condition;`},{name:"聚合查询",template:`SELECT column, COUNT(*), AVG(value)
FROM table_name
GROUP BY column
HAVING COUNT(*) > 1
ORDER BY column;`},{name:"子查询",template:`SELECT *
FROM table1
WHERE column IN (
  SELECT column
  FROM table2
  WHERE condition
);`}];return(()=>{var g=Yu(),v=g.firstChild,u=v.firstChild,p=u.firstChild,m=p.nextSibling,b=m.firstChild,_=b.nextSibling;_.nextSibling;var w=u.nextSibling,S=w.firstChild,C=S.firstChild,A=C.nextSibling;A.nextSibling;var M=S.nextSibling,D=M.firstChild,z=v.nextSibling;z.firstChild;var E=z.nextSibling,R=E.firstChild,k=R.nextSibling;f(m,()=>n.databaseType.toUpperCase(),_),f(S,()=>s().line,A),f(S,()=>s().column,null),f(M,()=>n.sql.length,D),f(z,()=>h.map(N=>(()=>{var $=Vu();return $.$$click=()=>d(N.template),f($,()=>N.name),G(P=>{var X=n.disabled,F=`插入${N.name}模板`;return X!==P.e&&($.disabled=P.e=X),F!==P.t&&Q($,"title",P.t=F),P},{e:void 0,t:void 0}),$})()),null),R.addEventListener("blur",()=>i(!1)),R.addEventListener("focus",()=>i(!0)),R.addEventListener("keypress",c),R.$$keydown=o,R.$$input=a;var q=e;return typeof q=="function"?Vn(q,R):e=R,Q(R,"spellcheck",!1),f(k,()=>n.sql.split(`
`).map((N,$)=>(()=>{var P=Xu();return f(P,$+1),P})())),G(N=>{var $=`editor-container ${t()?"focused":""} ${n.disabled?"disabled":""}`,P=n.disabled;return $!==N.e&&Se(E,N.e=$),P!==N.t&&(R.disabled=N.t=P),N},{e:void 0,t:void 0}),G(()=>R.value=n.sql),g})()}Ue(["input","keydown","click"]);var Ku=x("<div class=empty-message><p>请选择要查询的字段</p><button>自动选择字段"),Ju=x("<div class=builder-section><div class=section-header><h4>🔗 表关联 (JOIN)</h4><button class=add-btn>+ 添加关联</button></div><div class=joins-list>"),Zu=x(`<div class=visual-query-builder><div class=query-options><label class=option-checkbox><input type=checkbox><span>去重查询 (DISTINCT)</span></label></div><div class=builder-section><div class=section-header><h4>📋 选择字段 (SELECT)</h4><button class=add-btn>+ 添加字段</button></div><div class=fields-list></div></div><div class=builder-section><div class=section-header><h4>🔍 筛选条件 (WHERE)</h4><button class=add-btn>+ 添加条件</button></div><div class=where-list></div></div><div class=builder-section><div class=section-header><h4>⚙️ 其他选项</h4></div><div class=options-grid><div class=option-group><label>限制行数 (LIMIT):</label><input type=number placeholder=无限制 min=1 max=10000></div></div></div><style>
        .visual-query-builder {
          display: flex;
          flex-direction: column;
          gap: 20px;
          padding: 16px;
          background: #f8f9fa;
          border-radius: 8px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .query-options {
          display: flex;
          gap: 16px;
        }

        .option-checkbox {
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
        }

        .builder-section {
          background: white;
          border-radius: 6px;
          padding: 16px;
          border: 1px solid #dee2e6;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e9ecef;
        }

        .section-header h4 {
          margin: 0;
          color: #2c3e50;
          font-size: 14px;
        }

        .add-btn {
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
        }

        .add-btn:hover:not(:disabled) {
          background: #218838;
        }

        .field-item, .join-item, .where-item {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
          padding: 8px;
          background: #f8f9fa;
          border-radius: 4px;
          flex-wrap: wrap;
        }

        .join-condition {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .separator {
          font-weight: bold;
          color: #6c757d;
        }

        select, input {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          border-radius: 3px;
          font-size: 13px;
        }

        select {
          background: white;
        }

        input[type="text"] {
          min-width: 100px;
          flex: 1;
        }

        input[type="number"] {
          width: 100px;
        }

        .remove-btn {
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          cursor: pointer;
          font-size: 14px;
        }

        .remove-btn:hover:not(:disabled) {
          background: #c82333;
        }

        .empty-message {
          text-align: center;
          padding: 20px;
          color: #6c757d;
        }

        .empty-message button {
          background: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 8px 16px;
          cursor: pointer;
          margin-top: 8px;
        }

        .options-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
        }

        .option-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .option-group label {
          font-weight: bold;
          color: #495057;
          font-size: 13px;
        }

        button:disabled, select:disabled, input:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      `),eg=x('<div class=field-item><select></select><span class=separator>.</span><select></select><select><option value>无聚合</option><option value=COUNT>COUNT</option><option value=SUM>SUM</option><option value=AVG>AVG</option><option value=MIN>MIN</option><option value=MAX>MAX</option><option value=DISTINCT>DISTINCT</option></select><input type=text placeholder="别名 (可选)"><button class=remove-btn>×'),Rt=x("<option>"),tg=x("<option> (<!>)"),ng=x("<div class=join-item><select><option value=INNER>INNER JOIN</option><option value=LEFT>LEFT JOIN</option><option value=RIGHT>RIGHT JOIN</option><option value=FULL>FULL JOIN</option></select><div class=join-condition><select></select><select></select><span>=</span><select></select><select></select></div><button class=remove-btn>×"),ig=x("<select><option value=AND>AND</option><option value=OR>OR"),sg=x("<input type=text>"),rg=x('<div class=where-item><select></select><select></select><select><option value="=">=</option><option value="!=">!=</option><option value=">">&gt;</option><option value="<">&lt;</option><option value=">=">&gt;=</option><option value="<=">&lt;=</option><option value=LIKE>LIKE</option><option value=IN>IN</option><option value="IS NULL">IS NULL</option><option value="IS NOT NULL">IS NOT NULL</option></select><button class=remove-btn>×');function ag(n){const[e,t]=J([]),[i,s]=J([]),[r,a]=J([]),[l]=J([]),[o]=J([]),[c,d]=J(void 0),[h,g]=J(!1),v=Me(()=>n.schema?.schemas?.[0]?.tables?n.schema.schemas[0].tables.filter(R=>n.selectedTables.includes(R.name)):[]),u=R=>v().find(q=>q.name===R)?.columns||[],p=Me(()=>{const R=v();if(R.length===0||e().length===0)return"";let k="";k+=h()?"SELECT DISTINCT ":"SELECT ";const q=e().map(F=>{let O=`${F.table}.${F.column}`;return F.aggregate&&(F.aggregate==="DISTINCT"?O=`DISTINCT ${O}`:O=`${F.aggregate}(${O})`),F.alias&&(O+=` AS ${F.alias}`),O});k+=q.join(`,
       `),k+=`
FROM ${R[0]?.name||"table1"}`;const N=i();for(const F of N)k+=`
${F.joinType} JOIN ${F.rightTable} ON ${F.leftTable}.${F.leftColumn} = ${F.rightTable}.${F.rightColumn}`;const $=r();if($.length>0){k+=`
WHERE `;const F=$.map((O,V)=>{let B="";return V>0&&(B+=`${O.logicalOperator} `),B+=`${O.table}.${O.column} ${O.operator}`,["IS NULL","IS NOT NULL"].includes(O.operator)||(O.operator==="IN"?B+=` (${O.value})`:O.operator==="LIKE"?B+=` '%${O.value}%'`:B+=` '${O.value}'`),B});k+=F.join(" ")}const P=o();P.length>0&&(k+=`
GROUP BY ${P.join(", ")}`);const X=l();if(X.length>0){const F=X.map(O=>`${O.table}.${O.column} ${O.direction}`);k+=`
ORDER BY ${F.join(", ")}`}return c()&&(k+=`
LIMIT ${c()}`),k});et(()=>{b()});const m=()=>{n.onQueryChange(p())},b=()=>{const R=v();if(R.length===0)return;const k=[];R.forEach(q=>{(q.columns?.slice(0,3)||[]).forEach($=>{k.push({table:q.name,column:$.name})})}),t(k),m()},_=()=>{const R=v();if(R.length===0)return;const k=R[0];if(!k)return;const q=k.columns?.[0]?.name||"id";t(N=>[...N,{table:k.name,column:q}]),m()},w=R=>{t(k=>k.filter((q,N)=>N!==R)),m()},S=(R,k)=>{t(q=>q.map((N,$)=>{if($===R){const P={...N,...k};return k.hasOwnProperty("aggregate")&&k.aggregate===void 0&&delete P.aggregate,k.hasOwnProperty("alias")&&k.alias===void 0&&delete P.alias,P}return N})),m()},C=()=>{const R=v();if(R.length<2)return;const k=R[0],q=R[1];if(!k||!q)return;const N=k.columns?.[0]?.name||"id",$=q.columns?.[0]?.name||"id",P={id:Date.now().toString(),leftTable:k.name,leftColumn:N,rightTable:q.name,rightColumn:$,joinType:"INNER"};s(X=>[...X,P]),m()},A=R=>{s(k=>k.filter(q=>q.id!==R)),m()},M=(R,k)=>{s(q=>q.map(N=>N.id===R?{...N,...k}:N)),m()},D=()=>{const R=v();if(R.length===0)return;const k=R[0];if(!k)return;const q=k.columns?.[0]?.name||"id",N={id:Date.now().toString(),table:k.name,column:q,operator:"=",value:"",logicalOperator:"AND"};a($=>[...$,N]),m()},z=R=>{a(k=>k.filter(q=>q.id!==R)),m()},E=(R,k)=>{a(q=>q.map(N=>N.id===R?{...N,...k}:N)),m()};return(()=>{var R=Zu(),k=R.firstChild,q=k.firstChild,N=q.firstChild,$=k.nextSibling,P=$.firstChild,X=P.firstChild,F=X.nextSibling,O=P.nextSibling,V=$.nextSibling,B=V.firstChild,H=B.firstChild,j=H.nextSibling,de=B.nextSibling,me=V.nextSibling,fe=me.firstChild,ee=fe.nextSibling,oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling;return N.addEventListener("change",te=>{g(te.currentTarget.checked),m()}),F.$$click=_,f(O,y(pe,{get each(){return e()},children:(te,ne)=>(()=>{var ve=eg(),be=ve.firstChild,ke=be.nextSibling,_e=ke.nextSibling,Pe=_e.nextSibling,ue=Pe.nextSibling,xe=ue.nextSibling;return be.addEventListener("change",L=>{const Y=v().find(ie=>ie.name===L.currentTarget.value)?.columns?.[0]?.name||"id";S(ne(),{table:L.currentTarget.value,column:Y})}),f(be,y(pe,{get each(){return v()},children:L=>(()=>{var I=Rt();return f(I,()=>L.name),G(()=>I.value=L.name),I})()})),_e.addEventListener("change",L=>S(ne(),{column:L.currentTarget.value})),f(_e,y(pe,{get each(){return u(te.table)},children:L=>(()=>{var I=tg(),K=I.firstChild,Y=K.nextSibling;return Y.nextSibling,f(I,()=>L.name,K),f(I,()=>L.data_type,Y),G(()=>I.value=L.name),I})()})),Pe.addEventListener("change",L=>{const I=L.currentTarget.value;I===""?S(ne(),{aggregate:void 0}):S(ne(),{aggregate:I})}),ue.$$input=L=>{const I=L.currentTarget.value;I===""?S(ne(),{alias:void 0}):S(ne(),{alias:I})},xe.$$click=()=>w(ne()),G(L=>{var I=n.disabled,K=n.disabled,Y=n.disabled,ie=n.disabled,ce=n.disabled;return I!==L.e&&(be.disabled=L.e=I),K!==L.t&&(_e.disabled=L.t=K),Y!==L.a&&(Pe.disabled=L.a=Y),ie!==L.o&&(ue.disabled=L.o=ie),ce!==L.i&&(xe.disabled=L.i=ce),L},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),G(()=>be.value=te.table),G(()=>_e.value=te.column),G(()=>Pe.value=te.aggregate||""),G(()=>ue.value=te.alias||""),ve})()}),null),f(O,y(W,{get when(){return e().length===0},get children(){var te=Ku(),ne=te.firstChild,ve=ne.nextSibling;return ve.$$click=b,G(()=>ve.disabled=n.disabled),te}}),null),f(R,y(W,{get when(){return v().length>1},get children(){var te=Ju(),ne=te.firstChild,ve=ne.firstChild,be=ve.nextSibling,ke=ne.nextSibling;return be.$$click=C,f(ke,y(pe,{get each(){return i()},children:_e=>(()=>{var Pe=ng(),ue=Pe.firstChild,xe=ue.nextSibling,L=xe.firstChild,I=L.nextSibling,K=I.nextSibling,Y=K.nextSibling,ie=Y.nextSibling,ce=xe.nextSibling;return ue.addEventListener("change",ae=>M(_e.id,{joinType:ae.currentTarget.value})),L.addEventListener("change",ae=>M(_e.id,{leftTable:ae.currentTarget.value})),f(L,y(pe,{get each(){return v()},children:ae=>(()=>{var $e=Rt();return f($e,()=>ae.name),G(()=>$e.value=ae.name),$e})()})),I.addEventListener("change",ae=>M(_e.id,{leftColumn:ae.currentTarget.value})),f(I,y(pe,{get each(){return u(_e.leftTable)},children:ae=>(()=>{var $e=Rt();return f($e,()=>ae.name),G(()=>$e.value=ae.name),$e})()})),Y.addEventListener("change",ae=>M(_e.id,{rightTable:ae.currentTarget.value})),f(Y,y(pe,{get each(){return v()},children:ae=>(()=>{var $e=Rt();return f($e,()=>ae.name),G(()=>$e.value=ae.name),$e})()})),ie.addEventListener("change",ae=>M(_e.id,{rightColumn:ae.currentTarget.value})),f(ie,y(pe,{get each(){return u(_e.rightTable)},children:ae=>(()=>{var $e=Rt();return f($e,()=>ae.name),G(()=>$e.value=ae.name),$e})()})),ce.$$click=()=>A(_e.id),G(ae=>{var $e=n.disabled,Ie=n.disabled,Te=n.disabled,Ye=n.disabled,We=n.disabled,ot=n.disabled;return $e!==ae.e&&(ue.disabled=ae.e=$e),Ie!==ae.t&&(L.disabled=ae.t=Ie),Te!==ae.a&&(I.disabled=ae.a=Te),Ye!==ae.o&&(Y.disabled=ae.o=Ye),We!==ae.i&&(ie.disabled=ae.i=We),ot!==ae.n&&(ce.disabled=ae.n=ot),ae},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),G(()=>ue.value=_e.joinType),G(()=>L.value=_e.leftTable),G(()=>I.value=_e.leftColumn),G(()=>Y.value=_e.rightTable),G(()=>ie.value=_e.rightColumn),Pe})()})),G(()=>be.disabled=n.disabled),te}}),V),j.$$click=D,f(de,y(pe,{get each(){return r()},children:(te,ne)=>(()=>{var ve=rg(),be=ve.firstChild,ke=be.nextSibling,_e=ke.nextSibling,Pe=_e.nextSibling;return f(ve,y(W,{get when(){return ne()>0},get children(){var ue=ig();return ue.addEventListener("change",xe=>E(te.id,{logicalOperator:xe.currentTarget.value})),G(()=>ue.disabled=n.disabled),G(()=>ue.value=te.logicalOperator),ue}}),be),be.addEventListener("change",ue=>E(te.id,{table:ue.currentTarget.value})),f(be,y(pe,{get each(){return v()},children:ue=>(()=>{var xe=Rt();return f(xe,()=>ue.name),G(()=>xe.value=ue.name),xe})()})),ke.addEventListener("change",ue=>E(te.id,{column:ue.currentTarget.value})),f(ke,y(pe,{get each(){return u(te.table)},children:ue=>(()=>{var xe=Rt();return f(xe,()=>ue.name),G(()=>xe.value=ue.name),xe})()})),_e.addEventListener("change",ue=>E(te.id,{operator:ue.currentTarget.value})),f(ve,y(W,{get when(){return!["IS NULL","IS NOT NULL"].includes(te.operator)},get children(){var ue=sg();return ue.$$input=xe=>E(te.id,{value:xe.currentTarget.value}),G(xe=>{var L=te.operator==="IN"?"值1,值2,值3":"值",I=n.disabled;return L!==xe.e&&Q(ue,"placeholder",xe.e=L),I!==xe.t&&(ue.disabled=xe.t=I),xe},{e:void 0,t:void 0}),G(()=>ue.value=te.value),ue}}),Pe),Pe.$$click=()=>z(te.id),G(ue=>{var xe=n.disabled,L=n.disabled,I=n.disabled,K=n.disabled;return xe!==ue.e&&(be.disabled=ue.e=xe),L!==ue.t&&(ke.disabled=ue.t=L),I!==ue.a&&(_e.disabled=ue.a=I),K!==ue.o&&(Pe.disabled=ue.o=K),ue},{e:void 0,t:void 0,a:void 0,o:void 0}),G(()=>be.value=te.table),G(()=>ke.value=te.column),G(()=>_e.value=te.operator),ve})()})),he.$$input=te=>{const ne=parseInt(te.currentTarget.value)||void 0;d(ne),m()},G(te=>{var ne=n.disabled,ve=n.disabled,be=n.disabled,ke=n.disabled;return ne!==te.e&&(N.disabled=te.e=ne),ve!==te.t&&(F.disabled=te.t=ve),be!==te.a&&(j.disabled=te.a=be),ke!==te.o&&(he.disabled=te.o=ke),te},{e:void 0,t:void 0,a:void 0,o:void 0}),G(()=>N.checked=h()),G(()=>he.value=c()||""),R})()}Ue(["click","input"]);var lg=x('<button class="action-btn close-btn"title=关闭预览>✕'),og=x("<table class=result-table><thead><tr></tr></thead><tbody>"),cg=x("<div class=pagination><div class=pagination-info>显示 <!> - <!>/ <!> 行</div><div class=pagination-controls><select><option value=10>10行/页</option><option value=25>25行/页</option><option value=50>50行/页</option><option value=100>100行/页</option></select><div class=page-buttons><button>首页</button><button>上一页</button><span class=page-info> / </span><button>下一页</button><button>末页"),dg=x(`<div class=query-preview><div class=preview-header><div class=header-info><h4>📊 查询结果预览</h4><div class=result-stats><span class=stat-item>📋 <!> 行数据</span><span class=stat-item>📊 <!> 列</span><span class=stat-item>⏱️ <!>ms</span></div></div><div class=header-actions><button class="action-btn export-btn"title=导出为CSV文件>📤 导出CSV</button></div></div><div class=query-info><details><summary>🔍 查询详情</summary><div class=query-details><div class=query-sql><strong>SQL查询:</strong><pre class=sql-code></pre></div><div class=query-metadata><div class=metadata-item><strong>执行时间:</strong> <!>ms</div><div class=metadata-item><strong>返回行数:</strong> </div><div class=metadata-item><strong>列数量:</strong> </div></div></div></details></div><div class=table-container></div><style>
        .query-preview {
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          overflow: hidden;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .preview-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          padding: 16px;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
        }

        .header-info h4 {
          margin: 0 0 8px 0;
          color: #2c3e50;
        }

        .result-stats {
          display: flex;
          gap: 16px;
          font-size: 13px;
        }

        .stat-item {
          color: #6c757d;
        }

        .header-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border: 1px solid #ced4da;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s;
        }

        .export-btn:hover {
          background: #28a745;
          color: white;
          border-color: #28a745;
        }

        .close-btn:hover {
          background: #dc3545;
          color: white;
          border-color: #dc3545;
        }

        .query-info {
          padding: 12px 16px;
          border-bottom: 1px solid #e9ecef;
        }

        .query-details {
          margin-top: 8px;
        }

        .query-sql {
          margin-bottom: 12px;
        }

        .sql-code {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px;
          font-family: 'Monaco', 'Consolas', monospace;
          font-size: 12px;
          overflow-x: auto;
          margin: 4px 0;
        }

        .query-metadata {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
          font-size: 13px;
        }

        .metadata-item {
          color: #495057;
        }

        .table-container {
          overflow: auto;
          max-height: 500px;
        }

        .result-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .result-table th {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 8px 12px;
          text-align: left;
          font-weight: 600;
          position: sticky;
          top: 0;
          z-index: 1;
        }

        .result-table th.sortable {
          cursor: pointer;
          user-select: none;
        }

        .result-table th.sortable:hover {
          background: #e9ecef;
        }

        .column-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .sort-indicator {
          opacity: 0.5;
          font-size: 12px;
        }

        .result-table th.sorted-asc .sort-indicator,
        .result-table th.sorted-desc .sort-indicator {
          opacity: 1;
          color: #007bff;
        }

        .result-table td {
          border: 1px solid #dee2e6;
          padding: 6px 12px;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .result-table tr.even {
          background: #f8f9fa;
        }

        .result-table tr:hover {
          background: #e3f2fd;
        }

        .cell-null {
          color: #6c757d;
          font-style: italic;
        }

        .cell-boolean {
          text-align: center;
          font-weight: bold;
        }

        .cell-integer, .cell-float {
          text-align: right;
          font-family: 'Monaco', 'Consolas', monospace;
        }

        .cell-datetime {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #6f42c1;
        }

        .cell-object {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #e83e8c;
        }

        .empty-result {
          text-align: center;
          padding: 40px 20px;
          color: #6c757d;
        }

        .empty-icon {
          font-size: 48px;
          margin-bottom: 16px;
        }

        .empty-text {
          font-size: 18px;
          font-weight: 500;
          margin-bottom: 8px;
        }

        .empty-hint {
          font-size: 14px;
        }

        .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          background: #f8f9fa;
          border-top: 1px solid #dee2e6;
          font-size: 13px;
        }

        .pagination-controls {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .page-buttons {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .page-buttons button {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          background: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }

        .page-buttons button:hover:not(:disabled) {
          background: #e9ecef;
        }

        .page-buttons button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .page-info {
          margin: 0 8px;
          font-weight: 500;
        }

        details summary {
          cursor: pointer;
          font-weight: 500;
          color: #495057;
        }

        details[open] summary {
          margin-bottom: 8px;
        }
      `),hg=x("<div class=empty-result><div class=empty-icon>📭</div><div class=empty-text>查询未返回任何数据</div><div class=empty-hint>请检查查询条件或数据源"),ug=x("<th><div class=column-header><span class=column-name></span><span class=sort-indicator>"),gg=x("<tr>"),fg=x("<td>");function vg(n){const[e,t]=J(1),[i,s]=J(10),[r,a]=J(null),[l,o]=J("asc"),c=Me(()=>{let u=[...n.result.rows];if(r()){const b=r();u.sort((_,w)=>{const S=_[b],C=w[b];if(S==null)return 1;if(C==null)return-1;const A=String(S).localeCompare(String(C),void 0,{numeric:!0});return l()==="asc"?A:-A})}const p=(e()-1)*i(),m=p+i();return{data:u.slice(p,m),totalPages:Math.ceil(u.length/i()),totalRows:u.length}}),d=u=>{r()===u?o(p=>p==="asc"?"desc":"asc"):(a(u),o("asc"))},h=u=>{if(u==null)return"";if(typeof u=="object")return JSON.stringify(u);if(typeof u=="boolean")return u?"✓":"✗";if(typeof u=="number")return Number.isInteger(u)?u.toLocaleString():u.toFixed(2);const p=String(u);if(p.match(/^\d{4}-\d{2}-\d{2}/)||p.includes("T"))try{const m=new Date(p);if(!isNaN(m.getTime()))return m.toLocaleString("zh-CN")}catch{}return p.length>50?p.substring(0,47)+"...":p},g=u=>{if(u==null)return"null";if(typeof u=="boolean")return"boolean";if(typeof u=="number")return Number.isInteger(u)?"integer":"float";if(typeof u=="object")return"object";const p=String(u);if(p.match(/^\d{4}-\d{2}-\d{2}/)||p.includes("T"))try{const m=new Date(p);if(!isNaN(m.getTime()))return"datetime"}catch{}return"string"},v=()=>{const u=n.result.columns.join(","),p=n.result.rows.map(S=>n.result.columns.map(C=>{const A=S[C],M=h(A);return M.includes(",")||M.includes('"')||M.includes(`
`)?`"${M.replace(/"/g,'""')}"`:M}).join(",")).join(`
`),m=u+`
`+p,b=new Blob([m],{type:"text/csv;charset=utf-8;"}),_=document.createElement("a"),w=URL.createObjectURL(b);_.setAttribute("href",w),_.setAttribute("download",`query_result_${Date.now()}.csv`),document.body.appendChild(_),_.click(),document.body.removeChild(_)};return(()=>{var u=dg(),p=u.firstChild,m=p.firstChild,b=m.firstChild,_=b.nextSibling,w=_.firstChild,S=w.firstChild,C=S.nextSibling;C.nextSibling;var A=w.nextSibling,M=A.firstChild,D=M.nextSibling;D.nextSibling;var z=A.nextSibling,E=z.firstChild,R=E.nextSibling;R.nextSibling;var k=m.nextSibling,q=k.firstChild,N=p.nextSibling,$=N.firstChild,P=$.firstChild,X=P.nextSibling,F=X.firstChild,O=F.firstChild,V=O.nextSibling,B=F.nextSibling,H=B.firstChild,j=H.firstChild,de=j.nextSibling,me=de.nextSibling;me.nextSibling;var fe=H.nextSibling,ee=fe.firstChild;ee.nextSibling;var oe=fe.nextSibling,ge=oe.firstChild;ge.nextSibling;var he=N.nextSibling,te=he.nextSibling;return f(w,()=>n.result.totalCount??n.result.total_rows,C),f(A,()=>n.result.columns.length,D),f(z,()=>n.result.execution_time,R),q.$$click=v,f(k,y(W,{get when(){return n.onClose},get children(){var ne=lg();return Ae(ne,"click",n.onClose),ne}}),null),f(V,()=>n.result.query),f(H,()=>n.result.execution_time,me),f(fe,()=>n.result.totalCount??n.result.total_rows,null),f(oe,()=>n.result.columns.length,null),f(he,y(W,{get when(){return n.result.rows.length>0},get fallback(){return hg()},get children(){var ne=og(),ve=ne.firstChild,be=ve.firstChild,ke=ve.nextSibling;return f(be,y(pe,{get each(){return n.result.columns},children:_e=>(()=>{var Pe=ug(),ue=Pe.firstChild,xe=ue.firstChild,L=xe.nextSibling;return Pe.$$click=()=>d(_e),Q(Pe,"title",`点击排序 ${_e}`),f(xe,_e),f(L,(()=>{var I=Ce(()=>r()===_e);return()=>I()?l()==="asc"?"↑":"↓":"↕"})()),G(()=>Se(Pe,`sortable ${r()===_e?`sorted-${l()}`:""}`)),Pe})()})),f(ke,y(pe,{get each(){return c().data},children:(_e,Pe)=>(()=>{var ue=gg();return f(ue,y(pe,{get each(){return n.result.columns},children:xe=>(()=>{var L=fg();return f(L,()=>h(_e[xe])),G(I=>{var K=`cell-${g(_e[xe])}`,Y=`${xe}: ${h(_e[xe])}`;return K!==I.e&&Se(L,I.e=K),Y!==I.t&&Q(L,"title",I.t=Y),I},{e:void 0,t:void 0}),L})()})),G(()=>Se(ue,Pe()%2===0?"even":"odd")),ue})()})),ne}})),f(u,y(W,{get when(){return c().totalPages>1},get children(){var ne=cg(),ve=ne.firstChild,be=ve.firstChild,ke=be.nextSibling,_e=ke.nextSibling,Pe=_e.nextSibling,ue=Pe.nextSibling,xe=ue.nextSibling;xe.nextSibling;var L=ve.nextSibling,I=L.firstChild,K=I.nextSibling,Y=K.firstChild,ie=Y.nextSibling,ce=ie.nextSibling,ae=ce.firstChild,$e=ce.nextSibling,Ie=$e.nextSibling;return f(ve,()=>(e()-1)*i()+1,ke),f(ve,()=>Math.min(e()*i(),c().totalRows),Pe),f(ve,()=>c().totalRows,xe),I.addEventListener("change",Te=>{s(parseInt(Te.currentTarget.value)),t(1)}),Y.$$click=()=>t(1),ie.$$click=()=>t(Te=>Math.max(1,Te-1)),f(ce,e,ae),f(ce,()=>c().totalPages,null),$e.$$click=()=>t(Te=>Math.min(c().totalPages,Te+1)),Ie.$$click=()=>t(c().totalPages),G(Te=>{var Ye=e()===1,We=e()===1,ot=e()===c().totalPages,Pt=e()===c().totalPages;return Ye!==Te.e&&(Y.disabled=Te.e=Ye),We!==Te.t&&(ie.disabled=Te.t=We),ot!==Te.a&&($e.disabled=Te.a=ot),Pt!==Te.o&&(Ie.disabled=Te.o=Pt),Te},{e:void 0,t:void 0,a:void 0,o:void 0}),G(()=>I.value=i()),ne}}),te),u})()}Ue(["click"]);var pg=x("<span>通过可视化界面构建查询，适合初学者使用"),mg=x("<span>直接编写SQL语句，适合有经验的用户"),bg=x("<div class=error-message>❌ "),yg=x("<div class=validation-errors><strong>错误:</strong><ul>"),_g=x("<div class=validation-warnings><strong>警告:</strong><ul>"),xg=x("<div class=validation-suggestions><strong>建议:</strong><ul>"),Sg=x("<div><div class=validation-header><span class=validation-status></span><span class=security-status>"),wg=x('<div class=sql-query-builder><div class=query-mode-selector><div class=mode-tabs><button>🎯 可视化构建</button><button>💻 自定义SQL</button></div><div class=mode-description></div></div><div class=query-content></div><div class=query-preview-section><div class=preview-header><h4>📋 SQL查询预览</h4><div class=preview-actions><button class="action-btn format-btn"title=格式化SQL代码>🎨 格式化</button><button class="action-btn validate-btn"title=验证SQL语法>✓ 验证语法</button><button class="action-btn copy-btn"title=复制SQL到剪贴板>📋 复制</button><button class="action-btn execute-btn"title=执行查询预览></button></div></div><div class=sql-display><pre class=sql-code><code></code></pre></div></div><div class=query-help><details><summary>💡 查询构建帮助</summary><div class=help-content><div class=help-section><h5>可视化构建:</h5><ul><li>选择表和字段来自动生成查询</li><li>支持JOIN关联、WHERE条件、ORDER BY排序</li><li>适合SQL初学者使用</li></ul></div><div class=help-section><h5>自定义SQL:</h5><ul><li>直接编写SQL语句，支持复杂查询</li><li>提供语法验证和格式化功能</li><li>适合有经验的用户</li></ul></div><div class=help-section><h5>安全提示:</h5><ul><li>系统会自动检测SQL注入风险</li><li>预览查询限制返回行数，避免性能问题</li><li>建议先验证语法，再执行预览'),fi=x("<li>");function $g(n){const[e,t]=J("visual"),[i,s]=J(!1),[r,a]=J(null),[l,o]=J(null),[c,d]=J(null),[h,g]=J(""),v=Me(()=>e()==="visual"?h():n.sql),u=Me(()=>l()),p=async()=>{const S=v().trim();if(!S){o(null),n.onValidationChange(null);return}try{if(s(!0),a(null),console.log("🔍 验证SQL语法:",S),console.log("🔍 SQLQueryBuilder config对象:",n.config),console.log("🔍 config对象的键:",Object.keys(n.config)),console.log("🔍 database_type字段:",n.config.database_type),["database_type","databaseType","dbType","type"].forEach(M=>{n.config[M]&&console.log(`🔍 找到字段 ${M}:`,n.config[M])}),!n.config.database_type)throw new Error(`database_type字段缺失，config内容: ${JSON.stringify(n.config)}`);const A=await Re.validateSqlSyntax(S,n.config.database_type);o(A),n.onValidationChange(A),console.log("✅ SQL验证结果:",A)}catch(C){console.error("❌ SQL验证失败:",C);const A={valid:!1,errors:[`验证失败: ${C}`],warnings:[],suggestions:[],is_safe:!1,security_issues:["无法验证查询安全性"]};o(A),n.onValidationChange(A),a(`SQL验证失败: ${C}`)}finally{s(!1)}},m=async()=>{const S=v().trim();if(S)try{s(!0),a(null),console.log("🎨 格式化SQL:",S);const C=await Re.formatSql(S,n.config.database_type);e()==="visual"?g(C):n.onSQLChange(C),console.log("✅ SQL格式化完成")}catch(C){console.error("❌ SQL格式化失败:",C),a(`格式化失败: ${C}`)}finally{s(!1)}},b=async()=>{const S=v().trim();if(!S){a("请输入SQL查询语句");return}try{s(!0),a(null),console.log("▶️ 执行查询预览:",S),await p();const C=l();if(C&&!C.valid){a("SQL语法验证失败，请修正后重试");return}const A=await Re.executeDatabasePreview(n.config,S,50);d(A),n.onQueryResult(A),console.log("✅ 查询预览成功:",A)}catch(C){console.error("❌ 查询预览失败:",C),a(`查询执行失败: ${C}`),d(null),n.onQueryResult(null)}finally{s(!1)}},_=async()=>{const S=v();if(S)try{await navigator.clipboard.writeText(S),console.log("📋 SQL已复制到剪贴板")}catch(C){console.error("❌ 复制失败:",C),a(`复制失败: ${C}`)}},w=S=>{t(S),a(null),S==="custom"&&h()&&n.onSQLChange(h())};return(()=>{var S=wg(),C=S.firstChild,A=C.firstChild,M=A.firstChild,D=M.nextSibling,z=A.nextSibling,E=C.nextSibling,R=E.nextSibling,k=R.firstChild,q=k.firstChild,N=q.nextSibling,$=N.firstChild,P=$.nextSibling,X=P.nextSibling,F=X.nextSibling,O=k.nextSibling,V=O.firstChild,B=V.firstChild;return M.$$click=()=>w("visual"),D.$$click=()=>w("custom"),f(z,y(W,{get when(){return e()==="visual"},get children(){return pg()}}),null),f(z,y(W,{get when(){return e()==="custom"},get children(){return mg()}}),null),f(S,y(W,{get when(){return r()},get children(){var H=bg();return H.firstChild,f(H,r,null),H}}),E),f(E,y(W,{get when(){return e()==="visual"},get children(){return y(ag,{get selectedTables(){return n.selectedTables},get schema(){return n.schema},onQueryChange:g,get disabled(){return i()}})}}),null),f(E,y(W,{get when(){return e()==="custom"},get children(){return y(Qu,{get sql(){return n.sql},get onSQLChange(){return n.onSQLChange},get databaseType(){return n.config.database_type},get disabled(){return i()}})}}),null),$.$$click=m,P.$$click=p,X.$$click=_,F.$$click=b,f(F,()=>i()?"⏳ 执行中...":"▶️ 预览查询"),f(B,()=>v()||"-- 请构建或输入SQL查询语句"),f(R,y(W,{get when(){return u()},get children(){var H=Sg(),j=H.firstChild,de=j.firstChild,me=de.nextSibling;return f(de,()=>u().valid?"✅ 语法正确":"❌ 语法错误"),f(me,()=>u().is_safe?"🔒 查询安全":"⚠️ 安全警告"),f(H,y(W,{get when(){return Ce(()=>!!u().errors)()&&u().errors.length>0},get children(){var fe=yg(),ee=fe.firstChild,oe=ee.nextSibling;return f(oe,y(pe,{get each(){return u().errors},children:ge=>(()=>{var he=fi();return f(he,ge),he})()})),fe}}),null),f(H,y(W,{get when(){return Ce(()=>!!u()?.warnings)()&&u().warnings.length>0},get children(){var fe=_g(),ee=fe.firstChild,oe=ee.nextSibling;return f(oe,y(pe,{get each(){return u().warnings},children:ge=>(()=>{var he=fi();return f(he,ge),he})()})),fe}}),null),f(H,y(W,{get when(){return Ce(()=>!!u()?.suggestions)()&&u().suggestions.length>0},get children(){var fe=xg(),ee=fe.firstChild,oe=ee.nextSibling;return f(oe,y(pe,{get each(){return u().suggestions},children:ge=>(()=>{var he=fi();return f(he,ge),he})()})),fe}}),null),G(()=>Se(H,`validation-result ${u()?.valid?"valid":"invalid"}`)),H}}),null),f(R,y(W,{get when(){return c()},get children(){return y(vg,{get result(){return c()},onClose:()=>{d(null),n.onQueryResult(null)}})}}),null),G(H=>{var j=`mode-tab ${e()==="visual"?"active":""}`,de=i(),me=`mode-tab ${e()==="custom"?"active":""}`,fe=i(),ee=i()||!v(),oe=i()||!v(),ge=i()||!v(),he=i()||!v();return j!==H.e&&Se(M,H.e=j),de!==H.t&&(M.disabled=H.t=de),me!==H.a&&Se(D,H.a=me),fe!==H.o&&(D.disabled=H.o=fe),ee!==H.i&&($.disabled=H.i=ee),oe!==H.n&&(P.disabled=H.n=oe),ge!==H.s&&(X.disabled=H.s=ge),he!==H.h&&(F.disabled=H.h=he),H},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),S})()}Ue(["click"]);var Cg=x("<div class=error-messages>"),kg=x("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>处理中..."),Tg=x('<div class=form-row><div class="form-group flex-2"><label>主机地址</label><input type=text placeholder=localhost></div><div class="form-group flex-1"><label>端口</label><input type=number>'),Eg=x("<div class=form-group><label>数据库文件路径</label><input type=text placeholder=/path/to/database.db>"),Pg=x("<div class=form-group><label>数据库名</label><input type=text placeholder=myapp_production>"),Ag=x("<div class=form-row><div class=form-group><label>用户名</label><input type=text></div><div class=form-group><label>密码</label><input type=password>"),Nr=x("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Rg=x("<div class=connection-step><div class=step-header><h4>🔌 数据库连接配置</h4><p>请填写数据库连接信息</p></div><div class=form-section><div class=form-group><label>数据库类型</label><select><option value=mysql>MySQL</option><option value=postgresql>PostgreSQL</option><option value=sqlite>SQLite</option><option value=sqlserver>SQL Server</option><option value=oracle>Oracle</option></select></div><div class=connection-test><button class=test-connection-btn>"),Lg=x("<div class=schema-loading><button class=load-schema-btn>🔄 加载表结构</button><p class=loading-hint>点击按钮加载数据库的表结构信息"),Mg=x("<div class=views-section><h5>👁️ 数据视图列表</h5><div class=views-list>"),Dg=x("<div class=schema-content><div class=schema-summary><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>表数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>视图数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>加载时间:</span><span class=summary-value></span></div></div><div class=tables-section><h5>📋 数据表列表</h5><div class=tables-grid>"),Og=x("<div class=schema-step><div class=step-header><h4>🗂️ 数据库表结构</h4><p>选择要查询的数据表和字段"),Ig=x('<div class=database-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>🗄️ 创建数据库数据源</h3><p>连接数据库并配置查询语句</p></div></div><div class=wizard-progress><div><div class=step-indicator>1</div><div class=step-info><div class=step-title>数据库连接</div><div class=step-description>配置连接信息</div></div></div><div><div class=step-indicator>2</div><div class=step-info><div class=step-title>表结构</div><div class=step-description>选择数据表</div></div></div><div><div class=step-indicator>3</div><div class=step-info><div class=step-title>查询构建</div><div class=step-description>编写SQL查询</div></div></div><div><div class=step-indicator>4</div><div class=step-info><div class=step-title>预览保存</div><div class=step-description>测试并保存</div></div></div></div><div class=wizard-content></div><div class=wizard-controls><div class=control-buttons><button class="control-btn back-btn">← 上一步</button><button class="control-btn next-btn">下一步 →'),Ng=x("<div class=error-message>❌ "),zg=x("<span class=view-comment>"),Fg=x("<div class=view-item><div class=view-info><span class=view-name></span><span class=view-schema>"),Gg=x("<div class=table-comment>"),Bg=x("<div class=more-columns>+<!> 个字段..."),Ug=x("<span class=more-indexes>+"),Hg=x("<div class=table-indexes><h6>索引 (<!>)</h6><div class=indexes-list>"),qg=x("<span class=more-relations>+"),Wg=x("<div class=table-relations><h6>关联 (<!>)</h6><div class=relations-list>"),jg=x("<div><div class=table-card-header><div class=table-card-title><label class=table-checkbox><input type=checkbox><span class=table-name>📋 </span></label></div><div class=table-card-stats><span class=row-count title=预估行数> 行</span><span class=table-size title=预估大小></span></div></div><div class=table-columns><h6>字段 (<!>)</h6><div class=columns-preview>"),Yg=x("<span class=pk-badge title=主键>🔑"),Vg=x("<span class=fk-badge title=外键>🔗"),Xg=x("<div class=column-item><span class=column-icon></span><span class=column-name></span><span class=column-type>"),Qg=x("<span> "),Kg=x("<span class=relation-badge>🔗 "),Jg=x('<div class=preview-step><div class=step-header><h4>👁️ 预览和保存</h4><p>验证配置、预览数据并保存数据源</p></div><div class=basic-info-section><h5>📝 基本信息</h5><div class=form-row><div class="form-group flex-2"><label>数据源名称 *</label><input type=text placeholder=输入数据源名称... required></div><div class="form-group flex-1"><label>标签</label><input type=text placeholder="标签1, 标签2"></div></div><div class=form-group><label>描述</label><textarea placeholder=描述这个数据源的用途... rows=3>'),Zg=x("<div class=config-summary><h5>⚙️ 配置摘要</h5><div class=summary-grid><div class=summary-item><span class=summary-label>数据库类型:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>连接地址:</span><span class=summary-value>:</span></div><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>用户名:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>选中表:</span><span class=summary-value> 个表</span></div><div class=summary-item><span class=summary-label>查询长度:</span><span class=summary-value> 字符</span></div></div><div class=sql-preview><h6>SQL查询预览:</h6><pre class=sql-code>"),ef=x("<div class=validation-warnings><h6>⚠️ 警告"),tf=x("<div class=validation-errors><h6>❌ 错误"),nf=x("<div class=validation-suggestions><h6>💡 建议"),sf=x("<div class=validation-results><div class=validation-checks>"),rf=x("<div class=validation-section><div class=section-header><h5>✅ 验证状态</h5><button class=validate-btn>"),af=x("<div class=warning-item>"),lf=x("<div class=error-item>"),of=x("<div class=suggestion-item>"),cf=x("<div><span class=check-icon></span><span class=check-label></span><span>"),df=x("<div class=no-data>没有查询到数据"),hf=x("<div class=preview-results><div class=preview-stats><div class=stat-item><span class=stat-label>样本行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>预估总行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>执行时间:</span><span class=stat-value>ms</span></div></div><div class=preview-data>"),uf=x("<div class=data-preview-section><div class=section-header><h5>📊 数据预览</h5><button class=preview-btn>"),gf=x("<div class=no-data>没有数据"),ff=x("<div class=table-footer>显示前10行，共 <!> 行数据"),vf=x("<div class=data-table-container><table class=data-table><thead><tr></tr></thead><tbody>"),pf=x("<th>"),mf=x("<tr>"),bf=x("<td>"),yf=x('<div class=save-requirements><div class=requirements-header>❗ 保存要求检查：</div><div class=requirements-list><div class=requirement-item>数据源名称: <!> "<!>"</div><div class=requirement-item>自定义SQL: <!> </div><div class=requirement-item>测试连接: <!> </div><div class=requirement-item>保存状态: </div></div><div class=requirements-note>'),_f=x("<div class=result-details><div class=detail-item><span class=detail-label>数据源ID:</span><span class=detail-value>"),xf=x("<div class=result-warnings>"),Sf=x("<div class=result-errors>"),wf=x("<div class=save-requirements><h6>保存前需要完成:</h6><ul><li>填写数据源名称</li><li>确保SQL查询有效</li><li>通过基本验证检查"),$f=x("<div class=save-section><div class=section-header><h5>💾 保存数据源</h5><button>"),Cf=x("<div class=warning-item>⚠️ "),kf=x("<div class=error-item>❌ ");const Tf={database_type:"mysql",host:"localhost",port:3306,database:"",username:"",password:"",ssl_enabled:!1,max_connections:10,min_connections:1,connection_timeout:30,idle_timeout:600,sql:"",use_custom_sql:!1,query_timeout:60,default_limit:1e3,enable_caching:!0,cache_ttl:300};function Ef(n){const[e,t]=J({currentStep:"connection",name:"",description:"",tags:[],config:{...Tf},schema:null,selectedTables:[],generatedSQL:"",customSQL:"",useCustomSQL:!1,testResult:null,queryResult:null,validation:null,dataSourceValidation:null,dataPreview:null,loading:!1,errors:[],isSaving:!1,saveResult:null}),i=Me(()=>{const v=e();return{connection:v.testResult?.success||!1,schema:v.schema!==null&&v.selectedTables.length>0,query:v.customSQL.trim().length>0,preview:v.name.trim().length>0&&v.customSQL.trim().length>0}}),s=v=>{t(u=>({...u,...v}))},r=v=>{t(u=>({...u,config:{...u.config,...v}}))},a=async()=>{s({loading:!0,errors:[]});try{const v=await Re.testDatabaseConnection(e().config);s({testResult:v,loading:!1,errors:v.success?[]:[v.message]}),v.success&&setTimeout(()=>{s({currentStep:"schema"}),l()},1e3)}catch(v){s({loading:!1,errors:[`连接测试失败: ${v}`],testResult:{success:!1,message:String(v)}})}},l=async()=>{s({loading:!0,errors:[]});try{const v=await Re.loadDatabaseSchema(e().config);s({schema:v,loading:!1,errors:[]})}catch(v){s({loading:!1,errors:[`架构加载失败: ${v}`],schema:null})}},o=async()=>{s({loading:!0,errors:[]});try{const v={name:e().name,config:e().config,selected_tables:e().selectedTables,sql:e().customSQL,description:e().description,tags:e().tags,validate_before_save:!0},u=await Re.validateDataSourceBeforeSave(v);return s({dataSourceValidation:u,loading:!1,errors:u.errors}),u}catch(v){return s({loading:!1,errors:[`验证失败: ${v}`]}),null}},c=async()=>{s({loading:!0,errors:[]});try{const v=await Re.captureDataPreview(e().config,e().customSQL);return s({dataPreview:v,loading:!1}),v}catch(v){return s({loading:!1,errors:[`数据预览失败: ${v}`]}),null}},d=async()=>{s({isSaving:!0,errors:[]});try{console.log("🔍 DatabaseWizard 保存前状态:",{selectedTables:e().selectedTables,selectedTables_type:typeof e().selectedTables,selectedTables_length:e().selectedTables?.length,customSQL_length:e().customSQL?.length,name:e().name});const v={name:e().name,config:e().config,selected_tables:e().selectedTables,sql:e().customSQL,description:e().description,tags:e().tags,validate_before_save:!0,capture_schema_snapshot:!0,capture_data_preview:!0,preview_row_limit:10};console.log("🔍 构建的 SaveDataSourceRequest:",{selected_tables:v.selected_tables,selected_tables_type:typeof v.selected_tables,selected_tables_length:v.selected_tables?.length});const u=await Re.saveDataSource(v);return s({saveResult:u,isSaving:!1}),u.success&&setTimeout(()=>{n.onSuccess()},2e3),u}catch(v){return s({isSaving:!1,errors:[`保存失败: ${v}`]}),null}},h=v=>{s({currentStep:v})},g=()=>{switch(e().currentStep){case"schema":s({currentStep:"connection"});break;case"query":s({currentStep:"schema"});break;case"preview":s({currentStep:"query"});break;default:n.onBack()}};return(()=>{var v=Ig(),u=v.firstChild,p=u.firstChild,m=u.nextSibling,b=m.firstChild,_=b.nextSibling,w=_.nextSibling,S=w.nextSibling,C=m.nextSibling,A=C.nextSibling,M=A.firstChild,D=M.firstChild,z=D.nextSibling;return p.$$click=g,b.$$click=()=>h("connection"),_.$$click=()=>i().connection&&h("schema"),w.$$click=()=>i().schema&&h("query"),S.$$click=()=>i().query&&h("preview"),f(C,y(W,{get when(){return e().errors.length>0},get children(){var E=Cg();return f(E,y(pe,{get each(){return e().errors},children:R=>(()=>{var k=Ng();return k.firstChild,f(k,R,null),k})()})),E}}),null),f(C,y(W,{get when(){return e().loading},get children(){return kg()}}),null),f(C,y(W,{get when(){return e().currentStep==="connection"},get children(){var E=Rg(),R=E.firstChild,k=R.nextSibling,q=k.firstChild,N=q.firstChild,$=N.nextSibling,P=q.nextSibling,X=P.firstChild;return $.addEventListener("change",F=>{const O=F.currentTarget.value,V={mysql:3306,postgresql:5432,sqlserver:1433,oracle:1521,sqlite:0}[O];r({database_type:O,port:V})}),f(k,y(W,{get when(){return e().config.database_type!=="sqlite"},get children(){var F=Tg(),O=F.firstChild,V=O.firstChild,B=V.nextSibling,H=O.nextSibling,j=H.firstChild,de=j.nextSibling;return B.addEventListener("change",me=>r({host:me.currentTarget.value})),de.addEventListener("change",me=>r({port:parseInt(me.currentTarget.value)||3306})),G(()=>B.value=e().config.host),G(()=>de.value=e().config.port),F}}),P),f(k,y(W,{get when(){return e().config.database_type==="sqlite"},get children(){var F=Eg(),O=F.firstChild,V=O.nextSibling;return V.addEventListener("change",B=>r({database:B.currentTarget.value})),G(()=>V.value=e().config.database),F}}),P),f(k,y(W,{get when(){return e().config.database_type!=="sqlite"},get children(){return[(()=>{var F=Pg(),O=F.firstChild,V=O.nextSibling;return V.addEventListener("change",B=>r({database:B.currentTarget.value})),G(()=>V.value=e().config.database),F})(),(()=>{var F=Ag(),O=F.firstChild,V=O.firstChild,B=V.nextSibling,H=O.nextSibling,j=H.firstChild,de=j.nextSibling;return B.addEventListener("change",me=>r({username:me.currentTarget.value})),de.addEventListener("change",me=>r({password:me.currentTarget.value})),G(()=>B.value=e().config.username),G(()=>de.value=e().config.password),F})()]}}),P),X.$$click=a,f(X,()=>e().loading?"⏳ 测试中...":"🔗 测试连接"),f(P,y(W,{get when(){return e().testResult},get children(){var F=Nr(),O=F.firstChild,V=O.firstChild,B=V.nextSibling;return f(V,()=>e().testResult?.success?"✅":"❌"),f(B,()=>e().testResult?.message),G(()=>Se(F,`test-result ${e().testResult?.success?"success":"error"}`)),F}}),null),G(()=>X.disabled=e().loading),G(()=>$.value=e().config.database_type),E}}),null),f(C,y(W,{get when(){return e().currentStep==="schema"},get children(){var E=Og();return E.firstChild,f(E,y(W,{get when(){return Ce(()=>!e().schema)()&&!e().loading},get children(){var R=Lg(),k=R.firstChild;return k.$$click=l,R}}),null),f(E,y(W,{get when(){return e().schema},get children(){var R=Dg(),k=R.firstChild,q=k.firstChild,N=q.firstChild,$=N.nextSibling,P=q.nextSibling,X=P.firstChild,F=X.nextSibling,O=P.nextSibling,V=O.firstChild,B=V.nextSibling,H=O.nextSibling,j=H.firstChild,de=j.nextSibling,me=k.nextSibling,fe=me.firstChild,ee=fe.nextSibling;return f($,()=>e().schema?.database_name),f(F,()=>e().schema?.schemas[0]?.tables?.length||0),f(B,()=>e().schema?.schemas[0]?.views?.length||0),f(de,()=>new Date(e().schema?.loaded_at||"").toLocaleString("zh-CN")),f(ee,y(pe,{get each(){return e().schema?.schemas[0]?.tables||[]},children:oe=>y(Pf,{table:oe,get selected(){return e().selectedTables.includes(oe.name)},onToggle:(ge,he)=>{const te=e().selectedTables;s(he?{selectedTables:[...te,ge]}:{selectedTables:te.filter(ne=>ne!==ge)})}})})),f(R,y(W,{get when(){return Ce(()=>!!e().schema?.schemas[0]?.views)()&&e().schema.schemas[0].views.length>0},get children(){var oe=Mg(),ge=oe.firstChild,he=ge.nextSibling;return f(he,y(pe,{get each(){return e().schema?.schemas[0]?.views||[]},children:te=>(()=>{var ne=Fg(),ve=ne.firstChild,be=ve.firstChild,ke=be.nextSibling;return f(be,()=>te.name),f(ke,()=>te.schema),f(ne,y(W,{get when(){return te.comment},get children(){var _e=zg();return f(_e,()=>te.comment),_e}}),null),ne})()})),oe}}),null),R}}),null),E}}),null),f(C,y(W,{get when(){return e().currentStep==="query"},get children(){return y($g,{get selectedTables(){return e().selectedTables},get schema(){return e().schema},get config(){return e().config},get sql(){return e().customSQL},onSQLChange:E=>s({customSQL:E}),onQueryResult:E=>s({queryResult:E}),onValidationChange:E=>s({validation:E})})}}),null),f(C,y(W,{get when(){return e().currentStep==="preview"},get children(){return y(Af,{get state(){return e()},onStateUpdate:s,onSave:d,onValidate:o,onPreviewData:c})}}),null),D.$$click=g,z.$$click=()=>{const E=e();E.currentStep==="connection"&&E.testResult?.success?(s({currentStep:"schema"}),E.schema||l()):E.currentStep==="schema"?s({currentStep:"query"}):E.currentStep==="query"&&s({currentStep:"preview"})},G(E=>{var R=`progress-step ${e().currentStep==="connection"?"active":""} ${i().connection?"completed":""}`,k=`progress-step ${e().currentStep==="schema"?"active":""} ${i().schema?"completed":""}`,q=`progress-step ${e().currentStep==="query"?"active":""} ${i().query?"completed":""}`,N=`progress-step ${e().currentStep==="preview"?"active":""} ${i().preview?"completed":""}`,$=e().loading;return R!==E.e&&Se(b,E.e=R),k!==E.t&&Se(_,E.t=k),q!==E.a&&Se(w,E.a=q),N!==E.o&&Se(S,E.o=N),$!==E.i&&(z.disabled=E.i=$),E},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),v})()}function Pf(n){const e=i=>i<1e3?i.toString():i<1e6?`${(i/1e3).toFixed(1)}K`:`${(i/1e6).toFixed(1)}M`,t=i=>{const s=i.toLowerCase();return s.includes("int")||s.includes("number")||s.includes("decimal")?"🔢":s.includes("varchar")||s.includes("text")||s.includes("char")?"📝":s.includes("date")||s.includes("time")?"📅":s.includes("bool")?"✅":"📋"};return(()=>{var i=jg(),s=i.firstChild,r=s.firstChild,a=r.firstChild,l=a.firstChild,o=l.nextSibling;o.firstChild;var c=r.nextSibling,d=c.firstChild,h=d.firstChild,g=d.nextSibling,v=s.nextSibling,u=v.firstChild,p=u.firstChild,m=p.nextSibling;m.nextSibling;var b=u.nextSibling;return l.addEventListener("change",_=>n.onToggle(n.table.name,_.currentTarget.checked)),f(o,()=>n.table.name,null),f(d,()=>e(n.table.row_count_estimate),h),f(g,()=>n.table.size_estimate),f(i,y(W,{get when(){return n.table.comment},get children(){var _=Gg();return f(_,()=>n.table.comment),_}}),v),f(u,()=>n.table.columns?.length||0,m),f(b,y(pe,{get each(){return(n.table.columns||[]).slice(0,6)},children:_=>(()=>{var w=Xg(),S=w.firstChild,C=S.nextSibling,A=C.nextSibling;return f(S,()=>t(_.data_type)),f(C,()=>_.name),f(A,()=>_.data_type),f(w,y(W,{get when(){return _.is_primary_key},get children(){return Yg()}}),null),f(w,y(W,{get when(){return _.is_foreign_key},get children(){return Vg()}}),null),w})()}),null),f(b,y(W,{get when(){return(n.table.columns?.length||0)>6},get children(){var _=Bg(),w=_.firstChild,S=w.nextSibling;return S.nextSibling,f(_,()=>(n.table.columns?.length||0)-6,S),_}}),null),f(i,y(W,{get when(){return n.table.indexes&&n.table.indexes.length>0},get children(){var _=Hg(),w=_.firstChild,S=w.firstChild,C=S.nextSibling;C.nextSibling;var A=w.nextSibling;return f(w,()=>n.table.indexes.length,C),f(A,y(pe,{get each(){return n.table.indexes.slice(0,3)},children:M=>(()=>{var D=Qg(),z=D.firstChild;return f(D,()=>M.unique?"🔐":"📇",z),f(D,()=>M.name,null),G(E=>{var R=`index-badge ${M.unique?"unique":""}`,k=M.columns.join(", ");return R!==E.e&&Se(D,E.e=R),k!==E.t&&Q(D,"title",E.t=k),E},{e:void 0,t:void 0}),D})()}),null),f(A,y(W,{get when(){return n.table.indexes.length>3},get children(){var M=Ug();return M.firstChild,f(M,()=>n.table.indexes.length-3,null),M}}),null),_}}),null),f(i,y(W,{get when(){return n.table.foreign_keys&&n.table.foreign_keys.length>0},get children(){var _=Wg(),w=_.firstChild,S=w.firstChild,C=S.nextSibling;C.nextSibling;var A=w.nextSibling;return f(w,()=>n.table.foreign_keys.length,C),f(A,y(pe,{get each(){return n.table.foreign_keys.slice(0,2)},children:M=>(()=>{var D=Kg();return D.firstChild,f(D,()=>M.referenced_table,null),G(()=>Q(D,"title",`${M.column_name} → ${M.referenced_table}.${M.referenced_column}`)),D})()}),null),f(A,y(W,{get when(){return n.table.foreign_keys.length>2},get children(){var M=qg();return M.firstChild,f(M,()=>n.table.foreign_keys.length-2,null),M}}),null),_}}),null),G(()=>Se(i,`table-card ${n.selected?"selected":""}`)),G(()=>l.checked=n.selected),i})()}function Af(n){return(()=>{var e=Jg(),t=e.firstChild,i=t.nextSibling,s=i.firstChild,r=s.nextSibling,a=r.firstChild,l=a.firstChild,o=l.nextSibling,c=a.nextSibling,d=c.firstChild,h=d.nextSibling,g=r.nextSibling,v=g.firstChild,u=v.nextSibling;return o.$$input=p=>n.onStateUpdate({name:p.currentTarget.value}),h.$$input=p=>{const m=p.currentTarget.value.split(",").map(b=>b.trim()).filter(b=>b);n.onStateUpdate({tags:m})},u.$$input=p=>n.onStateUpdate({description:p.currentTarget.value}),f(e,y(Rf,{get state(){return n.state}}),null),f(e,y(Lf,{get validation(){return n.state.dataSourceValidation},get onValidate(){return n.onValidate},get loading(){return n.state.loading}}),null),f(e,y(Mf,{get preview(){return n.state.dataPreview},get onPreviewData(){return n.onPreviewData},get loading(){return n.state.loading}}),null),f(e,y(Of,{get state(){return n.state},get saveResult(){return n.state.saveResult},get onSave(){return n.onSave},get isSaving(){return n.state.isSaving},get canSave(){return If(n.state)}}),null),G(()=>o.value=n.state.name),G(()=>h.value=n.state.tags.join(", ")),G(()=>u.value=n.state.description),e})()}function Rf(n){return(()=>{var e=Zg(),t=e.firstChild,i=t.nextSibling,s=i.firstChild,r=s.firstChild,a=r.nextSibling,l=s.nextSibling,o=l.firstChild,c=o.nextSibling,d=c.firstChild,h=l.nextSibling,g=h.firstChild,v=g.nextSibling,u=h.nextSibling,p=u.firstChild,m=p.nextSibling,b=u.nextSibling,_=b.firstChild,w=_.nextSibling,S=w.firstChild,C=b.nextSibling,A=C.firstChild,M=A.nextSibling,D=M.firstChild,z=i.nextSibling,E=z.firstChild,R=E.nextSibling;return f(a,()=>n.state.config.database_type.toUpperCase()),f(c,()=>n.state.config.host,d),f(c,()=>n.state.config.port,null),f(v,()=>n.state.config.database),f(m,()=>n.state.config.username),f(w,()=>n.state.selectedTables.length,S),f(M,()=>n.state.customSQL.length,D),f(R,()=>n.state.customSQL.slice(0,200),null),f(R,()=>n.state.customSQL.length>200?"...":"",null),e})()}function Lf(n){return(()=>{var e=rf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(s,"click",n.onValidate),f(s,()=>n.loading?"⏳ 验证中...":"🔍 开始验证"),f(e,y(W,{get when(){return n.validation},get children(){var r=sf(),a=r.firstChild;return f(a,y(Mn,{label:"数据库连接",get status(){return n.validation?.connection_valid?"success":"error"},get icon(){return n.validation?.connection_valid?"✅":"❌"}}),null),f(a,y(Mn,{label:"SQL语法",get status(){return n.validation?.sql_valid?"success":"error"},get icon(){return n.validation?.sql_valid?"✅":"❌"}}),null),f(a,y(Mn,{label:"安全检查",get status(){return n.validation?.security_passed?"success":"warning"},get icon(){return n.validation?.security_passed?"✅":"⚠️"}}),null),f(a,y(Mn,{label:"性能评估",get status(){return n.validation?.performance_acceptable?"success":"info"},get icon(){return n.validation?.performance_acceptable?"✅":"ℹ️"}}),null),f(r,y(W,{get when(){return n.validation&&n.validation.warnings.length>0},get children(){var l=ef();return l.firstChild,f(l,y(pe,{get each(){return n.validation.warnings||[]},children:o=>(()=>{var c=af();return f(c,o),c})()}),null),l}}),null),f(r,y(W,{get when(){return n.validation&&n.validation.errors.length>0},get children(){var l=tf();return l.firstChild,f(l,y(pe,{get each(){return n.validation.errors||[]},children:o=>(()=>{var c=lf();return f(c,o),c})()}),null),l}}),null),f(r,y(W,{get when(){return n.validation&&n.validation.suggestions&&n.validation.suggestions.length>0},get children(){var l=nf();return l.firstChild,f(l,y(pe,{get each(){return n.validation.suggestions||[]},children:o=>(()=>{var c=of();return f(c,o),c})()}),null),l}}),null),r}}),null),G(()=>s.disabled=n.loading),e})()}function Mn(n){return(()=>{var e=cf(),t=e.firstChild,i=t.nextSibling,s=i.nextSibling;return f(t,()=>n.icon),f(i,()=>n.label),f(s,()=>n.status==="success"?"通过":n.status==="error"?"失败":n.status==="warning"?"警告":"信息"),G(r=>{var a=`validation-check ${n.status}`,l=`check-status ${n.status}`;return a!==r.e&&Se(e,r.e=a),l!==r.t&&Se(s,r.t=l),r},{e:void 0,t:void 0}),e})()}function Mf(n){return(()=>{var e=uf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(s,"click",n.onPreviewData),f(s,()=>n.loading?"⏳ 加载中...":"👁️ 预览数据"),f(e,y(W,{get when(){return n.preview},get children(){var r=hf(),a=r.firstChild,l=a.firstChild,o=l.firstChild,c=o.nextSibling,d=l.nextSibling,h=d.firstChild,g=h.nextSibling,v=d.nextSibling,u=v.firstChild,p=u.nextSibling,m=p.firstChild,b=a.nextSibling;return f(c,()=>n.preview?.sample_data.length||0),f(g,()=>n.preview?.total_estimated_rows.toLocaleString()||"未知"),f(p,()=>n.preview?.execution_stats.execution_time||0,m),f(b,y(W,{get when(){return n.preview&&n.preview.sample_data.length>0},get children(){return y(Df,{get data(){return n.preview.sample_data||[]}})}}),null),f(b,y(W,{get when(){return!n.preview||n.preview.sample_data.length===0},get children(){return df()}}),null),r}}),null),G(()=>s.disabled=n.loading),e})()}function Df(n){if(!n.data||n.data.length===0)return gf();const e=Object.keys(n.data[0]);return(()=>{var t=vf(),i=t.firstChild,s=i.firstChild,r=s.firstChild,a=s.nextSibling;return f(r,y(pe,{each:e,children:l=>(()=>{var o=pf();return f(o,l),o})()})),f(a,y(pe,{get each(){return n.data.slice(0,10)},children:l=>(()=>{var o=mf();return f(o,y(pe,{each:e,children:c=>(()=>{var d=bf();return f(d,()=>Nf(l[c])),d})()})),o})()})),f(t,y(W,{get when(){return n.data.length>10},get children(){var l=ff(),o=l.firstChild,c=o.nextSibling;return c.nextSibling,f(l,()=>n.data.length,c),l}}),null),t})()}function Of(n){return(()=>{var e=$f(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(s,"click",n.onSave),f(s,()=>n.isSaving?"💾 保存中...":"💾 保存数据源"),f(e,y(W,{get when(){return!n.canSave&&!n.isSaving},get children(){var r=yf(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.firstChild,d=c.nextSibling,h=d.nextSibling,g=h.nextSibling;g.nextSibling;var v=o.nextSibling,u=v.firstChild,p=u.nextSibling;p.nextSibling;var m=v.nextSibling,b=m.firstChild,_=b.nextSibling;_.nextSibling;var w=m.nextSibling;w.firstChild;var S=l.nextSibling;return f(o,()=>n.state.name?"✅":"❌",d),f(o,()=>n.state.name,g),f(v,()=>n.state.customSQL?"✅":"❌",p),f(v,()=>n.state.customSQL?`(${n.state.customSQL.length} 字符)`:"(空)",null),f(m,()=>n.state.testResult?.success?"✅":"❌",_),f(m,()=>n.state.testResult?.success?"成功":n.state.testResult?`失败: ${n.state.testResult.message}`:"未测试",null),f(w,()=>n.isSaving?"❌ 正在保存中":"✅ 空闲",null),f(S,()=>n.state.testResult?.success?"所有条件都已满足，但按钮仍然禁用。这可能是一个bug。":"请返回第1步完成连接测试，然后才能保存数据源。"),r}}),null),f(e,y(W,{get when(){return n.saveResult},get children(){var r=Nr(),a=r.firstChild,l=a.firstChild,o=l.nextSibling;return f(l,()=>n.saveResult?.success?"✅":"❌"),f(o,()=>n.saveResult?.message),f(r,y(W,{get when(){return n.saveResult?.success&&n.saveResult.data_source_id},get children(){var c=_f(),d=c.firstChild,h=d.firstChild,g=h.nextSibling;return f(g,()=>n.saveResult.data_source_id),c}}),null),f(r,y(W,{get when(){return n.saveResult&&n.saveResult.warnings&&n.saveResult.warnings.length>0},get children(){var c=xf();return f(c,y(pe,{get each(){return n.saveResult.warnings||[]},children:d=>(()=>{var h=Cf();return h.firstChild,f(h,d,null),h})()})),c}}),null),f(r,y(W,{get when(){return n.saveResult&&n.saveResult.errors&&n.saveResult.errors.length>0},get children(){var c=Sf();return f(c,y(pe,{get each(){return n.saveResult.errors||[]},children:d=>(()=>{var h=kf();return h.firstChild,f(h,d,null),h})()})),c}}),null),G(()=>Se(r,`save-result ${n.saveResult?.success?"success":"error"}`)),r}}),null),f(e,y(W,{get when(){return!n.canSave},get children(){return wf()}}),null),G(r=>{var a=`save-btn ${n.canSave?"primary":"disabled"}`,l=n.isSaving||!n.canSave;return a!==r.e&&Se(s,r.e=a),l!==r.t&&(s.disabled=r.t=l),r},{e:void 0,t:void 0}),e})()}function If(n){const e=n.name.trim().length>0,t=n.customSQL.trim().length>0,i=n.testResult?.success,s=!n.isSaving;return console.log("🔍 保存条件检查:",{hasName:e,hasSQL:t,hasSuccessfulTest:i,notSaving:s,testResult:n.testResult,name:n.name,sql:n.customSQL}),!!(e&&t&&i&&s)}function Nf(n){return n==null?"(null)":typeof n=="string"&&n.length>50?n.substring(0,47)+"...":String(n)}Ue(["click","input"]);var zf=x("<input type=text class=search-input placeholder=搜索数据源...>"),Ff=x("<div class=add-buttons-group><button class=add-data-source-btn>📄 文件数据源</button><button class=add-database-source-btn>🗄️ 数据库数据源"),Gf=x("<div class=error-message>"),Bf=x("<div class=loading-message>加载中..."),Uf=x("<div class=empty-state><p></p><button>添加第一个数据源"),Hf=x("<div class=data-source-grid>"),qf=x("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),Wf=x("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),jf=x("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),Yf=x("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),Vf=x("<li><button> <!> (<!>)"),Xf=x("<th>"),Qf=x("<tr>"),Kf=x("<td>"),Jf=x("<span class=active-badge title=当前激活>当前"),Zf=x('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function e0(n){console.log("🏗️  DataSourceManagementCenter 组件渲染，isOpen:",n.isOpen);const[e,t]=J([]),[i,s]=J([]),[r,a]=J("main"),[l,o]=J(null),[c,d]=J(null),[h,g]=J(!1),[v,u]=J(null),[p,m]=J(null),[b,_]=J(""),[w,S]=J("all"),[C,A]=J("all");et(async()=>{try{await M(),await D();const B=Je.subscribe(H=>{m(H?.dataSource.id||null)});m(Je.getCurrentContext()?.dataSource.id||null),$t(B)}catch(B){console.error("🚨 数据源管理中心初始化失败:",B),u(`初始化失败: ${B}`)}});const M=async()=>{try{g(!0),console.log("🔄 加载数据源列表...");const B=await Re.listDataSources();console.log("✅ 数据源列表加载成功:",B),t(B),u(null)}catch(B){console.error("❌ 加载数据源失败:",B),u(`加载数据源失败: ${B}`)}finally{g(!1)}},D=async()=>{try{console.log("🔄 加载可用数据源类型...");const B=await Re.getAvailableTypes();console.log("✅ 数据源类型加载成功:",B),s(B)}catch(B){console.error("❌ 加载数据源类型失败:",B)}},z=B=>{const H=(B.providerType||"").toLowerCase();return H.includes("database_mysql")?"mysql":H.includes("database_postgresql")?"postgresql":H.includes("database")?"database":H.includes("json")?"json":H.includes("csv")?"csv":H.includes("excel")?"excel":H.includes("api")?"api":H||"unknown"},E=()=>{let B=e();if(b()){const H=b().toLowerCase();B=B.filter(j=>(j.name||"").toLowerCase().includes(H)||z(j).includes(H))}return w()!=="all"&&(B=B.filter(H=>H.status===w())),C()!=="all"&&(B=B.filter(H=>z(H)===C())),B},R=B=>e().filter(H=>H.status===B).length,k=B=>e().filter(H=>z(H)===B).length,q=()=>{a("add"),o(null)},N=()=>{a("add-database"),o(null)},$=B=>{o(B),a("edit")},P=async B=>{try{g(!0),u(null),o(B),console.log("🔄 开始预览数据源:",B.name);const H=await Re.getPreview(B.id);d(H),a("preview"),console.log("✅ 数据预览加载成功:",H)}catch(H){console.error("❌ 数据预览失败:",H),u(`预览数据源 "${B.name}" 失败: ${H}`)}finally{g(!1)}},X=async B=>{try{g(!0),await Je.setActiveDataSource(B.id)}catch(H){console.error("❌ 激活数据源失败:",H),u(`激活数据源失败: ${H}`)}finally{g(!1)}},F=async B=>{try{g(!0);const H=e().find(de=>de.id===B);if(!H){u(`数据源不存在: ${B}`);return}const j=await Re.testConnection(H.providerType||H.provider_type,H.config||{});alert(j?`✅ 数据源 "${H.name}" 连接测试成功！`:`❌ 数据源 "${H.name}" 连接测试失败`)}catch(H){console.error("❌ 测试连接失败:",H);const j=e().find(de=>de.id===B);alert(`❌ 数据源 "${j?.name||B}" 连接测试失败:
${H}`)}finally{g(!1)}},O=async B=>{const H=e().find(j=>j.id===B);if(confirm(`确定要删除数据源 "${H?.name}" 吗？`))try{await Re.deleteDataSource(B),await M()}catch(j){u(`删除数据源失败: ${j}`)}},V=()=>{a("main"),o(null),d(null),u(null)};return y(W,{get when(){return n.isOpen},get children(){var B=Yf(),H=B.firstChild,j=H.firstChild,de=j.nextSibling,me=de.nextSibling,fe=H.nextSibling;return Ae(j,"click",n.onClose),f(me,y(W,{get when(){return r()==="main"},get children(){return[(()=>{var ee=zf();return ee.$$input=oe=>_(oe.currentTarget.value),G(()=>ee.value=b()),ee})(),(()=>{var ee=Ff(),oe=ee.firstChild,ge=oe.nextSibling;return oe.$$click=q,ge.$$click=N,ee})()]}})),f(fe,y(W,{get when(){return r()==="main"},get children(){var ee=qf(),oe=ee.firstChild,ge=oe.firstChild,he=ge.firstChild,te=he.nextSibling,ne=te.firstChild,ve=ne.firstChild,be=ve.firstChild,ke=be.nextSibling;ke.nextSibling;var _e=ge.nextSibling,Pe=_e.firstChild,ue=Pe.nextSibling,xe=ue.firstChild,L=xe.firstChild,I=L.firstChild,K=I.nextSibling;K.nextSibling;var Y=xe.nextSibling,ie=Y.firstChild,ce=ie.firstChild,ae=ce.nextSibling;ae.nextSibling;var $e=Y.nextSibling,Ie=$e.firstChild,Te=Ie.firstChild,Ye=Te.nextSibling;Ye.nextSibling;var We=_e.nextSibling,ot=We.firstChild,Pt=ot.nextSibling,rt=Pt.firstChild,zr=rt.firstChild,_n=oe.nextSibling;return ve.$$click=()=>S("all"),f(ve,()=>e().length,ke),L.$$click=()=>S("active"),f(L,()=>R("active"),K),ie.$$click=()=>S("error"),f(ie,()=>R("error"),ae),Ie.$$click=()=>S("disabled"),f(Ie,()=>R("disabled"),Ye),zr.$$click=()=>A("all"),f(Pt,y(pe,{get each(){return i()},children:De=>(()=>{var je=Vf(),ct=je.firstChild,Qt=ct.firstChild,Kt=Qt.nextSibling,xn=Kt.nextSibling,zi=xn.nextSibling;return zi.nextSibling,ct.$$click=()=>A(De.typeName),f(ct,()=>De.category==="file"?"📄":De.category==="api"?"🌐":De.category==="database"?"🗄️":"📊",Qt),f(ct,()=>De.displayName,Kt),f(ct,()=>k(De.typeName),zi),G(()=>Se(je,C()===De.typeName?"active":"")),je})()}),null),f(_n,y(W,{get when(){return v()},get children(){var De=Gf();return f(De,v),De}}),null),f(_n,y(W,{get when(){return h()},get children(){return Bf()}}),null),f(_n,y(W,{get when(){return Ce(()=>!h())()&&E().length===0},get children(){var De=Uf(),je=De.firstChild,ct=je.nextSibling;return f(je,()=>b()||w()!=="all"||C()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),ct.$$click=q,De}}),null),f(_n,y(W,{get when(){return Ce(()=>!h())()&&E().length>0},get children(){var De=Hf();return f(De,y(pe,{get each(){return E()},children:je=>y(t0,{source:je,onPreview:()=>P(je),onTest:()=>F(je.id),onEdit:()=>$(je),onDelete:()=>O(je.id),onActivate:()=>X(je),get active(){return p()===je.id}})})),De}}),null),G(De=>{var je=w()==="all"?"active":"",ct=w()==="active"?"active":"",Qt=w()==="error"?"active":"",Kt=w()==="disabled"?"active":"",xn=C()==="all"?"active":"";return je!==De.e&&Se(ne,De.e=je),ct!==De.t&&Se(xe,De.t=ct),Qt!==De.a&&Se(Y,De.a=Qt),Kt!==De.o&&Se($e,De.o=Kt),xn!==De.i&&Se(rt,De.i=xn),De},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ee}}),null),f(fe,y(W,{get when(){return r()==="add"},get children(){return y(Ir,{get availableTypes(){return i()},onBack:V,onSuccess:()=>{M(),V()}})}}),null),f(fe,y(W,{get when(){return r()==="add-database"},get children(){return y(Ef,{onBack:V,onSuccess:()=>{M(),V()}})}}),null),f(fe,y(W,{get when(){return Ce(()=>r()==="edit")()&&l()},get children(){var ee=Wf(),oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling;return he.firstChild,ge.$$click=V,f(he,()=>l()?.name,null),ee}}),null),f(fe,y(W,{get when(){return Ce(()=>!!(r()==="preview"&&l()))()&&c()},get children(){var ee=jf(),oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling;he.firstChild;var te=he.nextSibling,ne=te.firstChild,ve=ne.nextSibling,be=ve.nextSibling,ke=be.nextSibling;ke.nextSibling;var _e=oe.nextSibling,Pe=_e.firstChild,ue=Pe.firstChild,xe=ue.firstChild,L=ue.nextSibling;return ge.$$click=V,f(he,()=>l()?.name,null),f(te,()=>c()?.totalCount??c()?.total_rows,ve),f(te,()=>c()?.rows.length,ke),f(xe,y(pe,{get each(){return c()?.columns},children:I=>(()=>{var K=Xf();return f(K,I),K})()})),f(L,y(pe,{get each(){return c()?.rows.slice(0,50)},children:I=>(()=>{var K=Qf();return f(K,y(pe,{get each(){return c()?.columns||[]},children:Y=>(()=>{var ie=Kf();return f(ie,(()=>{var ce=Ce(()=>typeof I[Y]=="object");return()=>ce()?JSON.stringify(I[Y]):String(I[Y]||"")})()),ie})()})),K})()})),ee}}),null),B}})}function t0(n){const e=a=>{switch(a){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},t=a=>{switch(a){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},i=a=>{const l=new Date,o=new Date(a),c=l.getTime()-o.getTime(),d=Math.floor(c/(1e3*60*60));return d<1?"刚刚更新":d<24?`${d}小时前`:o.toLocaleDateString("zh-CN")},s=a=>{const l=(a||"").toLowerCase();return l.includes("json")?"📄":l.includes("api")?"🌐":l.includes("csv")?"📊":l.includes("database")?"🗄️":"📋"},r=a=>{const l=(a.providerType||a.provider_type||"").toLowerCase();return l.includes("database_mysql")?"MySQL":l.includes("database_postgresql")?"PostgreSQL":l==="json"?"JSON":l==="csv"?"CSV":l==="excel"?"Excel":l.startsWith("api")?"API":l.startsWith("database")?"Database":a.providerType||a.provider_type||"Unknown"};return(()=>{var a=Zf(),l=a.firstChild,o=l.firstChild,c=o.firstChild,d=c.nextSibling,h=o.nextSibling,g=l.nextSibling,v=g.firstChild,u=v.firstChild,p=u.nextSibling,m=v.nextSibling,b=m.firstChild,_=b.nextSibling,w=m.nextSibling,S=w.firstChild,C=S.nextSibling,A=g.nextSibling,M=A.firstChild,D=M.nextSibling,z=D.nextSibling,E=z.nextSibling,R=E.nextSibling;return f(c,()=>s(n.source.providerType)),f(d,()=>n.source.name,null),f(d,y(W,{get when(){return n.active},get children(){return Jf()}}),null),f(p,()=>r(n.source)),f(_,()=>t(n.source.status)),f(C,()=>i(n.source.lastUpdated)),Ae(M,"click",n.onPreview),Ae(D,"click",n.onTest),Ae(z,"click",n.onEdit),Ae(E,"click",n.onActivate),Ae(R,"click",n.onDelete),G(k=>{var q=n.active?"true":"false",N=e(n.source.status),$=`状态: ${t(n.source.status)}`,P=n.source.status!=="active",X=n.active;return q!==k.e&&Q(a,"data-active",k.e=q),N!==k.t&&((k.t=N)!=null?h.style.setProperty("background-color",N):h.style.removeProperty("background-color")),$!==k.a&&Q(h,"title",k.a=$),P!==k.o&&(M.disabled=k.o=P),X!==k.i&&(E.disabled=k.i=X),k},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),a})()}Ue(["click","input"]);function n0(n){return{id:n.id,type:i0(n.type),transform:{translate:{x:n.position.x,y:n.position.y},...n.scale&&{scale:{x:n.scale.x,y:n.scale.y}},...n.rotation!==void 0&&{rotate:n.rotation}},style:{width:n.size.width,height:n.size.height,fill:n.style?.fill_color,stroke:n.style?.border?.color,strokeWidth:n.style?.border?.width,opacity:n.style?.opacity},data:n.content,visible:n.visible,locked:n.locked}}function i0(n){return{Text:"text",Rectangle:"rect",Circle:"circle",Line:"path",Image:"image",DataField:"text"}[n]||"rect"}var s0=x('<div class="mb-6 p-4 bg-gray-50 rounded-lg"><h3 class="text-sm font-medium text-gray-700 mb-3">PDF 选项</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-gray-600 mb-1">页面大小</label><select class="w-full p-2 border border-gray-300 rounded text-sm"></select></div><div><label class="block text-xs text-gray-600 mb-1">方向</label><select class="w-full p-2 border border-gray-300 rounded text-sm"><option value=portrait>纵向</option><option value=landscape>横向'),r0=x('<div class="mb-6 p-4 bg-gray-50 rounded-lg"><h3 class="text-sm font-medium text-gray-700 mb-3">图片选项</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-gray-600 mb-1">DPI (<!>)</label><input type=range min=72 max=300 step=1 class=w-full></div><div><label class="block text-xs text-gray-600 mb-1">压缩质量 (<!>%)</label><input type=range min=0.1 max=1 step=0.1 class=w-full>'),a0=x('<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">'),l0=x('<div class=mb-4><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full transition-all duration-300"></div></div><p class="text-sm text-gray-600 mt-1">导出中... <!>%'),o0=x('<div style=position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;display:flex;align-items:center;justify-content:center;><div style="position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(0, 0, 0, 0.5);"></div><div style="position:relative;background-color:white;border-radius:8px;box-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);padding:24px;width:500px;max-width:90vw;max-height:80vh;overflow-y:auto;"><h2 class="text-xl font-semibold mb-4">导出报表</h2><div class=mb-6><label class="block text-sm font-medium text-gray-700 mb-2">导出格式</label><div class="grid grid-cols-2 gap-2"></div></div><div class=mb-6><label class="block text-sm font-medium text-gray-700 mb-2">输出质量</label><select class="w-full p-2 border border-gray-300 rounded-lg"></select></div><div class="flex justify-end gap-3"><button class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">取消</button><button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">'),c0=x("<button><span class=text-lg></span><span class=text-sm>"),Ps=x("<option>");const d0=n=>{const{state:e}=at(),[t,i]=J("pdf"),[s,r]=J("high"),[a,l]=J(!1),[o,c]=J(0),[d,h]=J(""),[g,v]=J("a4"),[u,p]=J("portrait"),[m,b]=J(150),[_,w]=J(.9),S=[{value:"pdf",label:"PDF 文档",icon:"📄"},{value:"png",label:"PNG 图片",icon:"🖼️"},{value:"jpg",label:"JPG 图片",icon:"🖼️"},{value:"svg",label:"SVG 矢量图",icon:"🎨"},{value:"excel",label:"Excel 表格",icon:"📊"}],C=[{value:"draft",label:"草稿"},{value:"standard",label:"标准"},{value:"high",label:"高质量"},{value:"print",label:"打印"}],A=[{value:"a4",label:"A4"},{value:"a3",label:"A3"},{value:"a5",label:"A5"},{value:"letter",label:"Letter"},{value:"legal",label:"Legal"}],M=async()=>{l(!0),h(""),c(0);try{const D={pdf:"pdf",png:"png",jpg:"jpg",webp:"webp",svg:"svg",excel:"xlsx",powerpoint:"pptx"},z=await Js({title:`导出为 ${t().toUpperCase()}`,defaultPath:`report.${D[t()]}`,filters:[{name:S.find(q=>q.value===t())?.label||"File",extensions:[D[t()]]}]});if(!z){l(!1);return}const E={format:t(),quality:s(),customProperties:{}};t()==="pdf"&&(E.pdfOptions={pageSize:g(),orientation:u(),margins:{top:20,right:20,bottom:20,left:20},embedFonts:!0,compressImages:!0,pdfVersion:"1.7"}),["png","jpg","webp"].includes(t())&&(E.imageQuality={dpi:m(),compression:_(),colorSpace:"srgb",antiAliasing:!0}),t()==="excel"&&(E.excelOptions={sheetName:"Report",includeFormatting:!0,autoFitColumns:!0,freezeHeader:!0,cellMappingStrategy:"position_based"});const R={elements:e.elements,canvasConfig:e.canvas_config,options:E,useCache:!0};if(c(30),!0){const q=e.elements.map(n0),N=await ye("export_with_skia",{elements:q,filePath:z,options:{format:t(),quality:t()==="jpg"?Math.round(_()*100):void 0,dpi:m(),width:e.canvas_config.width,height:e.canvas_config.height}});console.log("✅ Skia 导出成功:",N)}c(100),console.log("✅ 导出成功"),setTimeout(()=>{n.onClose(),l(!1),c(0)},500)}catch(D){console.error("❌ 导出失败:",D),h(D?.toString()||"导出失败"),l(!1),c(0)}};return y(W,{get when(){return n.isOpen},get children(){var D=o0(),z=D.firstChild,E=z.nextSibling,R=E.firstChild,k=R.nextSibling,q=k.firstChild,N=q.nextSibling,$=k.nextSibling,P=$.firstChild,X=P.nextSibling,F=$.nextSibling,O=F.firstChild,V=O.nextSibling;return Ae(z,"click",n.onClose),f(N,y(pe,{each:S,children:B=>(()=>{var H=c0(),j=H.firstChild,de=j.nextSibling;return H.$$click=()=>i(B.value),f(j,()=>B.icon),f(de,()=>B.label),G(()=>Se(H,`p-3 border rounded-lg flex items-center gap-2 transition-colors ${t()===B.value?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`)),H})()})),X.addEventListener("change",B=>r(B.target.value)),f(X,y(pe,{each:C,children:B=>(()=>{var H=Ps();return f(H,()=>B.label),G(()=>H.value=B.value),H})()})),f(E,y(W,{get when(){return t()==="pdf"},get children(){var B=s0(),H=B.firstChild,j=H.nextSibling,de=j.firstChild,me=de.firstChild,fe=me.nextSibling,ee=de.nextSibling,oe=ee.firstChild,ge=oe.nextSibling;return fe.addEventListener("change",he=>v(he.target.value)),f(fe,y(pe,{each:A,children:he=>(()=>{var te=Ps();return f(te,()=>he.label),G(()=>te.value=he.value),te})()})),ge.addEventListener("change",he=>p(he.target.value)),G(()=>fe.value=g()),G(()=>ge.value=u()),B}}),F),f(E,y(W,{get when(){return["png","jpg","webp"].includes(t())},get children(){var B=r0(),H=B.firstChild,j=H.nextSibling,de=j.firstChild,me=de.firstChild,fe=me.firstChild,ee=fe.nextSibling;ee.nextSibling;var oe=me.nextSibling,ge=de.nextSibling,he=ge.firstChild,te=he.firstChild,ne=te.nextSibling;ne.nextSibling;var ve=he.nextSibling;return f(me,m,ee),oe.addEventListener("change",be=>b(parseInt(be.target.value))),f(he,()=>Math.round(_()*100),ne),ve.addEventListener("change",be=>w(parseFloat(be.target.value))),G(()=>oe.value=m()),G(()=>ve.value=_()),B}}),F),f(E,y(W,{get when(){return d()},get children(){var B=a0();return f(B,d),B}}),F),f(E,y(W,{get when(){return a()},get children(){var B=l0(),H=B.firstChild,j=H.firstChild,de=H.nextSibling,me=de.firstChild,fe=me.nextSibling;return fe.nextSibling,f(de,o,fe),G(ee=>(ee=`${o()}%`)!=null?j.style.setProperty("width",ee):j.style.removeProperty("width")),B}}),F),Ae(O,"click",n.onClose),V.$$click=M,f(V,()=>a()?"导出中...":"导出"),G(B=>{var H=a(),j=a();return H!==B.e&&(O.disabled=B.e=H),j!==B.t&&(V.disabled=B.t=j),B},{e:void 0,t:void 0}),G(()=>X.value=s()),D}})};Ue(["click"]);var h0=x("<div class=flex-1>"),As=x('<div class="w-80 bg-primary border-r border-default flex flex-col">'),Rs=x('<div class="flex-1 flex flex-col bg-tertiary">'),u0=x('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">'),g0=x('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class="border-b border-default min-h-fit"></div><div class=min-h-fit>'),f0=x('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden">');const v0=()=>{const{state:n}=Xn(),[e,t]=J(!1),[i,s]=J(!1),[r,a]=J(!1);console.log("🖥️  MainLayout渲染，当前模式:",n().mode);const l=()=>{console.log("🔄 数据源按钮被点击，准备打开管理中心"),console.log("📊 当前管理中心状态:",i()),s(!0),console.log("✅ 管理中心状态已设置为 true"),console.log("📊 设置后的管理中心状态:",i())},o=()=>t(!1),c=()=>s(!1),d=()=>{console.log("📤 打开导出对话框"),a(!0)},h=()=>{a(!1)};return(()=>{var g=f0(),v=g.firstChild;return f(g,y(xa,{onOpenDataSources:l,onOpenExport:d}),v),f(v,y(Hs,{get children(){return[y(xt,{get when(){return n().mode==="preview"},get children(){var u=h0();return f(u,y(Kd,{})),u}}),y(xt,{get when(){return n().mode==="design"},get children(){return[(()=>{var u=As();return f(u,y(qi,{})),u})(),(()=>{var u=Rs();return f(u,y(Ki,{})),u})(),(()=>{var u=u0(),p=u.firstChild,m=p.firstChild,b=m.nextSibling;return f(m,y(Xi,{})),f(b,y(Es,{})),u})()]}}),y(xt,{get when(){return n().mode==="data"},get children(){return[(()=>{var u=As();return f(u,y(qi,{})),u})(),(()=>{var u=Rs();return f(u,y(Ki,{})),u})(),(()=>{var u=g0(),p=u.firstChild,m=p.firstChild,b=m.nextSibling;return f(m,y(Es,{})),f(b,y(Xi,{})),u})()]}})]}})),f(g,y(e0,{get isOpen(){return i()},onClose:c}),null),f(g,y(Pu,{get isOpen(){return e()},onClose:o}),null),f(g,y(d0,{get isOpen(){return r()},onClose:h}),null),g})()},p0=()=>y(ia,{get children(){return y(v0,{})}}),m0={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},b0=()=>{const{state:n,copySelectedElements:e,pasteElements:t,deleteElements:i,undo:s,redo:r,selectAllElements:a,clearSelection:l,moveElements:o}=at(),c=(u,p)=>{const m=u.key.toLowerCase()===p.key.toLowerCase()||u.key===p.key,b=!!p.ctrl===(u.ctrlKey||u.metaKey),_=!!p.alt===u.altKey,w=!!p.shift===u.shiftKey;return m&&b&&_&&w},d=async u=>{console.log("🎯 执行快捷键:",u);try{switch(u){case"copy":n.selected_ids.length>0&&(await e(),g("复制成功","✅"));break;case"paste":const p={x:20,y:20},m=await t(p.x,p.y);m.length>0&&g(`粘贴 ${m.length} 个元素`,"📋");break;case"cut":n.selected_ids.length>0&&(await e(),await i([...n.selected_ids]),g("剪切成功","✂️"));break;case"delete":if(n.selected_ids.length>0){const b=n.selected_ids.length;await i([...n.selected_ids]),g(`删除 ${b} 个元素`,"🗑️")}break;case"undo":await s(),g("撤销","↶");break;case"redo":await r(),g("重做","↷");break;case"selectAll":await a(),g(`全选 ${n.elements.length} 个元素`,"🎯");break;case"clearSelection":n.selected_ids.length>0&&(l(),g("清除选择","⭕"));break;case"duplicate":if(n.selected_ids.length>0){await e();const b=await t(20,20);g(`复制 ${b.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await h(u);break;default:console.warn("未知的快捷键动作:",u)}}catch(p){console.error("快捷键执行失败:",p),g("操作失败","❌")}},h=async u=>{if(n.selected_ids.length===0)return;const p=u.includes("Fast"),m=p?10:1;let b=0,_=0;switch(u){case"moveUp":case"moveFastUp":_=-m;break;case"moveDown":case"moveFastDown":_=m;break;case"moveLeft":case"moveFastLeft":b=-m;break;case"moveRight":case"moveFastRight":b=m;break}(b!==0||_!==0)&&(await o([...n.selected_ids],b,_),p&&g(`快速移动 ${m}px`,"🔄"))},g=(u,p)=>{const m=document.createElement("div");m.className="keyboard-feedback",m.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${p}</span>
        <span class="feedback-text">${u}</span>
      </div>
    `,document.body.appendChild(m),setTimeout(()=>{m.parentNode&&m.parentNode.removeChild(m)},2e3)},v=u=>{const p=u.target;if(!(p.tagName==="INPUT"||p.tagName==="TEXTAREA"||p.contentEditable==="true")){for(const[b,_]of Object.entries(m0))if(c(u,_.combination)){u.preventDefault(),u.stopPropagation(),console.log("🎹 快捷键触发:",b,_.action),d(_.action);return}}};return et(()=>{if(document.addEventListener("keydown",v,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const u=document.createElement("style");u.id="keyboard-feedback-styles",u.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(u)}}),$t(()=>{document.removeEventListener("keydown",v,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},y0=()=>(et(()=>{document.addEventListener("contextmenu",n=>n.preventDefault());try{const n=typeof window<"u"?window.localStorage.getItem("jasper.activeDataSourceId"):null;n&&Je.setActiveDataSource(n).catch(e=>{console.warn("恢复激活数据源失败:",e)})}catch(n){console.warn("读取本地激活数据源失败:",n)}}),y(ha,{get children(){return[y(b0,{}),y(p0,{})]}})),_0=document.getElementById("root");Kr(()=>y(y0,{}),_0);
