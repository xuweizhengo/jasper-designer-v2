(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const Br=!1,Ur=(n,e)=>n===e,Dt=Symbol("solid-proxy"),vi=Symbol("solid-track"),Fn={equals:Ur};let Rs=zs;const $t=1,Gn=2,Ls={owned:null,cleanups:null,context:null,owner:null};var Ge=null;let Zn=null,Hr=null,He=null,Ve=null,vt=null,Xn=0;function In(n,e){const t=He,i=Ge,s=n.length===0,r=e===void 0?i:e,a=s?Ls:{owned:null,cleanups:null,context:r?r.context:null,owner:r},l=s?n:()=>n(()=>it(()=>vn(a)));Ge=a,He=null;try{return Xt(l,!0)}finally{He=t,Ge=i}}function K(n,e){e=e?Object.assign({},Fn,e):Fn;const t={value:n,observers:null,observerSlots:null,comparator:e.equals||void 0},i=s=>(typeof s=="function"&&(s=s(t.value)),Ns(t,s));return[Is.bind(t),i]}function F(n,e,t){const i=Ri(n,e,!1,$t);yn(i)}function Vt(n,e,t){Rs=Yr;const i=Ri(n,e,!1,$t);i.user=!0,vt?vt.push(i):yn(i)}function Me(n,e,t){t=t?Object.assign({},Fn,t):Fn;const i=Ri(n,e,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=t.equals||void 0,yn(i),Is.bind(i)}function qr(n){return Xt(n,!1)}function it(n){if(He===null)return n();const e=He;He=null;try{return n()}finally{He=e}}function Qe(n){Vt(()=>it(n))}function dt(n){return Ge===null||(Ge.cleanups===null?Ge.cleanups=[n]:Ge.cleanups.push(n)),n}function pi(){return He}const[P0,A0]=K(!1);function Ms(n,e){const t=Symbol("context");return{id:t,Provider:Xr(t),defaultValue:n}}function Ds(n){let e;return Ge&&Ge.context&&(e=Ge.context[n.id])!==void 0?e:n.defaultValue}function Os(n){const e=Me(n),t=Me(()=>mi(e()));return t.toArray=()=>{const i=t();return Array.isArray(i)?i:i!=null?[i]:[]},t}function Is(){if(this.sources&&this.state)if(this.state===$t)yn(this);else{const n=Ve;Ve=null,Xt(()=>Un(this),!1),Ve=n}if(He){const n=this.observers?this.observers.length:0;He.sources?(He.sources.push(this),He.sourceSlots.push(n)):(He.sources=[this],He.sourceSlots=[n]),this.observers?(this.observers.push(He),this.observerSlots.push(He.sources.length-1)):(this.observers=[He],this.observerSlots=[He.sources.length-1])}return this.value}function Ns(n,e,t){let i=n.value;return(!n.comparator||!n.comparator(i,e))&&(n.value=e,n.observers&&n.observers.length&&Xt(()=>{for(let s=0;s<n.observers.length;s+=1){const r=n.observers[s],a=Zn&&Zn.running;a&&Zn.disposed.has(r),(a?!r.tState:!r.state)&&(r.pure?Ve.push(r):vt.push(r),r.observers&&Fs(r)),a||(r.state=$t)}if(Ve.length>1e6)throw Ve=[],new Error},!1)),e}function yn(n){if(!n.fn)return;vn(n);const e=Xn;Wr(n,n.value,e)}function Wr(n,e,t){let i;const s=Ge,r=He;He=Ge=n;try{i=n.fn(e)}catch(a){return n.pure&&(n.state=$t,n.owned&&n.owned.forEach(vn),n.owned=null),n.updatedAt=t+1,Gs(a)}finally{He=r,Ge=s}(!n.updatedAt||n.updatedAt<=t)&&(n.updatedAt!=null&&"observers"in n?Ns(n,i):n.value=i,n.updatedAt=t)}function Ri(n,e,t,i=$t,s){const r={fn:n,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:Ge,context:Ge?Ge.context:null,pure:t};return Ge===null||Ge!==Ls&&(Ge.owned?Ge.owned.push(r):Ge.owned=[r]),r}function Bn(n){if(n.state===0)return;if(n.state===Gn)return Un(n);if(n.suspense&&it(n.suspense.inFallback))return n.suspense.effects.push(n);const e=[n];for(;(n=n.owner)&&(!n.updatedAt||n.updatedAt<Xn);)n.state&&e.push(n);for(let t=e.length-1;t>=0;t--)if(n=e[t],n.state===$t)yn(n);else if(n.state===Gn){const i=Ve;Ve=null,Xt(()=>Un(n,e[0]),!1),Ve=i}}function Xt(n,e){if(Ve)return n();let t=!1;e||(Ve=[]),vt?t=!0:vt=[],Xn++;try{const i=n();return jr(t),i}catch(i){t||(vt=null),Ve=null,Gs(i)}}function jr(n){if(Ve&&(zs(Ve),Ve=null),n)return;const e=vt;vt=null,e.length&&Xt(()=>Rs(e),!1)}function zs(n){for(let e=0;e<n.length;e++)Bn(n[e])}function Yr(n){let e,t=0;for(e=0;e<n.length;e++){const i=n[e];i.user?n[t++]=i:Bn(i)}for(e=0;e<t;e++)Bn(n[e])}function Un(n,e){n.state=0;for(let t=0;t<n.sources.length;t+=1){const i=n.sources[t];if(i.sources){const s=i.state;s===$t?i!==e&&(!i.updatedAt||i.updatedAt<Xn)&&Bn(i):s===Gn&&Un(i,e)}}}function Fs(n){for(let e=0;e<n.observers.length;e+=1){const t=n.observers[e];t.state||(t.state=Gn,t.pure?Ve.push(t):vt.push(t),t.observers&&Fs(t))}}function vn(n){let e;if(n.sources)for(;n.sources.length;){const t=n.sources.pop(),i=n.sourceSlots.pop(),s=t.observers;if(s&&s.length){const r=s.pop(),a=t.observerSlots.pop();i<s.length&&(r.sourceSlots[a]=i,s[i]=r,t.observerSlots[i]=a)}}if(n.tOwned){for(e=n.tOwned.length-1;e>=0;e--)vn(n.tOwned[e]);delete n.tOwned}if(n.owned){for(e=n.owned.length-1;e>=0;e--)vn(n.owned[e]);n.owned=null}if(n.cleanups){for(e=n.cleanups.length-1;e>=0;e--)n.cleanups[e]();n.cleanups=null}n.state=0}function Vr(n){return n instanceof Error?n:new Error(typeof n=="string"?n:"Unknown error",{cause:n})}function Gs(n,e=Ge){throw Vr(n)}function mi(n){if(typeof n=="function"&&!n.length)return mi(n());if(Array.isArray(n)){const e=[];for(let t=0;t<n.length;t++){const i=mi(n[t]);Array.isArray(i)?e.push.apply(e,i):e.push(i)}return e}return n}function Xr(n,e){return function(i){let s;return F(()=>s=it(()=>(Ge.context={...Ge.context,[n]:i.value},Os(()=>i.children))),void 0),s}}const Qr=Symbol("fallback");function Fi(n){for(let e=0;e<n.length;e++)n[e]()}function Jr(n,e,t={}){let i=[],s=[],r=[],a=0,l=e.length>1?[]:null;return dt(()=>Fi(r)),()=>{let o=n()||[],c=o.length,d,u;return o[vi],it(()=>{let v,h,p,b,m,y,$,x,w;if(c===0)a!==0&&(Fi(r),r=[],i=[],s=[],a=0,l&&(l=[])),t.fallback&&(i=[Qr],s[0]=In(P=>(r[0]=P,t.fallback())),a=1);else if(a===0){for(s=new Array(c),u=0;u<c;u++)i[u]=o[u],s[u]=In(g);a=c}else{for(p=new Array(c),b=new Array(c),l&&(m=new Array(c)),y=0,$=Math.min(a,c);y<$&&i[y]===o[y];y++);for($=a-1,x=c-1;$>=y&&x>=y&&i[$]===o[x];$--,x--)p[x]=s[$],b[x]=r[$],l&&(m[x]=l[$]);for(v=new Map,h=new Array(x+1),u=x;u>=y;u--)w=o[u],d=v.get(w),h[u]=d===void 0?-1:d,v.set(w,u);for(d=y;d<=$;d++)w=i[d],u=v.get(w),u!==void 0&&u!==-1?(p[u]=s[d],b[u]=r[d],l&&(m[u]=l[d]),u=h[u],v.set(w,u)):r[d]();for(u=y;u<c;u++)u in p?(s[u]=p[u],r[u]=b[u],l&&(l[u]=m[u],l[u](u))):s[u]=In(g);s=s.slice(0,a=c),i=o.slice(0)}return s});function g(v){if(r[u]=v,l){const[h,p]=K(u);return l[u]=p,e(o[u],h)}return e(o[u])}}}function _(n,e){return it(()=>n(e||{}))}const Bs=n=>`Stale read from <${n}>.`;function pe(n){const e="fallback"in n&&{fallback:()=>n.fallback};return Me(Jr(()=>n.each,n.children,e||void 0))}function W(n){const e=n.keyed,t=Me(()=>n.when,void 0,void 0),i=e?t:Me(t,void 0,{equals:(s,r)=>!s==!r});return Me(()=>{const s=i();if(s){const r=n.children;return typeof r=="function"&&r.length>0?it(()=>r(e?s:()=>{if(!it(i))throw Bs("Show");return t()})):r}return n.fallback},void 0,void 0)}function Us(n){const e=Os(()=>n.children),t=Me(()=>{const i=e(),s=Array.isArray(i)?i:[i];let r=()=>{};for(let a=0;a<s.length;a++){const l=a,o=s[a],c=r,d=Me(()=>c()?void 0:o.when,void 0,void 0),u=o.keyed?d:Me(d,void 0,{equals:(g,v)=>!g==!v});r=()=>c()||(u()?[l,d,o]:void 0)}return r});return Me(()=>{const i=t()();if(!i)return n.fallback;const[s,r,a]=i,l=a.children;return typeof l=="function"&&l.length>0?it(()=>l(a.keyed?r():()=>{if(it(t)()?.[0]!==s)throw Bs("Match");return r()})):l},void 0,void 0)}function St(n){return n}const $e=n=>Me(()=>n());function Kr(n,e,t){let i=t.length,s=e.length,r=i,a=0,l=0,o=e[s-1].nextSibling,c=null;for(;a<s||l<r;){if(e[a]===t[l]){a++,l++;continue}for(;e[s-1]===t[r-1];)s--,r--;if(s===a){const d=r<i?l?t[l-1].nextSibling:t[r-l]:o;for(;l<r;)n.insertBefore(t[l++],d)}else if(r===l)for(;a<s;)(!c||!c.has(e[a]))&&e[a].remove(),a++;else if(e[a]===t[r-1]&&t[l]===e[s-1]){const d=e[--s].nextSibling;n.insertBefore(t[l++],e[a++].nextSibling),n.insertBefore(t[--r],d),e[s]=t[r]}else{if(!c){c=new Map;let u=l;for(;u<r;)c.set(t[u],u++)}const d=c.get(e[a]);if(d!=null)if(l<d&&d<r){let u=a,g=1,v;for(;++u<s&&u<r&&!((v=c.get(e[u]))==null||v!==d+g);)g++;if(g>d-l){const h=e[a];for(;l<d;)n.insertBefore(t[l++],h)}else n.replaceChild(t[l++],e[a++])}else a++;else e[a++].remove()}}}const Gi="_$DX_DELEGATE";function Zr(n,e,t,i={}){let s;return In(r=>{s=r,e===document?n():f(e,n(),e.firstChild?null:void 0,t)},i.owner),()=>{s(),e.textContent=""}}function S(n,e,t,i){let s;const r=()=>{const l=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return l.innerHTML=n,t?l.content.firstChild.firstChild:i?l.firstChild:l.content.firstChild},a=e?()=>it(()=>document.importNode(s||(s=r()),!0)):()=>(s||(s=r())).cloneNode(!0);return a.cloneNode=a,a}function Ue(n,e=window.document){const t=e[Gi]||(e[Gi]=new Set);for(let i=0,s=n.length;i<s;i++){const r=n[i];t.has(r)||(t.add(r),e.addEventListener(r,ea))}}function Q(n,e,t){t==null?n.removeAttribute(e):n.setAttribute(e,t)}function Se(n,e){e==null?n.removeAttribute("class"):n.className=e}function Ae(n,e,t,i){Array.isArray(t)?(n[`$$${e}`]=t[0],n[`$$${e}Data`]=t[1]):n[`$$${e}`]=t}function Hs(n,e,t){if(!e)return t?Q(n,"style"):e;const i=n.style;if(typeof e=="string")return i.cssText=e;typeof t=="string"&&(i.cssText=t=void 0),t||(t={}),e||(e={});let s,r;for(r in t)e[r]==null&&i.removeProperty(r),delete t[r];for(r in e)s=e[r],s!==t[r]&&(i.setProperty(r,s),t[r]=s);return t}function Qt(n,e,t){return it(()=>n(e,t))}function f(n,e,t,i){if(t!==void 0&&!i&&(i=[]),typeof e!="function")return Hn(n,e,i,t);F(s=>Hn(n,e(),s,t),i)}function ea(n){let e=n.target;const t=`$$${n.type}`,i=n.target,s=n.currentTarget,r=o=>Object.defineProperty(n,"target",{configurable:!0,value:o}),a=()=>{const o=e[t];if(o&&!e.disabled){const c=e[`${t}Data`];if(c!==void 0?o.call(e,c,n):o.call(e,n),n.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(n.target)&&r(e.host),!0},l=()=>{for(;a()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(n,"currentTarget",{configurable:!0,get(){return e||document}}),n.composedPath){const o=n.composedPath();r(o[0]);for(let c=0;c<o.length-2&&(e=o[c],!!a());c++){if(e._$host){e=e._$host,l();break}if(e.parentNode===s)break}}else l();r(i)}function Hn(n,e,t,i,s){for(;typeof t=="function";)t=t();if(e===t)return t;const r=typeof e,a=i!==void 0;if(n=a&&t[0]&&t[0].parentNode||n,r==="string"||r==="number"){if(r==="number"&&(e=e.toString(),e===t))return t;if(a){let l=t[0];l&&l.nodeType===3?l.data!==e&&(l.data=e):l=document.createTextNode(e),t=Gt(n,t,i,l)}else t!==""&&typeof t=="string"?t=n.firstChild.data=e:t=n.textContent=e}else if(e==null||r==="boolean")t=Gt(n,t,i);else{if(r==="function")return F(()=>{let l=e();for(;typeof l=="function";)l=l();t=Hn(n,l,t,i)}),()=>t;if(Array.isArray(e)){const l=[],o=t&&Array.isArray(t);if(bi(l,e,t,s))return F(()=>t=Hn(n,l,t,i,!0)),()=>t;if(l.length===0){if(t=Gt(n,t,i),a)return t}else o?t.length===0?Bi(n,l,i):Kr(n,t,l):(t&&Gt(n),Bi(n,l));t=l}else if(e.nodeType){if(Array.isArray(t)){if(a)return t=Gt(n,t,i,e);Gt(n,t,null,e)}else t==null||t===""||!n.firstChild?n.appendChild(e):n.replaceChild(e,n.firstChild);t=e}}return t}function bi(n,e,t,i){let s=!1;for(let r=0,a=e.length;r<a;r++){let l=e[r],o=t&&t[n.length],c;if(!(l==null||l===!0||l===!1))if((c=typeof l)=="object"&&l.nodeType)n.push(l);else if(Array.isArray(l))s=bi(n,l,o)||s;else if(c==="function")if(i){for(;typeof l=="function";)l=l();s=bi(n,Array.isArray(l)?l:[l],Array.isArray(o)?o:[o])||s}else n.push(l),s=!0;else{const d=String(l);o&&o.nodeType===3&&o.data===d?n.push(o):n.push(document.createTextNode(d))}}return s}function Bi(n,e,t=null){for(let i=0,s=e.length;i<s;i++)n.insertBefore(e[i],t)}function Gt(n,e,t,i){if(t===void 0)return n.textContent="";const s=i||document.createTextNode("");if(e.length){let r=!1;for(let a=e.length-1;a>=0;a--){const l=e[a];if(s!==l){const o=l.parentNode===n;!r&&!a?o?n.replaceChild(s,l):n.insertBefore(s,t):o&&l.remove()}else r=!0}}else n.insertBefore(s,t);return[s]}var ta=S("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),na=S("<span class=loading-indicator>⏳"),ia=S("<button><span class=button-icon></span><span class=button-text>"),sa=S("<div class=error-indicator>❌");const qs=Ms(),ra=n=>{const[e,t]=K({mode:"design",loading:!1,error:void 0}),i=u=>{t(g=>({...g,mode:u,error:void 0})),console.log(`🎯 预览模式切换: ${u==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:u,timestamp:Date.now()}}))},d={state:e,actions:{setMode:i,toggleMode:()=>{const u=e().mode;i(u==="design"?"data":u==="data"?"preview":"design")},setLoading:u=>{t(g=>({...g,loading:u}))},setError:u=>{t(g=>({...g,error:u,loading:!1}))},isDesignMode:()=>e().mode==="design",isDataMode:()=>e().mode==="data",isPreviewMode:()=>e().mode==="preview"}};return _(qs.Provider,{value:d,get children(){return n.children}})},_n=()=>{const n=Ds(qs);if(!n)throw new Error("usePreview必须在PreviewProvider内使用");return n},aa=()=>{const{state:n,actions:e}=_n(),t=s=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[s],i=()=>t(n().mode);return(()=>{var s=ta(),r=s.firstChild,a=r.firstChild,l=a.nextSibling,o=r.nextSibling;return f(a,()=>i().icon),f(l,()=>i().text),f(r,(()=>{var c=$e(()=>!!n().loading);return()=>c()&&na()})(),null),f(o,()=>["design","data","preview"].map(c=>{const d=t(c),u=n().mode===c;return(()=>{var g=ia(),v=g.firstChild,h=v.nextSibling;return g.$$click=()=>e.setMode(c),Se(g,`mode-btn ${u?"active":""}`),f(v,()=>d.icon),f(h,()=>d.text),F(p=>{var b=n().loading,m=`切换到${d.text}`;return b!==p.e&&(g.disabled=p.e=b),m!==p.t&&Q(g,"title",p.t=m),p},{e:void 0,t:void 0}),g})()})),f(s,(()=>{var c=$e(()=>!!n().error);return()=>c()&&(()=>{var d=sa();return F(()=>Q(d,"title",n().error)),d})()})(),null),s})()},ei={getModeDisplayText:n=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[n],getModeIcon:n=>({design:"🎨",data:"🔗",preview:"🔍"})[n],shouldShowExpression:n=>n==="design",shouldEvaluateExpression:n=>n==="data"||n==="preview",shouldShowDesignAids:n=>n==="design"||n==="data",shouldAllowInteraction:n=>n==="design"||n==="data",isReadOnlyMode:n=>n==="preview",getModeTransitionClass:n=>`mode-${n}-active`};Ue(["click"]);const yi=Symbol("store-raw"),jt=Symbol("store-node"),gt=Symbol("store-has"),Ws=Symbol("store-self");function js(n){let e=n[Dt];if(!e&&(Object.defineProperty(n,Dt,{value:e=new Proxy(n,ca)}),!Array.isArray(n))){const t=Object.keys(n),i=Object.getOwnPropertyDescriptors(n);for(let s=0,r=t.length;s<r;s++){const a=t[s];i[a].get&&Object.defineProperty(n,a,{enumerable:i[a].enumerable,get:i[a].get.bind(e)})}}return e}function qn(n){let e;return n!=null&&typeof n=="object"&&(n[Dt]||!(e=Object.getPrototypeOf(n))||e===Object.prototype||Array.isArray(n))}function pn(n,e=new Set){let t,i,s,r;if(t=n!=null&&n[yi])return t;if(!qn(n)||e.has(n))return n;if(Array.isArray(n)){Object.isFrozen(n)?n=n.slice(0):e.add(n);for(let a=0,l=n.length;a<l;a++)s=n[a],(i=pn(s,e))!==s&&(n[a]=i)}else{Object.isFrozen(n)?n=Object.assign({},n):e.add(n);const a=Object.keys(n),l=Object.getOwnPropertyDescriptors(n);for(let o=0,c=a.length;o<c;o++)r=a[o],!l[r].get&&(s=n[r],(i=pn(s,e))!==s&&(n[r]=i))}return n}function Wn(n,e){let t=n[e];return t||Object.defineProperty(n,e,{value:t=Object.create(null)}),t}function mn(n,e,t){if(n[e])return n[e];const[i,s]=K(t,{equals:!1,internal:!0});return i.$=s,n[e]=i}function la(n,e){const t=Reflect.getOwnPropertyDescriptor(n,e);return!t||t.get||!t.configurable||e===Dt||e===jt||(delete t.value,delete t.writable,t.get=()=>n[Dt][e]),t}function Ys(n){pi()&&mn(Wn(n,jt),Ws)()}function oa(n){return Ys(n),Reflect.ownKeys(n)}const ca={get(n,e,t){if(e===yi)return n;if(e===Dt)return t;if(e===vi)return Ys(n),t;const i=Wn(n,jt),s=i[e];let r=s?s():n[e];if(e===jt||e===gt||e==="__proto__")return r;if(!s){const a=Object.getOwnPropertyDescriptor(n,e);pi()&&(typeof r!="function"||n.hasOwnProperty(e))&&!(a&&a.get)&&(r=mn(i,e,r)())}return qn(r)?js(r):r},has(n,e){return e===yi||e===Dt||e===vi||e===jt||e===gt||e==="__proto__"?!0:(pi()&&mn(Wn(n,gt),e)(),e in n)},set(){return!0},deleteProperty(){return!0},ownKeys:oa,getOwnPropertyDescriptor:la};function jn(n,e,t,i=!1){if(!i&&n[e]===t)return;const s=n[e],r=n.length;t===void 0?(delete n[e],n[gt]&&n[gt][e]&&s!==void 0&&n[gt][e].$()):(n[e]=t,n[gt]&&n[gt][e]&&s===void 0&&n[gt][e].$());let a=Wn(n,jt),l;if((l=mn(a,e,s))&&l.$(()=>t),Array.isArray(n)&&n.length!==r){for(let o=n.length;o<r;o++)(l=a[o])&&l.$();(l=mn(a,"length",r))&&l.$(n.length)}(l=a[Ws])&&l.$()}function Vs(n,e){const t=Object.keys(e);for(let i=0;i<t.length;i+=1){const s=t[i];jn(n,s,e[s])}}function da(n,e){if(typeof e=="function"&&(e=e(n)),e=pn(e),Array.isArray(e)){if(n===e)return;let t=0,i=e.length;for(;t<i;t++){const s=e[t];n[t]!==s&&jn(n,t,s)}jn(n,"length",i)}else Vs(n,e)}function rn(n,e,t=[]){let i,s=n;if(e.length>1){i=e.shift();const a=typeof i,l=Array.isArray(n);if(Array.isArray(i)){for(let o=0;o<i.length;o++)rn(n,[i[o]].concat(e),t);return}else if(l&&a==="function"){for(let o=0;o<n.length;o++)i(n[o],o)&&rn(n,[o].concat(e),t);return}else if(l&&a==="object"){const{from:o=0,to:c=n.length-1,by:d=1}=i;for(let u=o;u<=c;u+=d)rn(n,[u].concat(e),t);return}else if(e.length>1){rn(n[i],e,[i].concat(t));return}s=n[i],t=[i].concat(t)}let r=e[0];typeof r=="function"&&(r=r(s,t),r===s)||i===void 0&&r==null||(r=pn(r),i===void 0||qn(s)&&qn(r)&&!Array.isArray(r)?Vs(s,r):jn(n,i,r))}function ha(...[n,e]){const t=pn(n||{}),i=Array.isArray(t),s=js(t);function r(...a){qr(()=>{i&&a.length===1?da(t,a[0]):rn(t,a)})}return[s,r]}function ua(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Ui(n,e=!1){const t=ua(),i=`_${t}`;return Object.defineProperty(window,i,{value:s=>(e&&Reflect.deleteProperty(window,i),n?.(s)),writable:!1,configurable:!0}),t}async function ye(n,e={}){return new Promise((t,i)=>{const s=Ui(a=>{t(a),Reflect.deleteProperty(window,`_${r}`)},!0),r=Ui(a=>{i(a),Reflect.deleteProperty(window,`_${s}`)},!0);window.__TAURI_IPC__({cmd:n,callback:s,error:r,...e})})}const Xs=Ms(),ga=n=>{const[e,t]=ha({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[i,s]=K(!1),[r,a]=K(null),[l,o]=K(!1),c=async()=>{try{s(!0),console.log("🔄 Loading app state...");const C=await ye("get_app_state");console.log("🔄 App state loaded, selected_ids:",C.selected_ids),t(C)}catch(C){console.error("Failed to load app state:",C)}finally{s(!1)}};Qe(()=>{c()});const d=async(C,A,X,G={})=>{try{s(!0);const O=await ye("create_element",{request:{element_type:C,position:A,size:X,content_data:G}});return await c(),O}catch(O){throw console.error("Failed to create element:",O),O}finally{s(!1)}},u=async(C,A)=>{try{s(!0),await ye("update_element",{request:{id:C,updates:A}}),await c()}catch(X){throw console.error("Failed to update element:",X),X}finally{s(!1)}},g=async C=>{try{s(!0),await ye("batch_update_positions",{request:{updates:C}}),t(A=>{const X=A.elements.map(G=>{const O=C.find(V=>V.element_id===G.id);return O?{...G,position:O.new_position}:G});return{...A,elements:X,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(A){throw console.error("Failed to batch update positions:",A),await c(),A}finally{s(!1)}},v=async C=>{try{s(!0),await ye("delete_element",{elementId:C}),await c()}catch(A){throw console.error("Failed to delete element:",A),A}finally{s(!1)}},h=async C=>{try{console.log("Selecting element:",C),await ye("select_element",{elementId:C}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",e.selected_ids)}catch(A){throw console.error("Failed to select element:",A),A}},p=async C=>{try{console.log("Selecting multiple elements:",C),C.length>0?(await ye("select_multiple",{elementIds:C}),console.log("✅ Multi-select completed for:",C.length,"elements")):await ye("clear_selection"),await c()}catch(A){throw console.error("Failed to select multiple elements:",A),A}},b=async C=>{try{console.log("Adding to selection:",C),await ye("add_to_selection",{elementId:C}),await c()}catch(A){throw console.error("Failed to add to selection:",A),A}},m=async C=>{try{console.log("Removing from selection:",C),await ye("remove_from_selection",{elementId:C}),await c()}catch(A){throw console.error("Failed to remove from selection:",A),A}},y=async C=>{try{console.log("Toggling selection:",C),await ye("toggle_selection",{elementId:C}),await c()}catch(A){throw console.error("Failed to toggle selection:",A),A}},$=async()=>{try{await ye("clear_selection"),await c()}catch(C){throw console.error("Failed to clear selection:",C),C}},x=async()=>{try{await ye("copy_selected")}catch(C){throw console.error("Failed to copy selected elements:",C),C}},N={state:e,setState:t,createElement:d,updateElement:u,batchUpdatePositions:g,deleteElement:v,selectElement:h,selectMultiple:p,addToSelection:b,removeFromSelection:m,toggleSelection:y,clearSelection:$,copySelected:x,copySelectedElements:async()=>x(),pasteElements:async(C,A)=>{try{s(!0);const X=await ye("paste_elements",{offsetX:C,offsetY:A});return await c(),X}catch(X){throw console.error("Failed to paste elements:",X),X}finally{s(!1)}},deleteElements:async C=>{try{s(!0);for(const A of C)await ye("delete_element",{elementId:A});await c()}catch(A){throw console.error("Failed to delete elements:",A),A}finally{s(!1)}},selectAllElements:async()=>{try{const C=e.elements.map(A=>A.id);await p(C)}catch(C){throw console.error("Failed to select all elements:",C),C}},moveElements:async(C,A,X)=>{try{s(!0);const G=e.elements.filter(O=>C.includes(O.id)).map(O=>({element_id:O.id,new_position:{x:O.position.x+A,y:O.position.y+X}}));G.length>0&&await g(G)}catch(G){throw console.error("Failed to move elements:",G),G}finally{s(!1)}},undo:async()=>{try{s(!0),await ye("undo"),await c()}catch(C){throw console.error("Failed to undo:",C),C}finally{s(!1)}},redo:async()=>{try{s(!0),await ye("redo"),await c()}catch(C){throw console.error("Failed to redo:",C),C}finally{s(!1)}},updateCanvasConfig:async C=>{try{s(!0),await ye("update_canvas_config",{request:C}),await c()}catch(A){throw console.error("Failed to update canvas config:",A),A}finally{s(!1)}},getElementsAtPoint:async(C,A)=>{try{return await ye("get_elements_at_point",{x:C,y:A})}catch(X){return console.error("Failed to get elements at point:",X),[]}},isLoading:i,setLoading:s,dragOperation:r,setDragOperation:a,resizeOperation:l,setResizeOperation:o};return _(Xs.Provider,{value:N,get children(){return n.children}})},st=()=>{const n=Ds(Xs);if(!n)throw new Error("useAppContext must be used within an AppProvider");return n};async function Qs(n){return ye("tauri",n)}async function fa(n={}){return typeof n=="object"&&Object.freeze(n),Qs({__tauriModule:"Dialog",message:{cmd:"openDialog",options:n}})}async function Js(n={}){return typeof n=="object"&&Object.freeze(n),Qs({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:n}})}class ti{static async loadTemplate(e){return await ye("load_jasper_template",{filePath:e})}static async saveTemplate(e,t){await ye("save_jasper_template",{template:e,filePath:t})}static async saveTemplateAs(e,t,i){await ye("save_template_as",{template:e,filePath:t,format:i})}static async validateTemplate(e){return await ye("validate_template",{template:e})}static async createEmptyTemplate(){return await ye("create_empty_template")}static async getTemplateInfo(e){return await ye("get_template_info",{filePath:e})}static async detectTemplateFormat(e){return await ye("detect_template_format",{filePath:e})}static async generateTemplatePreview(e){return await ye("generate_template_preview",{template:e})}static async exportTemplateJson(e){return await ye("export_template_json",{template:e})}static async importTemplateJson(e){return await ye("import_template_json",{jsonData:e})}static async cloneTemplate(e){return await ye("clone_template",{template:e})}static async mergeTemplates(e,t){return await ye("merge_templates",{baseTemplate:e,overlayTemplate:t})}static async extractTemplateElements(e,t){return await ye("extract_template_elements",{template:e,elementIds:t})}}const va="modulepreload",pa=function(n){return"/"+n},Hi={},Ks=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");s=Promise.allSettled(t.map(o=>{if(o=pa(o),o in Hi)return;Hi[o]=!0;const c=o.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${d}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":va,c||(u.as="script"),u.crossOrigin="",u.href=o,l&&u.setAttribute("nonce",l),document.head.appendChild(u),c)return new Promise((g,v)=>{u.addEventListener("load",g),u.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${o}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return s.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return e().catch(r)})},ma=()=>({metadata:{version:"2.0.0",format_version:"1.0.0",created_at:new Date().toISOString(),last_modified:new Date().toISOString(),created_by:"jasper-designer-v2",tags:[],compatibility:{min_jasper_version:"2.0.0",jasperreports_version:"6.20.0"}},canvas:{width:595,height:842,unit:"pt",orientation:"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:!0,size:10,snap:!0,visible:!0},background:{color:"#ffffff"}},data_sources:[],elements:[],parameters:[],variables:[],groups:[]});class ni{static toJasperTemplate(e,t){const i={...ma()},s={...i.metadata,...t,last_modified:new Date().toISOString()},r=this.convertCanvasConfig(e.canvas_config),a=e.elements.map(l=>this.convertReportElementToTemplateElement(l));return{...i,metadata:s,canvas:r,elements:a}}static convertCanvasConfig(e){return{width:e.width,height:e.height,unit:"pt",orientation:e.width>e.height?"landscape":"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:e.show_grid,size:e.grid_size,snap:e.snap_to_grid,visible:e.show_grid},background:{color:e.background_color}}}static convertReportElementToTemplateElement(e){const t=this.getElementType(e.content),i=this.convertElementContent(e.content),s=this.convertElementStyle(e.content);return{id:e.id,element_type:t,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},z_index:e.z_index,visible:e.visible,content:i,style:s,data_binding:this.extractDataBinding(e.content)}}static getElementType(e){switch(e.type){case"Text":return"Text";case"DataField":return"DataField";case"Rectangle":return"Rectangle";case"Line":return"Line";case"Image":return"Image";default:return"Text"}}static convertElementContent(e){switch(e.type){case"Text":return{text:e.content,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"DataField":return{expression:e.expression,format:e.format,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"Rectangle":return{color:e.fill_color};case"Line":return{color:e.color};case"Image":return{expression:e.src,text:e.alt};default:return{}}}static convertTextStyleToFont(e){return{family:e.font_family||"Arial",size:e.font_size||12,weight:this.mapFontWeight(e.font_weight),style:"normal"}}static convertTextStyleToAlignment(e){return{horizontal:this.mapTextAlign(e.align),vertical:"middle"}}static convertElementStyle(e){const t={};switch(e.type){case"Rectangle":e.fill_color&&(t.background={color:e.fill_color}),e.border&&(t.border={width:e.border.width,color:e.border.color,style:this.mapBorderStyle(e.border.style)});break;case"Text":case"DataField":e.style.background&&(t.background={color:e.style.background.color}),e.style.border&&(t.border={width:e.style.border.width,color:e.style.border.color,style:this.mapBorderStyle(e.style.border.style)});break}return t}static extractDataBinding(e){if(e.type==="DataField"&&e.data_source_id)return{source_id:e.data_source_id,field_name:this.extractFieldNameFromExpression(e.expression)}}static extractFieldNameFromExpression(e){return e.match(/^\{([^}]+)\}$/)?.[1]??e}static toAppState(e){const t=e.metadata.description||void 0;return{elements:e.elements.map(i=>this.convertTemplateElementToReportElement(i)),canvas_config:this.convertCanvasToCanvasConfig(e.canvas),selected_ids:[],can_undo:!1,can_redo:!1,dirty:!1,...t&&{template_name:t}}}static convertCanvasToCanvasConfig(e){return{width:e.width,height:e.height,zoom:1,offset_x:0,offset_y:0,show_grid:e.grid.enabled,show_rulers:!0,grid_size:e.grid.size,snap_to_grid:e.grid.snap,background_color:e.background.color}}static convertTemplateElementToReportElement(e){const t=this.convertTemplateContentToElementContent(e);return{id:e.id,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},content:t,z_index:e.z_index,visible:e.visible,locked:!1}}static convertTemplateContentToElementContent(e){switch(e.element_type){case"Text":return{type:"Text",content:e.content.text||"",style:this.convertTemplateStyleToTextStyle(e)};case"DataField":return{type:"DataField",expression:e.content.expression||"{data}",...e.content.format&&{format:e.content.format},style:this.convertTemplateStyleToTextStyle(e),...e.data_binding?.source_id&&{data_source_id:e.data_binding.source_id}};case"Rectangle":return{type:"Rectangle",...e.style?.background?.color&&{fill_color:e.style.background.color},...e.content.color&&!e.style?.background?.color&&{fill_color:e.content.color},...e.style?.border&&{border:{color:e.style.border.color,width:e.style.border.width,style:this.mapTemplateBorderStyle(e.style.border.style)}},corner_radius:0,opacity:1};case"Line":return{type:"Line",color:e.content.color||"#000000",width:1,line_style:"Solid",opacity:1};case"Image":return{type:"Image",src:e.content.expression||"",...e.content.text&&{alt:e.content.text}};default:return{type:"Text",content:"Unknown Element",style:this.createDefaultTextStyle()}}}static convertTemplateStyleToTextStyle(e){const t=e.content.font,i=e.content.alignment,s=e.style;return{font_family:t?.family||"Arial",font_size:t?.size||12,font_weight:this.mapTemplateFont(t?.weight),color:e.content.color||"#000000",align:this.mapTemplateAlignment(i?.horizontal),background:s?.background?{color:s.background.color||"",opacity:1,padding:0}:void 0,border:s?.border?{color:s.border.color,width:s.border.width,style:this.mapTemplateBorderStyle(s.border.style),radius:0}:void 0}}static createDefaultTextStyle(){return{font_family:"Arial",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}}static mapFontWeight(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTemplateFont(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTextAlign(e){switch(e){case"Center":return"center";case"Right":return"right";default:return"left"}}static mapTemplateAlignment(e){switch(e){case"center":return"Center";case"right":return"Right";default:return"Left"}}static mapBorderStyle(e){switch(e){case"Dashed":return"dashed";case"Dotted":return"dotted";default:return"solid"}}static mapTemplateBorderStyle(e){switch(e){case"dashed":return"Dashed";case"dotted":return"Dotted";default:return"Solid"}}}var ba=S("<span class=text-warning>●"),ya=S("<span class=ml-2> 个元素"),_a=S('<span class="ml-2 text-primary">已选择 <!> 个'),xa=S('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建模板 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开模板 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存模板 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class=toolbar-btn title="导出 (PDF/PNG/Excel)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>导出</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const Sa=n=>{const{state:e,undo:t,redo:i,updateCanvasConfig:s,setState:r}=st(),[a,l]=K(e.canvas_config.zoom*100),o=async()=>{try{const m=await ti.createEmptyTemplate(),y=ni.toAppState(m);r(y),console.log("✅ 新建模板成功")}catch(m){console.error("❌ 新建模板失败:",m),alert("新建模板失败")}},c=async()=>{try{const m=await fa({title:"打开模板文件",filters:[{name:"Jasper模板",extensions:["jasper","jbin","jrxml"]}],multiple:!1});if(m&&typeof m=="string"){const y=await ti.loadTemplate(m),$=ni.toAppState(y);r({...$,template_name:y.metadata.description||"未命名模板"}),console.log("✅ 模板加载成功:",m)}}catch(m){console.error("❌ 加载模板失败:",m),alert("加载模板失败")}},d=async()=>{try{const m=await Js({title:"保存模板文件",filters:[{name:"Jasper模板",extensions:["jasper"]}],defaultPath:e.template_name||"未命名模板"});if(m){const y=ni.toJasperTemplate(e,{description:e.template_name||"未命名模板"});await ti.saveTemplate(y,m),console.log("✅ 模板保存成功:",m)}}catch(m){console.error("❌ 保存模板失败:",m),alert("保存模板失败")}},u=async m=>{const y=m/100;l(m);try{await s({zoom:y})}catch($){console.error("Failed to update zoom:",$)}},g=()=>{const m=Math.min(a()+25,500);u(m)},v=()=>{const m=Math.max(a()-25,25);u(m)},h=async()=>{try{await s({show_grid:!e.canvas_config.show_grid})}catch(m){console.error("Failed to toggle grid:",m)}},p=async()=>{try{await s({show_rulers:!e.canvas_config.show_rulers})}catch(m){console.error("Failed to toggle rulers:",m)}},b=async()=>{try{await ye("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(m){console.error("Failed to toggle DevTools:",m)}};return(()=>{var m=xa(),y=m.firstChild,$=y.firstChild,x=$.nextSibling,w=x.nextSibling,P=w.nextSibling,L=P.nextSibling,D=L.nextSibling,z=y.nextSibling,E=z.firstChild,R=E.nextSibling,k=R.nextSibling,q=k.nextSibling,N=q.nextSibling,C=N.nextSibling,A=C.nextSibling,X=A.nextSibling,G=X.nextSibling,O=G.nextSibling,V=O.nextSibling,B=z.nextSibling,H=B.firstChild;return $.$$click=o,x.$$click=c,w.$$click=d,f(y,_(aa,{}),L),L.$$click=()=>{console.log("🔄 数据源按钮被点击！"),n.onOpenDataSources()},D.$$click=()=>{console.log("📤 导出按钮被点击！"),n.onOpenExport?.()},Ae(E,"click",t),Ae(R,"click",i),q.$$click=v,N.addEventListener("change",j=>{const de=j.target.value;if(de==="fit")console.log("Fit to window");else{const me=parseInt(de.replace("%",""));u(me)}}),C.$$click=g,X.$$click=h,G.$$click=p,V.$$click=b,f(B,_(W,{get when(){return e.dirty},get children(){return ba()}}),H),f(H,()=>e.template_name||"未命名模板"),f(B,_(W,{get when(){return e.elements.length>0},get children(){var j=ya(),de=j.firstChild;return f(j,()=>e.elements.length,de),j}}),null),f(B,_(W,{get when(){return e.selected_ids.length>0},get children(){var j=_a(),de=j.firstChild,me=de.nextSibling;return me.nextSibling,f(j,()=>e.selected_ids.length,me),j}}),null),F(j=>{var de=`toolbar-btn-icon ${e.can_undo?"":"opacity-50 cursor-not-allowed"}`,me=!e.can_undo,fe=`撤销${e.undo_description?` (${e.undo_description})`:""} (Ctrl+Z)`,ee=`toolbar-btn-icon ${e.can_redo?"":"opacity-50 cursor-not-allowed"}`,oe=!e.can_redo,ge=`重做${e.redo_description?` (${e.redo_description})`:""} (Ctrl+Y)`,he=`toolbar-btn-icon ${e.canvas_config.show_grid?"active":""}`,te=`toolbar-btn-icon ${e.canvas_config.show_rulers?"active":""}`;return de!==j.e&&Se(E,j.e=de),me!==j.t&&(E.disabled=j.t=me),fe!==j.a&&Q(E,"title",j.a=fe),ee!==j.o&&Se(R,j.o=ee),oe!==j.i&&(R.disabled=j.i=oe),ge!==j.n&&Q(R,"title",j.n=ge),he!==j.s&&Se(X,j.s=he),te!==j.h&&Se(G,j.h=te),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),F(()=>N.value=`${Math.round(a())}%`),m})()};Ue(["click"]);var wa=S('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),$a=S('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const qi=()=>{const{createElement:n}=st(),[e,t]=K(""),i=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:c?.text||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:c?.expression||"${fieldName}",format:c?.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:c?.fill_color||"transparent",border:{color:c?.border_color||"#000000",width:c?.border_width||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:c?.color||"#000000",width:c?.width||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:c?.src||"",alt:c?.alt||"图片"})}],s=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],r=[...i,...s],a=()=>{const c=e().toLowerCase();return c?r.filter(d=>d.name.toLowerCase().includes(c)||d.description.toLowerCase().includes(c)):r},l=(c,d)=>{if(console.log("Starting drag for component:",c.id),d.dataTransfer){d.dataTransfer.effectAllowed="copy",d.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const u=document.createElement("div");u.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,u.style.position="absolute",u.style.top="-1000px",document.body.appendChild(u),d.dataTransfer.setDragImage(u,50,20),setTimeout(()=>{document.body.removeChild(u)},0)}},o=async c=>{try{const d=await n(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",d)}catch(d){console.error("Failed to create element:",d)}};return(()=>{var c=wa(),d=c.firstChild,u=d.firstChild,g=u.nextSibling,v=d.nextSibling,h=v.firstChild,p=h.firstChild,b=p.firstChild,m=b.nextSibling,y=p.nextSibling,$=y.firstChild,x=$.nextSibling,w=y.nextSibling,P=w.firstChild,L=P.nextSibling;return g.$$input=D=>t(D.target.value),f(m,_(pe,{get each(){return a().filter(D=>D.category==="basic")},children:D=>_(ii,{component:D,onDrag:z=>l(D,z),onClick:()=>o(D)})})),f(x,_(pe,{get each(){return a().filter(D=>D.category==="data")},children:D=>_(ii,{component:D,onDrag:z=>l(D,z),onClick:()=>o(D)})})),f(L,_(pe,{get each(){return a().filter(D=>D.category==="bank")},children:D=>_(ii,{component:D,onDrag:z=>l(D,z),onClick:()=>o(D)})})),F(()=>g.value=e()),c})()},ii=n=>(()=>{var e=$a(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(e,"click",n.onClick),e.addEventListener("dragstart",r=>n.onDrag(r)),Q(e,"draggable",!0),f(i,()=>n.component.icon),f(s,()=>n.component.name),F(()=>Q(e,"title",n.component.description)),e})();Ue(["input","click"]);class Re{static async listDataSources(){return ye("list_data_sources")}static async deleteDataSource(e){return ye("delete_data_source",{req:{sourceId:e}})}static async updateConfig(e,t){return ye("update_data_source_config",{req:{sourceId:e,config:t}})}static async queryDataSource(e,t){return ye("query_data_source",{req:{sourceId:e,query:t}})}static async getDataPreview(e,t){return ye("get_data_preview",{req:{sourceId:e,limit:t}})}static async testConnection(e,t){return ye("test_data_source_connection",{req:{providerType:e,config:t}})}static async discoverSchema(e,t){return ye("discover_schema",{req:{providerType:e,config:t}})}static async testDatabaseConnection(e){return ye("test_database_connection",{config:e})}static async loadDatabaseSchema(e){return ye("load_database_schema",{config:e})}static async executeDatabasePreview(e,t,i){return ye("execute_database_preview",{req:{config:e,sql:t,limit:i}})}static async validateSqlSyntax(e,t){if(console.log("🔍 验证SQL语法 - 参数:",{sql:e.length+" 字符",databaseType:t}),!e||e.trim().length===0)throw new Error("SQL不能为空");if(!t)throw console.error("❌ databaseType参数为空或未定义:",t),new Error("数据库类型不能为空");try{const i={sql:e,databaseType:t};return console.log("🔍 将传递给Rust的参数:",i),console.log("🔍 参数对象的键:",Object.keys(i)),console.log("🔍 参数JSON:",JSON.stringify(i)),await ye("validate_sql_syntax",{req:i})}catch(i){throw console.error("❌ 调用失败:",i),i}}static async formatSql(e,t){return ye("format_sql",{req:{sql:e,databaseType:t}})}static async saveDataSource(e){try{const t=e.config;console.log("🔍 saveDataSource 请求参数:",{name:e.name,selected_tables:e.selected_tables,selected_tables_type:typeof e.selected_tables,selected_tables_length:e.selected_tables?.length,sql_length:e.sql?.length});const i=e.selected_tables||[];console.log("🔍 实际传递的 selectedTables:",i);const s=await ye("create_database_source",{req:{name:e.name,description:e.description||null,databaseType:t.database_type,host:t.host,port:t.port,database:t.database,username:t.username,password:t.password||null,sql:e.sql,selectedTables:i,tags:e.tags?e.tags:null}});return{success:!0,data_source_id:String(s),message:`数据源 "${e.name}" 创建成功`,warnings:[],errors:[]}}catch(t){return{success:!1,data_source_id:"",message:`保存数据源失败: ${t}`,warnings:[],errors:[String(t)]}}}static async createDataSource(e,t,i){return ye("create_data_source",{req:{name:e,providerType:t,config:i}})}static async getPreview(e,t,i){return this.getDataPreview(e,i)}static async queryData(e,t){return this.queryDataSource(e,t||{})}static async evaluateExpression(e,t,i){return ye("evaluate_expression",{req:{sourceId:e,expression:t,context:i}})}static async getAvailableTypes(){return ye("get_available_data_source_types")}static async getSchema(e){return ye("get_data_source_schema",{req:{sourceId:e}})}static async getConfigSchema(e){return ye("get_config_schema",{req:{providerType:e}})}static async getDefaultConfig(e){return ye("get_default_config",{req:{providerType:e}})}static async validateConfig(e,t){return ye("validate_config",{req:{providerType:e,config:t}})}static async captureDataPreview(e,t){return this.executeDatabasePreview(e,t,50)}static async validateDataSourceBeforeSave(e){try{console.log("🔍 开始验证数据源保存前检查"),console.log("🔍 请求配置:",e.config),console.log("🔍 数据库类型:",e.config.database_type);const t=await this.testDatabaseConnection(e.config),i=await this.validateSqlSyntax(e.sql,e.config.database_type),s=await this.performSecurityCheck(e.config,e.sql);return{connection_valid:t.success,sql_valid:i.valid,security_passed:s.is_safe,performance_acceptable:!0,warnings:[...i.warnings||[],...s.warnings||[]],errors:[]}}catch(t){return{connection_valid:!1,sql_valid:!1,security_passed:!1,performance_acceptable:!1,warnings:[],errors:[String(t)]}}}static async performSecurityCheck(e,t){const i=[],s=[],r=[/drop\s+table/i,/truncate\s+table/i,/delete\s+from/i,/update\s+.*set/i,/insert\s+into/i,/alter\s+table/i];for(const a of r)if(a.test(t)){i.push("包含可能危险的SQL操作");break}return{is_safe:i.length===0,security_issues:i,warnings:s}}}class Ca{styles=new Map;elementStyleMap=new Map;observers=new Set;initialized=!1;constructor(){console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(e){throw console.error("❌ TextStyleManager 初始化失败:",e),e}}createStyle(e){const t=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={...e,id:t,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(t,i),this.notifyObservers("style-created",t),this.saveUserStyles(),console.log(`🎨 创建新样式: ${i.name} (${t})`),t}getStyle(e){return this.styles.get(e)||null}updateStyle(e,t){const i=this.styles.get(e);if(!i)return console.warn(`⚠️ 样式 ${e} 不存在`),!1;if(i.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${e}`),!1;const s={...i,style:{...i.style,...t},metadata:{...i.metadata,lastModified:new Date}};return this.styles.set(e,s),this.syncAllStyleInstances(e),this.saveUserStyles(),this.notifyObservers("style-updated",e),console.log(`🔄 样式已更新: ${i.name} (${e})`),!0}deleteStyle(e){const t=this.styles.get(e);if(!t)return!1;if(t.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${e}`),!1;const i=Array.from(this.elementStyleMap.entries()).filter(([s,r])=>r===e).map(([s,r])=>s);return i.length>0?(console.warn(`⚠️ 无法删除样式 ${e}，仍有 ${i.length} 个元素在使用`),!1):(this.styles.delete(e),this.saveUserStyles(),this.notifyObservers("style-deleted",e),console.log(`🗑️ 样式已删除: ${t.name} (${e})`),!0)}applyStyleToElement(e,t){const i=this.styles.get(t);if(!i)return{success:!1,elementId:e,styleId:t,appliedAt:new Date,error:`样式 ${t} 不存在`};try{const s=this.elementStyleMap.get(e);if(this.elementStyleMap.set(e,t),i.metadata.usageCount++,s&&s!==t){const r=this.styles.get(s);r&&(r.metadata.usageCount=Math.max(0,r.metadata.usageCount-1))}return this.applyStyleToDOM(e,i.style),this.notifyObservers("style-applied",{elementId:e,styleId:t}),console.log(`🎯 应用样式: ${i.name} → 元素 ${e}`),{success:!0,elementId:e,styleId:t,appliedAt:new Date}}catch(s){return console.error(`❌ 应用样式失败: ${s}`),{success:!1,elementId:e,styleId:t,appliedAt:new Date,error:s instanceof Error?s.message:String(s)}}}getElementStyleId(e){return this.elementStyleMap.get(e)||null}removeElementStyle(e){const t=this.elementStyleMap.get(e);if(t){this.elementStyleMap.delete(e);const i=this.styles.get(t);i&&(i.metadata.usageCount=Math.max(0,i.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${e}`)}}getStylesByCategory(e){const t=Array.from(this.styles.values());return(e?t.filter(s=>s.category===e):t).sort((s,r)=>s.metadata.isSystemStyle!==r.metadata.isSystemStyle?s.metadata.isSystemStyle?-1:1:r.metadata.usageCount-s.metadata.usageCount)}searchStyles(e,t){const i=this.getStylesByCategory(t),s=e.toLowerCase().trim();return s?i.filter(r=>r.name.toLowerCase().includes(s)||r.description.toLowerCase().includes(s)||r.metadata.tags.some(a=>a.toLowerCase().includes(s))):i}getStyleUsageStats(){const e=[];for(const[t,i]of this.styles){const s=Array.from(this.elementStyleMap.entries()).filter(([r,a])=>a===t).map(([r,a])=>r);e.push({styleId:t,usageCount:s.length,elements:s,lastUsed:i.metadata.lastModified})}return e.sort((t,i)=>i.usageCount-t.usageCount)}cleanupUnusedStyles(){const e=new Set(this.elementStyleMap.values()),t=[];for(const[i,s]of this.styles)!e.has(i)&&!s.metadata.isSystemStyle&&(this.styles.delete(i),t.push(i),console.log(`🧹 清理未使用样式: ${s.name} (${i})`));return t.length>0&&this.saveUserStyles(),t}exportStyles(e){const t=e?e.map(s=>this.styles.get(s)).filter(Boolean):Array.from(this.styles.values()),i=new Set(t.map(s=>s.category));return{version:"2.0.0",exportedAt:new Date,styles:t,metadata:{totalStyles:t.length,categories:Array.from(i),author:"user"}}}async importStyles(e){const t=[];for(const i of e.styles){if(Array.from(this.styles.values()).find(a=>a.name===i.name&&a.category===i.category)){console.warn(`⚠️ 跳过已存在的样式: ${i.name}`);continue}const r=this.createStyle({name:i.name,description:i.description,category:i.category,style:i.style,...i.inheritance&&{inheritance:i.inheritance}});t.push(r)}return console.log(`📦 导入完成，共导入 ${t.length} 个样式`),t}addObserver(e){this.observers.add(e)}removeObserver(e){this.observers.delete(e)}syncAllStyleInstances(e){const t=this.styles.get(e);if(!t)return;const i=[];for(const[s,r]of this.elementStyleMap)r===e&&(this.applyStyleToDOM(s,t.style),i.push(s));this.notifyObservers("styles-synced",{styleId:e,affectedElements:i}),console.log(`🔄 样式同步完成: ${e} → ${i.length} 个元素`)}applyStyleToDOM(e,t){console.log(`🎨 应用样式到DOM: 元素 ${e}`,{font_family:t.font_family,font_size:t.font_size,typography:t.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:e}=await Ks(async()=>{const{BANK_TEXT_STYLES:t}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:t}},[]);for(const t of e)this.styles.set(t.id,t);console.log(`🏦 加载了 ${e.length} 个银行预设样式`)}catch(e){console.warn("⚠️ 加载系统样式失败:",e)}}async loadUserStyles(){try{const e=localStorage.getItem("jasper-text-styles");if(e){const t=JSON.parse(e);for(const i of t)i.metadata.createdAt=new Date(i.metadata.createdAt),i.metadata.lastModified=new Date(i.metadata.lastModified),this.styles.set(i.id,i);console.log(`👤 加载了 ${t.length} 个用户自定义样式`)}}catch(e){console.warn("⚠️ 加载用户样式失败:",e)}}saveUserStyles(){try{const e=Array.from(this.styles.values()).filter(t=>!t.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(e)),console.log(`💾 保存了 ${e.length} 个用户自定义样式`)}catch(e){console.error("❌ 保存用户样式失败:",e)}}notifyObservers(e,t){for(const i of this.observers)try{i.onStyleChange(e,t)}catch(s){console.error("❌ 观察者通知失败:",s)}}}const Xe=new Ca;class ka{calculateUnifiedBounds(e,t,i){const s=this.calculateFontMetrics(t),r=this.measureTextContent(e,t,i.width),a=this.calculateContainerHeight(r,s,i.height),l=this.calculateTextPositioning(t,i,a,s),o={containerBounds:{x:0,y:0,width:i.width,height:a},contentBounds:r.bounds,fontMetrics:s,positioning:l};return r.wrappedLines&&(o.textLayout={wrappedLines:r.wrappedLines,isWrapped:!0,originalLineCount:e.split(`
`).length,wrappedLineCount:r.wrappedLines.length}),o}calculateFontMetrics(e){const t=e.font_size,i=1.2,s=.75,r=.25,a=t*s,l=t*r;return{fontSize:t,lineHeight:t*i,ascender:a,descender:l,baseline:a}}getCharacterWidth(e,t){const i=t.font_size,s=t.font_family,r=/[\u4e00-\u9fa5]/.test(e),a={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},l=s.toLowerCase();let o=a.default;for(const[d,u]of Object.entries(a))if(l.includes(d.toLowerCase())||d.toLowerCase().includes(l)){o=u;break}const c=r?o.chinese:o.english;return i*c}calculateTextWidth(e,t){let i=0;for(const s of e)s!==`
`&&(i+=this.getCharacterWidth(s,t));return i}measureTextContent(e,t,i=0){const s=e.split(`
`),r=s.length;let a=0;for(const c of s){const d=this.calculateTextWidth(c,t);a=Math.max(a,d)}if(i>0&&a>i)return this.calculateWrappedText(e,t,i);const l=i>0?Math.min(a,i):a,o=r*t.font_size*1.2;return{bounds:{x:0,y:0,width:l,height:o},lineCount:r,actualHeight:o}}calculateWrappedText(e,t,i){const s=this.getCharacterWidth("测",t);if(Math.floor(i/s)<1||i<s)return{bounds:{x:0,y:0,width:i,height:t.font_size*1.2},lineCount:1,actualHeight:t.font_size*1.2,wrappedLines:["..."]};const a=this.smartSegmentation(e);let l=[],o="",c=0;for(const u of a){const g=this.calculateTextWidth(u,t),v=c+g;if(v>i)if(o.trim())l.push(o.trim()),o=u,c=g;else{const{truncated:h,remaining:p}=this.forceTruncateSegment(u,i,t);l.push(h),o=p,c=this.calculateTextWidth(p,t)}else o+=u,c=v}o.trim()&&l.push(o.trim());const d=l.length*t.font_size*1.2;return{bounds:{x:0,y:0,width:i,height:d},lineCount:l.length,actualHeight:d,wrappedLines:l}}forceTruncateSegment(e,t,i){let s="",r=0,a=0;for(a=0;a<e.length;a++){const o=e[a];if(!o)break;const c=this.getCharacterWidth(o,i);if(r+c>t)break;s+=o,r+=c}const l=e.substring(a);return{truncated:s,remaining:l}}smartSegmentation(e){const t=[];let i="";for(let s=0;s<e.length;s++){const r=e[s];r&&(/[\u4e00-\u9fa5]/.test(r)?(i&&(t.push(i),i=""),t.push(r)):r===`
`?(i&&(t.push(i),i=""),t.push(`
`)):r===" "?i?(t.push(i+" "),i=""):t.push(" "):i+=r)}return i&&t.push(i),t.filter(s=>s.length>0)}calculateContainerHeight(e,t,i){const s=t.lineHeight*e.lineCount,r=t.ascender+t.descender,a=t.lineHeight,l=Math.max(s,r,a);return Math.max(l,i)}calculateTextPositioning(e,t,i,s){const r=this.calculateHorizontalAnchor(e.align,t.width),a=s.baseline,l=e.background?.padding||0,o=-l,c=-l;return{textAnchorX:r,textAnchorY:a,backgroundX:o,backgroundY:c}}calculateHorizontalAnchor(e,t){switch(e){case"Left":return 0;case"Center":return t/2;case"Right":return t;default:return 0}}getTextAnchor(e){switch(e){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(e,t){}}const qt=new ka;class Ta{initialized=!1;constructor(){this.initialize()}async initialize(){if(!this.initialized)try{await Xe.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(e){console.error("❌ ProfessionalTextRenderer 初始化失败:",e)}}isElementUsingProfessionalStyle(e){return Xe.getElementStyleId(e)!==null}adaptLegacyTextStyle(e){return{...e,font_weight:e.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:e.color}}],effects:[]}}renderProfessionalText(e,t=!1){if(e.content.type!=="Text"&&e.content.type!=="DataField")return null;const i=Xe.getElementStyleId(e.id);let s;if(i){const l=Xe.getStyle(i);if(!l)return console.warn(`⚠️ 找不到样式定义: ${i}`),null;s=l.style,console.log(`🎨 使用专业样式渲染: ${l.name} (${i})`)}else{const l=e.content.type==="Text"||e.content.type==="DataField"?e.content.style:null;if(!l)return null;s=this.adaptLegacyTextStyle(l),console.log("🔄 适配传统样式到专业排版系统")}const r=this.calculateEnhancedBounds(e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",s,e.size);return{element:this.createProfessionalTextElement(r,e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",s,!1),bounds:r,style:s}}calculateEnhancedBounds(e,t,i){const s=qt.calculateUnifiedBounds(e,t,i),r=t.typography,a=this.calculateLetterSpacingEffect(e,r.letterSpacing),l=this.calculateLineHeightEffect(e,t.font_size,r.lineHeight),o=this.calculateParagraphSpacingEffect(e,r.paragraphSpacing);return{containerBounds:s.containerBounds,positioning:s.positioning,fontMetrics:s.fontMetrics,typography:{adjustedWidth:s.containerBounds.width+a.widthIncrease,adjustedHeight:s.containerBounds.height+l.heightIncrease+o.heightIncrease,letterSpacingData:a,lineHeightData:l,paragraphData:o}}}calculateLetterSpacingEffect(e,t){const i=e.split(`
`),s=i.reduce((a,l)=>a+l.length,0),r=Math.max(0,s-i.length);return{spacingValue:t,totalSpaces:r,widthIncrease:r*t,charPositions:[]}}calculateLineHeightEffect(e,t,i){const r=e.split(`
`).length,a=t*i,l=t*1.2,o=a-l;return{lineHeightRatio:i,actualLineHeight:a,lineCount:r,heightIncrease:o*Math.max(0,r-1),baselinePositions:[]}}calculateParagraphSpacingEffect(e,t){const s=e.split(`

`).length;return{spacing:t,paragraphCount:s,heightIncrease:t*Math.max(0,s-1),paragraphPositions:[]}}createProfessionalTextElement(e,t,i,s){const r=document.createElementNS("http://www.w3.org/2000/svg","g");return r.setAttribute("class","professional-text-container"),this.renderMultipleFills(r,e,i.fills),this.renderEffects(r,e,i.effects),this.renderTypographyText(r,e,t,i),this.renderTextDecorations(r,e,t,i.typography.decoration),r}renderMultipleFills(e,t,i){if(i&&i.length>0&&i[0].enabled){const s=i[0];s.type==="solid"&&s.solid&&console.log("🎨 应用纯色填充:",s.solid.color)}}renderEffects(e,t,i){if(!i||i.length===0)return;const s=document.createElementNS("http://www.w3.org/2000/svg","defs"),r=document.createElementNS("http://www.w3.org/2000/svg","filter"),a=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;r.id=a;for(const l of i)if(l.enabled&&l.type==="drop-shadow"&&l.dropShadow){const o=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");o.setAttribute("dx",l.dropShadow.offsetX.toString()),o.setAttribute("dy",l.dropShadow.offsetY.toString()),o.setAttribute("stdDeviation",l.dropShadow.blur.toString()),o.setAttribute("flood-color",l.dropShadow.color),o.setAttribute("flood-opacity",l.dropShadow.opacity.toString()),r.appendChild(o),console.log("✨ 应用投影效果")}r.children.length>0&&(s.appendChild(r),e.appendChild(s),e.setAttribute("filter",`url(#${a})`))}renderTypographyText(e,t,i,s){const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("font-family",s.font_family),r.setAttribute("font-size",s.font_size.toString()),r.setAttribute("font-weight",s.font_weight),r.setAttribute("fill",s.fills[0]?.solid?.color||s.color),r.setAttribute("text-anchor",this.getTextAnchor(s.align));const a=i.split(`
`),l=s.typography;a.forEach((o,c)=>{const d=document.createElementNS("http://www.w3.org/2000/svg","tspan");l.letterSpacing!==0&&d.setAttribute("letter-spacing",`${l.letterSpacing}px`);const u=t.positioning.textAnchorY+c*t.typography.lineHeightData.actualLineHeight;if(d.setAttribute("x",t.positioning.textAnchorX.toString()),d.setAttribute("y",u.toString()),c===0&&l.textIndent!==0){const g=t.positioning.textAnchorX+l.textIndent;d.setAttribute("x",g.toString())}l.textTransform&&l.textTransform!=="none"?d.textContent=this.applyTextTransform(o,l.textTransform):d.textContent=o,r.appendChild(d)}),e.appendChild(r)}renderTextDecorations(e,t,i,s){if(!s.underline&&!s.strikethrough&&!s.overline)return;const r=i.split(`
`),a=s.decorationColor||"#000000",l=s.decorationThickness||1,o=s.decorationStyle==="dashed"?"4,2":s.decorationStyle==="dotted"?"1,1":"none";r.forEach((c,d)=>{if(!c.trim())return;const u=t.positioning.textAnchorY+d*t.typography.lineHeightData.actualLineHeight,g=c.length*t.fontMetrics.fontSize*.6,v=t.positioning.textAnchorX,h=v+g;if(s.underline){const p=u+t.fontMetrics.fontSize*.1;this.createDecorationLine(e,v,p,h,p,a,l,o,"underline")}if(s.strikethrough){const p=u-t.fontMetrics.fontSize*.3;this.createDecorationLine(e,v,p,h,p,a,l,o,"strikethrough")}if(s.overline){const p=u-t.fontMetrics.fontSize*.8;this.createDecorationLine(e,v,p,h,p,a,l,o,"overline")}})}createDecorationLine(e,t,i,s,r,a,l,o,c){const d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",t.toString()),d.setAttribute("y1",i.toString()),d.setAttribute("x2",s.toString()),d.setAttribute("y2",r.toString()),d.setAttribute("stroke",a),d.setAttribute("stroke-width",l.toString()),d.setAttribute("stroke-dasharray",o),d.setAttribute("class",`text-decoration-${c}`),e.appendChild(d)}getTextAnchor(e){switch(e){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(e,t){switch(t){case"uppercase":return e.toUpperCase();case"lowercase":return e.toLowerCase();case"capitalize":return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase();default:return e}}}const Ea=new Ta;var Pa=S("<button class=search-clear title=清除搜索>✕"),Aa=S('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),Ra=S("<button><span class=category-icon></span><span class=category-label>"),La=S("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),Ma=S("<span class=usage-count>"),Da=S("<button class=edit-button title=编辑样式>✏️"),Oa=S("<span class=system-badge title=系统预设样式>🔒"),Ia=S("<div class=selection-indicator>✓");const Na=n=>{const[e,t]=K("bank-special"),[i,s]=K(""),[r,a]=K([]);(async()=>{await Xe.initialize();const g=Xe.getStylesByCategory();a(g)})();const o=Me(()=>{let g=r();e()&&(g=g.filter(h=>h.category===e()));const v=i().toLowerCase().trim();return v&&(g=g.filter(h=>h.name.toLowerCase().includes(v)||h.description.toLowerCase().includes(v)||h.metadata.tags.some(p=>p.toLowerCase().includes(v)))),g}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],d=g=>{console.log("🎯 选择样式:",g),n.onStyleSelect(g)},u=g=>{t(g),console.log("📂 切换分类:",g)};return(()=>{var g=Aa(),v=g.firstChild,h=v.nextSibling,p=h.firstChild,b=p.firstChild,m=b.nextSibling,y=h.nextSibling,$=y.firstChild,x=y.nextSibling,w=x.firstChild,P=w.firstChild;return f(v,_(pe,{each:c,children:L=>(()=>{var D=Ra(),z=D.firstChild,E=z.nextSibling;return D.$$click=()=>u(L.key),f(z,()=>L.icon),f(E,()=>L.label),F(R=>{var k=`category-button ${e()===L.key?"active":""}`,q=L.label;return k!==R.e&&Se(D,R.e=k),q!==R.t&&Q(D,"title",R.t=q),R},{e:void 0,t:void 0}),D})()})),m.$$input=L=>s(L.target.value),f(p,_(W,{get when(){return i()},get children(){var L=Pa();return L.$$click=()=>s(""),L}}),null),f(y,_(pe,{get each(){return o()},children:L=>_(za,{style:L,get selected(){return n.selectedStyleId===L.id},onClick:()=>d(L.id),onEdit:()=>n.onStyleEdit(L.id)})}),$),Ae($,"click",n.onStyleCreate),f(w,()=>o().length,P),f(w,(()=>{var L=$e(()=>!!i());return()=>L()&&` (搜索: "${i()}")`})(),null),F(()=>m.value=i()),g})()},za=n=>{const e=()=>{switch(n.style.category){case"bank-special":return n.style.id.includes("amount")?"¥123,456.78":n.style.id.includes("account")?"6222 0012 3456 7890":n.style.id.includes("institution")?n.style.name:n.style.id.includes("date")?"2025-08-19":n.style.name;case"heading":return n.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return n.style.name}},t=Me(()=>{const r=n.style.style;return{fontFamily:r.font_family,fontSize:`${Math.min(r.font_size,14)}px`,fontWeight:r.font_weight,color:r.fills?.[0]?.solid?.color||r.color,textAlign:r.align.toLowerCase(),letterSpacing:`${r.typography?.letterSpacing||0}px`,textDecoration:r.typography?.decoration?.underline?"underline":r.typography?.decoration?.strikethrough?"line-through":"none"}}),i=r=>{r.preventDefault(),n.onClick()},s=r=>{r.preventDefault(),r.stopPropagation(),n.onEdit()};return(()=>{var r=La(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.nextSibling,d=c.firstChild,u=l.nextSibling;return r.$$click=i,f(a,e),f(o,()=>n.style.name),f(d,()=>Fa(n.style.category)),f(c,(()=>{var g=$e(()=>n.style.metadata.usageCount>0);return()=>g()&&(()=>{var v=Ma();return f(v,()=>n.style.metadata.usageCount),F(()=>Q(v,"title",`使用次数: ${n.style.metadata.usageCount}`)),v})()})(),null),f(u,(()=>{var g=$e(()=>!n.style.metadata.isSystemStyle);return()=>g()&&(()=>{var v=Da();return v.$$click=s,v})()})(),null),f(u,(()=>{var g=$e(()=>!!n.style.metadata.isSystemStyle);return()=>g()&&Oa()})(),null),f(r,(()=>{var g=$e(()=>!!n.selected);return()=>g()&&Ia()})(),null),F(g=>{var v=`style-card ${n.selected?"selected":""} ${n.style.metadata.isSystemStyle?"system-style":"user-style"}`,h=t();return v!==g.e&&Se(r,g.e=v),g.t=Hs(a,h,g.t),g},{e:void 0,t:void 0}),r})()};function Fa(n){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[n]||n}Ue(["input","click"]);var Ga=S("<button class=style-picker-toggle>"),Ba=S("<button class=style-reload-btn title=重新加载样式系统>🔄"),Ua=S("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),Ha=S("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),qa=S("<div class=style-picker-panel>"),Wa=S("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),ja=S("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),Ya=S('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),Va=S("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),Xa=S('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const Wi=n=>{const[e,t]=K(null),[i,s]=K(!1),[r,a]=K([]),[l,o]=K(!1);Qe(async()=>{try{await Xe.initialize();const m=Xe.getElementStyleId(n.element.id);t(m);const y=Xe.getStylesByCategory();a(y),o(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch(m){console.error("❌ 专业文字属性面板初始化失败:",m)}});const c=Me(()=>{const m=e();return m?Xe.getStyle(m):null}),d=Me(()=>n.element.content.type==="Text"||n.element.content.type==="DataField"),u=async m=>{try{const y=await Xe.applyStyleToElement(n.element.id,m);if(y.success){t(m);const $=Xe.getStyle(m);if($){const x=g($.style);n.onUpdate(n.element.id,"content",{...n.element.content,style:x})}console.log("✅ 样式应用成功:",y)}else console.error("❌ 样式应用失败:",y.error)}catch(y){console.error("❌ 样式选择处理失败:",y)}},g=m=>({font_family:m.font_family,font_size:m.font_size,font_weight:m.font_weight,color:m.fills?.[0]?.solid?.color||m.color,align:m.align}),v=()=>{console.log("🆕 创建新样式")},h=m=>{console.log("✏️ 编辑样式:",m)},p=()=>{s(!i())},b=()=>{e()&&(Xe.removeElementStyle(n.element.id),t(null),console.log("🗑️ 移除元素样式"))};return d()?(()=>{var m=Va(),y=m.firstChild,$=y.firstChild,x=$.firstChild,w=x.nextSibling,P=w.nextSibling,L=$.nextSibling;return f(P,_(W,{get when(){return l()},get children(){var D=Ga();return D.$$click=p,f(D,()=>i()?"📝":"📚"),F(()=>Q(D,"title",i()?"隐藏样式库":"显示样式库")),D}}),null),f(P,_(W,{get when(){return!l()},get children(){var D=Ba();return D.$$click=()=>window.location.reload(),D}}),null),f(L,_(W,{get when(){return!l()},get children(){var D=Ua(),z=D.firstChild,E=z.firstChild,R=E.nextSibling,k=R.nextSibling,q=k.firstChild;return q.$$click=async()=>{try{await Xe.initialize();const N=Xe.getStylesByCategory();a(N),o(!0),console.log("🔄 样式系统重新初始化成功")}catch(N){console.error("❌ 重新初始化失败:",N)}},D}}),null),f(L,_(W,{get when(){return l()},get children(){return[_(W,{get when(){return c()},children:D=>(()=>{var z=Xa(),E=z.firstChild,R=E.firstChild,k=R.firstChild,q=k.nextSibling,N=R.nextSibling,C=N.firstChild,A=C.nextSibling;return f(k,()=>D().name),f(q,()=>Qa(D().category)),C.$$click=()=>h(D().id),A.$$click=b,z})()}),_(W,{get when(){return!c()},get children(){var D=Ha(),z=D.firstChild,E=z.nextSibling;return z.$$click=p,E.$$click=v,D}}),_(W,{get when(){return i()},get children(){var D=qa();return f(D,_(Na,{get selectedStyleId(){return e()},onStyleSelect:u,onStyleCreate:v,onStyleEdit:h})),D}})]}}),null),f(m,_(W,{get when(){return c()},get children(){return Wa()}}),null),f(m,_(W,{get when(){return c()},get children(){return ja()}}),null),f(m,_(W,{get when(){return!1},get children(){var D=Ya(),z=D.firstChild,E=z.nextSibling,R=E.firstChild,k=R.firstChild,q=k.firstChild,N=q.nextSibling,C=k.nextSibling,A=C.firstChild,X=A.nextSibling,G=C.nextSibling,O=G.firstChild,V=O.nextSibling,B=V.firstChild,H=G.nextSibling,j=H.firstChild,de=j.nextSibling;return f(N,()=>n.element.id),f(X,()=>e()||"无"),f(V,()=>r().length,B),f(de,()=>Ea.isElementUsingProfessionalStyle(n.element.id)?"是":"否"),D}}),null),m})():null};function Qa(n){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[n]||n}Ue(["click"]);var Ja=S('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),Ka=S('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),Za=S("<span class=property-value>"),el=S('<span class="property-value text-xs text-muted">'),Yn=S("<div class=space-y-2>"),en=S("<input type=number class=property-input>"),tl=S('<div class="grid grid-cols-2 gap-2">'),ji=S("<input type=checkbox class=property-checkbox>"),nl=S('<div class="p-4 space-y-4">'),Yi=S("<div>"),il=S("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),sl=S("<div class=property-field><label class=property-label>"),rl=S("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),Zs=S('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),er=S("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),al=S('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),tr=S("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),ll=S('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),nr=S('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),ir=S('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),ol=S('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),cl=S("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),Vi=S("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),dl=S('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),hl=S("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),ul=S("<input type=text class=property-input placeholder=图片描述文字>"),gl=S("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),fl=S("<div class=space-y-3>"),vl=S("<img class=property-image>"),pl=S("<div class=property-loading>加载数据源..."),ml=S('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),bl=S('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),yl=S('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),_l=S('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),xl=S("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),Sl=S("<div class=space-y-4>"),wl=S("<select class=property-select><option value>选择数据源"),$l=S("<option> (<!>)"),Cl=S('<div class=flex><input type=number class="property-input flex-1">'),kl=S("<span class=property-unit>"),Tl=S('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),El=S("<div class=property-alignment-group>"),Pl=S("<button>");const Xi=()=>{const{state:n,updateElement:e}=st(),t=Me(()=>{const r=new Set(n.selected_ids);return n.elements.filter(a=>r.has(a.id))}),i=Me(()=>t()[0]),s=async(r,a,l)=>{try{await e(r,{[a]:l})}catch(o){console.error("Failed to update element property:",o)}};return(()=>{var r=Ja(),a=r.firstChild,l=a.nextSibling;return f(l,_(W,{get when(){return i()},get fallback(){return Ka()},get children(){return _(Al,{get element(){return i()},onUpdate:s})}})),r})()},Al=n=>{const e=(i,s)=>{const r={...n.element.position,[i]:s};n.onUpdate(n.element.id,"position",r)},t=(i,s)=>{const r={...n.element.size,[i]:Math.max(1,s)};n.onUpdate(n.element.id,"size",r)};return(()=>{var i=nl();return f(i,_(pt,{title:"元素信息",icon:"ℹ️",get children(){var s=Yn();return f(s,_(we,{label:"类型",get children(){var r=Za();return f(r,()=>n.element.content.type),r}}),null),f(s,_(we,{label:"ID",get children(){var r=el();return f(r,()=>n.element.id),r}}),null),s}}),null),f(i,_(pt,{title:"位置和大小",icon:"📐",get children(){var s=tl();return f(s,_(we,{label:"X",get children(){var r=en();return r.$$input=a=>e("x",parseFloat(a.target.value)||0),F(()=>r.value=n.element.position.x),r}}),null),f(s,_(we,{label:"Y",get children(){var r=en();return r.$$input=a=>e("y",parseFloat(a.target.value)||0),F(()=>r.value=n.element.position.y),r}}),null),f(s,_(we,{label:"宽度",get children(){var r=en();return r.$$input=a=>t("width",parseFloat(a.target.value)||1),F(()=>r.value=n.element.size.width),r}}),null),f(s,_(we,{label:"高度",get children(){var r=en();return r.$$input=a=>t("height",parseFloat(a.target.value)||1),F(()=>r.value=n.element.size.height),r}}),null),s}}),null),f(i,_(pt,{title:"状态",icon:"👁️",get children(){var s=Yn();return f(s,_(we,{label:"可见",get children(){var r=ji();return r.addEventListener("change",a=>n.onUpdate(n.element.id,"visible",a.target.checked)),F(()=>r.checked=n.element.visible),r}}),null),f(s,_(we,{label:"锁定",get children(){var r=ji();return r.addEventListener("change",a=>n.onUpdate(n.element.id,"locked",a.target.checked)),F(()=>r.checked=n.element.locked),r}}),null),f(s,_(we,{label:"层级",get children(){var r=en();return r.$$input=a=>n.onUpdate(n.element.id,"z_index",parseInt(a.target.value)||0),F(()=>r.value=n.element.z_index),r}}),null),s}}),null),f(i,_(Us,{get children(){return[_(St,{get when(){return n.element.content.type==="Text"&&n.element.content},children:s=>(()=>{var r=Yi();return f(r,_(Wi,{get element(){return n.element},get onUpdate(){return n.onUpdate}}),null),f(r,_(Rl,{get content(){return s()},onUpdate:a=>{console.log("Text content update:",a),n.onUpdate(n.element.id,"content",a)}}),null),r})()}),_(St,{get when(){return n.element.content.type==="Rectangle"&&n.element.content},children:s=>_(Ll,{get content(){return s()},onUpdate:r=>{console.log("Rectangle content update:",r),n.onUpdate(n.element.id,"content",r)}})}),_(St,{get when(){return n.element.content.type==="Line"&&n.element.content},children:s=>_(Ml,{get content(){return s()},onUpdate:r=>{console.log("Line content update:",r),n.onUpdate(n.element.id,"content",r)}})}),_(St,{get when(){return n.element.content.type==="Image"&&n.element.content},children:s=>_(Dl,{get content(){return s()},onUpdate:r=>{console.log("Image content update:",r),n.onUpdate(n.element.id,"content",r)}})}),_(St,{get when(){return n.element.content.type==="DataField"&&n.element.content},children:s=>(()=>{var r=Yi();return f(r,_(Wi,{get element(){return n.element},get onUpdate(){return n.onUpdate}}),null),f(r,_(Ol,{get content(){return s()},onUpdate:a=>{console.log("🔍 [PropertiesPanel] DataField content update 接收到:",{更新内容:a,元素ID:n.element.id,当前content:s(),更新前data_source_id:s().data_source_id}),n.onUpdate(n.element.id,"content",a),console.log("🔍 [PropertiesPanel] 已调用 props.onUpdate")}}),null),r})()})]}}),null),i})()},pt=n=>(()=>{var e=il(),t=e.firstChild,i=t.firstChild,s=i.nextSibling,r=t.nextSibling;return f(i,()=>n.icon),f(s,()=>n.title),f(r,()=>n.children),e})(),we=n=>(()=>{var e=sl(),t=e.firstChild;return f(t,()=>n.label),f(e,()=>n.children,null),e})(),Rl=n=>_(pt,{title:"文字样式",icon:"🔤",get children(){var e=nr(),t=e.firstChild,i=t.nextSibling;return f(e,_(we,{label:"内容",get children(){var s=rl();return s.$$input=r=>n.onUpdate({content:r.target.value}),F(()=>s.value=n.content.content),s}}),t),f(t,_(we,{label:"字体",get children(){var s=Zs();return s.addEventListener("change",r=>n.onUpdate({style:{...n.content.style,font_family:r.target.value}})),F(()=>s.value=n.content.style.font_family),s}}),null),f(t,_(we,{label:"大小",get children(){return _(ft,{get value(){return n.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:s=>n.onUpdate({style:{...n.content.style,font_size:s}})})}}),null),f(i,_(we,{label:"字重",get children(){var s=er();return s.addEventListener("change",r=>n.onUpdate({style:{...n.content.style,font_weight:r.target.value}})),F(()=>s.value=n.content.style.font_weight),s}}),null),f(i,_(we,{label:"对齐",get children(){return _(sr,{get value(){return n.content.style.align},onUpdate:s=>n.onUpdate({style:{...n.content.style,align:s}})})}}),null),f(e,_(we,{label:"颜色",get children(){return _(Mt,{get value(){return n.content.style.color},onUpdate:s=>n.onUpdate({style:{...n.content.style,color:s}})})}}),null),f(e,_(we,{label:"背景",get children(){var s=al(),r=s.firstChild;return f(s,_(Mt,{get value(){return n.content.style.background?.color||"transparent"},onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,color:a}}})}),r),f(r,_(we,{label:"透明度",get children(){return _(ft,{get value(){return n.content.style.background?.opacity||1},min:0,max:1,step:.1,onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,opacity:a}}})})}}),null),f(r,_(we,{label:"内边距",get children(){return _(ft,{get value(){return n.content.style.background?.padding||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,padding:a}}})})}}),null),s}}),null),f(e,_(we,{label:"边框",get children(){var s=ll(),r=s.firstChild;return f(s,_(Mt,{get value(){return n.content.style.border?.color||"#000000"},onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,color:a}}})}),r),f(r,_(we,{label:"宽度",get children(){return _(ft,{get value(){return n.content.style.border?.width||1},min:0,max:10,step:.5,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,width:a}}})})}}),null),f(r,_(we,{label:"样式",get children(){var a=tr();return a.addEventListener("change",l=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,style:l.target.value}}})),F(()=>a.value=n.content.style.border?.style||"Solid"),a}}),null),f(r,_(we,{label:"圆角",get children(){return _(ft,{get value(){return n.content.style.border?.radius||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,radius:a}}})})}}),null),s}}),null),e}}),Ll=n=>_(pt,{title:"矩形样式",icon:"▭",get children(){var e=ol(),t=e.firstChild,i=t.firstChild;return f(e,_(we,{label:"填充颜色",get children(){return _(Mt,{get value(){return n.content.fill_color||"#ffffff"},onUpdate:s=>n.onUpdate({fill_color:s})})}}),t),f(t,_(we,{label:"边框",get children(){var s=Yn();return f(s,_(Mt,{get value(){return n.content.border?.color||"#000000"},onUpdate:r=>n.onUpdate({border:{...n.content.border,color:r}})})),s}}),i),f(i,_(we,{label:"宽度",get children(){return _(ft,{get value(){return n.content.border?.width||1},min:0,max:20,step:.5,unit:"px",onUpdate:s=>n.onUpdate({border:{...n.content.border,width:s}})})}}),null),f(i,_(we,{label:"样式",get children(){var s=tr();return s.addEventListener("change",r=>n.onUpdate({border:{...n.content.border,style:r.target.value}})),F(()=>s.value=n.content.border?.style||"Solid"),s}}),null),f(e,_(we,{label:"圆角半径",get children(){return _(ft,{get value(){return n.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:s=>n.onUpdate({corner_radius:s})})}}),null),f(e,_(we,{label:"透明度",get children(){var s=ir(),r=s.firstChild,a=r.nextSibling,l=a.firstChild;return r.$$input=o=>n.onUpdate({opacity:parseFloat(o.target.value)/100}),f(a,()=>Math.round((n.content.opacity||1)*100),l),F(()=>r.value=(n.content.opacity||1)*100),s}}),null),e}}),Ml=n=>_(pt,{title:"线条样式",icon:"━",get children(){var e=dl(),t=e.firstChild;return f(e,_(we,{label:"颜色",get children(){return _(Mt,{get value(){return n.content.color},onUpdate:i=>n.onUpdate({color:i})})}}),t),f(e,_(we,{label:"宽度",get children(){return _(ft,{get value(){return n.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:i=>n.onUpdate({width:i})})}}),t),f(e,_(we,{label:"样式",get children(){var i=cl();return i.addEventListener("change",s=>n.onUpdate({line_style:s.target.value})),F(()=>i.value=n.content.line_style||"Solid"),i}}),t),f(t,_(we,{label:"起点",get children(){var i=Vi();return i.addEventListener("change",s=>n.onUpdate({start_cap:s.target.value})),F(()=>i.value=n.content.start_cap||"None"),i}}),null),f(t,_(we,{label:"终点",get children(){var i=Vi();return i.addEventListener("change",s=>n.onUpdate({end_cap:s.target.value})),F(()=>i.value=n.content.end_cap||"None"),i}}),null),f(e,_(we,{label:"透明度",get children(){var i=ir(),s=i.firstChild,r=s.nextSibling,a=r.firstChild;return s.$$input=l=>n.onUpdate({opacity:parseFloat(l.target.value)/100}),f(r,()=>Math.round((n.content.opacity||1)*100),a),F(()=>s.value=(n.content.opacity||1)*100),i}}),null),e}}),Dl=n=>_(pt,{title:"图片属性",icon:"🖼️",get children(){var e=fl();return f(e,_(we,{label:"图片地址",get children(){var t=hl();return t.$$input=i=>n.onUpdate({src:i.target.value}),F(()=>t.value=n.content.src),t}}),null),f(e,_(we,{label:"替代文本",get children(){var t=ul();return t.$$input=i=>n.onUpdate({alt:i.target.value}),F(()=>t.value=n.content.alt||""),t}}),null),f(e,_(we,{label:"预览",get children(){var t=gl(),i=t.firstChild;return f(t,(()=>{var s=$e(()=>!!n.content.src);return()=>s()?(()=>{var r=vl();return r.addEventListener("load",a=>{const l=a.target,o=l.nextElementSibling;l&&(l.style.display="block"),o&&(o.style.display="none")}),r.addEventListener("error",a=>{const l=a.target,o=l.nextElementSibling;l&&(l.style.display="none"),o&&(o.style.display="flex")}),F(a=>{var l=n.content.src,o=n.content.alt||"图片预览";return l!==a.e&&Q(r,"src",a.e=l),o!==a.t&&Q(r,"alt",a.t=o),a},{e:void 0,t:void 0}),r})():null})(),i),F(s=>(s=n.content.src?"none":"flex")!=null?i.style.setProperty("display",s):i.style.removeProperty("display")),t}}),null),e}}),Ol=n=>{const[e,t]=K([]),[i,s]=K(!1);Vt(()=>{console.log("🔍 [DataFieldProperties] props.content 变化:",{data_source_id:n.content.data_source_id,expression:n.content.expression,完整content:n.content})}),Qe(async()=>{try{s(!0);const l=await Re.listDataSources();t(l)}catch(l){console.error("Failed to load data sources:",l)}finally{s(!1)}});const r=l=>{console.log("🔍 [DataField] handleDataSourceChange 触发:",{新值:l,当前值:n.content.data_source_id,是否为空:l==="",将要更新的值:l===""?void 0:l}),n.onUpdate({data_source_id:l===""?void 0:l}),console.log("🔍 [DataField] onUpdate 已调用，等待父组件更新"),setTimeout(()=>{console.log("🔍 [DataField] 更新后检查:",{更新后的值:n.content.data_source_id,是否更新成功:n.content.data_source_id===(l===""?void 0:l)})},100)},a=Me(()=>n.content.data_source_id?e().find(l=>l.id===n.content.data_source_id):null);return(()=>{var l=Sl();return f(l,_(pt,{title:"数据源配置",icon:"🔗",get children(){var o=Yn();return f(o,_(we,{label:"数据源",get children(){return _(W,{get when(){return i()},get fallback(){return(()=>{var c=wl();return c.firstChild,c.$$input=d=>{console.log("🔍 [DataField] select onInput 事件触发:",d.currentTarget.value)},c.addEventListener("change",d=>{console.log("🔍 [DataField] select onChange 事件触发:",{target:d.target,currentTarget:d.currentTarget,value:d.currentTarget.value,selectedIndex:d.currentTarget.selectedIndex,selectedOption:d.currentTarget.options[d.currentTarget.selectedIndex]?.text}),r(d.currentTarget.value)}),f(c,_(pe,{get each(){return e()},children:d=>(console.log("🔍 [DataField] 渲染数据源选项:",{id:d.id,name:d.name,当前选中:n.content.data_source_id===d.id}),(()=>{var u=$l(),g=u.firstChild,v=g.nextSibling;return v.nextSibling,f(u,()=>d.name,g),f(u,()=>d.providerType||d.provider_type,v),F(()=>u.value=d.id),u})())}),null),F(()=>c.value=n.content.data_source_id||""),c})()},get children(){return pl()}})}}),null),f(o,_(W,{get when(){return a()},get children(){var c=ml(),d=c.firstChild,u=d.firstChild,g=u.firstChild,v=g.nextSibling,h=v.nextSibling,p=u.nextSibling,b=p.firstChild;b.nextSibling;var m=p.nextSibling,y=m.firstChild;return y.nextSibling,f(h,(()=>{var $=$e(()=>a().status==="active");return()=>$()?"活跃":a().status==="error"?"错误":"禁用"})()),f(p,()=>a().providerType||a().provider_type,null),f(m,()=>new Date(a().lastUpdated||a().last_updated).toLocaleString("zh-CN"),null),F(()=>Se(h,a().status==="active"?"text-green-600":a().status==="error"?"text-red-600":"text-gray-600")),c}}),null),f(o,_(we,{label:"表达式",get children(){var c=bl();return c.$$input=d=>n.onUpdate({expression:d.currentTarget.value}),c.disabled=!1,F(()=>c.value=n.content.expression||""),c}}),null),f(o,_(W,{get when(){return!n.content.expression||!n.content.expression.trim()},get children(){return yl()}}),null),f(o,_(W,{get when(){return n.content.expression&&!n.content.data_source_id},get children(){return _l()}}),null),f(o,_(we,{label:"格式",get children(){var c=xl();return c.addEventListener("change",d=>n.onUpdate({format:d.currentTarget.value==="default"?void 0:d.currentTarget.value})),F(()=>c.value=n.content.format||"default"),c}}),null),o}}),null),f(l,_(pt,{title:"字段样式",icon:"🎨",get children(){var o=nr(),c=o.firstChild,d=c.nextSibling;return f(c,_(we,{label:"字体",get children(){var u=Zs();return u.addEventListener("change",g=>n.onUpdate({style:{...n.content.style,font_family:g.currentTarget.value}})),F(()=>u.value=n.content.style.font_family),u}}),null),f(c,_(we,{label:"大小",get children(){return _(ft,{get value(){return n.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:u=>n.onUpdate({style:{...n.content.style,font_size:u}})})}}),null),f(d,_(we,{label:"字重",get children(){var u=er();return u.addEventListener("change",g=>n.onUpdate({style:{...n.content.style,font_weight:g.currentTarget.value}})),F(()=>u.value=n.content.style.font_weight),u}}),null),f(d,_(we,{label:"对齐",get children(){return _(sr,{get value(){return n.content.style.align},onUpdate:u=>n.onUpdate({style:{...n.content.style,align:u}})})}}),null),f(o,_(we,{label:"颜色",get children(){return _(Mt,{get value(){return n.content.style.color},onUpdate:u=>n.onUpdate({style:{...n.content.style,color:u}})})}}),null),o}}),null),l})()},ft=n=>(()=>{var e=Cl(),t=e.firstChild;return t.addEventListener("blur",i=>{const s=parseFloat(i.target.value)||n.value,r=Math.max(n.min||-1/0,Math.min(n.max||1/0,s));r!==s&&(i.target.value=r.toString(),n.onUpdate(r))}),t.$$input=i=>{const s=parseFloat(i.target.value);if(!isNaN(s)){const r=Math.max(n.min||-1/0,Math.min(n.max||1/0,s));n.onUpdate(r)}},f(e,(()=>{var i=$e(()=>!!n.unit);return()=>i()&&(()=>{var s=kl();return f(s,()=>n.unit),s})()})(),null),F(i=>{var s=n.min,r=n.max,a=n.step||1;return s!==i.e&&Q(t,"min",i.e=s),r!==i.t&&Q(t,"max",i.t=r),a!==i.a&&Q(t,"step",i.a=a),i},{e:void 0,t:void 0,a:void 0}),F(()=>t.value=n.value),e})(),Mt=n=>(()=>{var e=Tl(),t=e.firstChild,i=t.firstChild,s=i.nextSibling,r=t.nextSibling;return i.$$input=a=>n.onUpdate(a.target.value),r.$$input=a=>{const l=a.target.value;(/^#[0-9A-Fa-f]{6}$/.test(l)||/^#[0-9A-Fa-f]{3}$/.test(l))&&n.onUpdate(l)},F(a=>(a=n.value)!=null?s.style.setProperty("background-color",a):s.style.removeProperty("background-color")),F(()=>i.value=n.value),F(()=>r.value=n.value),e})(),sr=n=>{const e=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var t=El();return f(t,()=>e.map(i=>(()=>{var s=Pl();return s.$$click=()=>n.onUpdate(i.value),f(s,()=>i.icon),F(r=>{var a=`property-alignment-btn ${n.value===i.value?"active":""}`,l=i.label;return a!==r.e&&Se(s,r.e=a),l!==r.t&&Q(s,"title",r.t=l),r},{e:void 0,t:void 0}),s})())),t})()};Ue(["input","click"]);var Il=S("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),Nl=S("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const zl=n=>_(W,{get when(){return n.config.show_grid},get children(){return[(()=>{var e=Il(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return F(r=>{var a=n.config.grid_size,l=n.config.grid_size,o=n.config.grid_size,c=n.config.grid_size,d=n.config.grid_size,u=n.config.grid_size,g=n.config.grid_size,v=n.config.grid_size;return a!==r.e&&Q(t,"width",r.e=a),l!==r.t&&Q(t,"height",r.t=l),o!==r.a&&Q(i,"x1",r.a=o),c!==r.o&&Q(i,"x2",r.o=c),d!==r.i&&Q(i,"y2",r.i=d),u!==r.n&&Q(s,"y1",r.n=u),g!==r.s&&Q(s,"x2",r.s=g),v!==r.h&&Q(s,"y2",r.h=v),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),e})(),(()=>{var e=Nl();return F(t=>{var i=n.config.width,s=n.config.height;return i!==t.e&&Q(e,"width",t.e=i),s!==t.t&&Q(e,"height",t.t=s),t},{e:void 0,t:void 0}),e})()]}});class Fl{expressionCache=new Map;maxCacheSize=1e3;async evaluateExpression(e,t){if(!e||!e.trim())return{success:!1,error:"表达式不能为空"};if(!t)return{success:!1,error:"没有可用的数据上下文"};try{const i=this.preprocessExpression(e),s=this.getCompiledExpression(i),r=await this.executeCompiledExpression(s,t);return{success:!0,value:r.value,type:this.inferValueType(r.value)}}catch(i){return{success:!1,error:i instanceof Error?i.message:String(i)}}}validateExpression(e,t){if(!e||!e.trim())return{valid:!1,error:"表达式不能为空"};try{const i=this.preprocessExpression(e),s=this.compileExpression(i);return this.staticValidation(s,t)}catch(i){return{valid:!1,error:i instanceof Error?i.message:"表达式格式错误"}}}getFieldSuggestions(e,t){if(!t)return[];const i=e.toLowerCase().replace(/[{}]/g,""),s=[];if(t.fields.forEach(r=>{r.name.toLowerCase().includes(i)&&s.push(`{${r.name}}`),r.displayName&&r.displayName.toLowerCase().includes(i)&&s.push(`{${r.name}}`)}),t.currentRecord.data){const r=this.getNestedFieldSuggestions(i,t.currentRecord.data,"");s.push(...r)}return Array.from(new Set(s)).sort((r,a)=>{const l=r.replace(/[{}]/g,""),o=a.replace(/[{}]/g,"");return l===i?-1:o===i?1:l.startsWith(i)?-1:o.startsWith(i)?1:l.localeCompare(o)}).slice(0,20)}preprocessExpression(e){let t=e.trim();return!t.startsWith("{")&&!t.endsWith("}")&&(t=`{${t}}`),t=t.replace(/^\{+/,"{").replace(/\}+$/,"}"),t}getCompiledExpression(e){let t=this.expressionCache.get(e);if(!t){if(t=this.compileExpression(e),this.expressionCache.size>=this.maxCacheSize){const i=this.expressionCache.keys().next().value;i&&this.expressionCache.delete(i)}this.expressionCache.set(e,t)}return t}compileExpression(e){const t=e.slice(1,-1),i=this.parsePath(t);return{original:e,path:i,type:this.determineExpressionType(i)}}parsePath(e){const t=[];let i="",s=!1;for(let r=0;r<e.length;r++){const a=e[r];if(a==="["&&!s)i&&(t.push({type:"field",value:i}),i=""),s=!0;else if(a==="]"&&s){const l=parseInt(i,10);if(isNaN(l))throw new Error(`无效的数组索引: ${i}`);t.push({type:"index",value:l}),i="",s=!1}else a==="."&&!s?i&&(t.push({type:"field",value:i}),i=""):i+=a}if(i){if(s)throw new Error("未闭合的数组索引");t.push({type:"field",value:i})}if(t.length===0)throw new Error("空的字段路径");return t}async executeCompiledExpression(e,t){let i=t.currentRecord.data;for(const s of e.path){if(i==null)throw new Error("无法访问 null/undefined 值的属性");if(s.type==="field"){if(typeof i!="object")throw new Error(`尝试访问非对象类型的字段: ${s.value}`);if(!(s.value in i))throw new Error(`字段不存在: ${s.value}`);i=i[s.value]}else if(s.type==="index"){if(!Array.isArray(i))throw new Error("尝试对非数组类型使用索引访问");const r=s.value;if(r<0||r>=i.length)throw new Error(`数组索引超出范围: ${r}`);i=i[r]}}return{value:i}}staticValidation(e,t){if(!t)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const i=[],s=e.path[0];if(s&&s.type==="field"){const a=s.value;if(!t.fields.some(o=>o.name===a)){const o=t.fields.filter(c=>c.name.toLowerCase().includes(a.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),a.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${a}`,suggestions:o}}}e.path.length>5&&i.push("表达式路径过深，可能影响性能");const r={valid:!0};return i.length>0&&(r.warnings=i),r}getNestedFieldSuggestions(e,t,i){const s=[];if(!t||typeof t!="object")return s;for(const r of Object.keys(t)){const a=i?`${i}.${r}`:r;a.toLowerCase().includes(e)&&s.push(`{${a}}`),i.split(".").length<3&&t[r]&&typeof t[r]=="object"&&s.push(...this.getNestedFieldSuggestions(e,t[r],a))}return s}inferValueType(e){return e==null?"object":typeof e=="string"?"string":typeof e=="number"?"number":typeof e=="boolean"?"boolean":e instanceof Date?"date":typeof e=="object"?"object":"string"}determineExpressionType(e){return e.length===1?"simple":e.length<=3&&e.every(t=>t.type==="field")?"nested":"complex"}levenshteinDistance(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const i=new Array(t.length+1);for(let s=0;s<=t.length;s++)i[s]=new Array(e.length+1),i[s][0]=s;for(let s=0;s<=e.length;s++)i[0][s]=s;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++){const a=e[r-1]===t[s-1]?0:1;i[s][r]=Math.min(i[s-1][r]+1,i[s][r-1]+1,i[s-1][r-1]+a)}return i[t.length][e.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const si=new Fl;class Gl{context=K(null);subscribers=[];constructor(){this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(e){try{const i=(await Re.listDataSources()).find(d=>d.id===e);if(!i)throw new Error(`数据源不存在: ${e}`);console.log("🔍 找到数据源:",i);const s=i.providerType||i.provider_type||i.type_name||"json";console.log("🔍 推断的 providerType:",s);let r={rows:[],totalCount:0},a={columns:[]},l=null;try{r=await Re.getPreview(e,void 0,1),console.log("🔍 预览数据:",r)}catch(d){console.warn("⚠️  获取数据预览失败，继续构建上下文:",d),l=d}try{a=await Re.getSchema(e),console.log("🔍 Schema信息:",a)}catch(d){console.warn("⚠️  获取Schema失败，继续构建上下文:",d),l||(l=d)}const o=Array.isArray(a.columns)?a.columns.map(d=>({name:d.name,displayName:d.description||d.name,type:this.mapDataType(d.data_type),nullable:!!d.nullable,sample:d.default_value})):[],c={dataSource:{id:e,type:this.inferDataSourceType(s),name:i.name,status:this.mapDataSourceStatus(i.status)},currentRecord:{index:0,total:r.totalCount??r.total_rows??r.total_count??0,data:r&&r.rows&&r.rows[0]?r.rows[0]:{}},fields:o,...l?{error:{type:"system",message:String(l),details:l}}:{}};console.log("✅ 创建新的数据上下文:",c),this.context[1](c);try{typeof window<"u"&&window.localStorage&&window.localStorage.setItem("jasper.activeDataSourceId",e)}catch(d){console.warn("无法持久化激活数据源ID:",d)}this.notifySubscribers(c)}catch(t){console.error("设置数据源失败:",t);let i="",s;try{const l=(await Re.listDataSources()).find(o=>o.id===e);l&&(i=l.name,s=l.providerType||l.provider_type||l.type_name)}catch{}const r={dataSource:{id:e,type:this.inferDataSourceType(s||"json"),name:i||"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:t instanceof Error?t.message:"数据源加载失败",details:t}};this.context[1](r),this.notifySubscribers(r)}}async navigateToRecord(e){const t=this.getCurrentContext();if(!t||e<0||e>=t.currentRecord.total)return!1;try{const i=await Re.queryData(t.dataSource.id,{limit:1,offset:e});if(i.rows.length===0)return!1;const s={...t,currentRecord:{...t.currentRecord,index:e,data:i.rows[0]}};return this.context[1](s),this.notifySubscribers(s),!0}catch(i){return console.error("导航到记录失败:",i),!1}}async navigateNext(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index+1):!1}async navigatePrevious(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index-1):!1}async evaluateExpression(e){const t=this.getCurrentContext();return await si.evaluateExpression(e,t)}validateExpression(e){const t=this.getCurrentContext(),i=si.validateExpression(e,t);return{valid:i.valid,...i.error&&{error:i.error},...i.suggestions&&{suggestions:i.suggestions}}}getFieldSuggestions(e){const t=this.getCurrentContext();return si.getFieldSuggestions(e,t)}subscribe(e){return this.subscribers.push(e),()=>{const t=this.subscribers.indexOf(e);t>-1&&this.subscribers.splice(t,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(e){this.subscribers.forEach(t=>{try{t(e)}catch(i){console.error("数据上下文订阅回调错误:",i)}})}inferDataSourceType(e){if(!e)return console.warn("providerType is undefined, defaulting to json"),"json";const t=e.toLowerCase();return t==="json"?"json":t==="excel"?"excel":t==="sql"?"sql":t==="xml"?"xml":t==="csv"?"csv":t.startsWith("database")?"sql":"json"}mapDataType(e){switch(e){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(e){if(!e)return console.warn("status is undefined, defaulting to empty"),"empty";switch(e.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${e}, defaulting to empty`),"empty"}}}const Ze=new Gl;var Bl=S("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),Qi=S("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),Ul=S("<svg><rect class=text-background-unified></svg>",!1,!0,!1),Hl=S("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),ql=S("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),Wl=S("<svg><tspan class=text-line-original></svg>",!1,!0,!1),jl=S("<svg><rect x=0 y=0></svg>",!1,!0,!1),Yl=S("<svg><line x1=0></svg>",!1,!0,!1),Vl=S("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),Xl=S('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),Ql=S("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),Jl=S("<svg><tspan dy=0></svg>",!1,!0,!1),Kl=S("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),Zl=S("<svg><g></svg>",!1,!0,!1);const eo=n=>{const{state:e}=_n(),[t,i]=K("[数据字段]");Vt(()=>{if(n.element.content.type==="DataField"){const a=n.element.content.expression||"",l=e().mode;ei.shouldShowExpression(l)?i(a||"[数据字段]"):ei.shouldEvaluateExpression(l)&&Ze.evaluateExpression(a).then(o=>{o.success?i(String(o.value||"")):i(`[错误: ${o.error}]`)}).catch(o=>{i(`[错误: ${o}]`)})}});const s=Me(()=>{const{position:a}=n.element;return{transform:`translate(${a.x}px, ${a.y}px)`,opacity:n.element.visible?1:.5}}),r=()=>{const{content:a,size:l}=n.element;if(a.type==="Text"&&a.content&&a.style){const o=qt.calculateUnifiedBounds(a.content,a.style,l),c=qt.getTextAnchor(a.style.align);return(()=>{var d=Bl(),u=d.firstChild;return f(d,(()=>{var g=$e(()=>!!n.selected);return()=>g()&&(()=>{var v=Qi();return F(h=>{var p=o.containerBounds.x,b=o.containerBounds.y,m=o.containerBounds.width,y=o.containerBounds.height;return p!==h.e&&Q(v,"x",h.e=p),b!==h.t&&Q(v,"y",h.t=b),m!==h.a&&Q(v,"width",h.a=m),y!==h.o&&Q(v,"height",h.o=y),h},{e:void 0,t:void 0,a:void 0,o:void 0}),v})()})(),u),f(d,(()=>{var g=$e(()=>!!a.style.background);return()=>g()&&(()=>{var v=Ul();return F(h=>{var p=o.positioning.backgroundX,b=o.positioning.backgroundY,m=o.containerBounds.width+(a.style.background.padding||0)*2,y=o.containerBounds.height+(a.style.background.padding||0)*2,$=a.style.background.color,x=a.style.background.opacity||1,w=a.style.border?.radius||0,P=a.style.border?.radius||0;return p!==h.e&&Q(v,"x",h.e=p),b!==h.t&&Q(v,"y",h.t=b),m!==h.a&&Q(v,"width",h.a=m),y!==h.o&&Q(v,"height",h.o=y),$!==h.i&&Q(v,"fill",h.i=$),x!==h.n&&Q(v,"fill-opacity",h.n=x),w!==h.s&&Q(v,"rx",h.s=w),P!==h.h&&Q(v,"ry",h.h=P),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),v})()})(),u),f(d,(()=>{var g=$e(()=>!!a.style.border);return()=>g()&&(()=>{var v=Hl();return F(h=>{var p=o.positioning.backgroundX,b=o.positioning.backgroundY,m=o.containerBounds.width+(a.style.background?.padding||0)*2,y=o.containerBounds.height+(a.style.background?.padding||0)*2,$=a.style.border.color,x=a.style.border.width,w=a.style.border.style==="Dashed"?"5,5":a.style.border.style==="Dotted"?"2,2":"none",P=a.style.border.radius||0,L=a.style.border.radius||0;return p!==h.e&&Q(v,"x",h.e=p),b!==h.t&&Q(v,"y",h.t=b),m!==h.a&&Q(v,"width",h.a=m),y!==h.o&&Q(v,"height",h.o=y),$!==h.i&&Q(v,"stroke",h.i=$),x!==h.n&&Q(v,"stroke-width",h.n=x),w!==h.s&&Q(v,"stroke-dasharray",h.s=w),P!==h.h&&Q(v,"rx",h.h=P),L!==h.r&&Q(v,"ry",h.r=L),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),v})()})(),u),Q(u,"text-anchor",c),f(u,(()=>{var g=$e(()=>!!o.textLayout?.isWrapped);return()=>g()?o.textLayout.wrappedLines.map((v,h)=>(()=>{var p=ql();return f(p,v),F(b=>{var m=o.positioning.textAnchorX,y=h===0?0:o.fontMetrics.lineHeight;return m!==b.e&&Q(p,"x",b.e=m),y!==b.t&&Q(p,"dy",b.t=y),b},{e:void 0,t:void 0}),p})()):a.content.split(`
`).map((v,h)=>(()=>{var p=Wl();return f(p,v),F(b=>{var m=o.positioning.textAnchorX,y=h===0?0:o.fontMetrics.lineHeight;return m!==b.e&&Q(p,"x",b.e=m),y!==b.t&&Q(p,"dy",b.t=y),b},{e:void 0,t:void 0}),p})())})()),F(g=>{var v=o.positioning.textAnchorX,h=o.positioning.textAnchorY,p=a.style.font_family,b=a.style.font_size.toString(),m=a.style.font_weight,y=a.style.color;return v!==g.e&&Q(u,"x",g.e=v),h!==g.t&&Q(u,"y",g.t=h),p!==g.a&&Q(u,"font-family",g.a=p),b!==g.o&&Q(u,"font-size",g.o=b),m!==g.i&&Q(u,"font-weight",g.i=m),y!==g.n&&Q(u,"fill",g.n=y),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),d})()}if(a.type==="Rectangle"){const o=a.opacity!==void 0?a.opacity:1,c=a.corner_radius||0;return(()=>{var d=jl();return Q(d,"rx",c),Q(d,"ry",c),Q(d,"fill-opacity",o),Q(d,"stroke-opacity",o),F(u=>{var g=l.width,v=l.height,h=a.fill_color||"transparent",p=a.border?.color||"#000000",b=a.border?.width||1,m=a.border?.style==="Dashed"?"5,5":a.border?.style==="Dotted"?"2,2":"none";return g!==u.e&&Q(d,"width",u.e=g),v!==u.t&&Q(d,"height",u.t=v),h!==u.a&&Q(d,"fill",u.a=h),p!==u.o&&Q(d,"stroke",u.o=p),b!==u.i&&Q(d,"stroke-width",u.i=b),m!==u.n&&Q(d,"stroke-dasharray",u.n=m),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),d})()}if(a.type==="Line"){const o=a.opacity!==void 0?a.opacity:1,c=a.line_style||"Solid",d=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var u=Yl();return Q(u,"stroke-opacity",o),Q(u,"stroke-dasharray",d),F(g=>{var v=l.height/2,h=l.width,p=l.height/2,b=a.color,m=a.width;return v!==g.e&&Q(u,"y1",g.e=v),h!==g.t&&Q(u,"x2",g.t=h),p!==g.a&&Q(u,"y2",g.a=p),b!==g.o&&Q(u,"stroke",g.o=b),m!==g.i&&Q(u,"stroke-width",g.i=m),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),u})()}if(a.type==="DataField"&&a.style){const o=t(),c=qt.calculateUnifiedBounds(o,a.style,l),d=qt.getTextAnchor(a.style.align);return(()=>{var u=Vl(),g=u.firstChild;return f(u,(()=>{var v=$e(()=>!!n.selected);return()=>v()&&(()=>{var h=Qi();return F(p=>{var b=c.containerBounds.x,m=c.containerBounds.y,y=c.containerBounds.width,$=c.containerBounds.height;return b!==p.e&&Q(h,"x",p.e=b),m!==p.t&&Q(h,"y",p.t=m),y!==p.a&&Q(h,"width",p.a=y),$!==p.o&&Q(h,"height",p.o=$),p},{e:void 0,t:void 0,a:void 0,o:void 0}),h})()})(),g),f(u,(()=>{var v=$e(()=>!!ei.shouldShowExpression(e().mode));return()=>v()&&(()=>{var h=Xl(),p=h.firstChild,b=p.nextSibling;return F(m=>{var y=c.containerBounds.x+c.containerBounds.width-8,$=c.containerBounds.y+8,x=c.containerBounds.x+c.containerBounds.width-8,w=c.containerBounds.y+8;return y!==m.e&&Q(p,"cx",m.e=y),$!==m.t&&Q(p,"cy",m.t=$),x!==m.a&&Q(b,"x",m.a=x),w!==m.o&&Q(b,"y",m.o=w),m},{e:void 0,t:void 0,a:void 0,o:void 0}),h})()})(),g),Q(g,"text-anchor",d),f(g,(()=>{var v=$e(()=>!!c.textLayout?.isWrapped);return()=>v()?c.textLayout.wrappedLines.map((h,p)=>(()=>{var b=Ql();return f(b,h),F(m=>{var y=c.positioning.textAnchorX,$=p===0?0:c.fontMetrics.lineHeight;return y!==m.e&&Q(b,"x",m.e=y),$!==m.t&&Q(b,"dy",m.t=$),m},{e:void 0,t:void 0}),b})()):(()=>{var h=Jl();return f(h,o),F(()=>Q(h,"x",c.positioning.textAnchorX)),h})()})()),F(v=>{var h=e().mode,p=c.positioning.textAnchorX,b=c.positioning.textAnchorY,m=a.style.font_family,y=a.style.font_size.toString(),$=a.style.font_weight,x=o.startsWith("[错误:")?"#ff4d4f":a.style.color,w=`datafield-content-unified ${e().mode}-mode`;return h!==v.e&&Q(u,"data-preview-mode",v.e=h),p!==v.t&&Q(g,"x",v.t=p),b!==v.a&&Q(g,"y",v.a=b),m!==v.o&&Q(g,"font-family",v.o=m),y!==v.i&&Q(g,"font-size",v.i=y),$!==v.n&&Q(g,"font-weight",v.n=$),x!==v.s&&Q(g,"fill",v.s=x),w!==v.h&&Q(g,"class",v.h=w),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),u})()}return(()=>{var o=Kl();return F(c=>{var d=l.width,u=l.height;return d!==c.e&&Q(o,"width",c.e=d),u!==c.t&&Q(o,"height",c.t=u),c},{e:void 0,t:void 0}),o})()};return(()=>{var a=Zl();return f(a,r),F(l=>{var o=`element ${n.selected&&n.element.content.type!=="Text"&&n.element.content.type!=="DataField"?"element-selected":""}`,c=s(),d=n.element.id,u=n.element.content.type;return o!==l.e&&Q(a,"class",l.e=o),l.t=Hs(a,c,l.t),d!==l.a&&Q(a,"data-element-id",l.a=d),u!==l.o&&Q(a,"data-element-type",l.o=u),l},{e:void 0,t:void 0,a:void 0,o:void 0}),a})()};var to=S("<svg><g class=resize-handles></svg>",!1,!0,!1),no=S("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const io=n=>{const{updateElement:e,setResizeOperation:t}=st(),[i,s]=K(!1),[r,a]=K(null),[l,o]=K({x:0,y:0}),[c,d]=K({width:0,height:0}),[u,g]=K({x:0,y:0}),[v,h]=K({width:0,height:0}),[p,b]=K({x:0,y:0}),[m,y]=K(!1),$=Me(()=>{const{position:E,size:R,content:k}=n.element,N=8/2;let C={x:E.x,y:E.y,width:R.width,height:R.height};if((k.type==="Text"||k.type==="DataField")&&k.style){const H=k.type==="Text"?k.content:k.expression||"[数据字段]",j=qt.calculateUnifiedBounds(H,k.style,R);C={x:E.x+j.containerBounds.x,y:E.y+j.containerBounds.y,width:j.containerBounds.width,height:j.containerBounds.height}}const A=C.x,X=C.y,G=C.x+C.width,O=C.y+C.height,V=C.x+C.width/2,B=C.y+C.height/2;return[{position:"nw",cursor:"nw-resize",x:A-N,y:X-N},{position:"ne",cursor:"ne-resize",x:G-N,y:X-N},{position:"sw",cursor:"sw-resize",x:A-N,y:O-N},{position:"se",cursor:"se-resize",x:G-N,y:O-N},{position:"n",cursor:"n-resize",x:V-N,y:X-N},{position:"s",cursor:"s-resize",x:V-N,y:O-N},{position:"w",cursor:"w-resize",x:A-N,y:B-N},{position:"e",cursor:"e-resize",x:G-N,y:B-N}]}),x=(E,R,k,q=!1,N=!1)=>{const C=c(),A=u();let X=C.width,G=C.height,O=A.x,V=A.y;switch(E){case"nw":X=C.width-R,G=C.height-k,O=A.x+R,V=A.y+k;break;case"ne":X=C.width+R,G=C.height-k,V=A.y+k;break;case"sw":X=C.width-R,G=C.height+k,O=A.x+R;break;case"se":X=C.width+R,G=C.height+k;break;case"n":G=C.height-k,V=A.y+k;break;case"s":G=C.height+k;break;case"w":X=C.width-R,O=A.x+R;break;case"e":X=C.width+R;break}if(q&&(E==="nw"||E==="ne"||E==="sw"||E==="se")){const H=C.width/C.height;X/G>H?(X=G*H,(E==="nw"||E==="sw")&&(O=A.x+(C.width-X))):(G=X/H,(E==="nw"||E==="ne")&&(V=A.y+(C.height-G)))}if(N){const H=A.x+C.width/2,j=A.y+C.height/2;O=H-X/2,V=j-G/2}const B=20;return X=Math.max(B,X),G=Math.max(B,G),{size:{width:X,height:G},position:{x:O,y:V}}},w=E=>(E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation(),!1),P=(E,R)=>{t(!0),document.addEventListener("click",w,{capture:!0}),s(!0),a(E),o({x:R.clientX,y:R.clientY}),d({width:n.element.size.width,height:n.element.size.height}),g({x:n.element.position.x,y:n.element.position.y}),h(n.element.size),b(n.element.position),y(!1),document.addEventListener("mousemove",D),document.addEventListener("mouseup",z),document.body.style.cursor=$().find(k=>k.position===E)?.cursor||"default"};let L=0;const D=E=>{if(!i())return;const R=r();if(!R)return;const k=l(),q=E.clientX-k.x,N=E.clientY-k.y,C=x(R,q,N,E.shiftKey,E.altKey);h(C.size),b(C.position),y(Math.abs(q)>2||Math.abs(N)>2);const A=Date.now();if(A-L>50)try{e(n.element.id,{size:C.size,position:C.position}),L=A}catch{}},z=()=>{if(!i()||!r())return;const R=()=>{document.removeEventListener("click",w,{capture:!0}),t(!1),s(!1),a(null),document.body.style.cursor="default",document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",z)};if(m()){const k=v(),q=p();e(n.element.id,{size:k,position:q}).catch(N=>{e(n.element.id,{size:c(),position:u()}).catch(C=>{})})}R()};return dt(()=>{t(!1),document.removeEventListener("click",w,{capture:!0}),document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",z),document.body.style.cursor="default"}),(()=>{var E=to();return f(E,()=>$().map(R=>(()=>{var k=no(),q=k.firstChild,N=q.nextSibling;return N.addEventListener("mouseleave",C=>{i()||(document.body.style.cursor="default")}),N.addEventListener("mouseenter",C=>{i()||(document.body.style.cursor=R.cursor)}),N.$$mousedown=C=>{C.stopPropagation(),C.preventDefault(),P(R.position,C)},N.style.setProperty("pointer-events","all"),F(C=>{var A=R.x+4,X=R.y+4,G=R.x,O=R.y,V=R.cursor;return A!==C.e&&Q(q,"cx",C.e=A),X!==C.t&&Q(q,"cy",C.t=X),G!==C.a&&Q(N,"x",C.a=G),O!==C.o&&Q(N,"y",C.o=O),V!==C.i&&((C.i=V)!=null?N.style.setProperty("cursor",V):N.style.removeProperty("cursor")),C},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),k})())),E})()};Ue(["mousedown"]);var tt=(n=>(n.IDLE="idle",n.HOVER="hover",n.SELECTING="selecting",n.DRAGGING="dragging",n))(tt||{});const so={dragThreshold:3,updateThrottle:16};var ro=S("<div tabindex=0>"),ao=S("<div>"),lo=S("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),oo=S("<div>拖拽: <!>个元素"),co=S("<div>[<!>]");const rr=n=>{const{resizeOperation:e,setResizeOperation:t}=st(),i=so;let s;const[r,a]=K(tt.IDLE),[l,o]=K([]),[c,d]=K(null),[u,g]=K(null),[v,h]=K(null),p=(M,I)=>Math.sqrt(Math.pow(M.x-I.x,2)+Math.pow(M.y-I.y,2)),b=(M,I)=>M.length===I.length&&M.every((J,Y)=>J===I[Y]),m=()=>{h(null)},[y,$]=K(null);let x="default";const w=(M,I)=>{!s||x===M||(s.style.cursor=M,x=M)},P=(M,...I)=>{console.log(`🎯 [InteractionLayer] ${M}`,...I)},L=M=>{if(!s)return{x:0,y:0};const I=s.getBoundingClientRect();return{x:M.clientX-I.left,y:M.clientY-I.top}},D=(M,I)=>M.x>=I.position.x&&M.x<=I.position.x+I.size.width&&M.y>=I.position.y&&M.y<=I.position.y+I.size.height,z=M=>{const I=E(M);return I.length>0?I[0]??null:null},E=M=>{const I=n.getAllElements();return I.filter(Y=>Y&&Y.visible&&D(M,Y)).sort((Y,ie)=>{const ce=Y.z_index??I.indexOf(Y);return(ie.z_index??I.indexOf(ie))-ce})},R=M=>{const I=l();if(I.length===0)return null;const J=n.getAllElements();for(const Y of I){const ie=J.find(at=>at.id===Y);if(!ie||!ie.visible)continue;const ce=8,ae=ce/2,Ce=ie.position.x,Ie=ie.position.y,Te=ie.position.x+ie.size.width,Ye=ie.position.y+ie.size.height,We=ie.position.x+ie.size.width/2,ot=ie.position.y+ie.size.height/2,Pt=[{direction:"nw",cursor:"nw-resize",x:Ce-ae,y:Ie-ae},{direction:"ne",cursor:"ne-resize",x:Te-ae,y:Ie-ae},{direction:"sw",cursor:"sw-resize",x:Ce-ae,y:Ye-ae},{direction:"se",cursor:"se-resize",x:Te-ae,y:Ye-ae},{direction:"n",cursor:"n-resize",x:We-ae,y:Ie-ae},{direction:"s",cursor:"s-resize",x:We-ae,y:Ye-ae},{direction:"w",cursor:"w-resize",x:Ce-ae,y:ot-ae},{direction:"e",cursor:"e-resize",x:Te-ae,y:ot-ae}];for(const at of Pt)if(M.x>=at.x&&M.x<at.x+ce&&M.y>=at.y&&M.y<at.y+ce)return{elementId:ie.id,direction:at.direction,cursor:at.cursor}}return null},k=M=>n.getAllElements().filter(J=>{if(!J.visible)return!1;const Y={x:J.position.x,y:J.position.y,width:J.size.width,height:J.size.height};return!(Y.x>M.x+M.width||Y.x+Y.width<M.x||Y.y>M.y+M.height||Y.y+Y.height<M.y)}),q=(M,I)=>{const J=E(M);return P("重叠选择检测",{elementsCount:J.length,isCtrlClick:I,elementIds:J.map(Y=>Y.id)}),J.length===0?null:J.length===1?(m(),J[0]?.id||null):I?N(M,J):(m(),P("普通点击选中最上层",{elementId:J[0]?.id}),J[0]?.id||null)},N=(M,I)=>{const J=v(),Y=Date.now();if(P("循环选择开始",{hasContext:!!J,elementIds:I.map(ce=>ce.id)}),!J||p(M,J.clickPoint)>5||Y-J.lastClickTime>3e3||!b(I.map(ce=>ce.id),J.overlappingElements.map(ce=>ce.id))){const ce=I.length>1?1:0;return h({clickPoint:M,overlappingElements:I,currentSelectedIndex:ce,lastClickTime:Y}),P("循环选择重置",{selectedIndex:ce,selectedId:I[ce]?.id,reason:J?p(M,J.clickPoint)>5?"position_changed":Y-J.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),C(ce+1,I.length,M),I[ce]?.id||null}else{const ce=(J.currentSelectedIndex+1)%I.length;return h({...J,currentSelectedIndex:ce,lastClickTime:Y}),P("循环选择继续",{selectedIndex:ce,selectedId:I[ce]?.id}),C(ce+1,I.length,M),I[ce]?.id||null}},C=(M,I,J)=>{const Y=document.querySelector(".overlap-indicator");Y?.parentNode&&Y.parentNode.removeChild(Y);const ie=document.createElement("div");ie.className="overlap-indicator",ie.textContent=`${M}/${I}`,Object.assign(ie.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${J.x+10}px`,top:`${J.y-20}px`}),document.body.appendChild(ie),P("显示重叠指示器",{current:M,total:I,point:J}),setTimeout(()=>{ie.parentNode&&(ie.parentNode.removeChild(ie),P("移除重叠指示器"))},1500)},A=M=>{const I=L(M);if(y()){ne(I);return}if(r()===tt.DRAGGING){he(I);return}if(r()===tt.SELECTING){te(I);return}if(r()===tt.IDLE&&c()&&!c()?.isDragging){fe(I);return}r()===tt.IDLE&&!c()&&!y()&&X(I)},X=M=>{const I=R(M);if(I){w(I.cursor);return}const J=z(M);if(J){const ie=l().includes(J.id)?"grab":"pointer";w(ie);return}w("default")},G=M=>{const I=L(M),J=R(I);if(J){P("点击ResizeHandle",{elementId:J.elementId,direction:J.direction}),O(J,I);return}if(e()){P("调整大小操作进行中，跳过交互处理");return}const Y=q(I,M.ctrlKey);if(P("鼠标按下",{point:I,selectedElementId:Y,currentMode:r(),isCtrlClick:M.ctrlKey}),Y){const ie=n.getAllElements().find(ce=>ce.id===Y);ie&&V(ie,I,M)}else B(I)},O=(M,I,J)=>{const Y=n.getAllElements().find(ie=>ie.id===M.elementId);Y&&(P("开始resize操作",{elementId:M.elementId,direction:M.direction}),t(!0),$({elementId:M.elementId,handlePosition:M.direction,startPoint:I,initialSize:{width:Y.size.width,height:Y.size.height},initialPosition:{x:Y.position.x,y:Y.position.y},cursor:M.cursor}),w(M.cursor),P("resize状态已设置",y()))},V=(M,I,J)=>{const Y=l().includes(M.id),ie=l(),ce=!!v();P("元素点击",{elementId:M.id,isSelected:Y,currentlySelected:ie,ctrlKey:J.ctrlKey,shiftKey:J.shiftKey,hasOverlapContext:ce}),J.ctrlKey&&!ce?H(M.id):J.shiftKey&&l().length>0?j(M.id):Y?(P("点击已选中元素，准备拖拽",{selectedCount:ie.length}),me(ie,I)):de(M.id,I)},B=(M,I)=>{P("开始框选",{point:M}),o([]),n.onElementsSelect?.([]),m(),a(tt.SELECTING),w("crosshair"),g({startPoint:M,currentPoint:M,selectedIds:[]})},H=M=>{const I=l(),J=I.includes(M)?I.filter(Y=>Y!==M):[...I,M];P("切换选择",{elementId:M,newSelection:J}),o(J),n.onElementsSelect?.(J)},j=M=>{const I=l();if(!I.includes(M)){const J=[...I,M];P("添加到选择",{elementId:M,newSelection:J}),o(J),n.onElementsSelect?.(J)}},de=(M,I,J)=>{P("选择并准备拖拽",{elementId:M,point:I}),o([M]),n.onElementsSelect?.([M]),me([M],I)},me=(M,I,J)=>{P("准备拖拽操作",{elementIds:M,startPoint:I});const Y=n.getAllElements(),ie=new Map;M.forEach(ce=>{const ae=Y.find(Ce=>Ce.id===ce);ae&&ie.set(ce,{x:ae.position.x,y:ae.position.y})}),d({elementIds:M,startPoint:I,startPositions:ie,currentOffset:{x:0,y:0},isDragging:!1})},fe=M=>{const I=c();if(!I)return;const J=Math.sqrt(Math.pow(M.x-I.startPoint.x,2)+Math.pow(M.y-I.startPoint.y,2));J>i.dragThreshold&&(P("开始拖拽",{distance:J,threshold:i.dragThreshold}),a(tt.DRAGGING),w("grabbing"),d({...I,isDragging:!0}))};let ee=!1,oe=0;const ge=(M,I=!1)=>{if(I){M();return}Date.now()-oe>=i.updateThrottle&&!ee&&(ee=!0,requestAnimationFrame(()=>{M(),ee=!1,oe=Date.now()}))},he=M=>{const I=c();if(!I)return;const J={x:M.x-I.startPoint.x,y:M.y-I.startPoint.y};d({...I,currentOffset:J}),ge(()=>{if(n.onBatchUpdatePositions&&I.elementIds.length>1){const Y=I.elementIds.map(ie=>{const ce=I.startPositions.get(ie);return ce?{element_id:ie,new_position:{x:ce.x+J.x,y:ce.y+J.y}}:null}).filter(Boolean);Y.length>0&&n.onBatchUpdatePositions(Y).catch(()=>{})}else if(n.onElementMove){const Y=I.elementIds.map(ie=>{const ce=I.startPositions.get(ie);if(ce)return n.onElementMove(ie,{x:ce.x+J.x,y:ce.y+J.y})}).filter(Boolean);Promise.allSettled(Y).catch(()=>{})}})},te=M=>{const I=u();if(!I)return;const J={...I,currentPoint:M};g(J);const Y={x:Math.min(I.startPoint.x,M.x),y:Math.min(I.startPoint.y,M.y),width:Math.abs(M.x-I.startPoint.x),height:Math.abs(M.y-I.startPoint.y)},ce=k(Y).map(ae=>ae.id);g({...J,selectedIds:ce}),o(ce)},ne=M=>{const I=y();if(!I)return;const J=M.x-I.startPoint.x,Y=M.y-I.startPoint.y,ie=ve(I.handlePosition,J,Y,I.initialSize,I.initialPosition);ge(()=>{n.onElementResize&&n.onElementResize(I.elementId,ie.size,ie.position)})},ve=(M,I,J,Y,ie)=>{let ce=Y.width,ae=Y.height,Ce=ie.x,Ie=ie.y;switch(M){case"nw":ce=Y.width-I,ae=Y.height-J,Ce=ie.x+I,Ie=ie.y+J;break;case"ne":ce=Y.width+I,ae=Y.height-J,Ie=ie.y+J;break;case"sw":ce=Y.width-I,ae=Y.height+J,Ce=ie.x+I;break;case"se":ce=Y.width+I,ae=Y.height+J;break;case"n":ae=Y.height-J,Ie=ie.y+J;break;case"s":ae=Y.height+J;break;case"w":ce=Y.width-I,Ce=ie.x+I;break;case"e":ce=Y.width+I;break}const Te=10;return ce=Math.max(Te,ce),ae=Math.max(Te,ae),{size:{width:ce,height:ae},position:{x:Ce,y:Ie}}},be=()=>{const M=r();if(P("鼠标释放",{currentMode:M,hasResizeState:!!y()}),y()){Pe();return}M===tt.DRAGGING?ke():M===tt.SELECTING&&_e(),ue()},ke=()=>{const M=c();if(!M||!M.isDragging&&M.currentOffset.x===0&&M.currentOffset.y===0){P("拖拽完成，无实际移动");return}if(n.onBatchUpdatePositions&&M.elementIds.length>1){const I=M.elementIds.map(J=>{const Y=M.startPositions.get(J);return Y?{element_id:J,new_position:{x:Y.x+M.currentOffset.x,y:Y.y+M.currentOffset.y}}:null}).filter(Boolean);I.length>0&&(P("拖拽完成 - 批量更新",{elementCount:I.length}),n.onBatchUpdatePositions(I).catch(J=>{console.warn("批量更新最终位置失败:",J)}))}},_e=()=>{const M=u();M&&(P("框选完成",{selectedCount:M.selectedIds.length}),n.onElementsSelect&&n.onElementsSelect(M.selectedIds))},Pe=()=>{const M=y();M&&(P("完成resize操作",{elementId:M.elementId}),t(!1),$(null))},ue=()=>{a(tt.IDLE),w("default"),d(null),g(null),$(null),t(!1),m(),P("状态重置完成")};Qe(async()=>{document.addEventListener("mousemove",A),document.addEventListener("mouseup",be),P("修复版交互层已初始化")}),dt(()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",be),P("修复版交互层已清理")});const xe=()=>{const M=u();if(!M||r()!==tt.SELECTING)return null;const{startPoint:I,currentPoint:J}=M;return{x:Math.min(I.x,J.x),y:Math.min(I.y,J.y),width:Math.abs(J.x-I.x),height:Math.abs(J.y-I.y)}};return(()=>{var M=ro();M.$$mousedown=G;var I=s;return typeof I=="function"?Qt(I,M):s=M,M.style.setProperty("position","absolute"),M.style.setProperty("top","0"),M.style.setProperty("left","0"),M.style.setProperty("width","100%"),M.style.setProperty("height","100%"),M.style.setProperty("z-index","10"),M.style.setProperty("pointer-events","all"),M.style.setProperty("background","transparent"),M.style.setProperty("user-select","none"),f(M,(()=>{var J=$e(()=>!!xe());return()=>J()&&(()=>{var Y=ao();return Y.style.setProperty("position","absolute"),Y.style.setProperty("border","1px dashed #007acc"),Y.style.setProperty("background","rgba(0, 122, 204, 0.1)"),Y.style.setProperty("pointer-events","none"),F(ie=>{var ce=`${xe().x}px`,ae=`${xe().y}px`,Ce=`${xe().width}px`,Ie=`${xe().height}px`;return ce!==ie.e&&((ie.e=ce)!=null?Y.style.setProperty("left",ce):Y.style.removeProperty("left")),ae!==ie.t&&((ie.t=ae)!=null?Y.style.setProperty("top",ae):Y.style.removeProperty("top")),Ce!==ie.a&&((ie.a=Ce)!=null?Y.style.setProperty("width",Ce):Y.style.removeProperty("width")),Ie!==ie.o&&((ie.o=Ie)!=null?Y.style.setProperty("height",Ie):Y.style.removeProperty("height")),ie},{e:void 0,t:void 0,a:void 0,o:void 0}),Y})()})(),null),f(M,(()=>{var J=$e(()=>!!n.enableDebugMode);return()=>J()&&(()=>{var Y=lo(),ie=Y.firstChild,ce=ie.nextSibling;ce.firstChild;var ae=ce.nextSibling;ae.firstChild;var Ce=ae.nextSibling;return Ce.firstChild,Y.style.setProperty("position","fixed"),Y.style.setProperty("top","10px"),Y.style.setProperty("right","10px"),Y.style.setProperty("padding","8px"),Y.style.setProperty("background","rgba(0, 0, 0, 0.8)"),Y.style.setProperty("color","white"),Y.style.setProperty("font-family","monospace"),Y.style.setProperty("font-size","12px"),Y.style.setProperty("border-radius","4px"),Y.style.setProperty("z-index","9999"),Y.style.setProperty("pointer-events","none"),f(ce,r,null),f(ae,()=>l().length,null),f(Ce,x,null),f(Y,(()=>{var Ie=$e(()=>!!c()?.isDragging);return()=>Ie()&&(()=>{var Te=oo(),Ye=Te.firstChild,We=Ye.nextSibling;return We.nextSibling,Te.style.setProperty("color","#ffeb3b"),f(Te,()=>c()?.elementIds.length,We),Te})()})(),null),f(Y,(()=>{var Ie=$e(()=>l().length>0);return()=>Ie()&&(()=>{var Te=co(),Ye=Te.firstChild,We=Ye.nextSibling;return We.nextSibling,Te.style.setProperty("font-size","10px"),Te.style.setProperty("color","#ccc"),f(Te,()=>l().slice(0,3).join(", "),We),f(Te,()=>l().length>3&&"...",We),Te})()})(),null),Y})()})(),null),M})()};Ue(["mousedown"]);var ho=S("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),uo=S("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),go=S('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),fo=S('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const vo=(n,e)=>{if(n.length<2)return[];const t=n.map(i=>({x:i.position.x,y:i.position.y,width:i.size.width,height:i.size.height}));return t.map((i,s)=>{let r=i.x,a=i.y;switch(e){case"left":r=Math.min(...t.map(u=>u.x));break;case"right":r=Math.max(...t.map(u=>u.x+u.width))-i.width;break;case"top":a=Math.min(...t.map(u=>u.y));break;case"bottom":a=Math.max(...t.map(u=>u.y+u.height))-i.height;break;case"h_center":r=t.reduce((u,g)=>u+g.x+g.width/2,0)/t.length-i.width/2;break;case"v_center":a=t.reduce((u,g)=>u+g.y+g.height/2,0)/t.length-i.height/2;break}return{element_id:n[s].id,new_position:{x:r,y:a}}})},ar=n=>{const{batchUpdatePositions:e,state:t}=st(),[i,s]=K(!1),r=()=>n.selectedElementIds().length>=2,a=()=>{const d=n.selectedElementIds();return t.elements.filter(u=>d.includes(u.id))},l=async d=>{const u=a();if(u.length<2){console.warn("对齐功能需要至少2个元素");return}try{s(!0),console.log(`🎯 执行${d}对齐:`,u.length,"个元素");const g=vo(u,d);await e(g),console.log("✅ 对齐操作完成"),n.onAlignmentComplete&&n.onAlignmentComplete(g)}catch(g){console.error("❌ 对齐操作失败:",g)}finally{s(!1)}},o=()=>a().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>o();return(()=>{var d=fo(),u=d.firstChild,g=u.firstChild,v=g.nextSibling,h=v.firstChild,p=h.nextSibling,b=p.nextSibling,m=u.nextSibling,y=m.firstChild,$=y.nextSibling,x=$.firstChild,w=x.nextSibling,P=w.nextSibling,L=m.nextSibling,D=L.firstChild,z=D.nextSibling,E=z.firstChild,R=E.nextSibling;return h.$$click=()=>l("left"),p.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("h_center")),p.$$click=()=>l("h_center"),b.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("right")),b.$$click=()=>l("right"),x.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("top")),x.$$click=()=>l("top"),w.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("v_center")),w.$$click=()=>l("v_center"),P.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("bottom")),P.$$click=()=>l("bottom"),E.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("distribute_h")),E.$$click=()=>l("distribute_h"),R.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("distribute_v")),R.$$click=()=>l("distribute_v"),f(d,_(W,{get when(){return $e(()=>!!r())()&&c()},get children(){var k=ho(),q=k.firstChild,N=q.nextSibling,C=N.firstChild,A=C.nextSibling,X=N.nextSibling;return N.$$click=()=>l(c().recommended),f(A,()=>c().recommended==="left"&&"左对齐",null),f(A,()=>c().recommended==="right"&&"右对齐",null),f(A,()=>c().recommended==="top"&&"顶对齐",null),f(A,()=>c().recommended==="bottom"&&"底对齐",null),f(A,()=>c().recommended==="h_center"&&"水平居中",null),f(A,()=>c().recommended==="v_center"&&"垂直居中",null),f(X,()=>c().reason),F(G=>{var O=i(),V=c().reason;return O!==G.e&&(N.disabled=G.e=O),V!==G.t&&Q(N,"title",G.t=V),G},{e:void 0,t:void 0}),k}}),null),f(d,_(W,{get when(){return!r()},get children(){var k=uo(),q=k.firstChild;return q.firstChild,f(q,()=>n.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),k}}),null),f(d,_(W,{get when(){return i()},get children(){return go()}}),null),F(k=>{var q=!r()||i(),N=!r()||i(),C=!r()||i(),A=!r()||i(),X=!r()||i(),G=!r()||i(),O=n.selectedElementIds().length<3||i(),V=n.selectedElementIds().length<3||i();return q!==k.e&&(h.disabled=k.e=q),N!==k.t&&(p.disabled=k.t=N),C!==k.a&&(b.disabled=k.a=C),A!==k.o&&(x.disabled=k.o=A),X!==k.i&&(w.disabled=k.i=X),G!==k.n&&(P.disabled=k.n=G),O!==k.s&&(E.disabled=k.s=O),V!==k.h&&(R.disabled=k.h=V),k},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d})()},po=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const n=document.createElement("style");n.textContent=po,document.head.appendChild(n)}Ue(["click"]);var mo=S("<div>"),bo=S('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),yo=S("<span class=ml-2>Zoom: <!>%");const _o=()=>{const{state:n,selectElement:e,clearSelection:t,createElement:i,selectMultiple:s,updateElement:r,batchUpdatePositions:a}=st();let l;const[o,c]=K([]),d=Me(()=>n.elements.filter($=>$.visible)),u=($,x)=>{if(!l)return{x:0,y:0};const w=l.getBoundingClientRect(),P=($-w.left)/n.canvas_config.zoom,L=(x-w.top)/n.canvas_config.zoom;return{x:P,y:L}},g=async $=>{console.log("🎯 选择元素",$),c([...$]);try{$.length===0?await t():$.length===1?await e($[0]):await s([...$])}catch(x){console.error("❌ 选择元素失败:",x)}},v=async $=>{try{await a($)}catch(x){console.error("❌ 批量更新位置失败:",x)}},h=async($,x)=>{try{await r($,{position:{x:x.x,y:x.y}})}catch(w){console.error("❌ 移动元素失败:",w)}},p=async($,x,w)=>{try{await r($,{size:x,position:w})}catch(P){console.error("❌ 调整大小失败:",P)}},b=async $=>{console.log("🖱️ 画布点击",$)},m=async $=>{$.preventDefault();try{const x=$.dataTransfer?.getData("application/json");if(!x)return;const{type:w,component:P}=JSON.parse(x);if(w==="component"){const{x:L,y:D}=u($.clientX,$.clientY),z=Math.max(0,L-P.default_size.width/2),E=Math.max(0,D-P.default_size.height/2);console.log("🎯 通过拖放创建组件:",P.name,"at",z,E);const R=await i(P.id,{x:z,y:E},P.default_size,P.create_content());console.log("✅ 通过拖放创建元素成功:",R),c([R]),await e(R)}}catch(x){console.error("拖放处理失败:",x)}};Qe(()=>{c([...n.selected_ids])}),Me(()=>{c([...n.selected_ids])});const y=Me(()=>{const{width:$,height:x}=n.canvas_config;return`0 0 ${$} ${x}`});return(()=>{var $=bo(),x=$.firstChild,w=x.firstChild,P=w.firstChild,L=P.nextSibling,D=L.nextSibling,z=D.nextSibling,E=z.nextSibling,R=E.nextSibling,k=R.firstChild,q=k.nextSibling;q.nextSibling;var N=x.nextSibling,C=N.firstChild,A=C.firstChild,X=A.firstChild,G=X.firstChild,O=G.nextSibling,V=O.nextSibling,B=V.nextSibling;f(w,()=>n.canvas_config.width,L),f(w,()=>n.canvas_config.height,z),f(w,(()=>{var j=$e(()=>n.canvas_config.zoom!==1);return()=>j()&&(()=>{var de=yo(),me=de.firstChild,fe=me.nextSibling;return fe.nextSibling,f(de,()=>Math.round(n.canvas_config.zoom*100),fe),de})()})(),R),f(R,()=>n.elements.length,q),f(R,()=>o().length,null),A.style.setProperty("position","relative"),X.addEventListener("drop",m),X.addEventListener("dragover",j=>{j.preventDefault(),j.dataTransfer.dropEffect="copy"}),X.$$contextmenu=j=>j.preventDefault();var H=l;return typeof H=="function"?Qt(H,X):l=X,f(X,_(zl,{get config(){return n.canvas_config}}),O),f(V,_(pe,{get each(){return d()},children:j=>_(eo,{element:j,get selected(){return o().includes(j.id)}})})),f(B,_(pe,{get each(){return d().filter(j=>o().includes(j.id))},children:j=>_(io,{element:j})})),f(A,_(rr,{canvasRef:l,getAllElements:()=>[...n.elements],onElementsSelect:g,onElementMove:h,onBatchUpdatePositions:v,onElementResize:p,onCanvasClick:b,get enableDebugMode(){return!1}}),null),f(A,_(W,{get when(){return o().length>=2},get children(){var j=mo();return j.style.setProperty("position","fixed"),j.style.setProperty("top","80px"),j.style.setProperty("right","20px"),j.style.setProperty("z-index","1000"),j.style.setProperty("background","white"),j.style.setProperty("border-radius","8px"),j.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),j.style.setProperty("border","1px solid #e5e7eb"),f(j,_(ar,{selectedElementIds:o,onAlignmentComplete:de=>{console.log("✅ 对齐操作完成:",de)},onAlignmentPreview:de=>{console.log("👁️ 对齐预览:",de)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),j}}),null),F(j=>{var de=n.canvas_config.width*n.canvas_config.zoom,me=n.canvas_config.height*n.canvas_config.zoom,fe=y(),ee=n.canvas_config.width,oe=n.canvas_config.height,ge=n.canvas_config.background_color,he=n.canvas_config.width,te=n.canvas_config.height;return de!==j.e&&Q(X,"width",j.e=de),me!==j.t&&Q(X,"height",j.t=me),fe!==j.a&&Q(X,"viewBox",j.a=fe),ee!==j.o&&Q(G,"width",j.o=ee),oe!==j.i&&Q(G,"height",j.i=oe),ge!==j.n&&Q(G,"fill",j.n=ge),he!==j.s&&Q(O,"width",j.s=he),te!==j.h&&Q(O,"height",j.h=te),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),$})()};Ue(["contextmenu"]);class xo{ck;surface;canvas;fontManager;elementCache=new Map;imageCache=new Map;constructor(e,t){if(this.ck=e,this.surface=e.MakeWebGLCanvasSurface(t),this.surface||(console.warn("WebGL not available, falling back to CPU rendering"),this.surface=e.MakeSWCanvasSurface(t)),!this.surface)throw new Error("Failed to create Skia surface");this.canvas=this.surface.getCanvas(),this.fontManager=e.FontMgr?.RefDefault?.()||e.FontMgr?.RefEmpty?.()}render(e,t={}){const i=this.parseColor(t.background||"#ffffff");this.canvas.clear(i),t.viewport&&this.applyViewport(t.viewport),t.showGrid&&this.renderGrid(t.gridSize||20);for(const s of e)s.visible&&this.renderElement(s);t.overlays&&this.renderOverlays(t.overlays),this.surface?.flush()}renderElement(e){switch(this.canvas.save(),e.transform&&this.applyTransform(e.transform),e.style.opacity!==void 0&&e.style.opacity<1&&(this.canvas.saveLayerAlpha?.(null,e.style.opacity*255)||this.canvas.saveLayer(null,this.createOpacityPaint(e.style.opacity))),e.type){case"text":this.renderText(e);break;case"rect":this.renderRect(e);break;case"circle":this.renderCircle(e);break;case"path":this.renderPath(e);break;case"image":this.renderImage(e);break;case"group":this.renderGroup(e);break}e.style.opacity!==void 0&&e.style.opacity<1&&this.canvas.restore(),this.canvas.restore()}renderText(e){const{content:t,fontSize:i=14,fontFamily:s="Arial",color:r="#000000"}=e.data;if(!t)return;const a=new this.ck.Paint;a.setColor(this.parseColor(r)),a.setAntiAlias(!0);const l=this.fontManager.matchFamilyStyle(s,this.ck.FontStyle?.Normal||0),o=new this.ck.Font(l,i);if(!t.includes(`
`))this.canvas.drawText(t,0,i,a,o);else{const c=t.split(`
`);let d=i;for(const u of c)this.canvas.drawText(u,0,d,a,o),d+=i*1.2}a.delete(),o.delete()}renderRect(e){const t=new this.ck.Paint;t.setAntiAlias(!0);const i=this.ck.LTRBRect(0,0,e.style.width||100,e.style.height||100);e.style.fill&&(t.setStyle(this.ck.PaintStyle.Fill),t.setColor(this.parseColor(e.style.fill)),this.canvas.drawRect(i,t)),e.style.stroke&&(t.setStyle(this.ck.PaintStyle.Stroke),t.setColor(this.parseColor(e.style.stroke)),t.setStrokeWidth(e.style.strokeWidth||1),this.canvas.drawRect(i,t)),t.delete()}renderCircle(e){const t=new this.ck.Paint;t.setAntiAlias(!0);const i=Math.min((e.style.width||100)/2,(e.style.height||100)/2),s=(e.style.width||100)/2,r=(e.style.height||100)/2;e.style.fill&&(t.setStyle(this.ck.PaintStyle.Fill),t.setColor(this.parseColor(e.style.fill)),this.canvas.drawCircle(s,r,i,t)),e.style.stroke&&(t.setStyle(this.ck.PaintStyle.Stroke),t.setColor(this.parseColor(e.style.stroke)),t.setStrokeWidth(e.style.strokeWidth||1),this.canvas.drawCircle(s,r,i,t)),t.delete()}renderPath(e){const t=new this.ck.Path,i=e.data.commands||[];for(const r of i)switch(r.type){case"M":t.moveTo(r.x,r.y);break;case"L":t.lineTo(r.x,r.y);break;case"Q":t.quadTo(r.x1,r.y1,r.x,r.y);break;case"C":t.cubicTo(r.x1,r.y1,r.x2,r.y2,r.x,r.y);break;case"Z":t.close();break}const s=new this.ck.Paint;s.setAntiAlias(!0),e.style.fill&&(s.setStyle(this.ck.PaintStyle.Fill),s.setColor(this.parseColor(e.style.fill)),this.canvas.drawPath(t,s)),e.style.stroke&&(s.setStyle(this.ck.PaintStyle.Stroke),s.setColor(this.parseColor(e.style.stroke)),s.setStrokeWidth(e.style.strokeWidth||1),this.canvas.drawPath(t,s)),t.delete(),s.delete()}async renderImage(e){const{src:t}=e.data;if(!t)return;let i=this.imageCache.get(t);if(!i)try{const o=await(await fetch(t)).arrayBuffer();i=this.ck.MakeImageFromEncoded(new Uint8Array(o)),i&&this.imageCache.set(t,i)}catch(l){console.error("Failed to load image:",t,l);return}if(!i)return;const s=new this.ck.Paint,r=this.ck.LTRBRect(0,0,i.width(),i.height()),a=this.ck.LTRBRect(0,0,e.style.width||100,e.style.height||100);this.canvas.drawImageRect(i,r,a,s),s.delete()}renderGroup(e){if(e.children)for(const t of e.children)t.visible&&this.renderElement(t)}renderGrid(e){const t=new this.ck.Paint;t.setStyle(this.ck.PaintStyle.Stroke),t.setColor(this.parseColor("#e0e0e0")),t.setStrokeWidth(.5),t.setAntiAlias(!0);const i=this.surface?.width()||1200,s=this.surface?.height()||800;for(let r=0;r<=i;r+=e){const a=new this.ck.Path;a.moveTo(r,0),a.lineTo(r,s),this.canvas.drawPath(a,t),a.delete()}for(let r=0;r<=s;r+=e){const a=new this.ck.Path;a.moveTo(0,r),a.lineTo(i,r),this.canvas.drawPath(a,t),a.delete()}t.delete()}renderOverlays(e){for(const t of e)switch(t.type){case"selection":this.renderSelectionOverlay(t);break;case"grid":this.renderGridOverlay(t);break;case"ruler":this.renderRulerOverlay(t);break}}renderSelectionOverlay(e){const t=new this.ck.Paint;t.setStyle(this.ck.PaintStyle.Stroke),t.setColor(this.parseColor("#0080ff")),t.setStrokeWidth(2);const i=this.ck.PathEffect.MakeDash([5,5],0);t.setPathEffect(i);const s=this.ck.LTRBRect(e.data.x,e.data.y,e.data.x+e.data.width,e.data.y+e.data.height);this.canvas.drawRect(s,t),t.setPathEffect(null),t.setStyle(this.ck.PaintStyle.Fill),t.setColor(this.parseColor("#ffffff"));const r=this.getResizeHandles(e.data);for(const a of r)this.canvas.drawCircle(a.x,a.y,4,t);t.delete()}renderGridOverlay(e){const t=new this.ck.Paint;t.setStyle(this.ck.PaintStyle.Stroke),t.setColor(this.ck.Color4f(0,0,0,.1)),t.setStrokeWidth(.5);const{width:i,height:s,gridSize:r=10}=e.data;for(let a=0;a<=i;a+=r)this.canvas.drawLine(a,0,a,s,t);for(let a=0;a<=s;a+=r)this.canvas.drawLine(0,a,i,a,t);t.delete()}renderRulerOverlay(e){}parseColor(e){if(e.startsWith("#")){const t=e.replace("#",""),i=parseInt(t.substr(0,2),16)/255,s=parseInt(t.substr(2,2),16)/255,r=parseInt(t.substr(4,2),16)/255,a=t.length>6?parseInt(t.substr(6,2),16)/255:1;return this.ck.Color4f(i,s,r,a)}return this.ck.Color4f(0,0,0,1)}createOpacityPaint(e){const t=new this.ck.Paint;return t.setAlphaf(e),t}applyTransform(e){if(e.translate&&this.canvas.translate(e.translate.x,e.translate.y),e.scale&&this.canvas.scale(e.scale.x,e.scale.y),e.rotate){const t=e.origin||{x:0,y:0};this.canvas.rotate(e.rotate,t.x,t.y)}}applyViewport(e){this.canvas.save(),this.canvas.translate(-e.x,-e.y),this.canvas.scale(e.zoom,e.zoom)}getResizeHandles(e){const{x:t,y:i,width:s,height:r}=e;return[{x:t,y:i},{x:t+s/2,y:i},{x:t+s,y:i},{x:t+s,y:i+r/2},{x:t+s,y:i+r},{x:t+s/2,y:i+r},{x:t,y:i+r},{x:t,y:i+r/2}]}async exportToPNG(){if(!this.surface)return null;const e=this.surface.makeImageSnapshot(),t=e.encodeToBytes();return e.delete(),t}dispose(){this.elementCache.clear(),this.imageCache.forEach(e=>e?.delete()),this.imageCache.clear(),this.surface?.delete()}}var So=S("<div class=skia-canvas-container><canvas>"),wo=S("<div>Loading Canvas..."),$o=S("<div>Error: ");const Co=n=>{let e,t=null,i=null;const[s,r]=K(!0),[a,l]=K("");let o=!1,c={x:0,y:0},d=null;Qe(async()=>{try{const h=(await Ks(async()=>{const{default:p}=await import("./canvaskit-CtG2eLFJ.js").then(b=>b.c);return{default:p}},[])).default;if(i=await h({locateFile:p=>`/canvaskit/${p}`}),e)t=new xo(i,e);else throw new Error("Canvas ref not found");n.onReady?.(t),t.render(n.elements||[],n.options),r(!1),n.mode==="design"&&u()}catch(h){console.error("Failed to initialize SkiaCanvas:",h),l(h?.toString()||"Failed to initialize canvas"),r(!1)}}),Vt(()=>{if(t&&!s())try{t.render(n.elements||[],n.options)}catch(h){console.error("Render error:",h)}});const u=()=>{e&&(e.addEventListener("mousedown",h=>{const p=e.getBoundingClientRect(),b=h.clientX-p.left,m=h.clientY-p.top,y=g(b,m);y&&(d=y.id,o=!0,c={x:h.clientX,y:h.clientY},n.onElementClick?.(y.id))}),e.addEventListener("mousemove",h=>{if(o&&d){const p={x:h.clientX-c.x,y:h.clientY-c.y};c={x:h.clientX,y:h.clientY},n.onElementDrag?.(d,p)}}),e.addEventListener("mouseup",()=>{o=!1}),e.addEventListener("mouseleave",()=>{o=!1}))},g=(h,p)=>{if(!n.elements)return null;for(let b=n.elements.length-1;b>=0;b--){const m=n.elements[b];if(!m||!m.visible||m.locked)continue;const y=v(m);if(h>=y.x&&h<=y.x+y.width&&p>=y.y&&p<=y.y+y.height)return m}return null},v=h=>{const p=h.transform?.translate?.x||0,b=h.transform?.translate?.y||0,m=h.style?.width||100,y=h.style?.height||100;return{x:p,y:b,width:m,height:y}};return dt(()=>{t?.dispose()}),(()=>{var h=So(),p=h.firstChild;h.style.setProperty("position","relative"),h.style.setProperty("width","100%"),h.style.setProperty("height","100%"),f(h,(()=>{var m=$e(()=>!!s());return()=>m()&&(()=>{var y=wo();return y.style.setProperty("position","absolute"),y.style.setProperty("top","50%"),y.style.setProperty("left","50%"),y.style.setProperty("transform","translate(-50%, -50%)"),y.style.setProperty("color","#666"),y})()})(),p),f(h,(()=>{var m=$e(()=>!!a());return()=>m()&&(()=>{var y=$o();return y.firstChild,y.style.setProperty("position","absolute"),y.style.setProperty("top","50%"),y.style.setProperty("left","50%"),y.style.setProperty("transform","translate(-50%, -50%)"),y.style.setProperty("color","red"),f(y,a,null),y})()})(),p);var b=e;return typeof b=="function"?Qt(b,p):e=p,p.style.setProperty("width","100%"),p.style.setProperty("height","100%"),F(m=>{var y=n.width||1200,$=n.height||800,x=s()?"none":"block",w=n.mode==="design"?"default":"auto";return y!==m.e&&Q(p,"width",m.e=y),$!==m.t&&Q(p,"height",m.t=$),x!==m.a&&((m.a=x)!=null?p.style.setProperty("display",x):p.style.removeProperty("display")),w!==m.o&&((m.o=w)!=null?p.style.setProperty("cursor",w):p.style.removeProperty("cursor")),m},{e:void 0,t:void 0,a:void 0,o:void 0}),h})()};var ko=S('<div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-20">'),To=S('<div class="flex-1 relative overflow-hidden bg-tertiary"><div class="absolute inset-0"></div><div class="absolute inset-0 pointer-events-none">');const Eo=()=>{const{state:n,selectElement:e,clearSelection:t,selectMultiple:i,updateElement:s,batchUpdatePositions:r}=st(),{state:a}=_n(),[l,o]=K([]),[c,d]=K({width:800,height:600});let u;Qe(()=>{const x=()=>{if(u){const w=u.getBoundingClientRect();d({width:w.width,height:w.height})}};x(),window.addEventListener("resize",x),dt(()=>{window.removeEventListener("resize",x)})});const g=x=>x.filter(w=>w.visible).map(w=>{const P={id:w.id,type:v(w.content.type),transform:{translate:{x:w.position.x,y:w.position.y},rotate:0,scale:{x:1,y:1}},style:{},data:{},visible:w.visible,locked:w.locked||!1};switch(w.content.type){case"Text":case"DataField":{const L=w.content.type==="Text"?w.content.content:w.content.type==="DataField"?w.content.expression:"";P.data={content:L,fontSize:w.content.style?.font_size||14,fontFamily:w.content.style?.font_family||"Arial",color:w.content.style?.color||"#000000",align:w.content.style?.align||"left"}}break;case"Rectangle":w.content.type==="Rectangle"&&(P.type="rect",P.style={width:w.size.width,height:w.size.height,fill:w.content.fill_color||"#ffffff",stroke:w.content.border?.color||"#000000",strokeWidth:w.content.border?.width||1});break;case"Line":w.content.type==="Line"&&(P.type="path",P.data={commands:[{type:"M",x:0,y:0},{type:"L",x:w.size.width,y:w.size.height}]},P.style={stroke:w.content.color||"#000000",strokeWidth:w.content.width||2,fill:"none"});break;case"Image":w.content.type==="Image"&&(P.data={src:w.content.src||"",width:w.size.width,height:w.size.height});break}return P}),v=x=>({Text:"text",DataField:"text",Rectangle:"rect",Line:"path",Image:"image"})[x]||"rect",h=async x=>{console.log("🎯 选择元素",x),o([...x]);try{x.length===0?await t():x.length===1?await e(x[0]):await i([...x])}catch(w){console.error("❌ 选择元素失败:",w)}},p=async x=>{try{await r(x)}catch(w){console.error("❌ 批量更新位置失败:",w)}},b=async(x,w)=>{try{await s(x,{position:{x:w.x,y:w.y}})}catch(P){console.error("❌ 移动元素失败:",P)}},m=async(x,w,P)=>{try{await s(x,{size:w,position:P})}catch(L){console.error("❌ 调整大小失败:",L)}},y=x=>{h([x])},$=(x,w)=>{const P=n.elements.find(L=>L.id===x);P&&b(x,{x:P.position.x+w.x,y:P.position.y+w.y})};return(()=>{var x=To(),w=x.firstChild,P=w.nextSibling,L=u;return typeof L=="function"?Qt(L,x):u=x,f(x,_(W,{get when(){return l().length>1},get children(){var D=ko();return f(D,_(ar,{selectedElementIds:l})),D}}),w),f(w,_(Co,{get elements(){return g(n.elements)},get mode(){return a().mode==="design"?"design":"preview"},get width(){return c().width},get height(){return c().height},onElementClick:y,onElementDrag:$,get options(){return{background:n.canvas_config.background_color||"#f5f5f5",showGrid:n.canvas_config.show_grid,gridSize:n.canvas_config.grid_size,viewport:{zoom:n.canvas_config.zoom,pan:{x:0,y:0}}}}})),f(P,_(rr,{getAllElements:()=>[...n.elements],onElementsSelect:h,onElementMove:b,onElementResize:m,onBatchUpdatePositions:p})),x})()},Po=Math.PI/180;function Ao(){return typeof window<"u"&&({}.toString.call(window)==="[object Window]"||{}.toString.call(window)==="[object global]")}const Lt=typeof global<"u"?global:typeof window<"u"?window:typeof WorkerGlobalScope<"u"?self:{},le={_global:Lt,version:"10.0.2",isBrowser:Ao(),isUnminified:/param/.test(function(n){}.toString()),dblClickWindow:400,getAngle(n){return le.angleDeg?n*Po:n},enableTrace:!1,pointerEventsEnabled:!0,autoDrawEnabled:!0,hitOnDragEnabled:!1,capturePointerEventsEnabled:!1,_mouseListenClick:!1,_touchListenClick:!1,_pointerListenClick:!1,_mouseInDblClickWindow:!1,_touchInDblClickWindow:!1,_pointerInDblClickWindow:!1,_mouseDblClickPointerId:null,_touchDblClickPointerId:null,_pointerDblClickPointerId:null,_renderBackend:"web",legacyTextRendering:!1,pixelRatio:typeof window<"u"&&window.devicePixelRatio||1,dragDistance:3,angleDeg:!0,showWarnings:!0,dragButtons:[0,1],isDragging(){return le.DD.isDragging},isTransforming(){var n,e;return(e=(n=le.Transformer)===null||n===void 0?void 0:n.isTransforming())!==null&&e!==void 0?e:!1},isDragReady(){return!!le.DD.node},releaseCanvasOnDestroy:!0,document:Lt.document,_injectGlobal(n){typeof Lt.Konva<"u"&&console.error("Severa Konva instances detected. It is not recommended to use multiple Konva instances in the same environment."),Lt.Konva=n}},Be=n=>{le[n.prototype.getClassName()]=n};le._injectGlobal(le);const Ro=`Konva.js unsupported environment.

Looks like you are trying to use Konva.js in Node.js environment. because "document" object is undefined.

To use Konva.js in Node.js environment, you need to use the "canvas-backend" or "skia-backend" module.

bash: npm install canvas
js: import "konva/canvas-backend";

or

bash: npm install skia-canvas
js: import "konva/skia-backend";
`,Ji=()=>{if(typeof document>"u")throw new Error(Ro)};class Ke{constructor(e=[1,0,0,1,0,0]){this.dirty=!1,this.m=e&&e.slice()||[1,0,0,1,0,0]}reset(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=1,this.m[4]=0,this.m[5]=0}copy(){return new Ke(this.m)}copyInto(e){e.m[0]=this.m[0],e.m[1]=this.m[1],e.m[2]=this.m[2],e.m[3]=this.m[3],e.m[4]=this.m[4],e.m[5]=this.m[5]}point(e){const t=this.m;return{x:t[0]*e.x+t[2]*e.y+t[4],y:t[1]*e.x+t[3]*e.y+t[5]}}translate(e,t){return this.m[4]+=this.m[0]*e+this.m[2]*t,this.m[5]+=this.m[1]*e+this.m[3]*t,this}scale(e,t){return this.m[0]*=e,this.m[1]*=e,this.m[2]*=t,this.m[3]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),s=this.m[0]*t+this.m[2]*i,r=this.m[1]*t+this.m[3]*i,a=this.m[0]*-i+this.m[2]*t,l=this.m[1]*-i+this.m[3]*t;return this.m[0]=s,this.m[1]=r,this.m[2]=a,this.m[3]=l,this}getTranslation(){return{x:this.m[4],y:this.m[5]}}skew(e,t){const i=this.m[0]+this.m[2]*t,s=this.m[1]+this.m[3]*t,r=this.m[2]+this.m[0]*e,a=this.m[3]+this.m[1]*e;return this.m[0]=i,this.m[1]=s,this.m[2]=r,this.m[3]=a,this}multiply(e){const t=this.m[0]*e.m[0]+this.m[2]*e.m[1],i=this.m[1]*e.m[0]+this.m[3]*e.m[1],s=this.m[0]*e.m[2]+this.m[2]*e.m[3],r=this.m[1]*e.m[2]+this.m[3]*e.m[3],a=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],l=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];return this.m[0]=t,this.m[1]=i,this.m[2]=s,this.m[3]=r,this.m[4]=a,this.m[5]=l,this}invert(){const e=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),t=this.m[3]*e,i=-this.m[1]*e,s=-this.m[2]*e,r=this.m[0]*e,a=e*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),l=e*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=t,this.m[1]=i,this.m[2]=s,this.m[3]=r,this.m[4]=a,this.m[5]=l,this}getMatrix(){return this.m}decompose(){const e=this.m[0],t=this.m[1],i=this.m[2],s=this.m[3],r=this.m[4],a=this.m[5],l=e*s-t*i,o={x:r,y:a,rotation:0,scaleX:0,scaleY:0,skewX:0,skewY:0};if(e!=0||t!=0){const c=Math.sqrt(e*e+t*t);o.rotation=t>0?Math.acos(e/c):-Math.acos(e/c),o.scaleX=c,o.scaleY=l/c,o.skewX=(e*i+t*s)/l,o.skewY=0}else if(i!=0||s!=0){const c=Math.sqrt(i*i+s*s);o.rotation=Math.PI/2-(s>0?Math.acos(-i/c):-Math.acos(i/c)),o.scaleX=l/c,o.scaleY=c,o.skewX=0,o.skewY=(e*i+t*s)/l}return o.rotation=U._getRotation(o.rotation),o}}const Lo="[object Array]",Mo="[object Number]",Do="[object String]",Oo="[object Boolean]",Io=Math.PI/180,No=180/Math.PI,ri="#",zo="",Fo="0",Go="Konva warning: ",Ki="Konva error: ",Bo="rgb(",ai={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},Uo=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;let $n=[];const Ho=typeof requestAnimationFrame<"u"&&requestAnimationFrame||function(n){setTimeout(n,60)},U={_isElement(n){return!!(n&&n.nodeType==1)},_isFunction(n){return!!(n&&n.constructor&&n.call&&n.apply)},_isPlainObject(n){return!!n&&n.constructor===Object},_isArray(n){return Object.prototype.toString.call(n)===Lo},_isNumber(n){return Object.prototype.toString.call(n)===Mo&&!isNaN(n)&&isFinite(n)},_isString(n){return Object.prototype.toString.call(n)===Do},_isBoolean(n){return Object.prototype.toString.call(n)===Oo},isObject(n){return n instanceof Object},isValidSelector(n){if(typeof n!="string")return!1;const e=n[0];return e==="#"||e==="."||e===e.toUpperCase()},_sign(n){return n===0||n>0?1:-1},requestAnimFrame(n){$n.push(n),$n.length===1&&Ho(function(){const e=$n;$n=[],e.forEach(function(t){t()})})},createCanvasElement(){Ji();const n=document.createElement("canvas");try{n.style=n.style||{}}catch{}return n},createImageElement(){return Ji(),document.createElement("img")},_isInDocument(n){for(;n=n.parentNode;)if(n==document)return!0;return!1},_urlToImage(n,e){const t=U.createImageElement();t.onload=function(){e(t)},t.src=n},_rgbToHex(n,e,t){return((1<<24)+(n<<16)+(e<<8)+t).toString(16).slice(1)},_hexToRgb(n){n=n.replace(ri,zo);const e=parseInt(n,16);return{r:e>>16&255,g:e>>8&255,b:e&255}},getRandomColor(){let n=(Math.random()*16777215<<0).toString(16);for(;n.length<6;)n=Fo+n;return ri+n},getRGB(n){let e;return n in ai?(e=ai[n],{r:e[0],g:e[1],b:e[2]}):n[0]===ri?this._hexToRgb(n.substring(1)):n.substr(0,4)===Bo?(e=Uo.exec(n.replace(/ /g,"")),{r:parseInt(e[1],10),g:parseInt(e[2],10),b:parseInt(e[3],10)}):{r:0,g:0,b:0}},colorToRGBA(n){return n=n||"black",U._namedColorToRBA(n)||U._hex3ColorToRGBA(n)||U._hex4ColorToRGBA(n)||U._hex6ColorToRGBA(n)||U._hex8ColorToRGBA(n)||U._rgbColorToRGBA(n)||U._rgbaColorToRGBA(n)||U._hslColorToRGBA(n)},_namedColorToRBA(n){const e=ai[n.toLowerCase()];return e?{r:e[0],g:e[1],b:e[2],a:1}:null},_rgbColorToRGBA(n){if(n.indexOf("rgb(")===0){n=n.match(/rgb\(([^)]+)\)/)[1];const e=n.split(/ *, */).map(Number);return{r:e[0],g:e[1],b:e[2],a:1}}},_rgbaColorToRGBA(n){if(n.indexOf("rgba(")===0){n=n.match(/rgba\(([^)]+)\)/)[1];const e=n.split(/ *, */).map((t,i)=>t.slice(-1)==="%"?i===3?parseInt(t)/100:parseInt(t)/100*255:Number(t));return{r:e[0],g:e[1],b:e[2],a:e[3]}}},_hex8ColorToRGBA(n){if(n[0]==="#"&&n.length===9)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:parseInt(n.slice(7,9),16)/255}},_hex6ColorToRGBA(n){if(n[0]==="#"&&n.length===7)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:1}},_hex4ColorToRGBA(n){if(n[0]==="#"&&n.length===5)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:parseInt(n[4]+n[4],16)/255}},_hex3ColorToRGBA(n){if(n[0]==="#"&&n.length===4)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:1}},_hslColorToRGBA(n){if(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.test(n)){const[e,...t]=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(n),i=Number(t[0])/360,s=Number(t[1])/100,r=Number(t[2])/100;let a,l,o;if(s===0)return o=r*255,{r:Math.round(o),g:Math.round(o),b:Math.round(o),a:1};r<.5?a=r*(1+s):a=r+s-r*s;const c=2*r-a,d=[0,0,0];for(let u=0;u<3;u++)l=i+1/3*-(u-1),l<0&&l++,l>1&&l--,6*l<1?o=c+(a-c)*6*l:2*l<1?o=a:3*l<2?o=c+(a-c)*(2/3-l)*6:o=c,d[u]=o*255;return{r:Math.round(d[0]),g:Math.round(d[1]),b:Math.round(d[2]),a:1}}},haveIntersection(n,e){return!(e.x>n.x+n.width||e.x+e.width<n.x||e.y>n.y+n.height||e.y+e.height<n.y)},cloneObject(n){const e={};for(const t in n)this._isPlainObject(n[t])?e[t]=this.cloneObject(n[t]):this._isArray(n[t])?e[t]=this.cloneArray(n[t]):e[t]=n[t];return e},cloneArray(n){return n.slice(0)},degToRad(n){return n*Io},radToDeg(n){return n*No},_degToRad(n){return U.warn("Util._degToRad is removed. Please use public Util.degToRad instead."),U.degToRad(n)},_radToDeg(n){return U.warn("Util._radToDeg is removed. Please use public Util.radToDeg instead."),U.radToDeg(n)},_getRotation(n){return le.angleDeg?U.radToDeg(n):n},_capitalize(n){return n.charAt(0).toUpperCase()+n.slice(1)},throw(n){throw new Error(Ki+n)},error(n){console.error(Ki+n)},warn(n){le.showWarnings&&console.warn(Go+n)},each(n,e){for(const t in n)e(t,n[t])},_inRange(n,e,t){return e<=n&&n<t},_getProjectionToSegment(n,e,t,i,s,r){let a,l,o;const c=(n-t)*(n-t)+(e-i)*(e-i);if(c==0)a=n,l=e,o=(s-t)*(s-t)+(r-i)*(r-i);else{const d=((s-n)*(t-n)+(r-e)*(i-e))/c;d<0?(a=n,l=e,o=(n-s)*(n-s)+(e-r)*(e-r)):d>1?(a=t,l=i,o=(t-s)*(t-s)+(i-r)*(i-r)):(a=n+d*(t-n),l=e+d*(i-e),o=(a-s)*(a-s)+(l-r)*(l-r))}return[a,l,o]},_getProjectionToLine(n,e,t){const i=U.cloneObject(n);let s=Number.MAX_VALUE;return e.forEach(function(r,a){if(!t&&a===e.length-1)return;const l=e[(a+1)%e.length],o=U._getProjectionToSegment(r.x,r.y,l.x,l.y,n.x,n.y),c=o[0],d=o[1],u=o[2];u<s&&(i.x=c,i.y=d,s=u)}),i},_prepareArrayForTween(n,e,t){const i=[],s=[];if(n.length>e.length){const a=e;e=n,n=a}for(let a=0;a<n.length;a+=2)i.push({x:n[a],y:n[a+1]});for(let a=0;a<e.length;a+=2)s.push({x:e[a],y:e[a+1]});const r=[];return s.forEach(function(a){const l=U._getProjectionToLine(a,i,t);r.push(l.x),r.push(l.y)}),r},_prepareToStringify(n){let e;n.visitedByCircularReferenceRemoval=!0;for(const t in n)if(n.hasOwnProperty(t)&&n[t]&&typeof n[t]=="object"){if(e=Object.getOwnPropertyDescriptor(n,t),n[t].visitedByCircularReferenceRemoval||U._isElement(n[t]))if(e.configurable)delete n[t];else return null;else if(U._prepareToStringify(n[t])===null)if(e.configurable)delete n[t];else return null}return delete n.visitedByCircularReferenceRemoval,n},_assign(n,e){for(const t in e)n[t]=e[t];return n},_getFirstPointerId(n){return n.touches?n.changedTouches[0].identifier:n.pointerId||999},releaseCanvas(...n){le.releaseCanvasOnDestroy&&n.forEach(e=>{e.width=0,e.height=0})},drawRoundedRectPath(n,e,t,i){let s=e<0?e:0,r=t<0?t:0;e=Math.abs(e),t=Math.abs(t);let a=0,l=0,o=0,c=0;typeof i=="number"?a=l=o=c=Math.min(i,e/2,t/2):(a=Math.min(i[0]||0,e/2,t/2),l=Math.min(i[1]||0,e/2,t/2),c=Math.min(i[2]||0,e/2,t/2),o=Math.min(i[3]||0,e/2,t/2)),n.moveTo(s+a,r),n.lineTo(s+e-l,r),n.arc(s+e-l,r+l,l,Math.PI*3/2,0,!1),n.lineTo(s+e,r+t-c),n.arc(s+e-c,r+t-c,c,0,Math.PI/2,!1),n.lineTo(s+o,r+t),n.arc(s+o,r+t-o,o,Math.PI/2,Math.PI,!1),n.lineTo(s,r+a),n.arc(s+a,r+a,a,Math.PI,Math.PI*3/2,!1)},drawRoundedPolygonPath(n,e,t,i,s){i=Math.abs(i);for(let r=0;r<t;r++){const a=e[(r-1+t)%t],l=e[r],o=e[(r+1)%t],c={x:l.x-a.x,y:l.y-a.y},d={x:o.x-l.x,y:o.y-l.y},u=Math.hypot(c.x,c.y),g=Math.hypot(d.x,d.y);let v;typeof s=="number"?v=s:v=r<s.length?s[r]:0,v=i*Math.cos(Math.PI/t)*Math.min(1,v/i*2);const p={x:c.x/u,y:c.y/u},b={x:d.x/g,y:d.y/g},m={x:l.x-p.x*v,y:l.y-p.y*v},y={x:l.x+b.x*v,y:l.y+b.y*v};r===0?n.moveTo(m.x,m.y):n.lineTo(m.x,m.y),n.arcTo(l.x,l.y,y.x,y.y,v)}}};function qo(n){const e=[],t=n.length,i=U;for(let s=0;s<t;s++){let r=n[s];i._isNumber(r)?r=Math.round(r*1e3)/1e3:i._isString(r)||(r=r+""),e.push(r)}return e}const Zi=",",Wo="(",jo=")",Yo="([",Vo="])",Xo=";",Qo="()",Jo="=",es=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","ellipse","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","roundRect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"],Ko=["fillStyle","strokeStyle","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","letterSpacing","lineCap","lineDashOffset","lineJoin","lineWidth","miterLimit","direction","font","textAlign","textBaseline","globalAlpha","globalCompositeOperation","imageSmoothingEnabled","filter"],Zo=100;let Cn=null;function ts(){if(Cn!==null)return Cn;try{const e=U.createCanvasElement().getContext("2d");return e?!!e&&"filter"in e:(Cn=!1,!1)}catch{return Cn=!1,!1}}class Qn{constructor(e){this.canvas=e,le.enableTrace&&(this.traceArr=[],this._enableTrace())}fillShape(e){e.fillEnabled()&&this._fill(e)}_fill(e){}strokeShape(e){e.hasStroke()&&this._stroke(e)}_stroke(e){}fillStrokeShape(e){e.attrs.fillAfterStrokeEnabled?(this.strokeShape(e),this.fillShape(e)):(this.fillShape(e),this.strokeShape(e))}getTrace(e,t){let i=this.traceArr,s=i.length,r="",a,l,o,c;for(a=0;a<s;a++)l=i[a],o=l.method,o?(c=l.args,r+=o,e?r+=Qo:U._isArray(c[0])?r+=Yo+c.join(Zi)+Vo:(t&&(c=c.map(d=>typeof d=="number"?Math.floor(d):d)),r+=Wo+c.join(Zi)+jo)):(r+=l.property,e||(r+=Jo+l.val)),r+=Xo;return r}clearTrace(){this.traceArr=[]}_trace(e){let t=this.traceArr,i;t.push(e),i=t.length,i>=Zo&&t.shift()}reset(){const e=this.getCanvas().getPixelRatio();this.setTransform(1*e,0,0,1*e,0,0)}getCanvas(){return this.canvas}clear(e){const t=this.getCanvas();e?this.clearRect(e.x||0,e.y||0,e.width||0,e.height||0):this.clearRect(0,0,t.getWidth()/t.pixelRatio,t.getHeight()/t.pixelRatio)}_applyLineCap(e){const t=e.attrs.lineCap;t&&this.setAttr("lineCap",t)}_applyOpacity(e){const t=e.getAbsoluteOpacity();t!==1&&this.setAttr("globalAlpha",t)}_applyLineJoin(e){const t=e.attrs.lineJoin;t&&this.setAttr("lineJoin",t)}_applyMiterLimit(e){const t=e.attrs.miterLimit;t!=null&&this.setAttr("miterLimit",t)}setAttr(e,t){this._context[e]=t}arc(e,t,i,s,r,a){this._context.arc(e,t,i,s,r,a)}arcTo(e,t,i,s,r){this._context.arcTo(e,t,i,s,r)}beginPath(){this._context.beginPath()}bezierCurveTo(e,t,i,s,r,a){this._context.bezierCurveTo(e,t,i,s,r,a)}clearRect(e,t,i,s){this._context.clearRect(e,t,i,s)}clip(...e){this._context.clip.apply(this._context,e)}closePath(){this._context.closePath()}createImageData(e,t){const i=arguments;if(i.length===2)return this._context.createImageData(e,t);if(i.length===1)return this._context.createImageData(e)}createLinearGradient(e,t,i,s){return this._context.createLinearGradient(e,t,i,s)}createPattern(e,t){return this._context.createPattern(e,t)}createRadialGradient(e,t,i,s,r,a){return this._context.createRadialGradient(e,t,i,s,r,a)}drawImage(e,t,i,s,r,a,l,o,c){const d=arguments,u=this._context;d.length===3?u.drawImage(e,t,i):d.length===5?u.drawImage(e,t,i,s,r):d.length===9&&u.drawImage(e,t,i,s,r,a,l,o,c)}ellipse(e,t,i,s,r,a,l,o){this._context.ellipse(e,t,i,s,r,a,l,o)}isPointInPath(e,t,i,s){return i?this._context.isPointInPath(i,e,t,s):this._context.isPointInPath(e,t,s)}fill(...e){this._context.fill.apply(this._context,e)}fillRect(e,t,i,s){this._context.fillRect(e,t,i,s)}strokeRect(e,t,i,s){this._context.strokeRect(e,t,i,s)}fillText(e,t,i,s){s?this._context.fillText(e,t,i,s):this._context.fillText(e,t,i)}measureText(e){return this._context.measureText(e)}getImageData(e,t,i,s){return this._context.getImageData(e,t,i,s)}lineTo(e,t){this._context.lineTo(e,t)}moveTo(e,t){this._context.moveTo(e,t)}rect(e,t,i,s){this._context.rect(e,t,i,s)}roundRect(e,t,i,s,r){this._context.roundRect(e,t,i,s,r)}putImageData(e,t,i){this._context.putImageData(e,t,i)}quadraticCurveTo(e,t,i,s){this._context.quadraticCurveTo(e,t,i,s)}restore(){this._context.restore()}rotate(e){this._context.rotate(e)}save(){this._context.save()}scale(e,t){this._context.scale(e,t)}setLineDash(e){this._context.setLineDash?this._context.setLineDash(e):"mozDash"in this._context?this._context.mozDash=e:"webkitLineDash"in this._context&&(this._context.webkitLineDash=e)}getLineDash(){return this._context.getLineDash()}setTransform(e,t,i,s,r,a){this._context.setTransform(e,t,i,s,r,a)}stroke(e){e?this._context.stroke(e):this._context.stroke()}strokeText(e,t,i,s){this._context.strokeText(e,t,i,s)}transform(e,t,i,s,r,a){this._context.transform(e,t,i,s,r,a)}translate(e,t){this._context.translate(e,t)}_enableTrace(){let e=this,t=es.length,i=this.setAttr,s,r;const a=function(l){let o=e[l],c;e[l]=function(){return r=qo(Array.prototype.slice.call(arguments,0)),c=o.apply(e,arguments),e._trace({method:l,args:r}),c}};for(s=0;s<t;s++)a(es[s]);e.setAttr=function(){i.apply(e,arguments);const l=arguments[0];let o=arguments[1];(l==="shadowOffsetX"||l==="shadowOffsetY"||l==="shadowBlur")&&(o=o/this.canvas.getPixelRatio()),e._trace({property:l,val:o})}}_applyGlobalCompositeOperation(e){const t=e.attrs.globalCompositeOperation;!t||t==="source-over"||this.setAttr("globalCompositeOperation",t)}}Ko.forEach(function(n){Object.defineProperty(Qn.prototype,n,{get(){return this._context[n]},set(e){this._context[n]=e}})});class ec extends Qn{constructor(e,{willReadFrequently:t=!1}={}){super(e),this._context=e._canvas.getContext("2d",{willReadFrequently:t})}_fillColor(e){const t=e.fill();this.setAttr("fillStyle",t),e._fillFunc(this)}_fillPattern(e){this.setAttr("fillStyle",e._getFillPattern()),e._fillFunc(this)}_fillLinearGradient(e){const t=e._getLinearGradient();t&&(this.setAttr("fillStyle",t),e._fillFunc(this))}_fillRadialGradient(e){const t=e._getRadialGradient();t&&(this.setAttr("fillStyle",t),e._fillFunc(this))}_fill(e){const t=e.fill(),i=e.getFillPriority();if(t&&i==="color"){this._fillColor(e);return}const s=e.getFillPatternImage();if(s&&i==="pattern"){this._fillPattern(e);return}const r=e.getFillLinearGradientColorStops();if(r&&i==="linear-gradient"){this._fillLinearGradient(e);return}const a=e.getFillRadialGradientColorStops();if(a&&i==="radial-gradient"){this._fillRadialGradient(e);return}t?this._fillColor(e):s?this._fillPattern(e):r?this._fillLinearGradient(e):a&&this._fillRadialGradient(e)}_strokeLinearGradient(e){const t=e.getStrokeLinearGradientStartPoint(),i=e.getStrokeLinearGradientEndPoint(),s=e.getStrokeLinearGradientColorStops(),r=this.createLinearGradient(t.x,t.y,i.x,i.y);if(s){for(let a=0;a<s.length;a+=2)r.addColorStop(s[a],s[a+1]);this.setAttr("strokeStyle",r)}}_stroke(e){const t=e.dash(),i=e.getStrokeScaleEnabled();if(e.hasStroke()){if(!i){this.save();const r=this.getCanvas().getPixelRatio();this.setTransform(r,0,0,r,0,0)}this._applyLineCap(e),t&&e.dashEnabled()&&(this.setLineDash(t),this.setAttr("lineDashOffset",e.dashOffset())),this.setAttr("lineWidth",e.strokeWidth()),e.getShadowForStrokeEnabled()||this.setAttr("shadowColor","rgba(0,0,0,0)"),e.getStrokeLinearGradientColorStops()?this._strokeLinearGradient(e):this.setAttr("strokeStyle",e.stroke()),e._strokeFunc(this),i||this.restore()}}_applyShadow(e){var t,i,s;const r=(t=e.getShadowRGBA())!==null&&t!==void 0?t:"black",a=(i=e.getShadowBlur())!==null&&i!==void 0?i:5,l=(s=e.getShadowOffset())!==null&&s!==void 0?s:{x:0,y:0},o=e.getAbsoluteScale(),c=this.canvas.getPixelRatio(),d=o.x*c,u=o.y*c;this.setAttr("shadowColor",r),this.setAttr("shadowBlur",a*Math.min(Math.abs(d),Math.abs(u))),this.setAttr("shadowOffsetX",l.x*d),this.setAttr("shadowOffsetY",l.y*u)}}class tc extends Qn{constructor(e){super(e),this._context=e._canvas.getContext("2d",{willReadFrequently:!0})}_fill(e){this.save(),this.setAttr("fillStyle",e.colorKey),e._fillFuncHit(this),this.restore()}strokeShape(e){e.hasHitStroke()&&this._stroke(e)}_stroke(e){if(e.hasHitStroke()){const t=e.getStrokeScaleEnabled();if(!t){this.save();const r=this.getCanvas().getPixelRatio();this.setTransform(r,0,0,r,0,0)}this._applyLineCap(e);const i=e.hitStrokeWidth(),s=i==="auto"?e.strokeWidth():i;this.setAttr("lineWidth",s),this.setAttr("strokeStyle",e.colorKey),e._strokeFuncHit(this),t||this.restore()}}}let kn;function nc(){if(kn)return kn;const n=U.createCanvasElement(),e=n.getContext("2d");return kn=function(){const t=le._global.devicePixelRatio||1,i=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return t/i}(),U.releaseCanvas(n),kn}class Li{constructor(e){this.pixelRatio=1,this.width=0,this.height=0,this.isCache=!1;const i=(e||{}).pixelRatio||le.pixelRatio||nc();this.pixelRatio=i,this._canvas=U.createCanvasElement(),this._canvas.style.padding="0",this._canvas.style.margin="0",this._canvas.style.border="0",this._canvas.style.background="transparent",this._canvas.style.position="absolute",this._canvas.style.top="0",this._canvas.style.left="0"}getContext(){return this.context}getPixelRatio(){return this.pixelRatio}setPixelRatio(e){const t=this.pixelRatio;this.pixelRatio=e,this.setSize(this.getWidth()/t,this.getHeight()/t)}setWidth(e){this.width=this._canvas.width=e*this.pixelRatio,this._canvas.style.width=e+"px";const t=this.pixelRatio;this.getContext()._context.scale(t,t)}setHeight(e){this.height=this._canvas.height=e*this.pixelRatio,this._canvas.style.height=e+"px";const t=this.pixelRatio;this.getContext()._context.scale(t,t)}getWidth(){return this.width}getHeight(){return this.height}setSize(e,t){this.setWidth(e||0),this.setHeight(t||0)}toDataURL(e,t){try{return this._canvas.toDataURL(e,t)}catch{try{return this._canvas.toDataURL()}catch(s){return U.error("Unable to get data URL. "+s.message+" For more info read https://konvajs.org/docs/posts/Tainted_Canvas.html."),""}}}}class wt extends Li{constructor(e={width:0,height:0,willReadFrequently:!1}){super(e),this.context=new ec(this,{willReadFrequently:e.willReadFrequently}),this.setSize(e.width,e.height)}}function ns(){const n=U.createCanvasElement();n.width=1,n.height=1;const e=n.getContext("2d",{willReadFrequently:!0});e.clearRect(0,0,1,1),e.fillStyle="rgba(255,0,255,1)",e.fillRect(0,0,1,1);const t=e.getImageData(0,0,1,1).data;return!(t[0]===255&&t[1]===0&&t[2]===255&&t[3]===255)}function is(){var n,e;return typeof navigator>"u"?!1:(e=(n=navigator.brave)===null||n===void 0?void 0:n.isBrave())!==null&&e!==void 0?e:!1}let ss=!1;function ic(){return is()&&ns()&&!ss&&(ss=!0,U.error('Looks like you have "Brave shield" enabled in your browser. It breaks KonvaJS internals. Please disable it. You may need to ask your users to do the same.')),is()&&ns()}class Mi extends Li{constructor(e={width:0,height:0}){super(e),this.hitCanvas=!0,this.context=new tc(this),this.setSize(e.width,e.height),ic()}}const Le={get isDragging(){let n=!1;return Le._dragElements.forEach(e=>{e.dragStatus==="dragging"&&(n=!0)}),n},justDragged:!1,get node(){let n;return Le._dragElements.forEach(e=>{n=e.node}),n},_dragElements:new Map,_drag(n){const e=[];Le._dragElements.forEach((t,i)=>{const{node:s}=t,r=s.getStage();r.setPointersPositions(n),t.pointerId===void 0&&(t.pointerId=U._getFirstPointerId(n));const a=r._changedPointerPositions.find(l=>l.id===t.pointerId);if(a){if(t.dragStatus!=="dragging"){const l=s.dragDistance();if(Math.max(Math.abs(a.x-t.startPointerPos.x),Math.abs(a.y-t.startPointerPos.y))<l||(s.startDrag({evt:n}),!s.isDragging()))return}s._setDragPosition(n,t),e.push(s)}}),e.forEach(t=>{t.fire("dragmove",{type:"dragmove",target:t,evt:n},!0)})},_endDragBefore(n){const e=[];Le._dragElements.forEach(t=>{const{node:i}=t,s=i.getStage();if(n&&s.setPointersPositions(n),!s._changedPointerPositions.find(l=>l.id===t.pointerId))return;(t.dragStatus==="dragging"||t.dragStatus==="stopped")&&(Le.justDragged=!0,le._mouseListenClick=!1,le._touchListenClick=!1,le._pointerListenClick=!1,t.dragStatus="stopped");const a=t.node.getLayer()||t.node instanceof le.Stage&&t.node;a&&e.indexOf(a)===-1&&e.push(a)}),e.forEach(t=>{t.draw()})},_endDragAfter(n){Le._dragElements.forEach((e,t)=>{e.dragStatus==="stopped"&&e.node.fire("dragend",{type:"dragend",target:e.node,evt:n},!0),e.dragStatus!=="dragging"&&Le._dragElements.delete(t)})}};le.isBrowser&&(window.addEventListener("mouseup",Le._endDragBefore,!0),window.addEventListener("touchend",Le._endDragBefore,!0),window.addEventListener("touchcancel",Le._endDragBefore,!0),window.addEventListener("mousemove",Le._drag),window.addEventListener("touchmove",Le._drag),window.addEventListener("mouseup",Le._endDragAfter,!1),window.addEventListener("touchend",Le._endDragAfter,!1),window.addEventListener("touchcancel",Le._endDragAfter,!1));function Ct(n){return U._isString(n)?'"'+n+'"':Object.prototype.toString.call(n)==="[object Number]"||U._isBoolean(n)?n:Object.prototype.toString.call(n)}function lr(n){return n>255?255:n<0?0:Math.round(n)}function re(){if(le.isUnminified)return function(n,e){return U._isNumber(n)||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a number.'),n}}function Jn(n){if(le.isUnminified)return function(e,t){let i=U._isNumber(e),s=U._isArray(e)&&e.length==n;return!i&&!s&&U.warn(Ct(e)+' is a not valid value for "'+t+'" attribute. The value should be a number or Array<number>('+n+")"),e}}function Di(){if(le.isUnminified)return function(n,e){return U._isNumber(n)||n==="auto"||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a number or "auto".'),n}}function Ot(){if(le.isUnminified)return function(n,e){return U._isString(n)||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a string.'),n}}function or(){if(le.isUnminified)return function(n,e){const t=U._isString(n),i=Object.prototype.toString.call(n)==="[object CanvasGradient]"||n&&n.addColorStop;return t||i||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a string or a native gradient.'),n}}function sc(){if(le.isUnminified)return function(n,e){const t=Int8Array?Object.getPrototypeOf(Int8Array):null;return t&&n instanceof t||(U._isArray(n)?n.forEach(function(i){U._isNumber(i)||U.warn('"'+e+'" attribute has non numeric element '+i+". Make sure that all elements are numbers.")}):U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a array of numbers.')),n}}function lt(){if(le.isUnminified)return function(n,e){return n===!0||n===!1||U.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a boolean.'),n}}function rc(n){if(le.isUnminified)return function(e,t){return e==null||U.isObject(e)||U.warn(Ct(e)+' is a not valid value for "'+t+'" attribute. The value should be an object with properties '+n),e}}const tn="get",nn="set",T={addGetterSetter(n,e,t,i,s){T.addGetter(n,e,t),T.addSetter(n,e,i,s),T.addOverloadedGetterSetter(n,e)},addGetter(n,e,t){const i=tn+U._capitalize(e);n.prototype[i]=n.prototype[i]||function(){const s=this.attrs[e];return s===void 0?t:s}},addSetter(n,e,t,i){const s=nn+U._capitalize(e);n.prototype[s]||T.overWriteSetter(n,e,t,i)},overWriteSetter(n,e,t,i){const s=nn+U._capitalize(e);n.prototype[s]=function(r){return t&&r!==void 0&&r!==null&&(r=t.call(this,r,e)),this._setAttr(e,r),i&&i.call(this),this}},addComponentsGetterSetter(n,e,t,i,s){const r=t.length,a=U._capitalize,l=tn+a(e),o=nn+a(e);n.prototype[l]=function(){const d={};for(let u=0;u<r;u++){const g=t[u];d[g]=this.getAttr(e+a(g))}return d};const c=rc(t);n.prototype[o]=function(d){const u=this.attrs[e];i&&(d=i.call(this,d,e)),c&&c.call(this,d,e);for(const g in d)d.hasOwnProperty(g)&&this._setAttr(e+a(g),d[g]);return d||t.forEach(g=>{this._setAttr(e+a(g),void 0)}),this._fireChangeEvent(e,u,d),s&&s.call(this),this},T.addOverloadedGetterSetter(n,e)},addOverloadedGetterSetter(n,e){const t=U._capitalize(e),i=nn+t,s=tn+t;n.prototype[e]=function(){return arguments.length?(this[i](arguments[0]),this):this[s]()}},addDeprecatedGetterSetter(n,e,t,i){U.error("Adding deprecated "+e);const s=tn+U._capitalize(e),r=e+" property is deprecated and will be removed soon. Look at Konva change log for more information.";n.prototype[s]=function(){U.error(r);const a=this.attrs[e];return a===void 0?t:a},T.addSetter(n,e,i,function(){U.error(r)}),T.addOverloadedGetterSetter(n,e)},backCompat(n,e){U.each(e,function(t,i){const s=n.prototype[i],r=tn+U._capitalize(t),a=nn+U._capitalize(t);function l(){s.apply(this,arguments),U.error('"'+t+'" method is deprecated and will be removed soon. Use ""'+i+'" instead.')}n.prototype[t]=l,n.prototype[r]=l,n.prototype[a]=l})},afterSetFilter(){this._filterUpToDate=!1}};function ac(n){const e=/(\w+)\(([^)]+)\)/g;let t;for(;(t=e.exec(n))!==null;){const[,i,s]=t;switch(i){case"blur":{const r=parseFloat(s.replace("px",""));return function(a){this.blurRadius(r*.5);const l=le.Filters;l&&l.Blur&&l.Blur.call(this,a)}}case"brightness":{const r=s.includes("%")?parseFloat(s)/100:parseFloat(s);return function(a){this.brightness(r);const l=le.Filters;l&&l.Brightness&&l.Brightness.call(this,a)}}case"contrast":{const r=parseFloat(s);return function(a){const l=100*(Math.sqrt(r)-1);this.contrast(l);const o=le.Filters;o&&o.Contrast&&o.Contrast.call(this,a)}}case"grayscale":return function(r){const a=le.Filters;a&&a.Grayscale&&a.Grayscale.call(this,r)};case"sepia":return function(r){const a=le.Filters;a&&a.Sepia&&a.Sepia.call(this,r)};case"invert":return function(r){const a=le.Filters;a&&a.Invert&&a.Invert.call(this,r)};default:U.warn(`CSS filter "${i}" is not supported in fallback mode. Consider using function filters for better compatibility.`);break}}return()=>{}}const Nn="absoluteOpacity",Tn="allEventListeners",ut="absoluteTransform",rs="absoluteScale",At="canvas",lc="Change",oc="children",cc="konva",_i="listening",dc="mouseenter",hc="mouseleave",uc="pointerenter",gc="pointerleave",fc="touchenter",vc="touchleave",as="set",ls="Shape",zn=" ",os="stage",_t="transform",pc="Stage",xi="visible",mc=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(zn);let bc=1;class se{constructor(e){this._id=bc++,this.eventListeners={},this.attrs={},this.index=0,this._allEventListeners=null,this.parent=null,this._cache=new Map,this._attachedDepsListeners=new Map,this._lastPos=null,this._batchingTransformChange=!1,this._needClearTransformCache=!1,this._filterUpToDate=!1,this._isUnderCache=!1,this._dragEventId=null,this._shouldFireChangeEvents=!1,this.setAttrs(e),this._shouldFireChangeEvents=!0}hasChildren(){return!1}_clearCache(e){(e===_t||e===ut)&&this._cache.get(e)?this._cache.get(e).dirty=!0:e?this._cache.delete(e):this._cache.clear()}_getCache(e,t){let i=this._cache.get(e);return(i===void 0||(e===_t||e===ut)&&i.dirty===!0)&&(i=t.call(this),this._cache.set(e,i)),i}_calculate(e,t,i){if(!this._attachedDepsListeners.get(e)){const s=t.map(r=>r+"Change.konva").join(zn);this.on(s,()=>{this._clearCache(e)}),this._attachedDepsListeners.set(e,!0)}return this._getCache(e,i)}_getCanvasCache(){return this._cache.get(At)}_clearSelfAndDescendantCache(e){this._clearCache(e),e===ut&&this.fire("absoluteTransformChange")}clearCache(){if(this._cache.has(At)){const{scene:e,filter:t,hit:i,buffer:s}=this._cache.get(At);U.releaseCanvas(e,t,i,s),this._cache.delete(At)}return this._clearSelfAndDescendantCache(),this._requestDraw(),this}cache(e){const t=e||{};let i={};(t.x===void 0||t.y===void 0||t.width===void 0||t.height===void 0)&&(i=this.getClientRect({skipTransform:!0,relativeTo:this.getParent()||void 0}));let s=Math.ceil(t.width||i.width),r=Math.ceil(t.height||i.height),a=t.pixelRatio,l=t.x===void 0?Math.floor(i.x):t.x,o=t.y===void 0?Math.floor(i.y):t.y,c=t.offset||0,d=t.drawBorder||!1,u=t.hitCanvasPixelRatio||1;if(!s||!r){U.error("Can not cache the node. Width or height of the node equals 0. Caching is skipped.");return}const g=Math.abs(Math.round(i.x)-l)>.5?1:0,v=Math.abs(Math.round(i.y)-o)>.5?1:0;s+=c*2+g,r+=c*2+v,l-=c,o-=c;const h=new wt({pixelRatio:a,width:s,height:r}),p=new wt({pixelRatio:a,width:0,height:0,willReadFrequently:!0}),b=new Mi({pixelRatio:u,width:s,height:r}),m=h.getContext(),y=b.getContext(),$=new wt({width:h.width/h.pixelRatio+Math.abs(l),height:h.height/h.pixelRatio+Math.abs(o),pixelRatio:h.pixelRatio}),x=$.getContext();return b.isCache=!0,h.isCache=!0,this._cache.delete(At),this._filterUpToDate=!1,t.imageSmoothingEnabled===!1&&(h.getContext()._context.imageSmoothingEnabled=!1,p.getContext()._context.imageSmoothingEnabled=!1),m.save(),y.save(),x.save(),m.translate(-l,-o),y.translate(-l,-o),x.translate(-l,-o),$.x=l,$.y=o,this._isUnderCache=!0,this._clearSelfAndDescendantCache(Nn),this._clearSelfAndDescendantCache(rs),this.drawScene(h,this,$),this.drawHit(b,this),this._isUnderCache=!1,m.restore(),y.restore(),d&&(m.save(),m.beginPath(),m.rect(0,0,s,r),m.closePath(),m.setAttr("strokeStyle","red"),m.setAttr("lineWidth",5),m.stroke(),m.restore()),this._cache.set(At,{scene:h,filter:p,hit:b,buffer:$,x:l,y:o}),this._requestDraw(),this}isCached(){return this._cache.has(At)}getClientRect(e){throw new Error('abstract "getClientRect" method call')}_transformedRect(e,t){const i=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}];let s=1/0,r=1/0,a=-1/0,l=-1/0;const o=this.getAbsoluteTransform(t);return i.forEach(function(c){const d=o.point(c);s===void 0&&(s=a=d.x,r=l=d.y),s=Math.min(s,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y)}),{x:s,y:r,width:a-s,height:l-r}}_drawCachedSceneCanvas(e){e.save(),e._applyOpacity(this),e._applyGlobalCompositeOperation(this);const t=this._getCanvasCache();e.translate(t.x,t.y);const i=this._getCachedSceneCanvas(),s=i.pixelRatio;e.drawImage(i._canvas,0,0,i.width/s,i.height/s),e.restore()}_drawCachedHitCanvas(e){const t=this._getCanvasCache(),i=t.hit;e.save(),e.translate(t.x,t.y),e.drawImage(i._canvas,0,0,i.width/i.pixelRatio,i.height/i.pixelRatio),e.restore()}_getCachedSceneCanvas(){let e=this.filters(),t=this._getCanvasCache(),i=t.scene,s=t.filter,r=s.getContext(),a,l,o,c;if(!e||e.length===0)return i;if(this._filterUpToDate)return s;let d=!0;for(let g=0;g<e.length;g++)if(typeof e[g]=="string"&&ts(),typeof e[g]!="string"||!ts()){d=!1;break}const u=i.pixelRatio;if(s.setSize(i.width/i.pixelRatio,i.height/i.pixelRatio),d){const g=e.join(" ");return r.save(),r.setAttr("filter",g),r.drawImage(i._canvas,0,0,i.getWidth()/u,i.getHeight()/u),r.restore(),this._filterUpToDate=!0,s}try{for(a=e.length,r.clear(),r.drawImage(i._canvas,0,0,i.getWidth()/u,i.getHeight()/u),l=r.getImageData(0,0,s.getWidth(),s.getHeight()),o=0;o<a;o++)c=e[o],typeof c=="string"&&(c=ac(c)),c.call(this,l),r.putImageData(l,0,0)}catch(g){U.error("Unable to apply filter. "+g.message+" This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.")}return this._filterUpToDate=!0,s}on(e,t){if(this._cache&&this._cache.delete(Tn),arguments.length===3)return this._delegate.apply(this,arguments);const i=e.split(zn);for(let s=0;s<i.length;s++){const a=i[s].split("."),l=a[0],o=a[1]||"";this.eventListeners[l]||(this.eventListeners[l]=[]),this.eventListeners[l].push({name:o,handler:t})}return this}off(e,t){let i=(e||"").split(zn),s=i.length,r,a,l,o,c,d;if(this._cache&&this._cache.delete(Tn),!e)for(a in this.eventListeners)this._off(a);for(r=0;r<s;r++)if(l=i[r],o=l.split("."),c=o[0],d=o[1],c)this.eventListeners[c]&&this._off(c,d,t);else for(a in this.eventListeners)this._off(a,d,t);return this}dispatchEvent(e){const t={target:this,type:e.type,evt:e};return this.fire(e.type,t),this}addEventListener(e,t){return this.on(e,function(i){t.call(this,i.evt)}),this}removeEventListener(e){return this.off(e),this}_delegate(e,t,i){const s=this;this.on(e,function(r){const a=r.target.findAncestors(t,!0,s);for(let l=0;l<a.length;l++)r=U.cloneObject(r),r.currentTarget=a[l],i.call(a[l],r)})}remove(){return this.isDragging()&&this.stopDrag(),Le._dragElements.delete(this._id),this._remove(),this}_clearCaches(){this._clearSelfAndDescendantCache(ut),this._clearSelfAndDescendantCache(Nn),this._clearSelfAndDescendantCache(rs),this._clearSelfAndDescendantCache(os),this._clearSelfAndDescendantCache(xi),this._clearSelfAndDescendantCache(_i)}_remove(){this._clearCaches();const e=this.getParent();e&&e.children&&(e.children.splice(this.index,1),e._setChildrenIndices(),this.parent=null)}destroy(){return this.remove(),this.clearCache(),this}getAttr(e){const t="get"+U._capitalize(e);return U._isFunction(this[t])?this[t]():this.attrs[e]}getAncestors(){let e=this.getParent(),t=[];for(;e;)t.push(e),e=e.getParent();return t}getAttrs(){return this.attrs||{}}setAttrs(e){return this._batchTransformChanges(()=>{let t,i;if(!e)return this;for(t in e)t!==oc&&(i=as+U._capitalize(t),U._isFunction(this[i])?this[i](e[t]):this._setAttr(t,e[t]))}),this}isListening(){return this._getCache(_i,this._isListening)}_isListening(e){if(!this.listening())return!1;const i=this.getParent();return i&&i!==e&&this!==e?i._isListening(e):!0}isVisible(){return this._getCache(xi,this._isVisible)}_isVisible(e){if(!this.visible())return!1;const i=this.getParent();return i&&i!==e&&this!==e?i._isVisible(e):!0}shouldDrawHit(e,t=!1){if(e)return this._isVisible(e)&&this._isListening(e);const i=this.getLayer();let s=!1;Le._dragElements.forEach(a=>{a.dragStatus==="dragging"&&(a.node.nodeType==="Stage"||a.node.getLayer()===i)&&(s=!0)});const r=!t&&!le.hitOnDragEnabled&&(s||le.isTransforming());return this.isListening()&&this.isVisible()&&!r}show(){return this.visible(!0),this}hide(){return this.visible(!1),this}getZIndex(){return this.index||0}getAbsoluteZIndex(){let e=this.getDepth(),t=this,i=0,s,r,a,l;function o(d){for(s=[],r=d.length,a=0;a<r;a++)l=d[a],i++,l.nodeType!==ls&&(s=s.concat(l.getChildren().slice())),l._id===t._id&&(a=r);s.length>0&&s[0].getDepth()<=e&&o(s)}const c=this.getStage();return t.nodeType!==pc&&c&&o(c.getChildren()),i}getDepth(){let e=0,t=this.parent;for(;t;)e++,t=t.parent;return e}_batchTransformChanges(e){this._batchingTransformChange=!0,e(),this._batchingTransformChange=!1,this._needClearTransformCache&&(this._clearCache(_t),this._clearSelfAndDescendantCache(ut)),this._needClearTransformCache=!1}setPosition(e){return this._batchTransformChanges(()=>{this.x(e.x),this.y(e.y)}),this}getPosition(){return{x:this.x(),y:this.y()}}getRelativePointerPosition(){const e=this.getStage();if(!e)return null;const t=e.getPointerPosition();if(!t)return null;const i=this.getAbsoluteTransform().copy();return i.invert(),i.point(t)}getAbsolutePosition(e){let t=!1,i=this.parent;for(;i;){if(i.isCached()){t=!0;break}i=i.parent}t&&!e&&(e=!0);const s=this.getAbsoluteTransform(e).getMatrix(),r=new Ke,a=this.offset();return r.m=s.slice(),r.translate(a.x,a.y),r.getTranslation()}setAbsolutePosition(e){const{x:t,y:i,...s}=this._clearTransform();this.attrs.x=t,this.attrs.y=i,this._clearCache(_t);const r=this._getAbsoluteTransform().copy();return r.invert(),r.translate(e.x,e.y),e={x:this.attrs.x+r.getTranslation().x,y:this.attrs.y+r.getTranslation().y},this._setTransform(s),this.setPosition({x:e.x,y:e.y}),this._clearCache(_t),this._clearSelfAndDescendantCache(ut),this}_setTransform(e){let t;for(t in e)this.attrs[t]=e[t]}_clearTransform(){const e={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,e}move(e){let t=e.x,i=e.y,s=this.x(),r=this.y();return t!==void 0&&(s+=t),i!==void 0&&(r+=i),this.setPosition({x:s,y:r}),this}_eachAncestorReverse(e,t){let i=[],s=this.getParent(),r,a;if(!(t&&t._id===this._id)){for(i.unshift(this);s&&(!t||s._id!==t._id);)i.unshift(s),s=s.parent;for(r=i.length,a=0;a<r;a++)e(i[a])}}rotate(e){return this.rotation(this.rotation()+e),this}moveToTop(){if(!this.parent)return U.warn("Node has no parent. moveToTop function is ignored."),!1;const e=this.index,t=this.parent.getChildren().length;return e<t-1?(this.parent.children.splice(e,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0):!1}moveUp(){if(!this.parent)return U.warn("Node has no parent. moveUp function is ignored."),!1;const e=this.index,t=this.parent.getChildren().length;return e<t-1?(this.parent.children.splice(e,1),this.parent.children.splice(e+1,0,this),this.parent._setChildrenIndices(),!0):!1}moveDown(){if(!this.parent)return U.warn("Node has no parent. moveDown function is ignored."),!1;const e=this.index;return e>0?(this.parent.children.splice(e,1),this.parent.children.splice(e-1,0,this),this.parent._setChildrenIndices(),!0):!1}moveToBottom(){if(!this.parent)return U.warn("Node has no parent. moveToBottom function is ignored."),!1;const e=this.index;return e>0?(this.parent.children.splice(e,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0):!1}setZIndex(e){if(!this.parent)return U.warn("Node has no parent. zIndex parameter is ignored."),this;(e<0||e>=this.parent.children.length)&&U.warn("Unexpected value "+e+" for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to "+(this.parent.children.length-1)+".");const t=this.index;return this.parent.children.splice(t,1),this.parent.children.splice(e,0,this),this.parent._setChildrenIndices(),this}getAbsoluteOpacity(){return this._getCache(Nn,this._getAbsoluteOpacity)}_getAbsoluteOpacity(){let e=this.opacity();const t=this.getParent();return t&&!t._isUnderCache&&(e*=t.getAbsoluteOpacity()),e}moveTo(e){return this.getParent()!==e&&(this._remove(),e.add(this)),this}toObject(){let e=this.getAttrs(),t,i,s,r,a;const l={attrs:{},className:this.getClassName()};for(t in e)i=e[t],a=U.isObject(i)&&!U._isPlainObject(i)&&!U._isArray(i),!a&&(s=typeof this[t]=="function"&&this[t],delete e[t],r=s?s.call(this):null,e[t]=i,r!==i&&(l.attrs[t]=i));return U._prepareToStringify(l)}toJSON(){return JSON.stringify(this.toObject())}getParent(){return this.parent}findAncestors(e,t,i){const s=[];t&&this._isMatch(e)&&s.push(this);let r=this.parent;for(;r;){if(r===i)return s;r._isMatch(e)&&s.push(r),r=r.parent}return s}isAncestorOf(e){return!1}findAncestor(e,t,i){return this.findAncestors(e,t,i)[0]}_isMatch(e){if(!e)return!1;if(typeof e=="function")return e(this);let t=e.replace(/ /g,"").split(","),i=t.length,s,r;for(s=0;s<i;s++)if(r=t[s],U.isValidSelector(r)||(U.warn('Selector "'+r+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),U.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),U.warn("Konva is awesome, right?")),r.charAt(0)==="#"){if(this.id()===r.slice(1))return!0}else if(r.charAt(0)==="."){if(this.hasName(r.slice(1)))return!0}else if(this.className===r||this.nodeType===r)return!0;return!1}getLayer(){const e=this.getParent();return e?e.getLayer():null}getStage(){return this._getCache(os,this._getStage)}_getStage(){const e=this.getParent();return e?e.getStage():null}fire(e,t={},i){return t.target=t.target||this,i?this._fireAndBubble(e,t):this._fire(e,t),this}getAbsoluteTransform(e){return e?this._getAbsoluteTransform(e):this._getCache(ut,this._getAbsoluteTransform)}_getAbsoluteTransform(e){let t;if(e)return t=new Ke,this._eachAncestorReverse(function(i){const s=i.transformsEnabled();s==="all"?t.multiply(i.getTransform()):s==="position"&&t.translate(i.x()-i.offsetX(),i.y()-i.offsetY())},e),t;{t=this._cache.get(ut)||new Ke,this.parent?this.parent.getAbsoluteTransform().copyInto(t):t.reset();const i=this.transformsEnabled();if(i==="all")t.multiply(this.getTransform());else if(i==="position"){const s=this.attrs.x||0,r=this.attrs.y||0,a=this.attrs.offsetX||0,l=this.attrs.offsetY||0;t.translate(s-a,r-l)}return t.dirty=!1,t}}getAbsoluteScale(e){let t=this;for(;t;)t._isUnderCache&&(e=t),t=t.getParent();const s=this.getAbsoluteTransform(e).decompose();return{x:s.scaleX,y:s.scaleY}}getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation}getTransform(){return this._getCache(_t,this._getTransform)}_getTransform(){var e,t;const i=this._cache.get(_t)||new Ke;i.reset();const s=this.x(),r=this.y(),a=le.getAngle(this.rotation()),l=(e=this.attrs.scaleX)!==null&&e!==void 0?e:1,o=(t=this.attrs.scaleY)!==null&&t!==void 0?t:1,c=this.attrs.skewX||0,d=this.attrs.skewY||0,u=this.attrs.offsetX||0,g=this.attrs.offsetY||0;return(s!==0||r!==0)&&i.translate(s,r),a!==0&&i.rotate(a),(c!==0||d!==0)&&i.skew(c,d),(l!==1||o!==1)&&i.scale(l,o),(u!==0||g!==0)&&i.translate(-1*u,-1*g),i.dirty=!1,i}clone(e){let t=U.cloneObject(this.attrs),i,s,r,a,l;for(i in e)t[i]=e[i];const o=new this.constructor(t);for(i in this.eventListeners)for(s=this.eventListeners[i],r=s.length,a=0;a<r;a++)l=s[a],l.name.indexOf(cc)<0&&(o.eventListeners[i]||(o.eventListeners[i]=[]),o.eventListeners[i].push(l));return o}_toKonvaCanvas(e){e=e||{};const t=this.getClientRect(),i=this.getStage(),s=e.x!==void 0?e.x:Math.floor(t.x),r=e.y!==void 0?e.y:Math.floor(t.y),a=e.pixelRatio||1,l=new wt({width:e.width||Math.ceil(t.width)||(i?i.width():0),height:e.height||Math.ceil(t.height)||(i?i.height():0),pixelRatio:a}),o=l.getContext(),c=new wt({width:l.width/l.pixelRatio+Math.abs(s),height:l.height/l.pixelRatio+Math.abs(r),pixelRatio:l.pixelRatio});return e.imageSmoothingEnabled===!1&&(o._context.imageSmoothingEnabled=!1),o.save(),(s||r)&&o.translate(-1*s,-1*r),this.drawScene(l,void 0,c),o.restore(),l}toCanvas(e){return this._toKonvaCanvas(e)._canvas}toDataURL(e){e=e||{};const t=e.mimeType||null,i=e.quality||null,s=this._toKonvaCanvas(e).toDataURL(t,i);return e.callback&&e.callback(s),s}toImage(e){return new Promise((t,i)=>{try{const s=e?.callback;s&&delete e.callback,U._urlToImage(this.toDataURL(e),function(r){t(r),s?.(r)})}catch(s){i(s)}})}toBlob(e){return new Promise((t,i)=>{try{const s=e?.callback;s&&delete e.callback,this.toCanvas(e).toBlob(r=>{t(r),s?.(r)},e?.mimeType,e?.quality)}catch(s){i(s)}})}setSize(e){return this.width(e.width),this.height(e.height),this}getSize(){return{width:this.width(),height:this.height()}}getClassName(){return this.className||this.nodeType}getType(){return this.nodeType}getDragDistance(){return this.attrs.dragDistance!==void 0?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():le.dragDistance}_off(e,t,i){let s=this.eventListeners[e],r,a,l;for(r=0;r<s.length;r++)if(a=s[r].name,l=s[r].handler,(a!=="konva"||t==="konva")&&(!t||a===t)&&(!i||i===l)){if(s.splice(r,1),s.length===0){delete this.eventListeners[e];break}r--}}_fireChangeEvent(e,t,i){this._fire(e+lc,{oldVal:t,newVal:i})}addName(e){if(!this.hasName(e)){const t=this.name(),i=t?t+" "+e:e;this.name(i)}return this}hasName(e){if(!e)return!1;const t=this.name();return t?(t||"").split(/\s/g).indexOf(e)!==-1:!1}removeName(e){const t=(this.name()||"").split(/\s/g),i=t.indexOf(e);return i!==-1&&(t.splice(i,1),this.name(t.join(" "))),this}setAttr(e,t){const i=this[as+U._capitalize(e)];return U._isFunction(i)?i.call(this,t):this._setAttr(e,t),this}_requestDraw(){if(le.autoDrawEnabled){const e=this.getLayer()||this.getStage();e?.batchDraw()}}_setAttr(e,t){const i=this.attrs[e];i===t&&!U.isObject(t)||(t==null?delete this.attrs[e]:this.attrs[e]=t,this._shouldFireChangeEvents&&this._fireChangeEvent(e,i,t),this._requestDraw())}_setComponentAttr(e,t,i){let s;i!==void 0&&(s=this.attrs[e],s||(this.attrs[e]=this.getAttr(e)),this.attrs[e][t]=i,this._fireChangeEvent(e,s,i))}_fireAndBubble(e,t,i){t&&this.nodeType===ls&&(t.target=this);const s=[dc,hc,uc,gc,fc,vc];if(!(s.indexOf(e)!==-1&&(i&&(this===i||this.isAncestorOf&&this.isAncestorOf(i))||this.nodeType==="Stage"&&!i))){this._fire(e,t);const a=s.indexOf(e)!==-1&&i&&i.isAncestorOf&&i.isAncestorOf(this)&&!i.isAncestorOf(this.parent);(t&&!t.cancelBubble||!t)&&this.parent&&this.parent.isListening()&&!a&&(i&&i.parent?this._fireAndBubble.call(this.parent,e,t,i):this._fireAndBubble.call(this.parent,e,t))}}_getProtoListeners(e){var t,i,s;const r=(t=this._cache.get(Tn))!==null&&t!==void 0?t:{};let a=r?.[e];if(a===void 0){a=[];let l=Object.getPrototypeOf(this);for(;l;){const o=(s=(i=l.eventListeners)===null||i===void 0?void 0:i[e])!==null&&s!==void 0?s:[];a.push(...o),l=Object.getPrototypeOf(l)}r[e]=a,this._cache.set(Tn,r)}return a}_fire(e,t){t=t||{},t.currentTarget=this,t.type=e;const i=this._getProtoListeners(e);if(i)for(let r=0;r<i.length;r++)i[r].handler.call(this,t);const s=this.eventListeners[e];if(s)for(let r=0;r<s.length;r++)s[r].handler.call(this,t)}draw(){return this.drawScene(),this.drawHit(),this}_createDragElement(e){const t=e?e.pointerId:void 0,i=this.getStage(),s=this.getAbsolutePosition();if(!i)return;const r=i._getPointerById(t)||i._changedPointerPositions[0]||s;Le._dragElements.set(this._id,{node:this,startPointerPos:r,offset:{x:r.x-s.x,y:r.y-s.y},dragStatus:"ready",pointerId:t})}startDrag(e,t=!0){Le._dragElements.has(this._id)||this._createDragElement(e);const i=Le._dragElements.get(this._id);i.dragStatus="dragging",this.fire("dragstart",{type:"dragstart",target:this,evt:e&&e.evt},t)}_setDragPosition(e,t){const i=this.getStage()._getPointerById(t.pointerId);if(!i)return;let s={x:i.x-t.offset.x,y:i.y-t.offset.y};const r=this.dragBoundFunc();if(r!==void 0){const a=r.call(this,s,e);a?s=a:U.warn("dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.")}(!this._lastPos||this._lastPos.x!==s.x||this._lastPos.y!==s.y)&&(this.setAbsolutePosition(s),this._requestDraw()),this._lastPos=s}stopDrag(e){const t=Le._dragElements.get(this._id);t&&(t.dragStatus="stopped"),Le._endDragBefore(e),Le._endDragAfter(e)}setDraggable(e){this._setAttr("draggable",e),this._dragChange()}isDragging(){const e=Le._dragElements.get(this._id);return e?e.dragStatus==="dragging":!1}_listenDrag(){this._dragCleanup(),this.on("mousedown.konva touchstart.konva",function(e){if(!(!(e.evt.button!==void 0)||le.dragButtons.indexOf(e.evt.button)>=0)||this.isDragging())return;let s=!1;Le._dragElements.forEach(r=>{this.isAncestorOf(r.node)&&(s=!0)}),s||this._createDragElement(e)})}_dragChange(){if(this.attrs.draggable)this._listenDrag();else{if(this._dragCleanup(),!this.getStage())return;const t=Le._dragElements.get(this._id),i=t&&t.dragStatus==="dragging",s=t&&t.dragStatus==="ready";i?this.stopDrag():s&&Le._dragElements.delete(this._id)}}_dragCleanup(){this.off("mousedown.konva"),this.off("touchstart.konva")}isClientRectOnScreen(e={x:0,y:0}){const t=this.getStage();if(!t)return!1;const i={x:-e.x,y:-e.y,width:t.width()+2*e.x,height:t.height()+2*e.y};return U.haveIntersection(i,this.getClientRect())}static create(e,t){return U._isString(e)&&(e=JSON.parse(e)),this._createNode(e,t)}static _createNode(e,t){let i=se.prototype.getClassName.call(e),s=e.children,r,a,l;t&&(e.attrs.container=t),le[i]||(U.warn('Can not find a node with class name "'+i+'". Fallback to "Shape".'),i="Shape");const o=le[i];if(r=new o(e.attrs),s)for(a=s.length,l=0;l<a;l++)r.add(se._createNode(s[l]));return r}}se.prototype.nodeType="Node";se.prototype._attrsAffectingSize=[];se.prototype.eventListeners={};se.prototype.on.call(se.prototype,mc,function(){if(this._batchingTransformChange){this._needClearTransformCache=!0;return}this._clearCache(_t),this._clearSelfAndDescendantCache(ut)});se.prototype.on.call(se.prototype,"visibleChange.konva",function(){this._clearSelfAndDescendantCache(xi)});se.prototype.on.call(se.prototype,"listeningChange.konva",function(){this._clearSelfAndDescendantCache(_i)});se.prototype.on.call(se.prototype,"opacityChange.konva",function(){this._clearSelfAndDescendantCache(Nn)});const Oe=T.addGetterSetter;Oe(se,"zIndex");Oe(se,"absolutePosition");Oe(se,"position");Oe(se,"x",0,re());Oe(se,"y",0,re());Oe(se,"globalCompositeOperation","source-over",Ot());Oe(se,"opacity",1,re());Oe(se,"name","",Ot());Oe(se,"id","",Ot());Oe(se,"rotation",0,re());T.addComponentsGetterSetter(se,"scale",["x","y"]);Oe(se,"scaleX",1,re());Oe(se,"scaleY",1,re());T.addComponentsGetterSetter(se,"skew",["x","y"]);Oe(se,"skewX",0,re());Oe(se,"skewY",0,re());T.addComponentsGetterSetter(se,"offset",["x","y"]);Oe(se,"offsetX",0,re());Oe(se,"offsetY",0,re());Oe(se,"dragDistance",void 0,re());Oe(se,"width",0,re());Oe(se,"height",0,re());Oe(se,"listening",!0,lt());Oe(se,"preventDefault",!0,lt());Oe(se,"filters",void 0,function(n){return this._filterUpToDate=!1,n});Oe(se,"visible",!0,lt());Oe(se,"transformsEnabled","all",Ot());Oe(se,"size");Oe(se,"dragBoundFunc");Oe(se,"draggable",!1,lt());T.backCompat(se,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"});class et extends se{constructor(){super(...arguments),this.children=[]}getChildren(e){const t=this.children||[];return e?t.filter(e):t}hasChildren(){return this.getChildren().length>0}removeChildren(){return this.getChildren().forEach(e=>{e.parent=null,e.index=0,e.remove()}),this.children=[],this._requestDraw(),this}destroyChildren(){return this.getChildren().forEach(e=>{e.parent=null,e.index=0,e.destroy()}),this.children=[],this._requestDraw(),this}add(...e){if(e.length===0)return this;if(e.length>1){for(let i=0;i<e.length;i++)this.add(e[i]);return this}const t=e[0];return t.getParent()?(t.moveTo(this),this):(this._validateAdd(t),t.index=this.getChildren().length,t.parent=this,t._clearCaches(),this.getChildren().push(t),this._fire("add",{child:t}),this._requestDraw(),this)}destroy(){return this.hasChildren()&&this.destroyChildren(),super.destroy(),this}find(e){return this._generalFind(e,!1)}findOne(e){const t=this._generalFind(e,!0);return t.length>0?t[0]:void 0}_generalFind(e,t){const i=[];return this._descendants(s=>{const r=s._isMatch(e);return r&&i.push(s),!!(r&&t)}),i}_descendants(e){let t=!1;const i=this.getChildren();for(const s of i){if(t=e(s),t)return!0;if(s.hasChildren()&&(t=s._descendants(e),t))return!0}return!1}toObject(){const e=se.prototype.toObject.call(this);return e.children=[],this.getChildren().forEach(t=>{e.children.push(t.toObject())}),e}isAncestorOf(e){let t=e.getParent();for(;t;){if(t._id===this._id)return!0;t=t.getParent()}return!1}clone(e){const t=se.prototype.clone.call(this,e);return this.getChildren().forEach(function(i){t.add(i.clone())}),t}getAllIntersections(e){const t=[];return this.find("Shape").forEach(i=>{i.isVisible()&&i.intersects(e)&&t.push(i)}),t}_clearSelfAndDescendantCache(e){var t;super._clearSelfAndDescendantCache(e),!this.isCached()&&((t=this.children)===null||t===void 0||t.forEach(function(i){i._clearSelfAndDescendantCache(e)}))}_setChildrenIndices(){var e;(e=this.children)===null||e===void 0||e.forEach(function(t,i){t.index=i}),this._requestDraw()}drawScene(e,t,i){const s=this.getLayer(),r=e||s&&s.getCanvas(),a=r&&r.getContext(),l=this._getCanvasCache(),o=l&&l.scene,c=r&&r.isCache;if(!this.isVisible()&&!c)return this;if(o){a.save();const d=this.getAbsoluteTransform(t).getMatrix();a.transform(d[0],d[1],d[2],d[3],d[4],d[5]),this._drawCachedSceneCanvas(a),a.restore()}else this._drawChildren("drawScene",r,t,i);return this}drawHit(e,t){if(!this.shouldDrawHit(t))return this;const i=this.getLayer(),s=e||i&&i.hitCanvas,r=s&&s.getContext(),a=this._getCanvasCache();if(a&&a.hit){r.save();const o=this.getAbsoluteTransform(t).getMatrix();r.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this._drawCachedHitCanvas(r),r.restore()}else this._drawChildren("drawHit",s,t);return this}_drawChildren(e,t,i,s){var r;const a=t&&t.getContext(),l=this.clipWidth(),o=this.clipHeight(),c=this.clipFunc(),d=typeof l=="number"&&typeof o=="number"||c,u=i===this;if(d){a.save();const v=this.getAbsoluteTransform(i);let h=v.getMatrix();a.transform(h[0],h[1],h[2],h[3],h[4],h[5]),a.beginPath();let p;if(c)p=c.call(this,a,this);else{const b=this.clipX(),m=this.clipY();a.rect(b||0,m||0,l,o)}a.clip.apply(a,p),h=v.copy().invert().getMatrix(),a.transform(h[0],h[1],h[2],h[3],h[4],h[5])}const g=!u&&this.globalCompositeOperation()!=="source-over"&&e==="drawScene";g&&(a.save(),a._applyGlobalCompositeOperation(this)),(r=this.children)===null||r===void 0||r.forEach(function(v){v[e](t,i,s)}),g&&a.restore(),d&&a.restore()}getClientRect(e={}){var t;const i=e.skipTransform,s=e.relativeTo;let r,a,l,o,c={x:1/0,y:1/0,width:0,height:0};const d=this;(t=this.children)===null||t===void 0||t.forEach(function(v){if(!v.visible())return;const h=v.getClientRect({relativeTo:d,skipShadow:e.skipShadow,skipStroke:e.skipStroke});h.width===0&&h.height===0||(r===void 0?(r=h.x,a=h.y,l=h.x+h.width,o=h.y+h.height):(r=Math.min(r,h.x),a=Math.min(a,h.y),l=Math.max(l,h.x+h.width),o=Math.max(o,h.y+h.height)))});const u=this.find("Shape");let g=!1;for(let v=0;v<u.length;v++)if(u[v]._isVisible(this)){g=!0;break}return g&&r!==void 0?c={x:r,y:a,width:l-r,height:o-a}:c={x:0,y:0,width:0,height:0},i?c:this._transformedRect(c,s)}}T.addComponentsGetterSetter(et,"clip",["x","y","width","height"]);T.addGetterSetter(et,"clipX",void 0,re());T.addGetterSetter(et,"clipY",void 0,re());T.addGetterSetter(et,"clipWidth",void 0,re());T.addGetterSetter(et,"clipHeight",void 0,re());T.addGetterSetter(et,"clipFunc");const bn=new Map,cr=le._global.PointerEvent!==void 0;function li(n){return bn.get(n)}function Oi(n){return{evt:n,pointerId:n.pointerId}}function dr(n,e){return bn.get(n)===e}function hr(n,e){hn(n),e.getStage()&&(bn.set(n,e),cr&&e._fire("gotpointercapture",Oi(new PointerEvent("gotpointercapture"))))}function hn(n,e){const t=bn.get(n);if(!t)return;const i=t.getStage();i&&i.content,bn.delete(n),cr&&t._fire("lostpointercapture",Oi(new PointerEvent("lostpointercapture")))}const yc="Stage",_c="string",cs="px",xc="mouseout",ur="mouseleave",gr="mouseover",fr="mouseenter",vr="mousemove",pr="mousedown",mr="mouseup",an="pointermove",ln="pointerdown",Wt="pointerup",on="pointercancel",Sc="lostpointercapture",En="pointerout",cn="pointerleave",Pn="pointerover",An="pointerenter",Si="contextmenu",br="touchstart",yr="touchend",_r="touchmove",xr="touchcancel",wi="wheel",wc=5,$c=[[fr,"_pointerenter"],[pr,"_pointerdown"],[vr,"_pointermove"],[mr,"_pointerup"],[ur,"_pointerleave"],[br,"_pointerdown"],[_r,"_pointermove"],[yr,"_pointerup"],[xr,"_pointercancel"],[gr,"_pointerover"],[wi,"_wheel"],[Si,"_contextmenu"],[ln,"_pointerdown"],[an,"_pointermove"],[Wt,"_pointerup"],[on,"_pointercancel"],[cn,"_pointerleave"],[Sc,"_lostpointercapture"]],oi={mouse:{[En]:xc,[cn]:ur,[Pn]:gr,[An]:fr,[an]:vr,[ln]:pr,[Wt]:mr,[on]:"mousecancel",pointerclick:"click",pointerdblclick:"dblclick"},touch:{[En]:"touchout",[cn]:"touchleave",[Pn]:"touchover",[An]:"touchenter",[an]:_r,[ln]:br,[Wt]:yr,[on]:xr,pointerclick:"tap",pointerdblclick:"dbltap"},pointer:{[En]:En,[cn]:cn,[Pn]:Pn,[An]:An,[an]:an,[ln]:ln,[Wt]:Wt,[on]:on,pointerclick:"pointerclick",pointerdblclick:"pointerdblclick"}},dn=n=>n.indexOf("pointer")>=0?"pointer":n.indexOf("touch")>=0?"touch":"mouse",Bt=n=>{const e=dn(n);if(e==="pointer")return le.pointerEventsEnabled&&oi.pointer;if(e==="touch")return oi.touch;if(e==="mouse")return oi.mouse};function ds(n={}){return(n.clipFunc||n.clipWidth||n.clipHeight)&&U.warn("Stage does not support clipping. Please use clip for Layers or Groups."),n}const Cc="Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);",un=[];class Kn extends et{constructor(e){super(ds(e)),this._pointerPositions=[],this._changedPointerPositions=[],this._buildDOM(),this._bindContentEvents(),un.push(this),this.on("widthChange.konva heightChange.konva",this._resizeDOM),this.on("visibleChange.konva",this._checkVisibility),this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",()=>{ds(this.attrs)}),this._checkVisibility()}_validateAdd(e){const t=e.getType()==="Layer",i=e.getType()==="FastLayer";t||i||U.throw("You may only add layers to the stage.")}_checkVisibility(){if(!this.content)return;const e=this.visible()?"":"none";this.content.style.display=e}setContainer(e){if(typeof e===_c){let t;if(e.charAt(0)==="."){const i=e.slice(1);e=document.getElementsByClassName(i)[0]}else e.charAt(0)!=="#"?t=e:t=e.slice(1),e=document.getElementById(t);if(!e)throw"Can not find container in document with id "+t}return this._setAttr("container",e),this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),e.appendChild(this.content)),this}shouldDrawHit(){return!0}clear(){const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].clear();return this}clone(e){return e||(e={}),e.container=typeof document<"u"&&document.createElement("div"),et.prototype.clone.call(this,e)}destroy(){super.destroy();const e=this.content;e&&U._isInDocument(e)&&this.container().removeChild(e);const t=un.indexOf(this);return t>-1&&un.splice(t,1),U.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas),this}getPointerPosition(){const e=this._pointerPositions[0]||this._changedPointerPositions[0];return e?{x:e.x,y:e.y}:(U.warn(Cc),null)}_getPointerById(e){return this._pointerPositions.find(t=>t.id===e)}getPointersPositions(){return this._pointerPositions}getStage(){return this}getContent(){return this.content}_toKonvaCanvas(e){e={...e},e.x=e.x||0,e.y=e.y||0,e.width=e.width||this.width(),e.height=e.height||this.height();const t=new wt({width:e.width,height:e.height,pixelRatio:e.pixelRatio||1}),i=t.getContext()._context,s=this.children;return(e.x||e.y)&&i.translate(-1*e.x,-1*e.y),s.forEach(function(r){if(!r.isVisible())return;const a=r._toKonvaCanvas(e);i.drawImage(a._canvas,e.x,e.y,a.getWidth()/a.getPixelRatio(),a.getHeight()/a.getPixelRatio())}),t}getIntersection(e){if(!e)return null;const t=this.children,i=t.length,s=i-1;for(let r=s;r>=0;r--){const a=t[r].getIntersection(e);if(a)return a}return null}_resizeDOM(){const e=this.width(),t=this.height();this.content&&(this.content.style.width=e+cs,this.content.style.height=t+cs),this.bufferCanvas.setSize(e,t),this.bufferHitCanvas.setSize(e,t),this.children.forEach(i=>{i.setSize({width:e,height:t}),i.draw()})}add(e,...t){if(arguments.length>1){for(let s=0;s<arguments.length;s++)this.add(arguments[s]);return this}super.add(e);const i=this.children.length;return i>wc&&U.warn("The stage has "+i+" layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group."),e.setSize({width:this.width(),height:this.height()}),e.draw(),le.isBrowser&&this.content.appendChild(e.canvas._canvas),this}getParent(){return null}getLayer(){return null}hasPointerCapture(e){return dr(e,this)}setPointerCapture(e){hr(e,this)}releaseCapture(e){hn(e)}getLayers(){return this.children}_bindContentEvents(){le.isBrowser&&$c.forEach(([e,t])=>{this.content.addEventListener(e,i=>{this[t](i)},{passive:!1})})}_pointerenter(e){this.setPointersPositions(e);const t=Bt(e.type);t&&this._fire(t.pointerenter,{evt:e,target:this,currentTarget:this})}_pointerover(e){this.setPointersPositions(e);const t=Bt(e.type);t&&this._fire(t.pointerover,{evt:e,target:this,currentTarget:this})}_getTargetShape(e){let t=this[e+"targetShape"];return t&&!t.getStage()&&(t=null),t}_pointerleave(e){const t=Bt(e.type),i=dn(e.type);if(!t)return;this.setPointersPositions(e);const s=this._getTargetShape(i),r=!(le.isDragging()||le.isTransforming())||le.hitOnDragEnabled;s&&r?(s._fireAndBubble(t.pointerout,{evt:e}),s._fireAndBubble(t.pointerleave,{evt:e}),this._fire(t.pointerleave,{evt:e,target:this,currentTarget:this}),this[i+"targetShape"]=null):r&&(this._fire(t.pointerleave,{evt:e,target:this,currentTarget:this}),this._fire(t.pointerout,{evt:e,target:this,currentTarget:this})),this.pointerPos=null,this._pointerPositions=[]}_pointerdown(e){const t=Bt(e.type),i=dn(e.type);if(!t)return;this.setPointersPositions(e);let s=!1;this._changedPointerPositions.forEach(r=>{const a=this.getIntersection(r);if(Le.justDragged=!1,le["_"+i+"ListenClick"]=!0,!a||!a.isListening()){this[i+"ClickStartShape"]=void 0;return}le.capturePointerEventsEnabled&&a.setPointerCapture(r.id),this[i+"ClickStartShape"]=a,a._fireAndBubble(t.pointerdown,{evt:e,pointerId:r.id}),s=!0;const l=e.type.indexOf("touch")>=0;a.preventDefault()&&e.cancelable&&l&&e.preventDefault()}),s||this._fire(t.pointerdown,{evt:e,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id})}_pointermove(e){const t=Bt(e.type),i=dn(e.type);if(!t)return;const s=e.type.indexOf("touch")>=0||e.pointerType==="touch";if(le.isDragging()&&Le.node.preventDefault()&&e.cancelable&&s&&e.preventDefault(),this.setPointersPositions(e),!(!(le.isDragging()||le.isTransforming())||le.hitOnDragEnabled))return;const a={};let l=!1;const o=this._getTargetShape(i);this._changedPointerPositions.forEach(c=>{const d=li(c.id)||this.getIntersection(c),u=c.id,g={evt:e,pointerId:u},v=o!==d;if(v&&o&&(o._fireAndBubble(t.pointerout,{...g},d),o._fireAndBubble(t.pointerleave,{...g},d)),d){if(a[d._id])return;a[d._id]=!0}d&&d.isListening()?(l=!0,v&&(d._fireAndBubble(t.pointerover,{...g},o),d._fireAndBubble(t.pointerenter,{...g},o),this[i+"targetShape"]=d),d._fireAndBubble(t.pointermove,{...g})):o&&(this._fire(t.pointerover,{evt:e,target:this,currentTarget:this,pointerId:u}),this[i+"targetShape"]=null)}),l||this._fire(t.pointermove,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id})}_pointerup(e){const t=Bt(e.type),i=dn(e.type);if(!t)return;this.setPointersPositions(e);const s=this[i+"ClickStartShape"],r=this[i+"ClickEndShape"],a={};let l=!1;this._changedPointerPositions.forEach(o=>{const c=li(o.id)||this.getIntersection(o);if(c){if(c.releaseCapture(o.id),a[c._id])return;a[c._id]=!0}const d=o.id,u={evt:e,pointerId:d};let g=!1;le["_"+i+"InDblClickWindow"]?(g=!0,clearTimeout(this[i+"DblTimeout"])):Le.justDragged||(le["_"+i+"InDblClickWindow"]=!0,clearTimeout(this[i+"DblTimeout"])),this[i+"DblTimeout"]=setTimeout(function(){le["_"+i+"InDblClickWindow"]=!1},le.dblClickWindow),c&&c.isListening()?(l=!0,this[i+"ClickEndShape"]=c,c._fireAndBubble(t.pointerup,{...u}),le["_"+i+"ListenClick"]&&s&&s===c&&(c._fireAndBubble(t.pointerclick,{...u}),g&&r&&r===c&&c._fireAndBubble(t.pointerdblclick,{...u}))):(this[i+"ClickEndShape"]=null,l||(this._fire(t.pointerup,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),l=!0),le["_"+i+"ListenClick"]&&this._fire(t.pointerclick,{evt:e,target:this,currentTarget:this,pointerId:d}),g&&this._fire(t.pointerdblclick,{evt:e,target:this,currentTarget:this,pointerId:d}))}),l||this._fire(t.pointerup,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),le["_"+i+"ListenClick"]=!1,e.cancelable&&i!=="touch"&&i!=="pointer"&&e.preventDefault()}_contextmenu(e){this.setPointersPositions(e);const t=this.getIntersection(this.getPointerPosition());t&&t.isListening()?t._fireAndBubble(Si,{evt:e}):this._fire(Si,{evt:e,target:this,currentTarget:this})}_wheel(e){this.setPointersPositions(e);const t=this.getIntersection(this.getPointerPosition());t&&t.isListening()?t._fireAndBubble(wi,{evt:e}):this._fire(wi,{evt:e,target:this,currentTarget:this})}_pointercancel(e){this.setPointersPositions(e);const t=li(e.pointerId)||this.getIntersection(this.getPointerPosition());t&&t._fireAndBubble(Wt,Oi(e)),hn(e.pointerId)}_lostpointercapture(e){hn(e.pointerId)}setPointersPositions(e){const t=this._getContentPosition();let i=null,s=null;e=e||window.event,e.touches!==void 0?(this._pointerPositions=[],this._changedPointerPositions=[],Array.prototype.forEach.call(e.touches,r=>{this._pointerPositions.push({id:r.identifier,x:(r.clientX-t.left)/t.scaleX,y:(r.clientY-t.top)/t.scaleY})}),Array.prototype.forEach.call(e.changedTouches||e.touches,r=>{this._changedPointerPositions.push({id:r.identifier,x:(r.clientX-t.left)/t.scaleX,y:(r.clientY-t.top)/t.scaleY})})):(i=(e.clientX-t.left)/t.scaleX,s=(e.clientY-t.top)/t.scaleY,this.pointerPos={x:i,y:s},this._pointerPositions=[{x:i,y:s,id:U._getFirstPointerId(e)}],this._changedPointerPositions=[{x:i,y:s,id:U._getFirstPointerId(e)}])}_setPointerPosition(e){U.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.'),this.setPointersPositions(e)}_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect)return{top:0,left:0,scaleX:1,scaleY:1};const e=this.content.getBoundingClientRect();return{top:e.top,left:e.left,scaleX:e.width/this.content.clientWidth||1,scaleY:e.height/this.content.clientHeight||1}}_buildDOM(){if(this.bufferCanvas=new wt({width:this.width(),height:this.height()}),this.bufferHitCanvas=new Mi({pixelRatio:1,width:this.width(),height:this.height()}),!le.isBrowser)return;const e=this.container();if(!e)throw"Stage has no container. A container is required.";e.innerHTML="",this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.userSelect="none",this.content.className="konvajs-content",this.content.setAttribute("role","presentation"),e.appendChild(this.content),this._resizeDOM()}cache(){return U.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes."),this}clearCache(){return this}batchDraw(){return this.getChildren().forEach(function(e){e.batchDraw()}),this}}Kn.prototype.nodeType=yc;Be(Kn);T.addGetterSetter(Kn,"container");le.isBrowser&&document.addEventListener("visibilitychange",()=>{un.forEach(n=>{n.batchDraw()})});const Sr="hasShadow",wr="shadowRGBA",$r="patternImage",Cr="linearGradient",kr="radialGradient";let Rn;function ci(){return Rn||(Rn=U.createCanvasElement().getContext("2d"),Rn)}const gn={};function kc(n){const e=this.attrs.fillRule;e?n.fill(e):n.fill()}function Tc(n){n.stroke()}function Ec(n){const e=this.attrs.fillRule;e?n.fill(e):n.fill()}function Pc(n){n.stroke()}function Ac(){this._clearCache(Sr)}function Rc(){this._clearCache(wr)}function Lc(){this._clearCache($r)}function Mc(){this._clearCache(Cr)}function Dc(){this._clearCache(kr)}class Z extends se{constructor(e){super(e);let t;for(;t=U.getRandomColor(),!(t&&!(t in gn)););this.colorKey=t,gn[t]=this}getContext(){return U.warn("shape.getContext() method is deprecated. Please do not use it."),this.getLayer().getContext()}getCanvas(){return U.warn("shape.getCanvas() method is deprecated. Please do not use it."),this.getLayer().getCanvas()}getSceneFunc(){return this.attrs.sceneFunc||this._sceneFunc}getHitFunc(){return this.attrs.hitFunc||this._hitFunc}hasShadow(){return this._getCache(Sr,this._hasShadow)}_hasShadow(){return this.shadowEnabled()&&this.shadowOpacity()!==0&&!!(this.shadowColor()||this.shadowBlur()||this.shadowOffsetX()||this.shadowOffsetY())}_getFillPattern(){return this._getCache($r,this.__getFillPattern)}__getFillPattern(){if(this.fillPatternImage()){const t=ci().createPattern(this.fillPatternImage(),this.fillPatternRepeat()||"repeat");if(t&&t.setTransform){const i=new Ke;i.translate(this.fillPatternX(),this.fillPatternY()),i.rotate(le.getAngle(this.fillPatternRotation())),i.scale(this.fillPatternScaleX(),this.fillPatternScaleY()),i.translate(-1*this.fillPatternOffsetX(),-1*this.fillPatternOffsetY());const s=i.getMatrix(),r=typeof DOMMatrix>"u"?{a:s[0],b:s[1],c:s[2],d:s[3],e:s[4],f:s[5]}:new DOMMatrix(s);t.setTransform(r)}return t}}_getLinearGradient(){return this._getCache(Cr,this.__getLinearGradient)}__getLinearGradient(){const e=this.fillLinearGradientColorStops();if(e){const t=ci(),i=this.fillLinearGradientStartPoint(),s=this.fillLinearGradientEndPoint(),r=t.createLinearGradient(i.x,i.y,s.x,s.y);for(let a=0;a<e.length;a+=2)r.addColorStop(e[a],e[a+1]);return r}}_getRadialGradient(){return this._getCache(kr,this.__getRadialGradient)}__getRadialGradient(){const e=this.fillRadialGradientColorStops();if(e){const t=ci(),i=this.fillRadialGradientStartPoint(),s=this.fillRadialGradientEndPoint(),r=t.createRadialGradient(i.x,i.y,this.fillRadialGradientStartRadius(),s.x,s.y,this.fillRadialGradientEndRadius());for(let a=0;a<e.length;a+=2)r.addColorStop(e[a],e[a+1]);return r}}getShadowRGBA(){return this._getCache(wr,this._getShadowRGBA)}_getShadowRGBA(){if(!this.hasShadow())return;const e=U.colorToRGBA(this.shadowColor());if(e)return"rgba("+e.r+","+e.g+","+e.b+","+e.a*(this.shadowOpacity()||1)+")"}hasFill(){return this._calculate("hasFill",["fillEnabled","fill","fillPatternImage","fillLinearGradientColorStops","fillRadialGradientColorStops"],()=>this.fillEnabled()&&!!(this.fill()||this.fillPatternImage()||this.fillLinearGradientColorStops()||this.fillRadialGradientColorStops()))}hasStroke(){return this._calculate("hasStroke",["strokeEnabled","strokeWidth","stroke","strokeLinearGradientColorStops"],()=>this.strokeEnabled()&&this.strokeWidth()&&!!(this.stroke()||this.strokeLinearGradientColorStops()))}hasHitStroke(){const e=this.hitStrokeWidth();return e==="auto"?this.hasStroke():this.strokeEnabled()&&!!e}intersects(e){const t=this.getStage();if(!t)return!1;const i=t.bufferHitCanvas;return i.getContext().clear(),this.drawHit(i,void 0,!0),i.context.getImageData(Math.round(e.x),Math.round(e.y),1,1).data[3]>0}destroy(){return se.prototype.destroy.call(this),delete gn[this.colorKey],delete this.colorKey,this}_useBufferCanvas(e){var t;if(!((t=this.attrs.perfectDrawEnabled)!==null&&t!==void 0?t:!0))return!1;const s=e||this.hasFill(),r=this.hasStroke(),a=this.getAbsoluteOpacity()!==1;if(s&&r&&a)return!0;const l=this.hasShadow(),o=this.shadowForStrokeEnabled();return!!(s&&r&&l&&o)}setStrokeHitEnabled(e){U.warn("strokeHitEnabled property is deprecated. Please use hitStrokeWidth instead."),e?this.hitStrokeWidth("auto"):this.hitStrokeWidth(0)}getStrokeHitEnabled(){return this.hitStrokeWidth()!==0}getSelfRect(){const e=this.size();return{x:this._centroid?-e.width/2:0,y:this._centroid?-e.height/2:0,width:e.width,height:e.height}}getClientRect(e={}){let t=!1,i=this.getParent();for(;i;){if(i.isCached()){t=!0;break}i=i.getParent()}const s=e.skipTransform,r=e.relativeTo||t&&this.getStage()||void 0,a=this.getSelfRect(),o=!e.skipStroke&&this.hasStroke()&&this.strokeWidth()||0,c=a.width+o,d=a.height+o,u=!e.skipShadow&&this.hasShadow(),g=u?this.shadowOffsetX():0,v=u?this.shadowOffsetY():0,h=c+Math.abs(g),p=d+Math.abs(v),b=u&&this.shadowBlur()||0,m=h+b*2,y=p+b*2,$={width:m,height:y,x:-(o/2+b)+Math.min(g,0)+a.x,y:-(o/2+b)+Math.min(v,0)+a.y};return s?$:this._transformedRect($,r)}drawScene(e,t,i){const s=this.getLayer(),r=e||s.getCanvas(),a=r.getContext(),l=this._getCanvasCache(),o=this.getSceneFunc(),c=this.hasShadow();let d;const u=t===this;if(!this.isVisible()&&!u)return this;if(l){a.save();const g=this.getAbsoluteTransform(t).getMatrix();return a.transform(g[0],g[1],g[2],g[3],g[4],g[5]),this._drawCachedSceneCanvas(a),a.restore(),this}if(!o)return this;if(a.save(),this._useBufferCanvas()){d=this.getStage();const g=i||d.bufferCanvas,v=g.getContext();v.clear(),v.save(),v._applyLineJoin(this),v._applyMiterLimit(this);const h=this.getAbsoluteTransform(t).getMatrix();v.transform(h[0],h[1],h[2],h[3],h[4],h[5]),o.call(this,v,this),v.restore();const p=g.pixelRatio;c&&a._applyShadow(this),a._applyOpacity(this),a._applyGlobalCompositeOperation(this),a.drawImage(g._canvas,g.x||0,g.y||0,g.width/p,g.height/p)}else{if(a._applyLineJoin(this),a._applyMiterLimit(this),!u){const g=this.getAbsoluteTransform(t).getMatrix();a.transform(g[0],g[1],g[2],g[3],g[4],g[5]),a._applyOpacity(this),a._applyGlobalCompositeOperation(this)}c&&a._applyShadow(this),o.call(this,a,this)}return a.restore(),this}drawHit(e,t,i=!1){if(!this.shouldDrawHit(t,i))return this;const s=this.getLayer(),r=e||s.hitCanvas,a=r&&r.getContext(),l=this.hitFunc()||this.sceneFunc(),o=this._getCanvasCache(),c=o&&o.hit;if(this.colorKey||U.warn("Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()"),c){a.save();const u=this.getAbsoluteTransform(t).getMatrix();return a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),this._drawCachedHitCanvas(a),a.restore(),this}if(!l)return this;if(a.save(),a._applyLineJoin(this),a._applyMiterLimit(this),!(this===t)){const u=this.getAbsoluteTransform(t).getMatrix();a.transform(u[0],u[1],u[2],u[3],u[4],u[5])}return l.call(this,a,this),a.restore(),this}drawHitFromCache(e=0){const t=this._getCanvasCache(),i=this._getCachedSceneCanvas(),s=t.hit,r=s.getContext(),a=s.getWidth(),l=s.getHeight();r.clear(),r.drawImage(i._canvas,0,0,a,l);try{const o=r.getImageData(0,0,a,l),c=o.data,d=c.length,u=U._hexToRgb(this.colorKey);for(let g=0;g<d;g+=4)c[g+3]>e?(c[g]=u.r,c[g+1]=u.g,c[g+2]=u.b,c[g+3]=255):c[g+3]=0;r.putImageData(o,0,0)}catch(o){U.error("Unable to draw hit graph from cached scene canvas. "+o.message)}return this}hasPointerCapture(e){return dr(e,this)}setPointerCapture(e){hr(e,this)}releaseCapture(e){hn(e)}}Z.prototype._fillFunc=kc;Z.prototype._strokeFunc=Tc;Z.prototype._fillFuncHit=Ec;Z.prototype._strokeFuncHit=Pc;Z.prototype._centroid=!1;Z.prototype.nodeType="Shape";Be(Z);Z.prototype.eventListeners={};Z.prototype.on.call(Z.prototype,"shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",Ac);Z.prototype.on.call(Z.prototype,"shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",Rc);Z.prototype.on.call(Z.prototype,"fillPriorityChange.konva fillPatternImageChange.konva fillPatternRepeatChange.konva fillPatternScaleXChange.konva fillPatternScaleYChange.konva fillPatternOffsetXChange.konva fillPatternOffsetYChange.konva fillPatternXChange.konva fillPatternYChange.konva fillPatternRotationChange.konva",Lc);Z.prototype.on.call(Z.prototype,"fillPriorityChange.konva fillLinearGradientColorStopsChange.konva fillLinearGradientStartPointXChange.konva fillLinearGradientStartPointYChange.konva fillLinearGradientEndPointXChange.konva fillLinearGradientEndPointYChange.konva",Mc);Z.prototype.on.call(Z.prototype,"fillPriorityChange.konva fillRadialGradientColorStopsChange.konva fillRadialGradientStartPointXChange.konva fillRadialGradientStartPointYChange.konva fillRadialGradientEndPointXChange.konva fillRadialGradientEndPointYChange.konva fillRadialGradientStartRadiusChange.konva fillRadialGradientEndRadiusChange.konva",Dc);T.addGetterSetter(Z,"stroke",void 0,or());T.addGetterSetter(Z,"strokeWidth",2,re());T.addGetterSetter(Z,"fillAfterStrokeEnabled",!1);T.addGetterSetter(Z,"hitStrokeWidth","auto",Di());T.addGetterSetter(Z,"strokeHitEnabled",!0,lt());T.addGetterSetter(Z,"perfectDrawEnabled",!0,lt());T.addGetterSetter(Z,"shadowForStrokeEnabled",!0,lt());T.addGetterSetter(Z,"lineJoin");T.addGetterSetter(Z,"lineCap");T.addGetterSetter(Z,"miterLimit");T.addGetterSetter(Z,"sceneFunc");T.addGetterSetter(Z,"hitFunc");T.addGetterSetter(Z,"dash");T.addGetterSetter(Z,"dashOffset",0,re());T.addGetterSetter(Z,"shadowColor",void 0,Ot());T.addGetterSetter(Z,"shadowBlur",0,re());T.addGetterSetter(Z,"shadowOpacity",1,re());T.addComponentsGetterSetter(Z,"shadowOffset",["x","y"]);T.addGetterSetter(Z,"shadowOffsetX",0,re());T.addGetterSetter(Z,"shadowOffsetY",0,re());T.addGetterSetter(Z,"fillPatternImage");T.addGetterSetter(Z,"fill",void 0,or());T.addGetterSetter(Z,"fillPatternX",0,re());T.addGetterSetter(Z,"fillPatternY",0,re());T.addGetterSetter(Z,"fillLinearGradientColorStops");T.addGetterSetter(Z,"strokeLinearGradientColorStops");T.addGetterSetter(Z,"fillRadialGradientStartRadius",0);T.addGetterSetter(Z,"fillRadialGradientEndRadius",0);T.addGetterSetter(Z,"fillRadialGradientColorStops");T.addGetterSetter(Z,"fillPatternRepeat","repeat");T.addGetterSetter(Z,"fillEnabled",!0);T.addGetterSetter(Z,"strokeEnabled",!0);T.addGetterSetter(Z,"shadowEnabled",!0);T.addGetterSetter(Z,"dashEnabled",!0);T.addGetterSetter(Z,"strokeScaleEnabled",!0);T.addGetterSetter(Z,"fillPriority","color");T.addComponentsGetterSetter(Z,"fillPatternOffset",["x","y"]);T.addGetterSetter(Z,"fillPatternOffsetX",0,re());T.addGetterSetter(Z,"fillPatternOffsetY",0,re());T.addComponentsGetterSetter(Z,"fillPatternScale",["x","y"]);T.addGetterSetter(Z,"fillPatternScaleX",1,re());T.addGetterSetter(Z,"fillPatternScaleY",1,re());T.addComponentsGetterSetter(Z,"fillLinearGradientStartPoint",["x","y"]);T.addComponentsGetterSetter(Z,"strokeLinearGradientStartPoint",["x","y"]);T.addGetterSetter(Z,"fillLinearGradientStartPointX",0);T.addGetterSetter(Z,"strokeLinearGradientStartPointX",0);T.addGetterSetter(Z,"fillLinearGradientStartPointY",0);T.addGetterSetter(Z,"strokeLinearGradientStartPointY",0);T.addComponentsGetterSetter(Z,"fillLinearGradientEndPoint",["x","y"]);T.addComponentsGetterSetter(Z,"strokeLinearGradientEndPoint",["x","y"]);T.addGetterSetter(Z,"fillLinearGradientEndPointX",0);T.addGetterSetter(Z,"strokeLinearGradientEndPointX",0);T.addGetterSetter(Z,"fillLinearGradientEndPointY",0);T.addGetterSetter(Z,"strokeLinearGradientEndPointY",0);T.addComponentsGetterSetter(Z,"fillRadialGradientStartPoint",["x","y"]);T.addGetterSetter(Z,"fillRadialGradientStartPointX",0);T.addGetterSetter(Z,"fillRadialGradientStartPointY",0);T.addComponentsGetterSetter(Z,"fillRadialGradientEndPoint",["x","y"]);T.addGetterSetter(Z,"fillRadialGradientEndPointX",0);T.addGetterSetter(Z,"fillRadialGradientEndPointY",0);T.addGetterSetter(Z,"fillPatternRotation",0);T.addGetterSetter(Z,"fillRule",void 0,Ot());T.backCompat(Z,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"});const Oc="#",Ic="beforeDraw",Nc="draw",Tr=[{x:0,y:0},{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],zc=Tr.length;class It extends et{constructor(e){super(e),this.canvas=new wt,this.hitCanvas=new Mi({pixelRatio:1}),this._waitingForDraw=!1,this.on("visibleChange.konva",this._checkVisibility),this._checkVisibility(),this.on("imageSmoothingEnabledChange.konva",this._setSmoothEnabled),this._setSmoothEnabled()}createPNGStream(){return this.canvas._canvas.createPNGStream()}getCanvas(){return this.canvas}getNativeCanvasElement(){return this.canvas._canvas}getHitCanvas(){return this.hitCanvas}getContext(){return this.getCanvas().getContext()}clear(e){return this.getContext().clear(e),this.getHitCanvas().getContext().clear(e),this}setZIndex(e){super.setZIndex(e);const t=this.getStage();return t&&t.content&&(t.content.removeChild(this.getNativeCanvasElement()),e<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[e+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement())),this}moveToTop(){se.prototype.moveToTop.call(this);const e=this.getStage();return e&&e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.appendChild(this.getNativeCanvasElement())),!0}moveUp(){if(!se.prototype.moveUp.call(this))return!1;const t=this.getStage();return!t||!t.content?!1:(t.content.removeChild(this.getNativeCanvasElement()),this.index<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[this.index+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement()),!0)}moveDown(){if(se.prototype.moveDown.call(this)){const e=this.getStage();if(e){const t=e.children;e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.insertBefore(this.getNativeCanvasElement(),t[this.index+1].getCanvas()._canvas))}return!0}return!1}moveToBottom(){if(se.prototype.moveToBottom.call(this)){const e=this.getStage();if(e){const t=e.children;e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.insertBefore(this.getNativeCanvasElement(),t[1].getCanvas()._canvas))}return!0}return!1}getLayer(){return this}remove(){const e=this.getNativeCanvasElement();return se.prototype.remove.call(this),e&&e.parentNode&&U._isInDocument(e)&&e.parentNode.removeChild(e),this}getStage(){return this.parent}setSize({width:e,height:t}){return this.canvas.setSize(e,t),this.hitCanvas.setSize(e,t),this._setSmoothEnabled(),this}_validateAdd(e){const t=e.getType();t!=="Group"&&t!=="Shape"&&U.throw("You may only add groups and shapes to a layer.")}_toKonvaCanvas(e){return e={...e},e.width=e.width||this.getWidth(),e.height=e.height||this.getHeight(),e.x=e.x!==void 0?e.x:this.x(),e.y=e.y!==void 0?e.y:this.y(),se.prototype._toKonvaCanvas.call(this,e)}_checkVisibility(){this.visible()?this.canvas._canvas.style.display="block":this.canvas._canvas.style.display="none"}_setSmoothEnabled(){this.getContext()._context.imageSmoothingEnabled=this.imageSmoothingEnabled()}getWidth(){if(this.parent)return this.parent.width()}setWidth(){U.warn('Can not change width of layer. Use "stage.width(value)" function instead.')}getHeight(){if(this.parent)return this.parent.height()}setHeight(){U.warn('Can not change height of layer. Use "stage.height(value)" function instead.')}batchDraw(){return this._waitingForDraw||(this._waitingForDraw=!0,U.requestAnimFrame(()=>{this.draw(),this._waitingForDraw=!1})),this}getIntersection(e){if(!this.isListening()||!this.isVisible())return null;let t=1,i=!1;for(;;){for(let s=0;s<zc;s++){const r=Tr[s],a=this._getIntersection({x:e.x+r.x*t,y:e.y+r.y*t}),l=a.shape;if(l)return l;if(i=!!a.antialiased,!a.antialiased)break}if(i)t+=1;else return null}}_getIntersection(e){const t=this.hitCanvas.pixelRatio,i=this.hitCanvas.context.getImageData(Math.round(e.x*t),Math.round(e.y*t),1,1).data,s=i[3];if(s===255){const r=U._rgbToHex(i[0],i[1],i[2]),a=gn[Oc+r];return a?{shape:a}:{antialiased:!0}}else if(s>0)return{antialiased:!0};return{}}drawScene(e,t,i){const s=this.getLayer(),r=e||s&&s.getCanvas();return this._fire(Ic,{node:this}),this.clearBeforeDraw()&&r.getContext().clear(),et.prototype.drawScene.call(this,r,t,i),this._fire(Nc,{node:this}),this}drawHit(e,t){const i=this.getLayer(),s=e||i&&i.hitCanvas;return i&&i.clearBeforeDraw()&&i.getHitCanvas().getContext().clear(),et.prototype.drawHit.call(this,s,t),this}enableHitGraph(){return this.hitGraphEnabled(!0),this}disableHitGraph(){return this.hitGraphEnabled(!1),this}setHitGraphEnabled(e){U.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening(e)}getHitGraphEnabled(e){return U.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening()}toggleHitCanvas(){if(!this.parent||!this.parent.content)return;const e=this.parent;!!this.hitCanvas._canvas.parentNode?e.content.removeChild(this.hitCanvas._canvas):e.content.appendChild(this.hitCanvas._canvas)}destroy(){return U.releaseCanvas(this.getNativeCanvasElement(),this.getHitCanvas()._canvas),super.destroy()}}It.prototype.nodeType="Layer";Be(It);T.addGetterSetter(It,"imageSmoothingEnabled",!0);T.addGetterSetter(It,"clearBeforeDraw",!0);T.addGetterSetter(It,"hitGraphEnabled",!0,lt());class Ii extends It{constructor(e){super(e),this.listening(!1),U.warn('Konva.Fast layer is deprecated. Please use "new Konva.Layer({ listening: false })" instead.')}}Ii.prototype.nodeType="FastLayer";Be(Ii);class Yt extends et{_validateAdd(e){const t=e.getType();t!=="Group"&&t!=="Shape"&&U.throw("You may only add groups and shapes to groups.")}}Yt.prototype.nodeType="Group";Be(Yt);const di=function(){return Lt.performance&&Lt.performance.now?function(){return Lt.performance.now()}:function(){return new Date().getTime()}}();class nt{constructor(e,t){this.id=nt.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:di(),frameRate:0},this.func=e,this.setLayers(t)}setLayers(e){let t=[];return e&&(t=Array.isArray(e)?e:[e]),this.layers=t,this}getLayers(){return this.layers}addLayer(e){const t=this.layers,i=t.length;for(let s=0;s<i;s++)if(t[s]._id===e._id)return!1;return this.layers.push(e),!0}isRunning(){const t=nt.animations,i=t.length;for(let s=0;s<i;s++)if(t[s].id===this.id)return!0;return!1}start(){return this.stop(),this.frame.timeDiff=0,this.frame.lastTime=di(),nt._addAnimation(this),this}stop(){return nt._removeAnimation(this),this}_updateFrameObject(e){this.frame.timeDiff=e-this.frame.lastTime,this.frame.lastTime=e,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}static _addAnimation(e){this.animations.push(e),this._handleAnimation()}static _removeAnimation(e){const t=e.id,i=this.animations,s=i.length;for(let r=0;r<s;r++)if(i[r].id===t){this.animations.splice(r,1);break}}static _runFrames(){const e={},t=this.animations;for(let i=0;i<t.length;i++){const s=t[i],r=s.layers,a=s.func;s._updateFrameObject(di());const l=r.length;let o;if(a?o=a.call(s,s.frame)!==!1:o=!0,!!o)for(let c=0;c<l;c++){const d=r[c];d._id!==void 0&&(e[d._id]=d)}}for(const i in e)e.hasOwnProperty(i)&&e[i].batchDraw()}static _animationLoop(){const e=nt;e.animations.length?(e._runFrames(),U.requestAnimFrame(e._animationLoop)):e.animRunning=!1}static _handleAnimation(){this.animRunning||(this.animRunning=!0,U.requestAnimFrame(this._animationLoop))}}nt.animations=[];nt.animIdCounter=0;nt.animRunning=!1;const Fc={node:1,duration:1,easing:1,onFinish:1,yoyo:1},Gc=1,hs=2,us=3,gs=["fill","stroke","shadowColor"];let Bc=0;class Uc{constructor(e,t,i,s,r,a,l){this.prop=e,this.propFunc=t,this.begin=s,this._pos=s,this.duration=a,this._change=0,this.prevPos=0,this.yoyo=l,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=i,this._change=r-this.begin,this.pause()}fire(e){const t=this[e];t&&t()}setTime(e){e>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():e<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=e,this.update())}getTime(){return this._time}setPosition(e){this.prevPos=this._pos,this.propFunc(e),this._pos=e}getPosition(e){return e===void 0&&(e=this._time),this.func(e,this.begin,this._change,this.duration)}play(){this.state=hs,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")}reverse(){this.state=us,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")}seek(e){this.pause(),this._time=e,this.update(),this.fire("onSeek")}reset(){this.pause(),this._time=0,this.update(),this.fire("onReset")}finish(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")}update(){this.setPosition(this.getPosition(this._time)),this.fire("onUpdate")}onEnterFrame(){const e=this.getTimer()-this._startTime;this.state===hs?this.setTime(e):this.state===us&&this.setTime(this.duration-e)}pause(){this.state=Gc,this.fire("onPause")}getTimer(){return new Date().getTime()}}class Ne{constructor(e){const t=this,i=e.node,s=i._id,r=e.easing||fn.Linear,a=!!e.yoyo;let l,o;typeof e.duration>"u"?l=.3:e.duration===0?l=.001:l=e.duration,this.node=i,this._id=Bc++;const c=i.getLayer()||(i instanceof le.Stage?i.getLayers():null);c||U.error("Tween constructor have `node` that is not in a layer. Please add node into layer first."),this.anim=new nt(function(){t.tween.onEnterFrame()},c),this.tween=new Uc(o,function(d){t._tweenFunc(d)},r,0,1,l*1e3,a),this._addListeners(),Ne.attrs[s]||(Ne.attrs[s]={}),Ne.attrs[s][this._id]||(Ne.attrs[s][this._id]={}),Ne.tweens[s]||(Ne.tweens[s]={});for(o in e)Fc[o]===void 0&&this._addAttr(o,e[o]);this.reset(),this.onFinish=e.onFinish,this.onReset=e.onReset,this.onUpdate=e.onUpdate}_addAttr(e,t){const i=this.node,s=i._id;let r,a,l,o,c;const d=Ne.tweens[s][e];d&&delete Ne.attrs[s][d][e];let u=i.getAttr(e);if(U._isArray(t))if(r=[],a=Math.max(t.length,u.length),e==="points"&&t.length!==u.length&&(t.length>u.length?(o=u,u=U._prepareArrayForTween(u,t,i.closed())):(l=t,t=U._prepareArrayForTween(t,u,i.closed()))),e.indexOf("fill")===0)for(let g=0;g<a;g++)if(g%2===0)r.push(t[g]-u[g]);else{const v=U.colorToRGBA(u[g]);c=U.colorToRGBA(t[g]),u[g]=v,r.push({r:c.r-v.r,g:c.g-v.g,b:c.b-v.b,a:c.a-v.a})}else for(let g=0;g<a;g++)r.push(t[g]-u[g]);else gs.indexOf(e)!==-1?(u=U.colorToRGBA(u),c=U.colorToRGBA(t),r={r:c.r-u.r,g:c.g-u.g,b:c.b-u.b,a:c.a-u.a}):r=t-u;Ne.attrs[s][this._id][e]={start:u,diff:r,end:t,trueEnd:l,trueStart:o},Ne.tweens[s][e]=this._id}_tweenFunc(e){const t=this.node,i=Ne.attrs[t._id][this._id];let s,r,a,l,o,c,d,u;for(s in i){if(r=i[s],a=r.start,l=r.diff,u=r.end,U._isArray(a))if(o=[],d=Math.max(a.length,u.length),s.indexOf("fill")===0)for(c=0;c<d;c++)c%2===0?o.push((a[c]||0)+l[c]*e):o.push("rgba("+Math.round(a[c].r+l[c].r*e)+","+Math.round(a[c].g+l[c].g*e)+","+Math.round(a[c].b+l[c].b*e)+","+(a[c].a+l[c].a*e)+")");else for(c=0;c<d;c++)o.push((a[c]||0)+l[c]*e);else gs.indexOf(s)!==-1?o="rgba("+Math.round(a.r+l.r*e)+","+Math.round(a.g+l.g*e)+","+Math.round(a.b+l.b*e)+","+(a.a+l.a*e)+")":o=a+l*e;t.setAttr(s,o)}}_addListeners(){this.tween.onPlay=()=>{this.anim.start()},this.tween.onReverse=()=>{this.anim.start()},this.tween.onPause=()=>{this.anim.stop()},this.tween.onFinish=()=>{const e=this.node,t=Ne.attrs[e._id][this._id];t.points&&t.points.trueEnd&&e.setAttr("points",t.points.trueEnd),this.onFinish&&this.onFinish.call(this)},this.tween.onReset=()=>{const e=this.node,t=Ne.attrs[e._id][this._id];t.points&&t.points.trueStart&&e.points(t.points.trueStart),this.onReset&&this.onReset()},this.tween.onUpdate=()=>{this.onUpdate&&this.onUpdate.call(this)}}play(){return this.tween.play(),this}reverse(){return this.tween.reverse(),this}reset(){return this.tween.reset(),this}seek(e){return this.tween.seek(e*1e3),this}pause(){return this.tween.pause(),this}finish(){return this.tween.finish(),this}destroy(){const e=this.node._id,t=this._id,i=Ne.tweens[e];this.pause(),this.anim&&this.anim.stop();for(const s in i)delete Ne.tweens[e][s];delete Ne.attrs[e][t],Ne.tweens[e]&&(Object.keys(Ne.tweens[e]).length===0&&delete Ne.tweens[e],Object.keys(Ne.attrs[e]).length===0&&delete Ne.attrs[e])}}Ne.attrs={};Ne.tweens={};se.prototype.to=function(n){const e=n.onFinish;n.node=this,n.onFinish=function(){this.destroy(),e&&e()},new Ne(n).play()};const fn={BackEaseIn(n,e,t,i){return t*(n/=i)*n*((1.70158+1)*n-1.70158)+e},BackEaseOut(n,e,t,i){return t*((n=n/i-1)*n*((1.70158+1)*n+1.70158)+1)+e},BackEaseInOut(n,e,t,i){let s=1.70158;return(n/=i/2)<1?t/2*(n*n*(((s*=1.525)+1)*n-s))+e:t/2*((n-=2)*n*(((s*=1.525)+1)*n+s)+2)+e},ElasticEaseIn(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i)===1?e+t:(r||(r=i*.3),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),-(s*Math.pow(2,10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r))+e)},ElasticEaseOut(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i)===1?e+t:(r||(r=i*.3),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),s*Math.pow(2,-10*n)*Math.sin((n*i-a)*(2*Math.PI)/r)+t+e)},ElasticEaseInOut(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i/2)===2?e+t:(r||(r=i*(.3*1.5)),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),n<1?-.5*(s*Math.pow(2,10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r))+e:s*Math.pow(2,-10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r)*.5+t+e)},BounceEaseOut(n,e,t,i){return(n/=i)<1/2.75?t*(7.5625*n*n)+e:n<2/2.75?t*(7.5625*(n-=1.5/2.75)*n+.75)+e:n<2.5/2.75?t*(7.5625*(n-=2.25/2.75)*n+.9375)+e:t*(7.5625*(n-=2.625/2.75)*n+.984375)+e},BounceEaseIn(n,e,t,i){return t-fn.BounceEaseOut(i-n,0,t,i)+e},BounceEaseInOut(n,e,t,i){return n<i/2?fn.BounceEaseIn(n*2,0,t,i)*.5+e:fn.BounceEaseOut(n*2-i,0,t,i)*.5+t*.5+e},EaseIn(n,e,t,i){return t*(n/=i)*n+e},EaseOut(n,e,t,i){return-t*(n/=i)*(n-2)+e},EaseInOut(n,e,t,i){return(n/=i/2)<1?t/2*n*n+e:-t/2*(--n*(n-2)-1)+e},StrongEaseIn(n,e,t,i){return t*(n/=i)*n*n*n*n+e},StrongEaseOut(n,e,t,i){return t*((n=n/i-1)*n*n*n*n+1)+e},StrongEaseInOut(n,e,t,i){return(n/=i/2)<1?t/2*n*n*n*n*n+e:t/2*((n-=2)*n*n*n*n+2)+e},Linear(n,e,t,i){return t*n/i+e}},fs=U._assign(le,{Util:U,Transform:Ke,Node:se,Container:et,Stage:Kn,stages:un,Layer:It,FastLayer:Ii,Group:Yt,DD:Le,Shape:Z,shapes:gn,Animation:nt,Tween:Ne,Easings:fn,Context:Qn,Canvas:Li});class mt extends Z{_sceneFunc(e){const t=le.getAngle(this.angle()),i=this.clockwise();e.beginPath(),e.arc(0,0,this.outerRadius(),0,t,i),e.arc(0,0,this.innerRadius(),t,0,!i),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}getSelfRect(){const e=this.innerRadius(),t=this.outerRadius(),i=this.clockwise(),s=le.getAngle(i?360-this.angle():this.angle()),r=Math.cos(Math.min(s,Math.PI)),a=1,l=Math.sin(Math.min(Math.max(Math.PI,s),3*Math.PI/2)),o=Math.sin(Math.min(s,Math.PI/2)),c=r*(r>0?e:t),d=a*t,u=l*(l>0?e:t),g=o*(o>0?t:e);return{x:c,y:i?-1*g:u,width:d-c,height:g-u}}}mt.prototype._centroid=!0;mt.prototype.className="Arc";mt.prototype._attrsAffectingSize=["innerRadius","outerRadius","angle","clockwise"];Be(mt);T.addGetterSetter(mt,"innerRadius",0,re());T.addGetterSetter(mt,"outerRadius",0,re());T.addGetterSetter(mt,"angle",0,re());T.addGetterSetter(mt,"clockwise",!1,lt());function $i(n,e,t,i,s,r,a){const l=Math.sqrt(Math.pow(t-n,2)+Math.pow(i-e,2)),o=Math.sqrt(Math.pow(s-t,2)+Math.pow(r-i,2)),c=a*l/(l+o),d=a*o/(l+o),u=t-c*(s-n),g=i-c*(r-e),v=t+d*(s-n),h=i+d*(r-e);return[u,g,v,h]}function vs(n,e){const t=n.length,i=[];for(let s=2;s<t-2;s+=2){const r=$i(n[s-2],n[s-1],n[s],n[s+1],n[s+2],n[s+3],e);isNaN(r[0])||(i.push(r[0]),i.push(r[1]),i.push(n[s]),i.push(n[s+1]),i.push(r[2]),i.push(r[3]))}return i}class bt extends Z{constructor(e){super(e),this.on("pointsChange.konva tensionChange.konva closedChange.konva bezierChange.konva",function(){this._clearCache("tensionPoints")})}_sceneFunc(e){const t=this.points(),i=t.length,s=this.tension(),r=this.closed(),a=this.bezier();if(!i)return;let l=0;if(e.beginPath(),e.moveTo(t[0],t[1]),s!==0&&i>4){const o=this.getTensionPoints(),c=o.length;for(l=r?0:4,r||e.quadraticCurveTo(o[0],o[1],o[2],o[3]);l<c-2;)e.bezierCurveTo(o[l++],o[l++],o[l++],o[l++],o[l++],o[l++]);r||e.quadraticCurveTo(o[c-2],o[c-1],t[i-2],t[i-1])}else if(a)for(l=2;l<i;)e.bezierCurveTo(t[l++],t[l++],t[l++],t[l++],t[l++],t[l++]);else for(l=2;l<i;l+=2)e.lineTo(t[l],t[l+1]);r?(e.closePath(),e.fillStrokeShape(this)):e.strokeShape(this)}getTensionPoints(){return this._getCache("tensionPoints",this._getTensionPoints)}_getTensionPoints(){return this.closed()?this._getTensionPointsClosed():vs(this.points(),this.tension())}_getTensionPointsClosed(){const e=this.points(),t=e.length,i=this.tension(),s=$i(e[t-2],e[t-1],e[0],e[1],e[2],e[3],i),r=$i(e[t-4],e[t-3],e[t-2],e[t-1],e[0],e[1],i),a=vs(e,i);return[s[2],s[3]].concat(a).concat([r[0],r[1],e[t-2],e[t-1],r[2],r[3],s[0],s[1],e[0],e[1]])}getWidth(){return this.getSelfRect().width}getHeight(){return this.getSelfRect().height}getSelfRect(){let e=this.points();if(e.length<4)return{x:e[0]||0,y:e[1]||0,width:0,height:0};this.tension()!==0?e=[e[0],e[1],...this._getTensionPoints(),e[e.length-2],e[e.length-1]]:e=this.points();let t=e[0],i=e[0],s=e[1],r=e[1],a,l;for(let o=0;o<e.length/2;o++)a=e[o*2],l=e[o*2+1],t=Math.min(t,a),i=Math.max(i,a),s=Math.min(s,l),r=Math.max(r,l);return{x:t,y:s,width:i-t,height:r-s}}}bt.prototype.className="Line";bt.prototype._attrsAffectingSize=["points","bezier","tension"];Be(bt);T.addGetterSetter(bt,"closed",!1);T.addGetterSetter(bt,"bezier",!1);T.addGetterSetter(bt,"tension",0,re());T.addGetterSetter(bt,"points",[],sc());const Hc=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],qc=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],Wc=[[1],[1,1],[1,2,1],[1,3,3,1]],ps=(n,e,t)=>{let i,s;const a=t/2;i=0;for(let l=0;l<20;l++)s=a*Hc[20][l]+a,i+=qc[20][l]*jc(n,e,s);return a*i},ms=(n,e,t)=>{t===void 0&&(t=1);const i=n[0]-2*n[1]+n[2],s=e[0]-2*e[1]+e[2],r=2*n[1]-2*n[0],a=2*e[1]-2*e[0],l=4*(i*i+s*s),o=4*(i*r+s*a),c=r*r+a*a;if(l===0)return t*Math.sqrt(Math.pow(n[2]-n[0],2)+Math.pow(e[2]-e[0],2));const d=o/(2*l),u=c/l,g=t+d,v=u-d*d,h=g*g+v>0?Math.sqrt(g*g+v):0,p=d*d+v>0?Math.sqrt(d*d+v):0,b=d+Math.sqrt(d*d+v)!==0?v*Math.log(Math.abs((g+h)/(d+p))):0;return Math.sqrt(l)/2*(g*h-d*p+b)};function jc(n,e,t){const i=Ci(1,t,n),s=Ci(1,t,e),r=i*i+s*s;return Math.sqrt(r)}const Ci=(n,e,t)=>{const i=t.length-1;let s,r;if(i===0)return 0;if(n===0){r=0;for(let a=0;a<=i;a++)r+=Wc[i][a]*Math.pow(1-e,i-a)*Math.pow(e,a)*t[a];return r}else{s=new Array(i);for(let a=0;a<i;a++)s[a]=i*(t[a+1]-t[a]);return Ci(n-1,e,s)}},bs=(n,e,t)=>{let i=1,s=n/e,r=(n-t(s))/e,a=0;for(;i>.001;){const l=t(s+r),o=Math.abs(n-l)/e;if(o<i)i=o,s+=r;else{const c=t(s-r),d=Math.abs(n-c)/e;d<i?(i=d,s-=r):r/=2}if(a++,a>500)break}return s};class ze extends Z{constructor(e){super(e),this.dataArray=[],this.pathLength=0,this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute()})}_readDataAttribute(){this.dataArray=ze.parsePathData(this.data()),this.pathLength=ze.getPathLength(this.dataArray)}_sceneFunc(e){const t=this.dataArray;e.beginPath();let i=!1;for(let s=0;s<t.length;s++){const r=t[s].command,a=t[s].points;switch(r){case"L":e.lineTo(a[0],a[1]);break;case"M":e.moveTo(a[0],a[1]);break;case"C":e.bezierCurveTo(a[0],a[1],a[2],a[3],a[4],a[5]);break;case"Q":e.quadraticCurveTo(a[0],a[1],a[2],a[3]);break;case"A":const l=a[0],o=a[1],c=a[2],d=a[3],u=a[4],g=a[5],v=a[6],h=a[7],p=c>d?c:d,b=c>d?1:c/d,m=c>d?d/c:1;e.translate(l,o),e.rotate(v),e.scale(b,m),e.arc(0,0,p,u,u+g,1-h),e.scale(1/b,1/m),e.rotate(-v),e.translate(-l,-o);break;case"z":i=!0,e.closePath();break}}!i&&!this.hasFill()?e.strokeShape(this):e.fillStrokeShape(this)}getSelfRect(){let e=[];this.dataArray.forEach(function(o){if(o.command==="A"){const c=o.points[4],d=o.points[5],u=o.points[4]+d;let g=Math.PI/180;if(Math.abs(c-u)<g&&(g=Math.abs(c-u)),d<0)for(let v=c-g;v>u;v-=g){const h=ze.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],v,0);e.push(h.x,h.y)}else for(let v=c+g;v<u;v+=g){const h=ze.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],v,0);e.push(h.x,h.y)}}else if(o.command==="C")for(let c=0;c<=1;c+=.01){const d=ze.getPointOnCubicBezier(c,o.start.x,o.start.y,o.points[0],o.points[1],o.points[2],o.points[3],o.points[4],o.points[5]);e.push(d.x,d.y)}else e=e.concat(o.points)});let t=e[0],i=e[0],s=e[1],r=e[1],a,l;for(let o=0;o<e.length/2;o++)a=e[o*2],l=e[o*2+1],isNaN(a)||(t=Math.min(t,a),i=Math.max(i,a)),isNaN(l)||(s=Math.min(s,l),r=Math.max(r,l));return{x:t,y:s,width:i-t,height:r-s}}getLength(){return this.pathLength}getPointAtLength(e){return ze.getPointAtLengthOfDataArray(e,this.dataArray)}static getLineLength(e,t,i,s){return Math.sqrt((i-e)*(i-e)+(s-t)*(s-t))}static getPathLength(e){let t=0;for(let i=0;i<e.length;++i)t+=e[i].pathLength;return t}static getPointAtLengthOfDataArray(e,t){let i,s=0,r=t.length;if(!r)return null;for(;s<r&&e>t[s].pathLength;)e-=t[s].pathLength,++s;if(s===r)return i=t[s-1].points.slice(-2),{x:i[0],y:i[1]};if(e<.01)return t[s].command==="M"?(i=t[s].points.slice(0,2),{x:i[0],y:i[1]}):{x:t[s].start.x,y:t[s].start.y};const a=t[s],l=a.points;switch(a.command){case"L":return ze.getPointOnLine(e,a.start.x,a.start.y,l[0],l[1]);case"C":return ze.getPointOnCubicBezier(bs(e,ze.getPathLength(t),p=>ps([a.start.x,l[0],l[2],l[4]],[a.start.y,l[1],l[3],l[5]],p)),a.start.x,a.start.y,l[0],l[1],l[2],l[3],l[4],l[5]);case"Q":return ze.getPointOnQuadraticBezier(bs(e,ze.getPathLength(t),p=>ms([a.start.x,l[0],l[2]],[a.start.y,l[1],l[3]],p)),a.start.x,a.start.y,l[0],l[1],l[2],l[3]);case"A":const o=l[0],c=l[1],d=l[2],u=l[3],g=l[5],v=l[6];let h=l[4];return h+=g*e/a.pathLength,ze.getPointOnEllipticalArc(o,c,d,u,h,v)}return null}static getPointOnLine(e,t,i,s,r,a,l){a=a??t,l=l??i;const o=this.getLineLength(t,i,s,r);if(o<1e-10)return{x:t,y:i};if(s===t)return{x:a,y:l+(r>i?e:-e)};const c=(r-i)/(s-t),d=Math.sqrt(e*e/(1+c*c))*(s<t?-1:1),u=c*d;if(Math.abs(l-i-c*(a-t))<1e-10)return{x:a+d,y:l+u};const g=((a-t)*(s-t)+(l-i)*(r-i))/(o*o),v=t+g*(s-t),h=i+g*(r-i),p=this.getLineLength(a,l,v,h),b=Math.sqrt(e*e-p*p),m=Math.sqrt(b*b/(1+c*c))*(s<t?-1:1),y=c*m;return{x:v+m,y:h+y}}static getPointOnCubicBezier(e,t,i,s,r,a,l,o,c){function d(b){return b*b*b}function u(b){return 3*b*b*(1-b)}function g(b){return 3*b*(1-b)*(1-b)}function v(b){return(1-b)*(1-b)*(1-b)}const h=o*d(e)+a*u(e)+s*g(e)+t*v(e),p=c*d(e)+l*u(e)+r*g(e)+i*v(e);return{x:h,y:p}}static getPointOnQuadraticBezier(e,t,i,s,r,a,l){function o(v){return v*v}function c(v){return 2*v*(1-v)}function d(v){return(1-v)*(1-v)}const u=a*o(e)+s*c(e)+t*d(e),g=l*o(e)+r*c(e)+i*d(e);return{x:u,y:g}}static getPointOnEllipticalArc(e,t,i,s,r,a){const l=Math.cos(a),o=Math.sin(a),c={x:i*Math.cos(r),y:s*Math.sin(r)};return{x:e+(c.x*l-c.y*o),y:t+(c.x*o+c.y*l)}}static parsePathData(e){if(!e)return[];let t=e;const i=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];t=t.replace(new RegExp(" ","g"),",");for(let u=0;u<i.length;u++)t=t.replace(new RegExp(i[u],"g"),"|"+i[u]);const s=t.split("|"),r=[],a=[];let l=0,o=0;const c=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;let d;for(let u=1;u<s.length;u++){let g=s[u],v=g.charAt(0);for(g=g.slice(1),a.length=0;d=c.exec(g);)a.push(d[0]);let h=[],p=v==="A"||v==="a"?0:-1;for(let b=0,m=a.length;b<m;b++){const y=a[b];if(y==="00"){h.push(0,0),p>=0&&(p+=2,p>=7&&(p-=7));continue}if(p>=0){if(p===3){if(/^[01]{2}\d+(?:\.\d+)?$/.test(y)){h.push(parseInt(y[0],10)),h.push(parseInt(y[1],10)),h.push(parseFloat(y.slice(2))),p+=3,p>=7&&(p-=7);continue}if(y==="11"||y==="10"||y==="01"){h.push(parseInt(y[0],10)),h.push(parseInt(y[1],10)),p+=2,p>=7&&(p-=7);continue}if(y==="0"||y==="1"){h.push(parseInt(y,10)),p+=1,p>=7&&(p-=7);continue}}else if(p===4){if(/^[01]\d+(?:\.\d+)?$/.test(y)){h.push(parseInt(y[0],10)),h.push(parseFloat(y.slice(1))),p+=2,p>=7&&(p-=7);continue}if(y==="0"||y==="1"){h.push(parseInt(y,10)),p+=1,p>=7&&(p-=7);continue}}const $=parseFloat(y);isNaN($)?h.push(0):h.push($),p+=1,p>=7&&(p-=7)}else{const $=parseFloat(y);isNaN($)?h.push(0):h.push($)}}for(;h.length>0&&!isNaN(h[0]);){let b="",m=[];const y=l,$=o;let x,w,P,L,D,z,E,R,k,q;switch(v){case"l":l+=h.shift(),o+=h.shift(),b="L",m.push(l,o);break;case"L":l=h.shift(),o=h.shift(),m.push(l,o);break;case"m":const N=h.shift(),C=h.shift();if(l+=N,o+=C,b="M",r.length>2&&r[r.length-1].command==="z"){for(let A=r.length-2;A>=0;A--)if(r[A].command==="M"){l=r[A].points[0]+N,o=r[A].points[1]+C;break}}m.push(l,o),v="l";break;case"M":l=h.shift(),o=h.shift(),b="M",m.push(l,o),v="L";break;case"h":l+=h.shift(),b="L",m.push(l,o);break;case"H":l=h.shift(),b="L",m.push(l,o);break;case"v":o+=h.shift(),b="L",m.push(l,o);break;case"V":o=h.shift(),b="L",m.push(l,o);break;case"C":m.push(h.shift(),h.shift(),h.shift(),h.shift()),l=h.shift(),o=h.shift(),m.push(l,o);break;case"c":m.push(l+h.shift(),o+h.shift(),l+h.shift(),o+h.shift()),l+=h.shift(),o+=h.shift(),b="C",m.push(l,o);break;case"S":w=l,P=o,x=r[r.length-1],x.command==="C"&&(w=l+(l-x.points[2]),P=o+(o-x.points[3])),m.push(w,P,h.shift(),h.shift()),l=h.shift(),o=h.shift(),b="C",m.push(l,o);break;case"s":w=l,P=o,x=r[r.length-1],x.command==="C"&&(w=l+(l-x.points[2]),P=o+(o-x.points[3])),m.push(w,P,l+h.shift(),o+h.shift()),l+=h.shift(),o+=h.shift(),b="C",m.push(l,o);break;case"Q":m.push(h.shift(),h.shift()),l=h.shift(),o=h.shift(),m.push(l,o);break;case"q":m.push(l+h.shift(),o+h.shift()),l+=h.shift(),o+=h.shift(),b="Q",m.push(l,o);break;case"T":w=l,P=o,x=r[r.length-1],x.command==="Q"&&(w=l+(l-x.points[0]),P=o+(o-x.points[1])),l=h.shift(),o=h.shift(),b="Q",m.push(w,P,l,o);break;case"t":w=l,P=o,x=r[r.length-1],x.command==="Q"&&(w=l+(l-x.points[0]),P=o+(o-x.points[1])),l+=h.shift(),o+=h.shift(),b="Q",m.push(w,P,l,o);break;case"A":L=h.shift(),D=h.shift(),z=h.shift(),E=h.shift(),R=h.shift(),k=l,q=o,l=h.shift(),o=h.shift(),b="A",m=this.convertEndpointToCenterParameterization(k,q,l,o,E,R,L,D,z);break;case"a":L=h.shift(),D=h.shift(),z=h.shift(),E=h.shift(),R=h.shift(),k=l,q=o,l+=h.shift(),o+=h.shift(),b="A",m=this.convertEndpointToCenterParameterization(k,q,l,o,E,R,L,D,z);break}r.push({command:b||v,points:m,start:{x:y,y:$},pathLength:this.calcLength(y,$,b||v,m)})}(v==="z"||v==="Z")&&r.push({command:"z",points:[],start:void 0,pathLength:0})}return r}static calcLength(e,t,i,s){let r,a,l,o;const c=ze;switch(i){case"L":return c.getLineLength(e,t,s[0],s[1]);case"C":return ps([e,s[0],s[2],s[4]],[t,s[1],s[3],s[5]],1);case"Q":return ms([e,s[0],s[2]],[t,s[1],s[3]],1);case"A":r=0;const d=s[4],u=s[5],g=s[4]+u;let v=Math.PI/180;if(Math.abs(d-g)<v&&(v=Math.abs(d-g)),a=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],d,0),u<0)for(o=d-v;o>g;o-=v)l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],o,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),a=l;else for(o=d+v;o<g;o+=v)l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],o,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),a=l;return l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],g,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),r}return 0}static convertEndpointToCenterParameterization(e,t,i,s,r,a,l,o,c){const d=c*(Math.PI/180),u=Math.cos(d)*(e-i)/2+Math.sin(d)*(t-s)/2,g=-1*Math.sin(d)*(e-i)/2+Math.cos(d)*(t-s)/2,v=u*u/(l*l)+g*g/(o*o);v>1&&(l*=Math.sqrt(v),o*=Math.sqrt(v));let h=Math.sqrt((l*l*(o*o)-l*l*(g*g)-o*o*(u*u))/(l*l*(g*g)+o*o*(u*u)));r===a&&(h*=-1),isNaN(h)&&(h=0);const p=h*l*g/o,b=h*-o*u/l,m=(e+i)/2+Math.cos(d)*p-Math.sin(d)*b,y=(t+s)/2+Math.sin(d)*p+Math.cos(d)*b,$=function(E){return Math.sqrt(E[0]*E[0]+E[1]*E[1])},x=function(E,R){return(E[0]*R[0]+E[1]*R[1])/($(E)*$(R))},w=function(E,R){return(E[0]*R[1]<E[1]*R[0]?-1:1)*Math.acos(x(E,R))},P=w([1,0],[(u-p)/l,(g-b)/o]),L=[(u-p)/l,(g-b)/o],D=[(-1*u-p)/l,(-1*g-b)/o];let z=w(L,D);return x(L,D)<=-1&&(z=Math.PI),x(L,D)>=1&&(z=0),a===0&&z>0&&(z=z-2*Math.PI),a===1&&z<0&&(z=z+2*Math.PI),[m,y,l,o,P,z,d,a]}}ze.prototype.className="Path";ze.prototype._attrsAffectingSize=["data"];Be(ze);T.addGetterSetter(ze,"data");class Nt extends bt{_sceneFunc(e){super._sceneFunc(e);const t=Math.PI*2,i=this.points();let s=i;const r=this.tension()!==0&&i.length>4;r&&(s=this.getTensionPoints());const a=this.pointerLength(),l=i.length;let o,c;if(r){const g=[s[s.length-4],s[s.length-3],s[s.length-2],s[s.length-1],i[l-2],i[l-1]],v=ze.calcLength(s[s.length-4],s[s.length-3],"C",g),h=ze.getPointOnQuadraticBezier(Math.min(1,1-a/v),g[0],g[1],g[2],g[3],g[4],g[5]);o=i[l-2]-h.x,c=i[l-1]-h.y}else o=i[l-2]-i[l-4],c=i[l-1]-i[l-3];const d=(Math.atan2(c,o)+t)%t,u=this.pointerWidth();this.pointerAtEnding()&&(e.save(),e.beginPath(),e.translate(i[l-2],i[l-1]),e.rotate(d),e.moveTo(0,0),e.lineTo(-a,u/2),e.lineTo(-a,-u/2),e.closePath(),e.restore(),this.__fillStroke(e)),this.pointerAtBeginning()&&(e.save(),e.beginPath(),e.translate(i[0],i[1]),r?(o=(s[0]+s[2])/2-i[0],c=(s[1]+s[3])/2-i[1]):(o=i[2]-i[0],c=i[3]-i[1]),e.rotate((Math.atan2(-c,-o)+t)%t),e.moveTo(0,0),e.lineTo(-a,u/2),e.lineTo(-a,-u/2),e.closePath(),e.restore(),this.__fillStroke(e))}__fillStroke(e){const t=this.dashEnabled();t&&(this.attrs.dashEnabled=!1,e.setLineDash([])),e.fillStrokeShape(this),t&&(this.attrs.dashEnabled=!0)}getSelfRect(){const e=super.getSelfRect(),t=this.pointerWidth()/2;return{x:e.x,y:e.y-t,width:e.width,height:e.height+t*2}}}Nt.prototype.className="Arrow";Be(Nt);T.addGetterSetter(Nt,"pointerLength",10,re());T.addGetterSetter(Nt,"pointerWidth",10,re());T.addGetterSetter(Nt,"pointerAtBeginning",!1);T.addGetterSetter(Nt,"pointerAtEnding",!0);class Jt extends Z{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.attrs.radius||0,0,Math.PI*2,!1),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius()!==e/2&&this.radius(e/2)}setHeight(e){this.radius()!==e/2&&this.radius(e/2)}}Jt.prototype._centroid=!0;Jt.prototype.className="Circle";Jt.prototype._attrsAffectingSize=["radius"];Be(Jt);T.addGetterSetter(Jt,"radius",0,re());class kt extends Z{_sceneFunc(e){const t=this.radiusX(),i=this.radiusY();e.beginPath(),e.save(),t!==i&&e.scale(1,i/t),e.arc(0,0,t,0,Math.PI*2,!1),e.restore(),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radiusX()*2}getHeight(){return this.radiusY()*2}setWidth(e){this.radiusX(e/2)}setHeight(e){this.radiusY(e/2)}}kt.prototype.className="Ellipse";kt.prototype._centroid=!0;kt.prototype._attrsAffectingSize=["radiusX","radiusY"];Be(kt);T.addComponentsGetterSetter(kt,"radius",["x","y"]);T.addGetterSetter(kt,"radiusX",0,re());T.addGetterSetter(kt,"radiusY",0,re());class rt extends Z{constructor(e){super(e),this._loadListener=()=>{this._requestDraw()},this.on("imageChange.konva",t=>{this._removeImageLoad(t.oldVal),this._setImageLoad()}),this._setImageLoad()}_setImageLoad(){const e=this.image();e&&e.complete||e&&e.readyState===4||e&&e.addEventListener&&e.addEventListener("load",this._loadListener)}_removeImageLoad(e){e&&e.removeEventListener&&e.removeEventListener("load",this._loadListener)}destroy(){return this._removeImageLoad(this.image()),super.destroy(),this}_useBufferCanvas(){const e=!!this.cornerRadius(),t=this.hasShadow();return e&&t?!0:super._useBufferCanvas(!0)}_sceneFunc(e){const t=this.getWidth(),i=this.getHeight(),s=this.cornerRadius(),r=this.attrs.image;let a;if(r){const l=this.attrs.cropWidth,o=this.attrs.cropHeight;l&&o?a=[r,this.cropX(),this.cropY(),l,o,0,0,t,i]:a=[r,0,0,t,i]}(this.hasFill()||this.hasStroke()||s)&&(e.beginPath(),s?U.drawRoundedRectPath(e,t,i,s):e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)),r&&(s&&e.clip(),e.drawImage.apply(e,a))}_hitFunc(e){const t=this.width(),i=this.height(),s=this.cornerRadius();e.beginPath(),s?U.drawRoundedRectPath(e,t,i,s):e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)}getWidth(){var e,t;return(e=this.attrs.width)!==null&&e!==void 0?e:(t=this.image())===null||t===void 0?void 0:t.width}getHeight(){var e,t;return(e=this.attrs.height)!==null&&e!==void 0?e:(t=this.image())===null||t===void 0?void 0:t.height}static fromURL(e,t,i=null){const s=U.createImageElement();s.onload=function(){const r=new rt({image:s});t(r)},s.onerror=i,s.crossOrigin="Anonymous",s.src=e}}rt.prototype.className="Image";Be(rt);T.addGetterSetter(rt,"cornerRadius",0,Jn(4));T.addGetterSetter(rt,"image");T.addComponentsGetterSetter(rt,"crop",["x","y","width","height"]);T.addGetterSetter(rt,"cropX",0,re());T.addGetterSetter(rt,"cropY",0,re());T.addGetterSetter(rt,"cropWidth",0,re());T.addGetterSetter(rt,"cropHeight",0,re());const Er=["fontFamily","fontSize","fontStyle","padding","lineHeight","text","width","height","pointerDirection","pointerWidth","pointerHeight"],Yc="Change.konva",Vc="none",ki="up",Ti="right",Ei="down",Pi="left",Xc=Er.length;class Ni extends Yt{constructor(e){super(e),this.on("add.konva",function(t){this._addListeners(t.child),this._sync()})}getText(){return this.find("Text")[0]}getTag(){return this.find("Tag")[0]}_addListeners(e){let t=this,i;const s=function(){t._sync()};for(i=0;i<Xc;i++)e.on(Er[i]+Yc,s)}getWidth(){return this.getText().width()}getHeight(){return this.getText().height()}_sync(){let e=this.getText(),t=this.getTag(),i,s,r,a,l,o,c;if(e&&t){switch(i=e.width(),s=e.height(),r=t.pointerDirection(),a=t.pointerWidth(),c=t.pointerHeight(),l=0,o=0,r){case ki:l=i/2,o=-1*c;break;case Ti:l=i+a,o=s/2;break;case Ei:l=i/2,o=s+c;break;case Pi:l=-1*a,o=s/2;break}t.setAttrs({x:-1*l,y:-1*o,width:i,height:s}),e.setAttrs({x:-1*l,y:-1*o})}}}Ni.prototype.className="Label";Be(Ni);class zt extends Z{_sceneFunc(e){const t=this.width(),i=this.height(),s=this.pointerDirection(),r=this.pointerWidth(),a=this.pointerHeight(),l=this.cornerRadius();let o=0,c=0,d=0,u=0;typeof l=="number"?o=c=d=u=Math.min(l,t/2,i/2):(o=Math.min(l[0]||0,t/2,i/2),c=Math.min(l[1]||0,t/2,i/2),u=Math.min(l[2]||0,t/2,i/2),d=Math.min(l[3]||0,t/2,i/2)),e.beginPath(),e.moveTo(o,0),s===ki&&(e.lineTo((t-r)/2,0),e.lineTo(t/2,-1*a),e.lineTo((t+r)/2,0)),e.lineTo(t-c,0),e.arc(t-c,c,c,Math.PI*3/2,0,!1),s===Ti&&(e.lineTo(t,(i-a)/2),e.lineTo(t+r,i/2),e.lineTo(t,(i+a)/2)),e.lineTo(t,i-u),e.arc(t-u,i-u,u,0,Math.PI/2,!1),s===Ei&&(e.lineTo((t+r)/2,i),e.lineTo(t/2,i+a),e.lineTo((t-r)/2,i)),e.lineTo(d,i),e.arc(d,i-d,d,Math.PI/2,Math.PI,!1),s===Pi&&(e.lineTo(0,(i+a)/2),e.lineTo(-1*r,i/2),e.lineTo(0,(i-a)/2)),e.lineTo(0,o),e.arc(o,o,o,Math.PI,Math.PI*3/2,!1),e.closePath(),e.fillStrokeShape(this)}getSelfRect(){let e=0,t=0,i=this.pointerWidth(),s=this.pointerHeight(),r=this.pointerDirection(),a=this.width(),l=this.height();return r===ki?(t-=s,l+=s):r===Ei?l+=s:r===Pi?(e-=i*1.5,a+=i):r===Ti&&(a+=i*1.5),{x:e,y:t,width:a,height:l}}}zt.prototype.className="Tag";Be(zt);T.addGetterSetter(zt,"pointerDirection",Vc);T.addGetterSetter(zt,"pointerWidth",0,re());T.addGetterSetter(zt,"pointerHeight",0,re());T.addGetterSetter(zt,"cornerRadius",0,Jn(4));class xn extends Z{_sceneFunc(e){const t=this.cornerRadius(),i=this.width(),s=this.height();e.beginPath(),t?U.drawRoundedRectPath(e,i,s,t):e.rect(0,0,i,s),e.closePath(),e.fillStrokeShape(this)}}xn.prototype.className="Rect";Be(xn);T.addGetterSetter(xn,"cornerRadius",0,Jn(4));class Tt extends Z{_sceneFunc(e){const t=this._getPoints(),i=this.radius(),s=this.sides(),r=this.cornerRadius();if(e.beginPath(),r)U.drawRoundedPolygonPath(e,t,s,i,r);else{e.moveTo(t[0].x,t[0].y);for(let a=1;a<t.length;a++)e.lineTo(t[a].x,t[a].y)}e.closePath(),e.fillStrokeShape(this)}_getPoints(){const e=this.attrs.sides,t=this.attrs.radius||0,i=[];for(let s=0;s<e;s++)i.push({x:t*Math.sin(s*2*Math.PI/e),y:-1*t*Math.cos(s*2*Math.PI/e)});return i}getSelfRect(){const e=this._getPoints();let t=e[0].x,i=e[0].y,s=e[0].x,r=e[0].y;return e.forEach(a=>{t=Math.min(t,a.x),i=Math.max(i,a.x),s=Math.min(s,a.y),r=Math.max(r,a.y)}),{x:t,y:s,width:i-t,height:r-s}}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius(e/2)}setHeight(e){this.radius(e/2)}}Tt.prototype.className="RegularPolygon";Tt.prototype._centroid=!0;Tt.prototype._attrsAffectingSize=["radius"];Be(Tt);T.addGetterSetter(Tt,"radius",0,re());T.addGetterSetter(Tt,"sides",0,re());T.addGetterSetter(Tt,"cornerRadius",0,Jn(4));const ys=Math.PI*2;class Ft extends Z{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.innerRadius(),0,ys,!1),e.moveTo(this.outerRadius(),0),e.arc(0,0,this.outerRadius(),ys,0,!0),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}}Ft.prototype.className="Ring";Ft.prototype._centroid=!0;Ft.prototype._attrsAffectingSize=["innerRadius","outerRadius"];Be(Ft);T.addGetterSetter(Ft,"innerRadius",0,re());T.addGetterSetter(Ft,"outerRadius",0,re());class ht extends Z{constructor(e){super(e),this._updated=!0,this.anim=new nt(()=>{const t=this._updated;return this._updated=!1,t}),this.on("animationChange.konva",function(){this.frameIndex(0)}),this.on("frameIndexChange.konva",function(){this._updated=!0}),this.on("frameRateChange.konva",function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())})}_sceneFunc(e){const t=this.animation(),i=this.frameIndex(),s=i*4,r=this.animations()[t],a=this.frameOffsets(),l=r[s+0],o=r[s+1],c=r[s+2],d=r[s+3],u=this.image();if((this.hasFill()||this.hasStroke())&&(e.beginPath(),e.rect(0,0,c,d),e.closePath(),e.fillStrokeShape(this)),u)if(a){const g=a[t],v=i*2;e.drawImage(u,l,o,c,d,g[v+0],g[v+1],c,d)}else e.drawImage(u,l,o,c,d,0,0,c,d)}_hitFunc(e){const t=this.animation(),i=this.frameIndex(),s=i*4,r=this.animations()[t],a=this.frameOffsets(),l=r[s+2],o=r[s+3];if(e.beginPath(),a){const c=a[t],d=i*2;e.rect(c[d+0],c[d+1],l,o)}else e.rect(0,0,l,o);e.closePath(),e.fillShape(this)}_useBufferCanvas(){return super._useBufferCanvas(!0)}_setInterval(){const e=this;this.interval=setInterval(function(){e._updateIndex()},1e3/this.frameRate())}start(){if(this.isRunning())return;const e=this.getLayer();this.anim.setLayers(e),this._setInterval(),this.anim.start()}stop(){this.anim.stop(),clearInterval(this.interval)}isRunning(){return this.anim.isRunning()}_updateIndex(){const e=this.frameIndex(),t=this.animation(),i=this.animations(),s=i[t],r=s.length/4;e<r-1?this.frameIndex(e+1):this.frameIndex(0)}}ht.prototype.className="Sprite";Be(ht);T.addGetterSetter(ht,"animation");T.addGetterSetter(ht,"animations");T.addGetterSetter(ht,"frameOffsets");T.addGetterSetter(ht,"image");T.addGetterSetter(ht,"frameIndex",0,re());T.addGetterSetter(ht,"frameRate",17,re());T.backCompat(ht,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"});class Et extends Z{_sceneFunc(e){const t=this.innerRadius(),i=this.outerRadius(),s=this.numPoints();e.beginPath(),e.moveTo(0,0-i);for(let r=1;r<s*2;r++){const a=r%2===0?i:t,l=a*Math.sin(r*Math.PI/s),o=-1*a*Math.cos(r*Math.PI/s);e.lineTo(l,o)}e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}}Et.prototype.className="Star";Et.prototype._centroid=!0;Et.prototype._attrsAffectingSize=["innerRadius","outerRadius"];Be(Et);T.addGetterSetter(Et,"numPoints",5,re());T.addGetterSetter(Et,"innerRadius",0,re());T.addGetterSetter(Et,"outerRadius",0,re());function xt(n){return[...n].reduce((e,t,i,s)=>{if(new RegExp("\\p{Emoji}","u").test(t)){const r=s[i+1];r&&new RegExp("\\p{Emoji_Modifier}|\\u200D","u").test(r)?(e.push(t+r),s[i+1]=""):e.push(t)}else new RegExp("\\p{Regional_Indicator}{2}","u").test(t+(s[i+1]||""))?e.push(t+s[i+1]):i>0&&new RegExp("\\p{Mn}|\\p{Me}|\\p{Mc}","u").test(t)?e[e.length-1]+=t:t&&e.push(t);return e},[])}const Ut="auto",Qc="center",Pr="inherit",Ht="justify",Jc="Change.konva",Kc="2d",_s="-",Ar="left",Zc="text",ed="Text",td="top",nd="bottom",xs="middle",Rr="normal",id="px ",Ln=" ",sd="right",Ss="rtl",rd="word",ad="char",ws="none",hi="…",Lr=["direction","fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],ld=Lr.length;function od(n){return n.split(",").map(e=>{e=e.trim();const t=e.indexOf(" ")>=0,i=e.indexOf('"')>=0||e.indexOf("'")>=0;return t&&!i&&(e=`"${e}"`),e}).join(", ")}let Mn;function ui(){return Mn||(Mn=U.createCanvasElement().getContext(Kc),Mn)}function cd(n){n.fillText(this._partialText,this._partialTextX,this._partialTextY)}function dd(n){n.setAttr("miterLimit",2),n.strokeText(this._partialText,this._partialTextX,this._partialTextY)}function hd(n){return n=n||{},!n.fillLinearGradientColorStops&&!n.fillRadialGradientColorStops&&!n.fillPatternImage&&(n.fill=n.fill||"black"),n}class Fe extends Z{constructor(e){super(hd(e)),this._partialTextX=0,this._partialTextY=0;for(let t=0;t<ld;t++)this.on(Lr[t]+Jc,this._setTextData);this._setTextData()}_sceneFunc(e){var t,i;const s=this.textArr,r=s.length;if(!this.text())return;let a=this.padding(),l=this.fontSize(),o=this.lineHeight()*l,c=this.verticalAlign(),d=this.direction(),u=0,g=this.align(),v=this.getWidth(),h=this.letterSpacing(),p=this.charRenderFunc(),b=this.fill(),m=this.textDecoration(),y=m.indexOf("underline")!==-1,$=m.indexOf("line-through")!==-1,x;d=d===Pr?e.direction:d;let w=o/2,P=xs;if(!le.legacyTextRendering){const L=this.measureSize("M");P="alphabetic";const D=(t=L.fontBoundingBoxAscent)!==null&&t!==void 0?t:L.actualBoundingBoxAscent,z=(i=L.fontBoundingBoxDescent)!==null&&i!==void 0?i:L.actualBoundingBoxDescent;w=(D-z)/2+o/2}for(d===Ss&&e.setAttr("direction",d),e.setAttr("font",this._getContextFont()),e.setAttr("textBaseline",P),e.setAttr("textAlign",Ar),c===xs?u=(this.getHeight()-r*o-a*2)/2:c===nd&&(u=this.getHeight()-r*o-a*2),e.translate(a,u+a),x=0;x<r;x++){let L=0,D=0;const z=s[x],E=z.text,R=z.width,k=z.lastInParagraph;if(e.save(),g===sd?L+=v-R-a*2:g===Qc&&(L+=(v-R-a*2)/2),y){e.save(),e.beginPath();const q=le.legacyTextRendering?Math.round(l/2):Math.round(l/4),N=L,C=w+D+q;e.moveTo(N,C);const A=g===Ht&&!k?v-a*2:R;e.lineTo(N+Math.round(A),C),e.lineWidth=l/15;const X=this._getLinearGradient();e.strokeStyle=X||b,e.stroke(),e.restore()}if(d!==Ss&&(h!==0||g===Ht||p)){const q=E.split(" ").length-1,N=xt(E);for(let C=0;C<N.length;C++){const A=N[C];if(A===" "&&!k&&g===Ht&&(L+=(v-a*2-R)/q),this._partialTextX=L,this._partialTextY=w+D,this._partialText=A,p){e.save();const G=s.slice(0,x).reduce((V,B)=>V+xt(B.text).length,0),O=C+G;p({char:A,index:O,x:L,y:w+D,lineIndex:x,column:C,isLastInLine:k,width:this.measureSize(A).width,context:e})}e.fillStrokeShape(this),p&&e.restore(),L+=this.measureSize(A).width+h}}else h!==0&&e.setAttr("letterSpacing",`${h}px`),this._partialTextX=L,this._partialTextY=w+D,this._partialText=E,e.fillStrokeShape(this);if($){e.save(),e.beginPath();const q=le.legacyTextRendering?0:-Math.round(l/4),N=g===Ht?0:L;e.moveTo(N,w+D+q);const C=g===Ht&&!k?v-a*2:R;e.lineTo(N+Math.round(C),w+D+q),e.lineWidth=l/15;const A=this._getLinearGradient();e.strokeStyle=A||b,e.stroke(),e.restore()}e.restore(),r>1&&(w+=o)}}_hitFunc(e){const t=this.getWidth(),i=this.getHeight();e.beginPath(),e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)}setText(e){const t=U._isString(e)?e:e==null?"":e+"";return this._setAttr(Zc,t),this}getWidth(){return this.attrs.width===Ut||this.attrs.width===void 0?this.getTextWidth()+this.padding()*2:this.attrs.width}getHeight(){return this.attrs.height===Ut||this.attrs.height===void 0?this.fontSize()*this.textArr.length*this.lineHeight()+this.padding()*2:this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return U.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(e){var t,i,s,r,a,l,o,c,d,u,g;let v=ui(),h=this.fontSize(),p;v.save(),v.font=this._getContextFont(),p=v.measureText(e),v.restore();const b=h/100;return{actualBoundingBoxAscent:(t=p.actualBoundingBoxAscent)!==null&&t!==void 0?t:71.58203125*b,actualBoundingBoxDescent:(i=p.actualBoundingBoxDescent)!==null&&i!==void 0?i:0,actualBoundingBoxLeft:(s=p.actualBoundingBoxLeft)!==null&&s!==void 0?s:-7.421875*b,actualBoundingBoxRight:(r=p.actualBoundingBoxRight)!==null&&r!==void 0?r:75.732421875*b,alphabeticBaseline:(a=p.alphabeticBaseline)!==null&&a!==void 0?a:0,emHeightAscent:(l=p.emHeightAscent)!==null&&l!==void 0?l:100*b,emHeightDescent:(o=p.emHeightDescent)!==null&&o!==void 0?o:-20*b,fontBoundingBoxAscent:(c=p.fontBoundingBoxAscent)!==null&&c!==void 0?c:91*b,fontBoundingBoxDescent:(d=p.fontBoundingBoxDescent)!==null&&d!==void 0?d:21*b,hangingBaseline:(u=p.hangingBaseline)!==null&&u!==void 0?u:72.80000305175781*b,ideographicBaseline:(g=p.ideographicBaseline)!==null&&g!==void 0?g:-21*b,width:p.width,height:h}}_getContextFont(){return this.fontStyle()+Ln+this.fontVariant()+Ln+(this.fontSize()+id)+od(this.fontFamily())}_addTextLine(e){this.align()===Ht&&(e=e.trim());const i=this._getTextWidth(e);return this.textArr.push({text:e,width:i,lastInParagraph:!1})}_getTextWidth(e){const t=this.letterSpacing(),i=e.length;return ui().measureText(e).width+t*i}_setTextData(){let e=this.text().split(`
`),t=+this.fontSize(),i=0,s=this.lineHeight()*t,r=this.attrs.width,a=this.attrs.height,l=r!==Ut&&r!==void 0,o=a!==Ut&&a!==void 0,c=this.padding(),d=r-c*2,u=a-c*2,g=0,v=this.wrap(),h=v!==ws,p=v!==ad&&h,b=this.ellipsis();this.textArr=[],ui().font=this._getContextFont();const m=b?this._getTextWidth(hi):0;for(let y=0,$=e.length;y<$;++y){let x=e[y],w=this._getTextWidth(x);if(l&&w>d)for(;x.length>0;){let P=0,L=xt(x).length,D="",z=0;for(;P<L;){const E=P+L>>>1,R=xt(x),k=R.slice(0,E+1).join(""),q=this._getTextWidth(k);(b&&o&&g+s>u?q+m:q)<=d?(P=E+1,D=k,z=q):L=E}if(D){if(p){const k=xt(x),q=xt(D),N=k[q.length],C=N===Ln||N===_s;let A;if(C&&z<=d)A=q.length;else{const X=q.lastIndexOf(Ln),G=q.lastIndexOf(_s);A=Math.max(X,G)+1}A>0&&(P=A,D=k.slice(0,P).join(""),z=this._getTextWidth(D))}if(D=D.trimRight(),this._addTextLine(D),i=Math.max(i,z),g+=s,this._shouldHandleEllipsis(g)){this._tryToAddEllipsisToLastLine();break}if(x=xt(x).slice(P).join("").trimLeft(),x.length>0&&(w=this._getTextWidth(x),w<=d)){this._addTextLine(x),g+=s,i=Math.max(i,w);break}}else break}else this._addTextLine(x),g+=s,i=Math.max(i,w),this._shouldHandleEllipsis(g)&&y<$-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),o&&g+s>u)break}this.textHeight=t,this.textWidth=i}_shouldHandleEllipsis(e){const t=+this.fontSize(),i=this.lineHeight()*t,s=this.attrs.height,r=s!==Ut&&s!==void 0,a=this.padding(),l=s-a*2;return!(this.wrap()!==ws)||r&&e+i>l}_tryToAddEllipsisToLastLine(){const e=this.attrs.width,t=e!==Ut&&e!==void 0,i=this.padding(),s=e-i*2,r=this.ellipsis(),a=this.textArr[this.textArr.length-1];!a||!r||(t&&(this._getTextWidth(a.text+hi)<s||(a.text=a.text.slice(0,a.text.length-3))),this.textArr.splice(this.textArr.length-1,1),this._addTextLine(a.text+hi))}getStrokeScaleEnabled(){return!0}_useBufferCanvas(){const e=this.textDecoration().indexOf("underline")!==-1||this.textDecoration().indexOf("line-through")!==-1,t=this.hasShadow();return e&&t?!0:super._useBufferCanvas()}}Fe.prototype._fillFunc=cd;Fe.prototype._strokeFunc=dd;Fe.prototype.className=ed;Fe.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"];Be(Fe);T.overWriteSetter(Fe,"width",Di());T.overWriteSetter(Fe,"height",Di());T.addGetterSetter(Fe,"direction",Pr);T.addGetterSetter(Fe,"fontFamily","Arial");T.addGetterSetter(Fe,"fontSize",12,re());T.addGetterSetter(Fe,"fontStyle",Rr);T.addGetterSetter(Fe,"fontVariant",Rr);T.addGetterSetter(Fe,"padding",0,re());T.addGetterSetter(Fe,"align",Ar);T.addGetterSetter(Fe,"verticalAlign",td);T.addGetterSetter(Fe,"lineHeight",1,re());T.addGetterSetter(Fe,"wrap",rd);T.addGetterSetter(Fe,"ellipsis",!1,lt());T.addGetterSetter(Fe,"letterSpacing",0,re());T.addGetterSetter(Fe,"text","",Ot());T.addGetterSetter(Fe,"textDecoration","");T.addGetterSetter(Fe,"charRenderFunc",void 0);const ud="",Mr="normal";function Dr(n){n.fillText(this.partialText,0,0)}function Or(n){n.strokeText(this.partialText,0,0)}class qe extends Z{constructor(e){super(e),this.dummyCanvas=U.createCanvasElement(),this.dataArray=[],this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute(),this._setTextData()}),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_getTextPathLength(){return ze.getPathLength(this.dataArray)}_getPointAtLength(e){if(!this.attrs.data)return null;const t=this.pathLength;return e>t?null:ze.getPointAtLengthOfDataArray(e,this.dataArray)}_readDataAttribute(){this.dataArray=ze.parsePathData(this.attrs.data),this.pathLength=this._getTextPathLength()}_sceneFunc(e){e.setAttr("font",this._getContextFont()),e.setAttr("textBaseline",this.textBaseline()),e.setAttr("textAlign","left"),e.save();const t=this.textDecoration(),i=this.fill(),s=this.fontSize(),r=this.glyphInfo;t==="underline"&&e.beginPath();for(let a=0;a<r.length;a++){e.save();const l=r[a].p0;e.translate(l.x,l.y),e.rotate(r[a].rotation),this.partialText=r[a].text,e.fillStrokeShape(this),t==="underline"&&(a===0&&e.moveTo(0,s/2+1),e.lineTo(s,s/2+1)),e.restore()}t==="underline"&&(e.strokeStyle=i,e.lineWidth=s/20,e.stroke()),e.restore()}_hitFunc(e){e.beginPath();const t=this.glyphInfo;if(t.length>=1){const i=t[0].p0;e.moveTo(i.x,i.y)}for(let i=0;i<t.length;i++){const s=t[i].p1;e.lineTo(s.x,s.y)}e.setAttr("lineWidth",this.fontSize()),e.setAttr("strokeStyle",this.colorKey),e.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return U.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(e){return Fe.prototype.setText.call(this,e)}_getContextFont(){return Fe.prototype._getContextFont.call(this)}_getTextSize(e){const i=this.dummyCanvas.getContext("2d");i.save(),i.font=this._getContextFont();const s=i.measureText(e);return i.restore(),{width:s.width,height:parseInt(`${this.fontSize()}`,10)}}_setTextData(){const e=xt(this.text()),t=[];let i=0;for(let u=0;u<e.length;u++)t.push({char:e[u],width:this._getTextSize(e[u]).width}),i+=t[u].width;const{height:s}=this._getTextSize(this.attrs.text);if(this.textWidth=i,this.textHeight=s,this.glyphInfo=[],!this.attrs.data)return null;const r=this.letterSpacing(),a=this.align(),l=this.kerningFunc(),o=Math.max(this.textWidth+((this.attrs.text||"").length-1)*r,0);let c=0;a==="center"&&(c=Math.max(0,this.pathLength/2-o/2)),a==="right"&&(c=Math.max(0,this.pathLength-o));let d=c;for(let u=0;u<t.length;u++){const g=this._getPointAtLength(d);if(!g)return;const v=t[u].char;let h=t[u].width+r;if(v===" "&&a==="justify"){const x=this.text().split(" ").length-1;h+=(this.pathLength-o)/x}const p=this._getPointAtLength(d+h);if(!p)return;const b=ze.getLineLength(g.x,g.y,p.x,p.y);let m=0;if(l)try{m=l(t[u-1].char,v)*this.fontSize()}catch{m=0}g.x+=m,p.x+=m,this.textWidth+=m;const y=ze.getPointOnLine(m+b/2,g.x,g.y,p.x,p.y),$=Math.atan2(p.y-g.y,p.x-g.x);this.glyphInfo.push({transposeX:y.x,transposeY:y.y,text:e[u],rotation:$,p0:g,p1:p}),d+=h}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};const e=[];this.glyphInfo.forEach(function(c){e.push(c.p0.x),e.push(c.p0.y),e.push(c.p1.x),e.push(c.p1.y)});let t=e[0]||0,i=e[0]||0,s=e[1]||0,r=e[1]||0,a,l;for(let c=0;c<e.length/2;c++)a=e[c*2],l=e[c*2+1],t=Math.min(t,a),i=Math.max(i,a),s=Math.min(s,l),r=Math.max(r,l);const o=this.fontSize();return{x:t-o/2,y:s-o/2,width:i-t+o,height:r-s+o}}destroy(){return U.releaseCanvas(this.dummyCanvas),super.destroy()}}qe.prototype._fillFunc=Dr;qe.prototype._strokeFunc=Or;qe.prototype._fillFuncHit=Dr;qe.prototype._strokeFuncHit=Or;qe.prototype.className="TextPath";qe.prototype._attrsAffectingSize=["text","fontSize","data"];Be(qe);T.addGetterSetter(qe,"data");T.addGetterSetter(qe,"fontFamily","Arial");T.addGetterSetter(qe,"fontSize",12,re());T.addGetterSetter(qe,"fontStyle",Mr);T.addGetterSetter(qe,"align","left");T.addGetterSetter(qe,"letterSpacing",0,re());T.addGetterSetter(qe,"textBaseline","middle");T.addGetterSetter(qe,"fontVariant",Mr);T.addGetterSetter(qe,"text",ud);T.addGetterSetter(qe,"textDecoration","");T.addGetterSetter(qe,"kerningFunc",void 0);const Ir="tr-konva",gd=["resizeEnabledChange","rotateAnchorOffsetChange","rotateEnabledChange","enabledAnchorsChange","anchorSizeChange","borderEnabledChange","borderStrokeChange","borderStrokeWidthChange","borderDashChange","anchorStrokeChange","anchorStrokeWidthChange","anchorFillChange","anchorCornerRadiusChange","ignoreStrokeChange","anchorStyleFuncChange"].map(n=>n+`.${Ir}`).join(" "),$s="nodesRect",fd=["widthChange","heightChange","scaleXChange","scaleYChange","skewXChange","skewYChange","rotationChange","offsetXChange","offsetYChange","transformsEnabledChange","strokeWidthChange","draggableChange"],vd={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135},pd="ontouchstart"in le._global;function md(n,e,t){if(n==="rotater")return t;e+=U.degToRad(vd[n]||0);const i=(U.radToDeg(e)%360+360)%360;return U._inRange(i,315+22.5,360)||U._inRange(i,0,22.5)?"ns-resize":U._inRange(i,45-22.5,45+22.5)?"nesw-resize":U._inRange(i,90-22.5,90+22.5)?"ew-resize":U._inRange(i,135-22.5,135+22.5)?"nwse-resize":U._inRange(i,180-22.5,180+22.5)?"ns-resize":U._inRange(i,225-22.5,225+22.5)?"nesw-resize":U._inRange(i,270-22.5,270+22.5)?"ew-resize":U._inRange(i,315-22.5,315+22.5)?"nwse-resize":(U.error("Transformer has unknown angle for cursor detection: "+i),"pointer")}const Vn=["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"];function bd(n){return{x:n.x+n.width/2*Math.cos(n.rotation)+n.height/2*Math.sin(-n.rotation),y:n.y+n.height/2*Math.cos(n.rotation)+n.width/2*Math.sin(n.rotation)}}function Nr(n,e,t){const i=t.x+(n.x-t.x)*Math.cos(e)-(n.y-t.y)*Math.sin(e),s=t.y+(n.x-t.x)*Math.sin(e)+(n.y-t.y)*Math.cos(e);return{...n,rotation:n.rotation+e,x:i,y:s}}function yd(n,e){const t=bd(n);return Nr(n,e,t)}function _d(n,e,t){let i=e;for(let s=0;s<n.length;s++){const r=le.getAngle(n[s]),a=Math.abs(r-e)%(Math.PI*2);Math.min(a,Math.PI*2-a)<t&&(i=r)}return i}let Ai=0;class Ee extends Yt{constructor(e){super(e),this._movingAnchorName=null,this._transforming=!1,this._createElements(),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.update=this.update.bind(this),this.on(gd,this.update),this.getNode()&&this.update()}attachTo(e){return this.setNode(e),this}setNode(e){return U.warn("tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead."),this.setNodes([e])}getNode(){return this._nodes&&this._nodes[0]}_getEventNamespace(){return Ir+this._id}setNodes(e=[]){this._nodes&&this._nodes.length&&this.detach();const t=e.filter(s=>s.isAncestorOf(this)?(U.error("Konva.Transformer cannot be an a child of the node you are trying to attach"),!1):!0);return this._nodes=e=t,e.length===1&&this.useSingleNodeRotation()?this.rotation(e[0].getAbsoluteRotation()):this.rotation(0),this._nodes.forEach(s=>{const r=()=>{this.nodes().length===1&&this.useSingleNodeRotation()&&this.rotation(this.nodes()[0].getAbsoluteRotation()),this._resetTransformCache(),!this._transforming&&!this.isDragging()&&this.update()};if(s._attrsAffectingSize.length){const a=s._attrsAffectingSize.map(l=>l+"Change."+this._getEventNamespace()).join(" ");s.on(a,r)}s.on(fd.map(a=>a+`.${this._getEventNamespace()}`).join(" "),r),s.on(`absoluteTransformChange.${this._getEventNamespace()}`,r),this._proxyDrag(s)}),this._resetTransformCache(),!!this.findOne(".top-left")&&this.update(),this}_proxyDrag(e){let t;e.on(`dragstart.${this._getEventNamespace()}`,i=>{t=e.getAbsolutePosition(),!this.isDragging()&&e!==this.findOne(".back")&&this.startDrag(i,!1)}),e.on(`dragmove.${this._getEventNamespace()}`,i=>{if(!t)return;const s=e.getAbsolutePosition(),r=s.x-t.x,a=s.y-t.y;this.nodes().forEach(l=>{if(l===e||l.isDragging())return;const o=l.getAbsolutePosition();l.setAbsolutePosition({x:o.x+r,y:o.y+a}),l.startDrag(i)}),t=null})}getNodes(){return this._nodes||[]}getActiveAnchor(){return this._movingAnchorName}detach(){this._nodes&&this._nodes.forEach(e=>{e.off("."+this._getEventNamespace())}),this._nodes=[],this._resetTransformCache()}_resetTransformCache(){this._clearCache($s),this._clearCache("transform"),this._clearSelfAndDescendantCache("absoluteTransform")}_getNodeRect(){return this._getCache($s,this.__getNodeRect)}__getNodeShape(e,t=this.rotation(),i){const s=e.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),r=e.getAbsoluteScale(i),a=e.getAbsolutePosition(i),l=s.x*r.x-e.offsetX()*r.x,o=s.y*r.y-e.offsetY()*r.y,c=(le.getAngle(e.getAbsoluteRotation())+Math.PI*2)%(Math.PI*2),d={x:a.x+l*Math.cos(c)+o*Math.sin(-c),y:a.y+o*Math.cos(c)+l*Math.sin(c),width:s.width*r.x,height:s.height*r.y,rotation:c};return Nr(d,-le.getAngle(t),{x:0,y:0})}__getNodeRect(){if(!this.getNode())return{x:-1e8,y:-1e8,width:0,height:0,rotation:0};const t=[];this.nodes().map(c=>{const d=c.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),u=[{x:d.x,y:d.y},{x:d.x+d.width,y:d.y},{x:d.x+d.width,y:d.y+d.height},{x:d.x,y:d.y+d.height}],g=c.getAbsoluteTransform();u.forEach(function(v){const h=g.point(v);t.push(h)})});const i=new Ke;i.rotate(-le.getAngle(this.rotation()));let s=1/0,r=1/0,a=-1/0,l=-1/0;t.forEach(function(c){const d=i.point(c);s===void 0&&(s=a=d.x,r=l=d.y),s=Math.min(s,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y)}),i.invert();const o=i.point({x:s,y:r});return{x:o.x,y:o.y,width:a-s,height:l-r,rotation:le.getAngle(this.rotation())}}getX(){return this._getNodeRect().x}getY(){return this._getNodeRect().y}getWidth(){return this._getNodeRect().width}getHeight(){return this._getNodeRect().height}_createElements(){this._createBack(),Vn.forEach(e=>{this._createAnchor(e)}),this._createAnchor("rotater")}_createAnchor(e){const t=new xn({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:e+" _anchor",dragDistance:0,draggable:!0,hitStrokeWidth:pd?10:"auto"}),i=this;t.on("mousedown touchstart",function(s){i._handleMouseDown(s)}),t.on("dragstart",s=>{t.stopDrag(),s.cancelBubble=!0}),t.on("dragend",s=>{s.cancelBubble=!0}),t.on("mouseenter",()=>{const s=le.getAngle(this.rotation()),r=this.rotateAnchorCursor(),a=md(e,s,r);t.getStage().content&&(t.getStage().content.style.cursor=a),this._cursorChange=!0}),t.on("mouseout",()=>{t.getStage().content&&(t.getStage().content.style.cursor=""),this._cursorChange=!1}),this.add(t)}_createBack(){const e=new Z({name:"back",width:0,height:0,sceneFunc(t,i){const s=i.getParent(),r=s.padding();t.beginPath(),t.rect(-r,-r,i.width()+r*2,i.height()+r*2),t.moveTo(i.width()/2,-r),s.rotateEnabled()&&s.rotateLineVisible()&&t.lineTo(i.width()/2,-s.rotateAnchorOffset()*U._sign(i.height())-r),t.fillStrokeShape(i)},hitFunc:(t,i)=>{if(!this.shouldOverdrawWholeArea())return;const s=this.padding();t.beginPath(),t.rect(-s,-s,i.width()+s*2,i.height()+s*2),t.fillStrokeShape(i)}});this.add(e),this._proxyDrag(e),e.on("dragstart",t=>{t.cancelBubble=!0}),e.on("dragmove",t=>{t.cancelBubble=!0}),e.on("dragend",t=>{t.cancelBubble=!0}),this.on("dragmove",t=>{this.update()})}_handleMouseDown(e){if(this._transforming)return;this._movingAnchorName=e.target.name().split(" ")[0];const t=this._getNodeRect(),i=t.width,s=t.height,r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2));this.sin=Math.abs(s/r),this.cos=Math.abs(i/r),typeof window<"u"&&(window.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("touchmove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp,!0),window.addEventListener("touchend",this._handleMouseUp,!0)),this._transforming=!0;const a=e.target.getAbsolutePosition(),l=e.target.getStage().getPointerPosition();this._anchorDragOffset={x:l.x-a.x,y:l.y-a.y},Ai++,this._fire("transformstart",{evt:e.evt,target:this.getNode()}),this._nodes.forEach(o=>{o._fire("transformstart",{evt:e.evt,target:o})})}_handleMouseMove(e){let t,i,s;const r=this.findOne("."+this._movingAnchorName),a=r.getStage();a.setPointersPositions(e);const l=a.getPointerPosition();let o={x:l.x-this._anchorDragOffset.x,y:l.y-this._anchorDragOffset.y};const c=r.getAbsolutePosition();this.anchorDragBoundFunc()&&(o=this.anchorDragBoundFunc()(c,o,e)),r.setAbsolutePosition(o);const d=r.getAbsolutePosition();if(c.x===d.x&&c.y===d.y)return;if(this._movingAnchorName==="rotater"){const y=this._getNodeRect();t=r.x()-y.width/2,i=-r.y()+y.height/2;let $=Math.atan2(-i,t)+Math.PI/2;y.height<0&&($-=Math.PI);const w=le.getAngle(this.rotation())+$,P=le.getAngle(this.rotationSnapTolerance()),D=_d(this.rotationSnaps(),w,P)-y.rotation,z=yd(y,D);this._fitNodesInto(z,e);return}const u=this.shiftBehavior();let g;u==="inverted"?g=this.keepRatio()&&!e.shiftKey:u==="none"?g=this.keepRatio():g=this.keepRatio()||e.shiftKey;let v=this.centeredScaling()||e.altKey;if(this._movingAnchorName==="top-left"){if(g){const y=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()};s=Math.sqrt(Math.pow(y.x-r.x(),2)+Math.pow(y.y-r.y(),2));const $=this.findOne(".top-left").x()>y.x?-1:1,x=this.findOne(".top-left").y()>y.y?-1:1;t=s*this.cos*$,i=s*this.sin*x,this.findOne(".top-left").x(y.x-t),this.findOne(".top-left").y(y.y-i)}}else if(this._movingAnchorName==="top-center")this.findOne(".top-left").y(r.y());else if(this._movingAnchorName==="top-right"){if(g){const y=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()};s=Math.sqrt(Math.pow(r.x()-y.x,2)+Math.pow(y.y-r.y(),2));const $=this.findOne(".top-right").x()<y.x?-1:1,x=this.findOne(".top-right").y()>y.y?-1:1;t=s*this.cos*$,i=s*this.sin*x,this.findOne(".top-right").x(y.x+t),this.findOne(".top-right").y(y.y-i)}var h=r.position();this.findOne(".top-left").y(h.y),this.findOne(".bottom-right").x(h.x)}else if(this._movingAnchorName==="middle-left")this.findOne(".top-left").x(r.x());else if(this._movingAnchorName==="middle-right")this.findOne(".bottom-right").x(r.x());else if(this._movingAnchorName==="bottom-left"){if(g){const y=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()};s=Math.sqrt(Math.pow(y.x-r.x(),2)+Math.pow(r.y()-y.y,2));const $=y.x<r.x()?-1:1,x=r.y()<y.y?-1:1;t=s*this.cos*$,i=s*this.sin*x,r.x(y.x-t),r.y(y.y+i)}h=r.position(),this.findOne(".top-left").x(h.x),this.findOne(".bottom-right").y(h.y)}else if(this._movingAnchorName==="bottom-center")this.findOne(".bottom-right").y(r.y());else if(this._movingAnchorName==="bottom-right"){if(g){const y=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()};s=Math.sqrt(Math.pow(r.x()-y.x,2)+Math.pow(r.y()-y.y,2));const $=this.findOne(".bottom-right").x()<y.x?-1:1,x=this.findOne(".bottom-right").y()<y.y?-1:1;t=s*this.cos*$,i=s*this.sin*x,this.findOne(".bottom-right").x(y.x+t),this.findOne(".bottom-right").y(y.y+i)}}else console.error(new Error("Wrong position argument of selection resizer: "+this._movingAnchorName));if(v=this.centeredScaling()||e.altKey,v){const y=this.findOne(".top-left"),$=this.findOne(".bottom-right"),x=y.x(),w=y.y(),P=this.getWidth()-$.x(),L=this.getHeight()-$.y();$.move({x:-x,y:-w}),y.move({x:P,y:L})}const p=this.findOne(".top-left").getAbsolutePosition();t=p.x,i=p.y;const b=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),m=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodesInto({x:t,y:i,width:b,height:m,rotation:le.getAngle(this.rotation())},e)}_handleMouseUp(e){this._removeEvents(e)}getAbsoluteTransform(){return this.getTransform()}_removeEvents(e){var t;if(this._transforming){this._transforming=!1,typeof window<"u"&&(window.removeEventListener("mousemove",this._handleMouseMove),window.removeEventListener("touchmove",this._handleMouseMove),window.removeEventListener("mouseup",this._handleMouseUp,!0),window.removeEventListener("touchend",this._handleMouseUp,!0));const i=this.getNode();Ai--,this._fire("transformend",{evt:e,target:i}),(t=this.getLayer())===null||t===void 0||t.batchDraw(),i&&this._nodes.forEach(s=>{var r;s._fire("transformend",{evt:e,target:s}),(r=s.getLayer())===null||r===void 0||r.batchDraw()}),this._movingAnchorName=null}}_fitNodesInto(e,t){const i=this._getNodeRect(),s=1;if(U._inRange(e.width,-this.padding()*2-s,s)){this.update();return}if(U._inRange(e.height,-this.padding()*2-s,s)){this.update();return}const r=new Ke;if(r.rotate(le.getAngle(this.rotation())),this._movingAnchorName&&e.width<0&&this._movingAnchorName.indexOf("left")>=0){const g=r.point({x:-this.padding()*2,y:0});e.x+=g.x,e.y+=g.y,e.width+=this.padding()*2,this._movingAnchorName=this._movingAnchorName.replace("left","right"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y}else if(this._movingAnchorName&&e.width<0&&this._movingAnchorName.indexOf("right")>=0){const g=r.point({x:this.padding()*2,y:0});this._movingAnchorName=this._movingAnchorName.replace("right","left"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y,e.width+=this.padding()*2}if(this._movingAnchorName&&e.height<0&&this._movingAnchorName.indexOf("top")>=0){const g=r.point({x:0,y:-this.padding()*2});e.x+=g.x,e.y+=g.y,this._movingAnchorName=this._movingAnchorName.replace("top","bottom"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y,e.height+=this.padding()*2}else if(this._movingAnchorName&&e.height<0&&this._movingAnchorName.indexOf("bottom")>=0){const g=r.point({x:0,y:this.padding()*2});this._movingAnchorName=this._movingAnchorName.replace("bottom","top"),this._anchorDragOffset.x-=g.x,this._anchorDragOffset.y-=g.y,e.height+=this.padding()*2}if(this.boundBoxFunc()){const g=this.boundBoxFunc()(i,e);g?e=g:U.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const a=1e7,l=new Ke;l.translate(i.x,i.y),l.rotate(i.rotation),l.scale(i.width/a,i.height/a);const o=new Ke,c=e.width/a,d=e.height/a;this.flipEnabled()===!1?(o.translate(e.x,e.y),o.rotate(e.rotation),o.translate(e.width<0?e.width:0,e.height<0?e.height:0),o.scale(Math.abs(c),Math.abs(d))):(o.translate(e.x,e.y),o.rotate(e.rotation),o.scale(c,d));const u=o.multiply(l.invert());this._nodes.forEach(g=>{var v;if(!g.getStage())return;const h=g.getParent().getAbsoluteTransform(),p=g.getTransform().copy();p.translate(g.offsetX(),g.offsetY());const b=new Ke;b.multiply(h.copy().invert()).multiply(u).multiply(h).multiply(p);const m=b.decompose();g.setAttrs(m),(v=g.getLayer())===null||v===void 0||v.batchDraw()}),this.rotation(U._getRotation(e.rotation)),this._nodes.forEach(g=>{this._fire("transform",{evt:t,target:g}),g._fire("transform",{evt:t,target:g})}),this._resetTransformCache(),this.update(),this.getLayer().batchDraw()}forceUpdate(){this._resetTransformCache(),this.update()}_batchChangeChild(e,t){this.findOne(e).setAttrs(t)}update(){var e;const t=this._getNodeRect();this.rotation(U._getRotation(t.rotation));const i=t.width,s=t.height,r=this.enabledAnchors(),a=this.resizeEnabled(),l=this.padding(),o=this.anchorSize(),c=this.find("._anchor");c.forEach(u=>{u.setAttrs({width:o,height:o,offsetX:o/2,offsetY:o/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius()})}),this._batchChangeChild(".top-left",{x:0,y:0,offsetX:o/2+l,offsetY:o/2+l,visible:a&&r.indexOf("top-left")>=0}),this._batchChangeChild(".top-center",{x:i/2,y:0,offsetY:o/2+l,visible:a&&r.indexOf("top-center")>=0}),this._batchChangeChild(".top-right",{x:i,y:0,offsetX:o/2-l,offsetY:o/2+l,visible:a&&r.indexOf("top-right")>=0}),this._batchChangeChild(".middle-left",{x:0,y:s/2,offsetX:o/2+l,visible:a&&r.indexOf("middle-left")>=0}),this._batchChangeChild(".middle-right",{x:i,y:s/2,offsetX:o/2-l,visible:a&&r.indexOf("middle-right")>=0}),this._batchChangeChild(".bottom-left",{x:0,y:s,offsetX:o/2+l,offsetY:o/2-l,visible:a&&r.indexOf("bottom-left")>=0}),this._batchChangeChild(".bottom-center",{x:i/2,y:s,offsetY:o/2-l,visible:a&&r.indexOf("bottom-center")>=0}),this._batchChangeChild(".bottom-right",{x:i,y:s,offsetX:o/2-l,offsetY:o/2-l,visible:a&&r.indexOf("bottom-right")>=0}),this._batchChangeChild(".rotater",{x:i/2,y:-this.rotateAnchorOffset()*U._sign(s)-l,visible:this.rotateEnabled()}),this._batchChangeChild(".back",{width:i,height:s,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),draggable:this.nodes().some(u=>u.draggable()),x:0,y:0});const d=this.anchorStyleFunc();d&&c.forEach(u=>{d(u)}),(e=this.getLayer())===null||e===void 0||e.batchDraw()}isTransforming(){return this._transforming}stopTransform(){if(this._transforming){this._removeEvents();const e=this.findOne("."+this._movingAnchorName);e&&e.stopDrag()}}destroy(){return this.getStage()&&this._cursorChange&&this.getStage().content&&(this.getStage().content.style.cursor=""),Yt.prototype.destroy.call(this),this.detach(),this._removeEvents(),this}toObject(){return se.prototype.toObject.call(this)}clone(e){return se.prototype.clone.call(this,e)}getClientRect(){return this.nodes().length>0?super.getClientRect():{x:0,y:0,width:0,height:0}}}Ee.isTransforming=()=>Ai>0;function xd(n){return n instanceof Array||U.warn("enabledAnchors value should be an array"),n instanceof Array&&n.forEach(function(e){Vn.indexOf(e)===-1&&U.warn("Unknown anchor name: "+e+". Available names are: "+Vn.join(", "))}),n||[]}Ee.prototype.className="Transformer";Be(Ee);T.addGetterSetter(Ee,"enabledAnchors",Vn,xd);T.addGetterSetter(Ee,"flipEnabled",!0,lt());T.addGetterSetter(Ee,"resizeEnabled",!0);T.addGetterSetter(Ee,"anchorSize",10,re());T.addGetterSetter(Ee,"rotateEnabled",!0);T.addGetterSetter(Ee,"rotateLineVisible",!0);T.addGetterSetter(Ee,"rotationSnaps",[]);T.addGetterSetter(Ee,"rotateAnchorOffset",50,re());T.addGetterSetter(Ee,"rotateAnchorCursor","crosshair");T.addGetterSetter(Ee,"rotationSnapTolerance",5,re());T.addGetterSetter(Ee,"borderEnabled",!0);T.addGetterSetter(Ee,"anchorStroke","rgb(0, 161, 255)");T.addGetterSetter(Ee,"anchorStrokeWidth",1,re());T.addGetterSetter(Ee,"anchorFill","white");T.addGetterSetter(Ee,"anchorCornerRadius",0,re());T.addGetterSetter(Ee,"borderStroke","rgb(0, 161, 255)");T.addGetterSetter(Ee,"borderStrokeWidth",1,re());T.addGetterSetter(Ee,"borderDash");T.addGetterSetter(Ee,"keepRatio",!0);T.addGetterSetter(Ee,"shiftBehavior","default");T.addGetterSetter(Ee,"centeredScaling",!1);T.addGetterSetter(Ee,"ignoreStroke",!1);T.addGetterSetter(Ee,"padding",0,re());T.addGetterSetter(Ee,"nodes");T.addGetterSetter(Ee,"node");T.addGetterSetter(Ee,"boundBoxFunc");T.addGetterSetter(Ee,"anchorDragBoundFunc");T.addGetterSetter(Ee,"anchorStyleFunc");T.addGetterSetter(Ee,"shouldOverdrawWholeArea",!1);T.addGetterSetter(Ee,"useSingleNodeRotation",!0);T.backCompat(Ee,{lineEnabled:"borderEnabled",rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"});class yt extends Z{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.radius(),0,le.getAngle(this.angle()),this.clockwise()),e.lineTo(0,0),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius(e/2)}setHeight(e){this.radius(e/2)}}yt.prototype.className="Wedge";yt.prototype._centroid=!0;yt.prototype._attrsAffectingSize=["radius"];Be(yt);T.addGetterSetter(yt,"radius",0,re());T.addGetterSetter(yt,"angle",0,re());T.addGetterSetter(yt,"clockwise",!1);T.backCompat(yt,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"});function Cs(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}const Sd=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],wd=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function $d(n,e){const t=n.data,i=n.width,s=n.height;let r,a,l,o,c,d,u,g,v,h,p,b,m,y,$,x,w,P,L,D;const z=e+e+1,E=i-1,R=s-1,k=e+1,q=k*(k+1)/2,N=new Cs,C=Sd[e],A=wd[e];let X=null,G=N,O=null,V=null;for(let B=1;B<z;B++)G=G.next=new Cs,B===k&&(X=G);G.next=N,l=a=0;for(let B=0;B<s;B++){b=m=y=$=o=c=d=u=0,g=k*(x=t[a]),v=k*(w=t[a+1]),h=k*(P=t[a+2]),p=k*(L=t[a+3]),o+=q*x,c+=q*w,d+=q*P,u+=q*L,G=N;for(let H=0;H<k;H++)G.r=x,G.g=w,G.b=P,G.a=L,G=G.next;for(let H=1;H<k;H++)r=a+((E<H?E:H)<<2),o+=(G.r=x=t[r])*(D=k-H),c+=(G.g=w=t[r+1])*D,d+=(G.b=P=t[r+2])*D,u+=(G.a=L=t[r+3])*D,b+=x,m+=w,y+=P,$+=L,G=G.next;O=N,V=X;for(let H=0;H<i;H++)t[a+3]=L=u*C>>A,L!==0?(L=255/L,t[a]=(o*C>>A)*L,t[a+1]=(c*C>>A)*L,t[a+2]=(d*C>>A)*L):t[a]=t[a+1]=t[a+2]=0,o-=g,c-=v,d-=h,u-=p,g-=O.r,v-=O.g,h-=O.b,p-=O.a,r=l+((r=H+e+1)<E?r:E)<<2,b+=O.r=t[r],m+=O.g=t[r+1],y+=O.b=t[r+2],$+=O.a=t[r+3],o+=b,c+=m,d+=y,u+=$,O=O.next,g+=x=V.r,v+=w=V.g,h+=P=V.b,p+=L=V.a,b-=x,m-=w,y-=P,$-=L,V=V.next,a+=4;l+=i}for(let B=0;B<i;B++){m=y=$=b=c=d=u=o=0,a=B<<2,g=k*(x=t[a]),v=k*(w=t[a+1]),h=k*(P=t[a+2]),p=k*(L=t[a+3]),o+=q*x,c+=q*w,d+=q*P,u+=q*L,G=N;for(let j=0;j<k;j++)G.r=x,G.g=w,G.b=P,G.a=L,G=G.next;let H=i;for(let j=1;j<=e;j++)a=H+B<<2,o+=(G.r=x=t[a])*(D=k-j),c+=(G.g=w=t[a+1])*D,d+=(G.b=P=t[a+2])*D,u+=(G.a=L=t[a+3])*D,b+=x,m+=w,y+=P,$+=L,G=G.next,j<R&&(H+=i);a=B,O=N,V=X;for(let j=0;j<s;j++)r=a<<2,t[r+3]=L=u*C>>A,L>0?(L=255/L,t[r]=(o*C>>A)*L,t[r+1]=(c*C>>A)*L,t[r+2]=(d*C>>A)*L):t[r]=t[r+1]=t[r+2]=0,o-=g,c-=v,d-=h,u-=p,g-=O.r,v-=O.g,h-=O.b,p-=O.a,r=B+((r=j+k)<R?r:R)*i<<2,o+=b+=O.r=t[r],c+=m+=O.g=t[r+1],d+=y+=O.b=t[r+2],u+=$+=O.a=t[r+3],O=O.next,g+=x=V.r,v+=w=V.g,h+=P=V.b,p+=L=V.a,b-=x,m-=w,y-=P,$-=L,V=V.next,a+=i}}const Cd=function(e){const t=Math.round(this.blurRadius());t>0&&$d(e,t)};T.addGetterSetter(se,"blurRadius",0,re(),T.afterSetFilter);const kd=function(n){const e=this.brightness()*255,t=n.data,i=t.length;for(let s=0;s<i;s+=4)t[s]+=e,t[s+1]+=e,t[s+2]+=e};T.addGetterSetter(se,"brightness",0,re(),T.afterSetFilter);const Td=function(n){const e=this.brightness(),t=n.data,i=t.length;for(let s=0;s<i;s+=4)t[s]=Math.min(255,t[s]*e),t[s+1]=Math.min(255,t[s+1]*e),t[s+2]=Math.min(255,t[s+2]*e)},Ed=function(n){const e=Math.pow((this.contrast()+100)/100,2),t=n.data,i=t.length;let s=150,r=150,a=150;for(let l=0;l<i;l+=4)s=t[l],r=t[l+1],a=t[l+2],s/=255,s-=.5,s*=e,s+=.5,s*=255,r/=255,r-=.5,r*=e,r+=.5,r*=255,a/=255,a-=.5,a*=e,a+=.5,a*=255,s=s<0?0:s>255?255:s,r=r<0?0:r>255?255:r,a=a<0?0:a>255?255:a,t[l]=s,t[l+1]=r,t[l+2]=a};T.addGetterSetter(se,"contrast",0,re(),T.afterSetFilter);const Pd=function(n){var e,t,i,s,r,a,l,o,c;const d=n.data,u=n.width,g=n.height,v=Math.min(1,Math.max(0,(t=(e=this.embossStrength)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:.5)),h=Math.min(1,Math.max(0,(s=(i=this.embossWhiteLevel)===null||i===void 0?void 0:i.call(this))!==null&&s!==void 0?s:.5)),b=(l={"top-left":315,top:270,"top-right":225,right:180,"bottom-right":135,bottom:90,"bottom-left":45,left:0}[(a=(r=this.embossDirection)===null||r===void 0?void 0:r.call(this))!==null&&a!==void 0?a:"top-left"])!==null&&l!==void 0?l:315,m=!!((c=(o=this.embossBlend)===null||o===void 0?void 0:o.call(this))!==null&&c!==void 0&&c),y=v*10,$=h*255,x=b*Math.PI/180,w=Math.cos(x),P=Math.sin(x),L=128/1020*y,D=new Uint8ClampedArray(d),z=new Float32Array(u*g);for(let N=0,C=0;C<d.length;C+=4,N++)z[N]=.2126*D[C]+.7152*D[C+1]+.0722*D[C+2];const E=[-1,0,1,-2,0,2,-1,0,1],R=[-1,-2,-1,0,0,0,1,2,1],k=[-u-1,-u,-u+1,-1,0,1,u-1,u,u+1],q=N=>N<0?0:N>255?255:N;for(let N=1;N<g-1;N++)for(let C=1;C<u-1;C++){const A=N*u+C;let X=0,G=0;X+=z[A+k[0]]*E[0],G+=z[A+k[0]]*R[0],X+=z[A+k[1]]*E[1],G+=z[A+k[1]]*R[1],X+=z[A+k[2]]*E[2],G+=z[A+k[2]]*R[2],X+=z[A+k[3]]*E[3],G+=z[A+k[3]]*R[3],X+=z[A+k[5]]*E[5],G+=z[A+k[5]]*R[5],X+=z[A+k[6]]*E[6],G+=z[A+k[6]]*R[6],X+=z[A+k[7]]*E[7],G+=z[A+k[7]]*R[7],X+=z[A+k[8]]*E[8],G+=z[A+k[8]]*R[8];const O=w*X+P*G,V=q($+O*L),B=A*4;if(m){const H=V-$;d[B]=q(D[B]+H),d[B+1]=q(D[B+1]+H),d[B+2]=q(D[B+2]+H),d[B+3]=D[B+3]}else d[B]=d[B+1]=d[B+2]=V,d[B+3]=D[B+3]}for(let N=0;N<u;N++){let C=N*4,A=((g-1)*u+N)*4;d[C]=D[C],d[C+1]=D[C+1],d[C+2]=D[C+2],d[C+3]=D[C+3],d[A]=D[A],d[A+1]=D[A+1],d[A+2]=D[A+2],d[A+3]=D[A+3]}for(let N=1;N<g-1;N++){let C=N*u*4,A=(N*u+(u-1))*4;d[C]=D[C],d[C+1]=D[C+1],d[C+2]=D[C+2],d[C+3]=D[C+3],d[A]=D[A],d[A+1]=D[A+1],d[A+2]=D[A+2],d[A+3]=D[A+3]}return n};T.addGetterSetter(se,"embossStrength",.5,re(),T.afterSetFilter);T.addGetterSetter(se,"embossWhiteLevel",.5,re(),T.afterSetFilter);T.addGetterSetter(se,"embossDirection","top-left",void 0,T.afterSetFilter);T.addGetterSetter(se,"embossBlend",!1,void 0,T.afterSetFilter);function gi(n,e,t,i,s){const r=t-e,a=s-i;if(r===0)return i+a/2;if(a===0)return i;let l=(n-e)/r;return l=a*l+i,l}const Ad=function(n){const e=n.data,t=e.length;let i=e[0],s=i,r,a=e[1],l=a,o,c=e[2],d=c,u;const g=this.enhance();if(g===0)return;for(let $=0;$<t;$+=4)r=e[$+0],r<i?i=r:r>s&&(s=r),o=e[$+1],o<a?a=o:o>l&&(l=o),u=e[$+2],u<c?c=u:u>d&&(d=u);s===i&&(s=255,i=0),l===a&&(l=255,a=0),d===c&&(d=255,c=0);let v,h,p,b,m,y;if(g>0)v=s+g*(255-s),h=i-g*(i-0),p=l+g*(255-l),b=a-g*(a-0),m=d+g*(255-d),y=c-g*(c-0);else{const $=(s+i)*.5;v=s+g*(s-$),h=i+g*(i-$);const x=(l+a)*.5;p=l+g*(l-x),b=a+g*(a-x);const w=(d+c)*.5;m=d+g*(d-w),y=c+g*(c-w)}for(let $=0;$<t;$+=4)e[$+0]=gi(e[$+0],i,s,h,v),e[$+1]=gi(e[$+1],a,l,b,p),e[$+2]=gi(e[$+2],c,d,y,m)};T.addGetterSetter(se,"enhance",0,re(),T.afterSetFilter);const Rd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4){const s=.34*e[i]+.5*e[i+1]+.16*e[i+2];e[i]=s,e[i+1]=s,e[i+2]=s}};T.addGetterSetter(se,"hue",0,re(),T.afterSetFilter);T.addGetterSetter(se,"saturation",0,re(),T.afterSetFilter);T.addGetterSetter(se,"luminance",0,re(),T.afterSetFilter);const Ld=function(n){const e=n.data,t=e.length,i=1,s=Math.pow(2,this.saturation()),r=Math.abs(this.hue()+360)%360,a=this.luminance()*127,l=i*s*Math.cos(r*Math.PI/180),o=i*s*Math.sin(r*Math.PI/180),c=.299*i+.701*l+.167*o,d=.587*i-.587*l+.33*o,u=.114*i-.114*l-.497*o,g=.299*i-.299*l-.328*o,v=.587*i+.413*l+.035*o,h=.114*i-.114*l+.293*o,p=.299*i-.3*l+1.25*o,b=.587*i-.586*l-1.05*o,m=.114*i+.886*l-.2*o;let y,$,x,w;for(let P=0;P<t;P+=4)y=e[P+0],$=e[P+1],x=e[P+2],w=e[P+3],e[P+0]=c*y+d*$+u*x+a,e[P+1]=g*y+v*$+h*x+a,e[P+2]=p*y+b*$+m*x+a,e[P+3]=w},Md=function(n){const e=n.data,t=e.length,i=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),r=Math.abs(this.hue()+360)%360,a=i*s*Math.cos(r*Math.PI/180),l=i*s*Math.sin(r*Math.PI/180),o=.299*i+.701*a+.167*l,c=.587*i-.587*a+.33*l,d=.114*i-.114*a-.497*l,u=.299*i-.299*a-.328*l,g=.587*i+.413*a+.035*l,v=.114*i-.114*a+.293*l,h=.299*i-.3*a+1.25*l,p=.587*i-.586*a-1.05*l,b=.114*i+.886*a-.2*l;for(let m=0;m<t;m+=4){const y=e[m+0],$=e[m+1],x=e[m+2],w=e[m+3];e[m+0]=o*y+c*$+d*x,e[m+1]=u*y+g*$+v*x,e[m+2]=h*y+p*$+b*x,e[m+3]=w}};T.addGetterSetter(se,"hue",0,re(),T.afterSetFilter);T.addGetterSetter(se,"saturation",0,re(),T.afterSetFilter);T.addGetterSetter(se,"value",0,re(),T.afterSetFilter);const Dd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4)e[i]=255-e[i],e[i+1]=255-e[i+1],e[i+2]=255-e[i+2]},Od=function(n,e,t){const i=n.data,s=e.data,r=n.width,a=n.height,l=t.polarCenterX||r/2,o=t.polarCenterY||a/2;let c=Math.sqrt(l*l+o*o),d=r-l,u=a-o;const g=Math.sqrt(d*d+u*u);c=g>c?g:c;const v=a,h=r,p=360/h*Math.PI/180;for(let b=0;b<h;b+=1){const m=Math.sin(b*p),y=Math.cos(b*p);for(let $=0;$<v;$+=1){d=Math.floor(l+c*$/v*y),u=Math.floor(o+c*$/v*m);let x=(u*r+d)*4;const w=i[x+0],P=i[x+1],L=i[x+2],D=i[x+3];x=(b+$*r)*4,s[x+0]=w,s[x+1]=P,s[x+2]=L,s[x+3]=D}}},Id=function(n,e,t){const i=n.data,s=e.data,r=n.width,a=n.height,l=t.polarCenterX||r/2,o=t.polarCenterY||a/2;let c=Math.sqrt(l*l+o*o),d=r-l,u=a-o;const g=Math.sqrt(d*d+u*u);c=g>c?g:c;const v=a,h=r,p=0;let b,m;for(d=0;d<r;d+=1)for(u=0;u<a;u+=1){const y=d-l,$=u-o,x=Math.sqrt(y*y+$*$)*v/c;let w=(Math.atan2($,y)*180/Math.PI+360+p)%360;w=w*h/360,b=Math.floor(w),m=Math.floor(x);let P=(m*r+b)*4;const L=i[P+0],D=i[P+1],z=i[P+2],E=i[P+3];P=(u*r+d)*4,s[P+0]=L,s[P+1]=D,s[P+2]=z,s[P+3]=E}},Nd=function(n){const e=n.width,t=n.height;let i,s,r,a,l,o,c,d,u,g,v=Math.round(this.kaleidoscopePower());const h=Math.round(this.kaleidoscopeAngle()),p=Math.floor(e*(h%360)/360);if(v<1)return;const b=U.createCanvasElement();b.width=e,b.height=t;const m=b.getContext("2d").getImageData(0,0,e,t);U.releaseCanvas(b),Od(n,m,{polarCenterX:e/2,polarCenterY:t/2});let y=e/Math.pow(2,v);for(;y<=8;)y=y*2,v-=1;y=Math.ceil(y);let $=y,x=0,w=$,P=1;for(p+y>e&&(x=$,w=0,P=-1),s=0;s<t;s+=1)for(i=x;i!==w;i+=P)r=Math.round(i+p)%e,u=(e*s+r)*4,l=m.data[u+0],o=m.data[u+1],c=m.data[u+2],d=m.data[u+3],g=(e*s+i)*4,m.data[g+0]=l,m.data[g+1]=o,m.data[g+2]=c,m.data[g+3]=d;for(s=0;s<t;s+=1)for($=Math.floor(y),a=0;a<v;a+=1){for(i=0;i<$+1;i+=1)u=(e*s+i)*4,l=m.data[u+0],o=m.data[u+1],c=m.data[u+2],d=m.data[u+3],g=(e*s+$*2-i-1)*4,m.data[g+0]=l,m.data[g+1]=o,m.data[g+2]=c,m.data[g+3]=d;$*=2}Id(m,n,{})};T.addGetterSetter(se,"kaleidoscopePower",2,re(),T.afterSetFilter);T.addGetterSetter(se,"kaleidoscopeAngle",0,re(),T.afterSetFilter);function Dn(n,e,t){let i=(t*n.width+e)*4;const s=[];return s.push(n.data[i++],n.data[i++],n.data[i++],n.data[i++]),s}function sn(n,e){return Math.sqrt(Math.pow(n[0]-e[0],2)+Math.pow(n[1]-e[1],2)+Math.pow(n[2]-e[2],2))}function zd(n){const e=[0,0,0];for(let t=0;t<n.length;t++)e[0]+=n[t][0],e[1]+=n[t][1],e[2]+=n[t][2];return e[0]/=n.length,e[1]/=n.length,e[2]/=n.length,e}function Fd(n,e){const t=Dn(n,0,0),i=Dn(n,n.width-1,0),s=Dn(n,0,n.height-1),r=Dn(n,n.width-1,n.height-1),a=e||10;if(sn(t,i)<a&&sn(i,r)<a&&sn(r,s)<a&&sn(s,t)<a){const l=zd([i,t,r,s]),o=[];for(let c=0;c<n.width*n.height;c++){const d=sn(l,[n.data[c*4],n.data[c*4+1],n.data[c*4+2]]);o[c]=d<a?0:255}return o}}function Gd(n,e){for(let t=0;t<n.width*n.height;t++)n.data[4*t+3]=e[t]}function Bd(n,e,t){const i=[1,1,1,1,0,1,1,1,1],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let u=0;u<s;u++)for(let g=0;g<s;g++){const v=l+u-r,h=o+g-r;if(v>=0&&v<t&&h>=0&&h<e){const p=v*e+h,b=i[u*s+g];d+=n[p]*b}}a[c]=d===255*8?255:0}return a}function Ud(n,e,t){const i=[1,1,1,1,1,1,1,1,1],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let u=0;u<s;u++)for(let g=0;g<s;g++){const v=l+u-r,h=o+g-r;if(v>=0&&v<t&&h>=0&&h<e){const p=v*e+h,b=i[u*s+g];d+=n[p]*b}}a[c]=d>=255*4?255:0}return a}function Hd(n,e,t){const i=[.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let u=0;u<s;u++)for(let g=0;g<s;g++){const v=l+u-r,h=o+g-r;if(v>=0&&v<t&&h>=0&&h<e){const p=v*e+h,b=i[u*s+g];d+=n[p]*b}}a[c]=d}return a}const qd=function(n){const e=this.threshold();let t=Fd(n,e);return t&&(t=Bd(t,n.width,n.height),t=Ud(t,n.width,n.height),t=Hd(t,n.width,n.height),Gd(n,t)),n};T.addGetterSetter(se,"threshold",0,re(),T.afterSetFilter);const Wd=function(n){const e=this.noise()*255,t=n.data,i=t.length,s=e/2;for(let r=0;r<i;r+=4)t[r+0]+=s-2*s*Math.random(),t[r+1]+=s-2*s*Math.random(),t[r+2]+=s-2*s*Math.random()};T.addGetterSetter(se,"noise",.2,re(),T.afterSetFilter);const jd=function(n){let e=Math.ceil(this.pixelSize()),t=n.width,i=n.height,s=Math.ceil(t/e),r=Math.ceil(i/e),a=n.data;if(e<=0){U.error("pixelSize value can not be <= 0");return}for(let l=0;l<s;l+=1)for(let o=0;o<r;o+=1){let c=0,d=0,u=0,g=0;const v=l*e,h=v+e,p=o*e,b=p+e;let m=0;for(let y=v;y<h;y+=1)if(!(y>=t))for(let $=p;$<b;$+=1){if($>=i)continue;const x=(t*$+y)*4;c+=a[x+0],d+=a[x+1],u+=a[x+2],g+=a[x+3],m+=1}c=c/m,d=d/m,u=u/m,g=g/m;for(let y=v;y<h;y+=1)if(!(y>=t))for(let $=p;$<b;$+=1){if($>=i)continue;const x=(t*$+y)*4;a[x+0]=c,a[x+1]=d,a[x+2]=u,a[x+3]=g}}};T.addGetterSetter(se,"pixelSize",8,re(),T.afterSetFilter);const Yd=function(n){const e=Math.round(this.levels()*254)+1,t=n.data,i=t.length,s=255/e;for(let r=0;r<i;r+=1)t[r]=Math.floor(t[r]/s)*s};T.addGetterSetter(se,"levels",.5,re(),T.afterSetFilter);const Vd=function(n){const e=n.data,t=e.length,i=this.red(),s=this.green(),r=this.blue();for(let a=0;a<t;a+=4){const l=(.34*e[a]+.5*e[a+1]+.16*e[a+2])/255;e[a]=l*i,e[a+1]=l*s,e[a+2]=l*r,e[a+3]=e[a+3]}};T.addGetterSetter(se,"red",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"green",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"blue",0,lr,T.afterSetFilter);const Xd=function(n){const e=n.data,t=e.length,i=this.red(),s=this.green(),r=this.blue(),a=this.alpha();for(let l=0;l<t;l+=4){const o=1-a;e[l]=i*a+e[l]*o,e[l+1]=s*a+e[l+1]*o,e[l+2]=r*a+e[l+2]*o}};T.addGetterSetter(se,"red",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"green",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});T.addGetterSetter(se,"blue",0,lr,T.afterSetFilter);T.addGetterSetter(se,"alpha",1,function(n){return this._filterUpToDate=!1,n>1?1:n<0?0:n});const Qd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4){const s=e[i+0],r=e[i+1],a=e[i+2];e[i+0]=Math.min(255,s*.393+r*.769+a*.189),e[i+1]=Math.min(255,s*.349+r*.686+a*.168),e[i+2]=Math.min(255,s*.272+r*.534+a*.131)}},Jd=function(n){const t=n.data;for(let i=0;i<t.length;i+=4){const s=t[i],r=t[i+1],a=t[i+2];.2126*s+.7152*r+.0722*a>=128&&(t[i]=255-s,t[i+1]=255-r,t[i+2]=255-a)}return n},Kd=function(n){const e=this.threshold()*255,t=n.data,i=t.length;for(let s=0;s<i;s+=1)t[s]=t[s]<e?0:255};T.addGetterSetter(se,"threshold",.5,re(),T.afterSetFilter);const Je=fs.Util._assign(fs,{Arc:mt,Arrow:Nt,Circle:Jt,Ellipse:kt,Image:rt,Label:Ni,Tag:zt,Line:bt,Path:ze,Rect:xn,RegularPolygon:Tt,Ring:Ft,Sprite:ht,Star:Et,Text:Fe,TextPath:qe,Transformer:Ee,Wedge:yt,Filters:{Blur:Cd,Brightness:Td,Brighten:kd,Contrast:Ed,Emboss:Pd,Enhance:Ad,Grayscale:Rd,HSL:Ld,HSV:Md,Invert:Dd,Kaleidoscope:Nd,Mask:qd,Noise:Wd,Pixelate:jd,Posterize:Yd,RGB:Vd,RGBA:Xd,Sepia:Qd,Solarize:Jd,Threshold:Kd}});class Zd{stage;layer;elements;backgroundLayer;constructor(e,t={}){if(this.stage=new Je.Stage({container:e,width:t.width||e.clientWidth,height:t.height||e.clientHeight}),this.backgroundLayer=new Je.Layer,this.stage.add(this.backgroundLayer),t.background){const i=new Je.Rect({x:0,y:0,width:this.stage.width(),height:this.stage.height(),fill:t.background});this.backgroundLayer.add(i)}this.layer=new Je.Layer,this.stage.add(this.layer),this.elements=new Map}render(e){this.layer.destroyChildren(),this.elements.clear();const t=performance.now();e.forEach(s=>{const r=this.createElement(s);r&&(this.layer.add(r),this.elements.set(s.id,r))}),this.layer.batchDraw();const i=performance.now()-t;console.log(`✨ Konva渲染完成: ${e.length}个元素, 耗时${i.toFixed(2)}ms`)}createElement(e){const t=e.content.type;switch(t){case"Text":return this.createText(e);case"Rectangle":return this.createRectangle(e);case"Image":return this.createImage(e);case"Line":return this.createLine(e);case"DataField":return this.createDataField(e);default:return console.warn(`未知元素类型: ${t}`),null}}createText(e){if(e.content.type!=="Text")return new Je.Text({});const t=e.content,i=t.style;return new Je.Text({id:e.id,x:e.position.x,y:e.position.y,text:t.content||"文本",fontSize:i.font_size||14,fontFamily:i.font_family||"Arial",fontStyle:i.font_weight==="bold"?"bold":"normal",fill:i.color||"#000000",width:e.size.width,align:i.align==="Center"?"center":i.align==="Right"?"right":"left",verticalAlign:"top",wrap:"word",ellipsis:!0})}createRectangle(e){if(e.content.type!=="Rectangle")return new Je.Rect({});const t=e.content;return new Je.Rect({id:e.id,x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,fill:t.fill_color||"transparent",stroke:t.border?.color||"#000000",strokeWidth:t.border?.width||0,cornerRadius:t.corner_radius||0,opacity:t.opacity||1})}createImage(e){const t=new Je.Rect({id:e.id+"_placeholder",x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,fill:"#f0f0f0",stroke:"#cccccc",strokeWidth:1});if(e.content.type==="Image"){const i=e.content,s=new window.Image;s.onload=()=>{const r=new Je.Image({id:e.id,x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,image:s});t.destroy(),this.layer.add(r),this.elements.set(e.id,r),this.layer.batchDraw()},s.onerror=()=>{console.error(`图片加载失败: ${i.src}`)},s.src=i.src}return t}createLine(e){const i=e.size.height<e.size.width?[0,0,e.size.width,0]:[0,0,0,e.size.height];if(e.content.type!=="Line")return new Je.Line({});const s=e.content,r=s.line_style==="Dashed"?[5,5]:s.line_style==="Dotted"?[2,2]:s.line_style==="DashDot"?[5,2,2,2]:void 0,a={id:e.id,x:e.position.x,y:e.position.y,points:i,stroke:s.color||"#000000",strokeWidth:s.width||1,lineCap:"round",lineJoin:"round"};return r&&(a.dash=r),new Je.Line(a)}createDataField(e){if(e.content.type!=="DataField")return new Je.Text({});const t=e.content,i=t.style;return new Je.Text({id:e.id,x:e.position.x,y:e.position.y,text:t.expression||"[Data Field]",fontSize:i.font_size||14,fontFamily:i.font_family||"Arial",fontStyle:i.font_weight==="bold"?"bold":"normal",fill:i.color||"#000000",width:e.size.width,align:i.align==="Center"?"center":i.align==="Right"?"right":"left",verticalAlign:"top",wrap:"word",ellipsis:!0})}setScale(e){this.stage.scale({x:e,y:e}),this.stage.batchDraw()}getScale(){return this.stage.scaleX()}setPosition(e,t){this.stage.position({x:e,y:t}),this.stage.batchDraw()}getPosition(){return this.stage.position()}fitToContainer(){const t=this.stage.container().getBoundingClientRect();this.stage.width(t.width),this.stage.height(t.height);const i=this.backgroundLayer.findOne("Rect");i&&(i.width(t.width),i.height(t.height)),this.stage.batchDraw()}async toDataURL(e={}){return this.stage.toDataURL({pixelRatio:e.pixelRatio||2,mimeType:e.mimeType||"image/png"})}destroy(){this.elements.clear(),this.stage.destroy()}getStats(){return{elementsCount:this.elements.size,layersCount:this.stage.getLayers().length,stageSize:{width:this.stage.width(),height:this.stage.height()},scale:this.getScale(),position:this.getPosition()}}}var eh=S('<div class="floating-toolbar fixed top-4 left-1/2 transform -translate-x-1/2 z-50"><div class="toolbar-container flex items-center gap-2 px-4 py-2 bg-gray-900 rounded-lg shadow-2xl"><div class="page-nav flex items-center gap-1"><button class="nav-btn p-1 text-white hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"title=上一页><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 19l-7-7 7-7"></path></svg></button><div class="page-display flex items-center gap-1 text-white text-sm"><input type=number class="page-input w-12 px-1 py-0.5 bg-gray-800 text-center rounded outline-none focus:bg-gray-700"min=1><span>/</span><span></span></div><button class="nav-btn p-1 text-white hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"title=下一页><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"></path></svg></button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="zoom-controls flex items-center gap-1"><button class="zoom-btn p-1 text-white hover:bg-gray-700 rounded"title=缩小><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M20 12H4"></path></svg></button><div class="zoom-display flex items-center gap-1 text-white text-sm"><input type=number class="zoom-input w-14 px-1 py-0.5 bg-gray-800 text-center rounded outline-none focus:bg-gray-700"min=10 max=500 step=10><span>%</span></div><button class="zoom-btn p-1 text-white hover:bg-gray-700 rounded"title=放大><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M12 4v16m8-8H4"></path></svg></button><button class="fit-btn p-1 text-white hover:bg-gray-700 rounded"title=适应屏幕><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg></button><button class="actual-btn p-1 text-white hover:bg-gray-700 rounded"title=实际大小><span class="text-xs font-bold">1:1</span></button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="mode-controls flex items-center gap-1"><button title=演示模式>演示</button><button title=开发模式>开发</button><button title=打印模式>打印</button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="quick-actions flex items-center gap-1"><button class="action-btn p-1 text-white hover:bg-gray-700 rounded"title=导出><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button><button class="action-btn p-1 text-white hover:bg-gray-700 rounded"title=打印><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button><button class="exit-btn px-2 py-1 text-xs bg-red-600 text-white hover:bg-red-700 rounded"title="退出预览 (ESC)">退出');const th=n=>{const[e,t]=K(1),[i,s]=K(!1);let r=null;const a=()=>{r&&clearTimeout(r),r=window.setTimeout(()=>{i()||t(.3)},3e3)},l=()=>{r&&(clearTimeout(r),r=null),t(1)};Qe(()=>{a()}),dt(()=>{r&&clearTimeout(r)});const o=()=>{s(!0),l()},c=()=>{s(!1),a()},d=()=>{n.currentPage>1&&n.onPageChange(n.currentPage-1)},u=()=>{n.currentPage<n.totalPages&&n.onPageChange(n.currentPage+1)},g=()=>{const b=Math.min(500,n.zoom+25);n.onZoomChange(b)},v=()=>{const b=Math.max(10,n.zoom-25);n.onZoomChange(b)},h=b=>{const m=b.target,y=parseInt(m.value);!isNaN(y)&&y>=1&&y<=n.totalPages&&n.onPageChange(y)},p=b=>{const m=b.target,y=parseInt(m.value);!isNaN(y)&&y>=10&&y<=500&&n.onZoomChange(y)};return(()=>{var b=eh(),m=b.firstChild,y=m.firstChild,$=y.firstChild,x=$.nextSibling,w=x.firstChild,P=w.nextSibling,L=P.nextSibling,D=x.nextSibling,z=y.nextSibling,E=z.nextSibling,R=E.firstChild,k=R.nextSibling,q=k.firstChild,N=k.nextSibling,C=N.nextSibling,A=C.nextSibling,X=E.nextSibling,G=X.nextSibling,O=G.firstChild,V=O.nextSibling,B=V.nextSibling,H=G.nextSibling,j=H.nextSibling,de=j.firstChild,me=de.nextSibling,fe=me.nextSibling;return b.addEventListener("mouseleave",c),b.addEventListener("mouseenter",o),b.style.setProperty("transition","opacity 0.3s ease"),$.$$click=d,w.$$input=h,f(L,()=>n.totalPages),D.$$click=u,R.$$click=v,q.$$input=p,N.$$click=g,Ae(C,"click",n.onFitScreen),Ae(A,"click",n.onActualSize),O.$$click=()=>n.onModeChange("presentation"),V.$$click=()=>n.onModeChange("development"),B.$$click=()=>n.onModeChange("print"),Ae(de,"click",n.onExport),Ae(me,"click",n.onPrint),Ae(fe,"click",n.onExit),F(ee=>{var oe=e(),ge=n.currentPage<=1,he=n.totalPages,te=n.currentPage>=n.totalPages,ne=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="presentation"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,ve=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="development"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,be=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="print"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`;return oe!==ee.e&&((ee.e=oe)!=null?b.style.setProperty("opacity",oe):b.style.removeProperty("opacity")),ge!==ee.t&&($.disabled=ee.t=ge),he!==ee.a&&Q(w,"max",ee.a=he),te!==ee.o&&(D.disabled=ee.o=te),ne!==ee.i&&Se(O,ee.i=ne),ve!==ee.n&&Se(V,ee.n=ve),be!==ee.s&&Se(B,ee.s=be),ee},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),F(()=>w.value=n.currentPage),F(()=>q.value=n.zoom),b})()};Ue(["click","input"]);var nh=S('<div class="preview-viewport w-full h-full bg-gray-100 relative overflow-hidden"><div class="preview-container w-full h-full"></div><div class="shortcuts-hint absolute bottom-4 left-1/2 transform -translate-x-1/2 text-gray-500 text-sm animate-fade-out"><span class="bg-white px-3 py-1 rounded shadow">ESC 退出 • Shift+拖动 平移 • Ctrl+滚轮 缩放 • F 适应屏幕');const ih=n=>{let e,t=null;const{state:i}=st(),{actions:s}=_n(),[r,a]=K(1),[l,o]=K(100),[c,d]=K("presentation"),[u,g]=K(!1),[v,h]=K({x:0,y:0}),[p,b]=K({x:0,y:0}),m=()=>n.elements||i.elements,y=()=>n.pageCount||1;Qe(()=>{e&&(console.log("🎨 初始化Konva渲染器"),t=new Zd(e,{width:n.pageSize?.width||794,height:n.pageSize?.height||1123,background:"#ffffff"}),$(),X(),window.addEventListener("resize",k))}),dt(()=>{t&&(t.destroy(),t=null),window.removeEventListener("resize",k),document.removeEventListener("keydown",G)}),Vt(()=>{const O=m();t&&O&&$()});const $=()=>{if(!t)return;const O=m(),V=r();t.render([...O]),console.log(`📄 渲染第 ${V} 页，共 ${O.length} 个元素`)},x=O=>{a(O),$()},w=O=>{o(O),t&&t.setScale(O/100)},P=()=>{if(!t||!e)return;const O=e.getBoundingClientRect(),V=n.pageSize?.width||794,B=n.pageSize?.height||1123,H=(O.width-100)/V,j=(O.height-100)/B,de=Math.min(H,j,1);w(Math.round(de*100));const me=(O.width-V*de)/2,fe=(O.height-B*de)/2;t.setPosition(me,fe),b({x:me,y:fe})},L=()=>{w(100),t&&(t.setPosition(0,0),b({x:0,y:0}))},D=async()=>{if(console.log("📤 导出预览"),t)try{const O=await t.toDataURL({pixelRatio:2}),V=document.createElement("a");V.download=`preview-page-${r()}.png`,V.href=O,V.click()}catch(O){console.error("导出失败:",O)}},z=()=>{console.log("🖨️ 打印预览"),window.print()},E=()=>{console.log("🚪 退出预览模式"),s.setMode("design")},R=O=>{d(O),console.log(`🔄 切换到${O}模式`)},k=()=>{t&&t.fitToContainer()},q=O=>{O.button===0&&O.shiftKey&&(g(!0),h({x:O.clientX,y:O.clientY}),O.preventDefault())},N=O=>{if(!u()||!t)return;const V=O.clientX-v().x,B=O.clientY-v().y,H={x:p().x+V,y:p().y+B};t.setPosition(H.x,H.y),b(H),h({x:O.clientX,y:O.clientY})},C=()=>{g(!1)},A=O=>{if(!O.ctrlKey&&!O.metaKey)return;O.preventDefault();const V=O.deltaY>0?-10:10,B=Math.max(10,Math.min(500,l()+V));w(B)},X=()=>{document.addEventListener("keydown",G)},G=O=>{switch(O.key){case"Escape":E();break;case"f":case"F":!O.ctrlKey&&!O.metaKey&&P();break;case"1":!O.ctrlKey&&!O.metaKey&&L();break;case"+":case"=":w(Math.min(500,l()+25));break;case"-":case"_":w(Math.max(10,l()-25));break;case"ArrowLeft":r()>1&&x(r()-1);break;case"ArrowRight":r()<y()&&x(r()+1);break;case"Home":x(1);break;case"End":x(y());break;case"p":case"P":(O.ctrlKey||O.metaKey)&&(O.preventDefault(),z());break;case"e":case"E":(O.ctrlKey||O.metaKey)&&(O.preventDefault(),D());break;case"d":case"D":!O.ctrlKey&&!O.metaKey&&R("development");break}};return(()=>{var O=nh(),V=O.firstChild;f(O,_(th,{get currentPage(){return r()},get totalPages(){return y()},get zoom(){return l()},get mode(){return c()},onPageChange:x,onZoomChange:w,onExport:D,onPrint:z,onModeChange:R,onFitScreen:P,onActualSize:L,onExit:E}),V),V.addEventListener("wheel",A),V.addEventListener("mouseleave",C),V.$$mouseup=C,V.$$mousemove=N,V.$$mousedown=q;var B=e;return typeof B=="function"?Qt(B,V):e=V,F(H=>(H=u()?"grabbing":"default")!=null?V.style.setProperty("cursor",H):V.style.removeProperty("cursor")),O})()};Ue(["mousedown","mousemove","mouseup"]);var sh=S('<div class="preview-renderer w-full h-full relative">');const rh=()=>{const{state:n}=st();return(()=>{var e=sh();return f(e,_(ih,{get elements(){return[...n.elements]},pageSize:{width:794,height:1123},pageCount:1})),e})()};var ah=S("<div class=wizard-errors>"),lh=S("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),oh=S("<div class=error-message>"),ch=S("<div class=wizard-progress>"),dh=S("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),hh=S("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),uh=S("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),gh=S("<span class=feature-tag>"),fh=S("<div class=data-input-step><div class=step-header><h4></h4><p>"),vh=S("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),ph=S("<div class=file-error>"),mh=S('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),bh=S("<div class=field-error>"),yh=S("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),_h=S('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),xh=S('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),Sh=S("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),wh=S("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),$h=S('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),Ch=S("<span class=status-success>✅ JSON格式正确"),kh=S("<span class=status-error>❌ 格式错误"),Th=S("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),Eh=S("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),Ph=S(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),Ah=S("<div class=template-item><div class=template-name></div><div class=template-description>"),Rh=S("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),Lh=S("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Mh=S('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),Dh=S("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),Oh=S("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),Ih=S("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),Nh=S("<li>首次配置数据源时，建议先测试连接确保配置正确"),zh=S("<li>测试过程会验证JSON格式和文件访问权限"),Fh=S("<li>预览功能可以帮助您确认数据结构是否符合预期"),Gh=S("<li>✅ 连接测试成功！您可以继续创建数据源"),Bh=S("<li>预览显示的是实际数据，创建后可用于报表设计"),Uh=S("<li>字段名称将用于数据绑定表达式"),Hh=S("<li>❌ 请检查JSON格式是否正确"),qh=S("<li>如果是文件类型，请确认文件路径存在且可访问"),Wh=S("<li>可以返回上一步修改配置后重新测试"),jh=S("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),Yh=S("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),Vh=S("<span class=loading-spinner>⏳"),Xh=S("<span class=test-button-icon>🔌"),Qh=S("<div class=field-tag><span class=field-name>"),Jh=S("<th>"),Kh=S("<tr>"),Zh=S("<td><div class=cell-content>"),eu=S("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),tu=S('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),nu=S('<button class="control-btn finish-btn">'),iu=S("<span class=hint-text>选择您的JSON数据来源方式"),ks=S("<span class=hint-text>"),su=S("<span class=hint-text>设置数据源名称和选项"),ru=S('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),au=S("<span class=btn-loading>⏳"),lu=S("<span class=btn-text>创建中..."),ou=S("<span class=btn-icon>✓"),cu=S("<span class=btn-text>创建数据源");function zr(n){const[e,t]=K({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),i=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],s=Me(()=>{const h=e();switch(h.currentStep){case 1:return h.sourceType!==null;case 2:return r(h);case 3:return a(h);case 4:return l(h);default:return!1}}),r=h=>{if(h.sourceType==="file")return!!h.config.file_path?.trim();if(h.sourceType==="content"){const p=h.config.json_content?.trim();if(!p)return!1;try{return JSON.parse(p),!0}catch{return!1}}return!1},a=h=>{const p=h.name.trim();return!(p.length<2||p.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(p))},l=h=>!!h.testResult?.success,o=h=>{const p=e();t(b=>({...b,validation:{...b.validation,errors:[]}})),p.currentStep===1&&p.sourceType?t(b=>({...b,currentStep:h,config:{...b.config,source_type:p.sourceType}})):t(b=>({...b,currentStep:h}))},c=()=>{const h=e();h.currentStep<4&&s()&&o(h.currentStep+1)},d=()=>{const h=e();h.currentStep>1&&(h.currentStep===4?t(p=>({...p,currentStep:p.currentStep-1,testResult:null})):o(h.currentStep-1))},u=h=>{t(p=>({...p,...h}))},g=async()=>{const h=e();u({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const p={...h.config,source_type:h.sourceType};if(await Re.testConnection("json",p)){console.log("✅ 连接测试成功，获取预览数据...");const m=await Re.discoverSchema("json",p),y=`temp_${Date.now()}`,$=await Re.createDataSource(y,"json",p),x=await Re.getPreview($,void 0,5);await Re.deleteDataSource($),u({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:x.totalCount??x.total_rows??x.total_count??0,fields:m.columns.map(w=>w.name),sample_data:x.rows}},loading:!1})}}catch(p){console.error("❌ 连接测试失败:",p),u({testResult:{success:!1,message:"连接测试失败",error:p instanceof Error?p.message:String(p)},loading:!1})}},v=async()=>{const h=e();u({loading:!0});try{console.log("🔄 开始创建数据源...");const p={...h.config,source_type:h.sourceType},b=await Re.createDataSource(h.name,"json",p);console.log("✅ 数据源创建成功，ID:",b);try{await Ze.setActiveDataSource(b),console.log("✅ 数据源自动激活成功")}catch(m){console.warn("⚠️ 数据源激活失败，但创建成功:",m)}n.onSuccess(),n.onBack()}catch(p){console.error("❌ 创建数据源失败:",p),u({validation:{isValid:!1,errors:[`创建失败: ${p}`],warnings:[]},loading:!1})}};return(()=>{var h=lh(),p=h.firstChild,b=p.firstChild,m=b.nextSibling,y=m.firstChild,$=y.nextSibling,x=p.nextSibling;return Ae(b,"click",n.onBack),f($,()=>i[e().currentStep-1]?.description),f(h,_(du,{get currentStep(){return e().currentStep},stepInfo:i,onStepClick:o}),x),f(x,_(W,{get when(){return e().currentStep===1},get children(){return _(hu,{get selectedType(){return e().sourceType},onSelect:w=>u({sourceType:w,config:{...e().config,source_type:w}})})}}),null),f(x,_(W,{get when(){return e().currentStep===2},get children(){return _(uu,{get sourceType(){return e().sourceType},get config(){return e().config},onConfigUpdate:w=>u({config:{...e().config,...w}})})}}),null),f(x,_(W,{get when(){return e().currentStep===3},get children(){return _(fu,{get name(){return e().name},get config(){return e().config},onNameChange:w=>u({name:w}),onConfigUpdate:w=>u({config:{...e().config,...w}})})}}),null),f(x,_(W,{get when(){return e().currentStep===4},get children(){return _(pu,{get config(){return e().config},get testResult(){return e().testResult},get loading(){return e().loading},onTest:g})}}),null),f(h,_(mu,{get currentStep(){return e().currentStep},get canProceed(){return s()},get loading(){return e().loading},get testResult(){return e().testResult},onPrevious:d,onNext:c,onFinish:v}),null),f(h,_(W,{get when(){return e().validation.errors.length>0},get children(){var w=ah();return f(w,_(pe,{get each(){return e().validation.errors},children:P=>(()=>{var L=oh();return f(L,P),L})()})),w}}),null),h})()}function du(n){return(()=>{var e=ch();return f(e,_(pe,{get each(){return n.stepInfo},children:t=>{const i=n.currentStep===t.step,s=n.currentStep>t.step,r=n.currentStep>=t.step;return(()=>{var a=dh(),l=a.firstChild,o=l.firstChild,c=l.nextSibling,d=c.firstChild,u=d.nextSibling;return a.$$click=()=>r&&n.onStepClick(t.step),Se(a,`progress-step ${i?"active":""} ${s?"completed":""}`),f(o,()=>s?"✓":t.step),f(d,()=>t.title),f(u,()=>t.description),a})()}})),e})()}function hu(n){const e=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var t=hh(),i=t.firstChild,s=i.nextSibling;return f(s,_(pe,{each:e,children:r=>(()=>{var a=uh(),l=a.firstChild,o=l.firstChild,c=o.nextSibling,d=l.nextSibling,u=d.nextSibling,g=u.nextSibling,v=g.firstChild;return a.$$click=()=>n.onSelect(r.type),f(o,()=>r.title),f(c,()=>r.description),f(d,_(pe,{get each(){return r.features},children:h=>(()=>{var p=gh();return f(p,h),p})()})),f(u,()=>r.example),v.addEventListener("change",()=>n.onSelect(r.type)),F(()=>Se(a,`source-option ${n.selectedType===r.type?"selected":""}`)),F(()=>v.checked=n.selectedType===r.type),a})()})),t})()}function uu(n){return(()=>{var e=fh(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return f(i,()=>n.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),f(s,()=>n.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),f(e,_(W,{get when(){return n.sourceType==="file"},get children(){return _(gu,{get filePath(){return n.config.file_path||""},onFileSelect:r=>n.onConfigUpdate({file_path:r})})}}),null),f(e,_(W,{get when(){return n.sourceType==="content"},get children(){return _(vu,{get content(){return n.config.json_content||""},onContentChange:r=>n.onConfigUpdate({json_content:r})})}}),null),e})()}function gu(n){const[e,t]=K(!1),[i,s]=K(null),r=o=>{const d=o.target.files?.[0];d&&l(d)},a=o=>{o.preventDefault(),t(!1);const c=o.dataTransfer?.files?.[0];c&&l(c)},l=o=>{if(s(null),!o.name.endsWith(".json")){s("请选择JSON文件（.json格式）");return}if(o.size>10*1024*1024){s("文件大小不能超过10MB");return}const c=new FileReader;c.onload=d=>{try{const u=d.target?.result;JSON.parse(u),n.onFileSelect(o.name),console.log("✅ 文件选择成功:",o.name)}catch{s("文件内容不是有效的JSON格式")}},c.readAsText(o)};return(()=>{var o=mh(),c=o.firstChild,d=c.nextSibling,u=d.firstChild,g=u.firstChild,v=d.nextSibling;return c.addEventListener("drop",a),c.addEventListener("dragleave",()=>t(!1)),c.addEventListener("dragover",h=>{h.preventDefault(),t(!0)}),g.addEventListener("change",r),f(d,_(W,{get when(){return n.filePath},get children(){var h=vh(),p=h.firstChild,b=p.nextSibling,m=b.nextSibling;return f(b,()=>n.filePath),m.$$click=()=>n.onFileSelect(""),h}}),null),f(o,_(W,{get when(){return i()},get children(){var h=ph();return f(h,i),h}}),v),F(()=>Se(c,`file-drop-zone ${e()?"active":""}`)),o})()}function fu(n){const[e,t]=K(null),i=r=>{n.onNameChange(r),r.trim().length===0?t("数据源名称不能为空"):r.trim().length<2?t("数据源名称至少需要2个字符"):r.trim().length>50?t("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(r.trim())?t(null):t("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},s=r=>{const a=parseInt(r);!isNaN(a)&&a>=10&&a<=3600&&n.onConfigUpdate({refresh_interval:a})};return(()=>{var r=$h(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.firstChild,d=c.nextSibling,u=d.firstChild,g=u.nextSibling,v=g.nextSibling,h=o.nextSibling,p=h.firstChild,b=p.nextSibling,m=b.firstChild,y=m.firstChild,$=y.nextSibling;return g.$$input=x=>i(x.currentTarget.value),f(d,_(W,{get when(){return e()},get children(){var x=bh();return f(x,e),x}}),v),f(l,_(W,{get when(){return n.config.source_type==="file"},get children(){var x=_h(),w=x.firstChild,P=w.nextSibling,L=P.firstChild,D=L.firstChild;return D.addEventListener("change",z=>n.onConfigUpdate({auto_refresh:z.currentTarget.checked})),f(x,_(W,{get when(){return n.config.auto_refresh},get children(){var z=yh(),E=z.firstChild,R=E.nextSibling,k=R.firstChild,q=k.nextSibling;return k.$$input=N=>s(N.currentTarget.value),q.addEventListener("change",N=>s(N.currentTarget.value)),F(()=>k.value=n.config.refresh_interval),F(()=>q.value=n.config.refresh_interval),z}}),null),F(()=>D.checked=n.config.auto_refresh),x}}),h),f($,()=>n.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),f(b,_(W,{get when(){return n.config.source_type==="file"},get children(){return[(()=>{var x=xh(),w=x.firstChild,P=w.nextSibling;return f(P,()=>n.config.file_path||"(未选择文件)"),x})(),(()=>{var x=Sh(),w=x.firstChild,P=w.nextSibling;return f(P,()=>n.config.auto_refresh?`✅ 每 ${n.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),x})()]}}),null),f(b,_(W,{get when(){return n.config.source_type==="content"},get children(){var x=wh(),w=x.firstChild,P=w.nextSibling,L=P.firstChild;return f(P,()=>n.config.json_content?.length||0,L),x}}),null),F(()=>Se(g,`name-input ${e()?"error":""}`)),F(()=>g.value=n.name),r})()}function vu(n){const[e,t]=K(null),[i,s]=K(!1),r=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],a=o=>{if(n.onContentChange(o),o.trim())try{JSON.parse(o),t(null)}catch(c){t(c instanceof Error?c.message:"无效的JSON格式")}else t(null)},l=o=>{n.onContentChange(o.content),t(null),s(!1)};return(()=>{var o=Ph(),c=o.firstChild,d=c.firstChild,u=d.nextSibling,g=u.nextSibling,v=c.nextSibling,h=v.firstChild,p=v.nextSibling;return d.$$click=()=>s(!i()),u.$$click=()=>n.onContentChange(""),f(g,_(W,{get when(){return $e(()=>!e())()&&n.content.trim()},get children(){return Ch()}}),null),f(g,_(W,{get when(){return e()},get children(){return kh()}}),null),f(o,_(W,{get when(){return i()},get children(){var b=Th(),m=b.firstChild,y=m.nextSibling;return f(y,_(pe,{each:r,children:$=>(()=>{var x=Ah(),w=x.firstChild,P=w.nextSibling;return x.$$click=()=>l($),f(w,()=>$.name),f(P,()=>$.description),x})()})),b}}),v),h.$$input=b=>a(b.currentTarget.value),f(o,_(W,{get when(){return e()},get children(){var b=Eh(),m=b.firstChild,y=m.nextSibling;return f(y,e),b}}),p),F(b=>{var m=!n.content,y=`json-textarea ${e()?"error":""}`;return m!==b.e&&(u.disabled=b.e=m),y!==b.t&&Se(h,b.t=y),b},{e:void 0,t:void 0}),F(()=>h.value=n.content),o})()}function pu(n){const[e,t]=K(!1),i=()=>n.loading?"🔄":n.testResult?n.testResult.success?"✅":"❌":"⚡",s=()=>n.loading?"测试连接中...":n.testResult?n.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",r=()=>n.loading?"testing":n.testResult?n.testResult.success?"success":"error":"ready",a=l=>typeof l=="object"?JSON.stringify(l,null,2):String(l);return(()=>{var l=Yh(),o=l.firstChild,c=o.nextSibling,d=c.firstChild,u=d.firstChild,g=u.firstChild,v=g.firstChild,h=v.nextSibling,p=g.nextSibling,b=d.nextSibling,m=b.firstChild,y=m.nextSibling;return f(v,i),f(h,s),Ae(p,"click",n.onTest),f(p,(()=>{var $=$e(()=>!!n.loading);return()=>$()?[Vh(),"测试中..."]:[Xh(),"测试连接"]})()),f(d,_(W,{get when(){return n.testResult},get children(){var $=Lh(),x=$.firstChild,w=x.firstChild,P=w.nextSibling;return f(w,i),f(P,()=>n.testResult.message),f($,_(W,{get when(){return n.testResult.error},get children(){var L=Rh(),D=L.firstChild,z=D.nextSibling;return f(z,()=>n.testResult.error),L}}),null),F(()=>Se($,`test-result ${r()}`)),$}}),null),f(c,_(W,{get when(){return n.testResult?.success&&n.testResult.preview},get children(){var $=Ih(),x=$.firstChild,w=x.firstChild,P=w.nextSibling,L=P.firstChild,D=L.firstChild,z=D.nextSibling,E=L.nextSibling,R=E.firstChild,k=R.nextSibling,q=x.nextSibling,N=q.firstChild,C=N.nextSibling,A=q.nextSibling,X=A.firstChild,G=X.nextSibling,O=G.firstChild,V=O.firstChild,B=V.firstChild,H=V.nextSibling,j=A.nextSibling,de=j.firstChild,me=de.firstChild;return f(z,()=>n.testResult.preview.record_count),f(k,()=>n.testResult.preview.fields.length),f(C,_(pe,{get each(){return n.testResult.preview.fields},children:fe=>(()=>{var ee=Qh(),oe=ee.firstChild;return f(oe,fe),ee})()})),f(B,_(pe,{get each(){return n.testResult.preview.fields},children:fe=>(()=>{var ee=Jh();return f(ee,fe),ee})()})),f(H,_(pe,{get each(){return n.testResult.preview.sample_data},children:fe=>(()=>{var ee=Kh();return f(ee,_(pe,{get each(){return n.testResult.preview.fields},children:oe=>(()=>{var ge=Zh(),he=ge.firstChild;return f(he,(()=>{var te=$e(()=>fe[oe]!==void 0);return()=>te()?a(fe[oe]):"-"})()),ge})()})),ee})()})),de.$$click=()=>t(!e()),f(me,()=>e()?"▼":"▶"),f(j,_(W,{get when(){return e()},get children(){var fe=Oh(),ee=fe.firstChild,oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling,te=oe.nextSibling;return f(he,()=>n.config.source_type==="file"?"JSON文件":"JSON内容"),f(ee,_(W,{get when(){return n.config.source_type==="file"},get children(){return[(()=>{var ne=Mh(),ve=ne.firstChild,be=ve.nextSibling;return f(be,()=>n.config.file_path),ne})(),(()=>{var ne=Dh(),ve=ne.firstChild,be=ve.nextSibling;return f(be,()=>n.config.auto_refresh?"已启用":"已禁用"),ne})()]}}),te),fe}}),null),$}}),b),f(y,_(W,{get when(){return!n.testResult},get children(){return[Nh(),zh(),Fh()]}}),null),f(y,_(W,{get when(){return n.testResult?.success},get children(){return[Gh(),Bh(),Uh()]}}),null),f(y,_(W,{get when(){return n.testResult&&!n.testResult.success},get children(){return[Hh(),qh(),Wh()]}}),null),f(c,_(W,{get when(){return n.config.source_type==="file"},get children(){return jh()}}),null),F($=>{var x=`test-button ${r()}`,w=n.loading;return x!==$.e&&Se(p,$.e=x),w!==$.t&&(p.disabled=$.t=w),$},{e:void 0,t:void 0}),l})()}function mu(n){const e=r=>{switch(r){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${r}`}},t=()=>n.currentStep>1,i=()=>n.currentStep<4&&n.canProceed,s=()=>n.currentStep===4&&n.canProceed;return(()=>{var r=ru(),a=r.firstChild,l=a.firstChild,o=l.firstChild,c=o.nextSibling;c.nextSibling;var d=a.nextSibling,u=d.firstChild,g=d.nextSibling;return f(l,()=>n.currentStep,c),f(l,()=>e(n.currentStep),null),f(a,_(W,{get when(){return!n.canProceed&&n.currentStep<4},get children(){return eu()}}),null),Ae(u,"click",n.onPrevious),f(d,_(W,{get when(){return n.currentStep<4},get children(){var v=tu();return Ae(v,"click",n.onNext),F(()=>v.disabled=!i()||n.loading),v}}),null),f(d,_(W,{get when(){return n.currentStep===4},get children(){var v=nu();return Ae(v,"click",n.onFinish),f(v,(()=>{var h=$e(()=>!!n.loading);return()=>h()?[au(),lu()]:[ou(),cu()]})()),F(()=>v.disabled=!s()||n.loading),v}}),null),f(g,_(W,{get when(){return n.currentStep===1},get children(){return iu()}}),null),f(g,_(W,{get when(){return n.currentStep===2},get children(){var v=ks();return f(v,()=>n.testResult?.success?"数据格式验证成功":"请提供JSON数据内容"),v}}),null),f(g,_(W,{get when(){return n.currentStep===3},get children(){return su()}}),null),f(g,_(W,{get when(){return n.currentStep===4},get children(){var v=ks();return f(v,()=>n.testResult?.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"),v}}),null),F(()=>u.disabled=!t()||n.loading),r})()}Ue(["click","input"]);var bu=S("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),yu=S("<div class=error-message>"),_u=S("<div class=loading-message>加载中..."),xu=S("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),Su=S("<div class=sources-grid>"),wu=S("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),$u=S("<span class=active-badge title=当前激活>当前"),Cu=S('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),ku=S("<span class=changes-indicator>● 有未保存的更改"),Tu=S("<div class=error-details>"),Eu=S("<div><div class=result-message> "),Pu=S("<div class=error-message>❌ "),Au=S("<button type=button class=reset-btn>重置更改"),Ru=S('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),Lu=S("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),Mu=S("<th>"),Du=S("<tr>"),Ou=S("<td>");const Iu=n=>{const e=(n.type_name||n.provider_type||n.providerType||"").toLowerCase();return e.includes("database_mysql")?"MySQL":e.includes("database_postgresql")?"PostgreSQL":e==="json"?"JSON":e==="csv"?"CSV":e==="excel"?"Excel":e.startsWith("api")?"API":e.startsWith("database")?"Database":n.type_name||n.provider_type||n.providerType||"Unknown"};function Nu(n){const[e,t]=K([]),[i,s]=K([]),[r,a]=K("list"),[l,o]=K(null),[c,d]=K(null),[u,g]=K(!1),[v,h]=K(null),[p,b]=K(null);Qe(async()=>{try{await m(),await y();const z=Ze.subscribe(E=>{b(E?.dataSource.id||null)});b(Ze.getCurrentContext()?.dataSource.id||null),dt(z)}catch(z){console.error("🚨 DataSourcesPanel初始化失败:",z),h(`数据源模块初始化失败: ${z}`)}});const m=async()=>{try{g(!0),console.log("🔄 开始加载数据源列表...");const z=await Re.listDataSources();console.log("✅ 数据源列表加载成功:",z),t(z),h(null)}catch(z){console.error("❌ 加载数据源失败:",z),h(`加载数据源失败: ${z}`)}finally{g(!1)}},y=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const z=await Re.getAvailableTypes();console.log("✅ 数据源类型加载成功:",z),s(z)}catch(z){console.error("❌ 加载数据源类型失败:",z)}},$=()=>{a("add"),o(null)},x=z=>{o(z),a("edit")},w=async z=>{try{g(!0),h(null),o(z),console.log("🔄 开始预览数据源:",z.name),z.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",z.status),h(`数据源状态为 ${z.status}，可能无法预览数据`));const E=await Re.getPreview(z.id);d(E),a("preview"),console.log("✅ 数据预览加载成功:",E)}catch(E){console.error("❌ 数据预览失败:",E);const R=`预览数据源 "${z.name}" 失败: ${E}`;h(R);const k={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},q=String(E).toLowerCase(),N=Object.keys(k).find(C=>q.includes(C));N&&h(`预览失败: ${k[N]}`)}finally{g(!1)}},P=async z=>{if(confirm("确定要删除这个数据源吗？"))try{await Re.deleteDataSource(z),await m()}catch(E){h(`删除数据源失败: ${E}`)}},L=async z=>{try{g(!0),h(null),await Ze.setActiveDataSource(z.id)}catch(E){console.error("❌ 激活数据源失败:",E),h(`激活数据源失败: ${E}`)}finally{g(!1)}},D=async z=>{try{g(!0),h(null),console.log("🔄 开始测试数据源连接:",z);const E=e().find(q=>q.id===z);if(!E){const q=`数据源不存在: ${z}`;console.error("❌",q),h(q);return}console.log("📋 数据源信息:",{id:E.id,name:E.name,providerType:E.providerType||E.provider_type,config:E.config});let R=E.providerType||E.provider_type||E.type_name;(E.name.includes("MySQL")||E.name.includes("数据库")||JSON.stringify(E.config).includes("mysql")||JSON.stringify(E.config).includes("3306"))&&(R="database",console.log("🗄️ 检测到数据库类型，使用provider_type: database")),console.log("🔍 调用测试连接API:",{providerType:R,config:E.config});const k=await Re.testConnection(R,E.config||{});console.log("📨 API返回结果:",k),k?(console.log("✅ 数据源连接测试成功:",z),alert(`✅ 数据源 "${E.name}" 连接测试成功！

🎉 数据库连接正常，可以正常使用`)):(console.log("❌ 数据源连接测试失败:",z),alert(`❌ 数据源 "${E.name}" 连接测试失败

请检查配置信息是否正确`))}catch(E){console.error("❌ 测试连接时发生错误:",E),console.error("❌ 错误详情:",{error:E,errorType:typeof E,errorString:String(E),errorJSON:JSON.stringify(E,null,2)});const R=e().find(q=>q.id===z),k=`测试连接失败: ${E}`;h(k),!E||String(E)===""||String(E)==="null"?alert(`❌ 数据源 "${R?.name||z}" 连接测试遇到未知错误

请检查：
• 开发者工具控制台的详细错误信息
• 后端服务是否正常运行
• 配置参数是否正确`):alert(`❌ 数据源 "${R?.name||z}" 连接测试失败:

${E}

💡 如果是空错误，请检查开发者工具控制台获取详细信息`)}finally{g(!1)}};return _(W,{get when(){return n.isOpen},get children(){var z=bu(),E=z.firstChild,R=E.nextSibling,k=R.firstChild,q=k.nextSibling,N=q.nextSibling,C=R.nextSibling;return Ae(N,"click",n.onClose),f(C,_(W,{get when(){return r()==="list"},get children(){return _(zu,{get dataSources(){return e()},get loading(){return u()},get error(){return v()},onAdd:$,onEdit:x,onPreview:w,onDelete:P,onActivate:L,onTestConnection:D,onRefresh:m,get activeId(){return p()}})}}),null),f(C,_(W,{get when(){return r()==="add"},get children(){return _(zr,{get availableTypes(){return i()},onBack:()=>a("list"),onSuccess:m})}}),null),f(C,_(W,{get when(){return $e(()=>r()==="edit")()&&l()},get children(){return _(Fu,{get dataSource(){return l()},onBack:()=>a("list"),onSuccess:m})}}),null),f(C,_(W,{get when(){return $e(()=>!!(r()==="preview"&&l()))()&&c()},get children(){return _(Gu,{get dataSource(){return l()},get data(){return c()},onBack:()=>a("list")})}}),null),z}})}function zu(n){const e=i=>{switch(i){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},t=i=>new Date(i).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var i=wu(),s=i.firstChild,r=s.firstChild,a=r.firstChild,l=a.firstChild,o=l.nextSibling;o.nextSibling;var c=a.nextSibling,d=r.nextSibling;return f(a,()=>n.dataSources.length,o),Ae(c,"click",n.onRefresh),Ae(d,"click",n.onAdd),f(i,_(W,{get when(){return n.error},get children(){var u=yu();return f(u,()=>n.error),u}}),null),f(i,_(W,{get when(){return n.loading},get children(){return _u()}}),null),f(i,_(W,{get when(){return!n.loading&&n.dataSources.length===0},get children(){var u=xu(),g=u.firstChild,v=g.nextSibling;return Ae(v,"click",n.onAdd),u}}),null),f(i,_(W,{get when(){return!n.loading&&n.dataSources.length>0},get children(){var u=Su();return f(u,_(pe,{get each(){return n.dataSources},children:g=>(()=>{var v=Cu(),h=v.firstChild,p=h.firstChild,b=p.firstChild,m=b.nextSibling,y=p.nextSibling,$=h.nextSibling,x=$.firstChild,w=x.firstChild,P=w.nextSibling,L=x.nextSibling,D=L.firstChild,z=D.nextSibling,E=$.nextSibling,R=E.firstChild,k=R.nextSibling,q=k.nextSibling,N=q.nextSibling,C=N.nextSibling;return f(b,()=>g.name,null),f(b,_(W,{get when(){return n.activeId===g.id},get children(){return $u()}}),null),f(m,()=>Iu(g)),f(P,()=>t(g.createdAt||g.created_at)),f(z,()=>t(g.lastUpdated||g.last_updated)),R.$$click=()=>n.onPreview(g),k.$$click=()=>n.onActivate(g),q.$$click=()=>n.onTestConnection(g.id),N.$$click=()=>n.onEdit(g),C.$$click=()=>n.onDelete(g.id),F(A=>{var X=n.activeId===g.id?"true":"false",G=e(g.status),O=`状态: ${g.status}`,V=g.status!=="active",B=n.activeId===g.id;return X!==A.e&&Q(v,"data-active",A.e=X),G!==A.t&&((A.t=G)!=null?y.style.setProperty("background-color",G):y.style.removeProperty("background-color")),O!==A.a&&Q(y,"title",A.a=O),V!==A.o&&(R.disabled=A.o=V),B!==A.i&&(k.disabled=A.i=B),A},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),v})()})),u}}),null),F(u=>{var g=n.loading,v=n.loading?"正在刷新数据源列表":"刷新数据源列表",h=n.loading?"正在刷新...":"刷新数据源列表";return g!==u.e&&(c.disabled=u.e=g),v!==u.t&&Q(c,"aria-label",u.t=v),h!==u.a&&Q(c,"title",u.a=h),u},{e:void 0,t:void 0,a:void 0}),i})()}function Fu(n){const[e,t]=K({name:n.dataSource.name,config:n.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[i]=K(JSON.stringify(n.dataSource.config||{})),s=()=>{const d=e(),u=d.name!==n.dataSource.name,g=JSON.stringify(d.config)!==i();t(v=>({...v,hasChanges:u||g}))},r=d=>{t(u=>({...u,name:d})),s()},a=d=>{t(u=>({...u,config:d})),s()},l=async()=>{const d=e();t(u=>({...u,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await Re.testConnection(n.dataSource.providerType||n.dataSource.provider_type,d.config)&&(console.log("✅ 连接测试成功"),t(g=>({...g,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(u){console.error("❌ 连接测试失败:",u),t(g=>({...g,testResult:{success:!1,message:"连接测试失败",error:u instanceof Error?u.message:String(u)},loading:!1}))}},o=async()=>{const d=e();if(!d.hasChanges){n.onBack();return}if(!d.name.trim()){t(u=>({...u,error:"数据源名称不能为空"}));return}try{t(u=>({...u,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await Re.updateConfig(n.dataSource.id,d.config),d.name!==n.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),t(u=>({...u,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),n.onSuccess(),n.onBack()}catch(u){console.error("❌ 更新数据源失败:",u),t(g=>({...g,error:`更新失败: ${u}`,loading:!1}))}},c=()=>{t(d=>({...d,name:n.dataSource.name,config:n.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var d=Ru(),u=d.firstChild,g=u.firstChild,v=g.nextSibling,h=v.firstChild,p=h.nextSibling,b=p.firstChild,m=b.nextSibling;m.firstChild;var y=u.nextSibling,$=y.firstChild,x=$.firstChild,w=x.nextSibling,P=w.firstChild,L=P.nextSibling,D=$.nextSibling,z=D.firstChild;z.firstChild;var E=z.nextSibling,R=E.firstChild,k=R.nextSibling,q=D.nextSibling,N=q.firstChild,C=N.firstChild,A=C.nextSibling,X=q.nextSibling,G=X.firstChild,O=G.nextSibling,V=O.firstChild,B=V.firstChild,H=B.nextSibling,j=V.nextSibling,de=j.firstChild,me=de.nextSibling,fe=j.nextSibling,ee=fe.firstChild,oe=ee.nextSibling,ge=X.nextSibling,he=ge.firstChild,te=he.nextSibling;return Ae(g,"click",n.onBack),f(b,()=>n.dataSource.providerType||n.dataSource.type_name),f(m,()=>n.dataSource.id,null),L.$$input=ne=>r(ne.currentTarget.value),f(z,_(W,{get when(){return e().hasChanges},get children(){return ku()}}),null),k.$$input=ne=>{try{const ve=JSON.parse(ne.currentTarget.value);a(ve),t(be=>({...be,error:null}))}catch{t(be=>({...be,error:"配置格式错误，请检查JSON语法"}))}},A.$$click=l,f(A,()=>e().loading?"测试中...":"测试连接"),f(q,_(W,{get when(){return e().testResult},get children(){var ne=Eu(),ve=ne.firstChild,be=ve.firstChild;return f(ve,()=>e().testResult?.success?"✅":"❌",be),f(ve,()=>e().testResult?.message,null),f(ne,_(W,{get when(){return e().testResult?.error},get children(){var ke=Tu();return f(ke,()=>e().testResult?.error),ke}}),null),F(()=>Se(ne,`test-result ${e().testResult?.success?"success":"error"}`)),ne}}),null),f(H,()=>n.dataSource.status==="active"?"✅ 活跃":n.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),f(me,()=>new Date(n.dataSource.createdAt||n.dataSource.created_at).toLocaleString("zh-CN")),f(oe,()=>new Date(n.dataSource.lastUpdated||n.dataSource.last_updated).toLocaleString("zh-CN")),f(y,_(W,{get when(){return e().error},get children(){var ne=Pu();return ne.firstChild,f(ne,()=>e().error,null),ne}}),ge),Ae(he,"click",n.onBack),f(ge,_(W,{get when(){return e().hasChanges},get children(){var ne=Au();return ne.$$click=c,F(()=>ne.disabled=e().loading),ne}}),te),te.$$click=o,f(te,(()=>{var ne=$e(()=>!!e().loading);return()=>ne()?"保存中...":e().hasChanges?"保存更改":"无更改"})()),F(ne=>{var ve=e().error&&!e().name.trim()?"error":"",be=e().error&&e().error?.includes("配置格式")?"error":"",ke=e().loading,_e=`status-value status-${n.dataSource.status}`,Pe=`save-btn ${e().hasChanges?"has-changes":""}`,ue=e().loading;return ve!==ne.e&&Se(L,ne.e=ve),be!==ne.t&&Se(k,ne.t=be),ke!==ne.a&&(A.disabled=ne.a=ke),_e!==ne.o&&Se(H,ne.o=_e),Pe!==ne.i&&Se(te,ne.i=Pe),ue!==ne.n&&(te.disabled=ne.n=ue),ne},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),F(()=>L.value=e().name),F(()=>k.value=JSON.stringify(e().config,null,2)),d})()}function Gu(n){return(()=>{var e=Lu(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;s.firstChild;var r=s.nextSibling,a=r.firstChild,l=a.nextSibling,o=l.nextSibling,c=o.nextSibling;c.nextSibling;var d=t.nextSibling,u=d.firstChild,g=u.firstChild,v=g.firstChild,h=g.nextSibling;return Ae(i,"click",n.onBack),f(s,()=>n.dataSource.name,null),f(r,()=>n.data.totalCount??n.data.total_rows,l),f(r,()=>n.data.rows.length,c),f(v,_(pe,{get each(){return n.data.columns},children:p=>(()=>{var b=Mu();return f(b,p),b})()})),f(h,_(pe,{get each(){return n.data.rows.slice(0,50)},children:p=>(()=>{var b=Du();return f(b,_(pe,{get each(){return n.data.columns},children:m=>(()=>{var y=Ou();return f(y,(()=>{var $=$e(()=>typeof p[m]=="object");return()=>$()?JSON.stringify(p[m]):String(p[m]||"")})()),y})()})),b})()})),e})()}Ue(["click","input"]);var Bu=S("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Uu=S("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Hu=S("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),qu=S("<div class=current-record>"),Wu=S("<div class=empty-record>暂无记录数据"),ju=S("<div class=available-fields>"),Yu=S("<div class=no-fields>暂无可用字段"),Vu=S('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),Xu=S("<div class=record-field><div class=field-key>:</div><div class=field-value>"),Qu=S("<div class=field-display-name>"),Ju=S("<div class=field-sample>示例: "),Ku=S("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),Zu=S("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),eg=S('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const Ts=()=>{const[n,e]=K(null),[t,i]=K(!1);Vt(()=>{const c=Ze.subscribe(d=>{e(d)});return e(Ze.getCurrentContext()),c});const s=Me(()=>{const c=n();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),r=async()=>{i(!0);try{await Ze.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{i(!1)}},a=async()=>{i(!0);try{await Ze.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{i(!1)}},l=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),o=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Hu(),d=c.firstChild,u=d.firstChild,g=u.nextSibling,v=g.firstChild,h=v.nextSibling;return f(v,()=>s().icon),f(h,()=>s().text),f(c,_(W,{get when(){return n()},children:p=>(()=>{var b=Vu(),m=b.firstChild,y=m.firstChild,$=y.nextSibling,x=$.firstChild,w=x.firstChild,P=w.nextSibling,L=x.nextSibling,D=L.firstChild,z=D.nextSibling,E=L.nextSibling,R=E.firstChild,k=R.nextSibling,q=m.nextSibling,N=q.firstChild,C=N.nextSibling,A=C.firstChild,X=A.nextSibling,G=X.firstChild,O=X.nextSibling,V=q.nextSibling;V.firstChild;var B=V.nextSibling,H=B.firstChild,j=H.firstChild,de=j.nextSibling,me=de.firstChild,fe=me.nextSibling;return fe.nextSibling,f(P,()=>p().dataSource.name),f(z,()=>p().dataSource.type.toUpperCase()),f(k,()=>p().dataSource.id),A.$$click=a,f(X,()=>p().currentRecord.index+1,G),f(X,()=>p().currentRecord.total,null),O.$$click=r,f(V,_(W,{get when(){return Object.keys(p().currentRecord.data).length>0},get children(){var ee=qu();return f(ee,_(pe,{get each(){return Object.entries(p().currentRecord.data)},children:([oe,ge])=>(()=>{var he=Xu(),te=he.firstChild,ne=te.firstChild,ve=te.nextSibling;return f(te,oe,ne),f(ve,()=>l(ge)),he})()})),ee}}),null),f(V,_(W,{get when(){return Object.keys(p().currentRecord.data).length===0},get children(){return Wu()}}),null),f(de,()=>p().fields.length,fe),f(B,_(W,{get when(){return p().fields.length>0},get children(){var ee=ju();return f(ee,_(pe,{get each(){return p().fields},children:oe=>(()=>{var ge=Ku(),he=ge.firstChild,te=he.firstChild,ne=te.nextSibling,ve=ne.firstChild,be=ve.nextSibling;be.nextSibling;var ke=he.nextSibling,_e=ke.firstChild,Pe=_e.nextSibling;return f(te,()=>oe.name),f(ne,()=>o(oe.type),be),f(ge,_(W,{get when(){return oe.displayName&&oe.displayName!==oe.name},get children(){var ue=Qu();return f(ue,()=>oe.displayName),ue}}),ke),f(ge,_(W,{get when(){return oe.sample!==void 0},get children(){var ue=Ju();return ue.firstChild,f(ue,()=>l(oe.sample),null),ue}}),ke),f(Pe,()=>`{${oe.name}}`),ge})()})),ee}}),null),f(B,_(W,{get when(){return p().fields.length===0},get children(){return Yu()}}),null),f(b,_(W,{get when(){return p().error},children:ee=>(()=>{var oe=eg(),ge=oe.firstChild,he=ge.nextSibling,te=he.firstChild;te.firstChild;var ne=te.nextSibling;return ne.firstChild,f(te,()=>ee().type,null),f(ne,()=>ee().message,null),f(he,_(W,{get when(){return ee().details},get children(){var ve=Zu(),be=ve.firstChild,ke=be.nextSibling;return f(ke,()=>JSON.stringify(ee().details,null,2)),ve}}),null),oe})()}),null),F(ee=>{var oe=t()||p().currentRecord.index<=0,ge=t()||p().currentRecord.index>=p().currentRecord.total-1;return oe!==ee.e&&(A.disabled=ee.e=oe),ge!==ee.t&&(O.disabled=ee.t=ge),ee},{e:void 0,t:void 0}),b})()}),null),f(c,_(W,{get when(){return!n()},get children(){return Bu()}}),null),f(c,_(W,{get when(){return t()},get children(){return Uu()}}),null),F(p=>(p=s().color)!=null?h.style.setProperty("color",p):h.style.removeProperty("color")),c})()};Ue(["click"]);var tg=S(`<div class=sql-editor><div class=editor-toolbar><div class=toolbar-left><span class=editor-label>SQL编辑器</span><span class=database-type>(<!>)</span></div><div class=toolbar-right><span class=cursor-position>行 <!>, 列 </span><span class=character-count> 字符</span></div></div><div class=template-toolbar><span class=template-label>模板:</span></div><div><textarea class=sql-textarea placeholder="请输入SQL查询语句...\r
\r
示例:\r
SELECT u.username, u.email, COUNT(o.id) as order_count\r
FROM users u\r
LEFT JOIN orders o ON u.id = o.user_id\r
WHERE u.created_at >= '2024-01-01'\r
GROUP BY u.id, u.username, u.email\r
ORDER BY order_count DESC\r
LIMIT 10;"rows=15></textarea><div class=line-numbers></div></div><div class=editor-help><div class=help-item><kbd>Tab</kbd> 缩进</div><div class=help-item><kbd>Ctrl+F</kbd> 格式化</div><div class=help-item><kbd>Enter</kbd> 自动缩进</div></div><style>
        .sql-editor {
          display: flex;
          flex-direction: column;
          border: 1px solid #ddd;
          border-radius: 6px;
          background: white;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .editor-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          background: #f8f9fa;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .toolbar-left {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .editor-label {
          font-weight: bold;
          color: #2c3e50;
        }

        .database-type {
          background: #3498db;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
          gap: 12px;
          color: #666;
        }

        .template-toolbar {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f1f3f5;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .template-label {
          color: #666;
          font-weight: bold;
        }

        .template-btn {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 4px;
          padding: 4px 8px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .template-btn:hover:not(:disabled) {
          background: #dee2e6;
          border-color: #adb5bd;
        }

        .template-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .editor-container {
          position: relative;
          flex: 1;
          min-height: 300px;
        }

        .editor-container.focused {
          box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editor-container.disabled {
          opacity: 0.6;
          pointer-events: none;
        }

        .sql-textarea {
          width: 100%;
          height: 100%;
          padding: 12px 12px 12px 48px;
          border: none;
          outline: none;
          resize: vertical;
          font-family: inherit;
          font-size: 14px;
          line-height: 1.5;
          background: transparent;
        }

        .line-numbers {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 36px;
          background: #f8f9fa;
          border-right: 1px solid #e9ecef;
          padding: 12px 4px;
          user-select: none;
          overflow: hidden;
        }

        .line-number {
          text-align: right;
          font-size: 12px;
          color: #6c757d;
          line-height: 1.5;
          padding-right: 8px;
        }

        .editor-help {
          display: flex;
          justify-content: center;
          gap: 16px;
          padding: 6px;
          background: #f8f9fa;
          border-top: 1px solid #ddd;
          font-size: 11px;
          color: #666;
        }

        .help-item {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        kbd {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 3px;
          padding: 2px 4px;
          font-size: 10px;
          font-family: inherit;
        }
      `),ng=S("<button class=template-btn>"),ig=S("<div class=line-number>");function sg(n){let e;const[t,i]=K(!1),[s,r]=K({line:1,column:1}),a=g=>{const v=g.target;n.onSQLChange(v.value),l()},l=()=>{if(!e)return;const g=e.selectionStart,h=n.sql.substring(0,g).split(`
`);r({line:h.length,column:(h[h.length-1]||"").length+1})},o=g=>{if(!e||n.disabled)return;const v=g.target,h=v.selectionStart,p=v.selectionEnd;if(g.key==="Tab"){g.preventDefault();const b=n.sql.substring(0,h)+"  "+n.sql.substring(p);n.onSQLChange(b),setTimeout(()=>{e&&(e.selectionStart=e.selectionEnd=h+2,l())},0)}else if(g.key==="Enter"){const b=n.sql.substring(0,h).split(`
`),m=b[b.length-1],y=m?.match(/^\s*/)?.[0]||"",$=m?.trim().toUpperCase()||"",w=["SELECT","FROM","WHERE","GROUP BY","ORDER BY","HAVING"].some(P=>$.endsWith(P)||$.includes(P+" "))?y+"  ":y;if(w){g.preventDefault();const P=n.sql.substring(0,h)+`
`+w+n.sql.substring(p);n.onSQLChange(P),setTimeout(()=>{if(e){const L=h+1+w.length;e.selectionStart=e.selectionEnd=L,l()}},0)}}},c=g=>{(g.ctrlKey||g.metaKey)&&g.key==="f"&&(g.preventDefault(),console.log("格式化快捷键触发"))},d=g=>{if(!e||n.disabled)return;const v=e.selectionStart,h=e.selectionEnd,p=n.sql.substring(0,v)+g+n.sql.substring(h);n.onSQLChange(p),setTimeout(()=>{e&&(e.focus(),e.selectionStart=e.selectionEnd=v+g.length,l())},0)};Qe(()=>{l(),e&&(e.addEventListener("selectionchange",l),e.addEventListener("click",l))});const u=[{name:"基础查询",template:"SELECT * FROM table_name WHERE condition;"},{name:"联表查询",template:`SELECT t1.*, t2.*
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.table1_id
WHERE condition;`},{name:"聚合查询",template:`SELECT column, COUNT(*), AVG(value)
FROM table_name
GROUP BY column
HAVING COUNT(*) > 1
ORDER BY column;`},{name:"子查询",template:`SELECT *
FROM table1
WHERE column IN (
  SELECT column
  FROM table2
  WHERE condition
);`}];return(()=>{var g=tg(),v=g.firstChild,h=v.firstChild,p=h.firstChild,b=p.nextSibling,m=b.firstChild,y=m.nextSibling;y.nextSibling;var $=h.nextSibling,x=$.firstChild,w=x.firstChild,P=w.nextSibling;P.nextSibling;var L=x.nextSibling,D=L.firstChild,z=v.nextSibling;z.firstChild;var E=z.nextSibling,R=E.firstChild,k=R.nextSibling;f(b,()=>n.databaseType.toUpperCase(),y),f(x,()=>s().line,P),f(x,()=>s().column,null),f(L,()=>n.sql.length,D),f(z,()=>u.map(N=>(()=>{var C=ng();return C.$$click=()=>d(N.template),f(C,()=>N.name),F(A=>{var X=n.disabled,G=`插入${N.name}模板`;return X!==A.e&&(C.disabled=A.e=X),G!==A.t&&Q(C,"title",A.t=G),A},{e:void 0,t:void 0}),C})()),null),R.addEventListener("blur",()=>i(!1)),R.addEventListener("focus",()=>i(!0)),R.addEventListener("keypress",c),R.$$keydown=o,R.$$input=a;var q=e;return typeof q=="function"?Qt(q,R):e=R,Q(R,"spellcheck",!1),f(k,()=>n.sql.split(`
`).map((N,C)=>(()=>{var A=ig();return f(A,C+1),A})())),F(N=>{var C=`editor-container ${t()?"focused":""} ${n.disabled?"disabled":""}`,A=n.disabled;return C!==N.e&&Se(E,N.e=C),A!==N.t&&(R.disabled=N.t=A),N},{e:void 0,t:void 0}),F(()=>R.value=n.sql),g})()}Ue(["input","keydown","click"]);var rg=S("<div class=empty-message><p>请选择要查询的字段</p><button>自动选择字段"),ag=S("<div class=builder-section><div class=section-header><h4>🔗 表关联 (JOIN)</h4><button class=add-btn>+ 添加关联</button></div><div class=joins-list>"),lg=S(`<div class=visual-query-builder><div class=query-options><label class=option-checkbox><input type=checkbox><span>去重查询 (DISTINCT)</span></label></div><div class=builder-section><div class=section-header><h4>📋 选择字段 (SELECT)</h4><button class=add-btn>+ 添加字段</button></div><div class=fields-list></div></div><div class=builder-section><div class=section-header><h4>🔍 筛选条件 (WHERE)</h4><button class=add-btn>+ 添加条件</button></div><div class=where-list></div></div><div class=builder-section><div class=section-header><h4>⚙️ 其他选项</h4></div><div class=options-grid><div class=option-group><label>限制行数 (LIMIT):</label><input type=number placeholder=无限制 min=1 max=10000></div></div></div><style>
        .visual-query-builder {
          display: flex;
          flex-direction: column;
          gap: 20px;
          padding: 16px;
          background: #f8f9fa;
          border-radius: 8px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .query-options {
          display: flex;
          gap: 16px;
        }

        .option-checkbox {
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
        }

        .builder-section {
          background: white;
          border-radius: 6px;
          padding: 16px;
          border: 1px solid #dee2e6;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e9ecef;
        }

        .section-header h4 {
          margin: 0;
          color: #2c3e50;
          font-size: 14px;
        }

        .add-btn {
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
        }

        .add-btn:hover:not(:disabled) {
          background: #218838;
        }

        .field-item, .join-item, .where-item {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
          padding: 8px;
          background: #f8f9fa;
          border-radius: 4px;
          flex-wrap: wrap;
        }

        .join-condition {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .separator {
          font-weight: bold;
          color: #6c757d;
        }

        select, input {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          border-radius: 3px;
          font-size: 13px;
        }

        select {
          background: white;
        }

        input[type="text"] {
          min-width: 100px;
          flex: 1;
        }

        input[type="number"] {
          width: 100px;
        }

        .remove-btn {
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          cursor: pointer;
          font-size: 14px;
        }

        .remove-btn:hover:not(:disabled) {
          background: #c82333;
        }

        .empty-message {
          text-align: center;
          padding: 20px;
          color: #6c757d;
        }

        .empty-message button {
          background: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 8px 16px;
          cursor: pointer;
          margin-top: 8px;
        }

        .options-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
        }

        .option-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .option-group label {
          font-weight: bold;
          color: #495057;
          font-size: 13px;
        }

        button:disabled, select:disabled, input:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      `),og=S('<div class=field-item><select></select><span class=separator>.</span><select></select><select><option value>无聚合</option><option value=COUNT>COUNT</option><option value=SUM>SUM</option><option value=AVG>AVG</option><option value=MIN>MIN</option><option value=MAX>MAX</option><option value=DISTINCT>DISTINCT</option></select><input type=text placeholder="别名 (可选)"><button class=remove-btn>×'),Rt=S("<option>"),cg=S("<option> (<!>)"),dg=S("<div class=join-item><select><option value=INNER>INNER JOIN</option><option value=LEFT>LEFT JOIN</option><option value=RIGHT>RIGHT JOIN</option><option value=FULL>FULL JOIN</option></select><div class=join-condition><select></select><select></select><span>=</span><select></select><select></select></div><button class=remove-btn>×"),hg=S("<select><option value=AND>AND</option><option value=OR>OR"),ug=S("<input type=text>"),gg=S('<div class=where-item><select></select><select></select><select><option value="=">=</option><option value="!=">!=</option><option value=">">&gt;</option><option value="<">&lt;</option><option value=">=">&gt;=</option><option value="<=">&lt;=</option><option value=LIKE>LIKE</option><option value=IN>IN</option><option value="IS NULL">IS NULL</option><option value="IS NOT NULL">IS NOT NULL</option></select><button class=remove-btn>×');function fg(n){const[e,t]=K([]),[i,s]=K([]),[r,a]=K([]),[l]=K([]),[o]=K([]),[c,d]=K(void 0),[u,g]=K(!1),v=Me(()=>n.schema?.schemas?.[0]?.tables?n.schema.schemas[0].tables.filter(R=>n.selectedTables.includes(R.name)):[]),h=R=>v().find(q=>q.name===R)?.columns||[],p=Me(()=>{const R=v();if(R.length===0||e().length===0)return"";let k="";k+=u()?"SELECT DISTINCT ":"SELECT ";const q=e().map(G=>{let O=`${G.table}.${G.column}`;return G.aggregate&&(G.aggregate==="DISTINCT"?O=`DISTINCT ${O}`:O=`${G.aggregate}(${O})`),G.alias&&(O+=` AS ${G.alias}`),O});k+=q.join(`,
       `),k+=`
FROM ${R[0]?.name||"table1"}`;const N=i();for(const G of N)k+=`
${G.joinType} JOIN ${G.rightTable} ON ${G.leftTable}.${G.leftColumn} = ${G.rightTable}.${G.rightColumn}`;const C=r();if(C.length>0){k+=`
WHERE `;const G=C.map((O,V)=>{let B="";return V>0&&(B+=`${O.logicalOperator} `),B+=`${O.table}.${O.column} ${O.operator}`,["IS NULL","IS NOT NULL"].includes(O.operator)||(O.operator==="IN"?B+=` (${O.value})`:O.operator==="LIKE"?B+=` '%${O.value}%'`:B+=` '${O.value}'`),B});k+=G.join(" ")}const A=o();A.length>0&&(k+=`
GROUP BY ${A.join(", ")}`);const X=l();if(X.length>0){const G=X.map(O=>`${O.table}.${O.column} ${O.direction}`);k+=`
ORDER BY ${G.join(", ")}`}return c()&&(k+=`
LIMIT ${c()}`),k});Qe(()=>{m()});const b=()=>{n.onQueryChange(p())},m=()=>{const R=v();if(R.length===0)return;const k=[];R.forEach(q=>{(q.columns?.slice(0,3)||[]).forEach(C=>{k.push({table:q.name,column:C.name})})}),t(k),b()},y=()=>{const R=v();if(R.length===0)return;const k=R[0];if(!k)return;const q=k.columns?.[0]?.name||"id";t(N=>[...N,{table:k.name,column:q}]),b()},$=R=>{t(k=>k.filter((q,N)=>N!==R)),b()},x=(R,k)=>{t(q=>q.map((N,C)=>{if(C===R){const A={...N,...k};return k.hasOwnProperty("aggregate")&&k.aggregate===void 0&&delete A.aggregate,k.hasOwnProperty("alias")&&k.alias===void 0&&delete A.alias,A}return N})),b()},w=()=>{const R=v();if(R.length<2)return;const k=R[0],q=R[1];if(!k||!q)return;const N=k.columns?.[0]?.name||"id",C=q.columns?.[0]?.name||"id",A={id:Date.now().toString(),leftTable:k.name,leftColumn:N,rightTable:q.name,rightColumn:C,joinType:"INNER"};s(X=>[...X,A]),b()},P=R=>{s(k=>k.filter(q=>q.id!==R)),b()},L=(R,k)=>{s(q=>q.map(N=>N.id===R?{...N,...k}:N)),b()},D=()=>{const R=v();if(R.length===0)return;const k=R[0];if(!k)return;const q=k.columns?.[0]?.name||"id",N={id:Date.now().toString(),table:k.name,column:q,operator:"=",value:"",logicalOperator:"AND"};a(C=>[...C,N]),b()},z=R=>{a(k=>k.filter(q=>q.id!==R)),b()},E=(R,k)=>{a(q=>q.map(N=>N.id===R?{...N,...k}:N)),b()};return(()=>{var R=lg(),k=R.firstChild,q=k.firstChild,N=q.firstChild,C=k.nextSibling,A=C.firstChild,X=A.firstChild,G=X.nextSibling,O=A.nextSibling,V=C.nextSibling,B=V.firstChild,H=B.firstChild,j=H.nextSibling,de=B.nextSibling,me=V.nextSibling,fe=me.firstChild,ee=fe.nextSibling,oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling;return N.addEventListener("change",te=>{g(te.currentTarget.checked),b()}),G.$$click=y,f(O,_(pe,{get each(){return e()},children:(te,ne)=>(()=>{var ve=og(),be=ve.firstChild,ke=be.nextSibling,_e=ke.nextSibling,Pe=_e.nextSibling,ue=Pe.nextSibling,xe=ue.nextSibling;return be.addEventListener("change",M=>{const Y=v().find(ie=>ie.name===M.currentTarget.value)?.columns?.[0]?.name||"id";x(ne(),{table:M.currentTarget.value,column:Y})}),f(be,_(pe,{get each(){return v()},children:M=>(()=>{var I=Rt();return f(I,()=>M.name),F(()=>I.value=M.name),I})()})),_e.addEventListener("change",M=>x(ne(),{column:M.currentTarget.value})),f(_e,_(pe,{get each(){return h(te.table)},children:M=>(()=>{var I=cg(),J=I.firstChild,Y=J.nextSibling;return Y.nextSibling,f(I,()=>M.name,J),f(I,()=>M.data_type,Y),F(()=>I.value=M.name),I})()})),Pe.addEventListener("change",M=>{const I=M.currentTarget.value;I===""?x(ne(),{aggregate:void 0}):x(ne(),{aggregate:I})}),ue.$$input=M=>{const I=M.currentTarget.value;I===""?x(ne(),{alias:void 0}):x(ne(),{alias:I})},xe.$$click=()=>$(ne()),F(M=>{var I=n.disabled,J=n.disabled,Y=n.disabled,ie=n.disabled,ce=n.disabled;return I!==M.e&&(be.disabled=M.e=I),J!==M.t&&(_e.disabled=M.t=J),Y!==M.a&&(Pe.disabled=M.a=Y),ie!==M.o&&(ue.disabled=M.o=ie),ce!==M.i&&(xe.disabled=M.i=ce),M},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),F(()=>be.value=te.table),F(()=>_e.value=te.column),F(()=>Pe.value=te.aggregate||""),F(()=>ue.value=te.alias||""),ve})()}),null),f(O,_(W,{get when(){return e().length===0},get children(){var te=rg(),ne=te.firstChild,ve=ne.nextSibling;return ve.$$click=m,F(()=>ve.disabled=n.disabled),te}}),null),f(R,_(W,{get when(){return v().length>1},get children(){var te=ag(),ne=te.firstChild,ve=ne.firstChild,be=ve.nextSibling,ke=ne.nextSibling;return be.$$click=w,f(ke,_(pe,{get each(){return i()},children:_e=>(()=>{var Pe=dg(),ue=Pe.firstChild,xe=ue.nextSibling,M=xe.firstChild,I=M.nextSibling,J=I.nextSibling,Y=J.nextSibling,ie=Y.nextSibling,ce=xe.nextSibling;return ue.addEventListener("change",ae=>L(_e.id,{joinType:ae.currentTarget.value})),M.addEventListener("change",ae=>L(_e.id,{leftTable:ae.currentTarget.value})),f(M,_(pe,{get each(){return v()},children:ae=>(()=>{var Ce=Rt();return f(Ce,()=>ae.name),F(()=>Ce.value=ae.name),Ce})()})),I.addEventListener("change",ae=>L(_e.id,{leftColumn:ae.currentTarget.value})),f(I,_(pe,{get each(){return h(_e.leftTable)},children:ae=>(()=>{var Ce=Rt();return f(Ce,()=>ae.name),F(()=>Ce.value=ae.name),Ce})()})),Y.addEventListener("change",ae=>L(_e.id,{rightTable:ae.currentTarget.value})),f(Y,_(pe,{get each(){return v()},children:ae=>(()=>{var Ce=Rt();return f(Ce,()=>ae.name),F(()=>Ce.value=ae.name),Ce})()})),ie.addEventListener("change",ae=>L(_e.id,{rightColumn:ae.currentTarget.value})),f(ie,_(pe,{get each(){return h(_e.rightTable)},children:ae=>(()=>{var Ce=Rt();return f(Ce,()=>ae.name),F(()=>Ce.value=ae.name),Ce})()})),ce.$$click=()=>P(_e.id),F(ae=>{var Ce=n.disabled,Ie=n.disabled,Te=n.disabled,Ye=n.disabled,We=n.disabled,ot=n.disabled;return Ce!==ae.e&&(ue.disabled=ae.e=Ce),Ie!==ae.t&&(M.disabled=ae.t=Ie),Te!==ae.a&&(I.disabled=ae.a=Te),Ye!==ae.o&&(Y.disabled=ae.o=Ye),We!==ae.i&&(ie.disabled=ae.i=We),ot!==ae.n&&(ce.disabled=ae.n=ot),ae},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),F(()=>ue.value=_e.joinType),F(()=>M.value=_e.leftTable),F(()=>I.value=_e.leftColumn),F(()=>Y.value=_e.rightTable),F(()=>ie.value=_e.rightColumn),Pe})()})),F(()=>be.disabled=n.disabled),te}}),V),j.$$click=D,f(de,_(pe,{get each(){return r()},children:(te,ne)=>(()=>{var ve=gg(),be=ve.firstChild,ke=be.nextSibling,_e=ke.nextSibling,Pe=_e.nextSibling;return f(ve,_(W,{get when(){return ne()>0},get children(){var ue=hg();return ue.addEventListener("change",xe=>E(te.id,{logicalOperator:xe.currentTarget.value})),F(()=>ue.disabled=n.disabled),F(()=>ue.value=te.logicalOperator),ue}}),be),be.addEventListener("change",ue=>E(te.id,{table:ue.currentTarget.value})),f(be,_(pe,{get each(){return v()},children:ue=>(()=>{var xe=Rt();return f(xe,()=>ue.name),F(()=>xe.value=ue.name),xe})()})),ke.addEventListener("change",ue=>E(te.id,{column:ue.currentTarget.value})),f(ke,_(pe,{get each(){return h(te.table)},children:ue=>(()=>{var xe=Rt();return f(xe,()=>ue.name),F(()=>xe.value=ue.name),xe})()})),_e.addEventListener("change",ue=>E(te.id,{operator:ue.currentTarget.value})),f(ve,_(W,{get when(){return!["IS NULL","IS NOT NULL"].includes(te.operator)},get children(){var ue=ug();return ue.$$input=xe=>E(te.id,{value:xe.currentTarget.value}),F(xe=>{var M=te.operator==="IN"?"值1,值2,值3":"值",I=n.disabled;return M!==xe.e&&Q(ue,"placeholder",xe.e=M),I!==xe.t&&(ue.disabled=xe.t=I),xe},{e:void 0,t:void 0}),F(()=>ue.value=te.value),ue}}),Pe),Pe.$$click=()=>z(te.id),F(ue=>{var xe=n.disabled,M=n.disabled,I=n.disabled,J=n.disabled;return xe!==ue.e&&(be.disabled=ue.e=xe),M!==ue.t&&(ke.disabled=ue.t=M),I!==ue.a&&(_e.disabled=ue.a=I),J!==ue.o&&(Pe.disabled=ue.o=J),ue},{e:void 0,t:void 0,a:void 0,o:void 0}),F(()=>be.value=te.table),F(()=>ke.value=te.column),F(()=>_e.value=te.operator),ve})()})),he.$$input=te=>{const ne=parseInt(te.currentTarget.value)||void 0;d(ne),b()},F(te=>{var ne=n.disabled,ve=n.disabled,be=n.disabled,ke=n.disabled;return ne!==te.e&&(N.disabled=te.e=ne),ve!==te.t&&(G.disabled=te.t=ve),be!==te.a&&(j.disabled=te.a=be),ke!==te.o&&(he.disabled=te.o=ke),te},{e:void 0,t:void 0,a:void 0,o:void 0}),F(()=>N.checked=u()),F(()=>he.value=c()||""),R})()}Ue(["click","input"]);var vg=S('<button class="action-btn close-btn"title=关闭预览>✕'),pg=S("<table class=result-table><thead><tr></tr></thead><tbody>"),mg=S("<div class=pagination><div class=pagination-info>显示 <!> - <!>/ <!> 行</div><div class=pagination-controls><select><option value=10>10行/页</option><option value=25>25行/页</option><option value=50>50行/页</option><option value=100>100行/页</option></select><div class=page-buttons><button>首页</button><button>上一页</button><span class=page-info> / </span><button>下一页</button><button>末页"),bg=S(`<div class=query-preview><div class=preview-header><div class=header-info><h4>📊 查询结果预览</h4><div class=result-stats><span class=stat-item>📋 <!> 行数据</span><span class=stat-item>📊 <!> 列</span><span class=stat-item>⏱️ <!>ms</span></div></div><div class=header-actions><button class="action-btn export-btn"title=导出为CSV文件>📤 导出CSV</button></div></div><div class=query-info><details><summary>🔍 查询详情</summary><div class=query-details><div class=query-sql><strong>SQL查询:</strong><pre class=sql-code></pre></div><div class=query-metadata><div class=metadata-item><strong>执行时间:</strong> <!>ms</div><div class=metadata-item><strong>返回行数:</strong> </div><div class=metadata-item><strong>列数量:</strong> </div></div></div></details></div><div class=table-container></div><style>
        .query-preview {
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          overflow: hidden;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .preview-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          padding: 16px;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
        }

        .header-info h4 {
          margin: 0 0 8px 0;
          color: #2c3e50;
        }

        .result-stats {
          display: flex;
          gap: 16px;
          font-size: 13px;
        }

        .stat-item {
          color: #6c757d;
        }

        .header-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border: 1px solid #ced4da;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s;
        }

        .export-btn:hover {
          background: #28a745;
          color: white;
          border-color: #28a745;
        }

        .close-btn:hover {
          background: #dc3545;
          color: white;
          border-color: #dc3545;
        }

        .query-info {
          padding: 12px 16px;
          border-bottom: 1px solid #e9ecef;
        }

        .query-details {
          margin-top: 8px;
        }

        .query-sql {
          margin-bottom: 12px;
        }

        .sql-code {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px;
          font-family: 'Monaco', 'Consolas', monospace;
          font-size: 12px;
          overflow-x: auto;
          margin: 4px 0;
        }

        .query-metadata {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
          font-size: 13px;
        }

        .metadata-item {
          color: #495057;
        }

        .table-container {
          overflow: auto;
          max-height: 500px;
        }

        .result-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .result-table th {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 8px 12px;
          text-align: left;
          font-weight: 600;
          position: sticky;
          top: 0;
          z-index: 1;
        }

        .result-table th.sortable {
          cursor: pointer;
          user-select: none;
        }

        .result-table th.sortable:hover {
          background: #e9ecef;
        }

        .column-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .sort-indicator {
          opacity: 0.5;
          font-size: 12px;
        }

        .result-table th.sorted-asc .sort-indicator,
        .result-table th.sorted-desc .sort-indicator {
          opacity: 1;
          color: #007bff;
        }

        .result-table td {
          border: 1px solid #dee2e6;
          padding: 6px 12px;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .result-table tr.even {
          background: #f8f9fa;
        }

        .result-table tr:hover {
          background: #e3f2fd;
        }

        .cell-null {
          color: #6c757d;
          font-style: italic;
        }

        .cell-boolean {
          text-align: center;
          font-weight: bold;
        }

        .cell-integer, .cell-float {
          text-align: right;
          font-family: 'Monaco', 'Consolas', monospace;
        }

        .cell-datetime {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #6f42c1;
        }

        .cell-object {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #e83e8c;
        }

        .empty-result {
          text-align: center;
          padding: 40px 20px;
          color: #6c757d;
        }

        .empty-icon {
          font-size: 48px;
          margin-bottom: 16px;
        }

        .empty-text {
          font-size: 18px;
          font-weight: 500;
          margin-bottom: 8px;
        }

        .empty-hint {
          font-size: 14px;
        }

        .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          background: #f8f9fa;
          border-top: 1px solid #dee2e6;
          font-size: 13px;
        }

        .pagination-controls {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .page-buttons {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .page-buttons button {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          background: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }

        .page-buttons button:hover:not(:disabled) {
          background: #e9ecef;
        }

        .page-buttons button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .page-info {
          margin: 0 8px;
          font-weight: 500;
        }

        details summary {
          cursor: pointer;
          font-weight: 500;
          color: #495057;
        }

        details[open] summary {
          margin-bottom: 8px;
        }
      `),yg=S("<div class=empty-result><div class=empty-icon>📭</div><div class=empty-text>查询未返回任何数据</div><div class=empty-hint>请检查查询条件或数据源"),_g=S("<th><div class=column-header><span class=column-name></span><span class=sort-indicator>"),xg=S("<tr>"),Sg=S("<td>");function wg(n){const[e,t]=K(1),[i,s]=K(10),[r,a]=K(null),[l,o]=K("asc"),c=Me(()=>{let h=[...n.result.rows];if(r()){const m=r();h.sort((y,$)=>{const x=y[m],w=$[m];if(x==null)return 1;if(w==null)return-1;const P=String(x).localeCompare(String(w),void 0,{numeric:!0});return l()==="asc"?P:-P})}const p=(e()-1)*i(),b=p+i();return{data:h.slice(p,b),totalPages:Math.ceil(h.length/i()),totalRows:h.length}}),d=h=>{r()===h?o(p=>p==="asc"?"desc":"asc"):(a(h),o("asc"))},u=h=>{if(h==null)return"";if(typeof h=="object")return JSON.stringify(h);if(typeof h=="boolean")return h?"✓":"✗";if(typeof h=="number")return Number.isInteger(h)?h.toLocaleString():h.toFixed(2);const p=String(h);if(p.match(/^\d{4}-\d{2}-\d{2}/)||p.includes("T"))try{const b=new Date(p);if(!isNaN(b.getTime()))return b.toLocaleString("zh-CN")}catch{}return p.length>50?p.substring(0,47)+"...":p},g=h=>{if(h==null)return"null";if(typeof h=="boolean")return"boolean";if(typeof h=="number")return Number.isInteger(h)?"integer":"float";if(typeof h=="object")return"object";const p=String(h);if(p.match(/^\d{4}-\d{2}-\d{2}/)||p.includes("T"))try{const b=new Date(p);if(!isNaN(b.getTime()))return"datetime"}catch{}return"string"},v=()=>{const h=n.result.columns.join(","),p=n.result.rows.map(x=>n.result.columns.map(w=>{const P=x[w],L=u(P);return L.includes(",")||L.includes('"')||L.includes(`
`)?`"${L.replace(/"/g,'""')}"`:L}).join(",")).join(`
`),b=h+`
`+p,m=new Blob([b],{type:"text/csv;charset=utf-8;"}),y=document.createElement("a"),$=URL.createObjectURL(m);y.setAttribute("href",$),y.setAttribute("download",`query_result_${Date.now()}.csv`),document.body.appendChild(y),y.click(),document.body.removeChild(y)};return(()=>{var h=bg(),p=h.firstChild,b=p.firstChild,m=b.firstChild,y=m.nextSibling,$=y.firstChild,x=$.firstChild,w=x.nextSibling;w.nextSibling;var P=$.nextSibling,L=P.firstChild,D=L.nextSibling;D.nextSibling;var z=P.nextSibling,E=z.firstChild,R=E.nextSibling;R.nextSibling;var k=b.nextSibling,q=k.firstChild,N=p.nextSibling,C=N.firstChild,A=C.firstChild,X=A.nextSibling,G=X.firstChild,O=G.firstChild,V=O.nextSibling,B=G.nextSibling,H=B.firstChild,j=H.firstChild,de=j.nextSibling,me=de.nextSibling;me.nextSibling;var fe=H.nextSibling,ee=fe.firstChild;ee.nextSibling;var oe=fe.nextSibling,ge=oe.firstChild;ge.nextSibling;var he=N.nextSibling,te=he.nextSibling;return f($,()=>n.result.totalCount??n.result.total_rows,w),f(P,()=>n.result.columns.length,D),f(z,()=>n.result.execution_time,R),q.$$click=v,f(k,_(W,{get when(){return n.onClose},get children(){var ne=vg();return Ae(ne,"click",n.onClose),ne}}),null),f(V,()=>n.result.query),f(H,()=>n.result.execution_time,me),f(fe,()=>n.result.totalCount??n.result.total_rows,null),f(oe,()=>n.result.columns.length,null),f(he,_(W,{get when(){return n.result.rows.length>0},get fallback(){return yg()},get children(){var ne=pg(),ve=ne.firstChild,be=ve.firstChild,ke=ve.nextSibling;return f(be,_(pe,{get each(){return n.result.columns},children:_e=>(()=>{var Pe=_g(),ue=Pe.firstChild,xe=ue.firstChild,M=xe.nextSibling;return Pe.$$click=()=>d(_e),Q(Pe,"title",`点击排序 ${_e}`),f(xe,_e),f(M,(()=>{var I=$e(()=>r()===_e);return()=>I()?l()==="asc"?"↑":"↓":"↕"})()),F(()=>Se(Pe,`sortable ${r()===_e?`sorted-${l()}`:""}`)),Pe})()})),f(ke,_(pe,{get each(){return c().data},children:(_e,Pe)=>(()=>{var ue=xg();return f(ue,_(pe,{get each(){return n.result.columns},children:xe=>(()=>{var M=Sg();return f(M,()=>u(_e[xe])),F(I=>{var J=`cell-${g(_e[xe])}`,Y=`${xe}: ${u(_e[xe])}`;return J!==I.e&&Se(M,I.e=J),Y!==I.t&&Q(M,"title",I.t=Y),I},{e:void 0,t:void 0}),M})()})),F(()=>Se(ue,Pe()%2===0?"even":"odd")),ue})()})),ne}})),f(h,_(W,{get when(){return c().totalPages>1},get children(){var ne=mg(),ve=ne.firstChild,be=ve.firstChild,ke=be.nextSibling,_e=ke.nextSibling,Pe=_e.nextSibling,ue=Pe.nextSibling,xe=ue.nextSibling;xe.nextSibling;var M=ve.nextSibling,I=M.firstChild,J=I.nextSibling,Y=J.firstChild,ie=Y.nextSibling,ce=ie.nextSibling,ae=ce.firstChild,Ce=ce.nextSibling,Ie=Ce.nextSibling;return f(ve,()=>(e()-1)*i()+1,ke),f(ve,()=>Math.min(e()*i(),c().totalRows),Pe),f(ve,()=>c().totalRows,xe),I.addEventListener("change",Te=>{s(parseInt(Te.currentTarget.value)),t(1)}),Y.$$click=()=>t(1),ie.$$click=()=>t(Te=>Math.max(1,Te-1)),f(ce,e,ae),f(ce,()=>c().totalPages,null),Ce.$$click=()=>t(Te=>Math.min(c().totalPages,Te+1)),Ie.$$click=()=>t(c().totalPages),F(Te=>{var Ye=e()===1,We=e()===1,ot=e()===c().totalPages,Pt=e()===c().totalPages;return Ye!==Te.e&&(Y.disabled=Te.e=Ye),We!==Te.t&&(ie.disabled=Te.t=We),ot!==Te.a&&(Ce.disabled=Te.a=ot),Pt!==Te.o&&(Ie.disabled=Te.o=Pt),Te},{e:void 0,t:void 0,a:void 0,o:void 0}),F(()=>I.value=i()),ne}}),te),h})()}Ue(["click"]);var $g=S("<span>通过可视化界面构建查询，适合初学者使用"),Cg=S("<span>直接编写SQL语句，适合有经验的用户"),kg=S("<div class=error-message>❌ "),Tg=S("<div class=validation-errors><strong>错误:</strong><ul>"),Eg=S("<div class=validation-warnings><strong>警告:</strong><ul>"),Pg=S("<div class=validation-suggestions><strong>建议:</strong><ul>"),Ag=S("<div><div class=validation-header><span class=validation-status></span><span class=security-status>"),Rg=S('<div class=sql-query-builder><div class=query-mode-selector><div class=mode-tabs><button>🎯 可视化构建</button><button>💻 自定义SQL</button></div><div class=mode-description></div></div><div class=query-content></div><div class=query-preview-section><div class=preview-header><h4>📋 SQL查询预览</h4><div class=preview-actions><button class="action-btn format-btn"title=格式化SQL代码>🎨 格式化</button><button class="action-btn validate-btn"title=验证SQL语法>✓ 验证语法</button><button class="action-btn copy-btn"title=复制SQL到剪贴板>📋 复制</button><button class="action-btn execute-btn"title=执行查询预览></button></div></div><div class=sql-display><pre class=sql-code><code></code></pre></div></div><div class=query-help><details><summary>💡 查询构建帮助</summary><div class=help-content><div class=help-section><h5>可视化构建:</h5><ul><li>选择表和字段来自动生成查询</li><li>支持JOIN关联、WHERE条件、ORDER BY排序</li><li>适合SQL初学者使用</li></ul></div><div class=help-section><h5>自定义SQL:</h5><ul><li>直接编写SQL语句，支持复杂查询</li><li>提供语法验证和格式化功能</li><li>适合有经验的用户</li></ul></div><div class=help-section><h5>安全提示:</h5><ul><li>系统会自动检测SQL注入风险</li><li>预览查询限制返回行数，避免性能问题</li><li>建议先验证语法，再执行预览'),fi=S("<li>");function Lg(n){const[e,t]=K("visual"),[i,s]=K(!1),[r,a]=K(null),[l,o]=K(null),[c,d]=K(null),[u,g]=K(""),v=Me(()=>e()==="visual"?u():n.sql),h=Me(()=>l()),p=async()=>{const x=v().trim();if(!x){o(null),n.onValidationChange(null);return}try{if(s(!0),a(null),console.log("🔍 验证SQL语法:",x),console.log("🔍 SQLQueryBuilder config对象:",n.config),console.log("🔍 config对象的键:",Object.keys(n.config)),console.log("🔍 database_type字段:",n.config.database_type),["database_type","databaseType","dbType","type"].forEach(L=>{n.config[L]&&console.log(`🔍 找到字段 ${L}:`,n.config[L])}),!n.config.database_type)throw new Error(`database_type字段缺失，config内容: ${JSON.stringify(n.config)}`);const P=await Re.validateSqlSyntax(x,n.config.database_type);o(P),n.onValidationChange(P),console.log("✅ SQL验证结果:",P)}catch(w){console.error("❌ SQL验证失败:",w);const P={valid:!1,errors:[`验证失败: ${w}`],warnings:[],suggestions:[],is_safe:!1,security_issues:["无法验证查询安全性"]};o(P),n.onValidationChange(P),a(`SQL验证失败: ${w}`)}finally{s(!1)}},b=async()=>{const x=v().trim();if(x)try{s(!0),a(null),console.log("🎨 格式化SQL:",x);const w=await Re.formatSql(x,n.config.database_type);e()==="visual"?g(w):n.onSQLChange(w),console.log("✅ SQL格式化完成")}catch(w){console.error("❌ SQL格式化失败:",w),a(`格式化失败: ${w}`)}finally{s(!1)}},m=async()=>{const x=v().trim();if(!x){a("请输入SQL查询语句");return}try{s(!0),a(null),console.log("▶️ 执行查询预览:",x),await p();const w=l();if(w&&!w.valid){a("SQL语法验证失败，请修正后重试");return}const P=await Re.executeDatabasePreview(n.config,x,50);d(P),n.onQueryResult(P),console.log("✅ 查询预览成功:",P)}catch(w){console.error("❌ 查询预览失败:",w),a(`查询执行失败: ${w}`),d(null),n.onQueryResult(null)}finally{s(!1)}},y=async()=>{const x=v();if(x)try{await navigator.clipboard.writeText(x),console.log("📋 SQL已复制到剪贴板")}catch(w){console.error("❌ 复制失败:",w),a(`复制失败: ${w}`)}},$=x=>{t(x),a(null),x==="custom"&&u()&&n.onSQLChange(u())};return(()=>{var x=Rg(),w=x.firstChild,P=w.firstChild,L=P.firstChild,D=L.nextSibling,z=P.nextSibling,E=w.nextSibling,R=E.nextSibling,k=R.firstChild,q=k.firstChild,N=q.nextSibling,C=N.firstChild,A=C.nextSibling,X=A.nextSibling,G=X.nextSibling,O=k.nextSibling,V=O.firstChild,B=V.firstChild;return L.$$click=()=>$("visual"),D.$$click=()=>$("custom"),f(z,_(W,{get when(){return e()==="visual"},get children(){return $g()}}),null),f(z,_(W,{get when(){return e()==="custom"},get children(){return Cg()}}),null),f(x,_(W,{get when(){return r()},get children(){var H=kg();return H.firstChild,f(H,r,null),H}}),E),f(E,_(W,{get when(){return e()==="visual"},get children(){return _(fg,{get selectedTables(){return n.selectedTables},get schema(){return n.schema},onQueryChange:g,get disabled(){return i()}})}}),null),f(E,_(W,{get when(){return e()==="custom"},get children(){return _(sg,{get sql(){return n.sql},get onSQLChange(){return n.onSQLChange},get databaseType(){return n.config.database_type},get disabled(){return i()}})}}),null),C.$$click=b,A.$$click=p,X.$$click=y,G.$$click=m,f(G,()=>i()?"⏳ 执行中...":"▶️ 预览查询"),f(B,()=>v()||"-- 请构建或输入SQL查询语句"),f(R,_(W,{get when(){return h()},get children(){var H=Ag(),j=H.firstChild,de=j.firstChild,me=de.nextSibling;return f(de,()=>h().valid?"✅ 语法正确":"❌ 语法错误"),f(me,()=>h().is_safe?"🔒 查询安全":"⚠️ 安全警告"),f(H,_(W,{get when(){return $e(()=>!!h().errors)()&&h().errors.length>0},get children(){var fe=Tg(),ee=fe.firstChild,oe=ee.nextSibling;return f(oe,_(pe,{get each(){return h().errors},children:ge=>(()=>{var he=fi();return f(he,ge),he})()})),fe}}),null),f(H,_(W,{get when(){return $e(()=>!!h()?.warnings)()&&h().warnings.length>0},get children(){var fe=Eg(),ee=fe.firstChild,oe=ee.nextSibling;return f(oe,_(pe,{get each(){return h().warnings},children:ge=>(()=>{var he=fi();return f(he,ge),he})()})),fe}}),null),f(H,_(W,{get when(){return $e(()=>!!h()?.suggestions)()&&h().suggestions.length>0},get children(){var fe=Pg(),ee=fe.firstChild,oe=ee.nextSibling;return f(oe,_(pe,{get each(){return h().suggestions},children:ge=>(()=>{var he=fi();return f(he,ge),he})()})),fe}}),null),F(()=>Se(H,`validation-result ${h()?.valid?"valid":"invalid"}`)),H}}),null),f(R,_(W,{get when(){return c()},get children(){return _(wg,{get result(){return c()},onClose:()=>{d(null),n.onQueryResult(null)}})}}),null),F(H=>{var j=`mode-tab ${e()==="visual"?"active":""}`,de=i(),me=`mode-tab ${e()==="custom"?"active":""}`,fe=i(),ee=i()||!v(),oe=i()||!v(),ge=i()||!v(),he=i()||!v();return j!==H.e&&Se(L,H.e=j),de!==H.t&&(L.disabled=H.t=de),me!==H.a&&Se(D,H.a=me),fe!==H.o&&(D.disabled=H.o=fe),ee!==H.i&&(C.disabled=H.i=ee),oe!==H.n&&(A.disabled=H.n=oe),ge!==H.s&&(X.disabled=H.s=ge),he!==H.h&&(G.disabled=H.h=he),H},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),x})()}Ue(["click"]);var Mg=S("<div class=error-messages>"),Dg=S("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>处理中..."),Og=S('<div class=form-row><div class="form-group flex-2"><label>主机地址</label><input type=text placeholder=localhost></div><div class="form-group flex-1"><label>端口</label><input type=number>'),Ig=S("<div class=form-group><label>数据库文件路径</label><input type=text placeholder=/path/to/database.db>"),Ng=S("<div class=form-group><label>数据库名</label><input type=text placeholder=myapp_production>"),zg=S("<div class=form-row><div class=form-group><label>用户名</label><input type=text></div><div class=form-group><label>密码</label><input type=password>"),Fr=S("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Fg=S("<div class=connection-step><div class=step-header><h4>🔌 数据库连接配置</h4><p>请填写数据库连接信息</p></div><div class=form-section><div class=form-group><label>数据库类型</label><select><option value=mysql>MySQL</option><option value=postgresql>PostgreSQL</option><option value=sqlite>SQLite</option><option value=sqlserver>SQL Server</option><option value=oracle>Oracle</option></select></div><div class=connection-test><button class=test-connection-btn>"),Gg=S("<div class=schema-loading><button class=load-schema-btn>🔄 加载表结构</button><p class=loading-hint>点击按钮加载数据库的表结构信息"),Bg=S("<div class=views-section><h5>👁️ 数据视图列表</h5><div class=views-list>"),Ug=S("<div class=schema-content><div class=schema-summary><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>表数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>视图数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>加载时间:</span><span class=summary-value></span></div></div><div class=tables-section><h5>📋 数据表列表</h5><div class=tables-grid>"),Hg=S("<div class=schema-step><div class=step-header><h4>🗂️ 数据库表结构</h4><p>选择要查询的数据表和字段"),qg=S('<div class=database-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>🗄️ 创建数据库数据源</h3><p>连接数据库并配置查询语句</p></div></div><div class=wizard-progress><div><div class=step-indicator>1</div><div class=step-info><div class=step-title>数据库连接</div><div class=step-description>配置连接信息</div></div></div><div><div class=step-indicator>2</div><div class=step-info><div class=step-title>表结构</div><div class=step-description>选择数据表</div></div></div><div><div class=step-indicator>3</div><div class=step-info><div class=step-title>查询构建</div><div class=step-description>编写SQL查询</div></div></div><div><div class=step-indicator>4</div><div class=step-info><div class=step-title>预览保存</div><div class=step-description>测试并保存</div></div></div></div><div class=wizard-content></div><div class=wizard-controls><div class=control-buttons><button class="control-btn back-btn">← 上一步</button><button class="control-btn next-btn">下一步 →'),Wg=S("<div class=error-message>❌ "),jg=S("<span class=view-comment>"),Yg=S("<div class=view-item><div class=view-info><span class=view-name></span><span class=view-schema>"),Vg=S("<div class=table-comment>"),Xg=S("<div class=more-columns>+<!> 个字段..."),Qg=S("<span class=more-indexes>+"),Jg=S("<div class=table-indexes><h6>索引 (<!>)</h6><div class=indexes-list>"),Kg=S("<span class=more-relations>+"),Zg=S("<div class=table-relations><h6>关联 (<!>)</h6><div class=relations-list>"),ef=S("<div><div class=table-card-header><div class=table-card-title><label class=table-checkbox><input type=checkbox><span class=table-name>📋 </span></label></div><div class=table-card-stats><span class=row-count title=预估行数> 行</span><span class=table-size title=预估大小></span></div></div><div class=table-columns><h6>字段 (<!>)</h6><div class=columns-preview>"),tf=S("<span class=pk-badge title=主键>🔑"),nf=S("<span class=fk-badge title=外键>🔗"),sf=S("<div class=column-item><span class=column-icon></span><span class=column-name></span><span class=column-type>"),rf=S("<span> "),af=S("<span class=relation-badge>🔗 "),lf=S('<div class=preview-step><div class=step-header><h4>👁️ 预览和保存</h4><p>验证配置、预览数据并保存数据源</p></div><div class=basic-info-section><h5>📝 基本信息</h5><div class=form-row><div class="form-group flex-2"><label>数据源名称 *</label><input type=text placeholder=输入数据源名称... required></div><div class="form-group flex-1"><label>标签</label><input type=text placeholder="标签1, 标签2"></div></div><div class=form-group><label>描述</label><textarea placeholder=描述这个数据源的用途... rows=3>'),of=S("<div class=config-summary><h5>⚙️ 配置摘要</h5><div class=summary-grid><div class=summary-item><span class=summary-label>数据库类型:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>连接地址:</span><span class=summary-value>:</span></div><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>用户名:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>选中表:</span><span class=summary-value> 个表</span></div><div class=summary-item><span class=summary-label>查询长度:</span><span class=summary-value> 字符</span></div></div><div class=sql-preview><h6>SQL查询预览:</h6><pre class=sql-code>"),cf=S("<div class=validation-warnings><h6>⚠️ 警告"),df=S("<div class=validation-errors><h6>❌ 错误"),hf=S("<div class=validation-suggestions><h6>💡 建议"),uf=S("<div class=validation-results><div class=validation-checks>"),gf=S("<div class=validation-section><div class=section-header><h5>✅ 验证状态</h5><button class=validate-btn>"),ff=S("<div class=warning-item>"),vf=S("<div class=error-item>"),pf=S("<div class=suggestion-item>"),mf=S("<div><span class=check-icon></span><span class=check-label></span><span>"),bf=S("<div class=no-data>没有查询到数据"),yf=S("<div class=preview-results><div class=preview-stats><div class=stat-item><span class=stat-label>样本行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>预估总行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>执行时间:</span><span class=stat-value>ms</span></div></div><div class=preview-data>"),_f=S("<div class=data-preview-section><div class=section-header><h5>📊 数据预览</h5><button class=preview-btn>"),xf=S("<div class=no-data>没有数据"),Sf=S("<div class=table-footer>显示前10行，共 <!> 行数据"),wf=S("<div class=data-table-container><table class=data-table><thead><tr></tr></thead><tbody>"),$f=S("<th>"),Cf=S("<tr>"),kf=S("<td>"),Tf=S('<div class=save-requirements><div class=requirements-header>❗ 保存要求检查：</div><div class=requirements-list><div class=requirement-item>数据源名称: <!> "<!>"</div><div class=requirement-item>自定义SQL: <!> </div><div class=requirement-item>测试连接: <!> </div><div class=requirement-item>保存状态: </div></div><div class=requirements-note>'),Ef=S("<div class=result-details><div class=detail-item><span class=detail-label>数据源ID:</span><span class=detail-value>"),Pf=S("<div class=result-warnings>"),Af=S("<div class=result-errors>"),Rf=S("<div class=save-requirements><h6>保存前需要完成:</h6><ul><li>填写数据源名称</li><li>确保SQL查询有效</li><li>通过基本验证检查"),Lf=S("<div class=save-section><div class=section-header><h5>💾 保存数据源</h5><button>"),Mf=S("<div class=warning-item>⚠️ "),Df=S("<div class=error-item>❌ ");const Of={database_type:"mysql",host:"localhost",port:3306,database:"",username:"",password:"",ssl_enabled:!1,max_connections:10,min_connections:1,connection_timeout:30,idle_timeout:600,sql:"",use_custom_sql:!1,query_timeout:60,default_limit:1e3,enable_caching:!0,cache_ttl:300};function If(n){const[e,t]=K({currentStep:"connection",name:"",description:"",tags:[],config:{...Of},schema:null,selectedTables:[],generatedSQL:"",customSQL:"",useCustomSQL:!1,testResult:null,queryResult:null,validation:null,dataSourceValidation:null,dataPreview:null,loading:!1,errors:[],isSaving:!1,saveResult:null}),i=Me(()=>{const v=e();return{connection:v.testResult?.success||!1,schema:v.schema!==null&&v.selectedTables.length>0,query:v.customSQL.trim().length>0,preview:v.name.trim().length>0&&v.customSQL.trim().length>0}}),s=v=>{t(h=>({...h,...v}))},r=v=>{t(h=>({...h,config:{...h.config,...v}}))},a=async()=>{s({loading:!0,errors:[]});try{const v=await Re.testDatabaseConnection(e().config);s({testResult:v,loading:!1,errors:v.success?[]:[v.message]}),v.success&&setTimeout(()=>{s({currentStep:"schema"}),l()},1e3)}catch(v){s({loading:!1,errors:[`连接测试失败: ${v}`],testResult:{success:!1,message:String(v)}})}},l=async()=>{s({loading:!0,errors:[]});try{const v=await Re.loadDatabaseSchema(e().config);s({schema:v,loading:!1,errors:[]})}catch(v){s({loading:!1,errors:[`架构加载失败: ${v}`],schema:null})}},o=async()=>{s({loading:!0,errors:[]});try{const v={name:e().name,config:e().config,selected_tables:e().selectedTables,sql:e().customSQL,description:e().description,tags:e().tags,validate_before_save:!0},h=await Re.validateDataSourceBeforeSave(v);return s({dataSourceValidation:h,loading:!1,errors:h.errors}),h}catch(v){return s({loading:!1,errors:[`验证失败: ${v}`]}),null}},c=async()=>{s({loading:!0,errors:[]});try{const v=await Re.captureDataPreview(e().config,e().customSQL);return s({dataPreview:v,loading:!1}),v}catch(v){return s({loading:!1,errors:[`数据预览失败: ${v}`]}),null}},d=async()=>{s({isSaving:!0,errors:[]});try{console.log("🔍 DatabaseWizard 保存前状态:",{selectedTables:e().selectedTables,selectedTables_type:typeof e().selectedTables,selectedTables_length:e().selectedTables?.length,customSQL_length:e().customSQL?.length,name:e().name});const v={name:e().name,config:e().config,selected_tables:e().selectedTables,sql:e().customSQL,description:e().description,tags:e().tags,validate_before_save:!0,capture_schema_snapshot:!0,capture_data_preview:!0,preview_row_limit:10};console.log("🔍 构建的 SaveDataSourceRequest:",{selected_tables:v.selected_tables,selected_tables_type:typeof v.selected_tables,selected_tables_length:v.selected_tables?.length});const h=await Re.saveDataSource(v);return s({saveResult:h,isSaving:!1}),h.success&&setTimeout(()=>{n.onSuccess()},2e3),h}catch(v){return s({isSaving:!1,errors:[`保存失败: ${v}`]}),null}},u=v=>{s({currentStep:v})},g=()=>{switch(e().currentStep){case"schema":s({currentStep:"connection"});break;case"query":s({currentStep:"schema"});break;case"preview":s({currentStep:"query"});break;default:n.onBack()}};return(()=>{var v=qg(),h=v.firstChild,p=h.firstChild,b=h.nextSibling,m=b.firstChild,y=m.nextSibling,$=y.nextSibling,x=$.nextSibling,w=b.nextSibling,P=w.nextSibling,L=P.firstChild,D=L.firstChild,z=D.nextSibling;return p.$$click=g,m.$$click=()=>u("connection"),y.$$click=()=>i().connection&&u("schema"),$.$$click=()=>i().schema&&u("query"),x.$$click=()=>i().query&&u("preview"),f(w,_(W,{get when(){return e().errors.length>0},get children(){var E=Mg();return f(E,_(pe,{get each(){return e().errors},children:R=>(()=>{var k=Wg();return k.firstChild,f(k,R,null),k})()})),E}}),null),f(w,_(W,{get when(){return e().loading},get children(){return Dg()}}),null),f(w,_(W,{get when(){return e().currentStep==="connection"},get children(){var E=Fg(),R=E.firstChild,k=R.nextSibling,q=k.firstChild,N=q.firstChild,C=N.nextSibling,A=q.nextSibling,X=A.firstChild;return C.addEventListener("change",G=>{const O=G.currentTarget.value,V={mysql:3306,postgresql:5432,sqlserver:1433,oracle:1521,sqlite:0}[O];r({database_type:O,port:V})}),f(k,_(W,{get when(){return e().config.database_type!=="sqlite"},get children(){var G=Og(),O=G.firstChild,V=O.firstChild,B=V.nextSibling,H=O.nextSibling,j=H.firstChild,de=j.nextSibling;return B.addEventListener("change",me=>r({host:me.currentTarget.value})),de.addEventListener("change",me=>r({port:parseInt(me.currentTarget.value)||3306})),F(()=>B.value=e().config.host),F(()=>de.value=e().config.port),G}}),A),f(k,_(W,{get when(){return e().config.database_type==="sqlite"},get children(){var G=Ig(),O=G.firstChild,V=O.nextSibling;return V.addEventListener("change",B=>r({database:B.currentTarget.value})),F(()=>V.value=e().config.database),G}}),A),f(k,_(W,{get when(){return e().config.database_type!=="sqlite"},get children(){return[(()=>{var G=Ng(),O=G.firstChild,V=O.nextSibling;return V.addEventListener("change",B=>r({database:B.currentTarget.value})),F(()=>V.value=e().config.database),G})(),(()=>{var G=zg(),O=G.firstChild,V=O.firstChild,B=V.nextSibling,H=O.nextSibling,j=H.firstChild,de=j.nextSibling;return B.addEventListener("change",me=>r({username:me.currentTarget.value})),de.addEventListener("change",me=>r({password:me.currentTarget.value})),F(()=>B.value=e().config.username),F(()=>de.value=e().config.password),G})()]}}),A),X.$$click=a,f(X,()=>e().loading?"⏳ 测试中...":"🔗 测试连接"),f(A,_(W,{get when(){return e().testResult},get children(){var G=Fr(),O=G.firstChild,V=O.firstChild,B=V.nextSibling;return f(V,()=>e().testResult?.success?"✅":"❌"),f(B,()=>e().testResult?.message),F(()=>Se(G,`test-result ${e().testResult?.success?"success":"error"}`)),G}}),null),F(()=>X.disabled=e().loading),F(()=>C.value=e().config.database_type),E}}),null),f(w,_(W,{get when(){return e().currentStep==="schema"},get children(){var E=Hg();return E.firstChild,f(E,_(W,{get when(){return $e(()=>!e().schema)()&&!e().loading},get children(){var R=Gg(),k=R.firstChild;return k.$$click=l,R}}),null),f(E,_(W,{get when(){return e().schema},get children(){var R=Ug(),k=R.firstChild,q=k.firstChild,N=q.firstChild,C=N.nextSibling,A=q.nextSibling,X=A.firstChild,G=X.nextSibling,O=A.nextSibling,V=O.firstChild,B=V.nextSibling,H=O.nextSibling,j=H.firstChild,de=j.nextSibling,me=k.nextSibling,fe=me.firstChild,ee=fe.nextSibling;return f(C,()=>e().schema?.database_name),f(G,()=>e().schema?.schemas[0]?.tables?.length||0),f(B,()=>e().schema?.schemas[0]?.views?.length||0),f(de,()=>new Date(e().schema?.loaded_at||"").toLocaleString("zh-CN")),f(ee,_(pe,{get each(){return e().schema?.schemas[0]?.tables||[]},children:oe=>_(Nf,{table:oe,get selected(){return e().selectedTables.includes(oe.name)},onToggle:(ge,he)=>{const te=e().selectedTables;s(he?{selectedTables:[...te,ge]}:{selectedTables:te.filter(ne=>ne!==ge)})}})})),f(R,_(W,{get when(){return $e(()=>!!e().schema?.schemas[0]?.views)()&&e().schema.schemas[0].views.length>0},get children(){var oe=Bg(),ge=oe.firstChild,he=ge.nextSibling;return f(he,_(pe,{get each(){return e().schema?.schemas[0]?.views||[]},children:te=>(()=>{var ne=Yg(),ve=ne.firstChild,be=ve.firstChild,ke=be.nextSibling;return f(be,()=>te.name),f(ke,()=>te.schema),f(ne,_(W,{get when(){return te.comment},get children(){var _e=jg();return f(_e,()=>te.comment),_e}}),null),ne})()})),oe}}),null),R}}),null),E}}),null),f(w,_(W,{get when(){return e().currentStep==="query"},get children(){return _(Lg,{get selectedTables(){return e().selectedTables},get schema(){return e().schema},get config(){return e().config},get sql(){return e().customSQL},onSQLChange:E=>s({customSQL:E}),onQueryResult:E=>s({queryResult:E}),onValidationChange:E=>s({validation:E})})}}),null),f(w,_(W,{get when(){return e().currentStep==="preview"},get children(){return _(zf,{get state(){return e()},onStateUpdate:s,onSave:d,onValidate:o,onPreviewData:c})}}),null),D.$$click=g,z.$$click=()=>{const E=e();E.currentStep==="connection"&&E.testResult?.success?(s({currentStep:"schema"}),E.schema||l()):E.currentStep==="schema"?s({currentStep:"query"}):E.currentStep==="query"&&s({currentStep:"preview"})},F(E=>{var R=`progress-step ${e().currentStep==="connection"?"active":""} ${i().connection?"completed":""}`,k=`progress-step ${e().currentStep==="schema"?"active":""} ${i().schema?"completed":""}`,q=`progress-step ${e().currentStep==="query"?"active":""} ${i().query?"completed":""}`,N=`progress-step ${e().currentStep==="preview"?"active":""} ${i().preview?"completed":""}`,C=e().loading;return R!==E.e&&Se(m,E.e=R),k!==E.t&&Se(y,E.t=k),q!==E.a&&Se($,E.a=q),N!==E.o&&Se(x,E.o=N),C!==E.i&&(z.disabled=E.i=C),E},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),v})()}function Nf(n){const e=i=>i<1e3?i.toString():i<1e6?`${(i/1e3).toFixed(1)}K`:`${(i/1e6).toFixed(1)}M`,t=i=>{const s=i.toLowerCase();return s.includes("int")||s.includes("number")||s.includes("decimal")?"🔢":s.includes("varchar")||s.includes("text")||s.includes("char")?"📝":s.includes("date")||s.includes("time")?"📅":s.includes("bool")?"✅":"📋"};return(()=>{var i=ef(),s=i.firstChild,r=s.firstChild,a=r.firstChild,l=a.firstChild,o=l.nextSibling;o.firstChild;var c=r.nextSibling,d=c.firstChild,u=d.firstChild,g=d.nextSibling,v=s.nextSibling,h=v.firstChild,p=h.firstChild,b=p.nextSibling;b.nextSibling;var m=h.nextSibling;return l.addEventListener("change",y=>n.onToggle(n.table.name,y.currentTarget.checked)),f(o,()=>n.table.name,null),f(d,()=>e(n.table.row_count_estimate),u),f(g,()=>n.table.size_estimate),f(i,_(W,{get when(){return n.table.comment},get children(){var y=Vg();return f(y,()=>n.table.comment),y}}),v),f(h,()=>n.table.columns?.length||0,b),f(m,_(pe,{get each(){return(n.table.columns||[]).slice(0,6)},children:y=>(()=>{var $=sf(),x=$.firstChild,w=x.nextSibling,P=w.nextSibling;return f(x,()=>t(y.data_type)),f(w,()=>y.name),f(P,()=>y.data_type),f($,_(W,{get when(){return y.is_primary_key},get children(){return tf()}}),null),f($,_(W,{get when(){return y.is_foreign_key},get children(){return nf()}}),null),$})()}),null),f(m,_(W,{get when(){return(n.table.columns?.length||0)>6},get children(){var y=Xg(),$=y.firstChild,x=$.nextSibling;return x.nextSibling,f(y,()=>(n.table.columns?.length||0)-6,x),y}}),null),f(i,_(W,{get when(){return n.table.indexes&&n.table.indexes.length>0},get children(){var y=Jg(),$=y.firstChild,x=$.firstChild,w=x.nextSibling;w.nextSibling;var P=$.nextSibling;return f($,()=>n.table.indexes.length,w),f(P,_(pe,{get each(){return n.table.indexes.slice(0,3)},children:L=>(()=>{var D=rf(),z=D.firstChild;return f(D,()=>L.unique?"🔐":"📇",z),f(D,()=>L.name,null),F(E=>{var R=`index-badge ${L.unique?"unique":""}`,k=L.columns.join(", ");return R!==E.e&&Se(D,E.e=R),k!==E.t&&Q(D,"title",E.t=k),E},{e:void 0,t:void 0}),D})()}),null),f(P,_(W,{get when(){return n.table.indexes.length>3},get children(){var L=Qg();return L.firstChild,f(L,()=>n.table.indexes.length-3,null),L}}),null),y}}),null),f(i,_(W,{get when(){return n.table.foreign_keys&&n.table.foreign_keys.length>0},get children(){var y=Zg(),$=y.firstChild,x=$.firstChild,w=x.nextSibling;w.nextSibling;var P=$.nextSibling;return f($,()=>n.table.foreign_keys.length,w),f(P,_(pe,{get each(){return n.table.foreign_keys.slice(0,2)},children:L=>(()=>{var D=af();return D.firstChild,f(D,()=>L.referenced_table,null),F(()=>Q(D,"title",`${L.column_name} → ${L.referenced_table}.${L.referenced_column}`)),D})()}),null),f(P,_(W,{get when(){return n.table.foreign_keys.length>2},get children(){var L=Kg();return L.firstChild,f(L,()=>n.table.foreign_keys.length-2,null),L}}),null),y}}),null),F(()=>Se(i,`table-card ${n.selected?"selected":""}`)),F(()=>l.checked=n.selected),i})()}function zf(n){return(()=>{var e=lf(),t=e.firstChild,i=t.nextSibling,s=i.firstChild,r=s.nextSibling,a=r.firstChild,l=a.firstChild,o=l.nextSibling,c=a.nextSibling,d=c.firstChild,u=d.nextSibling,g=r.nextSibling,v=g.firstChild,h=v.nextSibling;return o.$$input=p=>n.onStateUpdate({name:p.currentTarget.value}),u.$$input=p=>{const b=p.currentTarget.value.split(",").map(m=>m.trim()).filter(m=>m);n.onStateUpdate({tags:b})},h.$$input=p=>n.onStateUpdate({description:p.currentTarget.value}),f(e,_(Ff,{get state(){return n.state}}),null),f(e,_(Gf,{get validation(){return n.state.dataSourceValidation},get onValidate(){return n.onValidate},get loading(){return n.state.loading}}),null),f(e,_(Bf,{get preview(){return n.state.dataPreview},get onPreviewData(){return n.onPreviewData},get loading(){return n.state.loading}}),null),f(e,_(Hf,{get state(){return n.state},get saveResult(){return n.state.saveResult},get onSave(){return n.onSave},get isSaving(){return n.state.isSaving},get canSave(){return qf(n.state)}}),null),F(()=>o.value=n.state.name),F(()=>u.value=n.state.tags.join(", ")),F(()=>h.value=n.state.description),e})()}function Ff(n){return(()=>{var e=of(),t=e.firstChild,i=t.nextSibling,s=i.firstChild,r=s.firstChild,a=r.nextSibling,l=s.nextSibling,o=l.firstChild,c=o.nextSibling,d=c.firstChild,u=l.nextSibling,g=u.firstChild,v=g.nextSibling,h=u.nextSibling,p=h.firstChild,b=p.nextSibling,m=h.nextSibling,y=m.firstChild,$=y.nextSibling,x=$.firstChild,w=m.nextSibling,P=w.firstChild,L=P.nextSibling,D=L.firstChild,z=i.nextSibling,E=z.firstChild,R=E.nextSibling;return f(a,()=>n.state.config.database_type.toUpperCase()),f(c,()=>n.state.config.host,d),f(c,()=>n.state.config.port,null),f(v,()=>n.state.config.database),f(b,()=>n.state.config.username),f($,()=>n.state.selectedTables.length,x),f(L,()=>n.state.customSQL.length,D),f(R,()=>n.state.customSQL.slice(0,200),null),f(R,()=>n.state.customSQL.length>200?"...":"",null),e})()}function Gf(n){return(()=>{var e=gf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(s,"click",n.onValidate),f(s,()=>n.loading?"⏳ 验证中...":"🔍 开始验证"),f(e,_(W,{get when(){return n.validation},get children(){var r=uf(),a=r.firstChild;return f(a,_(On,{label:"数据库连接",get status(){return n.validation?.connection_valid?"success":"error"},get icon(){return n.validation?.connection_valid?"✅":"❌"}}),null),f(a,_(On,{label:"SQL语法",get status(){return n.validation?.sql_valid?"success":"error"},get icon(){return n.validation?.sql_valid?"✅":"❌"}}),null),f(a,_(On,{label:"安全检查",get status(){return n.validation?.security_passed?"success":"warning"},get icon(){return n.validation?.security_passed?"✅":"⚠️"}}),null),f(a,_(On,{label:"性能评估",get status(){return n.validation?.performance_acceptable?"success":"info"},get icon(){return n.validation?.performance_acceptable?"✅":"ℹ️"}}),null),f(r,_(W,{get when(){return n.validation&&n.validation.warnings.length>0},get children(){var l=cf();return l.firstChild,f(l,_(pe,{get each(){return n.validation.warnings||[]},children:o=>(()=>{var c=ff();return f(c,o),c})()}),null),l}}),null),f(r,_(W,{get when(){return n.validation&&n.validation.errors.length>0},get children(){var l=df();return l.firstChild,f(l,_(pe,{get each(){return n.validation.errors||[]},children:o=>(()=>{var c=vf();return f(c,o),c})()}),null),l}}),null),f(r,_(W,{get when(){return n.validation&&n.validation.suggestions&&n.validation.suggestions.length>0},get children(){var l=hf();return l.firstChild,f(l,_(pe,{get each(){return n.validation.suggestions||[]},children:o=>(()=>{var c=pf();return f(c,o),c})()}),null),l}}),null),r}}),null),F(()=>s.disabled=n.loading),e})()}function On(n){return(()=>{var e=mf(),t=e.firstChild,i=t.nextSibling,s=i.nextSibling;return f(t,()=>n.icon),f(i,()=>n.label),f(s,()=>n.status==="success"?"通过":n.status==="error"?"失败":n.status==="warning"?"警告":"信息"),F(r=>{var a=`validation-check ${n.status}`,l=`check-status ${n.status}`;return a!==r.e&&Se(e,r.e=a),l!==r.t&&Se(s,r.t=l),r},{e:void 0,t:void 0}),e})()}function Bf(n){return(()=>{var e=_f(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(s,"click",n.onPreviewData),f(s,()=>n.loading?"⏳ 加载中...":"👁️ 预览数据"),f(e,_(W,{get when(){return n.preview},get children(){var r=yf(),a=r.firstChild,l=a.firstChild,o=l.firstChild,c=o.nextSibling,d=l.nextSibling,u=d.firstChild,g=u.nextSibling,v=d.nextSibling,h=v.firstChild,p=h.nextSibling,b=p.firstChild,m=a.nextSibling;return f(c,()=>n.preview?.sample_data.length||0),f(g,()=>n.preview?.total_estimated_rows.toLocaleString()||"未知"),f(p,()=>n.preview?.execution_stats.execution_time||0,b),f(m,_(W,{get when(){return n.preview&&n.preview.sample_data.length>0},get children(){return _(Uf,{get data(){return n.preview.sample_data||[]}})}}),null),f(m,_(W,{get when(){return!n.preview||n.preview.sample_data.length===0},get children(){return bf()}}),null),r}}),null),F(()=>s.disabled=n.loading),e})()}function Uf(n){if(!n.data||n.data.length===0)return xf();const e=Object.keys(n.data[0]);return(()=>{var t=wf(),i=t.firstChild,s=i.firstChild,r=s.firstChild,a=s.nextSibling;return f(r,_(pe,{each:e,children:l=>(()=>{var o=$f();return f(o,l),o})()})),f(a,_(pe,{get each(){return n.data.slice(0,10)},children:l=>(()=>{var o=Cf();return f(o,_(pe,{each:e,children:c=>(()=>{var d=kf();return f(d,()=>Wf(l[c])),d})()})),o})()})),f(t,_(W,{get when(){return n.data.length>10},get children(){var l=Sf(),o=l.firstChild,c=o.nextSibling;return c.nextSibling,f(l,()=>n.data.length,c),l}}),null),t})()}function Hf(n){return(()=>{var e=Lf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Ae(s,"click",n.onSave),f(s,()=>n.isSaving?"💾 保存中...":"💾 保存数据源"),f(e,_(W,{get when(){return!n.canSave&&!n.isSaving},get children(){var r=Tf(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.firstChild,d=c.nextSibling,u=d.nextSibling,g=u.nextSibling;g.nextSibling;var v=o.nextSibling,h=v.firstChild,p=h.nextSibling;p.nextSibling;var b=v.nextSibling,m=b.firstChild,y=m.nextSibling;y.nextSibling;var $=b.nextSibling;$.firstChild;var x=l.nextSibling;return f(o,()=>n.state.name?"✅":"❌",d),f(o,()=>n.state.name,g),f(v,()=>n.state.customSQL?"✅":"❌",p),f(v,()=>n.state.customSQL?`(${n.state.customSQL.length} 字符)`:"(空)",null),f(b,()=>n.state.testResult?.success?"✅":"❌",y),f(b,()=>n.state.testResult?.success?"成功":n.state.testResult?`失败: ${n.state.testResult.message}`:"未测试",null),f($,()=>n.isSaving?"❌ 正在保存中":"✅ 空闲",null),f(x,()=>n.state.testResult?.success?"所有条件都已满足，但按钮仍然禁用。这可能是一个bug。":"请返回第1步完成连接测试，然后才能保存数据源。"),r}}),null),f(e,_(W,{get when(){return n.saveResult},get children(){var r=Fr(),a=r.firstChild,l=a.firstChild,o=l.nextSibling;return f(l,()=>n.saveResult?.success?"✅":"❌"),f(o,()=>n.saveResult?.message),f(r,_(W,{get when(){return n.saveResult?.success&&n.saveResult.data_source_id},get children(){var c=Ef(),d=c.firstChild,u=d.firstChild,g=u.nextSibling;return f(g,()=>n.saveResult.data_source_id),c}}),null),f(r,_(W,{get when(){return n.saveResult&&n.saveResult.warnings&&n.saveResult.warnings.length>0},get children(){var c=Pf();return f(c,_(pe,{get each(){return n.saveResult.warnings||[]},children:d=>(()=>{var u=Mf();return u.firstChild,f(u,d,null),u})()})),c}}),null),f(r,_(W,{get when(){return n.saveResult&&n.saveResult.errors&&n.saveResult.errors.length>0},get children(){var c=Af();return f(c,_(pe,{get each(){return n.saveResult.errors||[]},children:d=>(()=>{var u=Df();return u.firstChild,f(u,d,null),u})()})),c}}),null),F(()=>Se(r,`save-result ${n.saveResult?.success?"success":"error"}`)),r}}),null),f(e,_(W,{get when(){return!n.canSave},get children(){return Rf()}}),null),F(r=>{var a=`save-btn ${n.canSave?"primary":"disabled"}`,l=n.isSaving||!n.canSave;return a!==r.e&&Se(s,r.e=a),l!==r.t&&(s.disabled=r.t=l),r},{e:void 0,t:void 0}),e})()}function qf(n){const e=n.name.trim().length>0,t=n.customSQL.trim().length>0,i=n.testResult?.success,s=!n.isSaving;return console.log("🔍 保存条件检查:",{hasName:e,hasSQL:t,hasSuccessfulTest:i,notSaving:s,testResult:n.testResult,name:n.name,sql:n.customSQL}),!!(e&&t&&i&&s)}function Wf(n){return n==null?"(null)":typeof n=="string"&&n.length>50?n.substring(0,47)+"...":String(n)}Ue(["click","input"]);var jf=S("<input type=text class=search-input placeholder=搜索数据源...>"),Yf=S("<div class=add-buttons-group><button class=add-data-source-btn>📄 文件数据源</button><button class=add-database-source-btn>🗄️ 数据库数据源"),Vf=S("<div class=error-message>"),Xf=S("<div class=loading-message>加载中..."),Qf=S("<div class=empty-state><p></p><button>添加第一个数据源"),Jf=S("<div class=data-source-grid>"),Kf=S("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),Zf=S("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),e0=S("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),t0=S("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),n0=S("<li><button> <!> (<!>)"),i0=S("<th>"),s0=S("<tr>"),r0=S("<td>"),a0=S("<span class=active-badge title=当前激活>当前"),l0=S('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function o0(n){console.log("🏗️  DataSourceManagementCenter 组件渲染，isOpen:",n.isOpen);const[e,t]=K([]),[i,s]=K([]),[r,a]=K("main"),[l,o]=K(null),[c,d]=K(null),[u,g]=K(!1),[v,h]=K(null),[p,b]=K(null),[m,y]=K(""),[$,x]=K("all"),[w,P]=K("all");Qe(async()=>{try{await L(),await D();const B=Ze.subscribe(H=>{b(H?.dataSource.id||null)});b(Ze.getCurrentContext()?.dataSource.id||null),dt(B)}catch(B){console.error("🚨 数据源管理中心初始化失败:",B),h(`初始化失败: ${B}`)}});const L=async()=>{try{g(!0),console.log("🔄 加载数据源列表...");const B=await Re.listDataSources();console.log("✅ 数据源列表加载成功:",B),t(B),h(null)}catch(B){console.error("❌ 加载数据源失败:",B),h(`加载数据源失败: ${B}`)}finally{g(!1)}},D=async()=>{try{console.log("🔄 加载可用数据源类型...");const B=await Re.getAvailableTypes();console.log("✅ 数据源类型加载成功:",B),s(B)}catch(B){console.error("❌ 加载数据源类型失败:",B)}},z=B=>{const H=(B.providerType||"").toLowerCase();return H.includes("database_mysql")?"mysql":H.includes("database_postgresql")?"postgresql":H.includes("database")?"database":H.includes("json")?"json":H.includes("csv")?"csv":H.includes("excel")?"excel":H.includes("api")?"api":H||"unknown"},E=()=>{let B=e();if(m()){const H=m().toLowerCase();B=B.filter(j=>(j.name||"").toLowerCase().includes(H)||z(j).includes(H))}return $()!=="all"&&(B=B.filter(H=>H.status===$())),w()!=="all"&&(B=B.filter(H=>z(H)===w())),B},R=B=>e().filter(H=>H.status===B).length,k=B=>e().filter(H=>z(H)===B).length,q=()=>{a("add"),o(null)},N=()=>{a("add-database"),o(null)},C=B=>{o(B),a("edit")},A=async B=>{try{g(!0),h(null),o(B),console.log("🔄 开始预览数据源:",B.name);const H=await Re.getPreview(B.id);d(H),a("preview"),console.log("✅ 数据预览加载成功:",H)}catch(H){console.error("❌ 数据预览失败:",H),h(`预览数据源 "${B.name}" 失败: ${H}`)}finally{g(!1)}},X=async B=>{try{g(!0),await Ze.setActiveDataSource(B.id)}catch(H){console.error("❌ 激活数据源失败:",H),h(`激活数据源失败: ${H}`)}finally{g(!1)}},G=async B=>{try{g(!0);const H=e().find(de=>de.id===B);if(!H){h(`数据源不存在: ${B}`);return}const j=await Re.testConnection(H.providerType||H.provider_type,H.config||{});alert(j?`✅ 数据源 "${H.name}" 连接测试成功！`:`❌ 数据源 "${H.name}" 连接测试失败`)}catch(H){console.error("❌ 测试连接失败:",H);const j=e().find(de=>de.id===B);alert(`❌ 数据源 "${j?.name||B}" 连接测试失败:
${H}`)}finally{g(!1)}},O=async B=>{const H=e().find(j=>j.id===B);if(confirm(`确定要删除数据源 "${H?.name}" 吗？`))try{await Re.deleteDataSource(B),await L()}catch(j){h(`删除数据源失败: ${j}`)}},V=()=>{a("main"),o(null),d(null),h(null)};return _(W,{get when(){return n.isOpen},get children(){var B=t0(),H=B.firstChild,j=H.firstChild,de=j.nextSibling,me=de.nextSibling,fe=H.nextSibling;return Ae(j,"click",n.onClose),f(me,_(W,{get when(){return r()==="main"},get children(){return[(()=>{var ee=jf();return ee.$$input=oe=>y(oe.currentTarget.value),F(()=>ee.value=m()),ee})(),(()=>{var ee=Yf(),oe=ee.firstChild,ge=oe.nextSibling;return oe.$$click=q,ge.$$click=N,ee})()]}})),f(fe,_(W,{get when(){return r()==="main"},get children(){var ee=Kf(),oe=ee.firstChild,ge=oe.firstChild,he=ge.firstChild,te=he.nextSibling,ne=te.firstChild,ve=ne.firstChild,be=ve.firstChild,ke=be.nextSibling;ke.nextSibling;var _e=ge.nextSibling,Pe=_e.firstChild,ue=Pe.nextSibling,xe=ue.firstChild,M=xe.firstChild,I=M.firstChild,J=I.nextSibling;J.nextSibling;var Y=xe.nextSibling,ie=Y.firstChild,ce=ie.firstChild,ae=ce.nextSibling;ae.nextSibling;var Ce=Y.nextSibling,Ie=Ce.firstChild,Te=Ie.firstChild,Ye=Te.nextSibling;Ye.nextSibling;var We=_e.nextSibling,ot=We.firstChild,Pt=ot.nextSibling,at=Pt.firstChild,Gr=at.firstChild,Sn=oe.nextSibling;return ve.$$click=()=>x("all"),f(ve,()=>e().length,ke),M.$$click=()=>x("active"),f(M,()=>R("active"),J),ie.$$click=()=>x("error"),f(ie,()=>R("error"),ae),Ie.$$click=()=>x("disabled"),f(Ie,()=>R("disabled"),Ye),Gr.$$click=()=>P("all"),f(Pt,_(pe,{get each(){return i()},children:De=>(()=>{var je=n0(),ct=je.firstChild,Kt=ct.firstChild,Zt=Kt.nextSibling,wn=Zt.nextSibling,zi=wn.nextSibling;return zi.nextSibling,ct.$$click=()=>P(De.typeName),f(ct,()=>De.category==="file"?"📄":De.category==="api"?"🌐":De.category==="database"?"🗄️":"📊",Kt),f(ct,()=>De.displayName,Zt),f(ct,()=>k(De.typeName),zi),F(()=>Se(je,w()===De.typeName?"active":"")),je})()}),null),f(Sn,_(W,{get when(){return v()},get children(){var De=Vf();return f(De,v),De}}),null),f(Sn,_(W,{get when(){return u()},get children(){return Xf()}}),null),f(Sn,_(W,{get when(){return $e(()=>!u())()&&E().length===0},get children(){var De=Qf(),je=De.firstChild,ct=je.nextSibling;return f(je,()=>m()||$()!=="all"||w()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),ct.$$click=q,De}}),null),f(Sn,_(W,{get when(){return $e(()=>!u())()&&E().length>0},get children(){var De=Jf();return f(De,_(pe,{get each(){return E()},children:je=>_(c0,{source:je,onPreview:()=>A(je),onTest:()=>G(je.id),onEdit:()=>C(je),onDelete:()=>O(je.id),onActivate:()=>X(je),get active(){return p()===je.id}})})),De}}),null),F(De=>{var je=$()==="all"?"active":"",ct=$()==="active"?"active":"",Kt=$()==="error"?"active":"",Zt=$()==="disabled"?"active":"",wn=w()==="all"?"active":"";return je!==De.e&&Se(ne,De.e=je),ct!==De.t&&Se(xe,De.t=ct),Kt!==De.a&&Se(Y,De.a=Kt),Zt!==De.o&&Se(Ce,De.o=Zt),wn!==De.i&&Se(at,De.i=wn),De},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ee}}),null),f(fe,_(W,{get when(){return r()==="add"},get children(){return _(zr,{get availableTypes(){return i()},onBack:V,onSuccess:()=>{L(),V()}})}}),null),f(fe,_(W,{get when(){return r()==="add-database"},get children(){return _(If,{onBack:V,onSuccess:()=>{L(),V()}})}}),null),f(fe,_(W,{get when(){return $e(()=>r()==="edit")()&&l()},get children(){var ee=Zf(),oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling;return he.firstChild,ge.$$click=V,f(he,()=>l()?.name,null),ee}}),null),f(fe,_(W,{get when(){return $e(()=>!!(r()==="preview"&&l()))()&&c()},get children(){var ee=e0(),oe=ee.firstChild,ge=oe.firstChild,he=ge.nextSibling;he.firstChild;var te=he.nextSibling,ne=te.firstChild,ve=ne.nextSibling,be=ve.nextSibling,ke=be.nextSibling;ke.nextSibling;var _e=oe.nextSibling,Pe=_e.firstChild,ue=Pe.firstChild,xe=ue.firstChild,M=ue.nextSibling;return ge.$$click=V,f(he,()=>l()?.name,null),f(te,()=>c()?.totalCount??c()?.total_rows,ve),f(te,()=>c()?.rows.length,ke),f(xe,_(pe,{get each(){return c()?.columns},children:I=>(()=>{var J=i0();return f(J,I),J})()})),f(M,_(pe,{get each(){return c()?.rows.slice(0,50)},children:I=>(()=>{var J=s0();return f(J,_(pe,{get each(){return c()?.columns||[]},children:Y=>(()=>{var ie=r0();return f(ie,(()=>{var ce=$e(()=>typeof I[Y]=="object");return()=>ce()?JSON.stringify(I[Y]):String(I[Y]||"")})()),ie})()})),J})()})),ee}}),null),B}})}function c0(n){const e=a=>{switch(a){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},t=a=>{switch(a){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},i=a=>{const l=new Date,o=new Date(a),c=l.getTime()-o.getTime(),d=Math.floor(c/(1e3*60*60));return d<1?"刚刚更新":d<24?`${d}小时前`:o.toLocaleDateString("zh-CN")},s=a=>{const l=(a||"").toLowerCase();return l.includes("json")?"📄":l.includes("api")?"🌐":l.includes("csv")?"📊":l.includes("database")?"🗄️":"📋"},r=a=>{const l=(a.providerType||a.provider_type||"").toLowerCase();return l.includes("database_mysql")?"MySQL":l.includes("database_postgresql")?"PostgreSQL":l==="json"?"JSON":l==="csv"?"CSV":l==="excel"?"Excel":l.startsWith("api")?"API":l.startsWith("database")?"Database":a.providerType||a.provider_type||"Unknown"};return(()=>{var a=l0(),l=a.firstChild,o=l.firstChild,c=o.firstChild,d=c.nextSibling,u=o.nextSibling,g=l.nextSibling,v=g.firstChild,h=v.firstChild,p=h.nextSibling,b=v.nextSibling,m=b.firstChild,y=m.nextSibling,$=b.nextSibling,x=$.firstChild,w=x.nextSibling,P=g.nextSibling,L=P.firstChild,D=L.nextSibling,z=D.nextSibling,E=z.nextSibling,R=E.nextSibling;return f(c,()=>s(n.source.providerType)),f(d,()=>n.source.name,null),f(d,_(W,{get when(){return n.active},get children(){return a0()}}),null),f(p,()=>r(n.source)),f(y,()=>t(n.source.status)),f(w,()=>i(n.source.lastUpdated)),Ae(L,"click",n.onPreview),Ae(D,"click",n.onTest),Ae(z,"click",n.onEdit),Ae(E,"click",n.onActivate),Ae(R,"click",n.onDelete),F(k=>{var q=n.active?"true":"false",N=e(n.source.status),C=`状态: ${t(n.source.status)}`,A=n.source.status!=="active",X=n.active;return q!==k.e&&Q(a,"data-active",k.e=q),N!==k.t&&((k.t=N)!=null?u.style.setProperty("background-color",N):u.style.removeProperty("background-color")),C!==k.a&&Q(u,"title",k.a=C),A!==k.o&&(L.disabled=k.o=A),X!==k.i&&(E.disabled=k.i=X),k},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),a})()}Ue(["click","input"]);function d0(n){return{id:n.id,type:h0(n.type),transform:{translate:{x:n.position.x,y:n.position.y},...n.scale&&{scale:{x:n.scale.x,y:n.scale.y}},...n.rotation!==void 0&&{rotate:n.rotation}},style:{width:n.size.width,height:n.size.height,fill:n.style?.fill_color,stroke:n.style?.border?.color,strokeWidth:n.style?.border?.width,opacity:n.style?.opacity},data:n.content,visible:n.visible,locked:n.locked}}function h0(n){return{Text:"text",Rectangle:"rect",Circle:"circle",Line:"path",Image:"image",DataField:"text"}[n]||"rect"}var u0=S('<div class="mb-6 p-4 bg-gray-50 rounded-lg"><h3 class="text-sm font-medium text-gray-700 mb-3">PDF 选项</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-gray-600 mb-1">页面大小</label><select class="w-full p-2 border border-gray-300 rounded text-sm"></select></div><div><label class="block text-xs text-gray-600 mb-1">方向</label><select class="w-full p-2 border border-gray-300 rounded text-sm"><option value=portrait>纵向</option><option value=landscape>横向'),g0=S('<div class="mb-6 p-4 bg-gray-50 rounded-lg"><h3 class="text-sm font-medium text-gray-700 mb-3">图片选项</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-gray-600 mb-1">DPI (<!>)</label><input type=range min=72 max=300 step=1 class=w-full></div><div><label class="block text-xs text-gray-600 mb-1">压缩质量 (<!>%)</label><input type=range min=0.1 max=1 step=0.1 class=w-full>'),f0=S('<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">'),v0=S('<div class=mb-4><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full transition-all duration-300"></div></div><p class="text-sm text-gray-600 mt-1">导出中... <!>%'),p0=S('<div style=position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;display:flex;align-items:center;justify-content:center;><div style="position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(0, 0, 0, 0.5);"></div><div style="position:relative;background-color:white;border-radius:8px;box-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);padding:24px;width:500px;max-width:90vw;max-height:80vh;overflow-y:auto;"><h2 class="text-xl font-semibold mb-4">导出报表</h2><div class=mb-6><label class="block text-sm font-medium text-gray-700 mb-2">导出格式</label><div class="grid grid-cols-2 gap-2"></div></div><div class=mb-6><label class="block text-sm font-medium text-gray-700 mb-2">输出质量</label><select class="w-full p-2 border border-gray-300 rounded-lg"></select></div><div class="flex justify-end gap-3"><button class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">取消</button><button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">'),m0=S("<button><span class=text-lg></span><span class=text-sm>"),Es=S("<option>");const b0=n=>{const{state:e}=st(),[t,i]=K("pdf"),[s,r]=K("high"),[a,l]=K(!1),[o,c]=K(0),[d,u]=K(""),[g,v]=K("a4"),[h,p]=K("portrait"),[b,m]=K(150),[y,$]=K(.9),x=[{value:"pdf",label:"PDF 文档",icon:"📄"},{value:"png",label:"PNG 图片",icon:"🖼️"},{value:"jpg",label:"JPG 图片",icon:"🖼️"},{value:"svg",label:"SVG 矢量图",icon:"🎨"},{value:"excel",label:"Excel 表格",icon:"📊"}],w=[{value:"draft",label:"草稿"},{value:"standard",label:"标准"},{value:"high",label:"高质量"},{value:"print",label:"打印"}],P=[{value:"a4",label:"A4"},{value:"a3",label:"A3"},{value:"a5",label:"A5"},{value:"letter",label:"Letter"},{value:"legal",label:"Legal"}],L=async()=>{l(!0),u(""),c(0);try{const D={pdf:"pdf",png:"png",jpg:"jpg",webp:"webp",svg:"svg",excel:"xlsx",powerpoint:"pptx"},z=await Js({title:`导出为 ${t().toUpperCase()}`,defaultPath:`report.${D[t()]}`,filters:[{name:x.find(q=>q.value===t())?.label||"File",extensions:[D[t()]]}]});if(!z){l(!1);return}const E={format:t(),quality:s(),customProperties:{}};t()==="pdf"&&(E.pdfOptions={pageSize:g(),orientation:h(),margins:{top:20,right:20,bottom:20,left:20},embedFonts:!0,compressImages:!0,pdfVersion:"1.7"}),["png","jpg","webp"].includes(t())&&(E.imageQuality={dpi:b(),compression:y(),colorSpace:"srgb",antiAliasing:!0}),t()==="excel"&&(E.excelOptions={sheetName:"Report",includeFormatting:!0,autoFitColumns:!0,freezeHeader:!0,cellMappingStrategy:"position_based"});const R={elements:e.elements,canvasConfig:e.canvas_config,options:E,useCache:!0};if(c(30),!0){const q=e.elements.map(d0),N=await ye("export_with_skia",{elements:q,filePath:z,options:{format:t(),quality:t()==="jpg"?Math.round(y()*100):void 0,dpi:b(),width:e.canvas_config.width,height:e.canvas_config.height}});console.log("✅ Skia 导出成功:",N)}c(100),console.log("✅ 导出成功"),setTimeout(()=>{n.onClose(),l(!1),c(0)},500)}catch(D){console.error("❌ 导出失败:",D),u(D?.toString()||"导出失败"),l(!1),c(0)}};return _(W,{get when(){return n.isOpen},get children(){var D=p0(),z=D.firstChild,E=z.nextSibling,R=E.firstChild,k=R.nextSibling,q=k.firstChild,N=q.nextSibling,C=k.nextSibling,A=C.firstChild,X=A.nextSibling,G=C.nextSibling,O=G.firstChild,V=O.nextSibling;return Ae(z,"click",n.onClose),f(N,_(pe,{each:x,children:B=>(()=>{var H=m0(),j=H.firstChild,de=j.nextSibling;return H.$$click=()=>i(B.value),f(j,()=>B.icon),f(de,()=>B.label),F(()=>Se(H,`p-3 border rounded-lg flex items-center gap-2 transition-colors ${t()===B.value?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`)),H})()})),X.addEventListener("change",B=>r(B.target.value)),f(X,_(pe,{each:w,children:B=>(()=>{var H=Es();return f(H,()=>B.label),F(()=>H.value=B.value),H})()})),f(E,_(W,{get when(){return t()==="pdf"},get children(){var B=u0(),H=B.firstChild,j=H.nextSibling,de=j.firstChild,me=de.firstChild,fe=me.nextSibling,ee=de.nextSibling,oe=ee.firstChild,ge=oe.nextSibling;return fe.addEventListener("change",he=>v(he.target.value)),f(fe,_(pe,{each:P,children:he=>(()=>{var te=Es();return f(te,()=>he.label),F(()=>te.value=he.value),te})()})),ge.addEventListener("change",he=>p(he.target.value)),F(()=>fe.value=g()),F(()=>ge.value=h()),B}}),G),f(E,_(W,{get when(){return["png","jpg","webp"].includes(t())},get children(){var B=g0(),H=B.firstChild,j=H.nextSibling,de=j.firstChild,me=de.firstChild,fe=me.firstChild,ee=fe.nextSibling;ee.nextSibling;var oe=me.nextSibling,ge=de.nextSibling,he=ge.firstChild,te=he.firstChild,ne=te.nextSibling;ne.nextSibling;var ve=he.nextSibling;return f(me,b,ee),oe.addEventListener("change",be=>m(parseInt(be.target.value))),f(he,()=>Math.round(y()*100),ne),ve.addEventListener("change",be=>$(parseFloat(be.target.value))),F(()=>oe.value=b()),F(()=>ve.value=y()),B}}),G),f(E,_(W,{get when(){return d()},get children(){var B=f0();return f(B,d),B}}),G),f(E,_(W,{get when(){return a()},get children(){var B=v0(),H=B.firstChild,j=H.firstChild,de=H.nextSibling,me=de.firstChild,fe=me.nextSibling;return fe.nextSibling,f(de,o,fe),F(ee=>(ee=`${o()}%`)!=null?j.style.setProperty("width",ee):j.style.removeProperty("width")),B}}),G),Ae(O,"click",n.onClose),V.$$click=L,f(V,()=>a()?"导出中...":"导出"),F(B=>{var H=a(),j=a();return H!==B.e&&(O.disabled=B.e=H),j!==B.t&&(V.disabled=B.t=j),B},{e:void 0,t:void 0}),F(()=>X.value=s()),D}})};Ue(["click"]);var y0=S("<div class=flex-1>"),Ps=S('<div class="w-80 bg-primary border-r border-default flex flex-col">'),As=S('<div class="flex-1 flex flex-col bg-tertiary">'),_0=S('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">'),x0=S('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class="border-b border-default min-h-fit"></div><div class=min-h-fit>'),S0=S('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden">');const w0=()=>{const{state:n}=_n(),[e,t]=K(!1),[i,s]=K(!1),[r,a]=K(!1);console.log("🖥️  MainLayout渲染，当前模式:",n().mode);const l=()=>{console.log("🔄 数据源按钮被点击，准备打开管理中心"),console.log("📊 当前管理中心状态:",i()),s(!0),console.log("✅ 管理中心状态已设置为 true"),console.log("📊 设置后的管理中心状态:",i())},o=()=>t(!1),c=()=>s(!1),d=()=>{console.log("📤 打开导出对话框"),a(!0)},u=()=>{a(!1)};return(()=>{var g=S0(),v=g.firstChild;return f(g,_(Sa,{onOpenDataSources:l,onOpenExport:d}),v),f(v,_(Us,{get children(){return[_(St,{get when(){return n().mode==="preview"},get children(){var h=y0();return f(h,_(rh,{})),h}}),_(St,{get when(){return n().mode==="design"},get children(){return[(()=>{var h=Ps();return f(h,_(qi,{})),h})(),(()=>{var h=As();return f(h,_(Eo,{})),h})(),(()=>{var h=_0(),p=h.firstChild,b=p.firstChild,m=b.nextSibling;return f(b,_(Xi,{})),f(m,_(Ts,{})),h})()]}}),_(St,{get when(){return n().mode==="data"},get children(){return[(()=>{var h=Ps();return f(h,_(qi,{})),h})(),(()=>{var h=As();return f(h,_(_o,{})),h})(),(()=>{var h=x0(),p=h.firstChild,b=p.firstChild,m=b.nextSibling;return f(b,_(Ts,{})),f(m,_(Xi,{})),h})()]}})]}})),f(g,_(o0,{get isOpen(){return i()},onClose:c}),null),f(g,_(Nu,{get isOpen(){return e()},onClose:o}),null),f(g,_(b0,{get isOpen(){return r()},onClose:u}),null),g})()},$0=()=>_(ra,{get children(){return _(w0,{})}}),C0={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},k0=()=>{const{state:n,copySelectedElements:e,pasteElements:t,deleteElements:i,undo:s,redo:r,selectAllElements:a,clearSelection:l,moveElements:o}=st(),c=(h,p)=>{const b=h.key.toLowerCase()===p.key.toLowerCase()||h.key===p.key,m=!!p.ctrl===(h.ctrlKey||h.metaKey),y=!!p.alt===h.altKey,$=!!p.shift===h.shiftKey;return b&&m&&y&&$},d=async h=>{console.log("🎯 执行快捷键:",h);try{switch(h){case"copy":n.selected_ids.length>0&&(await e(),g("复制成功","✅"));break;case"paste":const p={x:20,y:20},b=await t(p.x,p.y);b.length>0&&g(`粘贴 ${b.length} 个元素`,"📋");break;case"cut":n.selected_ids.length>0&&(await e(),await i([...n.selected_ids]),g("剪切成功","✂️"));break;case"delete":if(n.selected_ids.length>0){const m=n.selected_ids.length;await i([...n.selected_ids]),g(`删除 ${m} 个元素`,"🗑️")}break;case"undo":await s(),g("撤销","↶");break;case"redo":await r(),g("重做","↷");break;case"selectAll":await a(),g(`全选 ${n.elements.length} 个元素`,"🎯");break;case"clearSelection":n.selected_ids.length>0&&(l(),g("清除选择","⭕"));break;case"duplicate":if(n.selected_ids.length>0){await e();const m=await t(20,20);g(`复制 ${m.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await u(h);break;default:console.warn("未知的快捷键动作:",h)}}catch(p){console.error("快捷键执行失败:",p),g("操作失败","❌")}},u=async h=>{if(n.selected_ids.length===0)return;const p=h.includes("Fast"),b=p?10:1;let m=0,y=0;switch(h){case"moveUp":case"moveFastUp":y=-b;break;case"moveDown":case"moveFastDown":y=b;break;case"moveLeft":case"moveFastLeft":m=-b;break;case"moveRight":case"moveFastRight":m=b;break}(m!==0||y!==0)&&(await o([...n.selected_ids],m,y),p&&g(`快速移动 ${b}px`,"🔄"))},g=(h,p)=>{const b=document.createElement("div");b.className="keyboard-feedback",b.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${p}</span>
        <span class="feedback-text">${h}</span>
      </div>
    `,document.body.appendChild(b),setTimeout(()=>{b.parentNode&&b.parentNode.removeChild(b)},2e3)},v=h=>{const p=h.target;if(!(p.tagName==="INPUT"||p.tagName==="TEXTAREA"||p.contentEditable==="true")){for(const[m,y]of Object.entries(C0))if(c(h,y.combination)){h.preventDefault(),h.stopPropagation(),console.log("🎹 快捷键触发:",m,y.action),d(y.action);return}}};return Qe(()=>{if(document.addEventListener("keydown",v,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const h=document.createElement("style");h.id="keyboard-feedback-styles",h.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(h)}}),dt(()=>{document.removeEventListener("keydown",v,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},T0=()=>(Qe(()=>{document.addEventListener("contextmenu",n=>n.preventDefault());try{const n=typeof window<"u"?window.localStorage.getItem("jasper.activeDataSourceId"):null;n&&Ze.setActiveDataSource(n).catch(e=>{console.warn("恢复激活数据源失败:",e)})}catch(n){console.warn("读取本地激活数据源失败:",n)}}),_(ga,{get children(){return[_(k0,{}),_($0,{})]}})),E0=document.getElementById("root");Zr(()=>_(T0,{}),E0);
