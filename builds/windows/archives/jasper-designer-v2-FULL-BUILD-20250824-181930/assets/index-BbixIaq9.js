var bn=Object.defineProperty;var $n=(e,t,n)=>t in e?bn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ue=(e,t,n)=>$n(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(s){if(s.ep)return;s.ep=!0;const l=n(s);fetch(s.href,l)}})();const _n=!1,xn=(e,t)=>e===t,Ke=Symbol("solid-proxy"),kt=Symbol("solid-track"),ut={equals:xn};let Vt=Zt;const Ve=1,ht=2,Wt={owned:null,cleanups:null,context:null,owner:null};var we=null;let xt=null,wn=null,Ee=null,De=null,je=null,$t=0;function dt(e,t){const n=Ee,i=we,s=e.length===0,l=t===void 0?i:t,r=s?Wt:{owned:null,cleanups:null,context:l?l.context:null,owner:l},o=s?e:()=>e(()=>Ne(()=>st(r)));we=r,Ee=null;try{return Qe(o,!0)}finally{Ee=n,we=i}}function q(e,t){t=t?Object.assign({},ut,t):ut;const n={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},i=s=>(typeof s=="function"&&(s=s(n.value)),Yt(n,s));return[Xt.bind(n),i]}function N(e,t,n){const i=zt(e,t,!1,Ve);ot(i)}function Tt(e,t,n){Vt=En;const i=zt(e,t,!1,Ve);i.user=!0,je?je.push(i):ot(i)}function xe(e,t,n){n=n?Object.assign({},ut,n):ut;const i=zt(e,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=n.equals||void 0,ot(i),Xt.bind(i)}function Sn(e){return Qe(e,!1)}function Ne(e){if(Ee===null)return e();const t=Ee;Ee=null;try{return e()}finally{Ee=t}}function Je(e){Tt(()=>Ne(e))}function _t(e){return we===null||(we.cleanups===null?we.cleanups=[e]:we.cleanups.push(e)),e}function Et(){return Ee}const[wa,Sa]=q(!1);function qt(e,t){const n=Symbol("context");return{id:n,Provider:Pn(n),defaultValue:e}}function Kt(e){let t;return we&&we.context&&(t=we.context[e.id])!==void 0?t:e.defaultValue}function Gt(e){const t=xe(e),n=xe(()=>At(t()));return n.toArray=()=>{const i=n();return Array.isArray(i)?i:i!=null?[i]:[]},n}function Xt(){if(this.sources&&this.state)if(this.state===Ve)ot(this);else{const e=De;De=null,Qe(()=>ft(this),!1),De=e}if(Ee){const e=this.observers?this.observers.length:0;Ee.sources?(Ee.sources.push(this),Ee.sourceSlots.push(e)):(Ee.sources=[this],Ee.sourceSlots=[e]),this.observers?(this.observers.push(Ee),this.observerSlots.push(Ee.sources.length-1)):(this.observers=[Ee],this.observerSlots=[Ee.sources.length-1])}return this.value}function Yt(e,t,n){let i=e.value;return(!e.comparator||!e.comparator(i,t))&&(e.value=t,e.observers&&e.observers.length&&Qe(()=>{for(let s=0;s<e.observers.length;s+=1){const l=e.observers[s],r=xt&&xt.running;r&&xt.disposed.has(l),(r?!l.tState:!l.state)&&(l.pure?De.push(l):je.push(l),l.observers&&Qt(l)),r||(l.state=Ve)}if(De.length>1e6)throw De=[],new Error},!1)),t}function ot(e){if(!e.fn)return;st(e);const t=$t;Cn(e,e.value,t)}function Cn(e,t,n){let i;const s=we,l=Ee;Ee=we=e;try{i=e.fn(t)}catch(r){return e.pure&&(e.state=Ve,e.owned&&e.owned.forEach(st),e.owned=null),e.updatedAt=n+1,en(r)}finally{Ee=l,we=s}(!e.updatedAt||e.updatedAt<=n)&&(e.updatedAt!=null&&"observers"in e?Yt(e,i):e.value=i,e.updatedAt=n)}function zt(e,t,n,i=Ve,s){const l={fn:e,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:we,context:we?we.context:null,pure:n};return we===null||we!==Wt&&(we.owned?we.owned.push(l):we.owned=[l]),l}function gt(e){if(e.state===0)return;if(e.state===ht)return ft(e);if(e.suspense&&Ne(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<$t);)e.state&&t.push(e);for(let n=t.length-1;n>=0;n--)if(e=t[n],e.state===Ve)ot(e);else if(e.state===ht){const i=De;De=null,Qe(()=>ft(e,t[0]),!1),De=i}}function Qe(e,t){if(De)return e();let n=!1;t||(De=[]),je?n=!0:je=[],$t++;try{const i=e();return kn(n),i}catch(i){n||(je=null),De=null,en(i)}}function kn(e){if(De&&(Zt(De),De=null),e)return;const t=je;je=null,t.length&&Qe(()=>Vt(t),!1)}function Zt(e){for(let t=0;t<e.length;t++)gt(e[t])}function En(e){let t,n=0;for(t=0;t<e.length;t++){const i=e[t];i.user?e[n++]=i:gt(i)}for(t=0;t<n;t++)gt(e[t])}function ft(e,t){e.state=0;for(let n=0;n<e.sources.length;n+=1){const i=e.sources[n];if(i.sources){const s=i.state;s===Ve?i!==t&&(!i.updatedAt||i.updatedAt<$t)&&gt(i):s===ht&&ft(i,t)}}}function Qt(e){for(let t=0;t<e.observers.length;t+=1){const n=e.observers[t];n.state||(n.state=ht,n.pure?De.push(n):je.push(n),n.observers&&Qt(n))}}function st(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),i=e.sourceSlots.pop(),s=n.observers;if(s&&s.length){const l=s.pop(),r=n.observerSlots.pop();i<s.length&&(l.sourceSlots[r]=i,s[i]=l,n.observerSlots[i]=r)}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)st(e.tOwned[t]);delete e.tOwned}if(e.owned){for(t=e.owned.length-1;t>=0;t--)st(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function An(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function en(e,t=we){throw An(e)}function At(e){if(typeof e=="function"&&!e.length)return At(e());if(Array.isArray(e)){const t=[];for(let n=0;n<e.length;n++){const i=At(e[n]);Array.isArray(i)?t.push.apply(t,i):t.push(i)}return t}return e}function Pn(e,t){return function(i){let s;return N(()=>s=Ne(()=>(we.context={...we.context,[e]:i.value},Gt(()=>i.children))),void 0),s}}const Dn=Symbol("fallback");function Mt(e){for(let t=0;t<e.length;t++)e[t]()}function Tn(e,t,n={}){let i=[],s=[],l=[],r=0,o=t.length>1?[]:null;return _t(()=>Mt(l)),()=>{let u=e()||[],c=u.length,v,d;return u[kt],Ne(()=>{let m,h,y,$,b,k,S,A,T;if(c===0)r!==0&&(Mt(l),l=[],i=[],s=[],r=0,o&&(o=[])),n.fallback&&(i=[Dn],s[0]=dt(E=>(l[0]=E,n.fallback())),r=1);else if(r===0){for(s=new Array(c),d=0;d<c;d++)i[d]=u[d],s[d]=dt(g);r=c}else{for(y=new Array(c),$=new Array(c),o&&(b=new Array(c)),k=0,S=Math.min(r,c);k<S&&i[k]===u[k];k++);for(S=r-1,A=c-1;S>=k&&A>=k&&i[S]===u[A];S--,A--)y[A]=s[S],$[A]=l[S],o&&(b[A]=o[S]);for(m=new Map,h=new Array(A+1),d=A;d>=k;d--)T=u[d],v=m.get(T),h[d]=v===void 0?-1:v,m.set(T,d);for(v=k;v<=S;v++)T=i[v],d=m.get(T),d!==void 0&&d!==-1?(y[d]=s[v],$[d]=l[v],o&&(b[d]=o[v]),d=h[d],m.set(T,d)):l[v]();for(d=k;d<c;d++)d in y?(s[d]=y[d],l[d]=$[d],o&&(o[d]=b[d],o[d](d))):s[d]=dt(g);s=s.slice(0,r=c),i=u.slice(0)}return s});function g(m){if(l[d]=m,o){const[h,y]=q(d);return o[d]=y,t(u[d],h)}return t(u[d])}}}function f(e,t){return Ne(()=>e(t||{}))}const tn=e=>`Stale read from <${e}>.`;function fe(e){const t="fallback"in e&&{fallback:()=>e.fallback};return xe(Tn(()=>e.each,e.children,t||void 0))}function U(e){const t=e.keyed,n=xe(()=>e.when,void 0,void 0),i=t?n:xe(n,void 0,{equals:(s,l)=>!s==!l});return xe(()=>{const s=i();if(s){const l=e.children;return typeof l=="function"&&l.length>0?Ne(()=>l(t?s:()=>{if(!Ne(i))throw tn("Show");return n()})):l}return e.fallback},void 0,void 0)}function zn(e){const t=Gt(()=>e.children),n=xe(()=>{const i=t(),s=Array.isArray(i)?i:[i];let l=()=>{};for(let r=0;r<s.length;r++){const o=r,u=s[r],c=l,v=xe(()=>c()?void 0:u.when,void 0,void 0),d=u.keyed?v:xe(v,void 0,{equals:(g,m)=>!g==!m});l=()=>c()||(d()?[o,v,u]:void 0)}return l});return xe(()=>{const i=n()();if(!i)return e.fallback;const[s,l,r]=i,o=r.children;return typeof o=="function"&&o.length>0?Ne(()=>o(r.keyed?l():()=>{var c;if(((c=Ne(n)())==null?void 0:c[0])!==s)throw tn("Match");return l()})):o},void 0,void 0)}function nt(e){return e}const se=e=>xe(()=>e());function Ln(e,t,n){let i=n.length,s=t.length,l=i,r=0,o=0,u=t[s-1].nextSibling,c=null;for(;r<s||o<l;){if(t[r]===n[o]){r++,o++;continue}for(;t[s-1]===n[l-1];)s--,l--;if(s===r){const v=l<i?o?n[o-1].nextSibling:n[l-o]:u;for(;o<l;)e.insertBefore(n[o++],v)}else if(l===o)for(;r<s;)(!c||!c.has(t[r]))&&t[r].remove(),r++;else if(t[r]===n[l-1]&&n[o]===t[s-1]){const v=t[--s].nextSibling;e.insertBefore(n[o++],t[r++].nextSibling),e.insertBefore(n[--l],v),t[s]=n[l]}else{if(!c){c=new Map;let d=o;for(;d<l;)c.set(n[d],d++)}const v=c.get(t[r]);if(v!=null)if(o<v&&v<l){let d=r,g=1,m;for(;++d<s&&d<l&&!((m=c.get(t[d]))==null||m!==v+g);)g++;if(g>v-o){const h=t[r];for(;o<v;)e.insertBefore(n[o++],h)}else e.replaceChild(n[o++],t[r++])}else r++;else t[r++].remove()}}}const Rt="_$DX_DELEGATE";function Mn(e,t,n,i={}){let s;return dt(l=>{s=l,t===document?e():a(t,e(),t.firstChild?null:void 0,n)},i.owner),()=>{s(),t.textContent=""}}function p(e,t,n,i){let s;const l=()=>{const o=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return o.innerHTML=e,n?o.content.firstChild.firstChild:i?o.firstChild:o.content.firstChild},r=t?()=>Ne(()=>document.importNode(s||(s=l()),!0)):()=>(s||(s=l())).cloneNode(!0);return r.cloneNode=r,r}function Re(e,t=window.document){const n=t[Rt]||(t[Rt]=new Set);for(let i=0,s=e.length;i<s;i++){const l=e[i];n.has(l)||(n.add(l),t.addEventListener(l,Rn))}}function z(e,t,n){n==null?e.removeAttribute(t):e.setAttribute(t,n)}function me(e,t){t==null?e.removeAttribute("class"):e.className=t}function ke(e,t,n,i){Array.isArray(n)?(e[`$$${t}`]=n[0],e[`$$${t}Data`]=n[1]):e[`$$${t}`]=n}function nn(e,t,n){if(!t)return n?z(e,"style"):t;const i=e.style;if(typeof t=="string")return i.cssText=t;typeof n=="string"&&(i.cssText=n=void 0),n||(n={}),t||(t={});let s,l;for(l in n)t[l]==null&&i.removeProperty(l),delete n[l];for(l in t)s=t[l],s!==n[l]&&(i.setProperty(l,s),n[l]=s);return n}function ln(e,t,n){return Ne(()=>e(t,n))}function a(e,t,n,i){if(n!==void 0&&!i&&(i=[]),typeof t!="function")return vt(e,t,i,n);N(s=>vt(e,t(),s,n),i)}function Rn(e){let t=e.target;const n=`$$${e.type}`,i=e.target,s=e.currentTarget,l=u=>Object.defineProperty(e,"target",{configurable:!0,value:u}),r=()=>{const u=t[n];if(u&&!t.disabled){const c=t[`${n}Data`];if(c!==void 0?u.call(t,c,e):u.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&l(t.host),!0},o=()=>{for(;r()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const u=e.composedPath();l(u[0]);for(let c=0;c<u.length-2&&(t=u[c],!!r());c++){if(t._$host){t=t._$host,o();break}if(t.parentNode===s)break}}else o();l(i)}function vt(e,t,n,i,s){for(;typeof n=="function";)n=n();if(t===n)return n;const l=typeof t,r=i!==void 0;if(e=r&&n[0]&&n[0].parentNode||e,l==="string"||l==="number"){if(l==="number"&&(t=t.toString(),t===n))return n;if(r){let o=n[0];o&&o.nodeType===3?o.data!==t&&(o.data=t):o=document.createTextNode(t),n=Ge(e,n,i,o)}else n!==""&&typeof n=="string"?n=e.firstChild.data=t:n=e.textContent=t}else if(t==null||l==="boolean")n=Ge(e,n,i);else{if(l==="function")return N(()=>{let o=t();for(;typeof o=="function";)o=o();n=vt(e,o,n,i)}),()=>n;if(Array.isArray(t)){const o=[],u=n&&Array.isArray(n);if(Pt(o,t,n,s))return N(()=>n=vt(e,o,n,i,!0)),()=>n;if(o.length===0){if(n=Ge(e,n,i),r)return n}else u?n.length===0?Ot(e,o,i):Ln(e,n,o):(n&&Ge(e),Ot(e,o));n=o}else if(t.nodeType){if(Array.isArray(n)){if(r)return n=Ge(e,n,i,t);Ge(e,n,null,t)}else n==null||n===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);n=t}}return n}function Pt(e,t,n,i){let s=!1;for(let l=0,r=t.length;l<r;l++){let o=t[l],u=n&&n[e.length],c;if(!(o==null||o===!0||o===!1))if((c=typeof o)=="object"&&o.nodeType)e.push(o);else if(Array.isArray(o))s=Pt(e,o,u)||s;else if(c==="function")if(i){for(;typeof o=="function";)o=o();s=Pt(e,Array.isArray(o)?o:[o],Array.isArray(u)?u:[u])||s}else e.push(o),s=!0;else{const v=String(o);u&&u.nodeType===3&&u.data===v?e.push(u):e.push(document.createTextNode(v))}}return s}function Ot(e,t,n=null){for(let i=0,s=t.length;i<s;i++)e.insertBefore(t[i],n)}function Ge(e,t,n,i){if(n===void 0)return e.textContent="";const s=i||document.createTextNode("");if(t.length){let l=!1;for(let r=t.length-1;r>=0;r--){const o=t[r];if(s!==o){const u=o.parentNode===e;!l&&!r?u?e.replaceChild(s,o):e.insertBefore(s,n):u&&o.remove()}else l=!0}}else e.insertBefore(s,n);return[s]}var On=p("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),Nn=p("<span class=loading-indicator>⏳"),Un=p("<button><span class=button-icon></span><span class=button-text>"),Fn=p("<span class=coming-soon>敬请期待"),In=p("<div class=error-indicator>❌");const sn=qt(),Bn=e=>{const[t,n]=q({mode:"design",loading:!1,error:void 0}),i=d=>{n(g=>({...g,mode:d,error:void 0})),console.log(`🎯 预览模式切换: ${d==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:d,timestamp:Date.now()}}))},v={state:t,actions:{setMode:i,toggleMode:()=>{const d=t().mode;i(d==="design"?"data":d==="data"?"preview":"design")},setLoading:d=>{n(g=>({...g,loading:d}))},setError:d=>{n(g=>({...g,error:d,loading:!1}))},isDesignMode:()=>t().mode==="design",isDataMode:()=>t().mode==="data",isPreviewMode:()=>t().mode==="preview"}};return f(sn.Provider,{value:v,get children(){return e.children}})},rn=()=>{const e=Kt(sn);if(!e)throw new Error("usePreview必须在PreviewProvider内使用");return e},jn=()=>{const{state:e,actions:t}=rn(),n=s=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[s],i=()=>n(e().mode);return(()=>{var s=On(),l=s.firstChild,r=l.firstChild,o=r.nextSibling,u=l.nextSibling;return a(r,()=>i().icon),a(o,()=>i().text),a(l,(()=>{var c=se(()=>!!e().loading);return()=>c()&&Nn()})(),null),a(u,()=>["design","data","preview"].map(c=>{const v=n(c),d=e().mode===c,g=c==="preview";return(()=>{var m=Un(),h=m.firstChild,y=h.nextSibling;return m.$$click=()=>{if(g){alert(`🔍 预览模式即将推出！

✨ 即将支持的功能：
• 纯净的最终效果预览
• 隐藏所有设计辅助元素
• 只读模式，专注查看输出效果`);return}t.setMode(c)},me(m,`mode-btn ${d?"active":""} ${g?"preview-placeholder":""}`),a(h,()=>v.icon),a(y,()=>v.text),a(m,g&&Fn(),null),N($=>{var b=e().loading,k=g?"预览模式 - 即将推出":`切换到${v.text}`;return b!==$.e&&(m.disabled=$.e=b),k!==$.t&&z(m,"title",$.t=k),$},{e:void 0,t:void 0}),m})()})),a(s,(()=>{var c=se(()=>!!e().error);return()=>c()&&(()=>{var v=In();return N(()=>z(v,"title",e().error)),v})()})(),null),s})()},wt={getModeDisplayText:e=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[e],getModeIcon:e=>({design:"🎨",data:"🔗",preview:"🔍"})[e],shouldShowExpression:e=>e==="design",shouldEvaluateExpression:e=>e==="data"||e==="preview",shouldShowDesignAids:e=>e==="design"||e==="data",shouldAllowInteraction:e=>e==="design"||e==="data",isReadOnlyMode:e=>e==="preview",getModeTransitionClass:e=>`mode-${e}-active`};Re(["click"]);const Dt=Symbol("store-raw"),Ze=Symbol("store-node"),Ie=Symbol("store-has"),an=Symbol("store-self");function on(e){let t=e[Ke];if(!t&&(Object.defineProperty(e,Ke,{value:t=new Proxy(e,Vn)}),!Array.isArray(e))){const n=Object.keys(e),i=Object.getOwnPropertyDescriptors(e);for(let s=0,l=n.length;s<l;s++){const r=n[s];i[r].get&&Object.defineProperty(e,r,{enumerable:i[r].enumerable,get:i[r].get.bind(t)})}}return t}function mt(e){let t;return e!=null&&typeof e=="object"&&(e[Ke]||!(t=Object.getPrototypeOf(e))||t===Object.prototype||Array.isArray(e))}function rt(e,t=new Set){let n,i,s,l;if(n=e!=null&&e[Dt])return n;if(!mt(e)||t.has(e))return e;if(Array.isArray(e)){Object.isFrozen(e)?e=e.slice(0):t.add(e);for(let r=0,o=e.length;r<o;r++)s=e[r],(i=rt(s,t))!==s&&(e[r]=i)}else{Object.isFrozen(e)?e=Object.assign({},e):t.add(e);const r=Object.keys(e),o=Object.getOwnPropertyDescriptors(e);for(let u=0,c=r.length;u<c;u++)l=r[u],!o[l].get&&(s=e[l],(i=rt(s,t))!==s&&(e[l]=i))}return e}function yt(e,t){let n=e[t];return n||Object.defineProperty(e,t,{value:n=Object.create(null)}),n}function at(e,t,n){if(e[t])return e[t];const[i,s]=q(n,{equals:!1,internal:!0});return i.$=s,e[t]=i}function Hn(e,t){const n=Reflect.getOwnPropertyDescriptor(e,t);return!n||n.get||!n.configurable||t===Ke||t===Ze||(delete n.value,delete n.writable,n.get=()=>e[Ke][t]),n}function cn(e){Et()&&at(yt(e,Ze),an)()}function Jn(e){return cn(e),Reflect.ownKeys(e)}const Vn={get(e,t,n){if(t===Dt)return e;if(t===Ke)return n;if(t===kt)return cn(e),n;const i=yt(e,Ze),s=i[t];let l=s?s():e[t];if(t===Ze||t===Ie||t==="__proto__")return l;if(!s){const r=Object.getOwnPropertyDescriptor(e,t);Et()&&(typeof l!="function"||e.hasOwnProperty(t))&&!(r&&r.get)&&(l=at(i,t,l)())}return mt(l)?on(l):l},has(e,t){return t===Dt||t===Ke||t===kt||t===Ze||t===Ie||t==="__proto__"?!0:(Et()&&at(yt(e,Ie),t)(),t in e)},set(){return!0},deleteProperty(){return!0},ownKeys:Jn,getOwnPropertyDescriptor:Hn};function pt(e,t,n,i=!1){if(!i&&e[t]===n)return;const s=e[t],l=e.length;n===void 0?(delete e[t],e[Ie]&&e[Ie][t]&&s!==void 0&&e[Ie][t].$()):(e[t]=n,e[Ie]&&e[Ie][t]&&s===void 0&&e[Ie][t].$());let r=yt(e,Ze),o;if((o=at(r,t,s))&&o.$(()=>n),Array.isArray(e)&&e.length!==l){for(let u=e.length;u<l;u++)(o=r[u])&&o.$();(o=at(r,"length",l))&&o.$(e.length)}(o=r[an])&&o.$()}function dn(e,t){const n=Object.keys(t);for(let i=0;i<n.length;i+=1){const s=n[i];pt(e,s,t[s])}}function Wn(e,t){if(typeof t=="function"&&(t=t(e)),t=rt(t),Array.isArray(t)){if(e===t)return;let n=0,i=t.length;for(;n<i;n++){const s=t[n];e[n]!==s&&pt(e,n,s)}pt(e,"length",i)}else dn(e,t)}function lt(e,t,n=[]){let i,s=e;if(t.length>1){i=t.shift();const r=typeof i,o=Array.isArray(e);if(Array.isArray(i)){for(let u=0;u<i.length;u++)lt(e,[i[u]].concat(t),n);return}else if(o&&r==="function"){for(let u=0;u<e.length;u++)i(e[u],u)&&lt(e,[u].concat(t),n);return}else if(o&&r==="object"){const{from:u=0,to:c=e.length-1,by:v=1}=i;for(let d=u;d<=c;d+=v)lt(e,[d].concat(t),n);return}else if(t.length>1){lt(e[i],t,[i].concat(n));return}s=e[i],n=[i].concat(n)}let l=t[0];typeof l=="function"&&(l=l(s,n),l===s)||i===void 0&&l==null||(l=rt(l),i===void 0||mt(s)&&mt(l)&&!Array.isArray(l)?dn(s,l):pt(e,i,l))}function qn(...[e,t]){const n=rt(e||{}),i=Array.isArray(n),s=on(n);function l(...r){Sn(()=>{i&&r.length===1?Wn(n,r[0]):lt(n,r)})}return[s,l]}function Kn(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Nt(e,t=!1){const n=Kn(),i=`_${n}`;return Object.defineProperty(window,i,{value:s=>(t&&Reflect.deleteProperty(window,i),e==null?void 0:e(s)),writable:!1,configurable:!0}),n}async function le(e,t={}){return new Promise((n,i)=>{const s=Nt(r=>{n(r),Reflect.deleteProperty(window,`_${l}`)},!0),l=Nt(r=>{i(r),Reflect.deleteProperty(window,`_${s}`)},!0);window.__TAURI_IPC__({cmd:e,callback:s,error:l,...t})})}const un=qt(),Gn=e=>{const[t,n]=qn({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[i,s]=q(!1),[l,r]=q(null),[o,u]=q(!1),c=async()=>{try{s(!0),console.log("🔄 Loading app state...");const x=await le("get_app_state");console.log("🔄 App state loaded, selected_ids:",x.selected_ids),n(x)}catch(x){console.error("Failed to load app state:",x)}finally{s(!1)}};Je(()=>{c()});const v=async(x,w,L,j={})=>{try{s(!0);const B=await le("create_element",{request:{element_type:x,position:w,size:L,content_data:j}});return await c(),B}catch(B){throw console.error("Failed to create element:",B),B}finally{s(!1)}},d=async(x,w)=>{try{s(!0),await le("update_element",{request:{id:x,updates:w}}),await c()}catch(L){throw console.error("Failed to update element:",L),L}finally{s(!1)}},g=async x=>{try{s(!0),await le("batch_update_positions",{request:{updates:x}}),n(w=>{const L=w.elements.map(j=>{const B=x.find(G=>G.element_id===j.id);return B?{...j,position:B.new_position}:j});return{...w,elements:L,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(w){throw console.error("Failed to batch update positions:",w),await c(),w}finally{s(!1)}},m=async x=>{try{s(!0),await le("delete_element",{elementId:x}),await c()}catch(w){throw console.error("Failed to delete element:",w),w}finally{s(!1)}},h=async x=>{try{console.log("Selecting element:",x),await le("select_element",{elementId:x}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",t.selected_ids)}catch(w){throw console.error("Failed to select element:",w),w}},y=async x=>{try{console.log("Selecting multiple elements:",x),x.length>0?(await le("select_multiple",{elementIds:x}),console.log("✅ Multi-select completed for:",x.length,"elements")):await le("clear_selection"),await c()}catch(w){throw console.error("Failed to select multiple elements:",w),w}},$=async x=>{try{console.log("Adding to selection:",x),await le("add_to_selection",{elementId:x}),await c()}catch(w){throw console.error("Failed to add to selection:",w),w}},b=async x=>{try{console.log("Removing from selection:",x),await le("remove_from_selection",{elementId:x}),await c()}catch(w){throw console.error("Failed to remove from selection:",w),w}},k=async x=>{try{console.log("Toggling selection:",x),await le("toggle_selection",{elementId:x}),await c()}catch(w){throw console.error("Failed to toggle selection:",w),w}},S=async()=>{try{await le("clear_selection"),await c()}catch(x){throw console.error("Failed to clear selection:",x),x}},A=async()=>{try{await le("copy_selected")}catch(x){throw console.error("Failed to copy selected elements:",x),x}},V={state:t,createElement:v,updateElement:d,batchUpdatePositions:g,deleteElement:m,selectElement:h,selectMultiple:y,addToSelection:$,removeFromSelection:b,toggleSelection:k,clearSelection:S,copySelected:A,copySelectedElements:async()=>A(),pasteElements:async(x,w)=>{try{s(!0);const L=await le("paste_elements",{offsetX:x,offsetY:w});return await c(),L}catch(L){throw console.error("Failed to paste elements:",L),L}finally{s(!1)}},deleteElements:async x=>{try{s(!0);for(const w of x)await le("delete_element",{elementId:w});await c()}catch(w){throw console.error("Failed to delete elements:",w),w}finally{s(!1)}},selectAllElements:async()=>{try{const x=t.elements.map(w=>w.id);await y(x)}catch(x){throw console.error("Failed to select all elements:",x),x}},moveElements:async(x,w,L)=>{try{s(!0);const j=t.elements.filter(B=>x.includes(B.id)).map(B=>({element_id:B.id,new_position:{x:B.position.x+w,y:B.position.y+L}}));j.length>0&&await g(j)}catch(j){throw console.error("Failed to move elements:",j),j}finally{s(!1)}},undo:async()=>{try{s(!0),await le("undo"),await c()}catch(x){throw console.error("Failed to undo:",x),x}finally{s(!1)}},redo:async()=>{try{s(!0),await le("redo"),await c()}catch(x){throw console.error("Failed to redo:",x),x}finally{s(!1)}},updateCanvasConfig:async x=>{try{s(!0),await le("update_canvas_config",{request:x}),await c()}catch(w){throw console.error("Failed to update canvas config:",w),w}finally{s(!1)}},getElementsAtPoint:async(x,w)=>{try{return await le("get_elements_at_point",{x,y:w})}catch(L){return console.error("Failed to get elements at point:",L),[]}},isLoading:i,setLoading:s,dragOperation:l,setDragOperation:r,resizeOperation:o,setResizeOperation:u};return f(un.Provider,{value:V,get children(){return e.children}})},We=()=>{const e=Kt(un);if(!e)throw new Error("useAppContext must be used within an AppProvider");return e};var Xn=p("<span class=text-warning>●"),Yn=p("<span class=ml-2> 个元素"),Zn=p('<span class="ml-2 text-primary">已选择 <!> 个'),Qn=p('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class="toolbar-btn opacity-50 cursor-not-allowed"title="输出预览 - 即将推出 (PDF/打印预览功能)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>输出预览</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const ei=e=>{const{state:t,undo:n,redo:i,updateCanvasConfig:s}=We(),[l,r]=q(t.canvas_config.zoom*100),o=async m=>{const h=m/100;r(m);try{await s({zoom:h})}catch(y){console.error("Failed to update zoom:",y)}},u=()=>{const m=Math.min(l()+25,500);o(m)},c=()=>{const m=Math.max(l()-25,25);o(m)},v=async()=>{try{await s({show_grid:!t.canvas_config.show_grid})}catch(m){console.error("Failed to toggle grid:",m)}},d=async()=>{try{await s({show_rulers:!t.canvas_config.show_rulers})}catch(m){console.error("Failed to toggle rulers:",m)}},g=async()=>{try{await le("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(m){console.error("Failed to toggle DevTools:",m)}};return(()=>{var m=Qn(),h=m.firstChild,y=h.firstChild,$=y.nextSibling,b=$.nextSibling,k=b.nextSibling,S=k.nextSibling,A=S.nextSibling,T=h.nextSibling,E=T.firstChild,R=E.nextSibling,O=R.nextSibling,W=O.nextSibling,I=W.nextSibling,F=I.nextSibling,P=F.nextSibling,K=P.nextSibling,V=K.nextSibling,x=V.nextSibling,w=x.nextSibling,L=T.nextSibling,j=L.firstChild;return a(h,f(jn,{}),S),ke(S,"click",e.onOpenDataSources),A.$$click=()=>{alert(`📄 输出预览即将推出！

✨ 即将支持的功能：
• PDF格式预览
• 打印效果预览
• 分页显示
• 导出设置`)},A.disabled=!0,ke(E,"click",n),ke(R,"click",i),W.$$click=c,I.addEventListener("change",B=>{const G=B.target.value;if(G==="fit")console.log("Fit to window");else{const ce=parseInt(G.replace("%",""));o(ce)}}),F.$$click=u,K.$$click=v,V.$$click=d,w.$$click=g,a(L,f(U,{get when(){return t.dirty},get children(){return Xn()}}),j),a(j,()=>t.template_name||"未命名模板"),a(L,f(U,{get when(){return t.elements.length>0},get children(){var B=Yn(),G=B.firstChild;return a(B,()=>t.elements.length,G),B}}),null),a(L,f(U,{get when(){return t.selected_ids.length>0},get children(){var B=Zn(),G=B.firstChild,ce=G.nextSibling;return ce.nextSibling,a(B,()=>t.selected_ids.length,ce),B}}),null),N(B=>{var G=`toolbar-btn-icon ${t.can_undo?"":"opacity-50 cursor-not-allowed"}`,ce=!t.can_undo,ne=`撤销${t.undo_description?` (${t.undo_description})`:""} (Ctrl+Z)`,J=`toolbar-btn-icon ${t.can_redo?"":"opacity-50 cursor-not-allowed"}`,re=!t.can_redo,be=`重做${t.redo_description?` (${t.redo_description})`:""} (Ctrl+Y)`,ae=`toolbar-btn-icon ${t.canvas_config.show_grid?"active":""}`,Q=`toolbar-btn-icon ${t.canvas_config.show_rulers?"active":""}`;return G!==B.e&&me(E,B.e=G),ce!==B.t&&(E.disabled=B.t=ce),ne!==B.a&&z(E,"title",B.a=ne),J!==B.o&&me(R,B.o=J),re!==B.i&&(R.disabled=B.i=re),be!==B.n&&z(R,"title",B.n=be),ae!==B.s&&me(K,B.s=ae),Q!==B.h&&me(V,B.h=Q),B},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),N(()=>I.value=`${Math.round(l())}%`),m})()};Re(["click"]);var ti=p('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),ni=p('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const ii=()=>{const{createElement:e}=We(),[t,n]=q(""),i=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:(c==null?void 0:c.text)||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:(c==null?void 0:c.expression)||"${fieldName}",format:c==null?void 0:c.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:(c==null?void 0:c.fill_color)||"transparent",border:{color:(c==null?void 0:c.border_color)||"#000000",width:(c==null?void 0:c.border_width)||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:(c==null?void 0:c.color)||"#000000",width:(c==null?void 0:c.width)||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:(c==null?void 0:c.src)||"",alt:(c==null?void 0:c.alt)||"图片"})}],s=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],l=[...i,...s],r=()=>{const c=t().toLowerCase();return c?l.filter(v=>v.name.toLowerCase().includes(c)||v.description.toLowerCase().includes(c)):l},o=(c,v)=>{if(console.log("Starting drag for component:",c.id),v.dataTransfer){v.dataTransfer.effectAllowed="copy",v.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const d=document.createElement("div");d.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,d.style.position="absolute",d.style.top="-1000px",document.body.appendChild(d),v.dataTransfer.setDragImage(d,50,20),setTimeout(()=>{document.body.removeChild(d)},0)}},u=async c=>{try{const v=await e(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",v)}catch(v){console.error("Failed to create element:",v)}};return(()=>{var c=ti(),v=c.firstChild,d=v.firstChild,g=d.nextSibling,m=v.nextSibling,h=m.firstChild,y=h.firstChild,$=y.firstChild,b=$.nextSibling,k=y.nextSibling,S=k.firstChild,A=S.nextSibling,T=k.nextSibling,E=T.firstChild,R=E.nextSibling;return g.$$input=O=>n(O.target.value),a(b,f(fe,{get each(){return r().filter(O=>O.category==="basic")},children:O=>f(St,{component:O,onDrag:W=>o(O,W),onClick:()=>u(O)})})),a(A,f(fe,{get each(){return r().filter(O=>O.category==="data")},children:O=>f(St,{component:O,onDrag:W=>o(O,W),onClick:()=>u(O)})})),a(R,f(fe,{get each(){return r().filter(O=>O.category==="bank")},children:O=>f(St,{component:O,onDrag:W=>o(O,W),onClick:()=>u(O)})})),N(()=>g.value=t()),c})()},St=e=>(()=>{var t=ni(),n=t.firstChild,i=n.firstChild,s=i.nextSibling;return ke(t,"click",e.onClick),t.addEventListener("dragstart",l=>e.onDrag(l)),z(t,"draggable",!0),a(i,()=>e.component.icon),a(s,()=>e.component.name),N(()=>z(t,"title",e.component.description)),t})();Re(["input","click"]);class Se{static async getAvailableTypes(){return le("get_available_data_source_types")}static async getConfigSchema(t){return le("get_config_schema",{providerType:t})}static async getDefaultConfig(t){return le("get_default_config",{providerType:t})}static async getExampleConfigs(t){return le("get_example_configs",{providerType:t})}static async validateConfig(t,n){return le("validate_config",{providerType:t,config:n})}static async testConnection(t,n){return le("test_data_source_connection",{providerType:t,config:n})}static async createDataSource(t,n,i){return le("create_data_source",{name:t,providerType:n,config:i})}static async listDataSources(){return le("list_data_sources")}static async deleteDataSource(t){return le("delete_data_source",{sourceId:t})}static async updateConfig(t,n){return le("update_data_source_config",{sourceId:t,config:n})}static async getSchema(t){return le("get_data_source_schema",{sourceId:t})}static async refreshSchema(t){return le("refresh_data_source_schema",{sourceId:t})}static async discoverSchema(t,n){return le("discover_schema",{providerType:t,config:n})}static async queryData(t,n){return le("query_data_source",{sourceId:t,query:n})}static async getPreview(t,n,i){return le("get_data_preview",{sourceId:t,path:n,limit:i})}static async searchData(t,n,i,s){return le("search_data",{sourceId:t,searchTerm:n,fields:i,limit:s})}static async evaluateExpression(t,n,i){return le("evaluate_expression",{sourceId:t,expression:n,context:i})}static async evaluateExpressionsBatch(t,n,i){return le("evaluate_expressions_batch",{sourceId:t,expressions:n,context:i})}}const li="modulepreload",si=function(e){return"/"+e},Ut={},ri=function(t,n,i){let s=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),o=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(n.map(u=>{if(u=si(u),u in Ut)return;Ut[u]=!0;const c=u.endsWith(".css"),v=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${v}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":li,c||(d.as="script"),d.crossOrigin="",d.href=u,o&&d.setAttribute("nonce",o),document.head.appendChild(d),c)return new Promise((g,m)=>{d.addEventListener("load",g),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${u}`)))})}))}function l(r){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=r,window.dispatchEvent(o),!o.defaultPrevented)throw r}return s.then(r=>{for(const o of r||[])o.status==="rejected"&&l(o.reason);return t().catch(l)})};class ai{constructor(){Ue(this,"styles",new Map);Ue(this,"elementStyleMap",new Map);Ue(this,"observers",new Set);Ue(this,"initialized",!1);console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(t){throw console.error("❌ TextStyleManager 初始化失败:",t),t}}createStyle(t){const n=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={...t,id:n,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(n,i),this.notifyObservers("style-created",n),this.saveUserStyles(),console.log(`🎨 创建新样式: ${i.name} (${n})`),n}getStyle(t){return this.styles.get(t)||null}updateStyle(t,n){const i=this.styles.get(t);if(!i)return console.warn(`⚠️ 样式 ${t} 不存在`),!1;if(i.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${t}`),!1;const s={...i,style:{...i.style,...n},metadata:{...i.metadata,lastModified:new Date}};return this.styles.set(t,s),this.syncAllStyleInstances(t),this.saveUserStyles(),this.notifyObservers("style-updated",t),console.log(`🔄 样式已更新: ${i.name} (${t})`),!0}deleteStyle(t){const n=this.styles.get(t);if(!n)return!1;if(n.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${t}`),!1;const i=Array.from(this.elementStyleMap.entries()).filter(([s,l])=>l===t).map(([s,l])=>s);return i.length>0?(console.warn(`⚠️ 无法删除样式 ${t}，仍有 ${i.length} 个元素在使用`),!1):(this.styles.delete(t),this.saveUserStyles(),this.notifyObservers("style-deleted",t),console.log(`🗑️ 样式已删除: ${n.name} (${t})`),!0)}applyStyleToElement(t,n){const i=this.styles.get(n);if(!i)return{success:!1,elementId:t,styleId:n,appliedAt:new Date,error:`样式 ${n} 不存在`};try{const s=this.elementStyleMap.get(t);if(this.elementStyleMap.set(t,n),i.metadata.usageCount++,s&&s!==n){const l=this.styles.get(s);l&&(l.metadata.usageCount=Math.max(0,l.metadata.usageCount-1))}return this.applyStyleToDOM(t,i.style),this.notifyObservers("style-applied",{elementId:t,styleId:n}),console.log(`🎯 应用样式: ${i.name} → 元素 ${t}`),{success:!0,elementId:t,styleId:n,appliedAt:new Date}}catch(s){return console.error(`❌ 应用样式失败: ${s}`),{success:!1,elementId:t,styleId:n,appliedAt:new Date,error:s instanceof Error?s.message:String(s)}}}getElementStyleId(t){return this.elementStyleMap.get(t)||null}removeElementStyle(t){const n=this.elementStyleMap.get(t);if(n){this.elementStyleMap.delete(t);const i=this.styles.get(n);i&&(i.metadata.usageCount=Math.max(0,i.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${t}`)}}getStylesByCategory(t){const n=Array.from(this.styles.values());return(t?n.filter(s=>s.category===t):n).sort((s,l)=>s.metadata.isSystemStyle!==l.metadata.isSystemStyle?s.metadata.isSystemStyle?-1:1:l.metadata.usageCount-s.metadata.usageCount)}searchStyles(t,n){const i=this.getStylesByCategory(n),s=t.toLowerCase().trim();return s?i.filter(l=>l.name.toLowerCase().includes(s)||l.description.toLowerCase().includes(s)||l.metadata.tags.some(r=>r.toLowerCase().includes(s))):i}getStyleUsageStats(){const t=[];for(const[n,i]of this.styles){const s=Array.from(this.elementStyleMap.entries()).filter(([l,r])=>r===n).map(([l,r])=>l);t.push({styleId:n,usageCount:s.length,elements:s,lastUsed:i.metadata.lastModified})}return t.sort((n,i)=>i.usageCount-n.usageCount)}cleanupUnusedStyles(){const t=new Set(this.elementStyleMap.values()),n=[];for(const[i,s]of this.styles)!t.has(i)&&!s.metadata.isSystemStyle&&(this.styles.delete(i),n.push(i),console.log(`🧹 清理未使用样式: ${s.name} (${i})`));return n.length>0&&this.saveUserStyles(),n}exportStyles(t){const n=t?t.map(s=>this.styles.get(s)).filter(Boolean):Array.from(this.styles.values()),i=new Set(n.map(s=>s.category));return{version:"2.0.0",exportedAt:new Date,styles:n,metadata:{totalStyles:n.length,categories:Array.from(i),author:"user"}}}async importStyles(t){const n=[];for(const i of t.styles){if(Array.from(this.styles.values()).find(r=>r.name===i.name&&r.category===i.category)){console.warn(`⚠️ 跳过已存在的样式: ${i.name}`);continue}const l=this.createStyle({name:i.name,description:i.description,category:i.category,style:i.style,...i.inheritance&&{inheritance:i.inheritance}});n.push(l)}return console.log(`📦 导入完成，共导入 ${n.length} 个样式`),n}addObserver(t){this.observers.add(t)}removeObserver(t){this.observers.delete(t)}syncAllStyleInstances(t){const n=this.styles.get(t);if(!n)return;const i=[];for(const[s,l]of this.elementStyleMap)l===t&&(this.applyStyleToDOM(s,n.style),i.push(s));this.notifyObservers("styles-synced",{styleId:t,affectedElements:i}),console.log(`🔄 样式同步完成: ${t} → ${i.length} 个元素`)}applyStyleToDOM(t,n){console.log(`🎨 应用样式到DOM: 元素 ${t}`,{font_family:n.font_family,font_size:n.font_size,typography:n.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:t}=await ri(async()=>{const{BANK_TEXT_STYLES:n}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:n}},[]);for(const n of t)this.styles.set(n.id,n);console.log(`🏦 加载了 ${t.length} 个银行预设样式`)}catch(t){console.warn("⚠️ 加载系统样式失败:",t)}}async loadUserStyles(){try{const t=localStorage.getItem("jasper-text-styles");if(t){const n=JSON.parse(t);for(const i of n)i.metadata.createdAt=new Date(i.metadata.createdAt),i.metadata.lastModified=new Date(i.metadata.lastModified),this.styles.set(i.id,i);console.log(`👤 加载了 ${n.length} 个用户自定义样式`)}}catch(t){console.warn("⚠️ 加载用户样式失败:",t)}}saveUserStyles(){try{const t=Array.from(this.styles.values()).filter(n=>!n.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(t)),console.log(`💾 保存了 ${t.length} 个用户自定义样式`)}catch(t){console.error("❌ 保存用户样式失败:",t)}}notifyObservers(t,n){for(const i of this.observers)try{i.onStyleChange(t,n)}catch(s){console.error("❌ 观察者通知失败:",s)}}}const Le=new ai;class oi{calculateUnifiedBounds(t,n,i){const s=this.calculateFontMetrics(n),l=this.measureTextContent(t,n,i.width),r=this.calculateContainerHeight(l,s,i.height),o=this.calculateTextPositioning(n,i,r,s),u={containerBounds:{x:0,y:0,width:i.width,height:r},contentBounds:l.bounds,fontMetrics:s,positioning:o};return l.wrappedLines&&(u.textLayout={wrappedLines:l.wrappedLines,isWrapped:!0,originalLineCount:t.split(`
`).length,wrappedLineCount:l.wrappedLines.length}),u}calculateFontMetrics(t){const n=t.font_size,i=1.2,s=.75,l=.25,r=n*s,o=n*l;return{fontSize:n,lineHeight:n*i,ascender:r,descender:o,baseline:r}}getCharacterWidth(t,n){const i=n.font_size,s=n.font_family,l=/[\u4e00-\u9fa5]/.test(t),r={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},o=s.toLowerCase();let u=r.default;for(const[v,d]of Object.entries(r))if(o.includes(v.toLowerCase())||v.toLowerCase().includes(o)){u=d;break}const c=l?u.chinese:u.english;return i*c}calculateTextWidth(t,n){let i=0;for(const s of t)s!==`
`&&(i+=this.getCharacterWidth(s,n));return i}measureTextContent(t,n,i=0){const s=t.split(`
`),l=s.length;let r=0;for(const c of s){const v=this.calculateTextWidth(c,n);r=Math.max(r,v)}if(i>0&&r>i)return this.calculateWrappedText(t,n,i);const o=i>0?Math.min(r,i):r,u=l*n.font_size*1.2;return{bounds:{x:0,y:0,width:o,height:u},lineCount:l,actualHeight:u}}calculateWrappedText(t,n,i){const s=this.getCharacterWidth("测",n);if(Math.floor(i/s)<1||i<s)return{bounds:{x:0,y:0,width:i,height:n.font_size*1.2},lineCount:1,actualHeight:n.font_size*1.2,wrappedLines:["..."]};const r=this.smartSegmentation(t);let o=[],u="",c=0;for(const d of r){const g=this.calculateTextWidth(d,n),m=c+g;if(m>i)if(u.trim())o.push(u.trim()),u=d,c=g;else{const{truncated:h,remaining:y}=this.forceTruncateSegment(d,i,n);o.push(h),u=y,c=this.calculateTextWidth(y,n)}else u+=d,c=m}u.trim()&&o.push(u.trim());const v=o.length*n.font_size*1.2;return{bounds:{x:0,y:0,width:i,height:v},lineCount:o.length,actualHeight:v,wrappedLines:o}}forceTruncateSegment(t,n,i){let s="",l=0,r=0;for(r=0;r<t.length;r++){const u=t[r];if(!u)break;const c=this.getCharacterWidth(u,i);if(l+c>n)break;s+=u,l+=c}const o=t.substring(r);return{truncated:s,remaining:o}}smartSegmentation(t){const n=[];let i="";for(let s=0;s<t.length;s++){const l=t[s];l&&(/[\u4e00-\u9fa5]/.test(l)?(i&&(n.push(i),i=""),n.push(l)):l===`
`?(i&&(n.push(i),i=""),n.push(`
`)):l===" "?i?(n.push(i+" "),i=""):n.push(" "):i+=l)}return i&&n.push(i),n.filter(s=>s.length>0)}calculateContainerHeight(t,n,i){const s=n.lineHeight*t.lineCount,l=n.ascender+n.descender,r=n.lineHeight,o=Math.max(s,l,r);return Math.max(o,i)}calculateTextPositioning(t,n,i,s){var v;const l=this.calculateHorizontalAnchor(t.align,n.width),r=s.baseline,o=((v=t.background)==null?void 0:v.padding)||0,u=-o,c=-o;return{textAnchorX:l,textAnchorY:r,backgroundX:u,backgroundY:c}}calculateHorizontalAnchor(t,n){switch(t){case"Left":return 0;case"Center":return n/2;case"Right":return n;default:return 0}}getTextAnchor(t){switch(t){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(t,n){}}const Xe=new oi;class ci{constructor(){Ue(this,"initialized",!1);this.initialize()}async initialize(){if(!this.initialized)try{await Le.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(t){console.error("❌ ProfessionalTextRenderer 初始化失败:",t)}}isElementUsingProfessionalStyle(t){return Le.getElementStyleId(t)!==null}adaptLegacyTextStyle(t){return{...t,font_weight:t.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:t.color}}],effects:[]}}renderProfessionalText(t,n=!1){if(t.content.type!=="Text"&&t.content.type!=="DataField")return null;const i=Le.getElementStyleId(t.id);let s;if(i){const o=Le.getStyle(i);if(!o)return console.warn(`⚠️ 找不到样式定义: ${i}`),null;s=o.style,console.log(`🎨 使用专业样式渲染: ${o.name} (${i})`)}else{const o=t.content.type==="Text"||t.content.type==="DataField"?t.content.style:null;if(!o)return null;s=this.adaptLegacyTextStyle(o),console.log("🔄 适配传统样式到专业排版系统")}const l=this.calculateEnhancedBounds(t.content.type==="Text"?t.content.content:t.content.expression||"[数据字段]",s,t.size);return{element:this.createProfessionalTextElement(l,t.content.type==="Text"?t.content.content:t.content.expression||"[数据字段]",s,!1),bounds:l,style:s}}calculateEnhancedBounds(t,n,i){const s=Xe.calculateUnifiedBounds(t,n,i),l=n.typography,r=this.calculateLetterSpacingEffect(t,l.letterSpacing),o=this.calculateLineHeightEffect(t,n.font_size,l.lineHeight),u=this.calculateParagraphSpacingEffect(t,l.paragraphSpacing);return{containerBounds:s.containerBounds,positioning:s.positioning,fontMetrics:s.fontMetrics,typography:{adjustedWidth:s.containerBounds.width+r.widthIncrease,adjustedHeight:s.containerBounds.height+o.heightIncrease+u.heightIncrease,letterSpacingData:r,lineHeightData:o,paragraphData:u}}}calculateLetterSpacingEffect(t,n){const i=t.split(`
`),s=i.reduce((r,o)=>r+o.length,0),l=Math.max(0,s-i.length);return{spacingValue:n,totalSpaces:l,widthIncrease:l*n,charPositions:[]}}calculateLineHeightEffect(t,n,i){const l=t.split(`
`).length,r=n*i,o=n*1.2,u=r-o;return{lineHeightRatio:i,actualLineHeight:r,lineCount:l,heightIncrease:u*Math.max(0,l-1),baselinePositions:[]}}calculateParagraphSpacingEffect(t,n){const s=t.split(`

`).length;return{spacing:n,paragraphCount:s,heightIncrease:n*Math.max(0,s-1),paragraphPositions:[]}}createProfessionalTextElement(t,n,i,s){const l=document.createElementNS("http://www.w3.org/2000/svg","g");return l.setAttribute("class","professional-text-container"),this.renderMultipleFills(l,t,i.fills),this.renderEffects(l,t,i.effects),this.renderTypographyText(l,t,n,i),this.renderTextDecorations(l,t,n,i.typography.decoration),l}renderMultipleFills(t,n,i){if(i&&i.length>0&&i[0].enabled){const s=i[0];s.type==="solid"&&s.solid&&console.log("🎨 应用纯色填充:",s.solid.color)}}renderEffects(t,n,i){if(!i||i.length===0)return;const s=document.createElementNS("http://www.w3.org/2000/svg","defs"),l=document.createElementNS("http://www.w3.org/2000/svg","filter"),r=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;l.id=r;for(const o of i)if(o.enabled&&o.type==="drop-shadow"&&o.dropShadow){const u=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");u.setAttribute("dx",o.dropShadow.offsetX.toString()),u.setAttribute("dy",o.dropShadow.offsetY.toString()),u.setAttribute("stdDeviation",o.dropShadow.blur.toString()),u.setAttribute("flood-color",o.dropShadow.color),u.setAttribute("flood-opacity",o.dropShadow.opacity.toString()),l.appendChild(u),console.log("✨ 应用投影效果")}l.children.length>0&&(s.appendChild(l),t.appendChild(s),t.setAttribute("filter",`url(#${r})`))}renderTypographyText(t,n,i,s){var u,c;const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("font-family",s.font_family),l.setAttribute("font-size",s.font_size.toString()),l.setAttribute("font-weight",s.font_weight),l.setAttribute("fill",((c=(u=s.fills[0])==null?void 0:u.solid)==null?void 0:c.color)||s.color),l.setAttribute("text-anchor",this.getTextAnchor(s.align));const r=i.split(`
`),o=s.typography;r.forEach((v,d)=>{const g=document.createElementNS("http://www.w3.org/2000/svg","tspan");o.letterSpacing!==0&&g.setAttribute("letter-spacing",`${o.letterSpacing}px`);const m=n.positioning.textAnchorY+d*n.typography.lineHeightData.actualLineHeight;if(g.setAttribute("x",n.positioning.textAnchorX.toString()),g.setAttribute("y",m.toString()),d===0&&o.textIndent!==0){const h=n.positioning.textAnchorX+o.textIndent;g.setAttribute("x",h.toString())}o.textTransform&&o.textTransform!=="none"?g.textContent=this.applyTextTransform(v,o.textTransform):g.textContent=v,l.appendChild(g)}),t.appendChild(l)}renderTextDecorations(t,n,i,s){if(!s.underline&&!s.strikethrough&&!s.overline)return;const l=i.split(`
`),r=s.decorationColor||"#000000",o=s.decorationThickness||1,u=s.decorationStyle==="dashed"?"4,2":s.decorationStyle==="dotted"?"1,1":"none";l.forEach((c,v)=>{if(!c.trim())return;const d=n.positioning.textAnchorY+v*n.typography.lineHeightData.actualLineHeight,g=c.length*n.fontMetrics.fontSize*.6,m=n.positioning.textAnchorX,h=m+g;if(s.underline){const y=d+n.fontMetrics.fontSize*.1;this.createDecorationLine(t,m,y,h,y,r,o,u,"underline")}if(s.strikethrough){const y=d-n.fontMetrics.fontSize*.3;this.createDecorationLine(t,m,y,h,y,r,o,u,"strikethrough")}if(s.overline){const y=d-n.fontMetrics.fontSize*.8;this.createDecorationLine(t,m,y,h,y,r,o,u,"overline")}})}createDecorationLine(t,n,i,s,l,r,o,u,c){const v=document.createElementNS("http://www.w3.org/2000/svg","line");v.setAttribute("x1",n.toString()),v.setAttribute("y1",i.toString()),v.setAttribute("x2",s.toString()),v.setAttribute("y2",l.toString()),v.setAttribute("stroke",r),v.setAttribute("stroke-width",o.toString()),v.setAttribute("stroke-dasharray",u),v.setAttribute("class",`text-decoration-${c}`),t.appendChild(v)}getTextAnchor(t){switch(t){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(t,n){switch(n){case"uppercase":return t.toUpperCase();case"lowercase":return t.toLowerCase();case"capitalize":return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();default:return t}}}const di=new ci;var ui=p("<button class=search-clear title=清除搜索>✕"),hi=p('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),gi=p("<button><span class=category-icon></span><span class=category-label>"),fi=p("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),vi=p("<span class=usage-count>"),mi=p("<button class=edit-button title=编辑样式>✏️"),yi=p("<span class=system-badge title=系统预设样式>🔒"),pi=p("<div class=selection-indicator>✓");const bi=e=>{const[t,n]=q("bank-special"),[i,s]=q(""),[l,r]=q([]);(async()=>{await Le.initialize();const g=Le.getStylesByCategory();r(g)})();const u=xe(()=>{let g=l();t()&&(g=g.filter(h=>h.category===t()));const m=i().toLowerCase().trim();return m&&(g=g.filter(h=>h.name.toLowerCase().includes(m)||h.description.toLowerCase().includes(m)||h.metadata.tags.some(y=>y.toLowerCase().includes(m)))),g}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],v=g=>{console.log("🎯 选择样式:",g),e.onStyleSelect(g)},d=g=>{n(g),console.log("📂 切换分类:",g)};return(()=>{var g=hi(),m=g.firstChild,h=m.nextSibling,y=h.firstChild,$=y.firstChild,b=$.nextSibling,k=h.nextSibling,S=k.firstChild,A=k.nextSibling,T=A.firstChild,E=T.firstChild;return a(m,f(fe,{each:c,children:R=>(()=>{var O=gi(),W=O.firstChild,I=W.nextSibling;return O.$$click=()=>d(R.key),a(W,()=>R.icon),a(I,()=>R.label),N(F=>{var P=`category-button ${t()===R.key?"active":""}`,K=R.label;return P!==F.e&&me(O,F.e=P),K!==F.t&&z(O,"title",F.t=K),F},{e:void 0,t:void 0}),O})()})),b.$$input=R=>s(R.target.value),a(y,f(U,{get when(){return i()},get children(){var R=ui();return R.$$click=()=>s(""),R}}),null),a(k,f(fe,{get each(){return u()},children:R=>f($i,{style:R,get selected(){return e.selectedStyleId===R.id},onClick:()=>v(R.id),onEdit:()=>e.onStyleEdit(R.id)})}),S),ke(S,"click",e.onStyleCreate),a(T,()=>u().length,E),a(T,(()=>{var R=se(()=>!!i());return()=>R()&&` (搜索: "${i()}")`})(),null),N(()=>b.value=i()),g})()},$i=e=>{const t=()=>{switch(e.style.category){case"bank-special":return e.style.id.includes("amount")?"¥123,456.78":e.style.id.includes("account")?"6222 0012 3456 7890":e.style.id.includes("institution")?e.style.name:e.style.id.includes("date")?"2025-08-19":e.style.name;case"heading":return e.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return e.style.name}},n=xe(()=>{var r,o,u,c,v,d,g,m;const l=e.style.style;return{fontFamily:l.font_family,fontSize:`${Math.min(l.font_size,14)}px`,fontWeight:l.font_weight,color:((u=(o=(r=l.fills)==null?void 0:r[0])==null?void 0:o.solid)==null?void 0:u.color)||l.color,textAlign:l.align.toLowerCase(),letterSpacing:`${((c=l.typography)==null?void 0:c.letterSpacing)||0}px`,textDecoration:(d=(v=l.typography)==null?void 0:v.decoration)!=null&&d.underline?"underline":(m=(g=l.typography)==null?void 0:g.decoration)!=null&&m.strikethrough?"line-through":"none"}}),i=l=>{l.preventDefault(),e.onClick()},s=l=>{l.preventDefault(),l.stopPropagation(),e.onEdit()};return(()=>{var l=fi(),r=l.firstChild,o=r.nextSibling,u=o.firstChild,c=u.nextSibling,v=c.firstChild,d=o.nextSibling;return l.$$click=i,a(r,t),a(u,()=>e.style.name),a(v,()=>_i(e.style.category)),a(c,(()=>{var g=se(()=>e.style.metadata.usageCount>0);return()=>g()&&(()=>{var m=vi();return a(m,()=>e.style.metadata.usageCount),N(()=>z(m,"title",`使用次数: ${e.style.metadata.usageCount}`)),m})()})(),null),a(d,(()=>{var g=se(()=>!e.style.metadata.isSystemStyle);return()=>g()&&(()=>{var m=mi();return m.$$click=s,m})()})(),null),a(d,(()=>{var g=se(()=>!!e.style.metadata.isSystemStyle);return()=>g()&&yi()})(),null),a(l,(()=>{var g=se(()=>!!e.selected);return()=>g()&&pi()})(),null),N(g=>{var m=`style-card ${e.selected?"selected":""} ${e.style.metadata.isSystemStyle?"system-style":"user-style"}`,h=n();return m!==g.e&&me(l,g.e=m),g.t=nn(r,h,g.t),g},{e:void 0,t:void 0}),l})()};function _i(e){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[e]||e}Re(["input","click"]);var xi=p("<button class=style-picker-toggle>"),wi=p("<button class=style-reload-btn title=重新加载样式系统>🔄"),Si=p("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),Ci=p("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),ki=p("<div class=style-picker-panel>"),Ei=p("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),Ai=p("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),Pi=p('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),Di=p("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),Ti=p('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const Ft=e=>{const[t,n]=q(null),[i,s]=q(!1),[l,r]=q([]),[o,u]=q(!1);Je(async()=>{try{await Le.initialize();const b=Le.getElementStyleId(e.element.id);n(b);const k=Le.getStylesByCategory();r(k),u(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch(b){console.error("❌ 专业文字属性面板初始化失败:",b)}});const c=xe(()=>{const b=t();return b?Le.getStyle(b):null}),v=xe(()=>e.element.content.type==="Text"||e.element.content.type==="DataField"),d=async b=>{try{const k=await Le.applyStyleToElement(e.element.id,b);if(k.success){n(b);const S=Le.getStyle(b);if(S){const A=g(S.style);e.onUpdate(e.element.id,"content",{...e.element.content,style:A})}console.log("✅ 样式应用成功:",k)}else console.error("❌ 样式应用失败:",k.error)}catch(k){console.error("❌ 样式选择处理失败:",k)}},g=b=>{var k,S,A;return{font_family:b.font_family,font_size:b.font_size,font_weight:b.font_weight,color:((A=(S=(k=b.fills)==null?void 0:k[0])==null?void 0:S.solid)==null?void 0:A.color)||b.color,align:b.align}},m=()=>{console.log("🆕 创建新样式")},h=b=>{console.log("✏️ 编辑样式:",b)},y=()=>{s(!i())},$=()=>{t()&&(Le.removeElementStyle(e.element.id),n(null),console.log("🗑️ 移除元素样式"))};return v()?(()=>{var b=Di(),k=b.firstChild,S=k.firstChild,A=S.firstChild,T=A.nextSibling,E=T.nextSibling,R=S.nextSibling;return a(E,f(U,{get when(){return o()},get children(){var O=xi();return O.$$click=y,a(O,()=>i()?"📝":"📚"),N(()=>z(O,"title",i()?"隐藏样式库":"显示样式库")),O}}),null),a(E,f(U,{get when(){return!o()},get children(){var O=wi();return O.$$click=()=>window.location.reload(),O}}),null),a(R,f(U,{get when(){return!o()},get children(){var O=Si(),W=O.firstChild,I=W.firstChild,F=I.nextSibling,P=F.nextSibling,K=P.firstChild;return K.$$click=async()=>{try{await Le.initialize();const V=Le.getStylesByCategory();r(V),u(!0),console.log("🔄 样式系统重新初始化成功")}catch(V){console.error("❌ 重新初始化失败:",V)}},O}}),null),a(R,f(U,{get when(){return o()},get children(){return[f(U,{get when(){return c()},children:O=>(()=>{var W=Ti(),I=W.firstChild,F=I.firstChild,P=F.firstChild,K=P.nextSibling,V=F.nextSibling,x=V.firstChild,w=x.nextSibling;return a(P,()=>O().name),a(K,()=>zi(O().category)),x.$$click=()=>h(O().id),w.$$click=$,W})()}),f(U,{get when(){return!c()},get children(){var O=Ci(),W=O.firstChild,I=W.nextSibling;return W.$$click=y,I.$$click=m,O}}),f(U,{get when(){return i()},get children(){var O=ki();return a(O,f(bi,{get selectedStyleId(){return t()},onStyleSelect:d,onStyleCreate:m,onStyleEdit:h})),O}})]}}),null),a(b,f(U,{get when(){return c()},get children(){return Ei()}}),null),a(b,f(U,{get when(){return c()},get children(){return Ai()}}),null),a(b,f(U,{get when(){return!1},get children(){var O=Pi(),W=O.firstChild,I=W.nextSibling,F=I.firstChild,P=F.firstChild,K=P.firstChild,V=K.nextSibling,x=P.nextSibling,w=x.firstChild,L=w.nextSibling,j=x.nextSibling,B=j.firstChild,G=B.nextSibling,ce=G.firstChild,ne=j.nextSibling,J=ne.firstChild,re=J.nextSibling;return a(V,()=>e.element.id),a(L,()=>t()||"无"),a(G,()=>l().length,ce),a(re,()=>di.isElementUsingProfessionalStyle(e.element.id)?"是":"否"),O}}),null),b})():null};function zi(e){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[e]||e}Re(["click"]);var Li=p('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),Mi=p('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),Ri=p("<span class=property-value>"),Oi=p('<span class="property-value text-xs text-muted">'),bt=p("<div class=space-y-2>"),it=p("<input type=number class=property-input>"),Ni=p('<div class="grid grid-cols-2 gap-2">'),It=p("<input type=checkbox class=property-checkbox>"),Ui=p('<div class="p-4 space-y-4">'),Bt=p("<div>"),Fi=p("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),Ii=p("<div class=property-field><label class=property-label>"),Bi=p("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),hn=p('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),gn=p("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),ji=p('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),fn=p("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),Hi=p('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),vn=p('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),mn=p('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),Ji=p('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),Vi=p("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),jt=p("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),Wi=p('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),qi=p("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),Ki=p("<input type=text class=property-input placeholder=图片描述文字>"),Gi=p("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),Xi=p("<div class=space-y-3>"),Yi=p("<img class=property-image>"),Zi=p("<div class=property-loading>加载数据源..."),Qi=p('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),el=p('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),tl=p('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),nl=p('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),il=p("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),ll=p("<div class=space-y-4>"),sl=p("<select class=property-select><option value>选择数据源"),rl=p("<option> (<!>)"),al=p('<div class=flex><input type=number class="property-input flex-1">'),ol=p("<span class=property-unit>"),cl=p('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),dl=p("<div class=property-alignment-group>"),ul=p("<button>");const hl=()=>{const{state:e,updateElement:t}=We(),n=xe(()=>{const l=new Set(e.selected_ids);return e.elements.filter(r=>l.has(r.id))}),i=xe(()=>n()[0]),s=async(l,r,o)=>{try{await t(l,{[r]:o})}catch(u){console.error("Failed to update element property:",u)}};return(()=>{var l=Li(),r=l.firstChild,o=r.nextSibling;return a(o,f(U,{get when(){return i()},get fallback(){return Mi()},get children(){return f(gl,{get element(){return i()},onUpdate:s})}})),l})()},gl=e=>{const t=(i,s)=>{const l={...e.element.position,[i]:s};e.onUpdate(e.element.id,"position",l)},n=(i,s)=>{const l={...e.element.size,[i]:Math.max(1,s)};e.onUpdate(e.element.id,"size",l)};return(()=>{var i=Ui();return a(i,f(He,{title:"元素信息",icon:"ℹ️",get children(){var s=bt();return a(s,f(ee,{label:"类型",get children(){var l=Ri();return a(l,()=>e.element.content.type),l}}),null),a(s,f(ee,{label:"ID",get children(){var l=Oi();return a(l,()=>e.element.id),l}}),null),s}}),null),a(i,f(He,{title:"位置和大小",icon:"📐",get children(){var s=Ni();return a(s,f(ee,{label:"X",get children(){var l=it();return l.$$input=r=>t("x",parseFloat(r.target.value)||0),N(()=>l.value=e.element.position.x),l}}),null),a(s,f(ee,{label:"Y",get children(){var l=it();return l.$$input=r=>t("y",parseFloat(r.target.value)||0),N(()=>l.value=e.element.position.y),l}}),null),a(s,f(ee,{label:"宽度",get children(){var l=it();return l.$$input=r=>n("width",parseFloat(r.target.value)||1),N(()=>l.value=e.element.size.width),l}}),null),a(s,f(ee,{label:"高度",get children(){var l=it();return l.$$input=r=>n("height",parseFloat(r.target.value)||1),N(()=>l.value=e.element.size.height),l}}),null),s}}),null),a(i,f(He,{title:"状态",icon:"👁️",get children(){var s=bt();return a(s,f(ee,{label:"可见",get children(){var l=It();return l.addEventListener("change",r=>e.onUpdate(e.element.id,"visible",r.target.checked)),N(()=>l.checked=e.element.visible),l}}),null),a(s,f(ee,{label:"锁定",get children(){var l=It();return l.addEventListener("change",r=>e.onUpdate(e.element.id,"locked",r.target.checked)),N(()=>l.checked=e.element.locked),l}}),null),a(s,f(ee,{label:"层级",get children(){var l=it();return l.$$input=r=>e.onUpdate(e.element.id,"z_index",parseInt(r.target.value)||0),N(()=>l.value=e.element.z_index),l}}),null),s}}),null),a(i,f(zn,{get children(){return[f(nt,{get when(){return e.element.content.type==="Text"&&e.element.content},children:s=>(()=>{var l=Bt();return a(l,f(Ft,{get element(){return e.element},get onUpdate(){return e.onUpdate}}),null),a(l,f(fl,{get content(){return s()},onUpdate:r=>{console.log("Text content update:",r),e.onUpdate(e.element.id,"content",r)}}),null),l})()}),f(nt,{get when(){return e.element.content.type==="Rectangle"&&e.element.content},children:s=>f(vl,{get content(){return s()},onUpdate:l=>{console.log("Rectangle content update:",l),e.onUpdate(e.element.id,"content",l)}})}),f(nt,{get when(){return e.element.content.type==="Line"&&e.element.content},children:s=>f(ml,{get content(){return s()},onUpdate:l=>{console.log("Line content update:",l),e.onUpdate(e.element.id,"content",l)}})}),f(nt,{get when(){return e.element.content.type==="Image"&&e.element.content},children:s=>f(yl,{get content(){return s()},onUpdate:l=>{console.log("Image content update:",l),e.onUpdate(e.element.id,"content",l)}})}),f(nt,{get when(){return e.element.content.type==="DataField"&&e.element.content},children:s=>(()=>{var l=Bt();return a(l,f(Ft,{get element(){return e.element},get onUpdate(){return e.onUpdate}}),null),a(l,f(pl,{get content(){return s()},onUpdate:r=>{console.log("DataField content update:",r),e.onUpdate(e.element.id,"content",r)}}),null),l})()})]}}),null),i})()},He=e=>(()=>{var t=Fi(),n=t.firstChild,i=n.firstChild,s=i.nextSibling,l=n.nextSibling;return a(i,()=>e.icon),a(s,()=>e.title),a(l,()=>e.children),t})(),ee=e=>(()=>{var t=Ii(),n=t.firstChild;return a(n,()=>e.label),a(t,()=>e.children,null),t})(),fl=e=>f(He,{title:"文字样式",icon:"🔤",get children(){var t=vn(),n=t.firstChild,i=n.nextSibling;return a(t,f(ee,{label:"内容",get children(){var s=Bi();return s.$$input=l=>e.onUpdate({content:l.target.value}),N(()=>s.value=e.content.content),s}}),n),a(n,f(ee,{label:"字体",get children(){var s=hn();return s.addEventListener("change",l=>e.onUpdate({style:{...e.content.style,font_family:l.target.value}})),N(()=>s.value=e.content.style.font_family),s}}),null),a(n,f(ee,{label:"大小",get children(){return f(Be,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:s=>e.onUpdate({style:{...e.content.style,font_size:s}})})}}),null),a(i,f(ee,{label:"字重",get children(){var s=gn();return s.addEventListener("change",l=>e.onUpdate({style:{...e.content.style,font_weight:l.target.value}})),N(()=>s.value=e.content.style.font_weight),s}}),null),a(i,f(ee,{label:"对齐",get children(){return f(yn,{get value(){return e.content.style.align},onUpdate:s=>e.onUpdate({style:{...e.content.style,align:s}})})}}),null),a(t,f(ee,{label:"颜色",get children(){return f(qe,{get value(){return e.content.style.color},onUpdate:s=>e.onUpdate({style:{...e.content.style,color:s}})})}}),null),a(t,f(ee,{label:"背景",get children(){var s=ji(),l=s.firstChild;return a(s,f(qe,{get value(){var r;return((r=e.content.style.background)==null?void 0:r.color)||"transparent"},onUpdate:r=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,color:r}}})}),l),a(l,f(ee,{label:"透明度",get children(){return f(Be,{get value(){var r;return((r=e.content.style.background)==null?void 0:r.opacity)||1},min:0,max:1,step:.1,onUpdate:r=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,opacity:r}}})})}}),null),a(l,f(ee,{label:"内边距",get children(){return f(Be,{get value(){var r;return((r=e.content.style.background)==null?void 0:r.padding)||0},min:0,max:20,step:1,unit:"px",onUpdate:r=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,padding:r}}})})}}),null),s}}),null),a(t,f(ee,{label:"边框",get children(){var s=Hi(),l=s.firstChild;return a(s,f(qe,{get value(){var r;return((r=e.content.style.border)==null?void 0:r.color)||"#000000"},onUpdate:r=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,color:r}}})}),l),a(l,f(ee,{label:"宽度",get children(){return f(Be,{get value(){var r;return((r=e.content.style.border)==null?void 0:r.width)||1},min:0,max:10,step:.5,unit:"px",onUpdate:r=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,width:r}}})})}}),null),a(l,f(ee,{label:"样式",get children(){var r=fn();return r.addEventListener("change",o=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,style:o.target.value}}})),N(()=>{var o;return r.value=((o=e.content.style.border)==null?void 0:o.style)||"Solid"}),r}}),null),a(l,f(ee,{label:"圆角",get children(){return f(Be,{get value(){var r;return((r=e.content.style.border)==null?void 0:r.radius)||0},min:0,max:20,step:1,unit:"px",onUpdate:r=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,radius:r}}})})}}),null),s}}),null),t}}),vl=e=>f(He,{title:"矩形样式",icon:"▭",get children(){var t=Ji(),n=t.firstChild,i=n.firstChild;return a(t,f(ee,{label:"填充颜色",get children(){return f(qe,{get value(){return e.content.fill_color||"#ffffff"},onUpdate:s=>e.onUpdate({fill_color:s})})}}),n),a(n,f(ee,{label:"边框",get children(){var s=bt();return a(s,f(qe,{get value(){var l;return((l=e.content.border)==null?void 0:l.color)||"#000000"},onUpdate:l=>e.onUpdate({border:{...e.content.border,color:l}})})),s}}),i),a(i,f(ee,{label:"宽度",get children(){return f(Be,{get value(){var s;return((s=e.content.border)==null?void 0:s.width)||1},min:0,max:20,step:.5,unit:"px",onUpdate:s=>e.onUpdate({border:{...e.content.border,width:s}})})}}),null),a(i,f(ee,{label:"样式",get children(){var s=fn();return s.addEventListener("change",l=>e.onUpdate({border:{...e.content.border,style:l.target.value}})),N(()=>{var l;return s.value=((l=e.content.border)==null?void 0:l.style)||"Solid"}),s}}),null),a(t,f(ee,{label:"圆角半径",get children(){return f(Be,{get value(){return e.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:s=>e.onUpdate({corner_radius:s})})}}),null),a(t,f(ee,{label:"透明度",get children(){var s=mn(),l=s.firstChild,r=l.nextSibling,o=r.firstChild;return l.$$input=u=>e.onUpdate({opacity:parseFloat(u.target.value)/100}),a(r,()=>Math.round((e.content.opacity||1)*100),o),N(()=>l.value=(e.content.opacity||1)*100),s}}),null),t}}),ml=e=>f(He,{title:"线条样式",icon:"━",get children(){var t=Wi(),n=t.firstChild;return a(t,f(ee,{label:"颜色",get children(){return f(qe,{get value(){return e.content.color},onUpdate:i=>e.onUpdate({color:i})})}}),n),a(t,f(ee,{label:"宽度",get children(){return f(Be,{get value(){return e.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:i=>e.onUpdate({width:i})})}}),n),a(t,f(ee,{label:"样式",get children(){var i=Vi();return i.addEventListener("change",s=>e.onUpdate({line_style:s.target.value})),N(()=>i.value=e.content.line_style||"Solid"),i}}),n),a(n,f(ee,{label:"起点",get children(){var i=jt();return i.addEventListener("change",s=>e.onUpdate({start_cap:s.target.value})),N(()=>i.value=e.content.start_cap||"None"),i}}),null),a(n,f(ee,{label:"终点",get children(){var i=jt();return i.addEventListener("change",s=>e.onUpdate({end_cap:s.target.value})),N(()=>i.value=e.content.end_cap||"None"),i}}),null),a(t,f(ee,{label:"透明度",get children(){var i=mn(),s=i.firstChild,l=s.nextSibling,r=l.firstChild;return s.$$input=o=>e.onUpdate({opacity:parseFloat(o.target.value)/100}),a(l,()=>Math.round((e.content.opacity||1)*100),r),N(()=>s.value=(e.content.opacity||1)*100),i}}),null),t}}),yl=e=>f(He,{title:"图片属性",icon:"🖼️",get children(){var t=Xi();return a(t,f(ee,{label:"图片地址",get children(){var n=qi();return n.$$input=i=>e.onUpdate({src:i.target.value}),N(()=>n.value=e.content.src),n}}),null),a(t,f(ee,{label:"替代文本",get children(){var n=Ki();return n.$$input=i=>e.onUpdate({alt:i.target.value}),N(()=>n.value=e.content.alt||""),n}}),null),a(t,f(ee,{label:"预览",get children(){var n=Gi(),i=n.firstChild;return a(n,(()=>{var s=se(()=>!!e.content.src);return()=>s()?(()=>{var l=Yi();return l.addEventListener("load",r=>{const o=r.target,u=o.nextElementSibling;o&&(o.style.display="block"),u&&(u.style.display="none")}),l.addEventListener("error",r=>{const o=r.target,u=o.nextElementSibling;o&&(o.style.display="none"),u&&(u.style.display="flex")}),N(r=>{var o=e.content.src,u=e.content.alt||"图片预览";return o!==r.e&&z(l,"src",r.e=o),u!==r.t&&z(l,"alt",r.t=u),r},{e:void 0,t:void 0}),l})():null})(),i),N(s=>(s=e.content.src?"none":"flex")!=null?i.style.setProperty("display",s):i.style.removeProperty("display")),n}}),null),t}}),pl=e=>{const[t,n]=q([]),[i,s]=q(!1);Je(async()=>{try{s(!0);const o=await Se.listDataSources();n(o)}catch(o){console.error("Failed to load data sources:",o)}finally{s(!1)}});const l=o=>{e.onUpdate({data_source_id:o===""?void 0:o})},r=xe(()=>e.content.data_source_id?t().find(o=>o.id===e.content.data_source_id):null);return(()=>{var o=ll();return a(o,f(He,{title:"数据源配置",icon:"🔗",get children(){var u=bt();return a(u,f(ee,{label:"数据源",get children(){return f(U,{get when(){return i()},get fallback(){return(()=>{var c=sl();return c.firstChild,c.addEventListener("change",v=>l(v.currentTarget.value)),a(c,f(fe,{get each(){return t()},children:v=>(()=>{var d=rl(),g=d.firstChild,m=g.nextSibling;return m.nextSibling,a(d,()=>v.name,g),a(d,()=>v.provider_type,m),N(()=>d.value=v.id),d})()}),null),N(()=>c.value=e.content.data_source_id||""),c})()},get children(){return Zi()}})}}),null),a(u,f(U,{get when(){return r()},get children(){var c=Qi(),v=c.firstChild,d=v.firstChild,g=d.firstChild,m=g.nextSibling,h=m.nextSibling,y=d.nextSibling,$=y.firstChild;$.nextSibling;var b=y.nextSibling,k=b.firstChild;return k.nextSibling,a(h,(()=>{var S=se(()=>r().status==="active");return()=>S()?"活跃":r().status==="error"?"错误":"禁用"})()),a(y,()=>r().provider_type,null),a(b,()=>new Date(r().last_updated).toLocaleString("zh-CN"),null),N(()=>me(h,r().status==="active"?"text-green-600":r().status==="error"?"text-red-600":"text-gray-600")),c}}),null),a(u,f(ee,{label:"表达式",get children(){var c=el();return c.$$input=v=>e.onUpdate({expression:v.currentTarget.value}),c.disabled=!1,N(()=>c.value=e.content.expression||""),c}}),null),a(u,f(U,{get when(){return!e.content.expression||!e.content.expression.trim()},get children(){return tl()}}),null),a(u,f(U,{get when(){return e.content.expression&&!e.content.data_source_id},get children(){return nl()}}),null),a(u,f(ee,{label:"格式",get children(){var c=il();return c.addEventListener("change",v=>e.onUpdate({format:v.currentTarget.value==="default"?void 0:v.currentTarget.value})),N(()=>c.value=e.content.format||"default"),c}}),null),u}}),null),a(o,f(He,{title:"字段样式",icon:"🎨",get children(){var u=vn(),c=u.firstChild,v=c.nextSibling;return a(c,f(ee,{label:"字体",get children(){var d=hn();return d.addEventListener("change",g=>e.onUpdate({style:{...e.content.style,font_family:g.currentTarget.value}})),N(()=>d.value=e.content.style.font_family),d}}),null),a(c,f(ee,{label:"大小",get children(){return f(Be,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:d=>e.onUpdate({style:{...e.content.style,font_size:d}})})}}),null),a(v,f(ee,{label:"字重",get children(){var d=gn();return d.addEventListener("change",g=>e.onUpdate({style:{...e.content.style,font_weight:g.currentTarget.value}})),N(()=>d.value=e.content.style.font_weight),d}}),null),a(v,f(ee,{label:"对齐",get children(){return f(yn,{get value(){return e.content.style.align},onUpdate:d=>e.onUpdate({style:{...e.content.style,align:d}})})}}),null),a(u,f(ee,{label:"颜色",get children(){return f(qe,{get value(){return e.content.style.color},onUpdate:d=>e.onUpdate({style:{...e.content.style,color:d}})})}}),null),u}}),null),o})()},Be=e=>(()=>{var t=al(),n=t.firstChild;return n.addEventListener("blur",i=>{const s=parseFloat(i.target.value)||e.value,l=Math.max(e.min||-1/0,Math.min(e.max||1/0,s));l!==s&&(i.target.value=l.toString(),e.onUpdate(l))}),n.$$input=i=>{const s=parseFloat(i.target.value);if(!isNaN(s)){const l=Math.max(e.min||-1/0,Math.min(e.max||1/0,s));e.onUpdate(l)}},a(t,(()=>{var i=se(()=>!!e.unit);return()=>i()&&(()=>{var s=ol();return a(s,()=>e.unit),s})()})(),null),N(i=>{var s=e.min,l=e.max,r=e.step||1;return s!==i.e&&z(n,"min",i.e=s),l!==i.t&&z(n,"max",i.t=l),r!==i.a&&z(n,"step",i.a=r),i},{e:void 0,t:void 0,a:void 0}),N(()=>n.value=e.value),t})(),qe=e=>(()=>{var t=cl(),n=t.firstChild,i=n.firstChild,s=i.nextSibling,l=n.nextSibling;return i.$$input=r=>e.onUpdate(r.target.value),l.$$input=r=>{const o=r.target.value;(/^#[0-9A-Fa-f]{6}$/.test(o)||/^#[0-9A-Fa-f]{3}$/.test(o))&&e.onUpdate(o)},N(r=>(r=e.value)!=null?s.style.setProperty("background-color",r):s.style.removeProperty("background-color")),N(()=>i.value=e.value),N(()=>l.value=e.value),t})(),yn=e=>{const t=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var n=dl();return a(n,()=>t.map(i=>(()=>{var s=ul();return s.$$click=()=>e.onUpdate(i.value),a(s,()=>i.icon),N(l=>{var r=`property-alignment-btn ${e.value===i.value?"active":""}`,o=i.label;return r!==l.e&&me(s,l.e=r),o!==l.t&&z(s,"title",l.t=o),l},{e:void 0,t:void 0}),s})())),n})()};Re(["input","click"]);var bl=p("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),$l=p("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const _l=e=>f(U,{get when(){return e.config.show_grid},get children(){return[(()=>{var t=bl(),n=t.firstChild,i=n.firstChild,s=i.nextSibling;return N(l=>{var r=e.config.grid_size,o=e.config.grid_size,u=e.config.grid_size,c=e.config.grid_size,v=e.config.grid_size,d=e.config.grid_size,g=e.config.grid_size,m=e.config.grid_size;return r!==l.e&&z(n,"width",l.e=r),o!==l.t&&z(n,"height",l.t=o),u!==l.a&&z(i,"x1",l.a=u),c!==l.o&&z(i,"x2",l.o=c),v!==l.i&&z(i,"y2",l.i=v),d!==l.n&&z(s,"y1",l.n=d),g!==l.s&&z(s,"x2",l.s=g),m!==l.h&&z(s,"y2",l.h=m),l},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),t})(),(()=>{var t=$l();return N(n=>{var i=e.config.width,s=e.config.height;return i!==n.e&&z(t,"width",n.e=i),s!==n.t&&z(t,"height",n.t=s),n},{e:void 0,t:void 0}),t})()]}});class xl{constructor(){Ue(this,"expressionCache",new Map);Ue(this,"maxCacheSize",1e3)}async evaluateExpression(t,n){if(!t||!t.trim())return{success:!1,error:"表达式不能为空"};if(!n)return{success:!1,error:"没有可用的数据上下文"};try{const i=this.preprocessExpression(t),s=this.getCompiledExpression(i),l=await this.executeCompiledExpression(s,n);return{success:!0,value:l.value,type:this.inferValueType(l.value)}}catch(i){return{success:!1,error:i instanceof Error?i.message:String(i)}}}validateExpression(t,n){if(!t||!t.trim())return{valid:!1,error:"表达式不能为空"};try{const i=this.preprocessExpression(t),s=this.compileExpression(i);return this.staticValidation(s,n)}catch(i){return{valid:!1,error:i instanceof Error?i.message:"表达式格式错误"}}}getFieldSuggestions(t,n){if(!n)return[];const i=t.toLowerCase().replace(/[{}]/g,""),s=[];if(n.fields.forEach(l=>{l.name.toLowerCase().includes(i)&&s.push(`{${l.name}}`),l.displayName&&l.displayName.toLowerCase().includes(i)&&s.push(`{${l.name}}`)}),n.currentRecord.data){const l=this.getNestedFieldSuggestions(i,n.currentRecord.data,"");s.push(...l)}return Array.from(new Set(s)).sort((l,r)=>{const o=l.replace(/[{}]/g,""),u=r.replace(/[{}]/g,"");return o===i?-1:u===i?1:o.startsWith(i)?-1:u.startsWith(i)?1:o.localeCompare(u)}).slice(0,20)}preprocessExpression(t){let n=t.trim();return!n.startsWith("{")&&!n.endsWith("}")&&(n=`{${n}}`),n=n.replace(/^\{+/,"{").replace(/\}+$/,"}"),n}getCompiledExpression(t){let n=this.expressionCache.get(t);if(!n){if(n=this.compileExpression(t),this.expressionCache.size>=this.maxCacheSize){const i=this.expressionCache.keys().next().value;i&&this.expressionCache.delete(i)}this.expressionCache.set(t,n)}return n}compileExpression(t){const n=t.slice(1,-1),i=this.parsePath(n);return{original:t,path:i,type:this.determineExpressionType(i)}}parsePath(t){const n=[];let i="",s=!1;for(let l=0;l<t.length;l++){const r=t[l];if(r==="["&&!s)i&&(n.push({type:"field",value:i}),i=""),s=!0;else if(r==="]"&&s){const o=parseInt(i,10);if(isNaN(o))throw new Error(`无效的数组索引: ${i}`);n.push({type:"index",value:o}),i="",s=!1}else r==="."&&!s?i&&(n.push({type:"field",value:i}),i=""):i+=r}if(i){if(s)throw new Error("未闭合的数组索引");n.push({type:"field",value:i})}if(n.length===0)throw new Error("空的字段路径");return n}async executeCompiledExpression(t,n){let i=n.currentRecord.data;for(const s of t.path){if(i==null)throw new Error("无法访问 null/undefined 值的属性");if(s.type==="field"){if(typeof i!="object")throw new Error(`尝试访问非对象类型的字段: ${s.value}`);if(!(s.value in i))throw new Error(`字段不存在: ${s.value}`);i=i[s.value]}else if(s.type==="index"){if(!Array.isArray(i))throw new Error("尝试对非数组类型使用索引访问");const l=s.value;if(l<0||l>=i.length)throw new Error(`数组索引超出范围: ${l}`);i=i[l]}}return{value:i}}staticValidation(t,n){if(!n)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const i=[],s=t.path[0];if(s&&s.type==="field"){const r=s.value;if(!n.fields.some(u=>u.name===r)){const u=n.fields.filter(c=>c.name.toLowerCase().includes(r.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),r.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${r}`,suggestions:u}}}t.path.length>5&&i.push("表达式路径过深，可能影响性能");const l={valid:!0};return i.length>0&&(l.warnings=i),l}getNestedFieldSuggestions(t,n,i){const s=[];if(!n||typeof n!="object")return s;for(const l of Object.keys(n)){const r=i?`${i}.${l}`:l;r.toLowerCase().includes(t)&&s.push(`{${r}}`),i.split(".").length<3&&n[l]&&typeof n[l]=="object"&&s.push(...this.getNestedFieldSuggestions(t,n[l],r))}return s}inferValueType(t){return t==null?"object":typeof t=="string"?"string":typeof t=="number"?"number":typeof t=="boolean"?"boolean":t instanceof Date?"date":typeof t=="object"?"object":"string"}determineExpressionType(t){return t.length===1?"simple":t.length<=3&&t.every(n=>n.type==="field")?"nested":"complex"}levenshteinDistance(t,n){if(t.length===0)return n.length;if(n.length===0)return t.length;const i=new Array(n.length+1);for(let s=0;s<=n.length;s++)i[s]=new Array(t.length+1),i[s][0]=s;for(let s=0;s<=t.length;s++)i[0][s]=s;for(let s=1;s<=n.length;s++)for(let l=1;l<=t.length;l++){const r=t[l-1]===n[s-1]?0:1;i[s][l]=Math.min(i[s-1][l]+1,i[s][l-1]+1,i[s-1][l-1]+r)}return i[n.length][t.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const Ct=new xl;class wl{constructor(){Ue(this,"context",q(null));Ue(this,"subscribers",[]);this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(t){try{const i=(await Se.listDataSources()).find(c=>c.id===t);if(!i)throw new Error(`数据源不存在: ${t}`);console.log("🔍 找到数据源:",i);const s=i.provider_type||i.type_name||"json";console.log("🔍 推断的 providerType:",s);const l=await Se.getPreview(t,void 0,1);console.log("🔍 预览数据:",l);const r=await Se.getSchema(t);console.log("🔍 Schema信息:",r);const o=r.columns.map(c=>({name:c.name,displayName:c.description||c.name,type:this.mapDataType(c.data_type),nullable:c.nullable,sample:c.default_value})),u={dataSource:{id:t,type:this.inferDataSourceType(s),name:i.name,status:this.mapDataSourceStatus(i.status)},currentRecord:{index:0,total:l.total_rows,data:l.rows[0]||{}},fields:o};console.log("✅ 创建新的数据上下文:",u),this.context[1](u),this.notifySubscribers(u)}catch(n){console.error("设置数据源失败:",n);const i={dataSource:{id:t,type:"json",name:"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:n instanceof Error?n.message:"数据源加载失败",details:n}};this.context[1](i),this.notifySubscribers(i)}}async navigateToRecord(t){const n=this.getCurrentContext();if(!n||t<0||t>=n.currentRecord.total)return!1;try{const i=await Se.queryData(n.dataSource.id,{limit:1,offset:t});if(i.rows.length===0)return!1;const s={...n,currentRecord:{...n.currentRecord,index:t,data:i.rows[0]}};return this.context[1](s),this.notifySubscribers(s),!0}catch(i){return console.error("导航到记录失败:",i),!1}}async navigateNext(){const t=this.getCurrentContext();return t?this.navigateToRecord(t.currentRecord.index+1):!1}async navigatePrevious(){const t=this.getCurrentContext();return t?this.navigateToRecord(t.currentRecord.index-1):!1}async evaluateExpression(t){const n=this.getCurrentContext();return await Ct.evaluateExpression(t,n)}validateExpression(t){const n=this.getCurrentContext(),i=Ct.validateExpression(t,n);return{valid:i.valid,...i.error&&{error:i.error},...i.suggestions&&{suggestions:i.suggestions}}}getFieldSuggestions(t){const n=this.getCurrentContext();return Ct.getFieldSuggestions(t,n)}subscribe(t){return this.subscribers.push(t),()=>{const n=this.subscribers.indexOf(t);n>-1&&this.subscribers.splice(n,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(t){this.subscribers.forEach(n=>{try{n(t)}catch(i){console.error("数据上下文订阅回调错误:",i)}})}inferDataSourceType(t){if(!t)return console.warn("providerType is undefined, defaulting to json"),"json";switch(t.toLowerCase()){case"json":return"json";case"excel":return"excel";case"sql":return"sql";case"xml":return"xml";case"csv":return"csv";default:return"json"}}mapDataType(t){switch(t){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(t){if(!t)return console.warn("status is undefined, defaulting to empty"),"empty";switch(t.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${t}, defaulting to empty`),"empty"}}}const Ye=new wl;var Sl=p("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),Ht=p("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),Cl=p("<svg><rect class=text-background-unified></svg>",!1,!0,!1),kl=p("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),El=p("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),Al=p("<svg><tspan class=text-line-original></svg>",!1,!0,!1),Pl=p("<svg><rect x=0 y=0></svg>",!1,!0,!1),Dl=p("<svg><line x1=0></svg>",!1,!0,!1),Tl=p("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),zl=p('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),Ll=p("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),Ml=p("<svg><tspan dy=0></svg>",!1,!0,!1),Rl=p("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),Ol=p("<svg><g></svg>",!1,!0,!1);const Nl=e=>{const{state:t}=rn(),[n,i]=q("[数据字段]");Tt(()=>{if(e.element.content.type==="DataField"){const r=e.element.content.expression||"",o=t().mode;wt.shouldShowExpression(o)?i(r||"[数据字段]"):wt.shouldEvaluateExpression(o)&&Ye.evaluateExpression(r).then(u=>{u.success?i(String(u.value||"")):i(`[错误: ${u.error}]`)}).catch(u=>{i(`[错误: ${u}]`)})}});const s=xe(()=>{const{position:r}=e.element;return{transform:`translate(${r.x}px, ${r.y}px)`,opacity:e.element.visible?1:.5}}),l=()=>{const{content:r,size:o}=e.element;if(r.type==="Text"&&r.content&&r.style){const u=Xe.calculateUnifiedBounds(r.content,r.style,o),c=Xe.getTextAnchor(r.style.align);return(()=>{var v=Sl(),d=v.firstChild;return a(v,(()=>{var g=se(()=>!!e.selected);return()=>g()&&(()=>{var m=Ht();return N(h=>{var y=u.containerBounds.x,$=u.containerBounds.y,b=u.containerBounds.width,k=u.containerBounds.height;return y!==h.e&&z(m,"x",h.e=y),$!==h.t&&z(m,"y",h.t=$),b!==h.a&&z(m,"width",h.a=b),k!==h.o&&z(m,"height",h.o=k),h},{e:void 0,t:void 0,a:void 0,o:void 0}),m})()})(),d),a(v,(()=>{var g=se(()=>!!r.style.background);return()=>g()&&(()=>{var m=Cl();return N(h=>{var R,O;var y=u.positioning.backgroundX,$=u.positioning.backgroundY,b=u.containerBounds.width+(r.style.background.padding||0)*2,k=u.containerBounds.height+(r.style.background.padding||0)*2,S=r.style.background.color,A=r.style.background.opacity||1,T=((R=r.style.border)==null?void 0:R.radius)||0,E=((O=r.style.border)==null?void 0:O.radius)||0;return y!==h.e&&z(m,"x",h.e=y),$!==h.t&&z(m,"y",h.t=$),b!==h.a&&z(m,"width",h.a=b),k!==h.o&&z(m,"height",h.o=k),S!==h.i&&z(m,"fill",h.i=S),A!==h.n&&z(m,"fill-opacity",h.n=A),T!==h.s&&z(m,"rx",h.s=T),E!==h.h&&z(m,"ry",h.h=E),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),m})()})(),d),a(v,(()=>{var g=se(()=>!!r.style.border);return()=>g()&&(()=>{var m=kl();return N(h=>{var O,W;var y=u.positioning.backgroundX,$=u.positioning.backgroundY,b=u.containerBounds.width+(((O=r.style.background)==null?void 0:O.padding)||0)*2,k=u.containerBounds.height+(((W=r.style.background)==null?void 0:W.padding)||0)*2,S=r.style.border.color,A=r.style.border.width,T=r.style.border.style==="Dashed"?"5,5":r.style.border.style==="Dotted"?"2,2":"none",E=r.style.border.radius||0,R=r.style.border.radius||0;return y!==h.e&&z(m,"x",h.e=y),$!==h.t&&z(m,"y",h.t=$),b!==h.a&&z(m,"width",h.a=b),k!==h.o&&z(m,"height",h.o=k),S!==h.i&&z(m,"stroke",h.i=S),A!==h.n&&z(m,"stroke-width",h.n=A),T!==h.s&&z(m,"stroke-dasharray",h.s=T),E!==h.h&&z(m,"rx",h.h=E),R!==h.r&&z(m,"ry",h.r=R),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),m})()})(),d),z(d,"text-anchor",c),a(d,(()=>{var g=se(()=>{var m;return!!((m=u.textLayout)!=null&&m.isWrapped)});return()=>g()?u.textLayout.wrappedLines.map((m,h)=>(()=>{var y=El();return a(y,m),N($=>{var b=u.positioning.textAnchorX,k=h===0?0:u.fontMetrics.lineHeight;return b!==$.e&&z(y,"x",$.e=b),k!==$.t&&z(y,"dy",$.t=k),$},{e:void 0,t:void 0}),y})()):r.content.split(`
`).map((m,h)=>(()=>{var y=Al();return a(y,m),N($=>{var b=u.positioning.textAnchorX,k=h===0?0:u.fontMetrics.lineHeight;return b!==$.e&&z(y,"x",$.e=b),k!==$.t&&z(y,"dy",$.t=k),$},{e:void 0,t:void 0}),y})())})()),N(g=>{var m=u.positioning.textAnchorX,h=u.positioning.textAnchorY,y=r.style.font_family,$=r.style.font_size.toString(),b=r.style.font_weight,k=r.style.color;return m!==g.e&&z(d,"x",g.e=m),h!==g.t&&z(d,"y",g.t=h),y!==g.a&&z(d,"font-family",g.a=y),$!==g.o&&z(d,"font-size",g.o=$),b!==g.i&&z(d,"font-weight",g.i=b),k!==g.n&&z(d,"fill",g.n=k),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),v})()}if(r.type==="Rectangle"){const u=r.opacity!==void 0?r.opacity:1,c=r.corner_radius||0;return(()=>{var v=Pl();return z(v,"rx",c),z(v,"ry",c),z(v,"fill-opacity",u),z(v,"stroke-opacity",u),N(d=>{var k,S,A,T;var g=o.width,m=o.height,h=r.fill_color||"transparent",y=((k=r.border)==null?void 0:k.color)||"#000000",$=((S=r.border)==null?void 0:S.width)||1,b=((A=r.border)==null?void 0:A.style)==="Dashed"?"5,5":((T=r.border)==null?void 0:T.style)==="Dotted"?"2,2":"none";return g!==d.e&&z(v,"width",d.e=g),m!==d.t&&z(v,"height",d.t=m),h!==d.a&&z(v,"fill",d.a=h),y!==d.o&&z(v,"stroke",d.o=y),$!==d.i&&z(v,"stroke-width",d.i=$),b!==d.n&&z(v,"stroke-dasharray",d.n=b),d},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),v})()}if(r.type==="Line"){const u=r.opacity!==void 0?r.opacity:1,c=r.line_style||"Solid",v=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var d=Dl();return z(d,"stroke-opacity",u),z(d,"stroke-dasharray",v),N(g=>{var m=o.height/2,h=o.width,y=o.height/2,$=r.color,b=r.width;return m!==g.e&&z(d,"y1",g.e=m),h!==g.t&&z(d,"x2",g.t=h),y!==g.a&&z(d,"y2",g.a=y),$!==g.o&&z(d,"stroke",g.o=$),b!==g.i&&z(d,"stroke-width",g.i=b),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),d})()}if(r.type==="DataField"&&r.style){const u=n(),c=Xe.calculateUnifiedBounds(u,r.style,o),v=Xe.getTextAnchor(r.style.align);return(()=>{var d=Tl(),g=d.firstChild;return a(d,(()=>{var m=se(()=>!!e.selected);return()=>m()&&(()=>{var h=Ht();return N(y=>{var $=c.containerBounds.x,b=c.containerBounds.y,k=c.containerBounds.width,S=c.containerBounds.height;return $!==y.e&&z(h,"x",y.e=$),b!==y.t&&z(h,"y",y.t=b),k!==y.a&&z(h,"width",y.a=k),S!==y.o&&z(h,"height",y.o=S),y},{e:void 0,t:void 0,a:void 0,o:void 0}),h})()})(),g),a(d,(()=>{var m=se(()=>!!wt.shouldShowExpression(t().mode));return()=>m()&&(()=>{var h=zl(),y=h.firstChild,$=y.nextSibling;return N(b=>{var k=c.containerBounds.x+c.containerBounds.width-8,S=c.containerBounds.y+8,A=c.containerBounds.x+c.containerBounds.width-8,T=c.containerBounds.y+8;return k!==b.e&&z(y,"cx",b.e=k),S!==b.t&&z(y,"cy",b.t=S),A!==b.a&&z($,"x",b.a=A),T!==b.o&&z($,"y",b.o=T),b},{e:void 0,t:void 0,a:void 0,o:void 0}),h})()})(),g),z(g,"text-anchor",v),a(g,(()=>{var m=se(()=>{var h;return!!((h=c.textLayout)!=null&&h.isWrapped)});return()=>m()?c.textLayout.wrappedLines.map((h,y)=>(()=>{var $=Ll();return a($,h),N(b=>{var k=c.positioning.textAnchorX,S=y===0?0:c.fontMetrics.lineHeight;return k!==b.e&&z($,"x",b.e=k),S!==b.t&&z($,"dy",b.t=S),b},{e:void 0,t:void 0}),$})()):(()=>{var h=Ml();return a(h,u),N(()=>z(h,"x",c.positioning.textAnchorX)),h})()})()),N(m=>{var h=t().mode,y=c.positioning.textAnchorX,$=c.positioning.textAnchorY,b=r.style.font_family,k=r.style.font_size.toString(),S=r.style.font_weight,A=u.startsWith("[错误:")?"#ff4d4f":r.style.color,T=`datafield-content-unified ${t().mode}-mode`;return h!==m.e&&z(d,"data-preview-mode",m.e=h),y!==m.t&&z(g,"x",m.t=y),$!==m.a&&z(g,"y",m.a=$),b!==m.o&&z(g,"font-family",m.o=b),k!==m.i&&z(g,"font-size",m.i=k),S!==m.n&&z(g,"font-weight",m.n=S),A!==m.s&&z(g,"fill",m.s=A),T!==m.h&&z(g,"class",m.h=T),m},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d})()}return(()=>{var u=Rl();return N(c=>{var v=o.width,d=o.height;return v!==c.e&&z(u,"width",c.e=v),d!==c.t&&z(u,"height",c.t=d),c},{e:void 0,t:void 0}),u})()};return(()=>{var r=Ol();return a(r,l),N(o=>{var u=`element ${e.selected&&e.element.content.type!=="Text"&&e.element.content.type!=="DataField"?"element-selected":""}`,c=s(),v=e.element.id,d=e.element.content.type;return u!==o.e&&z(r,"class",o.e=u),o.t=nn(r,c,o.t),v!==o.a&&z(r,"data-element-id",o.a=v),d!==o.o&&z(r,"data-element-type",o.o=d),o},{e:void 0,t:void 0,a:void 0,o:void 0}),r})()};var Ul=p("<svg><g class=resize-handles></svg>",!1,!0,!1),Fl=p("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const Il=e=>{const{updateElement:t,setResizeOperation:n}=We(),[i,s]=q(!1),[l,r]=q(null),[o,u]=q({x:0,y:0}),[c,v]=q({width:0,height:0}),[d,g]=q({x:0,y:0}),[m,h]=q({width:0,height:0}),[y,$]=q({x:0,y:0}),[b,k]=q(!1),S=xe(()=>{const{position:I,size:F,content:P}=e.element,V=8/2;let x={x:I.x,y:I.y,width:F.width,height:F.height};if((P.type==="Text"||P.type==="DataField")&&P.style){const ne=P.type==="Text"?P.content:P.expression||"[数据字段]",J=Xe.calculateUnifiedBounds(ne,P.style,F);x={x:I.x+J.containerBounds.x,y:I.y+J.containerBounds.y,width:J.containerBounds.width,height:J.containerBounds.height}}const w=x.x,L=x.y,j=x.x+x.width,B=x.y+x.height,G=x.x+x.width/2,ce=x.y+x.height/2;return[{position:"nw",cursor:"nw-resize",x:w-V,y:L-V},{position:"ne",cursor:"ne-resize",x:j-V,y:L-V},{position:"sw",cursor:"sw-resize",x:w-V,y:B-V},{position:"se",cursor:"se-resize",x:j-V,y:B-V},{position:"n",cursor:"n-resize",x:G-V,y:L-V},{position:"s",cursor:"s-resize",x:G-V,y:B-V},{position:"w",cursor:"w-resize",x:w-V,y:ce-V},{position:"e",cursor:"e-resize",x:j-V,y:ce-V}]}),A=(I,F,P,K=!1,V=!1)=>{const x=c(),w=d();let L=x.width,j=x.height,B=w.x,G=w.y;switch(I){case"nw":L=x.width-F,j=x.height-P,B=w.x+F,G=w.y+P;break;case"ne":L=x.width+F,j=x.height-P,G=w.y+P;break;case"sw":L=x.width-F,j=x.height+P,B=w.x+F;break;case"se":L=x.width+F,j=x.height+P;break;case"n":j=x.height-P,G=w.y+P;break;case"s":j=x.height+P;break;case"w":L=x.width-F,B=w.x+F;break;case"e":L=x.width+F;break}if(K&&(I==="nw"||I==="ne"||I==="sw"||I==="se")){const ne=x.width/x.height;L/j>ne?(L=j*ne,(I==="nw"||I==="sw")&&(B=w.x+(x.width-L))):(j=L/ne,(I==="nw"||I==="ne")&&(G=w.y+(x.height-j)))}if(V){const ne=w.x+x.width/2,J=w.y+x.height/2;B=ne-L/2,G=J-j/2}const ce=20;return L=Math.max(ce,L),j=Math.max(ce,j),{size:{width:L,height:j},position:{x:B,y:G}}},T=I=>(I.preventDefault(),I.stopPropagation(),I.stopImmediatePropagation(),!1),E=(I,F)=>{var P;n(!0),document.addEventListener("click",T,{capture:!0}),s(!0),r(I),u({x:F.clientX,y:F.clientY}),v({width:e.element.size.width,height:e.element.size.height}),g({x:e.element.position.x,y:e.element.position.y}),h(e.element.size),$(e.element.position),k(!1),document.addEventListener("mousemove",O),document.addEventListener("mouseup",W),document.body.style.cursor=((P=S().find(K=>K.position===I))==null?void 0:P.cursor)||"default"};let R=0;const O=I=>{if(!i())return;const F=l();if(!F)return;const P=o(),K=I.clientX-P.x,V=I.clientY-P.y,x=A(F,K,V,I.shiftKey,I.altKey);h(x.size),$(x.position),k(Math.abs(K)>2||Math.abs(V)>2);const w=Date.now();if(w-R>50)try{t(e.element.id,{size:x.size,position:x.position}),R=w}catch{}},W=()=>{if(!i()||!l())return;const F=()=>{document.removeEventListener("click",T,{capture:!0}),n(!1),s(!1),r(null),document.body.style.cursor="default",document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",W)};if(b()){const P=m(),K=y();t(e.element.id,{size:P,position:K}).catch(V=>{t(e.element.id,{size:c(),position:d()}).catch(x=>{})})}F()};return _t(()=>{n(!1),document.removeEventListener("click",T,{capture:!0}),document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",W),document.body.style.cursor="default"}),(()=>{var I=Ul();return a(I,()=>S().map(F=>(()=>{var P=Fl(),K=P.firstChild,V=K.nextSibling;return V.addEventListener("mouseleave",x=>{i()||(document.body.style.cursor="default")}),V.addEventListener("mouseenter",x=>{i()||(document.body.style.cursor=F.cursor)}),V.$$mousedown=x=>{x.stopPropagation(),x.preventDefault(),E(F.position,x)},V.style.setProperty("pointer-events","all"),N(x=>{var w=F.x+4,L=F.y+4,j=F.x,B=F.y,G=F.cursor;return w!==x.e&&z(K,"cx",x.e=w),L!==x.t&&z(K,"cy",x.t=L),j!==x.a&&z(V,"x",x.a=j),B!==x.o&&z(V,"y",x.o=B),G!==x.i&&((x.i=G)!=null?V.style.setProperty("cursor",G):V.style.removeProperty("cursor")),x},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),P})())),I})()};Re(["mousedown"]);var Oe=(e=>(e.IDLE="idle",e.HOVER="hover",e.SELECTING="selecting",e.DRAGGING="dragging",e))(Oe||{});const Bl={dragThreshold:3,updateThrottle:16};var jl=p("<div tabindex=0>"),Hl=p("<div>"),Jl=p("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),Vl=p("<div>拖拽: <!>个元素"),Wl=p("<div>[<!>]");const ql=e=>{const{resizeOperation:t,setResizeOperation:n}=We(),i=Bl;let s;const[l,r]=q(Oe.IDLE),[o,u]=q([]),[c,v]=q(null),[d,g]=q(null),[m,h]=q(null),y=(_,C)=>Math.sqrt(Math.pow(_.x-C.x,2)+Math.pow(_.y-C.y,2)),$=(_,C)=>_.length===C.length&&_.every((M,D)=>M===C[D]),b=()=>{h(null)},[k,S]=q(null);let A="default";const T=(_,C)=>{!s||A===_||(s.style.cursor=_,A=_)},E=(_,...C)=>{console.log(`🎯 [InteractionLayer] ${_}`,...C)},R=_=>{if(!s)return{x:0,y:0};const C=s.getBoundingClientRect();return{x:_.clientX-C.left,y:_.clientY-C.top}},O=(_,C)=>_.x>=C.position.x&&_.x<=C.position.x+C.size.width&&_.y>=C.position.y&&_.y<=C.position.y+C.size.height,W=_=>{var M;const C=I(_);return C.length>0&&(M=C[0])!=null?M:null},I=_=>{const C=e.getAllElements();return C.filter(D=>D&&D.visible&&O(_,D)).sort((D,H)=>{var $e,_e;const Y=($e=D.z_index)!=null?$e:C.indexOf(D);return((_e=H.z_index)!=null?_e:C.indexOf(H))-Y})},F=_=>{const C=o();if(C.length===0)return null;const M=e.getAllElements();for(const D of C){const H=M.find(Ae=>Ae.id===D);if(!H||!H.visible)continue;const Y=8,Z=Y/2,$e=H.position.x,_e=H.position.y,te=H.position.x+H.size.width,Fe=H.position.y+H.size.height,Me=H.position.x+H.size.width/2,oe=H.position.y+H.size.height/2,Pe=[{direction:"nw",cursor:"nw-resize",x:$e-Z,y:_e-Z},{direction:"ne",cursor:"ne-resize",x:te-Z,y:_e-Z},{direction:"sw",cursor:"sw-resize",x:$e-Z,y:Fe-Z},{direction:"se",cursor:"se-resize",x:te-Z,y:Fe-Z},{direction:"n",cursor:"n-resize",x:Me-Z,y:_e-Z},{direction:"s",cursor:"s-resize",x:Me-Z,y:Fe-Z},{direction:"w",cursor:"w-resize",x:$e-Z,y:oe-Z},{direction:"e",cursor:"e-resize",x:te-Z,y:oe-Z}];for(const Ae of Pe)if(_.x>=Ae.x&&_.x<Ae.x+Y&&_.y>=Ae.y&&_.y<Ae.y+Y)return{elementId:H.id,direction:Ae.direction,cursor:Ae.cursor}}return null},P=_=>e.getAllElements().filter(M=>{if(!M.visible)return!1;const D={x:M.position.x,y:M.position.y,width:M.size.width,height:M.size.height};return!(D.x>_.x+_.width||D.x+D.width<_.x||D.y>_.y+_.height||D.y+D.height<_.y)}),K=(_,C)=>{var D,H,Y;const M=I(_);return E("重叠选择检测",{elementsCount:M.length,isCtrlClick:C,elementIds:M.map(Z=>Z.id)}),M.length===0?null:M.length===1?(b(),((D=M[0])==null?void 0:D.id)||null):C?V(_,M):(b(),E("普通点击选中最上层",{elementId:(H=M[0])==null?void 0:H.id}),((Y=M[0])==null?void 0:Y.id)||null)},V=(_,C)=>{var Y,Z,$e,_e;const M=m(),D=Date.now();if(E("循环选择开始",{hasContext:!!M,elementIds:C.map(te=>te.id)}),!M||y(_,M.clickPoint)>5||D-M.lastClickTime>3e3||!$(C.map(te=>te.id),M.overlappingElements.map(te=>te.id))){const te=C.length>1?1:0;return h({clickPoint:_,overlappingElements:C,currentSelectedIndex:te,lastClickTime:D}),E("循环选择重置",{selectedIndex:te,selectedId:(Y=C[te])==null?void 0:Y.id,reason:M?y(_,M.clickPoint)>5?"position_changed":D-M.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),x(te+1,C.length,_),((Z=C[te])==null?void 0:Z.id)||null}else{const te=(M.currentSelectedIndex+1)%C.length;return h({...M,currentSelectedIndex:te,lastClickTime:D}),E("循环选择继续",{selectedIndex:te,selectedId:($e=C[te])==null?void 0:$e.id}),x(te+1,C.length,_),((_e=C[te])==null?void 0:_e.id)||null}},x=(_,C,M)=>{const D=document.querySelector(".overlap-indicator");D!=null&&D.parentNode&&D.parentNode.removeChild(D);const H=document.createElement("div");H.className="overlap-indicator",H.textContent=`${_}/${C}`,Object.assign(H.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${M.x+10}px`,top:`${M.y-20}px`}),document.body.appendChild(H),E("显示重叠指示器",{current:_,total:C,point:M}),setTimeout(()=>{H.parentNode&&(H.parentNode.removeChild(H),E("移除重叠指示器"))},1500)},w=_=>{var M;const C=R(_);if(k()){X(C);return}if(l()===Oe.DRAGGING){ye(C);return}if(l()===Oe.SELECTING){ge(C);return}if(l()===Oe.IDLE&&c()&&!((M=c())!=null&&M.isDragging)){ae(C);return}l()===Oe.IDLE&&!c()&&!k()&&L(C)},L=_=>{const C=F(_);if(C){T(C.cursor);return}const M=W(_);if(M){const H=o().includes(M.id)?"grab":"pointer";T(H);return}T("default")},j=_=>{const C=R(_),M=F(C);if(M){E("点击ResizeHandle",{elementId:M.elementId,direction:M.direction}),B(M,C);return}if(t()){E("调整大小操作进行中，跳过交互处理");return}const D=K(C,_.ctrlKey);if(E("鼠标按下",{point:C,selectedElementId:D,currentMode:l(),isCtrlClick:_.ctrlKey}),D){const H=e.getAllElements().find(Y=>Y.id===D);H&&G(H,C,_)}else ce(C)},B=(_,C,M)=>{const D=e.getAllElements().find(H=>H.id===_.elementId);D&&(E("开始resize操作",{elementId:_.elementId,direction:_.direction}),n(!0),S({elementId:_.elementId,handlePosition:_.direction,startPoint:C,initialSize:{width:D.size.width,height:D.size.height},initialPosition:{x:D.position.x,y:D.position.y},cursor:_.cursor}),T(_.cursor),E("resize状态已设置",k()))},G=(_,C,M)=>{const D=o().includes(_.id),H=o(),Y=!!m();E("元素点击",{elementId:_.id,isSelected:D,currentlySelected:H,ctrlKey:M.ctrlKey,shiftKey:M.shiftKey,hasOverlapContext:Y}),M.ctrlKey&&!Y?ne(_.id):M.shiftKey&&o().length>0?J(_.id):D?(E("点击已选中元素，准备拖拽",{selectedCount:H.length}),be(H,C)):re(_.id,C)},ce=(_,C)=>{var M;E("开始框选",{point:_}),u([]),(M=e.onElementsSelect)==null||M.call(e,[]),b(),r(Oe.SELECTING),T("crosshair"),g({startPoint:_,currentPoint:_,selectedIds:[]})},ne=_=>{var D;const C=o(),M=C.includes(_)?C.filter(H=>H!==_):[...C,_];E("切换选择",{elementId:_,newSelection:M}),u(M),(D=e.onElementsSelect)==null||D.call(e,M)},J=_=>{var M;const C=o();if(!C.includes(_)){const D=[...C,_];E("添加到选择",{elementId:_,newSelection:D}),u(D),(M=e.onElementsSelect)==null||M.call(e,D)}},re=(_,C,M)=>{var D;E("选择并准备拖拽",{elementId:_,point:C}),u([_]),(D=e.onElementsSelect)==null||D.call(e,[_]),be([_],C)},be=(_,C,M)=>{E("准备拖拽操作",{elementIds:_,startPoint:C});const D=e.getAllElements(),H=new Map;_.forEach(Y=>{const Z=D.find($e=>$e.id===Y);Z&&H.set(Y,{x:Z.position.x,y:Z.position.y})}),v({elementIds:_,startPoint:C,startPositions:H,currentOffset:{x:0,y:0},isDragging:!1})},ae=_=>{const C=c();if(!C)return;const M=Math.sqrt(Math.pow(_.x-C.startPoint.x,2)+Math.pow(_.y-C.startPoint.y,2));M>i.dragThreshold&&(E("开始拖拽",{distance:M,threshold:i.dragThreshold}),r(Oe.DRAGGING),T("grabbing"),v({...C,isDragging:!0}))};let Q=!1,ie=0;const he=(_,C=!1)=>{if(C){_();return}Date.now()-ie>=i.updateThrottle&&!Q&&(Q=!0,requestAnimationFrame(()=>{_(),Q=!1,ie=Date.now()}))},ye=_=>{const C=c();if(!C)return;const M={x:_.x-C.startPoint.x,y:_.y-C.startPoint.y};v({...C,currentOffset:M}),he(()=>{if(e.onBatchUpdatePositions&&C.elementIds.length>1){const D=C.elementIds.map(H=>{const Y=C.startPositions.get(H);return Y?{element_id:H,new_position:{x:Y.x+M.x,y:Y.y+M.y}}:null}).filter(Boolean);D.length>0&&e.onBatchUpdatePositions(D).catch(()=>{})}else if(e.onElementMove){const D=C.elementIds.map(H=>{const Y=C.startPositions.get(H);if(Y)return e.onElementMove(H,{x:Y.x+M.x,y:Y.y+M.y})}).filter(Boolean);Promise.allSettled(D).catch(()=>{})}})},ge=_=>{const C=d();if(!C)return;const M={...C,currentPoint:_};g(M);const D={x:Math.min(C.startPoint.x,_.x),y:Math.min(C.startPoint.y,_.y),width:Math.abs(_.x-C.startPoint.x),height:Math.abs(_.y-C.startPoint.y)},Y=P(D).map(Z=>Z.id);g({...M,selectedIds:Y}),u(Y)},X=_=>{const C=k();if(!C)return;const M=_.x-C.startPoint.x,D=_.y-C.startPoint.y,H=ve(C.handlePosition,M,D,C.initialSize,C.initialPosition);he(()=>{e.onElementResize&&e.onElementResize(C.elementId,H.size,H.position)})},ve=(_,C,M,D,H)=>{let Y=D.width,Z=D.height,$e=H.x,_e=H.y;switch(_){case"nw":Y=D.width-C,Z=D.height-M,$e=H.x+C,_e=H.y+M;break;case"ne":Y=D.width+C,Z=D.height-M,_e=H.y+M;break;case"sw":Y=D.width-C,Z=D.height+M,$e=H.x+C;break;case"se":Y=D.width+C,Z=D.height+M;break;case"n":Z=D.height-M,_e=H.y+M;break;case"s":Z=D.height+M;break;case"w":Y=D.width-C,$e=H.x+C;break;case"e":Y=D.width+C;break}const te=10;return Y=Math.max(te,Y),Z=Math.max(te,Z),{size:{width:Y,height:Z},position:{x:$e,y:_e}}},pe=()=>{const _=l();if(E("鼠标释放",{currentMode:_,hasResizeState:!!k()}),k()){Te();return}_===Oe.DRAGGING?ue():_===Oe.SELECTING&&de(),Ce()},ue=()=>{const _=c();if(!_||!_.isDragging&&_.currentOffset.x===0&&_.currentOffset.y===0){E("拖拽完成，无实际移动");return}if(e.onBatchUpdatePositions&&_.elementIds.length>1){const C=_.elementIds.map(M=>{const D=_.startPositions.get(M);return D?{element_id:M,new_position:{x:D.x+_.currentOffset.x,y:D.y+_.currentOffset.y}}:null}).filter(Boolean);C.length>0&&(E("拖拽完成 - 批量更新",{elementCount:C.length}),e.onBatchUpdatePositions(C).catch(M=>{console.warn("批量更新最终位置失败:",M)}))}},de=()=>{const _=d();_&&(E("框选完成",{selectedCount:_.selectedIds.length}),e.onElementsSelect&&e.onElementsSelect(_.selectedIds))},Te=()=>{const _=k();_&&(E("完成resize操作",{elementId:_.elementId}),n(!1),S(null))},Ce=()=>{r(Oe.IDLE),T("default"),v(null),g(null),S(null),n(!1),b(),E("状态重置完成")};Je(async()=>{document.addEventListener("mousemove",w),document.addEventListener("mouseup",pe),E("修复版交互层已初始化")}),_t(()=>{document.removeEventListener("mousemove",w),document.removeEventListener("mouseup",pe),E("修复版交互层已清理")});const ze=()=>{const _=d();if(!_||l()!==Oe.SELECTING)return null;const{startPoint:C,currentPoint:M}=_;return{x:Math.min(C.x,M.x),y:Math.min(C.y,M.y),width:Math.abs(M.x-C.x),height:Math.abs(M.y-C.y)}};return(()=>{var _=jl();_.$$mousedown=j;var C=s;return typeof C=="function"?ln(C,_):s=_,_.style.setProperty("position","absolute"),_.style.setProperty("top","0"),_.style.setProperty("left","0"),_.style.setProperty("width","100%"),_.style.setProperty("height","100%"),_.style.setProperty("z-index","10"),_.style.setProperty("pointer-events","all"),_.style.setProperty("background","transparent"),_.style.setProperty("user-select","none"),a(_,(()=>{var M=se(()=>!!ze());return()=>M()&&(()=>{var D=Hl();return D.style.setProperty("position","absolute"),D.style.setProperty("border","1px dashed #007acc"),D.style.setProperty("background","rgba(0, 122, 204, 0.1)"),D.style.setProperty("pointer-events","none"),N(H=>{var Y=`${ze().x}px`,Z=`${ze().y}px`,$e=`${ze().width}px`,_e=`${ze().height}px`;return Y!==H.e&&((H.e=Y)!=null?D.style.setProperty("left",Y):D.style.removeProperty("left")),Z!==H.t&&((H.t=Z)!=null?D.style.setProperty("top",Z):D.style.removeProperty("top")),$e!==H.a&&((H.a=$e)!=null?D.style.setProperty("width",$e):D.style.removeProperty("width")),_e!==H.o&&((H.o=_e)!=null?D.style.setProperty("height",_e):D.style.removeProperty("height")),H},{e:void 0,t:void 0,a:void 0,o:void 0}),D})()})(),null),a(_,(()=>{var M=se(()=>!!e.enableDebugMode);return()=>M()&&(()=>{var D=Jl(),H=D.firstChild,Y=H.nextSibling;Y.firstChild;var Z=Y.nextSibling;Z.firstChild;var $e=Z.nextSibling;return $e.firstChild,D.style.setProperty("position","fixed"),D.style.setProperty("top","10px"),D.style.setProperty("right","10px"),D.style.setProperty("padding","8px"),D.style.setProperty("background","rgba(0, 0, 0, 0.8)"),D.style.setProperty("color","white"),D.style.setProperty("font-family","monospace"),D.style.setProperty("font-size","12px"),D.style.setProperty("border-radius","4px"),D.style.setProperty("z-index","9999"),D.style.setProperty("pointer-events","none"),a(Y,l,null),a(Z,()=>o().length,null),a($e,A,null),a(D,(()=>{var _e=se(()=>{var te;return!!((te=c())!=null&&te.isDragging)});return()=>_e()&&(()=>{var te=Vl(),Fe=te.firstChild,Me=Fe.nextSibling;return Me.nextSibling,te.style.setProperty("color","#ffeb3b"),a(te,()=>{var oe;return(oe=c())==null?void 0:oe.elementIds.length},Me),te})()})(),null),a(D,(()=>{var _e=se(()=>o().length>0);return()=>_e()&&(()=>{var te=Wl(),Fe=te.firstChild,Me=Fe.nextSibling;return Me.nextSibling,te.style.setProperty("font-size","10px"),te.style.setProperty("color","#ccc"),a(te,()=>o().slice(0,3).join(", "),Me),a(te,()=>o().length>3&&"...",Me),te})()})(),null),D})()})(),null),_})()};Re(["mousedown"]);var Kl=p("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),Gl=p("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),Xl=p('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),Yl=p('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const Zl=(e,t)=>{if(e.length<2)return[];const n=e.map(i=>({x:i.position.x,y:i.position.y,width:i.size.width,height:i.size.height}));return n.map((i,s)=>{let l=i.x,r=i.y;switch(t){case"left":l=Math.min(...n.map(d=>d.x));break;case"right":l=Math.max(...n.map(d=>d.x+d.width))-i.width;break;case"top":r=Math.min(...n.map(d=>d.y));break;case"bottom":r=Math.max(...n.map(d=>d.y+d.height))-i.height;break;case"h_center":l=n.reduce((d,g)=>d+g.x+g.width/2,0)/n.length-i.width/2;break;case"v_center":r=n.reduce((d,g)=>d+g.y+g.height/2,0)/n.length-i.height/2;break}return{element_id:e[s].id,new_position:{x:l,y:r}}})},Ql=e=>{const{batchUpdatePositions:t,state:n}=We(),[i,s]=q(!1),l=()=>e.selectedElementIds().length>=2,r=()=>{const v=e.selectedElementIds();return n.elements.filter(d=>v.includes(d.id))},o=async v=>{const d=r();if(d.length<2){console.warn("对齐功能需要至少2个元素");return}try{s(!0),console.log(`🎯 执行${v}对齐:`,d.length,"个元素");const g=Zl(d,v);await t(g),console.log("✅ 对齐操作完成"),e.onAlignmentComplete&&e.onAlignmentComplete(g)}catch(g){console.error("❌ 对齐操作失败:",g)}finally{s(!1)}},u=()=>r().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>u();return(()=>{var v=Yl(),d=v.firstChild,g=d.firstChild,m=g.nextSibling,h=m.firstChild,y=h.nextSibling,$=y.nextSibling,b=d.nextSibling,k=b.firstChild,S=k.nextSibling,A=S.firstChild,T=A.nextSibling,E=T.nextSibling,R=b.nextSibling,O=R.firstChild,W=O.nextSibling,I=W.firstChild,F=I.nextSibling;return h.$$click=()=>o("left"),y.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"h_center")}),y.$$click=()=>o("h_center"),$.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"right")}),$.$$click=()=>o("right"),A.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"top")}),A.$$click=()=>o("top"),T.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"v_center")}),T.$$click=()=>o("v_center"),E.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"bottom")}),E.$$click=()=>o("bottom"),I.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"distribute_h")}),I.$$click=()=>o("distribute_h"),F.addEventListener("mouseenter",()=>{var P;return(P=e.onAlignmentPreview)==null?void 0:P.call(e,"distribute_v")}),F.$$click=()=>o("distribute_v"),a(v,f(U,{get when(){return se(()=>!!l())()&&c()},get children(){var P=Kl(),K=P.firstChild,V=K.nextSibling,x=V.firstChild,w=x.nextSibling,L=V.nextSibling;return V.$$click=()=>o(c().recommended),a(w,()=>c().recommended==="left"&&"左对齐",null),a(w,()=>c().recommended==="right"&&"右对齐",null),a(w,()=>c().recommended==="top"&&"顶对齐",null),a(w,()=>c().recommended==="bottom"&&"底对齐",null),a(w,()=>c().recommended==="h_center"&&"水平居中",null),a(w,()=>c().recommended==="v_center"&&"垂直居中",null),a(L,()=>c().reason),N(j=>{var B=i(),G=c().reason;return B!==j.e&&(V.disabled=j.e=B),G!==j.t&&z(V,"title",j.t=G),j},{e:void 0,t:void 0}),P}}),null),a(v,f(U,{get when(){return!l()},get children(){var P=Gl(),K=P.firstChild;return K.firstChild,a(K,()=>e.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),P}}),null),a(v,f(U,{get when(){return i()},get children(){return Xl()}}),null),N(P=>{var K=!l()||i(),V=!l()||i(),x=!l()||i(),w=!l()||i(),L=!l()||i(),j=!l()||i(),B=e.selectedElementIds().length<3||i(),G=e.selectedElementIds().length<3||i();return K!==P.e&&(h.disabled=P.e=K),V!==P.t&&(y.disabled=P.t=V),x!==P.a&&($.disabled=P.a=x),w!==P.o&&(A.disabled=P.o=w),L!==P.i&&(T.disabled=P.i=L),j!==P.n&&(E.disabled=P.n=j),B!==P.s&&(I.disabled=P.s=B),G!==P.h&&(F.disabled=P.h=G),P},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),v})()},es=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const e=document.createElement("style");e.textContent=es,document.head.appendChild(e)}Re(["click"]);var ts=p("<div>"),ns=p('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),is=p("<span class=ml-2>Zoom: <!>%");const ls=()=>{const{state:e,selectElement:t,clearSelection:n,createElement:i,selectMultiple:s,updateElement:l,batchUpdatePositions:r}=We();let o;const[u,c]=q([]),v=xe(()=>e.elements.filter(S=>S.visible)),d=(S,A)=>{if(!o)return{x:0,y:0};const T=o.getBoundingClientRect(),E=(S-T.left)/e.canvas_config.zoom,R=(A-T.top)/e.canvas_config.zoom;return{x:E,y:R}},g=async S=>{console.log("🎯 选择元素",S),c([...S]);try{S.length===0?await n():S.length===1?await t(S[0]):await s([...S])}catch(A){console.error("❌ 选择元素失败:",A)}},m=async S=>{try{await r(S)}catch(A){console.error("❌ 批量更新位置失败:",A)}},h=async(S,A)=>{try{await l(S,{position:{x:A.x,y:A.y}})}catch(T){console.error("❌ 移动元素失败:",T)}},y=async(S,A,T)=>{try{await l(S,{size:A,position:T})}catch(E){console.error("❌ 调整大小失败:",E)}},$=async S=>{console.log("🖱️ 画布点击",S)},b=async S=>{var A;S.preventDefault();try{const T=(A=S.dataTransfer)==null?void 0:A.getData("application/json");if(!T)return;const{type:E,component:R}=JSON.parse(T);if(E==="component"){const{x:O,y:W}=d(S.clientX,S.clientY),I=Math.max(0,O-R.default_size.width/2),F=Math.max(0,W-R.default_size.height/2);console.log("🎯 通过拖放创建组件:",R.name,"at",I,F);const P=await i(R.id,{x:I,y:F},R.default_size,R.create_content());console.log("✅ 通过拖放创建元素成功:",P),c([P]),await t(P)}}catch(T){console.error("拖放处理失败:",T)}};Je(()=>{c([...e.selected_ids])}),xe(()=>{c([...e.selected_ids])});const k=xe(()=>{const{width:S,height:A}=e.canvas_config;return`0 0 ${S} ${A}`});return(()=>{var S=ns(),A=S.firstChild,T=A.firstChild,E=T.firstChild,R=E.nextSibling,O=R.nextSibling,W=O.nextSibling,I=W.nextSibling,F=I.nextSibling,P=F.firstChild,K=P.nextSibling;K.nextSibling;var V=A.nextSibling,x=V.firstChild,w=x.firstChild,L=w.firstChild,j=L.firstChild,B=j.nextSibling,G=B.nextSibling,ce=G.nextSibling;a(T,()=>e.canvas_config.width,R),a(T,()=>e.canvas_config.height,W),a(T,(()=>{var J=se(()=>e.canvas_config.zoom!==1);return()=>J()&&(()=>{var re=is(),be=re.firstChild,ae=be.nextSibling;return ae.nextSibling,a(re,()=>Math.round(e.canvas_config.zoom*100),ae),re})()})(),F),a(F,()=>e.elements.length,K),a(F,()=>u().length,null),w.style.setProperty("position","relative"),L.addEventListener("drop",b),L.addEventListener("dragover",J=>{J.preventDefault(),J.dataTransfer.dropEffect="copy"}),L.$$contextmenu=J=>J.preventDefault();var ne=o;return typeof ne=="function"?ln(ne,L):o=L,a(L,f(_l,{get config(){return e.canvas_config}}),B),a(G,f(fe,{get each(){return v()},children:J=>f(Nl,{element:J,get selected(){return u().includes(J.id)}})})),a(ce,f(fe,{get each(){return v().filter(J=>u().includes(J.id))},children:J=>f(Il,{element:J})})),a(w,f(ql,{canvasRef:o,getAllElements:()=>[...e.elements],onElementsSelect:g,onElementMove:h,onBatchUpdatePositions:m,onElementResize:y,onCanvasClick:$,get enableDebugMode(){return!1}}),null),a(w,f(U,{get when(){return u().length>=2},get children(){var J=ts();return J.style.setProperty("position","fixed"),J.style.setProperty("top","80px"),J.style.setProperty("right","20px"),J.style.setProperty("z-index","1000"),J.style.setProperty("background","white"),J.style.setProperty("border-radius","8px"),J.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),J.style.setProperty("border","1px solid #e5e7eb"),a(J,f(Ql,{selectedElementIds:u,onAlignmentComplete:re=>{console.log("✅ 对齐操作完成:",re)},onAlignmentPreview:re=>{console.log("👁️ 对齐预览:",re)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),J}}),null),N(J=>{var re=e.canvas_config.width*e.canvas_config.zoom,be=e.canvas_config.height*e.canvas_config.zoom,ae=k(),Q=e.canvas_config.width,ie=e.canvas_config.height,he=e.canvas_config.background_color,ye=e.canvas_config.width,ge=e.canvas_config.height;return re!==J.e&&z(L,"width",J.e=re),be!==J.t&&z(L,"height",J.t=be),ae!==J.a&&z(L,"viewBox",J.a=ae),Q!==J.o&&z(j,"width",J.o=Q),ie!==J.i&&z(j,"height",J.i=ie),he!==J.n&&z(j,"fill",J.n=he),ye!==J.s&&z(B,"width",J.s=ye),ge!==J.h&&z(B,"height",J.h=ge),J},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),S})()};Re(["contextmenu"]);var ss=p("<div class=wizard-errors>"),rs=p("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),as=p("<div class=error-message>"),os=p("<div class=wizard-progress>"),cs=p("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),ds=p("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),us=p("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),hs=p("<span class=feature-tag>"),gs=p("<div class=data-input-step><div class=step-header><h4></h4><p>"),fs=p("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),vs=p("<div class=file-error>"),ms=p('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),ys=p("<div class=field-error>"),ps=p("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),bs=p('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),$s=p('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),_s=p("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),xs=p("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),ws=p('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),Ss=p("<span class=status-success>✅ JSON格式正确"),Cs=p("<span class=status-error>❌ 格式错误"),ks=p("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),Es=p("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),As=p(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),Ps=p("<div class=template-item><div class=template-name></div><div class=template-description>"),Ds=p("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),Ts=p("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),zs=p('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),Ls=p("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),Ms=p("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),Rs=p("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),Os=p("<li>首次配置数据源时，建议先测试连接确保配置正确"),Ns=p("<li>测试过程会验证JSON格式和文件访问权限"),Us=p("<li>预览功能可以帮助您确认数据结构是否符合预期"),Fs=p("<li>✅ 连接测试成功！您可以继续创建数据源"),Is=p("<li>预览显示的是实际数据，创建后可用于报表设计"),Bs=p("<li>字段名称将用于数据绑定表达式"),js=p("<li>❌ 请检查JSON格式是否正确"),Hs=p("<li>如果是文件类型，请确认文件路径存在且可访问"),Js=p("<li>可以返回上一步修改配置后重新测试"),Vs=p("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),Ws=p("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),qs=p("<span class=loading-spinner>⏳"),Ks=p("<span class=test-button-icon>🔌"),Gs=p("<div class=field-tag><span class=field-name>"),Xs=p("<th>"),Ys=p("<tr>"),Zs=p("<td><div class=cell-content>"),Qs=p("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),er=p('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),tr=p('<button class="control-btn finish-btn">'),nr=p("<span class=hint-text>选择您的JSON数据来源方式"),Jt=p("<span class=hint-text>"),ir=p("<span class=hint-text>设置数据源名称和选项"),lr=p('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),sr=p("<span class=btn-loading>⏳"),rr=p("<span class=btn-text>创建中..."),ar=p("<span class=btn-icon>✓"),or=p("<span class=btn-text>创建数据源");function pn(e){const[t,n]=q({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),i=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],s=xe(()=>{const h=t();switch(h.currentStep){case 1:return h.sourceType!==null;case 2:return l(h);case 3:return r(h);case 4:return o(h);default:return!1}}),l=h=>{var y,$;if(h.sourceType==="file")return!!((y=h.config.file_path)!=null&&y.trim());if(h.sourceType==="content"){const b=($=h.config.json_content)==null?void 0:$.trim();if(!b)return!1;try{return JSON.parse(b),!0}catch{return!1}}return!1},r=h=>{const y=h.name.trim();return!(y.length<2||y.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(y))},o=h=>{var y;return!!((y=h.testResult)!=null&&y.success)},u=h=>{const y=t();n($=>({...$,validation:{...$.validation,errors:[]}})),y.currentStep===1&&y.sourceType?n($=>({...$,currentStep:h,config:{...$.config,source_type:y.sourceType}})):n($=>({...$,currentStep:h}))},c=()=>{const h=t();h.currentStep<4&&s()&&u(h.currentStep+1)},v=()=>{const h=t();h.currentStep>1&&(h.currentStep===4?n(y=>({...y,currentStep:y.currentStep-1,testResult:null})):u(h.currentStep-1))},d=h=>{n(y=>({...y,...h}))},g=async()=>{const h=t();d({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const y={...h.config,source_type:h.sourceType};if(await Se.testConnection("json",y)){console.log("✅ 连接测试成功，获取预览数据...");const b=await Se.discoverSchema("json",y),k=`temp_${Date.now()}`,S=await Se.createDataSource(k,"json",y),A=await Se.getPreview(S,void 0,5);await Se.deleteDataSource(S),d({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:A.total_rows,fields:b.columns.map(T=>T.name),sample_data:A.rows}},loading:!1})}}catch(y){console.error("❌ 连接测试失败:",y),d({testResult:{success:!1,message:"连接测试失败",error:y instanceof Error?y.message:String(y)},loading:!1})}},m=async()=>{const h=t();d({loading:!0});try{console.log("🔄 开始创建数据源...");const y={...h.config,source_type:h.sourceType},$=await Se.createDataSource(h.name,"json",y);console.log("✅ 数据源创建成功，ID:",$);try{await Ye.setActiveDataSource($),console.log("✅ 数据源自动激活成功")}catch(b){console.warn("⚠️ 数据源激活失败，但创建成功:",b)}e.onSuccess(),e.onBack()}catch(y){console.error("❌ 创建数据源失败:",y),d({validation:{isValid:!1,errors:[`创建失败: ${y}`],warnings:[]},loading:!1})}};return(()=>{var h=rs(),y=h.firstChild,$=y.firstChild,b=$.nextSibling,k=b.firstChild,S=k.nextSibling,A=y.nextSibling;return ke($,"click",e.onBack),a(S,()=>{var T;return(T=i[t().currentStep-1])==null?void 0:T.description}),a(h,f(cr,{get currentStep(){return t().currentStep},stepInfo:i,onStepClick:u}),A),a(A,f(U,{get when(){return t().currentStep===1},get children(){return f(dr,{get selectedType(){return t().sourceType},onSelect:T=>d({sourceType:T,config:{...t().config,source_type:T}})})}}),null),a(A,f(U,{get when(){return t().currentStep===2},get children(){return f(ur,{get sourceType(){return t().sourceType},get config(){return t().config},onConfigUpdate:T=>d({config:{...t().config,...T}})})}}),null),a(A,f(U,{get when(){return t().currentStep===3},get children(){return f(gr,{get name(){return t().name},get config(){return t().config},onNameChange:T=>d({name:T}),onConfigUpdate:T=>d({config:{...t().config,...T}})})}}),null),a(A,f(U,{get when(){return t().currentStep===4},get children(){return f(vr,{get config(){return t().config},get testResult(){return t().testResult},get loading(){return t().loading},onTest:g})}}),null),a(h,f(mr,{get currentStep(){return t().currentStep},get canProceed(){return s()},get loading(){return t().loading},get testResult(){return t().testResult},onPrevious:v,onNext:c,onFinish:m}),null),a(h,f(U,{get when(){return t().validation.errors.length>0},get children(){var T=ss();return a(T,f(fe,{get each(){return t().validation.errors},children:E=>(()=>{var R=as();return a(R,E),R})()})),T}}),null),h})()}function cr(e){return(()=>{var t=os();return a(t,f(fe,{get each(){return e.stepInfo},children:n=>{const i=e.currentStep===n.step,s=e.currentStep>n.step,l=e.currentStep>=n.step;return(()=>{var r=cs(),o=r.firstChild,u=o.firstChild,c=o.nextSibling,v=c.firstChild,d=v.nextSibling;return r.$$click=()=>l&&e.onStepClick(n.step),me(r,`progress-step ${i?"active":""} ${s?"completed":""}`),a(u,()=>s?"✓":n.step),a(v,()=>n.title),a(d,()=>n.description),r})()}})),t})()}function dr(e){const t=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var n=ds(),i=n.firstChild,s=i.nextSibling;return a(s,f(fe,{each:t,children:l=>(()=>{var r=us(),o=r.firstChild,u=o.firstChild,c=u.nextSibling,v=o.nextSibling,d=v.nextSibling,g=d.nextSibling,m=g.firstChild;return r.$$click=()=>e.onSelect(l.type),a(u,()=>l.title),a(c,()=>l.description),a(v,f(fe,{get each(){return l.features},children:h=>(()=>{var y=hs();return a(y,h),y})()})),a(d,()=>l.example),m.addEventListener("change",()=>e.onSelect(l.type)),N(()=>me(r,`source-option ${e.selectedType===l.type?"selected":""}`)),N(()=>m.checked=e.selectedType===l.type),r})()})),n})()}function ur(e){return(()=>{var t=gs(),n=t.firstChild,i=n.firstChild,s=i.nextSibling;return a(i,()=>e.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),a(s,()=>e.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),a(t,f(U,{get when(){return e.sourceType==="file"},get children(){return f(hr,{get filePath(){return e.config.file_path||""},onFileSelect:l=>e.onConfigUpdate({file_path:l})})}}),null),a(t,f(U,{get when(){return e.sourceType==="content"},get children(){return f(fr,{get content(){return e.config.json_content||""},onContentChange:l=>e.onConfigUpdate({json_content:l})})}}),null),t})()}function hr(e){const[t,n]=q(!1),[i,s]=q(null),l=u=>{var d;const v=(d=u.target.files)==null?void 0:d[0];v&&o(v)},r=u=>{var v,d;u.preventDefault(),n(!1);const c=(d=(v=u.dataTransfer)==null?void 0:v.files)==null?void 0:d[0];c&&o(c)},o=u=>{if(s(null),!u.name.endsWith(".json")){s("请选择JSON文件（.json格式）");return}if(u.size>10*1024*1024){s("文件大小不能超过10MB");return}const c=new FileReader;c.onload=v=>{var d;try{const g=(d=v.target)==null?void 0:d.result;JSON.parse(g),e.onFileSelect(u.name),console.log("✅ 文件选择成功:",u.name)}catch{s("文件内容不是有效的JSON格式")}},c.readAsText(u)};return(()=>{var u=ms(),c=u.firstChild,v=c.nextSibling,d=v.firstChild,g=d.firstChild,m=v.nextSibling;return c.addEventListener("drop",r),c.addEventListener("dragleave",()=>n(!1)),c.addEventListener("dragover",h=>{h.preventDefault(),n(!0)}),g.addEventListener("change",l),a(v,f(U,{get when(){return e.filePath},get children(){var h=fs(),y=h.firstChild,$=y.nextSibling,b=$.nextSibling;return a($,()=>e.filePath),b.$$click=()=>e.onFileSelect(""),h}}),null),a(u,f(U,{get when(){return i()},get children(){var h=vs();return a(h,i),h}}),m),N(()=>me(c,`file-drop-zone ${t()?"active":""}`)),u})()}function gr(e){const[t,n]=q(null),i=l=>{e.onNameChange(l),l.trim().length===0?n("数据源名称不能为空"):l.trim().length<2?n("数据源名称至少需要2个字符"):l.trim().length>50?n("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(l.trim())?n(null):n("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},s=l=>{const r=parseInt(l);!isNaN(r)&&r>=10&&r<=3600&&e.onConfigUpdate({refresh_interval:r})};return(()=>{var l=ws(),r=l.firstChild,o=r.nextSibling,u=o.firstChild,c=u.firstChild,v=c.nextSibling,d=v.firstChild,g=d.nextSibling,m=g.nextSibling,h=u.nextSibling,y=h.firstChild,$=y.nextSibling,b=$.firstChild,k=b.firstChild,S=k.nextSibling;return g.$$input=A=>i(A.currentTarget.value),a(v,f(U,{get when(){return t()},get children(){var A=ys();return a(A,t),A}}),m),a(o,f(U,{get when(){return e.config.source_type==="file"},get children(){var A=bs(),T=A.firstChild,E=T.nextSibling,R=E.firstChild,O=R.firstChild;return O.addEventListener("change",W=>e.onConfigUpdate({auto_refresh:W.currentTarget.checked})),a(A,f(U,{get when(){return e.config.auto_refresh},get children(){var W=ps(),I=W.firstChild,F=I.nextSibling,P=F.firstChild,K=P.nextSibling;return P.$$input=V=>s(V.currentTarget.value),K.addEventListener("change",V=>s(V.currentTarget.value)),N(()=>P.value=e.config.refresh_interval),N(()=>K.value=e.config.refresh_interval),W}}),null),N(()=>O.checked=e.config.auto_refresh),A}}),h),a(S,()=>e.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),a($,f(U,{get when(){return e.config.source_type==="file"},get children(){return[(()=>{var A=$s(),T=A.firstChild,E=T.nextSibling;return a(E,()=>e.config.file_path||"(未选择文件)"),A})(),(()=>{var A=_s(),T=A.firstChild,E=T.nextSibling;return a(E,()=>e.config.auto_refresh?`✅ 每 ${e.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),A})()]}}),null),a($,f(U,{get when(){return e.config.source_type==="content"},get children(){var A=xs(),T=A.firstChild,E=T.nextSibling,R=E.firstChild;return a(E,()=>{var O;return((O=e.config.json_content)==null?void 0:O.length)||0},R),A}}),null),N(()=>me(g,`name-input ${t()?"error":""}`)),N(()=>g.value=e.name),l})()}function fr(e){const[t,n]=q(null),[i,s]=q(!1),l=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],r=u=>{if(e.onContentChange(u),u.trim())try{JSON.parse(u),n(null)}catch(c){n(c instanceof Error?c.message:"无效的JSON格式")}else n(null)},o=u=>{e.onContentChange(u.content),n(null),s(!1)};return(()=>{var u=As(),c=u.firstChild,v=c.firstChild,d=v.nextSibling,g=d.nextSibling,m=c.nextSibling,h=m.firstChild,y=m.nextSibling;return v.$$click=()=>s(!i()),d.$$click=()=>e.onContentChange(""),a(g,f(U,{get when(){return se(()=>!t())()&&e.content.trim()},get children(){return Ss()}}),null),a(g,f(U,{get when(){return t()},get children(){return Cs()}}),null),a(u,f(U,{get when(){return i()},get children(){var $=ks(),b=$.firstChild,k=b.nextSibling;return a(k,f(fe,{each:l,children:S=>(()=>{var A=Ps(),T=A.firstChild,E=T.nextSibling;return A.$$click=()=>o(S),a(T,()=>S.name),a(E,()=>S.description),A})()})),$}}),m),h.$$input=$=>r($.currentTarget.value),a(u,f(U,{get when(){return t()},get children(){var $=Es(),b=$.firstChild,k=b.nextSibling;return a(k,t),$}}),y),N($=>{var b=!e.content,k=`json-textarea ${t()?"error":""}`;return b!==$.e&&(d.disabled=$.e=b),k!==$.t&&me(h,$.t=k),$},{e:void 0,t:void 0}),N(()=>h.value=e.content),u})()}function vr(e){const[t,n]=q(!1),i=()=>e.loading?"🔄":e.testResult?e.testResult.success?"✅":"❌":"⚡",s=()=>e.loading?"测试连接中...":e.testResult?e.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",l=()=>e.loading?"testing":e.testResult?e.testResult.success?"success":"error":"ready",r=o=>typeof o=="object"?JSON.stringify(o,null,2):String(o);return(()=>{var o=Ws(),u=o.firstChild,c=u.nextSibling,v=c.firstChild,d=v.firstChild,g=d.firstChild,m=g.firstChild,h=m.nextSibling,y=g.nextSibling,$=v.nextSibling,b=$.firstChild,k=b.nextSibling;return a(m,i),a(h,s),ke(y,"click",e.onTest),a(y,(()=>{var S=se(()=>!!e.loading);return()=>S()?[qs(),"测试中..."]:[Ks(),"测试连接"]})()),a(v,f(U,{get when(){return e.testResult},get children(){var S=Ts(),A=S.firstChild,T=A.firstChild,E=T.nextSibling;return a(T,i),a(E,()=>e.testResult.message),a(S,f(U,{get when(){return e.testResult.error},get children(){var R=Ds(),O=R.firstChild,W=O.nextSibling;return a(W,()=>e.testResult.error),R}}),null),N(()=>me(S,`test-result ${l()}`)),S}}),null),a(c,f(U,{get when(){var S;return((S=e.testResult)==null?void 0:S.success)&&e.testResult.preview},get children(){var S=Rs(),A=S.firstChild,T=A.firstChild,E=T.nextSibling,R=E.firstChild,O=R.firstChild,W=O.nextSibling,I=R.nextSibling,F=I.firstChild,P=F.nextSibling,K=A.nextSibling,V=K.firstChild,x=V.nextSibling,w=K.nextSibling,L=w.firstChild,j=L.nextSibling,B=j.firstChild,G=B.firstChild,ce=G.firstChild,ne=G.nextSibling,J=w.nextSibling,re=J.firstChild,be=re.firstChild;return a(W,()=>e.testResult.preview.record_count),a(P,()=>e.testResult.preview.fields.length),a(x,f(fe,{get each(){return e.testResult.preview.fields},children:ae=>(()=>{var Q=Gs(),ie=Q.firstChild;return a(ie,ae),Q})()})),a(ce,f(fe,{get each(){return e.testResult.preview.fields},children:ae=>(()=>{var Q=Xs();return a(Q,ae),Q})()})),a(ne,f(fe,{get each(){return e.testResult.preview.sample_data},children:ae=>(()=>{var Q=Ys();return a(Q,f(fe,{get each(){return e.testResult.preview.fields},children:ie=>(()=>{var he=Zs(),ye=he.firstChild;return a(ye,(()=>{var ge=se(()=>ae[ie]!==void 0);return()=>ge()?r(ae[ie]):"-"})()),he})()})),Q})()})),re.$$click=()=>n(!t()),a(be,()=>t()?"▼":"▶"),a(J,f(U,{get when(){return t()},get children(){var ae=Ms(),Q=ae.firstChild,ie=Q.firstChild,he=ie.firstChild,ye=he.nextSibling,ge=ie.nextSibling;return a(ye,()=>e.config.source_type==="file"?"JSON文件":"JSON内容"),a(Q,f(U,{get when(){return e.config.source_type==="file"},get children(){return[(()=>{var X=zs(),ve=X.firstChild,pe=ve.nextSibling;return a(pe,()=>e.config.file_path),X})(),(()=>{var X=Ls(),ve=X.firstChild,pe=ve.nextSibling;return a(pe,()=>e.config.auto_refresh?"已启用":"已禁用"),X})()]}}),ge),ae}}),null),S}}),$),a(k,f(U,{get when(){return!e.testResult},get children(){return[Os(),Ns(),Us()]}}),null),a(k,f(U,{get when(){var S;return(S=e.testResult)==null?void 0:S.success},get children(){return[Fs(),Is(),Bs()]}}),null),a(k,f(U,{get when(){return e.testResult&&!e.testResult.success},get children(){return[js(),Hs(),Js()]}}),null),a(c,f(U,{get when(){return e.config.source_type==="file"},get children(){return Vs()}}),null),N(S=>{var A=`test-button ${l()}`,T=e.loading;return A!==S.e&&me(y,S.e=A),T!==S.t&&(y.disabled=S.t=T),S},{e:void 0,t:void 0}),o})()}function mr(e){const t=l=>{switch(l){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${l}`}},n=()=>e.currentStep>1,i=()=>e.currentStep<4&&e.canProceed,s=()=>e.currentStep===4&&e.canProceed;return(()=>{var l=lr(),r=l.firstChild,o=r.firstChild,u=o.firstChild,c=u.nextSibling;c.nextSibling;var v=r.nextSibling,d=v.firstChild,g=v.nextSibling;return a(o,()=>e.currentStep,c),a(o,()=>t(e.currentStep),null),a(r,f(U,{get when(){return!e.canProceed&&e.currentStep<4},get children(){return Qs()}}),null),ke(d,"click",e.onPrevious),a(v,f(U,{get when(){return e.currentStep<4},get children(){var m=er();return ke(m,"click",e.onNext),N(()=>m.disabled=!i()||e.loading),m}}),null),a(v,f(U,{get when(){return e.currentStep===4},get children(){var m=tr();return ke(m,"click",e.onFinish),a(m,(()=>{var h=se(()=>!!e.loading);return()=>h()?[sr(),rr()]:[ar(),or()]})()),N(()=>m.disabled=!s()||e.loading),m}}),null),a(g,f(U,{get when(){return e.currentStep===1},get children(){return nr()}}),null),a(g,f(U,{get when(){return e.currentStep===2},get children(){var m=Jt();return a(m,()=>{var h;return(h=e.testResult)!=null&&h.success?"数据格式验证成功":"请提供JSON数据内容"}),m}}),null),a(g,f(U,{get when(){return e.currentStep===3},get children(){return ir()}}),null),a(g,f(U,{get when(){return e.currentStep===4},get children(){var m=Jt();return a(m,()=>{var h;return(h=e.testResult)!=null&&h.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"}),m}}),null),N(()=>d.disabled=!n()||e.loading),l})()}Re(["click","input"]);var yr=p("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),pr=p("<div class=error-message>"),br=p("<div class=loading-message>加载中..."),$r=p("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),_r=p("<div class=sources-grid>"),xr=p("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),wr=p('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),Sr=p("<span class=changes-indicator>● 有未保存的更改"),Cr=p("<div class=error-details>"),kr=p("<div><div class=result-message> "),Er=p("<div class=error-message>❌ "),Ar=p("<button type=button class=reset-btn>重置更改"),Pr=p('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),Dr=p("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),Tr=p("<th>"),zr=p("<tr>"),Lr=p("<td>");function Mr(e){const[t,n]=q([]),[i,s]=q([]),[l,r]=q("list"),[o,u]=q(null),[c,v]=q(null),[d,g]=q(!1),[m,h]=q(null);Je(async()=>{try{await y(),await $()}catch(E){console.error("🚨 DataSourcesPanel初始化失败:",E),h(`数据源模块初始化失败: ${E}`)}});const y=async()=>{try{g(!0),console.log("🔄 开始加载数据源列表...");const E=await Se.listDataSources();console.log("✅ 数据源列表加载成功:",E),n(E),h(null)}catch(E){console.error("❌ 加载数据源失败:",E),h(`加载数据源失败: ${E}`)}finally{g(!1)}},$=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const E=await Se.getAvailableTypes();console.log("✅ 数据源类型加载成功:",E),s(E)}catch(E){console.error("❌ 加载数据源类型失败:",E)}},b=()=>{r("add"),u(null)},k=E=>{u(E),r("edit")},S=async E=>{try{g(!0),h(null),u(E),console.log("🔄 开始预览数据源:",E.name),E.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",E.status),h(`数据源状态为 ${E.status}，可能无法预览数据`));const R=await Se.getPreview(E.id);v(R),r("preview"),console.log("✅ 数据预览加载成功:",R)}catch(R){console.error("❌ 数据预览失败:",R);const O=`预览数据源 "${E.name}" 失败: ${R}`;h(O);const W={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},I=String(R).toLowerCase(),F=Object.keys(W).find(P=>I.includes(P));F&&h(`预览失败: ${W[F]}`)}finally{g(!1)}},A=async E=>{if(confirm("确定要删除这个数据源吗？"))try{await Se.deleteDataSource(E),await y()}catch(R){h(`删除数据源失败: ${R}`)}},T=async E=>{try{g(!0),console.log("🔄 开始测试数据源连接:",E);const R=t().find(W=>W.id===E);if(!R){h(`数据源不存在: ${E}`);return}await Se.testConnection(R.type_name,R.config||{})?(console.log("✅ 数据源连接测试成功:",E),alert(`✅ 数据源 "${R.name}" 连接测试成功！`)):(console.log("❌ 数据源连接测试失败:",E),alert(`❌ 数据源 "${R.name}" 连接测试失败`))}catch(R){console.error("❌ 测试连接时发生错误:",R);const O=t().find(W=>W.id===E);h(`测试连接失败: ${R}`),alert(`❌ 数据源 "${(O==null?void 0:O.name)||E}" 连接测试失败:
${R}`)}finally{g(!1)}};return f(U,{get when(){return e.isOpen},get children(){var E=yr(),R=E.firstChild,O=R.nextSibling,W=O.firstChild,I=W.nextSibling,F=I.nextSibling,P=O.nextSibling;return ke(F,"click",e.onClose),a(P,f(U,{get when(){return l()==="list"},get children(){return f(Rr,{get dataSources(){return t()},get loading(){return d()},get error(){return m()},onAdd:b,onEdit:k,onPreview:S,onDelete:A,onTestConnection:T,onRefresh:y})}}),null),a(P,f(U,{get when(){return l()==="add"},get children(){return f(pn,{get availableTypes(){return i()},onBack:()=>r("list"),onSuccess:y})}}),null),a(P,f(U,{get when(){return se(()=>l()==="edit")()&&o()},get children(){return f(Or,{get dataSource(){return o()},onBack:()=>r("list"),onSuccess:y})}}),null),a(P,f(U,{get when(){return se(()=>!!(l()==="preview"&&o()))()&&c()},get children(){return f(Nr,{get dataSource(){return o()},get data(){return c()},onBack:()=>r("list")})}}),null),E}})}function Rr(e){const t=i=>{switch(i){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=i=>new Date(i).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var i=xr(),s=i.firstChild,l=s.firstChild,r=l.firstChild,o=r.firstChild,u=o.nextSibling;u.nextSibling;var c=r.nextSibling,v=l.nextSibling;return a(r,()=>e.dataSources.length,u),ke(c,"click",e.onRefresh),ke(v,"click",e.onAdd),a(i,f(U,{get when(){return e.error},get children(){var d=pr();return a(d,()=>e.error),d}}),null),a(i,f(U,{get when(){return e.loading},get children(){return br()}}),null),a(i,f(U,{get when(){return!e.loading&&e.dataSources.length===0},get children(){var d=$r(),g=d.firstChild,m=g.nextSibling;return ke(m,"click",e.onAdd),d}}),null),a(i,f(U,{get when(){return!e.loading&&e.dataSources.length>0},get children(){var d=_r();return a(d,f(fe,{get each(){return e.dataSources},children:g=>(()=>{var m=wr(),h=m.firstChild,y=h.firstChild,$=y.firstChild,b=$.nextSibling,k=y.nextSibling,S=h.nextSibling,A=S.firstChild,T=A.firstChild,E=T.nextSibling,R=A.nextSibling,O=R.firstChild,W=O.nextSibling,I=S.nextSibling,F=I.firstChild,P=F.nextSibling,K=P.nextSibling,V=K.nextSibling;return a($,()=>g.name),a(b,()=>g.provider_type),a(E,()=>n(g.created_at)),a(W,()=>n(g.last_updated)),F.$$click=()=>e.onPreview(g),P.$$click=()=>e.onTestConnection(g.id),K.$$click=()=>e.onEdit(g),V.$$click=()=>e.onDelete(g.id),N(x=>{var w=t(g.status),L=`状态: ${g.status}`,j=g.status!=="active";return w!==x.e&&((x.e=w)!=null?k.style.setProperty("background-color",w):k.style.removeProperty("background-color")),L!==x.t&&z(k,"title",x.t=L),j!==x.a&&(F.disabled=x.a=j),x},{e:void 0,t:void 0,a:void 0}),m})()})),d}}),null),N(d=>{var g=e.loading,m=e.loading?"正在刷新数据源列表":"刷新数据源列表",h=e.loading?"正在刷新...":"刷新数据源列表";return g!==d.e&&(c.disabled=d.e=g),m!==d.t&&z(c,"aria-label",d.t=m),h!==d.a&&z(c,"title",d.a=h),d},{e:void 0,t:void 0,a:void 0}),i})()}function Or(e){const[t,n]=q({name:e.dataSource.name,config:e.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[i]=q(JSON.stringify(e.dataSource.config||{})),s=()=>{const v=t(),d=v.name!==e.dataSource.name,g=JSON.stringify(v.config)!==i();n(m=>({...m,hasChanges:d||g}))},l=v=>{n(d=>({...d,name:v})),s()},r=v=>{n(d=>({...d,config:v})),s()},o=async()=>{const v=t();n(d=>({...d,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await Se.testConnection(e.dataSource.type_name,v.config)&&(console.log("✅ 连接测试成功"),n(g=>({...g,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(d){console.error("❌ 连接测试失败:",d),n(g=>({...g,testResult:{success:!1,message:"连接测试失败",error:d instanceof Error?d.message:String(d)},loading:!1}))}},u=async()=>{const v=t();if(!v.hasChanges){e.onBack();return}if(!v.name.trim()){n(d=>({...d,error:"数据源名称不能为空"}));return}try{n(d=>({...d,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await Se.updateConfig(e.dataSource.id,v.config),v.name!==e.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),n(d=>({...d,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),e.onSuccess(),e.onBack()}catch(d){console.error("❌ 更新数据源失败:",d),n(g=>({...g,error:`更新失败: ${d}`,loading:!1}))}},c=()=>{n(v=>({...v,name:e.dataSource.name,config:e.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var v=Pr(),d=v.firstChild,g=d.firstChild,m=g.nextSibling,h=m.firstChild,y=h.nextSibling,$=y.firstChild,b=$.nextSibling;b.firstChild;var k=d.nextSibling,S=k.firstChild,A=S.firstChild,T=A.nextSibling,E=T.firstChild,R=E.nextSibling,O=S.nextSibling,W=O.firstChild;W.firstChild;var I=W.nextSibling,F=I.firstChild,P=F.nextSibling,K=O.nextSibling,V=K.firstChild,x=V.firstChild,w=x.nextSibling,L=K.nextSibling,j=L.firstChild,B=j.nextSibling,G=B.firstChild,ce=G.firstChild,ne=ce.nextSibling,J=G.nextSibling,re=J.firstChild,be=re.nextSibling,ae=J.nextSibling,Q=ae.firstChild,ie=Q.nextSibling,he=L.nextSibling,ye=he.firstChild,ge=ye.nextSibling;return ke(g,"click",e.onBack),a($,()=>e.dataSource.type_name),a(b,()=>e.dataSource.id,null),R.$$input=X=>l(X.currentTarget.value),a(W,f(U,{get when(){return t().hasChanges},get children(){return Sr()}}),null),P.$$input=X=>{try{const ve=JSON.parse(X.currentTarget.value);r(ve),n(pe=>({...pe,error:null}))}catch{n(pe=>({...pe,error:"配置格式错误，请检查JSON语法"}))}},w.$$click=o,a(w,()=>t().loading?"测试中...":"测试连接"),a(K,f(U,{get when(){return t().testResult},get children(){var X=kr(),ve=X.firstChild,pe=ve.firstChild;return a(ve,()=>{var ue;return(ue=t().testResult)!=null&&ue.success?"✅":"❌"},pe),a(ve,()=>{var ue;return(ue=t().testResult)==null?void 0:ue.message},null),a(X,f(U,{get when(){var ue;return(ue=t().testResult)==null?void 0:ue.error},get children(){var ue=Cr();return a(ue,()=>{var de;return(de=t().testResult)==null?void 0:de.error}),ue}}),null),N(()=>{var ue;return me(X,`test-result ${(ue=t().testResult)!=null&&ue.success?"success":"error"}`)}),X}}),null),a(ne,()=>e.dataSource.status==="active"?"✅ 活跃":e.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),a(be,()=>new Date(e.dataSource.created_at).toLocaleString("zh-CN")),a(ie,()=>new Date(e.dataSource.last_updated).toLocaleString("zh-CN")),a(k,f(U,{get when(){return t().error},get children(){var X=Er();return X.firstChild,a(X,()=>t().error,null),X}}),he),ke(ye,"click",e.onBack),a(he,f(U,{get when(){return t().hasChanges},get children(){var X=Ar();return X.$$click=c,N(()=>X.disabled=t().loading),X}}),ge),ge.$$click=u,a(ge,(()=>{var X=se(()=>!!t().loading);return()=>X()?"保存中...":t().hasChanges?"保存更改":"无更改"})()),N(X=>{var ze;var ve=t().error&&!t().name.trim()?"error":"",pe=t().error&&((ze=t().error)!=null&&ze.includes("配置格式"))?"error":"",ue=t().loading,de=`status-value status-${e.dataSource.status}`,Te=`save-btn ${t().hasChanges?"has-changes":""}`,Ce=t().loading;return ve!==X.e&&me(R,X.e=ve),pe!==X.t&&me(P,X.t=pe),ue!==X.a&&(w.disabled=X.a=ue),de!==X.o&&me(ne,X.o=de),Te!==X.i&&me(ge,X.i=Te),Ce!==X.n&&(ge.disabled=X.n=Ce),X},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),N(()=>R.value=t().name),N(()=>P.value=JSON.stringify(t().config,null,2)),v})()}function Nr(e){return(()=>{var t=Dr(),n=t.firstChild,i=n.firstChild,s=i.nextSibling;s.firstChild;var l=s.nextSibling,r=l.firstChild,o=r.nextSibling,u=o.nextSibling,c=u.nextSibling;c.nextSibling;var v=n.nextSibling,d=v.firstChild,g=d.firstChild,m=g.firstChild,h=g.nextSibling;return ke(i,"click",e.onBack),a(s,()=>e.dataSource.name,null),a(l,()=>e.data.total_rows,o),a(l,()=>e.data.rows.length,c),a(m,f(fe,{get each(){return e.data.columns},children:y=>(()=>{var $=Tr();return a($,y),$})()})),a(h,f(fe,{get each(){return e.data.rows.slice(0,50)},children:y=>(()=>{var $=zr();return a($,f(fe,{get each(){return e.data.columns},children:b=>(()=>{var k=Lr();return a(k,(()=>{var S=se(()=>typeof y[b]=="object");return()=>S()?JSON.stringify(y[b]):String(y[b]||"")})()),k})()})),$})()})),t})()}Re(["click","input"]);var Ur=p("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Fr=p("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Ir=p("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),Br=p("<div class=current-record>"),jr=p("<div class=empty-record>暂无记录数据"),Hr=p("<div class=available-fields>"),Jr=p("<div class=no-fields>暂无可用字段"),Vr=p('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),Wr=p("<div class=record-field><div class=field-key>:</div><div class=field-value>"),qr=p("<div class=field-display-name>"),Kr=p("<div class=field-sample>示例: "),Gr=p("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),Xr=p("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),Yr=p('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const Zr=()=>{const[e,t]=q(null),[n,i]=q(!1);Tt(()=>{const c=Ye.subscribe(v=>{t(v)});return t(Ye.getCurrentContext()),c});const s=xe(()=>{const c=e();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),l=async()=>{i(!0);try{await Ye.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{i(!1)}},r=async()=>{i(!0);try{await Ye.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{i(!1)}},o=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),u=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Ir(),v=c.firstChild,d=v.firstChild,g=d.nextSibling,m=g.firstChild,h=m.nextSibling;return a(m,()=>s().icon),a(h,()=>s().text),a(c,f(U,{get when(){return e()},children:y=>(()=>{var $=Vr(),b=$.firstChild,k=b.firstChild,S=k.nextSibling,A=S.firstChild,T=A.firstChild,E=T.nextSibling,R=A.nextSibling,O=R.firstChild,W=O.nextSibling,I=R.nextSibling,F=I.firstChild,P=F.nextSibling,K=b.nextSibling,V=K.firstChild,x=V.nextSibling,w=x.firstChild,L=w.nextSibling,j=L.firstChild,B=L.nextSibling,G=K.nextSibling;G.firstChild;var ce=G.nextSibling,ne=ce.firstChild,J=ne.firstChild,re=J.nextSibling,be=re.firstChild,ae=be.nextSibling;return ae.nextSibling,a(E,()=>y().dataSource.name),a(W,()=>y().dataSource.type.toUpperCase()),a(P,()=>y().dataSource.id),w.$$click=r,a(L,()=>y().currentRecord.index+1,j),a(L,()=>y().currentRecord.total,null),B.$$click=l,a(G,f(U,{get when(){return Object.keys(y().currentRecord.data).length>0},get children(){var Q=Br();return a(Q,f(fe,{get each(){return Object.entries(y().currentRecord.data)},children:([ie,he])=>(()=>{var ye=Wr(),ge=ye.firstChild,X=ge.firstChild,ve=ge.nextSibling;return a(ge,ie,X),a(ve,()=>o(he)),ye})()})),Q}}),null),a(G,f(U,{get when(){return Object.keys(y().currentRecord.data).length===0},get children(){return jr()}}),null),a(re,()=>y().fields.length,ae),a(ce,f(U,{get when(){return y().fields.length>0},get children(){var Q=Hr();return a(Q,f(fe,{get each(){return y().fields},children:ie=>(()=>{var he=Gr(),ye=he.firstChild,ge=ye.firstChild,X=ge.nextSibling,ve=X.firstChild,pe=ve.nextSibling;pe.nextSibling;var ue=ye.nextSibling,de=ue.firstChild,Te=de.nextSibling;return a(ge,()=>ie.name),a(X,()=>u(ie.type),pe),a(he,f(U,{get when(){return ie.displayName&&ie.displayName!==ie.name},get children(){var Ce=qr();return a(Ce,()=>ie.displayName),Ce}}),ue),a(he,f(U,{get when(){return ie.sample!==void 0},get children(){var Ce=Kr();return Ce.firstChild,a(Ce,()=>o(ie.sample),null),Ce}}),ue),a(Te,()=>`{${ie.name}}`),he})()})),Q}}),null),a(ce,f(U,{get when(){return y().fields.length===0},get children(){return Jr()}}),null),a($,f(U,{get when(){return y().error},children:Q=>(()=>{var ie=Yr(),he=ie.firstChild,ye=he.nextSibling,ge=ye.firstChild;ge.firstChild;var X=ge.nextSibling;return X.firstChild,a(ge,()=>Q().type,null),a(X,()=>Q().message,null),a(ye,f(U,{get when(){return Q().details},get children(){var ve=Xr(),pe=ve.firstChild,ue=pe.nextSibling;return a(ue,()=>JSON.stringify(Q().details,null,2)),ve}}),null),ie})()}),null),N(Q=>{var ie=n()||y().currentRecord.index<=0,he=n()||y().currentRecord.index>=y().currentRecord.total-1;return ie!==Q.e&&(w.disabled=Q.e=ie),he!==Q.t&&(B.disabled=Q.t=he),Q},{e:void 0,t:void 0}),$})()}),null),a(c,f(U,{get when(){return!e()},get children(){return Ur()}}),null),a(c,f(U,{get when(){return n()},get children(){return Fr()}}),null),N(y=>(y=s().color)!=null?h.style.setProperty("color",y):h.style.removeProperty("color")),c})()};Re(["click"]);var Qr=p("<input type=text class=search-input placeholder=搜索数据源...>"),ea=p("<button class=add-data-source-btn>+ 新建数据源"),ta=p("<div class=error-message>"),na=p("<div class=loading-message>加载中..."),ia=p("<div class=empty-state><p></p><button>添加第一个数据源"),la=p("<div class=data-source-grid>"),sa=p("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),ra=p("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),aa=p("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),oa=p("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),ca=p("<li><button> <!> (<!>)"),da=p("<th>"),ua=p("<tr>"),ha=p("<td>"),ga=p('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function fa(e){const[t,n]=q([]),[i,s]=q([]),[l,r]=q("main"),[o,u]=q(null),[c,v]=q(null),[d,g]=q(!1),[m,h]=q(null),[y,$]=q(""),[b,k]=q("all"),[S,A]=q("all");Je(async()=>{try{await T(),await E()}catch(w){console.error("🚨 数据源管理中心初始化失败:",w),h(`初始化失败: ${w}`)}});const T=async()=>{try{g(!0),console.log("🔄 加载数据源列表...");const w=await Se.listDataSources();console.log("✅ 数据源列表加载成功:",w),n(w),h(null)}catch(w){console.error("❌ 加载数据源失败:",w),h(`加载数据源失败: ${w}`)}finally{g(!1)}},E=async()=>{try{console.log("🔄 加载可用数据源类型...");const w=await Se.getAvailableTypes();console.log("✅ 数据源类型加载成功:",w),s(w)}catch(w){console.error("❌ 加载数据源类型失败:",w)}},R=()=>{let w=t();if(y()){const L=y().toLowerCase();w=w.filter(j=>j.name.toLowerCase().includes(L)||j.type_name.toLowerCase().includes(L))}return b()!=="all"&&(w=w.filter(L=>L.status===b())),S()!=="all"&&(w=w.filter(L=>L.type_name===S())),w},O=w=>t().filter(L=>L.status===w).length,W=w=>t().filter(L=>L.type_name===w).length,I=()=>{r("add"),u(null)},F=w=>{u(w),r("edit")},P=async w=>{try{g(!0),h(null),u(w),console.log("🔄 开始预览数据源:",w.name);const L=await Se.getPreview(w.id);v(L),r("preview"),console.log("✅ 数据预览加载成功:",L)}catch(L){console.error("❌ 数据预览失败:",L),h(`预览数据源 "${w.name}" 失败: ${L}`)}finally{g(!1)}},K=async w=>{try{g(!0);const L=t().find(B=>B.id===w);if(!L){h(`数据源不存在: ${w}`);return}const j=await Se.testConnection(L.type_name,L.config||{});alert(j?`✅ 数据源 "${L.name}" 连接测试成功！`:`❌ 数据源 "${L.name}" 连接测试失败`)}catch(L){console.error("❌ 测试连接失败:",L);const j=t().find(B=>B.id===w);alert(`❌ 数据源 "${(j==null?void 0:j.name)||w}" 连接测试失败:
${L}`)}finally{g(!1)}},V=async w=>{const L=t().find(j=>j.id===w);if(confirm(`确定要删除数据源 "${L==null?void 0:L.name}" 吗？`))try{await Se.deleteDataSource(w),await T()}catch(j){h(`删除数据源失败: ${j}`)}},x=()=>{r("main"),u(null),v(null),h(null)};return f(U,{get when(){return e.isOpen},get children(){var w=oa(),L=w.firstChild,j=L.firstChild,B=j.nextSibling,G=B.nextSibling,ce=L.nextSibling;return ke(j,"click",e.onClose),a(G,f(U,{get when(){return l()==="main"},get children(){return[(()=>{var ne=Qr();return ne.$$input=J=>$(J.currentTarget.value),N(()=>ne.value=y()),ne})(),(()=>{var ne=ea();return ne.$$click=I,ne})()]}})),a(ce,f(U,{get when(){return l()==="main"},get children(){var ne=sa(),J=ne.firstChild,re=J.firstChild,be=re.firstChild,ae=be.nextSibling,Q=ae.firstChild,ie=Q.firstChild,he=ie.firstChild,ye=he.nextSibling;ye.nextSibling;var ge=re.nextSibling,X=ge.firstChild,ve=X.nextSibling,pe=ve.firstChild,ue=pe.firstChild,de=ue.firstChild,Te=de.nextSibling;Te.nextSibling;var Ce=pe.nextSibling,ze=Ce.firstChild,_=ze.firstChild,C=_.nextSibling;C.nextSibling;var M=Ce.nextSibling,D=M.firstChild,H=D.firstChild,Y=H.nextSibling;Y.nextSibling;var Z=ge.nextSibling,$e=Z.firstChild,_e=$e.nextSibling,te=_e.firstChild,Fe=te.firstChild,Me=J.nextSibling;return ie.$$click=()=>k("all"),a(ie,()=>t().length,ye),ue.$$click=()=>k("active"),a(ue,()=>O("active"),Te),ze.$$click=()=>k("error"),a(ze,()=>O("error"),C),D.$$click=()=>k("disabled"),a(D,()=>O("disabled"),Y),Fe.$$click=()=>A("all"),a(_e,f(fe,{get each(){return i()},children:oe=>(()=>{var Pe=ca(),Ae=Pe.firstChild,et=Ae.firstChild,tt=et.nextSibling,ct=tt.nextSibling,Lt=ct.nextSibling;return Lt.nextSibling,Ae.$$click=()=>A(oe.type_name),a(Ae,()=>oe.category==="file"?"📄":oe.category==="api"?"🌐":oe.category==="database"?"🗄️":"📊",et),a(Ae,()=>oe.display_name,tt),a(Ae,()=>W(oe.type_name),Lt),N(()=>me(Pe,S()===oe.type_name?"active":"")),Pe})()}),null),a(Me,f(U,{get when(){return m()},get children(){var oe=ta();return a(oe,m),oe}}),null),a(Me,f(U,{get when(){return d()},get children(){return na()}}),null),a(Me,f(U,{get when(){return se(()=>!d())()&&R().length===0},get children(){var oe=ia(),Pe=oe.firstChild,Ae=Pe.nextSibling;return a(Pe,()=>y()||b()!=="all"||S()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),Ae.$$click=I,oe}}),null),a(Me,f(U,{get when(){return se(()=>!d())()&&R().length>0},get children(){var oe=la();return a(oe,f(fe,{get each(){return R()},children:Pe=>f(va,{source:Pe,onPreview:()=>P(Pe),onTest:()=>K(Pe.id),onEdit:()=>F(Pe),onDelete:()=>V(Pe.id)})})),oe}}),null),N(oe=>{var Pe=b()==="all"?"active":"",Ae=b()==="active"?"active":"",et=b()==="error"?"active":"",tt=b()==="disabled"?"active":"",ct=S()==="all"?"active":"";return Pe!==oe.e&&me(Q,oe.e=Pe),Ae!==oe.t&&me(pe,oe.t=Ae),et!==oe.a&&me(Ce,oe.a=et),tt!==oe.o&&me(M,oe.o=tt),ct!==oe.i&&me(te,oe.i=ct),oe},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ne}}),null),a(ce,f(U,{get when(){return l()==="add"},get children(){return f(pn,{get availableTypes(){return i()},onBack:x,onSuccess:()=>{T(),x()}})}}),null),a(ce,f(U,{get when(){return se(()=>l()==="edit")()&&o()},get children(){var ne=ra(),J=ne.firstChild,re=J.firstChild,be=re.nextSibling;return be.firstChild,re.$$click=x,a(be,()=>{var ae;return(ae=o())==null?void 0:ae.name},null),ne}}),null),a(ce,f(U,{get when(){return se(()=>!!(l()==="preview"&&o()))()&&c()},get children(){var ne=aa(),J=ne.firstChild,re=J.firstChild,be=re.nextSibling;be.firstChild;var ae=be.nextSibling,Q=ae.firstChild,ie=Q.nextSibling,he=ie.nextSibling,ye=he.nextSibling;ye.nextSibling;var ge=J.nextSibling,X=ge.firstChild,ve=X.firstChild,pe=ve.firstChild,ue=ve.nextSibling;return re.$$click=x,a(be,()=>{var de;return(de=o())==null?void 0:de.name},null),a(ae,()=>{var de;return(de=c())==null?void 0:de.total_rows},ie),a(ae,()=>{var de;return(de=c())==null?void 0:de.rows.length},ye),a(pe,f(fe,{get each(){var de;return(de=c())==null?void 0:de.columns},children:de=>(()=>{var Te=da();return a(Te,de),Te})()})),a(ue,f(fe,{get each(){var de;return(de=c())==null?void 0:de.rows.slice(0,50)},children:de=>(()=>{var Te=ua();return a(Te,f(fe,{get each(){var Ce;return((Ce=c())==null?void 0:Ce.columns)||[]},children:Ce=>(()=>{var ze=ha();return a(ze,(()=>{var _=se(()=>typeof de[Ce]=="object");return()=>_()?JSON.stringify(de[Ce]):String(de[Ce]||"")})()),ze})()})),Te})()})),ne}}),null),w}})}function va(e){const t=l=>{switch(l){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=l=>{switch(l){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},i=l=>{const r=new Date,o=new Date(l),u=r.getTime()-o.getTime(),c=Math.floor(u/(1e3*60*60));return c<1?"刚刚更新":c<24?`${c}小时前`:o.toLocaleDateString("zh-CN")},s=l=>l.toLowerCase().includes("json")?"📄":l.toLowerCase().includes("api")?"🌐":l.toLowerCase().includes("csv")?"📊":l.toLowerCase().includes("database")?"🗄️":"📋";return(()=>{var l=ga(),r=l.firstChild,o=r.firstChild,u=o.firstChild,c=u.nextSibling,v=o.nextSibling,d=r.nextSibling,g=d.firstChild,m=g.firstChild,h=m.nextSibling,y=g.nextSibling,$=y.firstChild,b=$.nextSibling,k=y.nextSibling,S=k.firstChild,A=S.nextSibling,T=d.nextSibling,E=T.firstChild,R=E.nextSibling,O=R.nextSibling,W=O.nextSibling;return a(u,()=>s(e.source.type_name)),a(c,()=>e.source.name),a(h,()=>e.source.type_name),a(b,()=>n(e.source.status)),a(A,()=>i(e.source.last_updated)),ke(E,"click",e.onPreview),ke(R,"click",e.onTest),ke(O,"click",e.onEdit),ke(W,"click",e.onDelete),N(I=>{var F=t(e.source.status),P=`状态: ${n(e.source.status)}`,K=e.source.status!=="active";return F!==I.e&&((I.e=F)!=null?v.style.setProperty("background-color",F):v.style.removeProperty("background-color")),P!==I.t&&z(v,"title",I.t=P),K!==I.a&&(E.disabled=I.a=K),I},{e:void 0,t:void 0,a:void 0}),l})()}Re(["click","input"]);var ma=p('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden"><div class="w-80 bg-primary border-r border-default flex flex-col"></div><div class="flex-1 flex flex-col bg-tertiary"></div><div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">');const ya=()=>{const[e,t]=q(!1),[n,i]=q(!1),s=()=>{i(!0)},l=()=>t(!1),r=()=>i(!1);return f(Bn,{get children(){var o=ma(),u=o.firstChild,c=u.firstChild,v=c.nextSibling,d=v.nextSibling,g=d.firstChild,m=g.firstChild,h=m.nextSibling;return a(o,f(ei,{onOpenDataSources:s}),u),a(c,f(ii,{})),a(v,f(ls,{})),a(m,f(hl,{})),a(h,f(Zr,{})),a(o,f(fa,{get isOpen(){return n()},onClose:r}),null),a(o,f(Mr,{get isOpen(){return e()},onClose:l}),null),o}})},pa={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},ba=()=>{const{state:e,copySelectedElements:t,pasteElements:n,deleteElements:i,undo:s,redo:l,selectAllElements:r,clearSelection:o,moveElements:u}=We(),c=(h,y)=>{const $=h.key.toLowerCase()===y.key.toLowerCase()||h.key===y.key,b=!!y.ctrl===(h.ctrlKey||h.metaKey),k=!!y.alt===h.altKey,S=!!y.shift===h.shiftKey;return $&&b&&k&&S},v=async h=>{console.log("🎯 执行快捷键:",h);try{switch(h){case"copy":e.selected_ids.length>0&&(await t(),g("复制成功","✅"));break;case"paste":const y={x:20,y:20},$=await n(y.x,y.y);$.length>0&&g(`粘贴 ${$.length} 个元素`,"📋");break;case"cut":e.selected_ids.length>0&&(await t(),await i([...e.selected_ids]),g("剪切成功","✂️"));break;case"delete":if(e.selected_ids.length>0){const b=e.selected_ids.length;await i([...e.selected_ids]),g(`删除 ${b} 个元素`,"🗑️")}break;case"undo":await s(),g("撤销","↶");break;case"redo":await l(),g("重做","↷");break;case"selectAll":await r(),g(`全选 ${e.elements.length} 个元素`,"🎯");break;case"clearSelection":e.selected_ids.length>0&&(o(),g("清除选择","⭕"));break;case"duplicate":if(e.selected_ids.length>0){await t();const b=await n(20,20);g(`复制 ${b.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await d(h);break;default:console.warn("未知的快捷键动作:",h)}}catch(y){console.error("快捷键执行失败:",y),g("操作失败","❌")}},d=async h=>{if(e.selected_ids.length===0)return;const y=h.includes("Fast"),$=y?10:1;let b=0,k=0;switch(h){case"moveUp":case"moveFastUp":k=-$;break;case"moveDown":case"moveFastDown":k=$;break;case"moveLeft":case"moveFastLeft":b=-$;break;case"moveRight":case"moveFastRight":b=$;break}(b!==0||k!==0)&&(await u([...e.selected_ids],b,k),y&&g(`快速移动 ${$}px`,"🔄"))},g=(h,y)=>{const $=document.createElement("div");$.className="keyboard-feedback",$.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${y}</span>
        <span class="feedback-text">${h}</span>
      </div>
    `,document.body.appendChild($),setTimeout(()=>{$.parentNode&&$.parentNode.removeChild($)},2e3)},m=h=>{const y=h.target;if(!(y.tagName==="INPUT"||y.tagName==="TEXTAREA"||y.contentEditable==="true")){for(const[b,k]of Object.entries(pa))if(c(h,k.combination)){h.preventDefault(),h.stopPropagation(),console.log("🎹 快捷键触发:",b,k.action),v(k.action);return}}};return Je(()=>{if(document.addEventListener("keydown",m,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const h=document.createElement("style");h.id="keyboard-feedback-styles",h.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(h)}}),_t(()=>{document.removeEventListener("keydown",m,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},$a=()=>(Je(()=>{document.addEventListener("contextmenu",e=>e.preventDefault())}),f(Gn,{get children(){return[f(ba,{}),f(ya,{})]}})),_a=document.getElementById("root");Mn(()=>f($a,{}),_a);
