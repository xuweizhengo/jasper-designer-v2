var wn=Object.defineProperty;var Sn=(t,e,n)=>e in t?wn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Ie=(t,e,n)=>Sn(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const s of l)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(l){const s={};return l.integrity&&(s.integrity=l.integrity),l.referrerPolicy&&(s.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?s.credentials="include":l.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(l){if(l.ep)return;l.ep=!0;const s=n(l);fetch(l.href,s)}})();const Cn=!1,kn=(t,e)=>t===e,Ge=Symbol("solid-proxy"),Dt=Symbol("solid-track"),ht={equals:kn};let Kt=tn;const Ve=1,gt=2,Gt={owned:null,cleanups:null,context:null,owner:null};var Ce=null;let wt=null,En=null,ke=null,Ae=null,He=null,_t=0;function ut(t,e){const n=ke,i=Ce,l=t.length===0,s=e===void 0?i:e,r=l?Gt:{owned:null,cleanups:null,context:s?s.context:null,owner:s},o=l?t:()=>t(()=>Re(()=>rt(r)));Ce=r,ke=null;try{return et(o,!0)}finally{ke=n,Ce=i}}function K(t,e){e=e?Object.assign({},ht,e):ht;const n={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},i=l=>(typeof l=="function"&&(l=l(n.value)),en(n,l));return[Zt.bind(n),i]}function N(t,e,n){const i=Rt(t,e,!1,Ve);ct(i)}function Mt(t,e,n){Kt=Pn;const i=Rt(t,e,!1,Ve);i.user=!0,He?He.push(i):ct(i)}function be(t,e,n){n=n?Object.assign({},ht,n):ht;const i=Rt(t,e,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=n.equals||void 0,ct(i),Zt.bind(i)}function Tn(t){return et(t,!1)}function Re(t){if(ke===null)return t();const e=ke;ke=null;try{return t()}finally{ke=e}}function Je(t){Mt(()=>Re(t))}function xt(t){return Ce===null||(Ce.cleanups===null?Ce.cleanups=[t]:Ce.cleanups.push(t)),t}function At(){return ke}const[co,uo]=K(!1);function Xt(t,e){const n=Symbol("context");return{id:n,Provider:Ln(n),defaultValue:t}}function Yt(t){let e;return Ce&&Ce.context&&(e=Ce.context[t.id])!==void 0?e:t.defaultValue}function Qt(t){const e=be(t),n=be(()=>Pt(e()));return n.toArray=()=>{const i=n();return Array.isArray(i)?i:i!=null?[i]:[]},n}function Zt(){if(this.sources&&this.state)if(this.state===Ve)ct(this);else{const t=Ae;Ae=null,et(()=>vt(this),!1),Ae=t}if(ke){const t=this.observers?this.observers.length:0;ke.sources?(ke.sources.push(this),ke.sourceSlots.push(t)):(ke.sources=[this],ke.sourceSlots=[t]),this.observers?(this.observers.push(ke),this.observerSlots.push(ke.sources.length-1)):(this.observers=[ke],this.observerSlots=[ke.sources.length-1])}return this.value}function en(t,e,n){let i=t.value;return(!t.comparator||!t.comparator(i,e))&&(t.value=e,t.observers&&t.observers.length&&et(()=>{for(let l=0;l<t.observers.length;l+=1){const s=t.observers[l],r=wt&&wt.running;r&&wt.disposed.has(s),(r?!s.tState:!s.state)&&(s.pure?Ae.push(s):He.push(s),s.observers&&nn(s)),r||(s.state=Ve)}if(Ae.length>1e6)throw Ae=[],new Error},!1)),e}function ct(t){if(!t.fn)return;rt(t);const e=_t;Dn(t,t.value,e)}function Dn(t,e,n){let i;const l=Ce,s=ke;ke=Ce=t;try{i=t.fn(e)}catch(r){return t.pure&&(t.state=Ve,t.owned&&t.owned.forEach(rt),t.owned=null),t.updatedAt=n+1,ln(r)}finally{ke=s,Ce=l}(!t.updatedAt||t.updatedAt<=n)&&(t.updatedAt!=null&&"observers"in t?en(t,i):t.value=i,t.updatedAt=n)}function Rt(t,e,n,i=Ve,l){const s={fn:t,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:Ce,context:Ce?Ce.context:null,pure:n};return Ce===null||Ce!==Gt&&(Ce.owned?Ce.owned.push(s):Ce.owned=[s]),s}function ft(t){if(t.state===0)return;if(t.state===gt)return vt(t);if(t.suspense&&Re(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<_t);)t.state&&e.push(t);for(let n=e.length-1;n>=0;n--)if(t=e[n],t.state===Ve)ct(t);else if(t.state===gt){const i=Ae;Ae=null,et(()=>vt(t,e[0]),!1),Ae=i}}function et(t,e){if(Ae)return t();let n=!1;e||(Ae=[]),He?n=!0:He=[],_t++;try{const i=t();return An(n),i}catch(i){n||(He=null),Ae=null,ln(i)}}function An(t){if(Ae&&(tn(Ae),Ae=null),t)return;const e=He;He=null,e.length&&et(()=>Kt(e),!1)}function tn(t){for(let e=0;e<t.length;e++)ft(t[e])}function Pn(t){let e,n=0;for(e=0;e<t.length;e++){const i=t[e];i.user?t[n++]=i:ft(i)}for(e=0;e<n;e++)ft(t[e])}function vt(t,e){t.state=0;for(let n=0;n<t.sources.length;n+=1){const i=t.sources[n];if(i.sources){const l=i.state;l===Ve?i!==e&&(!i.updatedAt||i.updatedAt<_t)&&ft(i):l===gt&&vt(i,e)}}}function nn(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=gt,n.pure?Ae.push(n):He.push(n),n.observers&&nn(n))}}function rt(t){let e;if(t.sources)for(;t.sources.length;){const n=t.sources.pop(),i=t.sourceSlots.pop(),l=n.observers;if(l&&l.length){const s=l.pop(),r=n.observerSlots.pop();i<l.length&&(s.sourceSlots[r]=i,l[i]=s,n.observerSlots[i]=r)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)rt(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)rt(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function zn(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function ln(t,e=Ce){throw zn(t)}function Pt(t){if(typeof t=="function"&&!t.length)return Pt(t());if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n++){const i=Pt(t[n]);Array.isArray(i)?e.push.apply(e,i):e.push(i)}return e}return t}function Ln(t,e){return function(i){let l;return N(()=>l=Re(()=>(Ce.context={...Ce.context,[t]:i.value},Qt(()=>i.children))),void 0),l}}const Mn=Symbol("fallback");function Nt(t){for(let e=0;e<t.length;e++)t[e]()}function Rn(t,e,n={}){let i=[],l=[],s=[],r=0,o=e.length>1?[]:null;return xt(()=>Nt(s)),()=>{let u=t()||[],c=u.length,f,d;return u[Dt],Re(()=>{let p,g,y,w,b,$,S,D,z;if(c===0)r!==0&&(Nt(s),s=[],i=[],l=[],r=0,o&&(o=[])),n.fallback&&(i=[Mn],l[0]=ut(T=>(s[0]=T,n.fallback())),r=1);else if(r===0){for(l=new Array(c),d=0;d<c;d++)i[d]=u[d],l[d]=ut(v);r=c}else{for(y=new Array(c),w=new Array(c),o&&(b=new Array(c)),$=0,S=Math.min(r,c);$<S&&i[$]===u[$];$++);for(S=r-1,D=c-1;S>=$&&D>=$&&i[S]===u[D];S--,D--)y[D]=l[S],w[D]=s[S],o&&(b[D]=o[S]);for(p=new Map,g=new Array(D+1),d=D;d>=$;d--)z=u[d],f=p.get(z),g[d]=f===void 0?-1:f,p.set(z,d);for(f=$;f<=S;f++)z=i[f],d=p.get(z),d!==void 0&&d!==-1?(y[d]=l[f],w[d]=s[f],o&&(b[d]=o[f]),d=g[d],p.set(z,d)):s[f]();for(d=$;d<c;d++)d in y?(l[d]=y[d],s[d]=w[d],o&&(o[d]=b[d],o[d](d))):l[d]=ut(v);l=l.slice(0,r=c),i=u.slice(0)}return l});function v(p){if(s[d]=p,o){const[g,y]=K(d);return o[d]=y,e(u[d],g)}return e(u[d])}}}function h(t,e){return Re(()=>t(e||{}))}const sn=t=>`Stale read from <${t}>.`;function ge(t){const e="fallback"in t&&{fallback:()=>t.fallback};return be(Rn(()=>t.each,t.children,e||void 0))}function O(t){const e=t.keyed,n=be(()=>t.when,void 0,void 0),i=e?n:be(n,void 0,{equals:(l,s)=>!l==!s});return be(()=>{const l=i();if(l){const s=t.children;return typeof s=="function"&&s.length>0?Re(()=>s(e?l:()=>{if(!Re(i))throw sn("Show");return n()})):s}return t.fallback},void 0,void 0)}function On(t){const e=Qt(()=>t.children),n=be(()=>{const i=e(),l=Array.isArray(i)?i:[i];let s=()=>{};for(let r=0;r<l.length;r++){const o=r,u=l[r],c=s,f=be(()=>c()?void 0:u.when,void 0,void 0),d=u.keyed?f:be(f,void 0,{equals:(v,p)=>!v==!p});s=()=>c()||(d()?[o,f,u]:void 0)}return s});return be(()=>{const i=n()();if(!i)return t.fallback;const[l,s,r]=i,o=r.children;return typeof o=="function"&&o.length>0?Re(()=>o(r.keyed?s():()=>{var c;if(((c=Re(n)())==null?void 0:c[0])!==l)throw sn("Match");return s()})):o},void 0,void 0)}function it(t){return t}const ce=t=>be(()=>t());function Nn(t,e,n){let i=n.length,l=e.length,s=i,r=0,o=0,u=e[l-1].nextSibling,c=null;for(;r<l||o<s;){if(e[r]===n[o]){r++,o++;continue}for(;e[l-1]===n[s-1];)l--,s--;if(l===r){const f=s<i?o?n[o-1].nextSibling:n[s-o]:u;for(;o<s;)t.insertBefore(n[o++],f)}else if(s===o)for(;r<l;)(!c||!c.has(e[r]))&&e[r].remove(),r++;else if(e[r]===n[s-1]&&n[o]===e[l-1]){const f=e[--l].nextSibling;t.insertBefore(n[o++],e[r++].nextSibling),t.insertBefore(n[--s],f),e[l]=n[s]}else{if(!c){c=new Map;let d=o;for(;d<s;)c.set(n[d],d++)}const f=c.get(e[r]);if(f!=null)if(o<f&&f<s){let d=r,v=1,p;for(;++d<l&&d<s&&!((p=c.get(e[d]))==null||p!==f+v);)v++;if(v>f-o){const g=e[r];for(;o<f;)t.insertBefore(n[o++],g)}else t.replaceChild(n[o++],e[r++])}else r++;else e[r++].remove()}}}const Ut="_$DX_DELEGATE";function Un(t,e,n,i={}){let l;return ut(s=>{l=s,e===document?t():a(e,t(),e.firstChild?null:void 0,n)},i.owner),()=>{l(),e.textContent=""}}function m(t,e,n,i){let l;const s=()=>{const o=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return o.innerHTML=t,n?o.content.firstChild.firstChild:i?o.firstChild:o.content.firstChild},r=e?()=>Re(()=>document.importNode(l||(l=s()),!0)):()=>(l||(l=s())).cloneNode(!0);return r.cloneNode=r,r}function Le(t,e=window.document){const n=e[Ut]||(e[Ut]=new Set);for(let i=0,l=t.length;i<l;i++){const s=t[i];n.has(s)||(n.add(s),e.addEventListener(s,Fn))}}function M(t,e,n){n==null?t.removeAttribute(e):t.setAttribute(e,n)}function he(t,e){e==null?t.removeAttribute("class"):t.className=e}function Ee(t,e,n,i){Array.isArray(n)?(t[`$$${e}`]=n[0],t[`$$${e}Data`]=n[1]):t[`$$${e}`]=n}function rn(t,e,n){if(!e)return n?M(t,"style"):e;const i=t.style;if(typeof e=="string")return i.cssText=e;typeof n=="string"&&(i.cssText=n=void 0),n||(n={}),e||(e={});let l,s;for(s in n)e[s]==null&&i.removeProperty(s),delete n[s];for(s in e)l=e[s],l!==n[s]&&(i.setProperty(s,l),n[s]=l);return n}function an(t,e,n){return Re(()=>t(e,n))}function a(t,e,n,i){if(n!==void 0&&!i&&(i=[]),typeof e!="function")return mt(t,e,i,n);N(l=>mt(t,e(),l,n),i)}function Fn(t){let e=t.target;const n=`$$${t.type}`,i=t.target,l=t.currentTarget,s=u=>Object.defineProperty(t,"target",{configurable:!0,value:u}),r=()=>{const u=e[n];if(u&&!e.disabled){const c=e[`${n}Data`];if(c!==void 0?u.call(e,c,t):u.call(e,t),t.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(t.target)&&s(e.host),!0},o=()=>{for(;r()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(t,"currentTarget",{configurable:!0,get(){return e||document}}),t.composedPath){const u=t.composedPath();s(u[0]);for(let c=0;c<u.length-2&&(e=u[c],!!r());c++){if(e._$host){e=e._$host,o();break}if(e.parentNode===l)break}}else o();s(i)}function mt(t,e,n,i,l){for(;typeof n=="function";)n=n();if(e===n)return n;const s=typeof e,r=i!==void 0;if(t=r&&n[0]&&n[0].parentNode||t,s==="string"||s==="number"){if(s==="number"&&(e=e.toString(),e===n))return n;if(r){let o=n[0];o&&o.nodeType===3?o.data!==e&&(o.data=e):o=document.createTextNode(e),n=Xe(t,n,i,o)}else n!==""&&typeof n=="string"?n=t.firstChild.data=e:n=t.textContent=e}else if(e==null||s==="boolean")n=Xe(t,n,i);else{if(s==="function")return N(()=>{let o=e();for(;typeof o=="function";)o=o();n=mt(t,o,n,i)}),()=>n;if(Array.isArray(e)){const o=[],u=n&&Array.isArray(n);if(zt(o,e,n,l))return N(()=>n=mt(t,o,n,i,!0)),()=>n;if(o.length===0){if(n=Xe(t,n,i),r)return n}else u?n.length===0?Ft(t,o,i):Nn(t,n,o):(n&&Xe(t),Ft(t,o));n=o}else if(e.nodeType){if(Array.isArray(n)){if(r)return n=Xe(t,n,i,e);Xe(t,n,null,e)}else n==null||n===""||!t.firstChild?t.appendChild(e):t.replaceChild(e,t.firstChild);n=e}}return n}function zt(t,e,n,i){let l=!1;for(let s=0,r=e.length;s<r;s++){let o=e[s],u=n&&n[t.length],c;if(!(o==null||o===!0||o===!1))if((c=typeof o)=="object"&&o.nodeType)t.push(o);else if(Array.isArray(o))l=zt(t,o,u)||l;else if(c==="function")if(i){for(;typeof o=="function";)o=o();l=zt(t,Array.isArray(o)?o:[o],Array.isArray(u)?u:[u])||l}else t.push(o),l=!0;else{const f=String(o);u&&u.nodeType===3&&u.data===f?t.push(u):t.push(document.createTextNode(f))}}return l}function Ft(t,e,n=null){for(let i=0,l=e.length;i<l;i++)t.insertBefore(e[i],n)}function Xe(t,e,n,i){if(n===void 0)return t.textContent="";const l=i||document.createTextNode("");if(e.length){let s=!1;for(let r=e.length-1;r>=0;r--){const o=e[r];if(l!==o){const u=o.parentNode===t;!s&&!r?u?t.replaceChild(l,o):t.insertBefore(l,n):u&&o.remove()}else s=!0}}else t.insertBefore(l,n);return[l]}var In=m("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),Bn=m("<span class=loading-indicator>⏳"),jn=m("<button><span class=button-icon></span><span class=button-text>"),Hn=m("<span class=coming-soon>敬请期待"),qn=m("<div class=error-indicator>❌");const on=Xt(),Jn=t=>{const[e,n]=K({mode:"design",loading:!1,error:void 0}),i=d=>{n(v=>({...v,mode:d,error:void 0})),console.log(`🎯 预览模式切换: ${d==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:d,timestamp:Date.now()}}))},f={state:e,actions:{setMode:i,toggleMode:()=>{const d=e().mode;i(d==="design"?"data":d==="data"?"preview":"design")},setLoading:d=>{n(v=>({...v,loading:d}))},setError:d=>{n(v=>({...v,error:d,loading:!1}))},isDesignMode:()=>e().mode==="design",isDataMode:()=>e().mode==="data",isPreviewMode:()=>e().mode==="preview"}};return h(on.Provider,{value:f,get children(){return t.children}})},cn=()=>{const t=Yt(on);if(!t)throw new Error("usePreview必须在PreviewProvider内使用");return t},Vn=()=>{const{state:t,actions:e}=cn(),n=l=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[l],i=()=>n(t().mode);return(()=>{var l=In(),s=l.firstChild,r=s.firstChild,o=r.nextSibling,u=s.nextSibling;return a(r,()=>i().icon),a(o,()=>i().text),a(s,(()=>{var c=ce(()=>!!t().loading);return()=>c()&&Bn()})(),null),a(u,()=>["design","data","preview"].map(c=>{const f=n(c),d=t().mode===c,v=c==="preview";return(()=>{var p=jn(),g=p.firstChild,y=g.nextSibling;return p.$$click=()=>{if(v){alert(`🔍 预览模式即将推出！

✨ 即将支持的功能：
• 纯净的最终效果预览
• 隐藏所有设计辅助元素
• 只读模式，专注查看输出效果`);return}e.setMode(c)},he(p,`mode-btn ${d?"active":""} ${v?"preview-placeholder":""}`),a(g,()=>f.icon),a(y,()=>f.text),a(p,v&&Hn(),null),N(w=>{var b=t().loading,$=v?"预览模式 - 即将推出":`切换到${f.text}`;return b!==w.e&&(p.disabled=w.e=b),$!==w.t&&M(p,"title",w.t=$),w},{e:void 0,t:void 0}),p})()})),a(l,(()=>{var c=ce(()=>!!t().error);return()=>c()&&(()=>{var f=qn();return N(()=>M(f,"title",t().error)),f})()})(),null),l})()},St={getModeDisplayText:t=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[t],getModeIcon:t=>({design:"🎨",data:"🔗",preview:"🔍"})[t],shouldShowExpression:t=>t==="design",shouldEvaluateExpression:t=>t==="data"||t==="preview",shouldShowDesignAids:t=>t==="design"||t==="data",shouldAllowInteraction:t=>t==="design"||t==="data",isReadOnlyMode:t=>t==="preview",getModeTransitionClass:t=>`mode-${t}-active`};Le(["click"]);const Lt=Symbol("store-raw"),Ze=Symbol("store-node"),Be=Symbol("store-has"),dn=Symbol("store-self");function un(t){let e=t[Ge];if(!e&&(Object.defineProperty(t,Ge,{value:e=new Proxy(t,Gn)}),!Array.isArray(t))){const n=Object.keys(t),i=Object.getOwnPropertyDescriptors(t);for(let l=0,s=n.length;l<s;l++){const r=n[l];i[r].get&&Object.defineProperty(t,r,{enumerable:i[r].enumerable,get:i[r].get.bind(e)})}}return e}function yt(t){let e;return t!=null&&typeof t=="object"&&(t[Ge]||!(e=Object.getPrototypeOf(t))||e===Object.prototype||Array.isArray(t))}function at(t,e=new Set){let n,i,l,s;if(n=t!=null&&t[Lt])return n;if(!yt(t)||e.has(t))return t;if(Array.isArray(t)){Object.isFrozen(t)?t=t.slice(0):e.add(t);for(let r=0,o=t.length;r<o;r++)l=t[r],(i=at(l,e))!==l&&(t[r]=i)}else{Object.isFrozen(t)?t=Object.assign({},t):e.add(t);const r=Object.keys(t),o=Object.getOwnPropertyDescriptors(t);for(let u=0,c=r.length;u<c;u++)s=r[u],!o[s].get&&(l=t[s],(i=at(l,e))!==l&&(t[s]=i))}return t}function pt(t,e){let n=t[e];return n||Object.defineProperty(t,e,{value:n=Object.create(null)}),n}function ot(t,e,n){if(t[e])return t[e];const[i,l]=K(n,{equals:!1,internal:!0});return i.$=l,t[e]=i}function Wn(t,e){const n=Reflect.getOwnPropertyDescriptor(t,e);return!n||n.get||!n.configurable||e===Ge||e===Ze||(delete n.value,delete n.writable,n.get=()=>t[Ge][e]),n}function hn(t){At()&&ot(pt(t,Ze),dn)()}function Kn(t){return hn(t),Reflect.ownKeys(t)}const Gn={get(t,e,n){if(e===Lt)return t;if(e===Ge)return n;if(e===Dt)return hn(t),n;const i=pt(t,Ze),l=i[e];let s=l?l():t[e];if(e===Ze||e===Be||e==="__proto__")return s;if(!l){const r=Object.getOwnPropertyDescriptor(t,e);At()&&(typeof s!="function"||t.hasOwnProperty(e))&&!(r&&r.get)&&(s=ot(i,e,s)())}return yt(s)?un(s):s},has(t,e){return e===Lt||e===Ge||e===Dt||e===Ze||e===Be||e==="__proto__"?!0:(At()&&ot(pt(t,Be),e)(),e in t)},set(){return!0},deleteProperty(){return!0},ownKeys:Kn,getOwnPropertyDescriptor:Wn};function bt(t,e,n,i=!1){if(!i&&t[e]===n)return;const l=t[e],s=t.length;n===void 0?(delete t[e],t[Be]&&t[Be][e]&&l!==void 0&&t[Be][e].$()):(t[e]=n,t[Be]&&t[Be][e]&&l===void 0&&t[Be][e].$());let r=pt(t,Ze),o;if((o=ot(r,e,l))&&o.$(()=>n),Array.isArray(t)&&t.length!==s){for(let u=t.length;u<s;u++)(o=r[u])&&o.$();(o=ot(r,"length",s))&&o.$(t.length)}(o=r[dn])&&o.$()}function gn(t,e){const n=Object.keys(e);for(let i=0;i<n.length;i+=1){const l=n[i];bt(t,l,e[l])}}function Xn(t,e){if(typeof e=="function"&&(e=e(t)),e=at(e),Array.isArray(e)){if(t===e)return;let n=0,i=e.length;for(;n<i;n++){const l=e[n];t[n]!==l&&bt(t,n,l)}bt(t,"length",i)}else gn(t,e)}function st(t,e,n=[]){let i,l=t;if(e.length>1){i=e.shift();const r=typeof i,o=Array.isArray(t);if(Array.isArray(i)){for(let u=0;u<i.length;u++)st(t,[i[u]].concat(e),n);return}else if(o&&r==="function"){for(let u=0;u<t.length;u++)i(t[u],u)&&st(t,[u].concat(e),n);return}else if(o&&r==="object"){const{from:u=0,to:c=t.length-1,by:f=1}=i;for(let d=u;d<=c;d+=f)st(t,[d].concat(e),n);return}else if(e.length>1){st(t[i],e,[i].concat(n));return}l=t[i],n=[i].concat(n)}let s=e[0];typeof s=="function"&&(s=s(l,n),s===l)||i===void 0&&s==null||(s=at(s),i===void 0||yt(l)&&yt(s)&&!Array.isArray(s)?gn(l,s):bt(t,i,s))}function Yn(...[t,e]){const n=at(t||{}),i=Array.isArray(n),l=un(n);function s(...r){Tn(()=>{i&&r.length===1?Xn(n,r[0]):st(n,r)})}return[l,s]}function Qn(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function It(t,e=!1){const n=Qn(),i=`_${n}`;return Object.defineProperty(window,i,{value:l=>(e&&Reflect.deleteProperty(window,i),t==null?void 0:t(l)),writable:!1,configurable:!0}),n}async function X(t,e={}){return new Promise((n,i)=>{const l=It(r=>{n(r),Reflect.deleteProperty(window,`_${s}`)},!0),s=It(r=>{i(r),Reflect.deleteProperty(window,`_${l}`)},!0);window.__TAURI_IPC__({cmd:t,callback:l,error:s,...e})})}const fn=Xt(),Zn=t=>{const[e,n]=Yn({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[i,l]=K(!1),[s,r]=K(null),[o,u]=K(!1),c=async()=>{try{l(!0),console.log("🔄 Loading app state...");const x=await X("get_app_state");console.log("🔄 App state loaded, selected_ids:",x.selected_ids),n(x)}catch(x){console.error("Failed to load app state:",x)}finally{l(!1)}};Je(()=>{c()});const f=async(x,L,A,U={})=>{try{l(!0);const q=await X("create_element",{request:{element_type:x,position:L,size:A,content_data:U}});return await c(),q}catch(q){throw console.error("Failed to create element:",q),q}finally{l(!1)}},d=async(x,L)=>{try{l(!0),await X("update_element",{request:{id:x,updates:L}}),await c()}catch(A){throw console.error("Failed to update element:",A),A}finally{l(!1)}},v=async x=>{try{l(!0),await X("batch_update_positions",{request:{updates:x}}),n(L=>{const A=L.elements.map(U=>{const q=x.find(Z=>Z.element_id===U.id);return q?{...U,position:q.new_position}:U});return{...L,elements:A,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(L){throw console.error("Failed to batch update positions:",L),await c(),L}finally{l(!1)}},p=async x=>{try{l(!0),await X("delete_element",{elementId:x}),await c()}catch(L){throw console.error("Failed to delete element:",L),L}finally{l(!1)}},g=async x=>{try{console.log("Selecting element:",x),await X("select_element",{elementId:x}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",e.selected_ids)}catch(L){throw console.error("Failed to select element:",L),L}},y=async x=>{try{console.log("Selecting multiple elements:",x),x.length>0?(await X("select_multiple",{elementIds:x}),console.log("✅ Multi-select completed for:",x.length,"elements")):await X("clear_selection"),await c()}catch(L){throw console.error("Failed to select multiple elements:",L),L}},w=async x=>{try{console.log("Adding to selection:",x),await X("add_to_selection",{elementId:x}),await c()}catch(L){throw console.error("Failed to add to selection:",L),L}},b=async x=>{try{console.log("Removing from selection:",x),await X("remove_from_selection",{elementId:x}),await c()}catch(L){throw console.error("Failed to remove from selection:",L),L}},$=async x=>{try{console.log("Toggling selection:",x),await X("toggle_selection",{elementId:x}),await c()}catch(L){throw console.error("Failed to toggle selection:",L),L}},S=async()=>{try{await X("clear_selection"),await c()}catch(x){throw console.error("Failed to clear selection:",x),x}},D=async()=>{try{await X("copy_selected")}catch(x){throw console.error("Failed to copy selected elements:",x),x}},V={state:e,setState:n,createElement:f,updateElement:d,batchUpdatePositions:v,deleteElement:p,selectElement:g,selectMultiple:y,addToSelection:w,removeFromSelection:b,toggleSelection:$,clearSelection:S,copySelected:D,copySelectedElements:async()=>D(),pasteElements:async(x,L)=>{try{l(!0);const A=await X("paste_elements",{offsetX:x,offsetY:L});return await c(),A}catch(A){throw console.error("Failed to paste elements:",A),A}finally{l(!1)}},deleteElements:async x=>{try{l(!0);for(const L of x)await X("delete_element",{elementId:L});await c()}catch(L){throw console.error("Failed to delete elements:",L),L}finally{l(!1)}},selectAllElements:async()=>{try{const x=e.elements.map(L=>L.id);await y(x)}catch(x){throw console.error("Failed to select all elements:",x),x}},moveElements:async(x,L,A)=>{try{l(!0);const U=e.elements.filter(q=>x.includes(q.id)).map(q=>({element_id:q.id,new_position:{x:q.position.x+L,y:q.position.y+A}}));U.length>0&&await v(U)}catch(U){throw console.error("Failed to move elements:",U),U}finally{l(!1)}},undo:async()=>{try{l(!0),await X("undo"),await c()}catch(x){throw console.error("Failed to undo:",x),x}finally{l(!1)}},redo:async()=>{try{l(!0),await X("redo"),await c()}catch(x){throw console.error("Failed to redo:",x),x}finally{l(!1)}},updateCanvasConfig:async x=>{try{l(!0),await X("update_canvas_config",{request:x}),await c()}catch(L){throw console.error("Failed to update canvas config:",L),L}finally{l(!1)}},getElementsAtPoint:async(x,L)=>{try{return await X("get_elements_at_point",{x,y:L})}catch(A){return console.error("Failed to get elements at point:",A),[]}},isLoading:i,setLoading:l,dragOperation:s,setDragOperation:r,resizeOperation:o,setResizeOperation:u};return h(fn.Provider,{value:V,get children(){return t.children}})},We=()=>{const t=Yt(fn);if(!t)throw new Error("useAppContext must be used within an AppProvider");return t};async function vn(t){return X("tauri",t)}async function ei(t={}){return typeof t=="object"&&Object.freeze(t),vn({__tauriModule:"Dialog",message:{cmd:"openDialog",options:t}})}async function ti(t={}){return typeof t=="object"&&Object.freeze(t),vn({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:t}})}class Ct{static async loadTemplate(e){return await X("load_jasper_template",{filePath:e})}static async saveTemplate(e,n){await X("save_jasper_template",{template:e,filePath:n})}static async saveTemplateAs(e,n,i){await X("save_template_as",{template:e,filePath:n,format:i})}static async validateTemplate(e){return await X("validate_template",{template:e})}static async createEmptyTemplate(){return await X("create_empty_template")}static async getTemplateInfo(e){return await X("get_template_info",{filePath:e})}static async detectTemplateFormat(e){return await X("detect_template_format",{filePath:e})}static async generateTemplatePreview(e){return await X("generate_template_preview",{template:e})}static async exportTemplateJson(e){return await X("export_template_json",{template:e})}static async importTemplateJson(e){return await X("import_template_json",{jsonData:e})}static async cloneTemplate(e){return await X("clone_template",{template:e})}static async mergeTemplates(e,n){return await X("merge_templates",{baseTemplate:e,overlayTemplate:n})}static async extractTemplateElements(e,n){return await X("extract_template_elements",{template:e,elementIds:n})}}const ni="modulepreload",ii=function(t){return"/"+t},Bt={},li=function(e,n,i){let l=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),o=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));l=Promise.allSettled(n.map(u=>{if(u=ii(u),u in Bt)return;Bt[u]=!0;const c=u.endsWith(".css"),f=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${f}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":ni,c||(d.as="script"),d.crossOrigin="",d.href=u,o&&d.setAttribute("nonce",o),document.head.appendChild(d),c)return new Promise((v,p)=>{d.addEventListener("load",v),d.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${u}`)))})}))}function s(r){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=r,window.dispatchEvent(o),!o.defaultPrevented)throw r}return l.then(r=>{for(const o of r||[])o.status==="rejected"&&s(o.reason);return e().catch(s)})},si=()=>({metadata:{version:"2.0.0",format_version:"1.0.0",created_at:new Date().toISOString(),last_modified:new Date().toISOString(),created_by:"jasper-designer-v2",tags:[],compatibility:{min_jasper_version:"2.0.0",jasperreports_version:"6.20.0"}},canvas:{width:595,height:842,unit:"pt",orientation:"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:!0,size:10,snap:!0,visible:!0},background:{color:"#ffffff"}},data_sources:[],elements:[],parameters:[],variables:[],groups:[]});class kt{static toJasperTemplate(e,n){const i={...si()},l={...i.metadata,...n,last_modified:new Date().toISOString()},s=this.convertCanvasConfig(e.canvas_config),r=e.elements.map(o=>this.convertReportElementToTemplateElement(o));return{...i,metadata:l,canvas:s,elements:r}}static convertCanvasConfig(e){return{width:e.width,height:e.height,unit:"pt",orientation:e.width>e.height?"landscape":"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:e.show_grid,size:e.grid_size,snap:e.snap_to_grid,visible:e.show_grid},background:{color:e.background_color}}}static convertReportElementToTemplateElement(e){const n=this.getElementType(e.content),i=this.convertElementContent(e.content),l=this.convertElementStyle(e.content);return{id:e.id,element_type:n,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},z_index:e.z_index,visible:e.visible,content:i,style:l,data_binding:this.extractDataBinding(e.content)}}static getElementType(e){switch(e.type){case"Text":return"Text";case"DataField":return"DataField";case"Rectangle":return"Rectangle";case"Line":return"Line";case"Image":return"Image";default:return"Text"}}static convertElementContent(e){switch(e.type){case"Text":return{text:e.content,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"DataField":return{expression:e.expression,format:e.format,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"Rectangle":return{color:e.fill_color};case"Line":return{color:e.color};case"Image":return{expression:e.src,text:e.alt};default:return{}}}static convertTextStyleToFont(e){return{family:e.font_family||"Arial",size:e.font_size||12,weight:this.mapFontWeight(e.font_weight),style:"normal"}}static convertTextStyleToAlignment(e){return{horizontal:this.mapTextAlign(e.align),vertical:"middle"}}static convertElementStyle(e){const n={};switch(e.type){case"Rectangle":e.fill_color&&(n.background={color:e.fill_color}),e.border&&(n.border={width:e.border.width,color:e.border.color,style:this.mapBorderStyle(e.border.style)});break;case"Text":case"DataField":e.style.background&&(n.background={color:e.style.background.color}),e.style.border&&(n.border={width:e.style.border.width,color:e.style.border.color,style:this.mapBorderStyle(e.style.border.style)});break}return n}static extractDataBinding(e){if(e.type==="DataField"&&e.data_source_id)return{source_id:e.data_source_id,field_name:this.extractFieldNameFromExpression(e.expression)}}static extractFieldNameFromExpression(e){var i;const n=e.match(/^\{([^}]+)\}$/);return(i=n==null?void 0:n[1])!=null?i:e}static toAppState(e){const n=e.metadata.description||void 0;return{elements:e.elements.map(i=>this.convertTemplateElementToReportElement(i)),canvas_config:this.convertCanvasToCanvasConfig(e.canvas),selected_ids:[],can_undo:!1,can_redo:!1,dirty:!1,...n&&{template_name:n}}}static convertCanvasToCanvasConfig(e){return{width:e.width,height:e.height,zoom:1,offset_x:0,offset_y:0,show_grid:e.grid.enabled,show_rulers:!0,grid_size:e.grid.size,snap_to_grid:e.grid.snap,background_color:e.background.color}}static convertTemplateElementToReportElement(e){const n=this.convertTemplateContentToElementContent(e);return{id:e.id,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},content:n,z_index:e.z_index,visible:e.visible,locked:!1}}static convertTemplateContentToElementContent(e){var n,i,l,s,r,o;switch(e.element_type){case"Text":return{type:"Text",content:e.content.text||"",style:this.convertTemplateStyleToTextStyle(e)};case"DataField":return{type:"DataField",expression:e.content.expression||"{data}",...e.content.format&&{format:e.content.format},style:this.convertTemplateStyleToTextStyle(e),...((n=e.data_binding)==null?void 0:n.source_id)&&{data_source_id:e.data_binding.source_id}};case"Rectangle":return{type:"Rectangle",...((l=(i=e.style)==null?void 0:i.background)==null?void 0:l.color)&&{fill_color:e.style.background.color},...e.content.color&&!((r=(s=e.style)==null?void 0:s.background)!=null&&r.color)&&{fill_color:e.content.color},...((o=e.style)==null?void 0:o.border)&&{border:{color:e.style.border.color,width:e.style.border.width,style:this.mapTemplateBorderStyle(e.style.border.style)}},corner_radius:0,opacity:1};case"Line":return{type:"Line",color:e.content.color||"#000000",width:1,line_style:"Solid",opacity:1};case"Image":return{type:"Image",src:e.content.expression||"",...e.content.text&&{alt:e.content.text}};default:return{type:"Text",content:"Unknown Element",style:this.createDefaultTextStyle()}}}static convertTemplateStyleToTextStyle(e){const n=e.content.font,i=e.content.alignment,l=e.style;return{font_family:(n==null?void 0:n.family)||"Arial",font_size:(n==null?void 0:n.size)||12,font_weight:this.mapTemplateFont(n==null?void 0:n.weight),color:e.content.color||"#000000",align:this.mapTemplateAlignment(i==null?void 0:i.horizontal),background:l!=null&&l.background?{color:l.background.color||"",opacity:1,padding:0}:void 0,border:l!=null&&l.border?{color:l.border.color,width:l.border.width,style:this.mapTemplateBorderStyle(l.border.style),radius:0}:void 0}}static createDefaultTextStyle(){return{font_family:"Arial",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}}static mapFontWeight(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTemplateFont(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTextAlign(e){switch(e){case"Center":return"center";case"Right":return"right";default:return"left"}}static mapTemplateAlignment(e){switch(e){case"center":return"Center";case"right":return"Right";default:return"Left"}}static mapBorderStyle(e){switch(e){case"Dashed":return"dashed";case"Dotted":return"dotted";default:return"solid"}}static mapTemplateBorderStyle(e){switch(e){case"dashed":return"Dashed";case"dotted":return"Dotted";default:return"Solid"}}}var ri=m("<span class=text-warning>●"),ai=m("<span class=ml-2> 个元素"),oi=m('<span class="ml-2 text-primary">已选择 <!> 个'),ci=m('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建模板 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开模板 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存模板 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class="toolbar-btn opacity-50 cursor-not-allowed"title="输出预览 - 即将推出 (PDF/打印预览功能)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>输出预览</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const di=t=>{const{state:e,undo:n,redo:i,updateCanvasConfig:l,setState:s}=We(),[r,o]=K(e.canvas_config.zoom*100),u=async()=>{try{const b=await Ct.createEmptyTemplate(),$=kt.toAppState(b);s($),console.log("✅ 新建模板成功")}catch(b){console.error("❌ 新建模板失败:",b),alert("新建模板失败")}},c=async()=>{try{const b=await ei({title:"打开模板文件",filters:[{name:"Jasper模板",extensions:["jasper","jbin","jrxml"]}],multiple:!1});if(b&&typeof b=="string"){const $=await Ct.loadTemplate(b),S=kt.toAppState($);s({...S,template_name:$.metadata.description||"未命名模板"}),console.log("✅ 模板加载成功:",b)}}catch(b){console.error("❌ 加载模板失败:",b),alert("加载模板失败")}},f=async()=>{try{const b=await ti({title:"保存模板文件",filters:[{name:"Jasper模板",extensions:["jasper"]}],defaultPath:e.template_name||"未命名模板"});if(b){const $=kt.toJasperTemplate(e,{description:e.template_name||"未命名模板"});await Ct.saveTemplate($,b),console.log("✅ 模板保存成功:",b)}}catch(b){console.error("❌ 保存模板失败:",b),alert("保存模板失败")}},d=async b=>{const $=b/100;o(b);try{await l({zoom:$})}catch(S){console.error("Failed to update zoom:",S)}},v=()=>{const b=Math.min(r()+25,500);d(b)},p=()=>{const b=Math.max(r()-25,25);d(b)},g=async()=>{try{await l({show_grid:!e.canvas_config.show_grid})}catch(b){console.error("Failed to toggle grid:",b)}},y=async()=>{try{await l({show_rulers:!e.canvas_config.show_rulers})}catch(b){console.error("Failed to toggle rulers:",b)}},w=async()=>{try{await X("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(b){console.error("Failed to toggle DevTools:",b)}};return(()=>{var b=ci(),$=b.firstChild,S=$.firstChild,D=S.nextSibling,z=D.nextSibling,T=z.nextSibling,_=T.nextSibling,k=_.nextSibling,H=$.nextSibling,F=H.firstChild,j=F.nextSibling,P=j.nextSibling,W=P.nextSibling,V=W.nextSibling,x=V.nextSibling,L=x.nextSibling,A=L.nextSibling,U=A.nextSibling,q=U.nextSibling,Z=q.nextSibling,ue=H.nextSibling,oe=ue.firstChild;return S.$$click=u,D.$$click=c,z.$$click=f,a($,h(Vn,{}),_),_.$$click=()=>{console.log("🔄 数据源按钮被点击！"),t.onOpenDataSources()},k.$$click=()=>{alert(`📄 输出预览即将推出！

✨ 即将支持的功能：
• PDF格式预览
• 打印效果预览
• 分页显示
• 导出设置`)},k.disabled=!0,Ee(F,"click",n),Ee(j,"click",i),W.$$click=p,V.addEventListener("change",I=>{const le=I.target.value;if(le==="fit")console.log("Fit to window");else{const Y=parseInt(le.replace("%",""));d(Y)}}),x.$$click=v,A.$$click=g,U.$$click=y,Z.$$click=w,a(ue,h(O,{get when(){return e.dirty},get children(){return ri()}}),oe),a(oe,()=>e.template_name||"未命名模板"),a(ue,h(O,{get when(){return e.elements.length>0},get children(){var I=ai(),le=I.firstChild;return a(I,()=>e.elements.length,le),I}}),null),a(ue,h(O,{get when(){return e.selected_ids.length>0},get children(){var I=oi(),le=I.firstChild,Y=le.nextSibling;return Y.nextSibling,a(I,()=>e.selected_ids.length,Y),I}}),null),N(I=>{var le=`toolbar-btn-icon ${e.can_undo?"":"opacity-50 cursor-not-allowed"}`,Y=!e.can_undo,te=`撤销${e.undo_description?` (${e.undo_description})`:""} (Ctrl+Z)`,G=`toolbar-btn-icon ${e.can_redo?"":"opacity-50 cursor-not-allowed"}`,ee=!e.can_redo,se=`重做${e.redo_description?` (${e.redo_description})`:""} (Ctrl+Y)`,me=`toolbar-btn-icon ${e.canvas_config.show_grid?"active":""}`,de=`toolbar-btn-icon ${e.canvas_config.show_rulers?"active":""}`;return le!==I.e&&he(F,I.e=le),Y!==I.t&&(F.disabled=I.t=Y),te!==I.a&&M(F,"title",I.a=te),G!==I.o&&he(j,I.o=G),ee!==I.i&&(j.disabled=I.i=ee),se!==I.n&&M(j,"title",I.n=se),me!==I.s&&he(A,I.s=me),de!==I.h&&he(U,I.h=de),I},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),N(()=>V.value=`${Math.round(r())}%`),b})()};Le(["click"]);var ui=m('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),hi=m('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const gi=()=>{const{createElement:t}=We(),[e,n]=K(""),i=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:(c==null?void 0:c.text)||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:(c==null?void 0:c.expression)||"${fieldName}",format:c==null?void 0:c.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:(c==null?void 0:c.fill_color)||"transparent",border:{color:(c==null?void 0:c.border_color)||"#000000",width:(c==null?void 0:c.border_width)||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:(c==null?void 0:c.color)||"#000000",width:(c==null?void 0:c.width)||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:(c==null?void 0:c.src)||"",alt:(c==null?void 0:c.alt)||"图片"})}],l=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],s=[...i,...l],r=()=>{const c=e().toLowerCase();return c?s.filter(f=>f.name.toLowerCase().includes(c)||f.description.toLowerCase().includes(c)):s},o=(c,f)=>{if(console.log("Starting drag for component:",c.id),f.dataTransfer){f.dataTransfer.effectAllowed="copy",f.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const d=document.createElement("div");d.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,d.style.position="absolute",d.style.top="-1000px",document.body.appendChild(d),f.dataTransfer.setDragImage(d,50,20),setTimeout(()=>{document.body.removeChild(d)},0)}},u=async c=>{try{const f=await t(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",f)}catch(f){console.error("Failed to create element:",f)}};return(()=>{var c=ui(),f=c.firstChild,d=f.firstChild,v=d.nextSibling,p=f.nextSibling,g=p.firstChild,y=g.firstChild,w=y.firstChild,b=w.nextSibling,$=y.nextSibling,S=$.firstChild,D=S.nextSibling,z=$.nextSibling,T=z.firstChild,_=T.nextSibling;return v.$$input=k=>n(k.target.value),a(b,h(ge,{get each(){return r().filter(k=>k.category==="basic")},children:k=>h(Et,{component:k,onDrag:H=>o(k,H),onClick:()=>u(k)})})),a(D,h(ge,{get each(){return r().filter(k=>k.category==="data")},children:k=>h(Et,{component:k,onDrag:H=>o(k,H),onClick:()=>u(k)})})),a(_,h(ge,{get each(){return r().filter(k=>k.category==="bank")},children:k=>h(Et,{component:k,onDrag:H=>o(k,H),onClick:()=>u(k)})})),N(()=>v.value=e()),c})()},Et=t=>(()=>{var e=hi(),n=e.firstChild,i=n.firstChild,l=i.nextSibling;return Ee(e,"click",t.onClick),e.addEventListener("dragstart",s=>t.onDrag(s)),M(e,"draggable",!0),a(i,()=>t.component.icon),a(l,()=>t.component.name),N(()=>M(e,"title",t.component.description)),e})();Le(["input","click"]);class xe{static async getAvailableTypes(){return X("get_available_data_source_types")}static async getConfigSchema(e){return X("get_config_schema",{providerType:e})}static async getDefaultConfig(e){return X("get_default_config",{providerType:e})}static async getExampleConfigs(e){return X("get_example_configs",{providerType:e})}static async validateConfig(e,n){return X("validate_config",{providerType:e,config:n})}static async testConnection(e,n){return X("test_data_source_connection",{providerType:e,config:n})}static async createDataSource(e,n,i){return X("create_data_source",{name:e,providerType:n,config:i})}static async listDataSources(){return X("list_data_sources")}static async deleteDataSource(e){return X("delete_data_source",{sourceId:e})}static async updateConfig(e,n){return X("update_data_source_config",{sourceId:e,config:n})}static async getSchema(e){return X("get_data_source_schema",{sourceId:e})}static async refreshSchema(e){return X("refresh_data_source_schema",{sourceId:e})}static async discoverSchema(e,n){return X("discover_schema",{providerType:e,config:n})}static async queryData(e,n){return X("query_data_source",{sourceId:e,query:n})}static async getPreview(e,n,i){return X("get_data_preview",{sourceId:e,path:n,limit:i})}static async searchData(e,n,i,l){return X("search_data",{sourceId:e,searchTerm:n,fields:i,limit:l})}static async evaluateExpression(e,n,i){return X("evaluate_expression",{sourceId:e,expression:n,context:i})}static async evaluateExpressionsBatch(e,n,i){return X("evaluate_expressions_batch",{sourceId:e,expressions:n,context:i})}static async testDatabaseConnection(e){return X("test_database_connection",{config:e})}static async loadDatabaseSchema(e){return X("load_database_schema",{config:e})}static async executeDatabasePreview(e,n,i){return X("execute_database_preview",{config:e,sql:n,limit:i})}static async validateSqlSyntax(e,n){return X("validate_sql_syntax",{sql:e,databaseType:n})}static async formatSql(e,n){return X("format_sql",{sql:e,databaseType:n})}static async explainQuery(e,n){return X("explain_query",{config:e,sql:n})}static async getTableSample(e,n,i){return X("get_table_sample",{config:e,tableName:n,limit:i})}}class fi{constructor(){Ie(this,"styles",new Map);Ie(this,"elementStyleMap",new Map);Ie(this,"observers",new Set);Ie(this,"initialized",!1);console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(e){throw console.error("❌ TextStyleManager 初始化失败:",e),e}}createStyle(e){const n=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={...e,id:n,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(n,i),this.notifyObservers("style-created",n),this.saveUserStyles(),console.log(`🎨 创建新样式: ${i.name} (${n})`),n}getStyle(e){return this.styles.get(e)||null}updateStyle(e,n){const i=this.styles.get(e);if(!i)return console.warn(`⚠️ 样式 ${e} 不存在`),!1;if(i.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${e}`),!1;const l={...i,style:{...i.style,...n},metadata:{...i.metadata,lastModified:new Date}};return this.styles.set(e,l),this.syncAllStyleInstances(e),this.saveUserStyles(),this.notifyObservers("style-updated",e),console.log(`🔄 样式已更新: ${i.name} (${e})`),!0}deleteStyle(e){const n=this.styles.get(e);if(!n)return!1;if(n.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${e}`),!1;const i=Array.from(this.elementStyleMap.entries()).filter(([l,s])=>s===e).map(([l,s])=>l);return i.length>0?(console.warn(`⚠️ 无法删除样式 ${e}，仍有 ${i.length} 个元素在使用`),!1):(this.styles.delete(e),this.saveUserStyles(),this.notifyObservers("style-deleted",e),console.log(`🗑️ 样式已删除: ${n.name} (${e})`),!0)}applyStyleToElement(e,n){const i=this.styles.get(n);if(!i)return{success:!1,elementId:e,styleId:n,appliedAt:new Date,error:`样式 ${n} 不存在`};try{const l=this.elementStyleMap.get(e);if(this.elementStyleMap.set(e,n),i.metadata.usageCount++,l&&l!==n){const s=this.styles.get(l);s&&(s.metadata.usageCount=Math.max(0,s.metadata.usageCount-1))}return this.applyStyleToDOM(e,i.style),this.notifyObservers("style-applied",{elementId:e,styleId:n}),console.log(`🎯 应用样式: ${i.name} → 元素 ${e}`),{success:!0,elementId:e,styleId:n,appliedAt:new Date}}catch(l){return console.error(`❌ 应用样式失败: ${l}`),{success:!1,elementId:e,styleId:n,appliedAt:new Date,error:l instanceof Error?l.message:String(l)}}}getElementStyleId(e){return this.elementStyleMap.get(e)||null}removeElementStyle(e){const n=this.elementStyleMap.get(e);if(n){this.elementStyleMap.delete(e);const i=this.styles.get(n);i&&(i.metadata.usageCount=Math.max(0,i.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${e}`)}}getStylesByCategory(e){const n=Array.from(this.styles.values());return(e?n.filter(l=>l.category===e):n).sort((l,s)=>l.metadata.isSystemStyle!==s.metadata.isSystemStyle?l.metadata.isSystemStyle?-1:1:s.metadata.usageCount-l.metadata.usageCount)}searchStyles(e,n){const i=this.getStylesByCategory(n),l=e.toLowerCase().trim();return l?i.filter(s=>s.name.toLowerCase().includes(l)||s.description.toLowerCase().includes(l)||s.metadata.tags.some(r=>r.toLowerCase().includes(l))):i}getStyleUsageStats(){const e=[];for(const[n,i]of this.styles){const l=Array.from(this.elementStyleMap.entries()).filter(([s,r])=>r===n).map(([s,r])=>s);e.push({styleId:n,usageCount:l.length,elements:l,lastUsed:i.metadata.lastModified})}return e.sort((n,i)=>i.usageCount-n.usageCount)}cleanupUnusedStyles(){const e=new Set(this.elementStyleMap.values()),n=[];for(const[i,l]of this.styles)!e.has(i)&&!l.metadata.isSystemStyle&&(this.styles.delete(i),n.push(i),console.log(`🧹 清理未使用样式: ${l.name} (${i})`));return n.length>0&&this.saveUserStyles(),n}exportStyles(e){const n=e?e.map(l=>this.styles.get(l)).filter(Boolean):Array.from(this.styles.values()),i=new Set(n.map(l=>l.category));return{version:"2.0.0",exportedAt:new Date,styles:n,metadata:{totalStyles:n.length,categories:Array.from(i),author:"user"}}}async importStyles(e){const n=[];for(const i of e.styles){if(Array.from(this.styles.values()).find(r=>r.name===i.name&&r.category===i.category)){console.warn(`⚠️ 跳过已存在的样式: ${i.name}`);continue}const s=this.createStyle({name:i.name,description:i.description,category:i.category,style:i.style,...i.inheritance&&{inheritance:i.inheritance}});n.push(s)}return console.log(`📦 导入完成，共导入 ${n.length} 个样式`),n}addObserver(e){this.observers.add(e)}removeObserver(e){this.observers.delete(e)}syncAllStyleInstances(e){const n=this.styles.get(e);if(!n)return;const i=[];for(const[l,s]of this.elementStyleMap)s===e&&(this.applyStyleToDOM(l,n.style),i.push(l));this.notifyObservers("styles-synced",{styleId:e,affectedElements:i}),console.log(`🔄 样式同步完成: ${e} → ${i.length} 个元素`)}applyStyleToDOM(e,n){console.log(`🎨 应用样式到DOM: 元素 ${e}`,{font_family:n.font_family,font_size:n.font_size,typography:n.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:e}=await li(async()=>{const{BANK_TEXT_STYLES:n}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:n}},[]);for(const n of e)this.styles.set(n.id,n);console.log(`🏦 加载了 ${e.length} 个银行预设样式`)}catch(e){console.warn("⚠️ 加载系统样式失败:",e)}}async loadUserStyles(){try{const e=localStorage.getItem("jasper-text-styles");if(e){const n=JSON.parse(e);for(const i of n)i.metadata.createdAt=new Date(i.metadata.createdAt),i.metadata.lastModified=new Date(i.metadata.lastModified),this.styles.set(i.id,i);console.log(`👤 加载了 ${n.length} 个用户自定义样式`)}}catch(e){console.warn("⚠️ 加载用户样式失败:",e)}}saveUserStyles(){try{const e=Array.from(this.styles.values()).filter(n=>!n.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(e)),console.log(`💾 保存了 ${e.length} 个用户自定义样式`)}catch(e){console.error("❌ 保存用户样式失败:",e)}}notifyObservers(e,n){for(const i of this.observers)try{i.onStyleChange(e,n)}catch(l){console.error("❌ 观察者通知失败:",l)}}}const ze=new fi;class vi{calculateUnifiedBounds(e,n,i){const l=this.calculateFontMetrics(n),s=this.measureTextContent(e,n,i.width),r=this.calculateContainerHeight(s,l,i.height),o=this.calculateTextPositioning(n,i,r,l),u={containerBounds:{x:0,y:0,width:i.width,height:r},contentBounds:s.bounds,fontMetrics:l,positioning:o};return s.wrappedLines&&(u.textLayout={wrappedLines:s.wrappedLines,isWrapped:!0,originalLineCount:e.split(`
`).length,wrappedLineCount:s.wrappedLines.length}),u}calculateFontMetrics(e){const n=e.font_size,i=1.2,l=.75,s=.25,r=n*l,o=n*s;return{fontSize:n,lineHeight:n*i,ascender:r,descender:o,baseline:r}}getCharacterWidth(e,n){const i=n.font_size,l=n.font_family,s=/[\u4e00-\u9fa5]/.test(e),r={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},o=l.toLowerCase();let u=r.default;for(const[f,d]of Object.entries(r))if(o.includes(f.toLowerCase())||f.toLowerCase().includes(o)){u=d;break}const c=s?u.chinese:u.english;return i*c}calculateTextWidth(e,n){let i=0;for(const l of e)l!==`
`&&(i+=this.getCharacterWidth(l,n));return i}measureTextContent(e,n,i=0){const l=e.split(`
`),s=l.length;let r=0;for(const c of l){const f=this.calculateTextWidth(c,n);r=Math.max(r,f)}if(i>0&&r>i)return this.calculateWrappedText(e,n,i);const o=i>0?Math.min(r,i):r,u=s*n.font_size*1.2;return{bounds:{x:0,y:0,width:o,height:u},lineCount:s,actualHeight:u}}calculateWrappedText(e,n,i){const l=this.getCharacterWidth("测",n);if(Math.floor(i/l)<1||i<l)return{bounds:{x:0,y:0,width:i,height:n.font_size*1.2},lineCount:1,actualHeight:n.font_size*1.2,wrappedLines:["..."]};const r=this.smartSegmentation(e);let o=[],u="",c=0;for(const d of r){const v=this.calculateTextWidth(d,n),p=c+v;if(p>i)if(u.trim())o.push(u.trim()),u=d,c=v;else{const{truncated:g,remaining:y}=this.forceTruncateSegment(d,i,n);o.push(g),u=y,c=this.calculateTextWidth(y,n)}else u+=d,c=p}u.trim()&&o.push(u.trim());const f=o.length*n.font_size*1.2;return{bounds:{x:0,y:0,width:i,height:f},lineCount:o.length,actualHeight:f,wrappedLines:o}}forceTruncateSegment(e,n,i){let l="",s=0,r=0;for(r=0;r<e.length;r++){const u=e[r];if(!u)break;const c=this.getCharacterWidth(u,i);if(s+c>n)break;l+=u,s+=c}const o=e.substring(r);return{truncated:l,remaining:o}}smartSegmentation(e){const n=[];let i="";for(let l=0;l<e.length;l++){const s=e[l];s&&(/[\u4e00-\u9fa5]/.test(s)?(i&&(n.push(i),i=""),n.push(s)):s===`
`?(i&&(n.push(i),i=""),n.push(`
`)):s===" "?i?(n.push(i+" "),i=""):n.push(" "):i+=s)}return i&&n.push(i),n.filter(l=>l.length>0)}calculateContainerHeight(e,n,i){const l=n.lineHeight*e.lineCount,s=n.ascender+n.descender,r=n.lineHeight,o=Math.max(l,s,r);return Math.max(o,i)}calculateTextPositioning(e,n,i,l){var f;const s=this.calculateHorizontalAnchor(e.align,n.width),r=l.baseline,o=((f=e.background)==null?void 0:f.padding)||0,u=-o,c=-o;return{textAnchorX:s,textAnchorY:r,backgroundX:u,backgroundY:c}}calculateHorizontalAnchor(e,n){switch(e){case"Left":return 0;case"Center":return n/2;case"Right":return n;default:return 0}}getTextAnchor(e){switch(e){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(e,n){}}const Ye=new vi;class mi{constructor(){Ie(this,"initialized",!1);this.initialize()}async initialize(){if(!this.initialized)try{await ze.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(e){console.error("❌ ProfessionalTextRenderer 初始化失败:",e)}}isElementUsingProfessionalStyle(e){return ze.getElementStyleId(e)!==null}adaptLegacyTextStyle(e){return{...e,font_weight:e.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:e.color}}],effects:[]}}renderProfessionalText(e,n=!1){if(e.content.type!=="Text"&&e.content.type!=="DataField")return null;const i=ze.getElementStyleId(e.id);let l;if(i){const o=ze.getStyle(i);if(!o)return console.warn(`⚠️ 找不到样式定义: ${i}`),null;l=o.style,console.log(`🎨 使用专业样式渲染: ${o.name} (${i})`)}else{const o=e.content.type==="Text"||e.content.type==="DataField"?e.content.style:null;if(!o)return null;l=this.adaptLegacyTextStyle(o),console.log("🔄 适配传统样式到专业排版系统")}const s=this.calculateEnhancedBounds(e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",l,e.size);return{element:this.createProfessionalTextElement(s,e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",l,!1),bounds:s,style:l}}calculateEnhancedBounds(e,n,i){const l=Ye.calculateUnifiedBounds(e,n,i),s=n.typography,r=this.calculateLetterSpacingEffect(e,s.letterSpacing),o=this.calculateLineHeightEffect(e,n.font_size,s.lineHeight),u=this.calculateParagraphSpacingEffect(e,s.paragraphSpacing);return{containerBounds:l.containerBounds,positioning:l.positioning,fontMetrics:l.fontMetrics,typography:{adjustedWidth:l.containerBounds.width+r.widthIncrease,adjustedHeight:l.containerBounds.height+o.heightIncrease+u.heightIncrease,letterSpacingData:r,lineHeightData:o,paragraphData:u}}}calculateLetterSpacingEffect(e,n){const i=e.split(`
`),l=i.reduce((r,o)=>r+o.length,0),s=Math.max(0,l-i.length);return{spacingValue:n,totalSpaces:s,widthIncrease:s*n,charPositions:[]}}calculateLineHeightEffect(e,n,i){const s=e.split(`
`).length,r=n*i,o=n*1.2,u=r-o;return{lineHeightRatio:i,actualLineHeight:r,lineCount:s,heightIncrease:u*Math.max(0,s-1),baselinePositions:[]}}calculateParagraphSpacingEffect(e,n){const l=e.split(`

`).length;return{spacing:n,paragraphCount:l,heightIncrease:n*Math.max(0,l-1),paragraphPositions:[]}}createProfessionalTextElement(e,n,i,l){const s=document.createElementNS("http://www.w3.org/2000/svg","g");return s.setAttribute("class","professional-text-container"),this.renderMultipleFills(s,e,i.fills),this.renderEffects(s,e,i.effects),this.renderTypographyText(s,e,n,i),this.renderTextDecorations(s,e,n,i.typography.decoration),s}renderMultipleFills(e,n,i){if(i&&i.length>0&&i[0].enabled){const l=i[0];l.type==="solid"&&l.solid&&console.log("🎨 应用纯色填充:",l.solid.color)}}renderEffects(e,n,i){if(!i||i.length===0)return;const l=document.createElementNS("http://www.w3.org/2000/svg","defs"),s=document.createElementNS("http://www.w3.org/2000/svg","filter"),r=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;s.id=r;for(const o of i)if(o.enabled&&o.type==="drop-shadow"&&o.dropShadow){const u=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");u.setAttribute("dx",o.dropShadow.offsetX.toString()),u.setAttribute("dy",o.dropShadow.offsetY.toString()),u.setAttribute("stdDeviation",o.dropShadow.blur.toString()),u.setAttribute("flood-color",o.dropShadow.color),u.setAttribute("flood-opacity",o.dropShadow.opacity.toString()),s.appendChild(u),console.log("✨ 应用投影效果")}s.children.length>0&&(l.appendChild(s),e.appendChild(l),e.setAttribute("filter",`url(#${r})`))}renderTypographyText(e,n,i,l){var u,c;const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("font-family",l.font_family),s.setAttribute("font-size",l.font_size.toString()),s.setAttribute("font-weight",l.font_weight),s.setAttribute("fill",((c=(u=l.fills[0])==null?void 0:u.solid)==null?void 0:c.color)||l.color),s.setAttribute("text-anchor",this.getTextAnchor(l.align));const r=i.split(`
`),o=l.typography;r.forEach((f,d)=>{const v=document.createElementNS("http://www.w3.org/2000/svg","tspan");o.letterSpacing!==0&&v.setAttribute("letter-spacing",`${o.letterSpacing}px`);const p=n.positioning.textAnchorY+d*n.typography.lineHeightData.actualLineHeight;if(v.setAttribute("x",n.positioning.textAnchorX.toString()),v.setAttribute("y",p.toString()),d===0&&o.textIndent!==0){const g=n.positioning.textAnchorX+o.textIndent;v.setAttribute("x",g.toString())}o.textTransform&&o.textTransform!=="none"?v.textContent=this.applyTextTransform(f,o.textTransform):v.textContent=f,s.appendChild(v)}),e.appendChild(s)}renderTextDecorations(e,n,i,l){if(!l.underline&&!l.strikethrough&&!l.overline)return;const s=i.split(`
`),r=l.decorationColor||"#000000",o=l.decorationThickness||1,u=l.decorationStyle==="dashed"?"4,2":l.decorationStyle==="dotted"?"1,1":"none";s.forEach((c,f)=>{if(!c.trim())return;const d=n.positioning.textAnchorY+f*n.typography.lineHeightData.actualLineHeight,v=c.length*n.fontMetrics.fontSize*.6,p=n.positioning.textAnchorX,g=p+v;if(l.underline){const y=d+n.fontMetrics.fontSize*.1;this.createDecorationLine(e,p,y,g,y,r,o,u,"underline")}if(l.strikethrough){const y=d-n.fontMetrics.fontSize*.3;this.createDecorationLine(e,p,y,g,y,r,o,u,"strikethrough")}if(l.overline){const y=d-n.fontMetrics.fontSize*.8;this.createDecorationLine(e,p,y,g,y,r,o,u,"overline")}})}createDecorationLine(e,n,i,l,s,r,o,u,c){const f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",n.toString()),f.setAttribute("y1",i.toString()),f.setAttribute("x2",l.toString()),f.setAttribute("y2",s.toString()),f.setAttribute("stroke",r),f.setAttribute("stroke-width",o.toString()),f.setAttribute("stroke-dasharray",u),f.setAttribute("class",`text-decoration-${c}`),e.appendChild(f)}getTextAnchor(e){switch(e){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(e,n){switch(n){case"uppercase":return e.toUpperCase();case"lowercase":return e.toLowerCase();case"capitalize":return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase();default:return e}}}const yi=new mi;var pi=m("<button class=search-clear title=清除搜索>✕"),bi=m('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),$i=m("<button><span class=category-icon></span><span class=category-label>"),_i=m("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),xi=m("<span class=usage-count>"),wi=m("<button class=edit-button title=编辑样式>✏️"),Si=m("<span class=system-badge title=系统预设样式>🔒"),Ci=m("<div class=selection-indicator>✓");const ki=t=>{const[e,n]=K("bank-special"),[i,l]=K(""),[s,r]=K([]);(async()=>{await ze.initialize();const v=ze.getStylesByCategory();r(v)})();const u=be(()=>{let v=s();e()&&(v=v.filter(g=>g.category===e()));const p=i().toLowerCase().trim();return p&&(v=v.filter(g=>g.name.toLowerCase().includes(p)||g.description.toLowerCase().includes(p)||g.metadata.tags.some(y=>y.toLowerCase().includes(p)))),v}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],f=v=>{console.log("🎯 选择样式:",v),t.onStyleSelect(v)},d=v=>{n(v),console.log("📂 切换分类:",v)};return(()=>{var v=bi(),p=v.firstChild,g=p.nextSibling,y=g.firstChild,w=y.firstChild,b=w.nextSibling,$=g.nextSibling,S=$.firstChild,D=$.nextSibling,z=D.firstChild,T=z.firstChild;return a(p,h(ge,{each:c,children:_=>(()=>{var k=$i(),H=k.firstChild,F=H.nextSibling;return k.$$click=()=>d(_.key),a(H,()=>_.icon),a(F,()=>_.label),N(j=>{var P=`category-button ${e()===_.key?"active":""}`,W=_.label;return P!==j.e&&he(k,j.e=P),W!==j.t&&M(k,"title",j.t=W),j},{e:void 0,t:void 0}),k})()})),b.$$input=_=>l(_.target.value),a(y,h(O,{get when(){return i()},get children(){var _=pi();return _.$$click=()=>l(""),_}}),null),a($,h(ge,{get each(){return u()},children:_=>h(Ei,{style:_,get selected(){return t.selectedStyleId===_.id},onClick:()=>f(_.id),onEdit:()=>t.onStyleEdit(_.id)})}),S),Ee(S,"click",t.onStyleCreate),a(z,()=>u().length,T),a(z,(()=>{var _=ce(()=>!!i());return()=>_()&&` (搜索: "${i()}")`})(),null),N(()=>b.value=i()),v})()},Ei=t=>{const e=()=>{switch(t.style.category){case"bank-special":return t.style.id.includes("amount")?"¥123,456.78":t.style.id.includes("account")?"6222 0012 3456 7890":t.style.id.includes("institution")?t.style.name:t.style.id.includes("date")?"2025-08-19":t.style.name;case"heading":return t.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return t.style.name}},n=be(()=>{var r,o,u,c,f,d,v,p;const s=t.style.style;return{fontFamily:s.font_family,fontSize:`${Math.min(s.font_size,14)}px`,fontWeight:s.font_weight,color:((u=(o=(r=s.fills)==null?void 0:r[0])==null?void 0:o.solid)==null?void 0:u.color)||s.color,textAlign:s.align.toLowerCase(),letterSpacing:`${((c=s.typography)==null?void 0:c.letterSpacing)||0}px`,textDecoration:(d=(f=s.typography)==null?void 0:f.decoration)!=null&&d.underline?"underline":(p=(v=s.typography)==null?void 0:v.decoration)!=null&&p.strikethrough?"line-through":"none"}}),i=s=>{s.preventDefault(),t.onClick()},l=s=>{s.preventDefault(),s.stopPropagation(),t.onEdit()};return(()=>{var s=_i(),r=s.firstChild,o=r.nextSibling,u=o.firstChild,c=u.nextSibling,f=c.firstChild,d=o.nextSibling;return s.$$click=i,a(r,e),a(u,()=>t.style.name),a(f,()=>Ti(t.style.category)),a(c,(()=>{var v=ce(()=>t.style.metadata.usageCount>0);return()=>v()&&(()=>{var p=xi();return a(p,()=>t.style.metadata.usageCount),N(()=>M(p,"title",`使用次数: ${t.style.metadata.usageCount}`)),p})()})(),null),a(d,(()=>{var v=ce(()=>!t.style.metadata.isSystemStyle);return()=>v()&&(()=>{var p=wi();return p.$$click=l,p})()})(),null),a(d,(()=>{var v=ce(()=>!!t.style.metadata.isSystemStyle);return()=>v()&&Si()})(),null),a(s,(()=>{var v=ce(()=>!!t.selected);return()=>v()&&Ci()})(),null),N(v=>{var p=`style-card ${t.selected?"selected":""} ${t.style.metadata.isSystemStyle?"system-style":"user-style"}`,g=n();return p!==v.e&&he(s,v.e=p),v.t=rn(r,g,v.t),v},{e:void 0,t:void 0}),s})()};function Ti(t){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[t]||t}Le(["input","click"]);var Di=m("<button class=style-picker-toggle>"),Ai=m("<button class=style-reload-btn title=重新加载样式系统>🔄"),Pi=m("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),zi=m("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),Li=m("<div class=style-picker-panel>"),Mi=m("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),Ri=m("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),Oi=m('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),Ni=m("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),Ui=m('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const jt=t=>{const[e,n]=K(null),[i,l]=K(!1),[s,r]=K([]),[o,u]=K(!1);Je(async()=>{try{await ze.initialize();const b=ze.getElementStyleId(t.element.id);n(b);const $=ze.getStylesByCategory();r($),u(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch(b){console.error("❌ 专业文字属性面板初始化失败:",b)}});const c=be(()=>{const b=e();return b?ze.getStyle(b):null}),f=be(()=>t.element.content.type==="Text"||t.element.content.type==="DataField"),d=async b=>{try{const $=await ze.applyStyleToElement(t.element.id,b);if($.success){n(b);const S=ze.getStyle(b);if(S){const D=v(S.style);t.onUpdate(t.element.id,"content",{...t.element.content,style:D})}console.log("✅ 样式应用成功:",$)}else console.error("❌ 样式应用失败:",$.error)}catch($){console.error("❌ 样式选择处理失败:",$)}},v=b=>{var $,S,D;return{font_family:b.font_family,font_size:b.font_size,font_weight:b.font_weight,color:((D=(S=($=b.fills)==null?void 0:$[0])==null?void 0:S.solid)==null?void 0:D.color)||b.color,align:b.align}},p=()=>{console.log("🆕 创建新样式")},g=b=>{console.log("✏️ 编辑样式:",b)},y=()=>{l(!i())},w=()=>{e()&&(ze.removeElementStyle(t.element.id),n(null),console.log("🗑️ 移除元素样式"))};return f()?(()=>{var b=Ni(),$=b.firstChild,S=$.firstChild,D=S.firstChild,z=D.nextSibling,T=z.nextSibling,_=S.nextSibling;return a(T,h(O,{get when(){return o()},get children(){var k=Di();return k.$$click=y,a(k,()=>i()?"📝":"📚"),N(()=>M(k,"title",i()?"隐藏样式库":"显示样式库")),k}}),null),a(T,h(O,{get when(){return!o()},get children(){var k=Ai();return k.$$click=()=>window.location.reload(),k}}),null),a(_,h(O,{get when(){return!o()},get children(){var k=Pi(),H=k.firstChild,F=H.firstChild,j=F.nextSibling,P=j.nextSibling,W=P.firstChild;return W.$$click=async()=>{try{await ze.initialize();const V=ze.getStylesByCategory();r(V),u(!0),console.log("🔄 样式系统重新初始化成功")}catch(V){console.error("❌ 重新初始化失败:",V)}},k}}),null),a(_,h(O,{get when(){return o()},get children(){return[h(O,{get when(){return c()},children:k=>(()=>{var H=Ui(),F=H.firstChild,j=F.firstChild,P=j.firstChild,W=P.nextSibling,V=j.nextSibling,x=V.firstChild,L=x.nextSibling;return a(P,()=>k().name),a(W,()=>Fi(k().category)),x.$$click=()=>g(k().id),L.$$click=w,H})()}),h(O,{get when(){return!c()},get children(){var k=zi(),H=k.firstChild,F=H.nextSibling;return H.$$click=y,F.$$click=p,k}}),h(O,{get when(){return i()},get children(){var k=Li();return a(k,h(ki,{get selectedStyleId(){return e()},onStyleSelect:d,onStyleCreate:p,onStyleEdit:g})),k}})]}}),null),a(b,h(O,{get when(){return c()},get children(){return Mi()}}),null),a(b,h(O,{get when(){return c()},get children(){return Ri()}}),null),a(b,h(O,{get when(){return!1},get children(){var k=Oi(),H=k.firstChild,F=H.nextSibling,j=F.firstChild,P=j.firstChild,W=P.firstChild,V=W.nextSibling,x=P.nextSibling,L=x.firstChild,A=L.nextSibling,U=x.nextSibling,q=U.firstChild,Z=q.nextSibling,ue=Z.firstChild,oe=U.nextSibling,I=oe.firstChild,le=I.nextSibling;return a(V,()=>t.element.id),a(A,()=>e()||"无"),a(Z,()=>s().length,ue),a(le,()=>yi.isElementUsingProfessionalStyle(t.element.id)?"是":"否"),k}}),null),b})():null};function Fi(t){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[t]||t}Le(["click"]);var Ii=m('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),Bi=m('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),ji=m("<span class=property-value>"),Hi=m('<span class="property-value text-xs text-muted">'),$t=m("<div class=space-y-2>"),lt=m("<input type=number class=property-input>"),qi=m('<div class="grid grid-cols-2 gap-2">'),Ht=m("<input type=checkbox class=property-checkbox>"),Ji=m('<div class="p-4 space-y-4">'),qt=m("<div>"),Vi=m("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),Wi=m("<div class=property-field><label class=property-label>"),Ki=m("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),mn=m('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),yn=m("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),Gi=m('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),pn=m("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),Xi=m('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),bn=m('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),$n=m('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),Yi=m('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),Qi=m("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),Jt=m("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),Zi=m('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),el=m("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),tl=m("<input type=text class=property-input placeholder=图片描述文字>"),nl=m("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),il=m("<div class=space-y-3>"),ll=m("<img class=property-image>"),sl=m("<div class=property-loading>加载数据源..."),rl=m('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),al=m('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),ol=m('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),cl=m('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),dl=m("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),ul=m("<div class=space-y-4>"),hl=m("<select class=property-select><option value>选择数据源"),gl=m("<option> (<!>)"),fl=m('<div class=flex><input type=number class="property-input flex-1">'),vl=m("<span class=property-unit>"),ml=m('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),yl=m("<div class=property-alignment-group>"),pl=m("<button>");const bl=()=>{const{state:t,updateElement:e}=We(),n=be(()=>{const s=new Set(t.selected_ids);return t.elements.filter(r=>s.has(r.id))}),i=be(()=>n()[0]),l=async(s,r,o)=>{try{await e(s,{[r]:o})}catch(u){console.error("Failed to update element property:",u)}};return(()=>{var s=Ii(),r=s.firstChild,o=r.nextSibling;return a(o,h(O,{get when(){return i()},get fallback(){return Bi()},get children(){return h($l,{get element(){return i()},onUpdate:l})}})),s})()},$l=t=>{const e=(i,l)=>{const s={...t.element.position,[i]:l};t.onUpdate(t.element.id,"position",s)},n=(i,l)=>{const s={...t.element.size,[i]:Math.max(1,l)};t.onUpdate(t.element.id,"size",s)};return(()=>{var i=Ji();return a(i,h(qe,{title:"元素信息",icon:"ℹ️",get children(){var l=$t();return a(l,h(re,{label:"类型",get children(){var s=ji();return a(s,()=>t.element.content.type),s}}),null),a(l,h(re,{label:"ID",get children(){var s=Hi();return a(s,()=>t.element.id),s}}),null),l}}),null),a(i,h(qe,{title:"位置和大小",icon:"📐",get children(){var l=qi();return a(l,h(re,{label:"X",get children(){var s=lt();return s.$$input=r=>e("x",parseFloat(r.target.value)||0),N(()=>s.value=t.element.position.x),s}}),null),a(l,h(re,{label:"Y",get children(){var s=lt();return s.$$input=r=>e("y",parseFloat(r.target.value)||0),N(()=>s.value=t.element.position.y),s}}),null),a(l,h(re,{label:"宽度",get children(){var s=lt();return s.$$input=r=>n("width",parseFloat(r.target.value)||1),N(()=>s.value=t.element.size.width),s}}),null),a(l,h(re,{label:"高度",get children(){var s=lt();return s.$$input=r=>n("height",parseFloat(r.target.value)||1),N(()=>s.value=t.element.size.height),s}}),null),l}}),null),a(i,h(qe,{title:"状态",icon:"👁️",get children(){var l=$t();return a(l,h(re,{label:"可见",get children(){var s=Ht();return s.addEventListener("change",r=>t.onUpdate(t.element.id,"visible",r.target.checked)),N(()=>s.checked=t.element.visible),s}}),null),a(l,h(re,{label:"锁定",get children(){var s=Ht();return s.addEventListener("change",r=>t.onUpdate(t.element.id,"locked",r.target.checked)),N(()=>s.checked=t.element.locked),s}}),null),a(l,h(re,{label:"层级",get children(){var s=lt();return s.$$input=r=>t.onUpdate(t.element.id,"z_index",parseInt(r.target.value)||0),N(()=>s.value=t.element.z_index),s}}),null),l}}),null),a(i,h(On,{get children(){return[h(it,{get when(){return t.element.content.type==="Text"&&t.element.content},children:l=>(()=>{var s=qt();return a(s,h(jt,{get element(){return t.element},get onUpdate(){return t.onUpdate}}),null),a(s,h(_l,{get content(){return l()},onUpdate:r=>{console.log("Text content update:",r),t.onUpdate(t.element.id,"content",r)}}),null),s})()}),h(it,{get when(){return t.element.content.type==="Rectangle"&&t.element.content},children:l=>h(xl,{get content(){return l()},onUpdate:s=>{console.log("Rectangle content update:",s),t.onUpdate(t.element.id,"content",s)}})}),h(it,{get when(){return t.element.content.type==="Line"&&t.element.content},children:l=>h(wl,{get content(){return l()},onUpdate:s=>{console.log("Line content update:",s),t.onUpdate(t.element.id,"content",s)}})}),h(it,{get when(){return t.element.content.type==="Image"&&t.element.content},children:l=>h(Sl,{get content(){return l()},onUpdate:s=>{console.log("Image content update:",s),t.onUpdate(t.element.id,"content",s)}})}),h(it,{get when(){return t.element.content.type==="DataField"&&t.element.content},children:l=>(()=>{var s=qt();return a(s,h(jt,{get element(){return t.element},get onUpdate(){return t.onUpdate}}),null),a(s,h(Cl,{get content(){return l()},onUpdate:r=>{console.log("DataField content update:",r),t.onUpdate(t.element.id,"content",r)}}),null),s})()})]}}),null),i})()},qe=t=>(()=>{var e=Vi(),n=e.firstChild,i=n.firstChild,l=i.nextSibling,s=n.nextSibling;return a(i,()=>t.icon),a(l,()=>t.title),a(s,()=>t.children),e})(),re=t=>(()=>{var e=Wi(),n=e.firstChild;return a(n,()=>t.label),a(e,()=>t.children,null),e})(),_l=t=>h(qe,{title:"文字样式",icon:"🔤",get children(){var e=bn(),n=e.firstChild,i=n.nextSibling;return a(e,h(re,{label:"内容",get children(){var l=Ki();return l.$$input=s=>t.onUpdate({content:s.target.value}),N(()=>l.value=t.content.content),l}}),n),a(n,h(re,{label:"字体",get children(){var l=mn();return l.addEventListener("change",s=>t.onUpdate({style:{...t.content.style,font_family:s.target.value}})),N(()=>l.value=t.content.style.font_family),l}}),null),a(n,h(re,{label:"大小",get children(){return h(je,{get value(){return t.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:l=>t.onUpdate({style:{...t.content.style,font_size:l}})})}}),null),a(i,h(re,{label:"字重",get children(){var l=yn();return l.addEventListener("change",s=>t.onUpdate({style:{...t.content.style,font_weight:s.target.value}})),N(()=>l.value=t.content.style.font_weight),l}}),null),a(i,h(re,{label:"对齐",get children(){return h(_n,{get value(){return t.content.style.align},onUpdate:l=>t.onUpdate({style:{...t.content.style,align:l}})})}}),null),a(e,h(re,{label:"颜色",get children(){return h(Ke,{get value(){return t.content.style.color},onUpdate:l=>t.onUpdate({style:{...t.content.style,color:l}})})}}),null),a(e,h(re,{label:"背景",get children(){var l=Gi(),s=l.firstChild;return a(l,h(Ke,{get value(){var r;return((r=t.content.style.background)==null?void 0:r.color)||"transparent"},onUpdate:r=>t.onUpdate({style:{...t.content.style,background:{...t.content.style.background,color:r}}})}),s),a(s,h(re,{label:"透明度",get children(){return h(je,{get value(){var r;return((r=t.content.style.background)==null?void 0:r.opacity)||1},min:0,max:1,step:.1,onUpdate:r=>t.onUpdate({style:{...t.content.style,background:{...t.content.style.background,opacity:r}}})})}}),null),a(s,h(re,{label:"内边距",get children(){return h(je,{get value(){var r;return((r=t.content.style.background)==null?void 0:r.padding)||0},min:0,max:20,step:1,unit:"px",onUpdate:r=>t.onUpdate({style:{...t.content.style,background:{...t.content.style.background,padding:r}}})})}}),null),l}}),null),a(e,h(re,{label:"边框",get children(){var l=Xi(),s=l.firstChild;return a(l,h(Ke,{get value(){var r;return((r=t.content.style.border)==null?void 0:r.color)||"#000000"},onUpdate:r=>t.onUpdate({style:{...t.content.style,border:{...t.content.style.border,color:r}}})}),s),a(s,h(re,{label:"宽度",get children(){return h(je,{get value(){var r;return((r=t.content.style.border)==null?void 0:r.width)||1},min:0,max:10,step:.5,unit:"px",onUpdate:r=>t.onUpdate({style:{...t.content.style,border:{...t.content.style.border,width:r}}})})}}),null),a(s,h(re,{label:"样式",get children(){var r=pn();return r.addEventListener("change",o=>t.onUpdate({style:{...t.content.style,border:{...t.content.style.border,style:o.target.value}}})),N(()=>{var o;return r.value=((o=t.content.style.border)==null?void 0:o.style)||"Solid"}),r}}),null),a(s,h(re,{label:"圆角",get children(){return h(je,{get value(){var r;return((r=t.content.style.border)==null?void 0:r.radius)||0},min:0,max:20,step:1,unit:"px",onUpdate:r=>t.onUpdate({style:{...t.content.style,border:{...t.content.style.border,radius:r}}})})}}),null),l}}),null),e}}),xl=t=>h(qe,{title:"矩形样式",icon:"▭",get children(){var e=Yi(),n=e.firstChild,i=n.firstChild;return a(e,h(re,{label:"填充颜色",get children(){return h(Ke,{get value(){return t.content.fill_color||"#ffffff"},onUpdate:l=>t.onUpdate({fill_color:l})})}}),n),a(n,h(re,{label:"边框",get children(){var l=$t();return a(l,h(Ke,{get value(){var s;return((s=t.content.border)==null?void 0:s.color)||"#000000"},onUpdate:s=>t.onUpdate({border:{...t.content.border,color:s}})})),l}}),i),a(i,h(re,{label:"宽度",get children(){return h(je,{get value(){var l;return((l=t.content.border)==null?void 0:l.width)||1},min:0,max:20,step:.5,unit:"px",onUpdate:l=>t.onUpdate({border:{...t.content.border,width:l}})})}}),null),a(i,h(re,{label:"样式",get children(){var l=pn();return l.addEventListener("change",s=>t.onUpdate({border:{...t.content.border,style:s.target.value}})),N(()=>{var s;return l.value=((s=t.content.border)==null?void 0:s.style)||"Solid"}),l}}),null),a(e,h(re,{label:"圆角半径",get children(){return h(je,{get value(){return t.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:l=>t.onUpdate({corner_radius:l})})}}),null),a(e,h(re,{label:"透明度",get children(){var l=$n(),s=l.firstChild,r=s.nextSibling,o=r.firstChild;return s.$$input=u=>t.onUpdate({opacity:parseFloat(u.target.value)/100}),a(r,()=>Math.round((t.content.opacity||1)*100),o),N(()=>s.value=(t.content.opacity||1)*100),l}}),null),e}}),wl=t=>h(qe,{title:"线条样式",icon:"━",get children(){var e=Zi(),n=e.firstChild;return a(e,h(re,{label:"颜色",get children(){return h(Ke,{get value(){return t.content.color},onUpdate:i=>t.onUpdate({color:i})})}}),n),a(e,h(re,{label:"宽度",get children(){return h(je,{get value(){return t.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:i=>t.onUpdate({width:i})})}}),n),a(e,h(re,{label:"样式",get children(){var i=Qi();return i.addEventListener("change",l=>t.onUpdate({line_style:l.target.value})),N(()=>i.value=t.content.line_style||"Solid"),i}}),n),a(n,h(re,{label:"起点",get children(){var i=Jt();return i.addEventListener("change",l=>t.onUpdate({start_cap:l.target.value})),N(()=>i.value=t.content.start_cap||"None"),i}}),null),a(n,h(re,{label:"终点",get children(){var i=Jt();return i.addEventListener("change",l=>t.onUpdate({end_cap:l.target.value})),N(()=>i.value=t.content.end_cap||"None"),i}}),null),a(e,h(re,{label:"透明度",get children(){var i=$n(),l=i.firstChild,s=l.nextSibling,r=s.firstChild;return l.$$input=o=>t.onUpdate({opacity:parseFloat(o.target.value)/100}),a(s,()=>Math.round((t.content.opacity||1)*100),r),N(()=>l.value=(t.content.opacity||1)*100),i}}),null),e}}),Sl=t=>h(qe,{title:"图片属性",icon:"🖼️",get children(){var e=il();return a(e,h(re,{label:"图片地址",get children(){var n=el();return n.$$input=i=>t.onUpdate({src:i.target.value}),N(()=>n.value=t.content.src),n}}),null),a(e,h(re,{label:"替代文本",get children(){var n=tl();return n.$$input=i=>t.onUpdate({alt:i.target.value}),N(()=>n.value=t.content.alt||""),n}}),null),a(e,h(re,{label:"预览",get children(){var n=nl(),i=n.firstChild;return a(n,(()=>{var l=ce(()=>!!t.content.src);return()=>l()?(()=>{var s=ll();return s.addEventListener("load",r=>{const o=r.target,u=o.nextElementSibling;o&&(o.style.display="block"),u&&(u.style.display="none")}),s.addEventListener("error",r=>{const o=r.target,u=o.nextElementSibling;o&&(o.style.display="none"),u&&(u.style.display="flex")}),N(r=>{var o=t.content.src,u=t.content.alt||"图片预览";return o!==r.e&&M(s,"src",r.e=o),u!==r.t&&M(s,"alt",r.t=u),r},{e:void 0,t:void 0}),s})():null})(),i),N(l=>(l=t.content.src?"none":"flex")!=null?i.style.setProperty("display",l):i.style.removeProperty("display")),n}}),null),e}}),Cl=t=>{const[e,n]=K([]),[i,l]=K(!1);Je(async()=>{try{l(!0);const o=await xe.listDataSources();n(o)}catch(o){console.error("Failed to load data sources:",o)}finally{l(!1)}});const s=o=>{t.onUpdate({data_source_id:o===""?void 0:o})},r=be(()=>t.content.data_source_id?e().find(o=>o.id===t.content.data_source_id):null);return(()=>{var o=ul();return a(o,h(qe,{title:"数据源配置",icon:"🔗",get children(){var u=$t();return a(u,h(re,{label:"数据源",get children(){return h(O,{get when(){return i()},get fallback(){return(()=>{var c=hl();return c.firstChild,c.addEventListener("change",f=>s(f.currentTarget.value)),a(c,h(ge,{get each(){return e()},children:f=>(()=>{var d=gl(),v=d.firstChild,p=v.nextSibling;return p.nextSibling,a(d,()=>f.name,v),a(d,()=>f.provider_type,p),N(()=>d.value=f.id),d})()}),null),N(()=>c.value=t.content.data_source_id||""),c})()},get children(){return sl()}})}}),null),a(u,h(O,{get when(){return r()},get children(){var c=rl(),f=c.firstChild,d=f.firstChild,v=d.firstChild,p=v.nextSibling,g=p.nextSibling,y=d.nextSibling,w=y.firstChild;w.nextSibling;var b=y.nextSibling,$=b.firstChild;return $.nextSibling,a(g,(()=>{var S=ce(()=>r().status==="active");return()=>S()?"活跃":r().status==="error"?"错误":"禁用"})()),a(y,()=>r().provider_type,null),a(b,()=>new Date(r().last_updated).toLocaleString("zh-CN"),null),N(()=>he(g,r().status==="active"?"text-green-600":r().status==="error"?"text-red-600":"text-gray-600")),c}}),null),a(u,h(re,{label:"表达式",get children(){var c=al();return c.$$input=f=>t.onUpdate({expression:f.currentTarget.value}),c.disabled=!1,N(()=>c.value=t.content.expression||""),c}}),null),a(u,h(O,{get when(){return!t.content.expression||!t.content.expression.trim()},get children(){return ol()}}),null),a(u,h(O,{get when(){return t.content.expression&&!t.content.data_source_id},get children(){return cl()}}),null),a(u,h(re,{label:"格式",get children(){var c=dl();return c.addEventListener("change",f=>t.onUpdate({format:f.currentTarget.value==="default"?void 0:f.currentTarget.value})),N(()=>c.value=t.content.format||"default"),c}}),null),u}}),null),a(o,h(qe,{title:"字段样式",icon:"🎨",get children(){var u=bn(),c=u.firstChild,f=c.nextSibling;return a(c,h(re,{label:"字体",get children(){var d=mn();return d.addEventListener("change",v=>t.onUpdate({style:{...t.content.style,font_family:v.currentTarget.value}})),N(()=>d.value=t.content.style.font_family),d}}),null),a(c,h(re,{label:"大小",get children(){return h(je,{get value(){return t.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:d=>t.onUpdate({style:{...t.content.style,font_size:d}})})}}),null),a(f,h(re,{label:"字重",get children(){var d=yn();return d.addEventListener("change",v=>t.onUpdate({style:{...t.content.style,font_weight:v.currentTarget.value}})),N(()=>d.value=t.content.style.font_weight),d}}),null),a(f,h(re,{label:"对齐",get children(){return h(_n,{get value(){return t.content.style.align},onUpdate:d=>t.onUpdate({style:{...t.content.style,align:d}})})}}),null),a(u,h(re,{label:"颜色",get children(){return h(Ke,{get value(){return t.content.style.color},onUpdate:d=>t.onUpdate({style:{...t.content.style,color:d}})})}}),null),u}}),null),o})()},je=t=>(()=>{var e=fl(),n=e.firstChild;return n.addEventListener("blur",i=>{const l=parseFloat(i.target.value)||t.value,s=Math.max(t.min||-1/0,Math.min(t.max||1/0,l));s!==l&&(i.target.value=s.toString(),t.onUpdate(s))}),n.$$input=i=>{const l=parseFloat(i.target.value);if(!isNaN(l)){const s=Math.max(t.min||-1/0,Math.min(t.max||1/0,l));t.onUpdate(s)}},a(e,(()=>{var i=ce(()=>!!t.unit);return()=>i()&&(()=>{var l=vl();return a(l,()=>t.unit),l})()})(),null),N(i=>{var l=t.min,s=t.max,r=t.step||1;return l!==i.e&&M(n,"min",i.e=l),s!==i.t&&M(n,"max",i.t=s),r!==i.a&&M(n,"step",i.a=r),i},{e:void 0,t:void 0,a:void 0}),N(()=>n.value=t.value),e})(),Ke=t=>(()=>{var e=ml(),n=e.firstChild,i=n.firstChild,l=i.nextSibling,s=n.nextSibling;return i.$$input=r=>t.onUpdate(r.target.value),s.$$input=r=>{const o=r.target.value;(/^#[0-9A-Fa-f]{6}$/.test(o)||/^#[0-9A-Fa-f]{3}$/.test(o))&&t.onUpdate(o)},N(r=>(r=t.value)!=null?l.style.setProperty("background-color",r):l.style.removeProperty("background-color")),N(()=>i.value=t.value),N(()=>s.value=t.value),e})(),_n=t=>{const e=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var n=yl();return a(n,()=>e.map(i=>(()=>{var l=pl();return l.$$click=()=>t.onUpdate(i.value),a(l,()=>i.icon),N(s=>{var r=`property-alignment-btn ${t.value===i.value?"active":""}`,o=i.label;return r!==s.e&&he(l,s.e=r),o!==s.t&&M(l,"title",s.t=o),s},{e:void 0,t:void 0}),l})())),n})()};Le(["input","click"]);var kl=m("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),El=m("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const Tl=t=>h(O,{get when(){return t.config.show_grid},get children(){return[(()=>{var e=kl(),n=e.firstChild,i=n.firstChild,l=i.nextSibling;return N(s=>{var r=t.config.grid_size,o=t.config.grid_size,u=t.config.grid_size,c=t.config.grid_size,f=t.config.grid_size,d=t.config.grid_size,v=t.config.grid_size,p=t.config.grid_size;return r!==s.e&&M(n,"width",s.e=r),o!==s.t&&M(n,"height",s.t=o),u!==s.a&&M(i,"x1",s.a=u),c!==s.o&&M(i,"x2",s.o=c),f!==s.i&&M(i,"y2",s.i=f),d!==s.n&&M(l,"y1",s.n=d),v!==s.s&&M(l,"x2",s.s=v),p!==s.h&&M(l,"y2",s.h=p),s},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),e})(),(()=>{var e=El();return N(n=>{var i=t.config.width,l=t.config.height;return i!==n.e&&M(e,"width",n.e=i),l!==n.t&&M(e,"height",n.t=l),n},{e:void 0,t:void 0}),e})()]}});class Dl{constructor(){Ie(this,"expressionCache",new Map);Ie(this,"maxCacheSize",1e3)}async evaluateExpression(e,n){if(!e||!e.trim())return{success:!1,error:"表达式不能为空"};if(!n)return{success:!1,error:"没有可用的数据上下文"};try{const i=this.preprocessExpression(e),l=this.getCompiledExpression(i),s=await this.executeCompiledExpression(l,n);return{success:!0,value:s.value,type:this.inferValueType(s.value)}}catch(i){return{success:!1,error:i instanceof Error?i.message:String(i)}}}validateExpression(e,n){if(!e||!e.trim())return{valid:!1,error:"表达式不能为空"};try{const i=this.preprocessExpression(e),l=this.compileExpression(i);return this.staticValidation(l,n)}catch(i){return{valid:!1,error:i instanceof Error?i.message:"表达式格式错误"}}}getFieldSuggestions(e,n){if(!n)return[];const i=e.toLowerCase().replace(/[{}]/g,""),l=[];if(n.fields.forEach(s=>{s.name.toLowerCase().includes(i)&&l.push(`{${s.name}}`),s.displayName&&s.displayName.toLowerCase().includes(i)&&l.push(`{${s.name}}`)}),n.currentRecord.data){const s=this.getNestedFieldSuggestions(i,n.currentRecord.data,"");l.push(...s)}return Array.from(new Set(l)).sort((s,r)=>{const o=s.replace(/[{}]/g,""),u=r.replace(/[{}]/g,"");return o===i?-1:u===i?1:o.startsWith(i)?-1:u.startsWith(i)?1:o.localeCompare(u)}).slice(0,20)}preprocessExpression(e){let n=e.trim();return!n.startsWith("{")&&!n.endsWith("}")&&(n=`{${n}}`),n=n.replace(/^\{+/,"{").replace(/\}+$/,"}"),n}getCompiledExpression(e){let n=this.expressionCache.get(e);if(!n){if(n=this.compileExpression(e),this.expressionCache.size>=this.maxCacheSize){const i=this.expressionCache.keys().next().value;i&&this.expressionCache.delete(i)}this.expressionCache.set(e,n)}return n}compileExpression(e){const n=e.slice(1,-1),i=this.parsePath(n);return{original:e,path:i,type:this.determineExpressionType(i)}}parsePath(e){const n=[];let i="",l=!1;for(let s=0;s<e.length;s++){const r=e[s];if(r==="["&&!l)i&&(n.push({type:"field",value:i}),i=""),l=!0;else if(r==="]"&&l){const o=parseInt(i,10);if(isNaN(o))throw new Error(`无效的数组索引: ${i}`);n.push({type:"index",value:o}),i="",l=!1}else r==="."&&!l?i&&(n.push({type:"field",value:i}),i=""):i+=r}if(i){if(l)throw new Error("未闭合的数组索引");n.push({type:"field",value:i})}if(n.length===0)throw new Error("空的字段路径");return n}async executeCompiledExpression(e,n){let i=n.currentRecord.data;for(const l of e.path){if(i==null)throw new Error("无法访问 null/undefined 值的属性");if(l.type==="field"){if(typeof i!="object")throw new Error(`尝试访问非对象类型的字段: ${l.value}`);if(!(l.value in i))throw new Error(`字段不存在: ${l.value}`);i=i[l.value]}else if(l.type==="index"){if(!Array.isArray(i))throw new Error("尝试对非数组类型使用索引访问");const s=l.value;if(s<0||s>=i.length)throw new Error(`数组索引超出范围: ${s}`);i=i[s]}}return{value:i}}staticValidation(e,n){if(!n)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const i=[],l=e.path[0];if(l&&l.type==="field"){const r=l.value;if(!n.fields.some(u=>u.name===r)){const u=n.fields.filter(c=>c.name.toLowerCase().includes(r.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),r.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${r}`,suggestions:u}}}e.path.length>5&&i.push("表达式路径过深，可能影响性能");const s={valid:!0};return i.length>0&&(s.warnings=i),s}getNestedFieldSuggestions(e,n,i){const l=[];if(!n||typeof n!="object")return l;for(const s of Object.keys(n)){const r=i?`${i}.${s}`:s;r.toLowerCase().includes(e)&&l.push(`{${r}}`),i.split(".").length<3&&n[s]&&typeof n[s]=="object"&&l.push(...this.getNestedFieldSuggestions(e,n[s],r))}return l}inferValueType(e){return e==null?"object":typeof e=="string"?"string":typeof e=="number"?"number":typeof e=="boolean"?"boolean":e instanceof Date?"date":typeof e=="object"?"object":"string"}determineExpressionType(e){return e.length===1?"simple":e.length<=3&&e.every(n=>n.type==="field")?"nested":"complex"}levenshteinDistance(e,n){if(e.length===0)return n.length;if(n.length===0)return e.length;const i=new Array(n.length+1);for(let l=0;l<=n.length;l++)i[l]=new Array(e.length+1),i[l][0]=l;for(let l=0;l<=e.length;l++)i[0][l]=l;for(let l=1;l<=n.length;l++)for(let s=1;s<=e.length;s++){const r=e[s-1]===n[l-1]?0:1;i[l][s]=Math.min(i[l-1][s]+1,i[l][s-1]+1,i[l-1][s-1]+r)}return i[n.length][e.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const Tt=new Dl;class Al{constructor(){Ie(this,"context",K(null));Ie(this,"subscribers",[]);this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(e){try{const i=(await xe.listDataSources()).find(c=>c.id===e);if(!i)throw new Error(`数据源不存在: ${e}`);console.log("🔍 找到数据源:",i);const l=i.provider_type||i.type_name||"json";console.log("🔍 推断的 providerType:",l);const s=await xe.getPreview(e,void 0,1);console.log("🔍 预览数据:",s);const r=await xe.getSchema(e);console.log("🔍 Schema信息:",r);const o=r.columns.map(c=>({name:c.name,displayName:c.description||c.name,type:this.mapDataType(c.data_type),nullable:c.nullable,sample:c.default_value})),u={dataSource:{id:e,type:this.inferDataSourceType(l),name:i.name,status:this.mapDataSourceStatus(i.status)},currentRecord:{index:0,total:s.total_rows,data:s.rows[0]||{}},fields:o};console.log("✅ 创建新的数据上下文:",u),this.context[1](u),this.notifySubscribers(u)}catch(n){console.error("设置数据源失败:",n);const i={dataSource:{id:e,type:"json",name:"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:n instanceof Error?n.message:"数据源加载失败",details:n}};this.context[1](i),this.notifySubscribers(i)}}async navigateToRecord(e){const n=this.getCurrentContext();if(!n||e<0||e>=n.currentRecord.total)return!1;try{const i=await xe.queryData(n.dataSource.id,{limit:1,offset:e});if(i.rows.length===0)return!1;const l={...n,currentRecord:{...n.currentRecord,index:e,data:i.rows[0]}};return this.context[1](l),this.notifySubscribers(l),!0}catch(i){return console.error("导航到记录失败:",i),!1}}async navigateNext(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index+1):!1}async navigatePrevious(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index-1):!1}async evaluateExpression(e){const n=this.getCurrentContext();return await Tt.evaluateExpression(e,n)}validateExpression(e){const n=this.getCurrentContext(),i=Tt.validateExpression(e,n);return{valid:i.valid,...i.error&&{error:i.error},...i.suggestions&&{suggestions:i.suggestions}}}getFieldSuggestions(e){const n=this.getCurrentContext();return Tt.getFieldSuggestions(e,n)}subscribe(e){return this.subscribers.push(e),()=>{const n=this.subscribers.indexOf(e);n>-1&&this.subscribers.splice(n,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(e){this.subscribers.forEach(n=>{try{n(e)}catch(i){console.error("数据上下文订阅回调错误:",i)}})}inferDataSourceType(e){if(!e)return console.warn("providerType is undefined, defaulting to json"),"json";switch(e.toLowerCase()){case"json":return"json";case"excel":return"excel";case"sql":return"sql";case"xml":return"xml";case"csv":return"csv";default:return"json"}}mapDataType(e){switch(e){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(e){if(!e)return console.warn("status is undefined, defaulting to empty"),"empty";switch(e.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${e}, defaulting to empty`),"empty"}}}const Qe=new Al;var Pl=m("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),Vt=m("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),zl=m("<svg><rect class=text-background-unified></svg>",!1,!0,!1),Ll=m("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),Ml=m("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),Rl=m("<svg><tspan class=text-line-original></svg>",!1,!0,!1),Ol=m("<svg><rect x=0 y=0></svg>",!1,!0,!1),Nl=m("<svg><line x1=0></svg>",!1,!0,!1),Ul=m("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),Fl=m('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),Il=m("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),Bl=m("<svg><tspan dy=0></svg>",!1,!0,!1),jl=m("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),Hl=m("<svg><g></svg>",!1,!0,!1);const ql=t=>{const{state:e}=cn(),[n,i]=K("[数据字段]");Mt(()=>{if(t.element.content.type==="DataField"){const r=t.element.content.expression||"",o=e().mode;St.shouldShowExpression(o)?i(r||"[数据字段]"):St.shouldEvaluateExpression(o)&&Qe.evaluateExpression(r).then(u=>{u.success?i(String(u.value||"")):i(`[错误: ${u.error}]`)}).catch(u=>{i(`[错误: ${u}]`)})}});const l=be(()=>{const{position:r}=t.element;return{transform:`translate(${r.x}px, ${r.y}px)`,opacity:t.element.visible?1:.5}}),s=()=>{const{content:r,size:o}=t.element;if(r.type==="Text"&&r.content&&r.style){const u=Ye.calculateUnifiedBounds(r.content,r.style,o),c=Ye.getTextAnchor(r.style.align);return(()=>{var f=Pl(),d=f.firstChild;return a(f,(()=>{var v=ce(()=>!!t.selected);return()=>v()&&(()=>{var p=Vt();return N(g=>{var y=u.containerBounds.x,w=u.containerBounds.y,b=u.containerBounds.width,$=u.containerBounds.height;return y!==g.e&&M(p,"x",g.e=y),w!==g.t&&M(p,"y",g.t=w),b!==g.a&&M(p,"width",g.a=b),$!==g.o&&M(p,"height",g.o=$),g},{e:void 0,t:void 0,a:void 0,o:void 0}),p})()})(),d),a(f,(()=>{var v=ce(()=>!!r.style.background);return()=>v()&&(()=>{var p=zl();return N(g=>{var _,k;var y=u.positioning.backgroundX,w=u.positioning.backgroundY,b=u.containerBounds.width+(r.style.background.padding||0)*2,$=u.containerBounds.height+(r.style.background.padding||0)*2,S=r.style.background.color,D=r.style.background.opacity||1,z=((_=r.style.border)==null?void 0:_.radius)||0,T=((k=r.style.border)==null?void 0:k.radius)||0;return y!==g.e&&M(p,"x",g.e=y),w!==g.t&&M(p,"y",g.t=w),b!==g.a&&M(p,"width",g.a=b),$!==g.o&&M(p,"height",g.o=$),S!==g.i&&M(p,"fill",g.i=S),D!==g.n&&M(p,"fill-opacity",g.n=D),z!==g.s&&M(p,"rx",g.s=z),T!==g.h&&M(p,"ry",g.h=T),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),p})()})(),d),a(f,(()=>{var v=ce(()=>!!r.style.border);return()=>v()&&(()=>{var p=Ll();return N(g=>{var k,H;var y=u.positioning.backgroundX,w=u.positioning.backgroundY,b=u.containerBounds.width+(((k=r.style.background)==null?void 0:k.padding)||0)*2,$=u.containerBounds.height+(((H=r.style.background)==null?void 0:H.padding)||0)*2,S=r.style.border.color,D=r.style.border.width,z=r.style.border.style==="Dashed"?"5,5":r.style.border.style==="Dotted"?"2,2":"none",T=r.style.border.radius||0,_=r.style.border.radius||0;return y!==g.e&&M(p,"x",g.e=y),w!==g.t&&M(p,"y",g.t=w),b!==g.a&&M(p,"width",g.a=b),$!==g.o&&M(p,"height",g.o=$),S!==g.i&&M(p,"stroke",g.i=S),D!==g.n&&M(p,"stroke-width",g.n=D),z!==g.s&&M(p,"stroke-dasharray",g.s=z),T!==g.h&&M(p,"rx",g.h=T),_!==g.r&&M(p,"ry",g.r=_),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),p})()})(),d),M(d,"text-anchor",c),a(d,(()=>{var v=ce(()=>{var p;return!!((p=u.textLayout)!=null&&p.isWrapped)});return()=>v()?u.textLayout.wrappedLines.map((p,g)=>(()=>{var y=Ml();return a(y,p),N(w=>{var b=u.positioning.textAnchorX,$=g===0?0:u.fontMetrics.lineHeight;return b!==w.e&&M(y,"x",w.e=b),$!==w.t&&M(y,"dy",w.t=$),w},{e:void 0,t:void 0}),y})()):r.content.split(`
`).map((p,g)=>(()=>{var y=Rl();return a(y,p),N(w=>{var b=u.positioning.textAnchorX,$=g===0?0:u.fontMetrics.lineHeight;return b!==w.e&&M(y,"x",w.e=b),$!==w.t&&M(y,"dy",w.t=$),w},{e:void 0,t:void 0}),y})())})()),N(v=>{var p=u.positioning.textAnchorX,g=u.positioning.textAnchorY,y=r.style.font_family,w=r.style.font_size.toString(),b=r.style.font_weight,$=r.style.color;return p!==v.e&&M(d,"x",v.e=p),g!==v.t&&M(d,"y",v.t=g),y!==v.a&&M(d,"font-family",v.a=y),w!==v.o&&M(d,"font-size",v.o=w),b!==v.i&&M(d,"font-weight",v.i=b),$!==v.n&&M(d,"fill",v.n=$),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),f})()}if(r.type==="Rectangle"){const u=r.opacity!==void 0?r.opacity:1,c=r.corner_radius||0;return(()=>{var f=Ol();return M(f,"rx",c),M(f,"ry",c),M(f,"fill-opacity",u),M(f,"stroke-opacity",u),N(d=>{var $,S,D,z;var v=o.width,p=o.height,g=r.fill_color||"transparent",y=(($=r.border)==null?void 0:$.color)||"#000000",w=((S=r.border)==null?void 0:S.width)||1,b=((D=r.border)==null?void 0:D.style)==="Dashed"?"5,5":((z=r.border)==null?void 0:z.style)==="Dotted"?"2,2":"none";return v!==d.e&&M(f,"width",d.e=v),p!==d.t&&M(f,"height",d.t=p),g!==d.a&&M(f,"fill",d.a=g),y!==d.o&&M(f,"stroke",d.o=y),w!==d.i&&M(f,"stroke-width",d.i=w),b!==d.n&&M(f,"stroke-dasharray",d.n=b),d},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),f})()}if(r.type==="Line"){const u=r.opacity!==void 0?r.opacity:1,c=r.line_style||"Solid",f=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var d=Nl();return M(d,"stroke-opacity",u),M(d,"stroke-dasharray",f),N(v=>{var p=o.height/2,g=o.width,y=o.height/2,w=r.color,b=r.width;return p!==v.e&&M(d,"y1",v.e=p),g!==v.t&&M(d,"x2",v.t=g),y!==v.a&&M(d,"y2",v.a=y),w!==v.o&&M(d,"stroke",v.o=w),b!==v.i&&M(d,"stroke-width",v.i=b),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),d})()}if(r.type==="DataField"&&r.style){const u=n(),c=Ye.calculateUnifiedBounds(u,r.style,o),f=Ye.getTextAnchor(r.style.align);return(()=>{var d=Ul(),v=d.firstChild;return a(d,(()=>{var p=ce(()=>!!t.selected);return()=>p()&&(()=>{var g=Vt();return N(y=>{var w=c.containerBounds.x,b=c.containerBounds.y,$=c.containerBounds.width,S=c.containerBounds.height;return w!==y.e&&M(g,"x",y.e=w),b!==y.t&&M(g,"y",y.t=b),$!==y.a&&M(g,"width",y.a=$),S!==y.o&&M(g,"height",y.o=S),y},{e:void 0,t:void 0,a:void 0,o:void 0}),g})()})(),v),a(d,(()=>{var p=ce(()=>!!St.shouldShowExpression(e().mode));return()=>p()&&(()=>{var g=Fl(),y=g.firstChild,w=y.nextSibling;return N(b=>{var $=c.containerBounds.x+c.containerBounds.width-8,S=c.containerBounds.y+8,D=c.containerBounds.x+c.containerBounds.width-8,z=c.containerBounds.y+8;return $!==b.e&&M(y,"cx",b.e=$),S!==b.t&&M(y,"cy",b.t=S),D!==b.a&&M(w,"x",b.a=D),z!==b.o&&M(w,"y",b.o=z),b},{e:void 0,t:void 0,a:void 0,o:void 0}),g})()})(),v),M(v,"text-anchor",f),a(v,(()=>{var p=ce(()=>{var g;return!!((g=c.textLayout)!=null&&g.isWrapped)});return()=>p()?c.textLayout.wrappedLines.map((g,y)=>(()=>{var w=Il();return a(w,g),N(b=>{var $=c.positioning.textAnchorX,S=y===0?0:c.fontMetrics.lineHeight;return $!==b.e&&M(w,"x",b.e=$),S!==b.t&&M(w,"dy",b.t=S),b},{e:void 0,t:void 0}),w})()):(()=>{var g=Bl();return a(g,u),N(()=>M(g,"x",c.positioning.textAnchorX)),g})()})()),N(p=>{var g=e().mode,y=c.positioning.textAnchorX,w=c.positioning.textAnchorY,b=r.style.font_family,$=r.style.font_size.toString(),S=r.style.font_weight,D=u.startsWith("[错误:")?"#ff4d4f":r.style.color,z=`datafield-content-unified ${e().mode}-mode`;return g!==p.e&&M(d,"data-preview-mode",p.e=g),y!==p.t&&M(v,"x",p.t=y),w!==p.a&&M(v,"y",p.a=w),b!==p.o&&M(v,"font-family",p.o=b),$!==p.i&&M(v,"font-size",p.i=$),S!==p.n&&M(v,"font-weight",p.n=S),D!==p.s&&M(v,"fill",p.s=D),z!==p.h&&M(v,"class",p.h=z),p},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d})()}return(()=>{var u=jl();return N(c=>{var f=o.width,d=o.height;return f!==c.e&&M(u,"width",c.e=f),d!==c.t&&M(u,"height",c.t=d),c},{e:void 0,t:void 0}),u})()};return(()=>{var r=Hl();return a(r,s),N(o=>{var u=`element ${t.selected&&t.element.content.type!=="Text"&&t.element.content.type!=="DataField"?"element-selected":""}`,c=l(),f=t.element.id,d=t.element.content.type;return u!==o.e&&M(r,"class",o.e=u),o.t=rn(r,c,o.t),f!==o.a&&M(r,"data-element-id",o.a=f),d!==o.o&&M(r,"data-element-type",o.o=d),o},{e:void 0,t:void 0,a:void 0,o:void 0}),r})()};var Jl=m("<svg><g class=resize-handles></svg>",!1,!0,!1),Vl=m("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const Wl=t=>{const{updateElement:e,setResizeOperation:n}=We(),[i,l]=K(!1),[s,r]=K(null),[o,u]=K({x:0,y:0}),[c,f]=K({width:0,height:0}),[d,v]=K({x:0,y:0}),[p,g]=K({width:0,height:0}),[y,w]=K({x:0,y:0}),[b,$]=K(!1),S=be(()=>{const{position:F,size:j,content:P}=t.element,V=8/2;let x={x:F.x,y:F.y,width:j.width,height:j.height};if((P.type==="Text"||P.type==="DataField")&&P.style){const oe=P.type==="Text"?P.content:P.expression||"[数据字段]",I=Ye.calculateUnifiedBounds(oe,P.style,j);x={x:F.x+I.containerBounds.x,y:F.y+I.containerBounds.y,width:I.containerBounds.width,height:I.containerBounds.height}}const L=x.x,A=x.y,U=x.x+x.width,q=x.y+x.height,Z=x.x+x.width/2,ue=x.y+x.height/2;return[{position:"nw",cursor:"nw-resize",x:L-V,y:A-V},{position:"ne",cursor:"ne-resize",x:U-V,y:A-V},{position:"sw",cursor:"sw-resize",x:L-V,y:q-V},{position:"se",cursor:"se-resize",x:U-V,y:q-V},{position:"n",cursor:"n-resize",x:Z-V,y:A-V},{position:"s",cursor:"s-resize",x:Z-V,y:q-V},{position:"w",cursor:"w-resize",x:L-V,y:ue-V},{position:"e",cursor:"e-resize",x:U-V,y:ue-V}]}),D=(F,j,P,W=!1,V=!1)=>{const x=c(),L=d();let A=x.width,U=x.height,q=L.x,Z=L.y;switch(F){case"nw":A=x.width-j,U=x.height-P,q=L.x+j,Z=L.y+P;break;case"ne":A=x.width+j,U=x.height-P,Z=L.y+P;break;case"sw":A=x.width-j,U=x.height+P,q=L.x+j;break;case"se":A=x.width+j,U=x.height+P;break;case"n":U=x.height-P,Z=L.y+P;break;case"s":U=x.height+P;break;case"w":A=x.width-j,q=L.x+j;break;case"e":A=x.width+j;break}if(W&&(F==="nw"||F==="ne"||F==="sw"||F==="se")){const oe=x.width/x.height;A/U>oe?(A=U*oe,(F==="nw"||F==="sw")&&(q=L.x+(x.width-A))):(U=A/oe,(F==="nw"||F==="ne")&&(Z=L.y+(x.height-U)))}if(V){const oe=L.x+x.width/2,I=L.y+x.height/2;q=oe-A/2,Z=I-U/2}const ue=20;return A=Math.max(ue,A),U=Math.max(ue,U),{size:{width:A,height:U},position:{x:q,y:Z}}},z=F=>(F.preventDefault(),F.stopPropagation(),F.stopImmediatePropagation(),!1),T=(F,j)=>{var P;n(!0),document.addEventListener("click",z,{capture:!0}),l(!0),r(F),u({x:j.clientX,y:j.clientY}),f({width:t.element.size.width,height:t.element.size.height}),v({x:t.element.position.x,y:t.element.position.y}),g(t.element.size),w(t.element.position),$(!1),document.addEventListener("mousemove",k),document.addEventListener("mouseup",H),document.body.style.cursor=((P=S().find(W=>W.position===F))==null?void 0:P.cursor)||"default"};let _=0;const k=F=>{if(!i())return;const j=s();if(!j)return;const P=o(),W=F.clientX-P.x,V=F.clientY-P.y,x=D(j,W,V,F.shiftKey,F.altKey);g(x.size),w(x.position),$(Math.abs(W)>2||Math.abs(V)>2);const L=Date.now();if(L-_>50)try{e(t.element.id,{size:x.size,position:x.position}),_=L}catch{}},H=()=>{if(!i()||!s())return;const j=()=>{document.removeEventListener("click",z,{capture:!0}),n(!1),l(!1),r(null),document.body.style.cursor="default",document.removeEventListener("mousemove",k),document.removeEventListener("mouseup",H)};if(b()){const P=p(),W=y();e(t.element.id,{size:P,position:W}).catch(V=>{e(t.element.id,{size:c(),position:d()}).catch(x=>{})})}j()};return xt(()=>{n(!1),document.removeEventListener("click",z,{capture:!0}),document.removeEventListener("mousemove",k),document.removeEventListener("mouseup",H),document.body.style.cursor="default"}),(()=>{var F=Jl();return a(F,()=>S().map(j=>(()=>{var P=Vl(),W=P.firstChild,V=W.nextSibling;return V.addEventListener("mouseleave",x=>{i()||(document.body.style.cursor="default")}),V.addEventListener("mouseenter",x=>{i()||(document.body.style.cursor=j.cursor)}),V.$$mousedown=x=>{x.stopPropagation(),x.preventDefault(),T(j.position,x)},V.style.setProperty("pointer-events","all"),N(x=>{var L=j.x+4,A=j.y+4,U=j.x,q=j.y,Z=j.cursor;return L!==x.e&&M(W,"cx",x.e=L),A!==x.t&&M(W,"cy",x.t=A),U!==x.a&&M(V,"x",x.a=U),q!==x.o&&M(V,"y",x.o=q),Z!==x.i&&((x.i=Z)!=null?V.style.setProperty("cursor",Z):V.style.removeProperty("cursor")),x},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),P})())),F})()};Le(["mousedown"]);var Me=(t=>(t.IDLE="idle",t.HOVER="hover",t.SELECTING="selecting",t.DRAGGING="dragging",t))(Me||{});const Kl={dragThreshold:3,updateThrottle:16};var Gl=m("<div tabindex=0>"),Xl=m("<div>"),Yl=m("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),Ql=m("<div>拖拽: <!>个元素"),Zl=m("<div>[<!>]");const es=t=>{const{resizeOperation:e,setResizeOperation:n}=We(),i=Kl;let l;const[s,r]=K(Me.IDLE),[o,u]=K([]),[c,f]=K(null),[d,v]=K(null),[p,g]=K(null),y=(C,E)=>Math.sqrt(Math.pow(C.x-E.x,2)+Math.pow(C.y-E.y,2)),w=(C,E)=>C.length===E.length&&C.every((B,R)=>B===E[R]),b=()=>{g(null)},[$,S]=K(null);let D="default";const z=(C,E)=>{!l||D===C||(l.style.cursor=C,D=C)},T=(C,...E)=>{console.log(`🎯 [InteractionLayer] ${C}`,...E)},_=C=>{if(!l)return{x:0,y:0};const E=l.getBoundingClientRect();return{x:C.clientX-E.left,y:C.clientY-E.top}},k=(C,E)=>C.x>=E.position.x&&C.x<=E.position.x+E.size.width&&C.y>=E.position.y&&C.y<=E.position.y+E.size.height,H=C=>{var B;const E=F(C);return E.length>0&&(B=E[0])!=null?B:null},F=C=>{const E=t.getAllElements();return E.filter(R=>R&&R.visible&&k(C,R)).sort((R,J)=>{var _e,we;const ne=(_e=R.z_index)!=null?_e:E.indexOf(R);return((we=J.z_index)!=null?we:E.indexOf(J))-ne})},j=C=>{const E=o();if(E.length===0)return null;const B=t.getAllElements();for(const R of E){const J=B.find(Se=>Se.id===R);if(!J||!J.visible)continue;const ne=8,ie=ne/2,_e=J.position.x,we=J.position.y,ae=J.position.x+J.size.width,Ne=J.position.y+J.size.height,Oe=J.position.x+J.size.width/2,Ue=J.position.y+J.size.height/2,ve=[{direction:"nw",cursor:"nw-resize",x:_e-ie,y:we-ie},{direction:"ne",cursor:"ne-resize",x:ae-ie,y:we-ie},{direction:"sw",cursor:"sw-resize",x:_e-ie,y:Ne-ie},{direction:"se",cursor:"se-resize",x:ae-ie,y:Ne-ie},{direction:"n",cursor:"n-resize",x:Oe-ie,y:we-ie},{direction:"s",cursor:"s-resize",x:Oe-ie,y:Ne-ie},{direction:"w",cursor:"w-resize",x:_e-ie,y:Ue-ie},{direction:"e",cursor:"e-resize",x:ae-ie,y:Ue-ie}];for(const Se of ve)if(C.x>=Se.x&&C.x<Se.x+ne&&C.y>=Se.y&&C.y<Se.y+ne)return{elementId:J.id,direction:Se.direction,cursor:Se.cursor}}return null},P=C=>t.getAllElements().filter(B=>{if(!B.visible)return!1;const R={x:B.position.x,y:B.position.y,width:B.size.width,height:B.size.height};return!(R.x>C.x+C.width||R.x+R.width<C.x||R.y>C.y+C.height||R.y+R.height<C.y)}),W=(C,E)=>{var R,J,ne;const B=F(C);return T("重叠选择检测",{elementsCount:B.length,isCtrlClick:E,elementIds:B.map(ie=>ie.id)}),B.length===0?null:B.length===1?(b(),((R=B[0])==null?void 0:R.id)||null):E?V(C,B):(b(),T("普通点击选中最上层",{elementId:(J=B[0])==null?void 0:J.id}),((ne=B[0])==null?void 0:ne.id)||null)},V=(C,E)=>{var ne,ie,_e,we;const B=p(),R=Date.now();if(T("循环选择开始",{hasContext:!!B,elementIds:E.map(ae=>ae.id)}),!B||y(C,B.clickPoint)>5||R-B.lastClickTime>3e3||!w(E.map(ae=>ae.id),B.overlappingElements.map(ae=>ae.id))){const ae=E.length>1?1:0;return g({clickPoint:C,overlappingElements:E,currentSelectedIndex:ae,lastClickTime:R}),T("循环选择重置",{selectedIndex:ae,selectedId:(ne=E[ae])==null?void 0:ne.id,reason:B?y(C,B.clickPoint)>5?"position_changed":R-B.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),x(ae+1,E.length,C),((ie=E[ae])==null?void 0:ie.id)||null}else{const ae=(B.currentSelectedIndex+1)%E.length;return g({...B,currentSelectedIndex:ae,lastClickTime:R}),T("循环选择继续",{selectedIndex:ae,selectedId:(_e=E[ae])==null?void 0:_e.id}),x(ae+1,E.length,C),((we=E[ae])==null?void 0:we.id)||null}},x=(C,E,B)=>{const R=document.querySelector(".overlap-indicator");R!=null&&R.parentNode&&R.parentNode.removeChild(R);const J=document.createElement("div");J.className="overlap-indicator",J.textContent=`${C}/${E}`,Object.assign(J.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${B.x+10}px`,top:`${B.y-20}px`}),document.body.appendChild(J),T("显示重叠指示器",{current:C,total:E,point:B}),setTimeout(()=>{J.parentNode&&(J.parentNode.removeChild(J),T("移除重叠指示器"))},1500)},L=C=>{var B;const E=_(C);if($()){Q(E);return}if(s()===Me.DRAGGING){me(E);return}if(s()===Me.SELECTING){de(E);return}if(s()===Me.IDLE&&c()&&!((B=c())!=null&&B.isDragging)){te(E);return}s()===Me.IDLE&&!c()&&!$()&&A(E)},A=C=>{const E=j(C);if(E){z(E.cursor);return}const B=H(C);if(B){const J=o().includes(B.id)?"grab":"pointer";z(J);return}z("default")},U=C=>{const E=_(C),B=j(E);if(B){T("点击ResizeHandle",{elementId:B.elementId,direction:B.direction}),q(B,E);return}if(e()){T("调整大小操作进行中，跳过交互处理");return}const R=W(E,C.ctrlKey);if(T("鼠标按下",{point:E,selectedElementId:R,currentMode:s(),isCtrlClick:C.ctrlKey}),R){const J=t.getAllElements().find(ne=>ne.id===R);J&&Z(J,E,C)}else ue(E)},q=(C,E,B)=>{const R=t.getAllElements().find(J=>J.id===C.elementId);R&&(T("开始resize操作",{elementId:C.elementId,direction:C.direction}),n(!0),S({elementId:C.elementId,handlePosition:C.direction,startPoint:E,initialSize:{width:R.size.width,height:R.size.height},initialPosition:{x:R.position.x,y:R.position.y},cursor:C.cursor}),z(C.cursor),T("resize状态已设置",$()))},Z=(C,E,B)=>{const R=o().includes(C.id),J=o(),ne=!!p();T("元素点击",{elementId:C.id,isSelected:R,currentlySelected:J,ctrlKey:B.ctrlKey,shiftKey:B.shiftKey,hasOverlapContext:ne}),B.ctrlKey&&!ne?oe(C.id):B.shiftKey&&o().length>0?I(C.id):R?(T("点击已选中元素，准备拖拽",{selectedCount:J.length}),Y(J,E)):le(C.id,E)},ue=(C,E)=>{var B;T("开始框选",{point:C}),u([]),(B=t.onElementsSelect)==null||B.call(t,[]),b(),r(Me.SELECTING),z("crosshair"),v({startPoint:C,currentPoint:C,selectedIds:[]})},oe=C=>{var R;const E=o(),B=E.includes(C)?E.filter(J=>J!==C):[...E,C];T("切换选择",{elementId:C,newSelection:B}),u(B),(R=t.onElementsSelect)==null||R.call(t,B)},I=C=>{var B;const E=o();if(!E.includes(C)){const R=[...E,C];T("添加到选择",{elementId:C,newSelection:R}),u(R),(B=t.onElementsSelect)==null||B.call(t,R)}},le=(C,E,B)=>{var R;T("选择并准备拖拽",{elementId:C,point:E}),u([C]),(R=t.onElementsSelect)==null||R.call(t,[C]),Y([C],E)},Y=(C,E,B)=>{T("准备拖拽操作",{elementIds:C,startPoint:E});const R=t.getAllElements(),J=new Map;C.forEach(ne=>{const ie=R.find(_e=>_e.id===ne);ie&&J.set(ne,{x:ie.position.x,y:ie.position.y})}),f({elementIds:C,startPoint:E,startPositions:J,currentOffset:{x:0,y:0},isDragging:!1})},te=C=>{const E=c();if(!E)return;const B=Math.sqrt(Math.pow(C.x-E.startPoint.x,2)+Math.pow(C.y-E.startPoint.y,2));B>i.dragThreshold&&(T("开始拖拽",{distance:B,threshold:i.dragThreshold}),r(Me.DRAGGING),z("grabbing"),f({...E,isDragging:!0}))};let G=!1,ee=0;const se=(C,E=!1)=>{if(E){C();return}Date.now()-ee>=i.updateThrottle&&!G&&(G=!0,requestAnimationFrame(()=>{C(),G=!1,ee=Date.now()}))},me=C=>{const E=c();if(!E)return;const B={x:C.x-E.startPoint.x,y:C.y-E.startPoint.y};f({...E,currentOffset:B}),se(()=>{if(t.onBatchUpdatePositions&&E.elementIds.length>1){const R=E.elementIds.map(J=>{const ne=E.startPositions.get(J);return ne?{element_id:J,new_position:{x:ne.x+B.x,y:ne.y+B.y}}:null}).filter(Boolean);R.length>0&&t.onBatchUpdatePositions(R).catch(()=>{})}else if(t.onElementMove){const R=E.elementIds.map(J=>{const ne=E.startPositions.get(J);if(ne)return t.onElementMove(J,{x:ne.x+B.x,y:ne.y+B.y})}).filter(Boolean);Promise.allSettled(R).catch(()=>{})}})},de=C=>{const E=d();if(!E)return;const B={...E,currentPoint:C};v(B);const R={x:Math.min(E.startPoint.x,C.x),y:Math.min(E.startPoint.y,C.y),width:Math.abs(C.x-E.startPoint.x),height:Math.abs(C.y-E.startPoint.y)},ne=P(R).map(ie=>ie.id);v({...B,selectedIds:ne}),u(ne)},Q=C=>{const E=$();if(!E)return;const B=C.x-E.startPoint.x,R=C.y-E.startPoint.y,J=ye(E.handlePosition,B,R,E.initialSize,E.initialPosition);se(()=>{t.onElementResize&&t.onElementResize(E.elementId,J.size,J.position)})},ye=(C,E,B,R,J)=>{let ne=R.width,ie=R.height,_e=J.x,we=J.y;switch(C){case"nw":ne=R.width-E,ie=R.height-B,_e=J.x+E,we=J.y+B;break;case"ne":ne=R.width+E,ie=R.height-B,we=J.y+B;break;case"sw":ne=R.width-E,ie=R.height+B,_e=J.x+E;break;case"se":ne=R.width+E,ie=R.height+B;break;case"n":ie=R.height-B,we=J.y+B;break;case"s":ie=R.height+B;break;case"w":ne=R.width-E,_e=J.x+E;break;case"e":ne=R.width+E;break}const ae=10;return ne=Math.max(ae,ne),ie=Math.max(ae,ie),{size:{width:ne,height:ie},position:{x:_e,y:we}}},$e=()=>{const C=s();if(T("鼠标释放",{currentMode:C,hasResizeState:!!$()}),$()){pe();return}C===Me.DRAGGING?fe():C===Me.SELECTING&&Pe(),Te()},fe=()=>{const C=c();if(!C||!C.isDragging&&C.currentOffset.x===0&&C.currentOffset.y===0){T("拖拽完成，无实际移动");return}if(t.onBatchUpdatePositions&&C.elementIds.length>1){const E=C.elementIds.map(B=>{const R=C.startPositions.get(B);return R?{element_id:B,new_position:{x:R.x+C.currentOffset.x,y:R.y+C.currentOffset.y}}:null}).filter(Boolean);E.length>0&&(T("拖拽完成 - 批量更新",{elementCount:E.length}),t.onBatchUpdatePositions(E).catch(B=>{console.warn("批量更新最终位置失败:",B)}))}},Pe=()=>{const C=d();C&&(T("框选完成",{selectedCount:C.selectedIds.length}),t.onElementsSelect&&t.onElementsSelect(C.selectedIds))},pe=()=>{const C=$();C&&(T("完成resize操作",{elementId:C.elementId}),n(!1),S(null))},Te=()=>{r(Me.IDLE),z("default"),f(null),v(null),S(null),n(!1),b(),T("状态重置完成")};Je(async()=>{document.addEventListener("mousemove",L),document.addEventListener("mouseup",$e),T("修复版交互层已初始化")}),xt(()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",$e),T("修复版交互层已清理")});const De=()=>{const C=d();if(!C||s()!==Me.SELECTING)return null;const{startPoint:E,currentPoint:B}=C;return{x:Math.min(E.x,B.x),y:Math.min(E.y,B.y),width:Math.abs(B.x-E.x),height:Math.abs(B.y-E.y)}};return(()=>{var C=Gl();C.$$mousedown=U;var E=l;return typeof E=="function"?an(E,C):l=C,C.style.setProperty("position","absolute"),C.style.setProperty("top","0"),C.style.setProperty("left","0"),C.style.setProperty("width","100%"),C.style.setProperty("height","100%"),C.style.setProperty("z-index","10"),C.style.setProperty("pointer-events","all"),C.style.setProperty("background","transparent"),C.style.setProperty("user-select","none"),a(C,(()=>{var B=ce(()=>!!De());return()=>B()&&(()=>{var R=Xl();return R.style.setProperty("position","absolute"),R.style.setProperty("border","1px dashed #007acc"),R.style.setProperty("background","rgba(0, 122, 204, 0.1)"),R.style.setProperty("pointer-events","none"),N(J=>{var ne=`${De().x}px`,ie=`${De().y}px`,_e=`${De().width}px`,we=`${De().height}px`;return ne!==J.e&&((J.e=ne)!=null?R.style.setProperty("left",ne):R.style.removeProperty("left")),ie!==J.t&&((J.t=ie)!=null?R.style.setProperty("top",ie):R.style.removeProperty("top")),_e!==J.a&&((J.a=_e)!=null?R.style.setProperty("width",_e):R.style.removeProperty("width")),we!==J.o&&((J.o=we)!=null?R.style.setProperty("height",we):R.style.removeProperty("height")),J},{e:void 0,t:void 0,a:void 0,o:void 0}),R})()})(),null),a(C,(()=>{var B=ce(()=>!!t.enableDebugMode);return()=>B()&&(()=>{var R=Yl(),J=R.firstChild,ne=J.nextSibling;ne.firstChild;var ie=ne.nextSibling;ie.firstChild;var _e=ie.nextSibling;return _e.firstChild,R.style.setProperty("position","fixed"),R.style.setProperty("top","10px"),R.style.setProperty("right","10px"),R.style.setProperty("padding","8px"),R.style.setProperty("background","rgba(0, 0, 0, 0.8)"),R.style.setProperty("color","white"),R.style.setProperty("font-family","monospace"),R.style.setProperty("font-size","12px"),R.style.setProperty("border-radius","4px"),R.style.setProperty("z-index","9999"),R.style.setProperty("pointer-events","none"),a(ne,s,null),a(ie,()=>o().length,null),a(_e,D,null),a(R,(()=>{var we=ce(()=>{var ae;return!!((ae=c())!=null&&ae.isDragging)});return()=>we()&&(()=>{var ae=Ql(),Ne=ae.firstChild,Oe=Ne.nextSibling;return Oe.nextSibling,ae.style.setProperty("color","#ffeb3b"),a(ae,()=>{var Ue;return(Ue=c())==null?void 0:Ue.elementIds.length},Oe),ae})()})(),null),a(R,(()=>{var we=ce(()=>o().length>0);return()=>we()&&(()=>{var ae=Zl(),Ne=ae.firstChild,Oe=Ne.nextSibling;return Oe.nextSibling,ae.style.setProperty("font-size","10px"),ae.style.setProperty("color","#ccc"),a(ae,()=>o().slice(0,3).join(", "),Oe),a(ae,()=>o().length>3&&"...",Oe),ae})()})(),null),R})()})(),null),C})()};Le(["mousedown"]);var ts=m("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),ns=m("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),is=m('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),ls=m('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const ss=(t,e)=>{if(t.length<2)return[];const n=t.map(i=>({x:i.position.x,y:i.position.y,width:i.size.width,height:i.size.height}));return n.map((i,l)=>{let s=i.x,r=i.y;switch(e){case"left":s=Math.min(...n.map(d=>d.x));break;case"right":s=Math.max(...n.map(d=>d.x+d.width))-i.width;break;case"top":r=Math.min(...n.map(d=>d.y));break;case"bottom":r=Math.max(...n.map(d=>d.y+d.height))-i.height;break;case"h_center":s=n.reduce((d,v)=>d+v.x+v.width/2,0)/n.length-i.width/2;break;case"v_center":r=n.reduce((d,v)=>d+v.y+v.height/2,0)/n.length-i.height/2;break}return{element_id:t[l].id,new_position:{x:s,y:r}}})},rs=t=>{const{batchUpdatePositions:e,state:n}=We(),[i,l]=K(!1),s=()=>t.selectedElementIds().length>=2,r=()=>{const f=t.selectedElementIds();return n.elements.filter(d=>f.includes(d.id))},o=async f=>{const d=r();if(d.length<2){console.warn("对齐功能需要至少2个元素");return}try{l(!0),console.log(`🎯 执行${f}对齐:`,d.length,"个元素");const v=ss(d,f);await e(v),console.log("✅ 对齐操作完成"),t.onAlignmentComplete&&t.onAlignmentComplete(v)}catch(v){console.error("❌ 对齐操作失败:",v)}finally{l(!1)}},u=()=>r().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>u();return(()=>{var f=ls(),d=f.firstChild,v=d.firstChild,p=v.nextSibling,g=p.firstChild,y=g.nextSibling,w=y.nextSibling,b=d.nextSibling,$=b.firstChild,S=$.nextSibling,D=S.firstChild,z=D.nextSibling,T=z.nextSibling,_=b.nextSibling,k=_.firstChild,H=k.nextSibling,F=H.firstChild,j=F.nextSibling;return g.$$click=()=>o("left"),y.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"h_center")}),y.$$click=()=>o("h_center"),w.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"right")}),w.$$click=()=>o("right"),D.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"top")}),D.$$click=()=>o("top"),z.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"v_center")}),z.$$click=()=>o("v_center"),T.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"bottom")}),T.$$click=()=>o("bottom"),F.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"distribute_h")}),F.$$click=()=>o("distribute_h"),j.addEventListener("mouseenter",()=>{var P;return(P=t.onAlignmentPreview)==null?void 0:P.call(t,"distribute_v")}),j.$$click=()=>o("distribute_v"),a(f,h(O,{get when(){return ce(()=>!!s())()&&c()},get children(){var P=ts(),W=P.firstChild,V=W.nextSibling,x=V.firstChild,L=x.nextSibling,A=V.nextSibling;return V.$$click=()=>o(c().recommended),a(L,()=>c().recommended==="left"&&"左对齐",null),a(L,()=>c().recommended==="right"&&"右对齐",null),a(L,()=>c().recommended==="top"&&"顶对齐",null),a(L,()=>c().recommended==="bottom"&&"底对齐",null),a(L,()=>c().recommended==="h_center"&&"水平居中",null),a(L,()=>c().recommended==="v_center"&&"垂直居中",null),a(A,()=>c().reason),N(U=>{var q=i(),Z=c().reason;return q!==U.e&&(V.disabled=U.e=q),Z!==U.t&&M(V,"title",U.t=Z),U},{e:void 0,t:void 0}),P}}),null),a(f,h(O,{get when(){return!s()},get children(){var P=ns(),W=P.firstChild;return W.firstChild,a(W,()=>t.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),P}}),null),a(f,h(O,{get when(){return i()},get children(){return is()}}),null),N(P=>{var W=!s()||i(),V=!s()||i(),x=!s()||i(),L=!s()||i(),A=!s()||i(),U=!s()||i(),q=t.selectedElementIds().length<3||i(),Z=t.selectedElementIds().length<3||i();return W!==P.e&&(g.disabled=P.e=W),V!==P.t&&(y.disabled=P.t=V),x!==P.a&&(w.disabled=P.a=x),L!==P.o&&(D.disabled=P.o=L),A!==P.i&&(z.disabled=P.i=A),U!==P.n&&(T.disabled=P.n=U),q!==P.s&&(F.disabled=P.s=q),Z!==P.h&&(j.disabled=P.h=Z),P},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),f})()},as=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const t=document.createElement("style");t.textContent=as,document.head.appendChild(t)}Le(["click"]);var os=m("<div>"),cs=m('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),ds=m("<span class=ml-2>Zoom: <!>%");const us=()=>{const{state:t,selectElement:e,clearSelection:n,createElement:i,selectMultiple:l,updateElement:s,batchUpdatePositions:r}=We();let o;const[u,c]=K([]),f=be(()=>t.elements.filter(S=>S.visible)),d=(S,D)=>{if(!o)return{x:0,y:0};const z=o.getBoundingClientRect(),T=(S-z.left)/t.canvas_config.zoom,_=(D-z.top)/t.canvas_config.zoom;return{x:T,y:_}},v=async S=>{console.log("🎯 选择元素",S),c([...S]);try{S.length===0?await n():S.length===1?await e(S[0]):await l([...S])}catch(D){console.error("❌ 选择元素失败:",D)}},p=async S=>{try{await r(S)}catch(D){console.error("❌ 批量更新位置失败:",D)}},g=async(S,D)=>{try{await s(S,{position:{x:D.x,y:D.y}})}catch(z){console.error("❌ 移动元素失败:",z)}},y=async(S,D,z)=>{try{await s(S,{size:D,position:z})}catch(T){console.error("❌ 调整大小失败:",T)}},w=async S=>{console.log("🖱️ 画布点击",S)},b=async S=>{var D;S.preventDefault();try{const z=(D=S.dataTransfer)==null?void 0:D.getData("application/json");if(!z)return;const{type:T,component:_}=JSON.parse(z);if(T==="component"){const{x:k,y:H}=d(S.clientX,S.clientY),F=Math.max(0,k-_.default_size.width/2),j=Math.max(0,H-_.default_size.height/2);console.log("🎯 通过拖放创建组件:",_.name,"at",F,j);const P=await i(_.id,{x:F,y:j},_.default_size,_.create_content());console.log("✅ 通过拖放创建元素成功:",P),c([P]),await e(P)}}catch(z){console.error("拖放处理失败:",z)}};Je(()=>{c([...t.selected_ids])}),be(()=>{c([...t.selected_ids])});const $=be(()=>{const{width:S,height:D}=t.canvas_config;return`0 0 ${S} ${D}`});return(()=>{var S=cs(),D=S.firstChild,z=D.firstChild,T=z.firstChild,_=T.nextSibling,k=_.nextSibling,H=k.nextSibling,F=H.nextSibling,j=F.nextSibling,P=j.firstChild,W=P.nextSibling;W.nextSibling;var V=D.nextSibling,x=V.firstChild,L=x.firstChild,A=L.firstChild,U=A.firstChild,q=U.nextSibling,Z=q.nextSibling,ue=Z.nextSibling;a(z,()=>t.canvas_config.width,_),a(z,()=>t.canvas_config.height,H),a(z,(()=>{var I=ce(()=>t.canvas_config.zoom!==1);return()=>I()&&(()=>{var le=ds(),Y=le.firstChild,te=Y.nextSibling;return te.nextSibling,a(le,()=>Math.round(t.canvas_config.zoom*100),te),le})()})(),j),a(j,()=>t.elements.length,W),a(j,()=>u().length,null),L.style.setProperty("position","relative"),A.addEventListener("drop",b),A.addEventListener("dragover",I=>{I.preventDefault(),I.dataTransfer.dropEffect="copy"}),A.$$contextmenu=I=>I.preventDefault();var oe=o;return typeof oe=="function"?an(oe,A):o=A,a(A,h(Tl,{get config(){return t.canvas_config}}),q),a(Z,h(ge,{get each(){return f()},children:I=>h(ql,{element:I,get selected(){return u().includes(I.id)}})})),a(ue,h(ge,{get each(){return f().filter(I=>u().includes(I.id))},children:I=>h(Wl,{element:I})})),a(L,h(es,{canvasRef:o,getAllElements:()=>[...t.elements],onElementsSelect:v,onElementMove:g,onBatchUpdatePositions:p,onElementResize:y,onCanvasClick:w,get enableDebugMode(){return!1}}),null),a(L,h(O,{get when(){return u().length>=2},get children(){var I=os();return I.style.setProperty("position","fixed"),I.style.setProperty("top","80px"),I.style.setProperty("right","20px"),I.style.setProperty("z-index","1000"),I.style.setProperty("background","white"),I.style.setProperty("border-radius","8px"),I.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),I.style.setProperty("border","1px solid #e5e7eb"),a(I,h(rs,{selectedElementIds:u,onAlignmentComplete:le=>{console.log("✅ 对齐操作完成:",le)},onAlignmentPreview:le=>{console.log("👁️ 对齐预览:",le)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),I}}),null),N(I=>{var le=t.canvas_config.width*t.canvas_config.zoom,Y=t.canvas_config.height*t.canvas_config.zoom,te=$(),G=t.canvas_config.width,ee=t.canvas_config.height,se=t.canvas_config.background_color,me=t.canvas_config.width,de=t.canvas_config.height;return le!==I.e&&M(A,"width",I.e=le),Y!==I.t&&M(A,"height",I.t=Y),te!==I.a&&M(A,"viewBox",I.a=te),G!==I.o&&M(U,"width",I.o=G),ee!==I.i&&M(U,"height",I.i=ee),se!==I.n&&M(U,"fill",I.n=se),me!==I.s&&M(q,"width",I.s=me),de!==I.h&&M(q,"height",I.h=de),I},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),S})()};Le(["contextmenu"]);var hs=m("<div class=wizard-errors>"),gs=m("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),fs=m("<div class=error-message>"),vs=m("<div class=wizard-progress>"),ms=m("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),ys=m("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),ps=m("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),bs=m("<span class=feature-tag>"),$s=m("<div class=data-input-step><div class=step-header><h4></h4><p>"),_s=m("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),xs=m("<div class=file-error>"),ws=m('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),Ss=m("<div class=field-error>"),Cs=m("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),ks=m('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),Es=m('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),Ts=m("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),Ds=m("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),As=m('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),Ps=m("<span class=status-success>✅ JSON格式正确"),zs=m("<span class=status-error>❌ 格式错误"),Ls=m("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),Ms=m("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),Rs=m(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),Os=m("<div class=template-item><div class=template-name></div><div class=template-description>"),Ns=m("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),Us=m("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Fs=m('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),Is=m("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),Bs=m("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),js=m("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),Hs=m("<li>首次配置数据源时，建议先测试连接确保配置正确"),qs=m("<li>测试过程会验证JSON格式和文件访问权限"),Js=m("<li>预览功能可以帮助您确认数据结构是否符合预期"),Vs=m("<li>✅ 连接测试成功！您可以继续创建数据源"),Ws=m("<li>预览显示的是实际数据，创建后可用于报表设计"),Ks=m("<li>字段名称将用于数据绑定表达式"),Gs=m("<li>❌ 请检查JSON格式是否正确"),Xs=m("<li>如果是文件类型，请确认文件路径存在且可访问"),Ys=m("<li>可以返回上一步修改配置后重新测试"),Qs=m("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),Zs=m("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),er=m("<span class=loading-spinner>⏳"),tr=m("<span class=test-button-icon>🔌"),nr=m("<div class=field-tag><span class=field-name>"),ir=m("<th>"),lr=m("<tr>"),sr=m("<td><div class=cell-content>"),rr=m("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),ar=m('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),or=m('<button class="control-btn finish-btn">'),cr=m("<span class=hint-text>选择您的JSON数据来源方式"),Wt=m("<span class=hint-text>"),dr=m("<span class=hint-text>设置数据源名称和选项"),ur=m('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),hr=m("<span class=btn-loading>⏳"),gr=m("<span class=btn-text>创建中..."),fr=m("<span class=btn-icon>✓"),vr=m("<span class=btn-text>创建数据源");function xn(t){const[e,n]=K({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),i=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],l=be(()=>{const g=e();switch(g.currentStep){case 1:return g.sourceType!==null;case 2:return s(g);case 3:return r(g);case 4:return o(g);default:return!1}}),s=g=>{var y,w;if(g.sourceType==="file")return!!((y=g.config.file_path)!=null&&y.trim());if(g.sourceType==="content"){const b=(w=g.config.json_content)==null?void 0:w.trim();if(!b)return!1;try{return JSON.parse(b),!0}catch{return!1}}return!1},r=g=>{const y=g.name.trim();return!(y.length<2||y.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(y))},o=g=>{var y;return!!((y=g.testResult)!=null&&y.success)},u=g=>{const y=e();n(w=>({...w,validation:{...w.validation,errors:[]}})),y.currentStep===1&&y.sourceType?n(w=>({...w,currentStep:g,config:{...w.config,source_type:y.sourceType}})):n(w=>({...w,currentStep:g}))},c=()=>{const g=e();g.currentStep<4&&l()&&u(g.currentStep+1)},f=()=>{const g=e();g.currentStep>1&&(g.currentStep===4?n(y=>({...y,currentStep:y.currentStep-1,testResult:null})):u(g.currentStep-1))},d=g=>{n(y=>({...y,...g}))},v=async()=>{const g=e();d({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const y={...g.config,source_type:g.sourceType};if(await xe.testConnection("json",y)){console.log("✅ 连接测试成功，获取预览数据...");const b=await xe.discoverSchema("json",y),$=`temp_${Date.now()}`,S=await xe.createDataSource($,"json",y),D=await xe.getPreview(S,void 0,5);await xe.deleteDataSource(S),d({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:D.total_rows,fields:b.columns.map(z=>z.name),sample_data:D.rows}},loading:!1})}}catch(y){console.error("❌ 连接测试失败:",y),d({testResult:{success:!1,message:"连接测试失败",error:y instanceof Error?y.message:String(y)},loading:!1})}},p=async()=>{const g=e();d({loading:!0});try{console.log("🔄 开始创建数据源...");const y={...g.config,source_type:g.sourceType},w=await xe.createDataSource(g.name,"json",y);console.log("✅ 数据源创建成功，ID:",w);try{await Qe.setActiveDataSource(w),console.log("✅ 数据源自动激活成功")}catch(b){console.warn("⚠️ 数据源激活失败，但创建成功:",b)}t.onSuccess(),t.onBack()}catch(y){console.error("❌ 创建数据源失败:",y),d({validation:{isValid:!1,errors:[`创建失败: ${y}`],warnings:[]},loading:!1})}};return(()=>{var g=gs(),y=g.firstChild,w=y.firstChild,b=w.nextSibling,$=b.firstChild,S=$.nextSibling,D=y.nextSibling;return Ee(w,"click",t.onBack),a(S,()=>{var z;return(z=i[e().currentStep-1])==null?void 0:z.description}),a(g,h(mr,{get currentStep(){return e().currentStep},stepInfo:i,onStepClick:u}),D),a(D,h(O,{get when(){return e().currentStep===1},get children(){return h(yr,{get selectedType(){return e().sourceType},onSelect:z=>d({sourceType:z,config:{...e().config,source_type:z}})})}}),null),a(D,h(O,{get when(){return e().currentStep===2},get children(){return h(pr,{get sourceType(){return e().sourceType},get config(){return e().config},onConfigUpdate:z=>d({config:{...e().config,...z}})})}}),null),a(D,h(O,{get when(){return e().currentStep===3},get children(){return h($r,{get name(){return e().name},get config(){return e().config},onNameChange:z=>d({name:z}),onConfigUpdate:z=>d({config:{...e().config,...z}})})}}),null),a(D,h(O,{get when(){return e().currentStep===4},get children(){return h(xr,{get config(){return e().config},get testResult(){return e().testResult},get loading(){return e().loading},onTest:v})}}),null),a(g,h(wr,{get currentStep(){return e().currentStep},get canProceed(){return l()},get loading(){return e().loading},get testResult(){return e().testResult},onPrevious:f,onNext:c,onFinish:p}),null),a(g,h(O,{get when(){return e().validation.errors.length>0},get children(){var z=hs();return a(z,h(ge,{get each(){return e().validation.errors},children:T=>(()=>{var _=fs();return a(_,T),_})()})),z}}),null),g})()}function mr(t){return(()=>{var e=vs();return a(e,h(ge,{get each(){return t.stepInfo},children:n=>{const i=t.currentStep===n.step,l=t.currentStep>n.step,s=t.currentStep>=n.step;return(()=>{var r=ms(),o=r.firstChild,u=o.firstChild,c=o.nextSibling,f=c.firstChild,d=f.nextSibling;return r.$$click=()=>s&&t.onStepClick(n.step),he(r,`progress-step ${i?"active":""} ${l?"completed":""}`),a(u,()=>l?"✓":n.step),a(f,()=>n.title),a(d,()=>n.description),r})()}})),e})()}function yr(t){const e=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var n=ys(),i=n.firstChild,l=i.nextSibling;return a(l,h(ge,{each:e,children:s=>(()=>{var r=ps(),o=r.firstChild,u=o.firstChild,c=u.nextSibling,f=o.nextSibling,d=f.nextSibling,v=d.nextSibling,p=v.firstChild;return r.$$click=()=>t.onSelect(s.type),a(u,()=>s.title),a(c,()=>s.description),a(f,h(ge,{get each(){return s.features},children:g=>(()=>{var y=bs();return a(y,g),y})()})),a(d,()=>s.example),p.addEventListener("change",()=>t.onSelect(s.type)),N(()=>he(r,`source-option ${t.selectedType===s.type?"selected":""}`)),N(()=>p.checked=t.selectedType===s.type),r})()})),n})()}function pr(t){return(()=>{var e=$s(),n=e.firstChild,i=n.firstChild,l=i.nextSibling;return a(i,()=>t.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),a(l,()=>t.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),a(e,h(O,{get when(){return t.sourceType==="file"},get children(){return h(br,{get filePath(){return t.config.file_path||""},onFileSelect:s=>t.onConfigUpdate({file_path:s})})}}),null),a(e,h(O,{get when(){return t.sourceType==="content"},get children(){return h(_r,{get content(){return t.config.json_content||""},onContentChange:s=>t.onConfigUpdate({json_content:s})})}}),null),e})()}function br(t){const[e,n]=K(!1),[i,l]=K(null),s=u=>{var d;const f=(d=u.target.files)==null?void 0:d[0];f&&o(f)},r=u=>{var f,d;u.preventDefault(),n(!1);const c=(d=(f=u.dataTransfer)==null?void 0:f.files)==null?void 0:d[0];c&&o(c)},o=u=>{if(l(null),!u.name.endsWith(".json")){l("请选择JSON文件（.json格式）");return}if(u.size>10*1024*1024){l("文件大小不能超过10MB");return}const c=new FileReader;c.onload=f=>{var d;try{const v=(d=f.target)==null?void 0:d.result;JSON.parse(v),t.onFileSelect(u.name),console.log("✅ 文件选择成功:",u.name)}catch{l("文件内容不是有效的JSON格式")}},c.readAsText(u)};return(()=>{var u=ws(),c=u.firstChild,f=c.nextSibling,d=f.firstChild,v=d.firstChild,p=f.nextSibling;return c.addEventListener("drop",r),c.addEventListener("dragleave",()=>n(!1)),c.addEventListener("dragover",g=>{g.preventDefault(),n(!0)}),v.addEventListener("change",s),a(f,h(O,{get when(){return t.filePath},get children(){var g=_s(),y=g.firstChild,w=y.nextSibling,b=w.nextSibling;return a(w,()=>t.filePath),b.$$click=()=>t.onFileSelect(""),g}}),null),a(u,h(O,{get when(){return i()},get children(){var g=xs();return a(g,i),g}}),p),N(()=>he(c,`file-drop-zone ${e()?"active":""}`)),u})()}function $r(t){const[e,n]=K(null),i=s=>{t.onNameChange(s),s.trim().length===0?n("数据源名称不能为空"):s.trim().length<2?n("数据源名称至少需要2个字符"):s.trim().length>50?n("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(s.trim())?n(null):n("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},l=s=>{const r=parseInt(s);!isNaN(r)&&r>=10&&r<=3600&&t.onConfigUpdate({refresh_interval:r})};return(()=>{var s=As(),r=s.firstChild,o=r.nextSibling,u=o.firstChild,c=u.firstChild,f=c.nextSibling,d=f.firstChild,v=d.nextSibling,p=v.nextSibling,g=u.nextSibling,y=g.firstChild,w=y.nextSibling,b=w.firstChild,$=b.firstChild,S=$.nextSibling;return v.$$input=D=>i(D.currentTarget.value),a(f,h(O,{get when(){return e()},get children(){var D=Ss();return a(D,e),D}}),p),a(o,h(O,{get when(){return t.config.source_type==="file"},get children(){var D=ks(),z=D.firstChild,T=z.nextSibling,_=T.firstChild,k=_.firstChild;return k.addEventListener("change",H=>t.onConfigUpdate({auto_refresh:H.currentTarget.checked})),a(D,h(O,{get when(){return t.config.auto_refresh},get children(){var H=Cs(),F=H.firstChild,j=F.nextSibling,P=j.firstChild,W=P.nextSibling;return P.$$input=V=>l(V.currentTarget.value),W.addEventListener("change",V=>l(V.currentTarget.value)),N(()=>P.value=t.config.refresh_interval),N(()=>W.value=t.config.refresh_interval),H}}),null),N(()=>k.checked=t.config.auto_refresh),D}}),g),a(S,()=>t.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),a(w,h(O,{get when(){return t.config.source_type==="file"},get children(){return[(()=>{var D=Es(),z=D.firstChild,T=z.nextSibling;return a(T,()=>t.config.file_path||"(未选择文件)"),D})(),(()=>{var D=Ts(),z=D.firstChild,T=z.nextSibling;return a(T,()=>t.config.auto_refresh?`✅ 每 ${t.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),D})()]}}),null),a(w,h(O,{get when(){return t.config.source_type==="content"},get children(){var D=Ds(),z=D.firstChild,T=z.nextSibling,_=T.firstChild;return a(T,()=>{var k;return((k=t.config.json_content)==null?void 0:k.length)||0},_),D}}),null),N(()=>he(v,`name-input ${e()?"error":""}`)),N(()=>v.value=t.name),s})()}function _r(t){const[e,n]=K(null),[i,l]=K(!1),s=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],r=u=>{if(t.onContentChange(u),u.trim())try{JSON.parse(u),n(null)}catch(c){n(c instanceof Error?c.message:"无效的JSON格式")}else n(null)},o=u=>{t.onContentChange(u.content),n(null),l(!1)};return(()=>{var u=Rs(),c=u.firstChild,f=c.firstChild,d=f.nextSibling,v=d.nextSibling,p=c.nextSibling,g=p.firstChild,y=p.nextSibling;return f.$$click=()=>l(!i()),d.$$click=()=>t.onContentChange(""),a(v,h(O,{get when(){return ce(()=>!e())()&&t.content.trim()},get children(){return Ps()}}),null),a(v,h(O,{get when(){return e()},get children(){return zs()}}),null),a(u,h(O,{get when(){return i()},get children(){var w=Ls(),b=w.firstChild,$=b.nextSibling;return a($,h(ge,{each:s,children:S=>(()=>{var D=Os(),z=D.firstChild,T=z.nextSibling;return D.$$click=()=>o(S),a(z,()=>S.name),a(T,()=>S.description),D})()})),w}}),p),g.$$input=w=>r(w.currentTarget.value),a(u,h(O,{get when(){return e()},get children(){var w=Ms(),b=w.firstChild,$=b.nextSibling;return a($,e),w}}),y),N(w=>{var b=!t.content,$=`json-textarea ${e()?"error":""}`;return b!==w.e&&(d.disabled=w.e=b),$!==w.t&&he(g,w.t=$),w},{e:void 0,t:void 0}),N(()=>g.value=t.content),u})()}function xr(t){const[e,n]=K(!1),i=()=>t.loading?"🔄":t.testResult?t.testResult.success?"✅":"❌":"⚡",l=()=>t.loading?"测试连接中...":t.testResult?t.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",s=()=>t.loading?"testing":t.testResult?t.testResult.success?"success":"error":"ready",r=o=>typeof o=="object"?JSON.stringify(o,null,2):String(o);return(()=>{var o=Zs(),u=o.firstChild,c=u.nextSibling,f=c.firstChild,d=f.firstChild,v=d.firstChild,p=v.firstChild,g=p.nextSibling,y=v.nextSibling,w=f.nextSibling,b=w.firstChild,$=b.nextSibling;return a(p,i),a(g,l),Ee(y,"click",t.onTest),a(y,(()=>{var S=ce(()=>!!t.loading);return()=>S()?[er(),"测试中..."]:[tr(),"测试连接"]})()),a(f,h(O,{get when(){return t.testResult},get children(){var S=Us(),D=S.firstChild,z=D.firstChild,T=z.nextSibling;return a(z,i),a(T,()=>t.testResult.message),a(S,h(O,{get when(){return t.testResult.error},get children(){var _=Ns(),k=_.firstChild,H=k.nextSibling;return a(H,()=>t.testResult.error),_}}),null),N(()=>he(S,`test-result ${s()}`)),S}}),null),a(c,h(O,{get when(){var S;return((S=t.testResult)==null?void 0:S.success)&&t.testResult.preview},get children(){var S=js(),D=S.firstChild,z=D.firstChild,T=z.nextSibling,_=T.firstChild,k=_.firstChild,H=k.nextSibling,F=_.nextSibling,j=F.firstChild,P=j.nextSibling,W=D.nextSibling,V=W.firstChild,x=V.nextSibling,L=W.nextSibling,A=L.firstChild,U=A.nextSibling,q=U.firstChild,Z=q.firstChild,ue=Z.firstChild,oe=Z.nextSibling,I=L.nextSibling,le=I.firstChild,Y=le.firstChild;return a(H,()=>t.testResult.preview.record_count),a(P,()=>t.testResult.preview.fields.length),a(x,h(ge,{get each(){return t.testResult.preview.fields},children:te=>(()=>{var G=nr(),ee=G.firstChild;return a(ee,te),G})()})),a(ue,h(ge,{get each(){return t.testResult.preview.fields},children:te=>(()=>{var G=ir();return a(G,te),G})()})),a(oe,h(ge,{get each(){return t.testResult.preview.sample_data},children:te=>(()=>{var G=lr();return a(G,h(ge,{get each(){return t.testResult.preview.fields},children:ee=>(()=>{var se=sr(),me=se.firstChild;return a(me,(()=>{var de=ce(()=>te[ee]!==void 0);return()=>de()?r(te[ee]):"-"})()),se})()})),G})()})),le.$$click=()=>n(!e()),a(Y,()=>e()?"▼":"▶"),a(I,h(O,{get when(){return e()},get children(){var te=Bs(),G=te.firstChild,ee=G.firstChild,se=ee.firstChild,me=se.nextSibling,de=ee.nextSibling;return a(me,()=>t.config.source_type==="file"?"JSON文件":"JSON内容"),a(G,h(O,{get when(){return t.config.source_type==="file"},get children(){return[(()=>{var Q=Fs(),ye=Q.firstChild,$e=ye.nextSibling;return a($e,()=>t.config.file_path),Q})(),(()=>{var Q=Is(),ye=Q.firstChild,$e=ye.nextSibling;return a($e,()=>t.config.auto_refresh?"已启用":"已禁用"),Q})()]}}),de),te}}),null),S}}),w),a($,h(O,{get when(){return!t.testResult},get children(){return[Hs(),qs(),Js()]}}),null),a($,h(O,{get when(){var S;return(S=t.testResult)==null?void 0:S.success},get children(){return[Vs(),Ws(),Ks()]}}),null),a($,h(O,{get when(){return t.testResult&&!t.testResult.success},get children(){return[Gs(),Xs(),Ys()]}}),null),a(c,h(O,{get when(){return t.config.source_type==="file"},get children(){return Qs()}}),null),N(S=>{var D=`test-button ${s()}`,z=t.loading;return D!==S.e&&he(y,S.e=D),z!==S.t&&(y.disabled=S.t=z),S},{e:void 0,t:void 0}),o})()}function wr(t){const e=s=>{switch(s){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${s}`}},n=()=>t.currentStep>1,i=()=>t.currentStep<4&&t.canProceed,l=()=>t.currentStep===4&&t.canProceed;return(()=>{var s=ur(),r=s.firstChild,o=r.firstChild,u=o.firstChild,c=u.nextSibling;c.nextSibling;var f=r.nextSibling,d=f.firstChild,v=f.nextSibling;return a(o,()=>t.currentStep,c),a(o,()=>e(t.currentStep),null),a(r,h(O,{get when(){return!t.canProceed&&t.currentStep<4},get children(){return rr()}}),null),Ee(d,"click",t.onPrevious),a(f,h(O,{get when(){return t.currentStep<4},get children(){var p=ar();return Ee(p,"click",t.onNext),N(()=>p.disabled=!i()||t.loading),p}}),null),a(f,h(O,{get when(){return t.currentStep===4},get children(){var p=or();return Ee(p,"click",t.onFinish),a(p,(()=>{var g=ce(()=>!!t.loading);return()=>g()?[hr(),gr()]:[fr(),vr()]})()),N(()=>p.disabled=!l()||t.loading),p}}),null),a(v,h(O,{get when(){return t.currentStep===1},get children(){return cr()}}),null),a(v,h(O,{get when(){return t.currentStep===2},get children(){var p=Wt();return a(p,()=>{var g;return(g=t.testResult)!=null&&g.success?"数据格式验证成功":"请提供JSON数据内容"}),p}}),null),a(v,h(O,{get when(){return t.currentStep===3},get children(){return dr()}}),null),a(v,h(O,{get when(){return t.currentStep===4},get children(){var p=Wt();return a(p,()=>{var g;return(g=t.testResult)!=null&&g.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"}),p}}),null),N(()=>d.disabled=!n()||t.loading),s})()}Le(["click","input"]);var Sr=m("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),Cr=m("<div class=error-message>"),kr=m("<div class=loading-message>加载中..."),Er=m("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),Tr=m("<div class=sources-grid>"),Dr=m("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),Ar=m('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),Pr=m("<span class=changes-indicator>● 有未保存的更改"),zr=m("<div class=error-details>"),Lr=m("<div><div class=result-message> "),Mr=m("<div class=error-message>❌ "),Rr=m("<button type=button class=reset-btn>重置更改"),Or=m('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),Nr=m("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),Ur=m("<th>"),Fr=m("<tr>"),Ir=m("<td>");function Br(t){const[e,n]=K([]),[i,l]=K([]),[s,r]=K("list"),[o,u]=K(null),[c,f]=K(null),[d,v]=K(!1),[p,g]=K(null);Je(async()=>{try{await y(),await w()}catch(T){console.error("🚨 DataSourcesPanel初始化失败:",T),g(`数据源模块初始化失败: ${T}`)}});const y=async()=>{try{v(!0),console.log("🔄 开始加载数据源列表...");const T=await xe.listDataSources();console.log("✅ 数据源列表加载成功:",T),n(T),g(null)}catch(T){console.error("❌ 加载数据源失败:",T),g(`加载数据源失败: ${T}`)}finally{v(!1)}},w=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const T=await xe.getAvailableTypes();console.log("✅ 数据源类型加载成功:",T),l(T)}catch(T){console.error("❌ 加载数据源类型失败:",T)}},b=()=>{r("add"),u(null)},$=T=>{u(T),r("edit")},S=async T=>{try{v(!0),g(null),u(T),console.log("🔄 开始预览数据源:",T.name),T.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",T.status),g(`数据源状态为 ${T.status}，可能无法预览数据`));const _=await xe.getPreview(T.id);f(_),r("preview"),console.log("✅ 数据预览加载成功:",_)}catch(_){console.error("❌ 数据预览失败:",_);const k=`预览数据源 "${T.name}" 失败: ${_}`;g(k);const H={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},F=String(_).toLowerCase(),j=Object.keys(H).find(P=>F.includes(P));j&&g(`预览失败: ${H[j]}`)}finally{v(!1)}},D=async T=>{if(confirm("确定要删除这个数据源吗？"))try{await xe.deleteDataSource(T),await y()}catch(_){g(`删除数据源失败: ${_}`)}},z=async T=>{try{v(!0),g(null),console.log("🔄 开始测试数据源连接:",T);const _=e().find(F=>F.id===T);if(!_){const F=`数据源不存在: ${T}`;console.error("❌",F),g(F);return}console.log("📋 数据源信息:",{id:_.id,name:_.name,type_name:_.type_name,provider_type:_.provider_type,config:_.config});let k=_.provider_type||_.type_name;(_.name.includes("MySQL")||_.name.includes("数据库")||JSON.stringify(_.config).includes("mysql")||JSON.stringify(_.config).includes("3306"))&&(k="database",console.log("🗄️ 检测到数据库类型，使用provider_type: database")),console.log("🔍 调用测试连接API:",{providerType:k,config:_.config});const H=await xe.testConnection(k,_.config||{});console.log("📨 API返回结果:",H),H?(console.log("✅ 数据源连接测试成功:",T),alert(`✅ 数据源 "${_.name}" 连接测试成功！

🎉 数据库连接正常，可以正常使用`)):(console.log("❌ 数据源连接测试失败:",T),alert(`❌ 数据源 "${_.name}" 连接测试失败

请检查配置信息是否正确`))}catch(_){console.error("❌ 测试连接时发生错误:",_),console.error("❌ 错误详情:",{error:_,errorType:typeof _,errorString:String(_),errorJSON:JSON.stringify(_,null,2)});const k=e().find(F=>F.id===T),H=`测试连接失败: ${_}`;g(H),!_||String(_)===""||String(_)==="null"?alert(`❌ 数据源 "${(k==null?void 0:k.name)||T}" 连接测试遇到未知错误

请检查：
• 开发者工具控制台的详细错误信息
• 后端服务是否正常运行
• 配置参数是否正确`):alert(`❌ 数据源 "${(k==null?void 0:k.name)||T}" 连接测试失败:

${_}

💡 如果是空错误，请检查开发者工具控制台获取详细信息`)}finally{v(!1)}};return h(O,{get when(){return t.isOpen},get children(){var T=Sr(),_=T.firstChild,k=_.nextSibling,H=k.firstChild,F=H.nextSibling,j=F.nextSibling,P=k.nextSibling;return Ee(j,"click",t.onClose),a(P,h(O,{get when(){return s()==="list"},get children(){return h(jr,{get dataSources(){return e()},get loading(){return d()},get error(){return p()},onAdd:b,onEdit:$,onPreview:S,onDelete:D,onTestConnection:z,onRefresh:y})}}),null),a(P,h(O,{get when(){return s()==="add"},get children(){return h(xn,{get availableTypes(){return i()},onBack:()=>r("list"),onSuccess:y})}}),null),a(P,h(O,{get when(){return ce(()=>s()==="edit")()&&o()},get children(){return h(Hr,{get dataSource(){return o()},onBack:()=>r("list"),onSuccess:y})}}),null),a(P,h(O,{get when(){return ce(()=>!!(s()==="preview"&&o()))()&&c()},get children(){return h(qr,{get dataSource(){return o()},get data(){return c()},onBack:()=>r("list")})}}),null),T}})}function jr(t){const e=i=>{switch(i){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=i=>new Date(i).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var i=Dr(),l=i.firstChild,s=l.firstChild,r=s.firstChild,o=r.firstChild,u=o.nextSibling;u.nextSibling;var c=r.nextSibling,f=s.nextSibling;return a(r,()=>t.dataSources.length,u),Ee(c,"click",t.onRefresh),Ee(f,"click",t.onAdd),a(i,h(O,{get when(){return t.error},get children(){var d=Cr();return a(d,()=>t.error),d}}),null),a(i,h(O,{get when(){return t.loading},get children(){return kr()}}),null),a(i,h(O,{get when(){return!t.loading&&t.dataSources.length===0},get children(){var d=Er(),v=d.firstChild,p=v.nextSibling;return Ee(p,"click",t.onAdd),d}}),null),a(i,h(O,{get when(){return!t.loading&&t.dataSources.length>0},get children(){var d=Tr();return a(d,h(ge,{get each(){return t.dataSources},children:v=>(()=>{var p=Ar(),g=p.firstChild,y=g.firstChild,w=y.firstChild,b=w.nextSibling,$=y.nextSibling,S=g.nextSibling,D=S.firstChild,z=D.firstChild,T=z.nextSibling,_=D.nextSibling,k=_.firstChild,H=k.nextSibling,F=S.nextSibling,j=F.firstChild,P=j.nextSibling,W=P.nextSibling,V=W.nextSibling;return a(w,()=>v.name),a(b,()=>v.provider_type),a(T,()=>n(v.created_at)),a(H,()=>n(v.last_updated)),j.$$click=()=>t.onPreview(v),P.$$click=()=>t.onTestConnection(v.id),W.$$click=()=>t.onEdit(v),V.$$click=()=>t.onDelete(v.id),N(x=>{var L=e(v.status),A=`状态: ${v.status}`,U=v.status!=="active";return L!==x.e&&((x.e=L)!=null?$.style.setProperty("background-color",L):$.style.removeProperty("background-color")),A!==x.t&&M($,"title",x.t=A),U!==x.a&&(j.disabled=x.a=U),x},{e:void 0,t:void 0,a:void 0}),p})()})),d}}),null),N(d=>{var v=t.loading,p=t.loading?"正在刷新数据源列表":"刷新数据源列表",g=t.loading?"正在刷新...":"刷新数据源列表";return v!==d.e&&(c.disabled=d.e=v),p!==d.t&&M(c,"aria-label",d.t=p),g!==d.a&&M(c,"title",d.a=g),d},{e:void 0,t:void 0,a:void 0}),i})()}function Hr(t){const[e,n]=K({name:t.dataSource.name,config:t.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[i]=K(JSON.stringify(t.dataSource.config||{})),l=()=>{const f=e(),d=f.name!==t.dataSource.name,v=JSON.stringify(f.config)!==i();n(p=>({...p,hasChanges:d||v}))},s=f=>{n(d=>({...d,name:f})),l()},r=f=>{n(d=>({...d,config:f})),l()},o=async()=>{const f=e();n(d=>({...d,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await xe.testConnection(t.dataSource.type_name,f.config)&&(console.log("✅ 连接测试成功"),n(v=>({...v,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(d){console.error("❌ 连接测试失败:",d),n(v=>({...v,testResult:{success:!1,message:"连接测试失败",error:d instanceof Error?d.message:String(d)},loading:!1}))}},u=async()=>{const f=e();if(!f.hasChanges){t.onBack();return}if(!f.name.trim()){n(d=>({...d,error:"数据源名称不能为空"}));return}try{n(d=>({...d,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await xe.updateConfig(t.dataSource.id,f.config),f.name!==t.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),n(d=>({...d,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),t.onSuccess(),t.onBack()}catch(d){console.error("❌ 更新数据源失败:",d),n(v=>({...v,error:`更新失败: ${d}`,loading:!1}))}},c=()=>{n(f=>({...f,name:t.dataSource.name,config:t.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var f=Or(),d=f.firstChild,v=d.firstChild,p=v.nextSibling,g=p.firstChild,y=g.nextSibling,w=y.firstChild,b=w.nextSibling;b.firstChild;var $=d.nextSibling,S=$.firstChild,D=S.firstChild,z=D.nextSibling,T=z.firstChild,_=T.nextSibling,k=S.nextSibling,H=k.firstChild;H.firstChild;var F=H.nextSibling,j=F.firstChild,P=j.nextSibling,W=k.nextSibling,V=W.firstChild,x=V.firstChild,L=x.nextSibling,A=W.nextSibling,U=A.firstChild,q=U.nextSibling,Z=q.firstChild,ue=Z.firstChild,oe=ue.nextSibling,I=Z.nextSibling,le=I.firstChild,Y=le.nextSibling,te=I.nextSibling,G=te.firstChild,ee=G.nextSibling,se=A.nextSibling,me=se.firstChild,de=me.nextSibling;return Ee(v,"click",t.onBack),a(w,()=>t.dataSource.type_name),a(b,()=>t.dataSource.id,null),_.$$input=Q=>s(Q.currentTarget.value),a(H,h(O,{get when(){return e().hasChanges},get children(){return Pr()}}),null),P.$$input=Q=>{try{const ye=JSON.parse(Q.currentTarget.value);r(ye),n($e=>({...$e,error:null}))}catch{n($e=>({...$e,error:"配置格式错误，请检查JSON语法"}))}},L.$$click=o,a(L,()=>e().loading?"测试中...":"测试连接"),a(W,h(O,{get when(){return e().testResult},get children(){var Q=Lr(),ye=Q.firstChild,$e=ye.firstChild;return a(ye,()=>{var fe;return(fe=e().testResult)!=null&&fe.success?"✅":"❌"},$e),a(ye,()=>{var fe;return(fe=e().testResult)==null?void 0:fe.message},null),a(Q,h(O,{get when(){var fe;return(fe=e().testResult)==null?void 0:fe.error},get children(){var fe=zr();return a(fe,()=>{var Pe;return(Pe=e().testResult)==null?void 0:Pe.error}),fe}}),null),N(()=>{var fe;return he(Q,`test-result ${(fe=e().testResult)!=null&&fe.success?"success":"error"}`)}),Q}}),null),a(oe,()=>t.dataSource.status==="active"?"✅ 活跃":t.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),a(Y,()=>new Date(t.dataSource.created_at).toLocaleString("zh-CN")),a(ee,()=>new Date(t.dataSource.last_updated).toLocaleString("zh-CN")),a($,h(O,{get when(){return e().error},get children(){var Q=Mr();return Q.firstChild,a(Q,()=>e().error,null),Q}}),se),Ee(me,"click",t.onBack),a(se,h(O,{get when(){return e().hasChanges},get children(){var Q=Rr();return Q.$$click=c,N(()=>Q.disabled=e().loading),Q}}),de),de.$$click=u,a(de,(()=>{var Q=ce(()=>!!e().loading);return()=>Q()?"保存中...":e().hasChanges?"保存更改":"无更改"})()),N(Q=>{var De;var ye=e().error&&!e().name.trim()?"error":"",$e=e().error&&((De=e().error)!=null&&De.includes("配置格式"))?"error":"",fe=e().loading,Pe=`status-value status-${t.dataSource.status}`,pe=`save-btn ${e().hasChanges?"has-changes":""}`,Te=e().loading;return ye!==Q.e&&he(_,Q.e=ye),$e!==Q.t&&he(P,Q.t=$e),fe!==Q.a&&(L.disabled=Q.a=fe),Pe!==Q.o&&he(oe,Q.o=Pe),pe!==Q.i&&he(de,Q.i=pe),Te!==Q.n&&(de.disabled=Q.n=Te),Q},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),N(()=>_.value=e().name),N(()=>P.value=JSON.stringify(e().config,null,2)),f})()}function qr(t){return(()=>{var e=Nr(),n=e.firstChild,i=n.firstChild,l=i.nextSibling;l.firstChild;var s=l.nextSibling,r=s.firstChild,o=r.nextSibling,u=o.nextSibling,c=u.nextSibling;c.nextSibling;var f=n.nextSibling,d=f.firstChild,v=d.firstChild,p=v.firstChild,g=v.nextSibling;return Ee(i,"click",t.onBack),a(l,()=>t.dataSource.name,null),a(s,()=>t.data.total_rows,o),a(s,()=>t.data.rows.length,c),a(p,h(ge,{get each(){return t.data.columns},children:y=>(()=>{var w=Ur();return a(w,y),w})()})),a(g,h(ge,{get each(){return t.data.rows.slice(0,50)},children:y=>(()=>{var w=Fr();return a(w,h(ge,{get each(){return t.data.columns},children:b=>(()=>{var $=Ir();return a($,(()=>{var S=ce(()=>typeof y[b]=="object");return()=>S()?JSON.stringify(y[b]):String(y[b]||"")})()),$})()})),w})()})),e})()}Le(["click","input"]);var Jr=m("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Vr=m("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Wr=m("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),Kr=m("<div class=current-record>"),Gr=m("<div class=empty-record>暂无记录数据"),Xr=m("<div class=available-fields>"),Yr=m("<div class=no-fields>暂无可用字段"),Qr=m('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),Zr=m("<div class=record-field><div class=field-key>:</div><div class=field-value>"),ea=m("<div class=field-display-name>"),ta=m("<div class=field-sample>示例: "),na=m("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),ia=m("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),la=m('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const sa=()=>{const[t,e]=K(null),[n,i]=K(!1);Mt(()=>{const c=Qe.subscribe(f=>{e(f)});return e(Qe.getCurrentContext()),c});const l=be(()=>{const c=t();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),s=async()=>{i(!0);try{await Qe.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{i(!1)}},r=async()=>{i(!0);try{await Qe.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{i(!1)}},o=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),u=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Wr(),f=c.firstChild,d=f.firstChild,v=d.nextSibling,p=v.firstChild,g=p.nextSibling;return a(p,()=>l().icon),a(g,()=>l().text),a(c,h(O,{get when(){return t()},children:y=>(()=>{var w=Qr(),b=w.firstChild,$=b.firstChild,S=$.nextSibling,D=S.firstChild,z=D.firstChild,T=z.nextSibling,_=D.nextSibling,k=_.firstChild,H=k.nextSibling,F=_.nextSibling,j=F.firstChild,P=j.nextSibling,W=b.nextSibling,V=W.firstChild,x=V.nextSibling,L=x.firstChild,A=L.nextSibling,U=A.firstChild,q=A.nextSibling,Z=W.nextSibling;Z.firstChild;var ue=Z.nextSibling,oe=ue.firstChild,I=oe.firstChild,le=I.nextSibling,Y=le.firstChild,te=Y.nextSibling;return te.nextSibling,a(T,()=>y().dataSource.name),a(H,()=>y().dataSource.type.toUpperCase()),a(P,()=>y().dataSource.id),L.$$click=r,a(A,()=>y().currentRecord.index+1,U),a(A,()=>y().currentRecord.total,null),q.$$click=s,a(Z,h(O,{get when(){return Object.keys(y().currentRecord.data).length>0},get children(){var G=Kr();return a(G,h(ge,{get each(){return Object.entries(y().currentRecord.data)},children:([ee,se])=>(()=>{var me=Zr(),de=me.firstChild,Q=de.firstChild,ye=de.nextSibling;return a(de,ee,Q),a(ye,()=>o(se)),me})()})),G}}),null),a(Z,h(O,{get when(){return Object.keys(y().currentRecord.data).length===0},get children(){return Gr()}}),null),a(le,()=>y().fields.length,te),a(ue,h(O,{get when(){return y().fields.length>0},get children(){var G=Xr();return a(G,h(ge,{get each(){return y().fields},children:ee=>(()=>{var se=na(),me=se.firstChild,de=me.firstChild,Q=de.nextSibling,ye=Q.firstChild,$e=ye.nextSibling;$e.nextSibling;var fe=me.nextSibling,Pe=fe.firstChild,pe=Pe.nextSibling;return a(de,()=>ee.name),a(Q,()=>u(ee.type),$e),a(se,h(O,{get when(){return ee.displayName&&ee.displayName!==ee.name},get children(){var Te=ea();return a(Te,()=>ee.displayName),Te}}),fe),a(se,h(O,{get when(){return ee.sample!==void 0},get children(){var Te=ta();return Te.firstChild,a(Te,()=>o(ee.sample),null),Te}}),fe),a(pe,()=>`{${ee.name}}`),se})()})),G}}),null),a(ue,h(O,{get when(){return y().fields.length===0},get children(){return Yr()}}),null),a(w,h(O,{get when(){return y().error},children:G=>(()=>{var ee=la(),se=ee.firstChild,me=se.nextSibling,de=me.firstChild;de.firstChild;var Q=de.nextSibling;return Q.firstChild,a(de,()=>G().type,null),a(Q,()=>G().message,null),a(me,h(O,{get when(){return G().details},get children(){var ye=ia(),$e=ye.firstChild,fe=$e.nextSibling;return a(fe,()=>JSON.stringify(G().details,null,2)),ye}}),null),ee})()}),null),N(G=>{var ee=n()||y().currentRecord.index<=0,se=n()||y().currentRecord.index>=y().currentRecord.total-1;return ee!==G.e&&(L.disabled=G.e=ee),se!==G.t&&(q.disabled=G.t=se),G},{e:void 0,t:void 0}),w})()}),null),a(c,h(O,{get when(){return!t()},get children(){return Jr()}}),null),a(c,h(O,{get when(){return n()},get children(){return Vr()}}),null),N(y=>(y=l().color)!=null?g.style.setProperty("color",y):g.style.removeProperty("color")),c})()};Le(["click"]);var ra=m("<div class=error-messages>"),aa=m("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>处理中..."),oa=m('<div class=form-row><div class="form-group flex-2"><label>主机地址</label><input type=text placeholder=localhost></div><div class="form-group flex-1"><label>端口</label><input type=number>'),ca=m("<div class=form-group><label>数据库文件路径</label><input type=text placeholder=/path/to/database.db>"),da=m("<div class=form-group><label>数据库名</label><input type=text placeholder=myapp_production>"),ua=m("<div class=form-row><div class=form-group><label>用户名</label><input type=text></div><div class=form-group><label>密码</label><input type=password>"),ha=m("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),ga=m("<div class=connection-step><div class=step-header><h4>🔌 数据库连接配置</h4><p>请填写数据库连接信息</p></div><div class=form-section><div class=form-group><label>数据库类型</label><select><option value=mysql>MySQL</option><option value=postgresql>PostgreSQL</option><option value=sqlite>SQLite</option><option value=sqlserver>SQL Server</option><option value=oracle>Oracle</option></select></div><div class=connection-test><button class=test-connection-btn>"),fa=m("<div class=schema-loading><button class=load-schema-btn>🔄 加载表结构</button><p class=loading-hint>点击按钮加载数据库的表结构信息"),va=m("<div class=views-section><h5>👁️ 数据视图列表</h5><div class=views-list>"),ma=m("<div class=schema-content><div class=schema-summary><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>表数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>视图数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>加载时间:</span><span class=summary-value></span></div></div><div class=tables-section><h5>📋 数据表列表</h5><div class=tables-grid>"),ya=m("<div class=schema-step><div class=step-header><h4>🗂️ 数据库表结构</h4><p>选择要查询的数据表和字段"),pa=m("<div class=query-step><div class=step-header><h4>🔍 SQL查询构建</h4><p>编写或生成SQL查询语句</p></div><p>查询构建功能正在开发中..."),ba=m("<div class=preview-step><div class=step-header><h4>👁️ 预览和保存</h4><p>测试查询并保存数据源</p></div><div class=form-group><label>数据源名称</label><input type=text placeholder=输入数据源名称...></div><p>预览和保存功能正在开发中..."),$a=m('<div class=database-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>🗄️ 创建数据库数据源</h3><p>连接数据库并配置查询语句</p></div></div><div class=wizard-progress><div><div class=step-indicator>1</div><div class=step-info><div class=step-title>数据库连接</div><div class=step-description>配置连接信息</div></div></div><div><div class=step-indicator>2</div><div class=step-info><div class=step-title>表结构</div><div class=step-description>选择数据表</div></div></div><div><div class=step-indicator>3</div><div class=step-info><div class=step-title>查询构建</div><div class=step-description>编写SQL查询</div></div></div><div><div class=step-indicator>4</div><div class=step-info><div class=step-title>预览保存</div><div class=step-description>测试并保存</div></div></div></div><div class=wizard-content></div><div class=wizard-controls><div class=control-buttons><button class="control-btn back-btn">← 上一步</button><button class="control-btn next-btn">下一步 →'),_a=m("<div class=error-message>❌ "),xa=m("<span class=view-comment>"),wa=m("<div class=view-item><div class=view-info><span class=view-name></span><span class=view-schema>"),Sa=m("<div class=table-comment>"),Ca=m("<div class=more-columns>+<!> 个字段..."),ka=m("<span class=more-indexes>+"),Ea=m("<div class=table-indexes><h6>索引 (<!>)</h6><div class=indexes-list>"),Ta=m("<span class=more-relations>+"),Da=m("<div class=table-relations><h6>关联 (<!>)</h6><div class=relations-list>"),Aa=m("<div><div class=table-card-header><div class=table-card-title><label class=table-checkbox><input type=checkbox><span class=table-name>📋 </span></label></div><div class=table-card-stats><span class=row-count title=预估行数> 行</span><span class=table-size title=预估大小></span></div></div><div class=table-columns><h6>字段 (<!>)</h6><div class=columns-preview>"),Pa=m("<span class=pk-badge title=主键>🔑"),za=m("<span class=fk-badge title=外键>🔗"),La=m("<div class=column-item><span class=column-icon></span><span class=column-name></span><span class=column-type>"),Ma=m("<span> "),Ra=m("<span class=relation-badge>🔗 ");const Oa={database_type:"mysql",host:"localhost",port:3306,database:"",username:"",password:"",ssl_enabled:!1,max_connections:10,min_connections:1,connection_timeout:30,idle_timeout:600,sql:"",use_custom_sql:!1,query_timeout:60,default_limit:1e3,enable_caching:!0,cache_ttl:300};function Na(t){const[e,n]=K({currentStep:"connection",name:"",config:{...Oa},schema:null,selectedTables:[],generatedSQL:"",customSQL:"",useCustomSQL:!1,testResult:null,queryResult:null,validation:null,loading:!1,errors:[]}),i=be(()=>{var d;const f=e();return{connection:((d=f.testResult)==null?void 0:d.success)||!1,schema:f.schema!==null&&f.selectedTables.length>0,query:f.generatedSQL.length>0||f.customSQL.length>0,preview:f.queryResult!==null}}),l=f=>{n(d=>({...d,...f}))},s=f=>{n(d=>({...d,config:{...d.config,...f}}))},r=async()=>{l({loading:!0,errors:[]});try{const f=await xe.testDatabaseConnection(e().config);l({testResult:f,loading:!1,errors:f.success?[]:[f.message]}),f.success&&setTimeout(()=>{l({currentStep:"schema"}),o()},1e3)}catch(f){l({loading:!1,errors:[`连接测试失败: ${f}`],testResult:null})}},o=async()=>{l({loading:!0,errors:[]});try{const f=await xe.loadDatabaseSchema(e().config);l({schema:f,loading:!1,errors:[]})}catch(f){l({loading:!1,errors:[`架构加载失败: ${f}`],schema:null})}},u=f=>{l({currentStep:f})},c=()=>{switch(e().currentStep){case"schema":l({currentStep:"connection"});break;case"query":l({currentStep:"schema"});break;case"preview":l({currentStep:"query"});break;default:t.onBack()}};return(()=>{var f=$a(),d=f.firstChild,v=d.firstChild,p=d.nextSibling,g=p.firstChild,y=g.nextSibling,w=y.nextSibling,b=w.nextSibling,$=p.nextSibling,S=$.nextSibling,D=S.firstChild,z=D.firstChild,T=z.nextSibling;return v.$$click=c,g.$$click=()=>u("connection"),y.$$click=()=>i().connection&&u("schema"),w.$$click=()=>i().schema&&u("query"),b.$$click=()=>i().query&&u("preview"),a($,h(O,{get when(){return e().errors.length>0},get children(){var _=ra();return a(_,h(ge,{get each(){return e().errors},children:k=>(()=>{var H=_a();return H.firstChild,a(H,k,null),H})()})),_}}),null),a($,h(O,{get when(){return e().loading},get children(){return aa()}}),null),a($,h(O,{get when(){return e().currentStep==="connection"},get children(){var _=ga(),k=_.firstChild,H=k.nextSibling,F=H.firstChild,j=F.firstChild,P=j.nextSibling,W=F.nextSibling,V=W.firstChild;return P.addEventListener("change",x=>{const L=x.currentTarget.value,A={mysql:3306,postgresql:5432,sqlserver:1433,oracle:1521,sqlite:0}[L];s({database_type:L,port:A})}),a(H,h(O,{get when(){return e().config.database_type!=="sqlite"},get children(){var x=oa(),L=x.firstChild,A=L.firstChild,U=A.nextSibling,q=L.nextSibling,Z=q.firstChild,ue=Z.nextSibling;return U.addEventListener("change",oe=>s({host:oe.currentTarget.value})),ue.addEventListener("change",oe=>s({port:parseInt(oe.currentTarget.value)||3306})),N(()=>U.value=e().config.host),N(()=>ue.value=e().config.port),x}}),W),a(H,h(O,{get when(){return e().config.database_type==="sqlite"},get children(){var x=ca(),L=x.firstChild,A=L.nextSibling;return A.addEventListener("change",U=>s({database:U.currentTarget.value})),N(()=>A.value=e().config.database),x}}),W),a(H,h(O,{get when(){return e().config.database_type!=="sqlite"},get children(){return[(()=>{var x=da(),L=x.firstChild,A=L.nextSibling;return A.addEventListener("change",U=>s({database:U.currentTarget.value})),N(()=>A.value=e().config.database),x})(),(()=>{var x=ua(),L=x.firstChild,A=L.firstChild,U=A.nextSibling,q=L.nextSibling,Z=q.firstChild,ue=Z.nextSibling;return U.addEventListener("change",oe=>s({username:oe.currentTarget.value})),ue.addEventListener("change",oe=>s({password:oe.currentTarget.value})),N(()=>U.value=e().config.username),N(()=>ue.value=e().config.password),x})()]}}),W),V.$$click=r,a(V,()=>e().loading?"⏳ 测试中...":"🔗 测试连接"),a(W,h(O,{get when(){return e().testResult},get children(){var x=ha(),L=x.firstChild,A=L.firstChild,U=A.nextSibling;return a(A,()=>{var q;return(q=e().testResult)!=null&&q.success?"✅":"❌"}),a(U,()=>{var q;return(q=e().testResult)==null?void 0:q.message}),N(()=>{var q;return he(x,`test-result ${(q=e().testResult)!=null&&q.success?"success":"error"}`)}),x}}),null),N(()=>V.disabled=e().loading),N(()=>P.value=e().config.database_type),_}}),null),a($,h(O,{get when(){return e().currentStep==="schema"},get children(){var _=ya();return _.firstChild,a(_,h(O,{get when(){return ce(()=>!e().schema)()&&!e().loading},get children(){var k=fa(),H=k.firstChild;return H.$$click=o,k}}),null),a(_,h(O,{get when(){return e().schema},get children(){var k=ma(),H=k.firstChild,F=H.firstChild,j=F.firstChild,P=j.nextSibling,W=F.nextSibling,V=W.firstChild,x=V.nextSibling,L=W.nextSibling,A=L.firstChild,U=A.nextSibling,q=L.nextSibling,Z=q.firstChild,ue=Z.nextSibling,oe=H.nextSibling,I=oe.firstChild,le=I.nextSibling;return a(P,()=>{var Y;return(Y=e().schema)==null?void 0:Y.database_name}),a(x,()=>{var Y,te,G;return((G=(te=(Y=e().schema)==null?void 0:Y.schemas[0])==null?void 0:te.tables)==null?void 0:G.length)||0}),a(U,()=>{var Y,te,G;return((G=(te=(Y=e().schema)==null?void 0:Y.schemas[0])==null?void 0:te.views)==null?void 0:G.length)||0}),a(ue,()=>{var Y;return new Date(((Y=e().schema)==null?void 0:Y.loaded_at)||"").toLocaleString("zh-CN")}),a(le,h(ge,{get each(){var Y,te;return((te=(Y=e().schema)==null?void 0:Y.schemas[0])==null?void 0:te.tables)||[]},children:Y=>h(Ua,{table:Y,get selected(){return e().selectedTables.includes(Y.name)},onToggle:(te,G)=>{const ee=e().selectedTables;l(G?{selectedTables:[...ee,te]}:{selectedTables:ee.filter(se=>se!==te)})}})})),a(k,h(O,{get when(){return ce(()=>{var Y,te;return!!((te=(Y=e().schema)==null?void 0:Y.schemas[0])!=null&&te.views)})()&&e().schema.schemas[0].views.length>0},get children(){var Y=va(),te=Y.firstChild,G=te.nextSibling;return a(G,h(ge,{get each(){var ee,se;return((se=(ee=e().schema)==null?void 0:ee.schemas[0])==null?void 0:se.views)||[]},children:ee=>(()=>{var se=wa(),me=se.firstChild,de=me.firstChild,Q=de.nextSibling;return a(de,()=>ee.name),a(Q,()=>ee.schema),a(se,h(O,{get when(){return ee.comment},get children(){var ye=xa();return a(ye,()=>ee.comment),ye}}),null),se})()})),Y}}),null),k}}),null),_}}),null),a($,h(O,{get when(){return e().currentStep==="query"},get children(){return pa()}}),null),a($,h(O,{get when(){return e().currentStep==="preview"},get children(){var _=ba(),k=_.firstChild,H=k.nextSibling,F=H.firstChild,j=F.nextSibling;return j.addEventListener("change",P=>l({name:P.currentTarget.value})),N(()=>j.value=e().name),_}}),null),z.$$click=c,T.$$click=()=>{var k;const _=e();_.currentStep==="connection"&&((k=_.testResult)!=null&&k.success)?(l({currentStep:"schema"}),_.schema||o()):_.currentStep==="schema"?l({currentStep:"query"}):_.currentStep==="query"&&l({currentStep:"preview"})},N(_=>{var k=`progress-step ${e().currentStep==="connection"?"active":""} ${i().connection?"completed":""}`,H=`progress-step ${e().currentStep==="schema"?"active":""} ${i().schema?"completed":""}`,F=`progress-step ${e().currentStep==="query"?"active":""} ${i().query?"completed":""}`,j=`progress-step ${e().currentStep==="preview"?"active":""} ${i().preview?"completed":""}`,P=e().loading;return k!==_.e&&he(g,_.e=k),H!==_.t&&he(y,_.t=H),F!==_.a&&he(w,_.a=F),j!==_.o&&he(b,_.o=j),P!==_.i&&(T.disabled=_.i=P),_},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),f})()}function Ua(t){const e=i=>i<1e3?i.toString():i<1e6?`${(i/1e3).toFixed(1)}K`:`${(i/1e6).toFixed(1)}M`,n=i=>{const l=i.toLowerCase();return l.includes("int")||l.includes("number")||l.includes("decimal")?"🔢":l.includes("varchar")||l.includes("text")||l.includes("char")?"📝":l.includes("date")||l.includes("time")?"📅":l.includes("bool")?"✅":"📋"};return(()=>{var i=Aa(),l=i.firstChild,s=l.firstChild,r=s.firstChild,o=r.firstChild,u=o.nextSibling;u.firstChild;var c=s.nextSibling,f=c.firstChild,d=f.firstChild,v=f.nextSibling,p=l.nextSibling,g=p.firstChild,y=g.firstChild,w=y.nextSibling;w.nextSibling;var b=g.nextSibling;return o.addEventListener("change",$=>t.onToggle(t.table.name,$.currentTarget.checked)),a(u,()=>t.table.name,null),a(f,()=>e(t.table.row_count_estimate),d),a(v,()=>t.table.size_estimate),a(i,h(O,{get when(){return t.table.comment},get children(){var $=Sa();return a($,()=>t.table.comment),$}}),p),a(g,()=>{var $;return(($=t.table.columns)==null?void 0:$.length)||0},w),a(b,h(ge,{get each(){return(t.table.columns||[]).slice(0,6)},children:$=>(()=>{var S=La(),D=S.firstChild,z=D.nextSibling,T=z.nextSibling;return a(D,()=>n($.data_type)),a(z,()=>$.name),a(T,()=>$.data_type),a(S,h(O,{get when(){return $.is_primary_key},get children(){return Pa()}}),null),a(S,h(O,{get when(){return $.is_foreign_key},get children(){return za()}}),null),S})()}),null),a(b,h(O,{get when(){var $;return((($=t.table.columns)==null?void 0:$.length)||0)>6},get children(){var $=Ca(),S=$.firstChild,D=S.nextSibling;return D.nextSibling,a($,()=>{var z;return(((z=t.table.columns)==null?void 0:z.length)||0)-6},D),$}}),null),a(i,h(O,{get when(){return t.table.indexes&&t.table.indexes.length>0},get children(){var $=Ea(),S=$.firstChild,D=S.firstChild,z=D.nextSibling;z.nextSibling;var T=S.nextSibling;return a(S,()=>t.table.indexes.length,z),a(T,h(ge,{get each(){return t.table.indexes.slice(0,3)},children:_=>(()=>{var k=Ma(),H=k.firstChild;return a(k,()=>_.unique?"🔐":"📇",H),a(k,()=>_.name,null),N(F=>{var j=`index-badge ${_.unique?"unique":""}`,P=_.columns.join(", ");return j!==F.e&&he(k,F.e=j),P!==F.t&&M(k,"title",F.t=P),F},{e:void 0,t:void 0}),k})()}),null),a(T,h(O,{get when(){return t.table.indexes.length>3},get children(){var _=ka();return _.firstChild,a(_,()=>t.table.indexes.length-3,null),_}}),null),$}}),null),a(i,h(O,{get when(){return t.table.foreign_keys&&t.table.foreign_keys.length>0},get children(){var $=Da(),S=$.firstChild,D=S.firstChild,z=D.nextSibling;z.nextSibling;var T=S.nextSibling;return a(S,()=>t.table.foreign_keys.length,z),a(T,h(ge,{get each(){return t.table.foreign_keys.slice(0,2)},children:_=>(()=>{var k=Ra();return k.firstChild,a(k,()=>_.referenced_table,null),N(()=>M(k,"title",`${_.column_name} → ${_.referenced_table}.${_.referenced_column}`)),k})()}),null),a(T,h(O,{get when(){return t.table.foreign_keys.length>2},get children(){var _=Ta();return _.firstChild,a(_,()=>t.table.foreign_keys.length-2,null),_}}),null),$}}),null),N(()=>he(i,`table-card ${t.selected?"selected":""}`)),N(()=>o.checked=t.selected),i})()}Le(["click"]);var Fa=m("<input type=text class=search-input placeholder=搜索数据源...>"),Ia=m("<div class=add-buttons-group><button class=add-data-source-btn>📄 文件数据源</button><button class=add-database-source-btn>🗄️ 数据库数据源"),Ba=m("<div class=error-message>"),ja=m("<div class=loading-message>加载中..."),Ha=m("<div class=empty-state><p></p><button>添加第一个数据源"),qa=m("<div class=data-source-grid>"),Ja=m("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),Va=m("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),Wa=m("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),Ka=m("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),Ga=m("<li><button> <!> (<!>)"),Xa=m("<th>"),Ya=m("<tr>"),Qa=m("<td>"),Za=m('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function eo(t){console.log("🏗️  DataSourceManagementCenter 组件渲染，isOpen:",t.isOpen);const[e,n]=K([]),[i,l]=K([]),[s,r]=K("main"),[o,u]=K(null),[c,f]=K(null),[d,v]=K(!1),[p,g]=K(null),[y,w]=K(""),[b,$]=K("all"),[S,D]=K("all");Je(async()=>{try{await z(),await T()}catch(A){console.error("🚨 数据源管理中心初始化失败:",A),g(`初始化失败: ${A}`)}});const z=async()=>{try{v(!0),console.log("🔄 加载数据源列表...");const A=await xe.listDataSources();console.log("✅ 数据源列表加载成功:",A),n(A),g(null)}catch(A){console.error("❌ 加载数据源失败:",A),g(`加载数据源失败: ${A}`)}finally{v(!1)}},T=async()=>{try{console.log("🔄 加载可用数据源类型...");const A=await xe.getAvailableTypes();console.log("✅ 数据源类型加载成功:",A),l(A)}catch(A){console.error("❌ 加载数据源类型失败:",A)}},_=()=>{let A=e();if(y()){const U=y().toLowerCase();A=A.filter(q=>(q.name||"").toLowerCase().includes(U)||(q.type_name||"").toLowerCase().includes(U))}return b()!=="all"&&(A=A.filter(U=>U.status===b())),S()!=="all"&&(A=A.filter(U=>U.type_name===S())),A},k=A=>e().filter(U=>U.status===A).length,H=A=>e().filter(U=>U.type_name===A).length,F=()=>{r("add"),u(null)},j=()=>{r("add-database"),u(null)},P=A=>{u(A),r("edit")},W=async A=>{try{v(!0),g(null),u(A),console.log("🔄 开始预览数据源:",A.name);const U=await xe.getPreview(A.id);f(U),r("preview"),console.log("✅ 数据预览加载成功:",U)}catch(U){console.error("❌ 数据预览失败:",U),g(`预览数据源 "${A.name}" 失败: ${U}`)}finally{v(!1)}},V=async A=>{try{v(!0);const U=e().find(Z=>Z.id===A);if(!U){g(`数据源不存在: ${A}`);return}const q=await xe.testConnection(U.provider_type,U.config||{});alert(q?`✅ 数据源 "${U.name}" 连接测试成功！`:`❌ 数据源 "${U.name}" 连接测试失败`)}catch(U){console.error("❌ 测试连接失败:",U);const q=e().find(Z=>Z.id===A);alert(`❌ 数据源 "${(q==null?void 0:q.name)||A}" 连接测试失败:
${U}`)}finally{v(!1)}},x=async A=>{const U=e().find(q=>q.id===A);if(confirm(`确定要删除数据源 "${U==null?void 0:U.name}" 吗？`))try{await xe.deleteDataSource(A),await z()}catch(q){g(`删除数据源失败: ${q}`)}},L=()=>{r("main"),u(null),f(null),g(null)};return h(O,{get when(){return t.isOpen},get children(){var A=Ka(),U=A.firstChild,q=U.firstChild,Z=q.nextSibling,ue=Z.nextSibling,oe=U.nextSibling;return Ee(q,"click",t.onClose),a(ue,h(O,{get when(){return s()==="main"},get children(){return[(()=>{var I=Fa();return I.$$input=le=>w(le.currentTarget.value),N(()=>I.value=y()),I})(),(()=>{var I=Ia(),le=I.firstChild,Y=le.nextSibling;return le.$$click=F,Y.$$click=j,I})()]}})),a(oe,h(O,{get when(){return s()==="main"},get children(){var I=Ja(),le=I.firstChild,Y=le.firstChild,te=Y.firstChild,G=te.nextSibling,ee=G.firstChild,se=ee.firstChild,me=se.firstChild,de=me.nextSibling;de.nextSibling;var Q=Y.nextSibling,ye=Q.firstChild,$e=ye.nextSibling,fe=$e.firstChild,Pe=fe.firstChild,pe=Pe.firstChild,Te=pe.nextSibling;Te.nextSibling;var De=fe.nextSibling,C=De.firstChild,E=C.firstChild,B=E.nextSibling;B.nextSibling;var R=De.nextSibling,J=R.firstChild,ne=J.firstChild,ie=ne.nextSibling;ie.nextSibling;var _e=Q.nextSibling,we=_e.firstChild,ae=we.nextSibling,Ne=ae.firstChild,Oe=Ne.firstChild,Ue=le.nextSibling;return se.$$click=()=>$("all"),a(se,()=>e().length,de),Pe.$$click=()=>$("active"),a(Pe,()=>k("active"),Te),C.$$click=()=>$("error"),a(C,()=>k("error"),B),J.$$click=()=>$("disabled"),a(J,()=>k("disabled"),ie),Oe.$$click=()=>D("all"),a(ae,h(ge,{get each(){return i()},children:ve=>(()=>{var Se=Ga(),Fe=Se.firstChild,tt=Fe.firstChild,nt=tt.nextSibling,dt=nt.nextSibling,Ot=dt.nextSibling;return Ot.nextSibling,Fe.$$click=()=>D(ve.type_name),a(Fe,()=>ve.category==="file"?"📄":ve.category==="api"?"🌐":ve.category==="database"?"🗄️":"📊",tt),a(Fe,()=>ve.display_name,nt),a(Fe,()=>H(ve.type_name),Ot),N(()=>he(Se,S()===ve.type_name?"active":"")),Se})()}),null),a(Ue,h(O,{get when(){return p()},get children(){var ve=Ba();return a(ve,p),ve}}),null),a(Ue,h(O,{get when(){return d()},get children(){return ja()}}),null),a(Ue,h(O,{get when(){return ce(()=>!d())()&&_().length===0},get children(){var ve=Ha(),Se=ve.firstChild,Fe=Se.nextSibling;return a(Se,()=>y()||b()!=="all"||S()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),Fe.$$click=F,ve}}),null),a(Ue,h(O,{get when(){return ce(()=>!d())()&&_().length>0},get children(){var ve=qa();return a(ve,h(ge,{get each(){return _()},children:Se=>h(to,{source:Se,onPreview:()=>W(Se),onTest:()=>V(Se.id),onEdit:()=>P(Se),onDelete:()=>x(Se.id)})})),ve}}),null),N(ve=>{var Se=b()==="all"?"active":"",Fe=b()==="active"?"active":"",tt=b()==="error"?"active":"",nt=b()==="disabled"?"active":"",dt=S()==="all"?"active":"";return Se!==ve.e&&he(ee,ve.e=Se),Fe!==ve.t&&he(fe,ve.t=Fe),tt!==ve.a&&he(De,ve.a=tt),nt!==ve.o&&he(R,ve.o=nt),dt!==ve.i&&he(Ne,ve.i=dt),ve},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),I}}),null),a(oe,h(O,{get when(){return s()==="add"},get children(){return h(xn,{get availableTypes(){return i()},onBack:L,onSuccess:()=>{z(),L()}})}}),null),a(oe,h(O,{get when(){return s()==="add-database"},get children(){return h(Na,{onBack:L,onSuccess:()=>{z(),L()}})}}),null),a(oe,h(O,{get when(){return ce(()=>s()==="edit")()&&o()},get children(){var I=Va(),le=I.firstChild,Y=le.firstChild,te=Y.nextSibling;return te.firstChild,Y.$$click=L,a(te,()=>{var G;return(G=o())==null?void 0:G.name},null),I}}),null),a(oe,h(O,{get when(){return ce(()=>!!(s()==="preview"&&o()))()&&c()},get children(){var I=Wa(),le=I.firstChild,Y=le.firstChild,te=Y.nextSibling;te.firstChild;var G=te.nextSibling,ee=G.firstChild,se=ee.nextSibling,me=se.nextSibling,de=me.nextSibling;de.nextSibling;var Q=le.nextSibling,ye=Q.firstChild,$e=ye.firstChild,fe=$e.firstChild,Pe=$e.nextSibling;return Y.$$click=L,a(te,()=>{var pe;return(pe=o())==null?void 0:pe.name},null),a(G,()=>{var pe;return(pe=c())==null?void 0:pe.total_rows},se),a(G,()=>{var pe;return(pe=c())==null?void 0:pe.rows.length},de),a(fe,h(ge,{get each(){var pe;return(pe=c())==null?void 0:pe.columns},children:pe=>(()=>{var Te=Xa();return a(Te,pe),Te})()})),a(Pe,h(ge,{get each(){var pe;return(pe=c())==null?void 0:pe.rows.slice(0,50)},children:pe=>(()=>{var Te=Ya();return a(Te,h(ge,{get each(){var De;return((De=c())==null?void 0:De.columns)||[]},children:De=>(()=>{var C=Qa();return a(C,(()=>{var E=ce(()=>typeof pe[De]=="object");return()=>E()?JSON.stringify(pe[De]):String(pe[De]||"")})()),C})()})),Te})()})),I}}),null),A}})}function to(t){const e=s=>{switch(s){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=s=>{switch(s){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},i=s=>{const r=new Date,o=new Date(s),u=r.getTime()-o.getTime(),c=Math.floor(u/(1e3*60*60));return c<1?"刚刚更新":c<24?`${c}小时前`:o.toLocaleDateString("zh-CN")},l=s=>{const r=(s||"").toLowerCase();return r.includes("json")?"📄":r.includes("api")?"🌐":r.includes("csv")?"📊":r.includes("database")?"🗄️":"📋"};return(()=>{var s=Za(),r=s.firstChild,o=r.firstChild,u=o.firstChild,c=u.nextSibling,f=o.nextSibling,d=r.nextSibling,v=d.firstChild,p=v.firstChild,g=p.nextSibling,y=v.nextSibling,w=y.firstChild,b=w.nextSibling,$=y.nextSibling,S=$.firstChild,D=S.nextSibling,z=d.nextSibling,T=z.firstChild,_=T.nextSibling,k=_.nextSibling,H=k.nextSibling;return a(u,()=>l(t.source.type_name)),a(c,()=>t.source.name),a(g,()=>t.source.type_name),a(b,()=>n(t.source.status)),a(D,()=>i(t.source.last_updated)),Ee(T,"click",t.onPreview),Ee(_,"click",t.onTest),Ee(k,"click",t.onEdit),Ee(H,"click",t.onDelete),N(F=>{var j=e(t.source.status),P=`状态: ${n(t.source.status)}`,W=t.source.status!=="active";return j!==F.e&&((F.e=j)!=null?f.style.setProperty("background-color",j):f.style.removeProperty("background-color")),P!==F.t&&M(f,"title",F.t=P),W!==F.a&&(T.disabled=F.a=W),F},{e:void 0,t:void 0,a:void 0}),s})()}Le(["click","input"]);var no=m('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden"><div class="w-80 bg-primary border-r border-default flex flex-col"></div><div class="flex-1 flex flex-col bg-tertiary"></div><div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">');const io=()=>{const[t,e]=K(!1),[n,i]=K(!1);console.log("🖥️  MainLayout渲染，管理中心状态:",n());const l=()=>{console.log("🔄 数据源按钮被点击，准备打开管理中心"),console.log("📊 当前管理中心状态:",n()),i(!0),console.log("✅ 管理中心状态已设置为 true"),console.log("📊 设置后的管理中心状态:",n())},s=()=>e(!1),r=()=>i(!1);return h(Jn,{get children(){var o=no(),u=o.firstChild,c=u.firstChild,f=c.nextSibling,d=f.nextSibling,v=d.firstChild,p=v.firstChild,g=p.nextSibling;return a(o,h(di,{onOpenDataSources:l}),u),a(c,h(gi,{})),a(f,h(us,{})),a(p,h(bl,{})),a(g,h(sa,{})),a(o,h(eo,{get isOpen(){return n()},onClose:r}),null),a(o,h(Br,{get isOpen(){return t()},onClose:s}),null),o}})},lo={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},so=()=>{const{state:t,copySelectedElements:e,pasteElements:n,deleteElements:i,undo:l,redo:s,selectAllElements:r,clearSelection:o,moveElements:u}=We(),c=(g,y)=>{const w=g.key.toLowerCase()===y.key.toLowerCase()||g.key===y.key,b=!!y.ctrl===(g.ctrlKey||g.metaKey),$=!!y.alt===g.altKey,S=!!y.shift===g.shiftKey;return w&&b&&$&&S},f=async g=>{console.log("🎯 执行快捷键:",g);try{switch(g){case"copy":t.selected_ids.length>0&&(await e(),v("复制成功","✅"));break;case"paste":const y={x:20,y:20},w=await n(y.x,y.y);w.length>0&&v(`粘贴 ${w.length} 个元素`,"📋");break;case"cut":t.selected_ids.length>0&&(await e(),await i([...t.selected_ids]),v("剪切成功","✂️"));break;case"delete":if(t.selected_ids.length>0){const b=t.selected_ids.length;await i([...t.selected_ids]),v(`删除 ${b} 个元素`,"🗑️")}break;case"undo":await l(),v("撤销","↶");break;case"redo":await s(),v("重做","↷");break;case"selectAll":await r(),v(`全选 ${t.elements.length} 个元素`,"🎯");break;case"clearSelection":t.selected_ids.length>0&&(o(),v("清除选择","⭕"));break;case"duplicate":if(t.selected_ids.length>0){await e();const b=await n(20,20);v(`复制 ${b.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await d(g);break;default:console.warn("未知的快捷键动作:",g)}}catch(y){console.error("快捷键执行失败:",y),v("操作失败","❌")}},d=async g=>{if(t.selected_ids.length===0)return;const y=g.includes("Fast"),w=y?10:1;let b=0,$=0;switch(g){case"moveUp":case"moveFastUp":$=-w;break;case"moveDown":case"moveFastDown":$=w;break;case"moveLeft":case"moveFastLeft":b=-w;break;case"moveRight":case"moveFastRight":b=w;break}(b!==0||$!==0)&&(await u([...t.selected_ids],b,$),y&&v(`快速移动 ${w}px`,"🔄"))},v=(g,y)=>{const w=document.createElement("div");w.className="keyboard-feedback",w.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${y}</span>
        <span class="feedback-text">${g}</span>
      </div>
    `,document.body.appendChild(w),setTimeout(()=>{w.parentNode&&w.parentNode.removeChild(w)},2e3)},p=g=>{const y=g.target;if(!(y.tagName==="INPUT"||y.tagName==="TEXTAREA"||y.contentEditable==="true")){for(const[b,$]of Object.entries(lo))if(c(g,$.combination)){g.preventDefault(),g.stopPropagation(),console.log("🎹 快捷键触发:",b,$.action),f($.action);return}}};return Je(()=>{if(document.addEventListener("keydown",p,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const g=document.createElement("style");g.id="keyboard-feedback-styles",g.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(g)}}),xt(()=>{document.removeEventListener("keydown",p,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},ro=()=>(Je(()=>{document.addEventListener("contextmenu",t=>t.preventDefault())}),h(Zn,{get children(){return[h(so,{}),h(io,{})]}})),ao=document.getElementById("root");Un(()=>h(ro,{}),ao);
