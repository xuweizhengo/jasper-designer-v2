var En=Object.defineProperty;var Ln=(e,t,n)=>t in e?En(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var qe=(e,t,n)=>Ln(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))l(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function l(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const Dn=!1,Pn=(e,t)=>e===t,Xe=Symbol("solid-proxy"),zt=Symbol("solid-track"),mt={equals:Pn};let Zt=an;const We=1,bt=2,en={owned:null,cleanups:null,context:null,owner:null};var Ee=null;let kt=null,An=null,Le=null,ze=null,Je=null,Ct=0;function ft(e,t){const n=Le,l=Ee,i=e.length===0,s=t===void 0?l:t,a=i?en:{owned:null,cleanups:null,context:s?s.context:null,owner:s},o=i?e:()=>e(()=>Ie(()=>ot(a)));Ee=a,Le=null;try{return nt(o,!0)}finally{Le=n,Ee=l}}function Y(e,t){t=t?Object.assign({},mt,t):mt;const n={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},l=i=>(typeof i=="function"&&(i=i(n.value)),rn(n,i));return[sn.bind(n),l]}function P(e,t,n){const l=Ut(e,t,!1,We);gt(l)}function It(e,t,n){Zt=Nn;const l=Ut(e,t,!1,We);l.user=!0,Je?Je.push(l):gt(l)}function Ce(e,t,n){n=n?Object.assign({},mt,n):mt;const l=Ut(e,t,!0,0);return l.observers=null,l.observerSlots=null,l.comparator=n.equals||void 0,gt(l),sn.bind(l)}function zn(e){return nt(e,!1)}function Ie(e){if(Le===null)return e();const t=Le;Le=null;try{return e()}finally{Le=t}}function Ue(e){It(()=>Ie(e))}function ut(e){return Ee===null||(Ee.cleanups===null?Ee.cleanups=[e]:Ee.cleanups.push(e)),e}function Rt(){return Le}const[Tc,Ec]=Y(!1);function tn(e,t){const n=Symbol("context");return{id:n,Provider:In(n),defaultValue:e}}function nn(e){let t;return Ee&&Ee.context&&(t=Ee.context[e.id])!==void 0?t:e.defaultValue}function ln(e){const t=Ce(e),n=Ce(()=>Mt(t()));return n.toArray=()=>{const l=n();return Array.isArray(l)?l:l!=null?[l]:[]},n}function sn(){if(this.sources&&this.state)if(this.state===We)gt(this);else{const e=ze;ze=null,nt(()=>pt(this),!1),ze=e}if(Le){const e=this.observers?this.observers.length:0;Le.sources?(Le.sources.push(this),Le.sourceSlots.push(e)):(Le.sources=[this],Le.sourceSlots=[e]),this.observers?(this.observers.push(Le),this.observerSlots.push(Le.sources.length-1)):(this.observers=[Le],this.observerSlots=[Le.sources.length-1])}return this.value}function rn(e,t,n){let l=e.value;return(!e.comparator||!e.comparator(l,t))&&(e.value=t,e.observers&&e.observers.length&&nt(()=>{for(let i=0;i<e.observers.length;i+=1){const s=e.observers[i],a=kt&&kt.running;a&&kt.disposed.has(s),(a?!s.tState:!s.state)&&(s.pure?ze.push(s):Je.push(s),s.observers&&on(s)),a||(s.state=We)}if(ze.length>1e6)throw ze=[],new Error},!1)),t}function gt(e){if(!e.fn)return;ot(e);const t=Ct;Rn(e,e.value,t)}function Rn(e,t,n){let l;const i=Ee,s=Le;Le=Ee=e;try{l=e.fn(t)}catch(a){return e.pure&&(e.state=We,e.owned&&e.owned.forEach(ot),e.owned=null),e.updatedAt=n+1,cn(a)}finally{Le=s,Ee=i}(!e.updatedAt||e.updatedAt<=n)&&(e.updatedAt!=null&&"observers"in e?rn(e,l):e.value=l,e.updatedAt=n)}function Ut(e,t,n,l=We,i){const s={fn:e,state:l,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:Ee,context:Ee?Ee.context:null,pure:n};return Ee===null||Ee!==en&&(Ee.owned?Ee.owned.push(s):Ee.owned=[s]),s}function yt(e){if(e.state===0)return;if(e.state===bt)return pt(e);if(e.suspense&&Ie(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<Ct);)e.state&&t.push(e);for(let n=t.length-1;n>=0;n--)if(e=t[n],e.state===We)gt(e);else if(e.state===bt){const l=ze;ze=null,nt(()=>pt(e,t[0]),!1),ze=l}}function nt(e,t){if(ze)return e();let n=!1;t||(ze=[]),Je?n=!0:Je=[],Ct++;try{const l=e();return Mn(n),l}catch(l){n||(Je=null),ze=null,cn(l)}}function Mn(e){if(ze&&(an(ze),ze=null),e)return;const t=Je;Je=null,t.length&&nt(()=>Zt(t),!1)}function an(e){for(let t=0;t<e.length;t++)yt(e[t])}function Nn(e){let t,n=0;for(t=0;t<e.length;t++){const l=e[t];l.user?e[n++]=l:yt(l)}for(t=0;t<n;t++)yt(e[t])}function pt(e,t){e.state=0;for(let n=0;n<e.sources.length;n+=1){const l=e.sources[n];if(l.sources){const i=l.state;i===We?l!==t&&(!l.updatedAt||l.updatedAt<Ct)&&yt(l):i===bt&&pt(l,t)}}}function on(e){for(let t=0;t<e.observers.length;t+=1){const n=e.observers[t];n.state||(n.state=bt,n.pure?ze.push(n):Je.push(n),n.observers&&on(n))}}function ot(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),l=e.sourceSlots.pop(),i=n.observers;if(i&&i.length){const s=i.pop(),a=n.observerSlots.pop();l<i.length&&(s.sourceSlots[a]=l,i[l]=s,n.observerSlots[l]=a)}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)ot(e.tOwned[t]);delete e.tOwned}if(e.owned){for(t=e.owned.length-1;t>=0;t--)ot(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function On(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function cn(e,t=Ee){throw On(e)}function Mt(e){if(typeof e=="function"&&!e.length)return Mt(e());if(Array.isArray(e)){const t=[];for(let n=0;n<e.length;n++){const l=Mt(e[n]);Array.isArray(l)?t.push.apply(t,l):t.push(l)}return t}return e}function In(e,t){return function(l){let i;return P(()=>i=Ie(()=>(Ee.context={...Ee.context,[e]:l.value},ln(()=>l.children))),void 0),i}}const Un=Symbol("fallback");function Bt(e){for(let t=0;t<e.length;t++)e[t]()}function Fn(e,t,n={}){let l=[],i=[],s=[],a=0,o=t.length>1?[]:null;return ut(()=>Bt(s)),()=>{let g=e()||[],c=g.length,b,u;return g[zt],Ie(()=>{let f,d,y,$,p,_,C,E,k;if(c===0)a!==0&&(Bt(s),s=[],l=[],i=[],a=0,o&&(o=[])),n.fallback&&(l=[Un],i[0]=ft(I=>(s[0]=I,n.fallback())),a=1);else if(a===0){for(i=new Array(c),u=0;u<c;u++)l[u]=g[u],i[u]=ft(v);a=c}else{for(y=new Array(c),$=new Array(c),o&&(p=new Array(c)),_=0,C=Math.min(a,c);_<C&&l[_]===g[_];_++);for(C=a-1,E=c-1;C>=_&&E>=_&&l[C]===g[E];C--,E--)y[E]=i[C],$[E]=s[C],o&&(p[E]=o[C]);for(f=new Map,d=new Array(E+1),u=E;u>=_;u--)k=g[u],b=f.get(k),d[u]=b===void 0?-1:b,f.set(k,u);for(b=_;b<=C;b++)k=l[b],u=f.get(k),u!==void 0&&u!==-1?(y[u]=i[b],$[u]=s[b],o&&(p[u]=o[b]),u=d[u],f.set(k,u)):s[b]();for(u=_;u<c;u++)u in y?(i[u]=y[u],s[u]=$[u],o&&(o[u]=p[u],o[u](u))):i[u]=ft(v);i=i.slice(0,a=c),l=g.slice(0)}return i});function v(f){if(s[u]=f,o){const[d,y]=Y(u);return o[u]=y,t(g[u],d)}return t(g[u])}}}function h(e,t){return Ie(()=>e(t||{}))}const dn=e=>`Stale read from <${e}>.`;function ce(e){const t="fallback"in e&&{fallback:()=>e.fallback};return Ce(Fn(()=>e.each,e.children,t||void 0))}function R(e){const t=e.keyed,n=Ce(()=>e.when,void 0,void 0),l=t?n:Ce(n,void 0,{equals:(i,s)=>!i==!s});return Ce(()=>{const i=l();if(i){const s=e.children;return typeof s=="function"&&s.length>0?Ie(()=>s(t?i:()=>{if(!Ie(l))throw dn("Show");return n()})):s}return e.fallback},void 0,void 0)}function qn(e){const t=ln(()=>e.children),n=Ce(()=>{const l=t(),i=Array.isArray(l)?l:[l];let s=()=>{};for(let a=0;a<i.length;a++){const o=a,g=i[a],c=s,b=Ce(()=>c()?void 0:g.when,void 0,void 0),u=g.keyed?b:Ce(b,void 0,{equals:(v,f)=>!v==!f});s=()=>c()||(u()?[o,b,g]:void 0)}return s});return Ce(()=>{const l=n()();if(!l)return e.fallback;const[i,s,a]=l,o=a.children;return typeof o=="function"&&o.length>0?Ie(()=>o(a.keyed?s():()=>{var c;if(((c=Ie(n)())==null?void 0:c[0])!==i)throw dn("Match");return s()})):o},void 0,void 0)}function st(e){return e}const _e=e=>Ce(()=>e());function Bn(e,t,n){let l=n.length,i=t.length,s=l,a=0,o=0,g=t[i-1].nextSibling,c=null;for(;a<i||o<s;){if(t[a]===n[o]){a++,o++;continue}for(;t[i-1]===n[s-1];)i--,s--;if(i===a){const b=s<l?o?n[o-1].nextSibling:n[s-o]:g;for(;o<s;)e.insertBefore(n[o++],b)}else if(s===o)for(;a<i;)(!c||!c.has(t[a]))&&t[a].remove(),a++;else if(t[a]===n[s-1]&&n[o]===t[i-1]){const b=t[--i].nextSibling;e.insertBefore(n[o++],t[a++].nextSibling),e.insertBefore(n[--s],b),t[i]=n[s]}else{if(!c){c=new Map;let u=o;for(;u<s;)c.set(n[u],u++)}const b=c.get(t[a]);if(b!=null)if(o<b&&b<s){let u=a,v=1,f;for(;++u<i&&u<s&&!((f=c.get(t[u]))==null||f!==b+v);)v++;if(v>b-o){const d=t[a];for(;o<b;)e.insertBefore(n[o++],d)}else e.replaceChild(n[o++],t[a++])}else a++;else t[a++].remove()}}}const jt="_$DX_DELEGATE";function jn(e,t,n,l={}){let i;return ft(s=>{i=s,t===document?e():r(t,e(),t.firstChild?null:void 0,n)},l.owner),()=>{i(),t.textContent=""}}function m(e,t,n,l){let i;const s=()=>{const o=l?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return o.innerHTML=e,n?o.content.firstChild.firstChild:l?o.firstChild:o.content.firstChild},a=t?()=>Ie(()=>document.importNode(i||(i=s()),!0)):()=>(i||(i=s())).cloneNode(!0);return a.cloneNode=a,a}function De(e,t=window.document){const n=t[jt]||(t[jt]=new Set);for(let l=0,i=e.length;l<i;l++){const s=e[l];n.has(s)||(n.add(s),t.addEventListener(s,Qn))}}function B(e,t,n){n==null?e.removeAttribute(t):e.setAttribute(t,n)}function $e(e,t){t==null?e.removeAttribute("class"):e.className=t}function Te(e,t,n,l){Array.isArray(n)?(e[`$$${t}`]=n[0],e[`$$${t}Data`]=n[1]):e[`$$${t}`]=n}function un(e,t,n){if(!t)return n?B(e,"style"):t;const l=e.style;if(typeof t=="string")return l.cssText=t;typeof n=="string"&&(l.cssText=n=void 0),n||(n={}),t||(t={});let i,s;for(s in n)t[s]==null&&l.removeProperty(s),delete n[s];for(s in t)i=t[s],i!==n[s]&&(l.setProperty(s,i),n[s]=i);return n}function Ft(e,t,n){return Ie(()=>e(t,n))}function r(e,t,n,l){if(n!==void 0&&!l&&(l=[]),typeof t!="function")return $t(e,t,l,n);P(i=>$t(e,t(),i,n),l)}function Qn(e){let t=e.target;const n=`$$${e.type}`,l=e.target,i=e.currentTarget,s=g=>Object.defineProperty(e,"target",{configurable:!0,value:g}),a=()=>{const g=t[n];if(g&&!t.disabled){const c=t[`${n}Data`];if(c!==void 0?g.call(t,c,e):g.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&s(t.host),!0},o=()=>{for(;a()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const g=e.composedPath();s(g[0]);for(let c=0;c<g.length-2&&(t=g[c],!!a());c++){if(t._$host){t=t._$host,o();break}if(t.parentNode===i)break}}else o();s(l)}function $t(e,t,n,l,i){for(;typeof n=="function";)n=n();if(t===n)return n;const s=typeof t,a=l!==void 0;if(e=a&&n[0]&&n[0].parentNode||e,s==="string"||s==="number"){if(s==="number"&&(t=t.toString(),t===n))return n;if(a){let o=n[0];o&&o.nodeType===3?o.data!==t&&(o.data=t):o=document.createTextNode(t),n=Ze(e,n,l,o)}else n!==""&&typeof n=="string"?n=e.firstChild.data=t:n=e.textContent=t}else if(t==null||s==="boolean")n=Ze(e,n,l);else{if(s==="function")return P(()=>{let o=t();for(;typeof o=="function";)o=o();n=$t(e,o,n,l)}),()=>n;if(Array.isArray(t)){const o=[],g=n&&Array.isArray(n);if(Nt(o,t,n,i))return P(()=>n=$t(e,o,n,l,!0)),()=>n;if(o.length===0){if(n=Ze(e,n,l),a)return n}else g?n.length===0?Qt(e,o,l):Bn(e,n,o):(n&&Ze(e),Qt(e,o));n=o}else if(t.nodeType){if(Array.isArray(n)){if(a)return n=Ze(e,n,l,t);Ze(e,n,null,t)}else n==null||n===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);n=t}}return n}function Nt(e,t,n,l){let i=!1;for(let s=0,a=t.length;s<a;s++){let o=t[s],g=n&&n[e.length],c;if(!(o==null||o===!0||o===!1))if((c=typeof o)=="object"&&o.nodeType)e.push(o);else if(Array.isArray(o))i=Nt(e,o,g)||i;else if(c==="function")if(l){for(;typeof o=="function";)o=o();i=Nt(e,Array.isArray(o)?o:[o],Array.isArray(g)?g:[g])||i}else e.push(o),i=!0;else{const b=String(o);g&&g.nodeType===3&&g.data===b?e.push(g):e.push(document.createTextNode(b))}}return i}function Qt(e,t,n=null){for(let l=0,i=t.length;l<i;l++)e.insertBefore(t[l],n)}function Ze(e,t,n,l){if(n===void 0)return e.textContent="";const i=l||document.createTextNode("");if(t.length){let s=!1;for(let a=t.length-1;a>=0;a--){const o=t[a];if(i!==o){const g=o.parentNode===e;!s&&!a?g?e.replaceChild(i,o):e.insertBefore(i,n):g&&o.remove()}else s=!0}}else e.insertBefore(i,n);return[i]}var Hn=m("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),Jn=m("<span class=loading-indicator>⏳"),Vn=m("<button><span class=button-icon></span><span class=button-text>"),Wn=m("<span class=coming-soon>敬请期待"),Gn=m("<div class=error-indicator>❌");const gn=tn(),Kn=e=>{const[t,n]=Y({mode:"design",loading:!1,error:void 0}),l=u=>{n(v=>({...v,mode:u,error:void 0})),console.log(`🎯 预览模式切换: ${u==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:u,timestamp:Date.now()}}))},b={state:t,actions:{setMode:l,toggleMode:()=>{const u=t().mode;l(u==="design"?"data":u==="data"?"preview":"design")},setLoading:u=>{n(v=>({...v,loading:u}))},setError:u=>{n(v=>({...v,error:u,loading:!1}))},isDesignMode:()=>t().mode==="design",isDataMode:()=>t().mode==="data",isPreviewMode:()=>t().mode==="preview"}};return h(gn.Provider,{value:b,get children(){return e.children}})},hn=()=>{const e=nn(gn);if(!e)throw new Error("usePreview必须在PreviewProvider内使用");return e},Yn=()=>{const{state:e,actions:t}=hn(),n=i=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[i],l=()=>n(e().mode);return(()=>{var i=Hn(),s=i.firstChild,a=s.firstChild,o=a.nextSibling,g=s.nextSibling;return r(a,()=>l().icon),r(o,()=>l().text),r(s,(()=>{var c=_e(()=>!!e().loading);return()=>c()&&Jn()})(),null),r(g,()=>["design","data","preview"].map(c=>{const b=n(c),u=e().mode===c,v=c==="preview";return(()=>{var f=Vn(),d=f.firstChild,y=d.nextSibling;return f.$$click=()=>{if(v){alert(`🔍 预览模式即将推出！

✨ 即将支持的功能：
• 纯净的最终效果预览
• 隐藏所有设计辅助元素
• 只读模式，专注查看输出效果`);return}t.setMode(c)},$e(f,`mode-btn ${u?"active":""} ${v?"preview-placeholder":""}`),r(d,()=>b.icon),r(y,()=>b.text),r(f,v&&Wn(),null),P($=>{var p=e().loading,_=v?"预览模式 - 即将推出":`切换到${b.text}`;return p!==$.e&&(f.disabled=$.e=p),_!==$.t&&B(f,"title",$.t=_),$},{e:void 0,t:void 0}),f})()})),r(i,(()=>{var c=_e(()=>!!e().error);return()=>c()&&(()=>{var b=Gn();return P(()=>B(b,"title",e().error)),b})()})(),null),i})()},Tt={getModeDisplayText:e=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[e],getModeIcon:e=>({design:"🎨",data:"🔗",preview:"🔍"})[e],shouldShowExpression:e=>e==="design",shouldEvaluateExpression:e=>e==="data"||e==="preview",shouldShowDesignAids:e=>e==="design"||e==="data",shouldAllowInteraction:e=>e==="design"||e==="data",isReadOnlyMode:e=>e==="preview",getModeTransitionClass:e=>`mode-${e}-active`};De(["click"]);const Ot=Symbol("store-raw"),tt=Symbol("store-node"),Qe=Symbol("store-has"),vn=Symbol("store-self");function fn(e){let t=e[Xe];if(!t&&(Object.defineProperty(e,Xe,{value:t=new Proxy(e,el)}),!Array.isArray(e))){const n=Object.keys(e),l=Object.getOwnPropertyDescriptors(e);for(let i=0,s=n.length;i<s;i++){const a=n[i];l[a].get&&Object.defineProperty(e,a,{enumerable:l[a].enumerable,get:l[a].get.bind(t)})}}return t}function _t(e){let t;return e!=null&&typeof e=="object"&&(e[Xe]||!(t=Object.getPrototypeOf(e))||t===Object.prototype||Array.isArray(e))}function ct(e,t=new Set){let n,l,i,s;if(n=e!=null&&e[Ot])return n;if(!_t(e)||t.has(e))return e;if(Array.isArray(e)){Object.isFrozen(e)?e=e.slice(0):t.add(e);for(let a=0,o=e.length;a<o;a++)i=e[a],(l=ct(i,t))!==i&&(e[a]=l)}else{Object.isFrozen(e)?e=Object.assign({},e):t.add(e);const a=Object.keys(e),o=Object.getOwnPropertyDescriptors(e);for(let g=0,c=a.length;g<c;g++)s=a[g],!o[s].get&&(i=e[s],(l=ct(i,t))!==i&&(e[s]=l))}return e}function xt(e,t){let n=e[t];return n||Object.defineProperty(e,t,{value:n=Object.create(null)}),n}function dt(e,t,n){if(e[t])return e[t];const[l,i]=Y(n,{equals:!1,internal:!0});return l.$=i,e[t]=l}function Xn(e,t){const n=Reflect.getOwnPropertyDescriptor(e,t);return!n||n.get||!n.configurable||t===Xe||t===tt||(delete n.value,delete n.writable,n.get=()=>e[Xe][t]),n}function mn(e){Rt()&&dt(xt(e,tt),vn)()}function Zn(e){return mn(e),Reflect.ownKeys(e)}const el={get(e,t,n){if(t===Ot)return e;if(t===Xe)return n;if(t===zt)return mn(e),n;const l=xt(e,tt),i=l[t];let s=i?i():e[t];if(t===tt||t===Qe||t==="__proto__")return s;if(!i){const a=Object.getOwnPropertyDescriptor(e,t);Rt()&&(typeof s!="function"||e.hasOwnProperty(t))&&!(a&&a.get)&&(s=dt(l,t,s)())}return _t(s)?fn(s):s},has(e,t){return t===Ot||t===Xe||t===zt||t===tt||t===Qe||t==="__proto__"?!0:(Rt()&&dt(xt(e,Qe),t)(),t in e)},set(){return!0},deleteProperty(){return!0},ownKeys:Zn,getOwnPropertyDescriptor:Xn};function St(e,t,n,l=!1){if(!l&&e[t]===n)return;const i=e[t],s=e.length;n===void 0?(delete e[t],e[Qe]&&e[Qe][t]&&i!==void 0&&e[Qe][t].$()):(e[t]=n,e[Qe]&&e[Qe][t]&&i===void 0&&e[Qe][t].$());let a=xt(e,tt),o;if((o=dt(a,t,i))&&o.$(()=>n),Array.isArray(e)&&e.length!==s){for(let g=e.length;g<s;g++)(o=a[g])&&o.$();(o=dt(a,"length",s))&&o.$(e.length)}(o=a[vn])&&o.$()}function bn(e,t){const n=Object.keys(t);for(let l=0;l<n.length;l+=1){const i=n[l];St(e,i,t[i])}}function tl(e,t){if(typeof t=="function"&&(t=t(e)),t=ct(t),Array.isArray(t)){if(e===t)return;let n=0,l=t.length;for(;n<l;n++){const i=t[n];e[n]!==i&&St(e,n,i)}St(e,"length",l)}else bn(e,t)}function at(e,t,n=[]){let l,i=e;if(t.length>1){l=t.shift();const a=typeof l,o=Array.isArray(e);if(Array.isArray(l)){for(let g=0;g<l.length;g++)at(e,[l[g]].concat(t),n);return}else if(o&&a==="function"){for(let g=0;g<e.length;g++)l(e[g],g)&&at(e,[g].concat(t),n);return}else if(o&&a==="object"){const{from:g=0,to:c=e.length-1,by:b=1}=l;for(let u=g;u<=c;u+=b)at(e,[u].concat(t),n);return}else if(t.length>1){at(e[l],t,[l].concat(n));return}i=e[l],n=[l].concat(n)}let s=t[0];typeof s=="function"&&(s=s(i,n),s===i)||l===void 0&&s==null||(s=ct(s),l===void 0||_t(i)&&_t(s)&&!Array.isArray(s)?bn(i,s):St(e,l,s))}function nl(...[e,t]){const n=ct(e||{}),l=Array.isArray(n),i=fn(n);function s(...a){zn(()=>{l&&a.length===1?tl(n,a[0]):at(n,a)})}return[i,s]}function ll(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Ht(e,t=!1){const n=ll(),l=`_${n}`;return Object.defineProperty(window,l,{value:i=>(t&&Reflect.deleteProperty(window,l),e==null?void 0:e(i)),writable:!1,configurable:!0}),n}async function he(e,t={}){return new Promise((n,l)=>{const i=Ht(a=>{n(a),Reflect.deleteProperty(window,`_${s}`)},!0),s=Ht(a=>{l(a),Reflect.deleteProperty(window,`_${i}`)},!0);window.__TAURI_IPC__({cmd:e,callback:i,error:s,...t})})}const yn=tn(),il=e=>{const[t,n]=nl({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[l,i]=Y(!1),[s,a]=Y(null),[o,g]=Y(!1),c=async()=>{try{i(!0),console.log("🔄 Loading app state...");const w=await he("get_app_state");console.log("🔄 App state loaded, selected_ids:",w.selected_ids),n(w)}catch(w){console.error("Failed to load app state:",w)}finally{i(!1)}};Ue(()=>{c()});const b=async(w,A,V,z={})=>{try{i(!0);const M=await he("create_element",{request:{element_type:w,position:A,size:V,content_data:z}});return await c(),M}catch(M){throw console.error("Failed to create element:",M),M}finally{i(!1)}},u=async(w,A)=>{try{i(!0),await he("update_element",{request:{id:w,updates:A}}),await c()}catch(V){throw console.error("Failed to update element:",V),V}finally{i(!1)}},v=async w=>{try{i(!0),await he("batch_update_positions",{request:{updates:w}}),n(A=>{const V=A.elements.map(z=>{const M=w.find(J=>J.element_id===z.id);return M?{...z,position:M.new_position}:z});return{...A,elements:V,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(A){throw console.error("Failed to batch update positions:",A),await c(),A}finally{i(!1)}},f=async w=>{try{i(!0),await he("delete_element",{elementId:w}),await c()}catch(A){throw console.error("Failed to delete element:",A),A}finally{i(!1)}},d=async w=>{try{console.log("Selecting element:",w),await he("select_element",{elementId:w}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",t.selected_ids)}catch(A){throw console.error("Failed to select element:",A),A}},y=async w=>{try{console.log("Selecting multiple elements:",w),w.length>0?(await he("select_multiple",{elementIds:w}),console.log("✅ Multi-select completed for:",w.length,"elements")):await he("clear_selection"),await c()}catch(A){throw console.error("Failed to select multiple elements:",A),A}},$=async w=>{try{console.log("Adding to selection:",w),await he("add_to_selection",{elementId:w}),await c()}catch(A){throw console.error("Failed to add to selection:",A),A}},p=async w=>{try{console.log("Removing from selection:",w),await he("remove_from_selection",{elementId:w}),await c()}catch(A){throw console.error("Failed to remove from selection:",A),A}},_=async w=>{try{console.log("Toggling selection:",w),await he("toggle_selection",{elementId:w}),await c()}catch(A){throw console.error("Failed to toggle selection:",A),A}},C=async()=>{try{await he("clear_selection"),await c()}catch(w){throw console.error("Failed to clear selection:",w),w}},E=async()=>{try{await he("copy_selected")}catch(w){throw console.error("Failed to copy selected elements:",w),w}},U={state:t,setState:n,createElement:b,updateElement:u,batchUpdatePositions:v,deleteElement:f,selectElement:d,selectMultiple:y,addToSelection:$,removeFromSelection:p,toggleSelection:_,clearSelection:C,copySelected:E,copySelectedElements:async()=>E(),pasteElements:async(w,A)=>{try{i(!0);const V=await he("paste_elements",{offsetX:w,offsetY:A});return await c(),V}catch(V){throw console.error("Failed to paste elements:",V),V}finally{i(!1)}},deleteElements:async w=>{try{i(!0);for(const A of w)await he("delete_element",{elementId:A});await c()}catch(A){throw console.error("Failed to delete elements:",A),A}finally{i(!1)}},selectAllElements:async()=>{try{const w=t.elements.map(A=>A.id);await y(w)}catch(w){throw console.error("Failed to select all elements:",w),w}},moveElements:async(w,A,V)=>{try{i(!0);const z=t.elements.filter(M=>w.includes(M.id)).map(M=>({element_id:M.id,new_position:{x:M.position.x+A,y:M.position.y+V}}));z.length>0&&await v(z)}catch(z){throw console.error("Failed to move elements:",z),z}finally{i(!1)}},undo:async()=>{try{i(!0),await he("undo"),await c()}catch(w){throw console.error("Failed to undo:",w),w}finally{i(!1)}},redo:async()=>{try{i(!0),await he("redo"),await c()}catch(w){throw console.error("Failed to redo:",w),w}finally{i(!1)}},updateCanvasConfig:async w=>{try{i(!0),await he("update_canvas_config",{request:w}),await c()}catch(A){throw console.error("Failed to update canvas config:",A),A}finally{i(!1)}},getElementsAtPoint:async(w,A)=>{try{return await he("get_elements_at_point",{x:w,y:A})}catch(V){return console.error("Failed to get elements at point:",V),[]}},isLoading:l,setLoading:i,dragOperation:s,setDragOperation:a,resizeOperation:o,setResizeOperation:g};return h(yn.Provider,{value:U,get children(){return e.children}})},Ge=()=>{const e=nn(yn);if(!e)throw new Error("useAppContext must be used within an AppProvider");return e};async function pn(e){return he("tauri",e)}async function sl(e={}){return typeof e=="object"&&Object.freeze(e),pn({__tauriModule:"Dialog",message:{cmd:"openDialog",options:e}})}async function rl(e={}){return typeof e=="object"&&Object.freeze(e),pn({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:e}})}class Et{static async loadTemplate(t){return await he("load_jasper_template",{filePath:t})}static async saveTemplate(t,n){await he("save_jasper_template",{template:t,filePath:n})}static async saveTemplateAs(t,n,l){await he("save_template_as",{template:t,filePath:n,format:l})}static async validateTemplate(t){return await he("validate_template",{template:t})}static async createEmptyTemplate(){return await he("create_empty_template")}static async getTemplateInfo(t){return await he("get_template_info",{filePath:t})}static async detectTemplateFormat(t){return await he("detect_template_format",{filePath:t})}static async generateTemplatePreview(t){return await he("generate_template_preview",{template:t})}static async exportTemplateJson(t){return await he("export_template_json",{template:t})}static async importTemplateJson(t){return await he("import_template_json",{jsonData:t})}static async cloneTemplate(t){return await he("clone_template",{template:t})}static async mergeTemplates(t,n){return await he("merge_templates",{baseTemplate:t,overlayTemplate:n})}static async extractTemplateElements(t,n){return await he("extract_template_elements",{template:t,elementIds:n})}}const al="modulepreload",ol=function(e){return"/"+e},Jt={},cl=function(t,n,l){let i=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=Promise.allSettled(n.map(g=>{if(g=ol(g),g in Jt)return;Jt[g]=!0;const c=g.endsWith(".css"),b=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${g}"]${b}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":al,c||(u.as="script"),u.crossOrigin="",u.href=g,o&&u.setAttribute("nonce",o),document.head.appendChild(u),c)return new Promise((v,f)=>{u.addEventListener("load",v),u.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${g}`)))})}))}function s(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return i.then(a=>{for(const o of a||[])o.status==="rejected"&&s(o.reason);return t().catch(s)})},dl=()=>({metadata:{version:"2.0.0",format_version:"1.0.0",created_at:new Date().toISOString(),last_modified:new Date().toISOString(),created_by:"jasper-designer-v2",tags:[],compatibility:{min_jasper_version:"2.0.0",jasperreports_version:"6.20.0"}},canvas:{width:595,height:842,unit:"pt",orientation:"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:!0,size:10,snap:!0,visible:!0},background:{color:"#ffffff"}},data_sources:[],elements:[],parameters:[],variables:[],groups:[]});class Lt{static toJasperTemplate(t,n){const l={...dl()},i={...l.metadata,...n,last_modified:new Date().toISOString()},s=this.convertCanvasConfig(t.canvas_config),a=t.elements.map(o=>this.convertReportElementToTemplateElement(o));return{...l,metadata:i,canvas:s,elements:a}}static convertCanvasConfig(t){return{width:t.width,height:t.height,unit:"pt",orientation:t.width>t.height?"landscape":"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:t.show_grid,size:t.grid_size,snap:t.snap_to_grid,visible:t.show_grid},background:{color:t.background_color}}}static convertReportElementToTemplateElement(t){const n=this.getElementType(t.content),l=this.convertElementContent(t.content),i=this.convertElementStyle(t.content);return{id:t.id,element_type:n,position:{x:t.position.x,y:t.position.y},size:{width:t.size.width,height:t.size.height},z_index:t.z_index,visible:t.visible,content:l,style:i,data_binding:this.extractDataBinding(t.content)}}static getElementType(t){switch(t.type){case"Text":return"Text";case"DataField":return"DataField";case"Rectangle":return"Rectangle";case"Line":return"Line";case"Image":return"Image";default:return"Text"}}static convertElementContent(t){switch(t.type){case"Text":return{text:t.content,font:this.convertTextStyleToFont(t.style),alignment:this.convertTextStyleToAlignment(t.style),color:t.style.color};case"DataField":return{expression:t.expression,format:t.format,font:this.convertTextStyleToFont(t.style),alignment:this.convertTextStyleToAlignment(t.style),color:t.style.color};case"Rectangle":return{color:t.fill_color};case"Line":return{color:t.color};case"Image":return{expression:t.src,text:t.alt};default:return{}}}static convertTextStyleToFont(t){return{family:t.font_family||"Arial",size:t.font_size||12,weight:this.mapFontWeight(t.font_weight),style:"normal"}}static convertTextStyleToAlignment(t){return{horizontal:this.mapTextAlign(t.align),vertical:"middle"}}static convertElementStyle(t){const n={};switch(t.type){case"Rectangle":t.fill_color&&(n.background={color:t.fill_color}),t.border&&(n.border={width:t.border.width,color:t.border.color,style:this.mapBorderStyle(t.border.style)});break;case"Text":case"DataField":t.style.background&&(n.background={color:t.style.background.color}),t.style.border&&(n.border={width:t.style.border.width,color:t.style.border.color,style:this.mapBorderStyle(t.style.border.style)});break}return n}static extractDataBinding(t){if(t.type==="DataField"&&t.data_source_id)return{source_id:t.data_source_id,field_name:this.extractFieldNameFromExpression(t.expression)}}static extractFieldNameFromExpression(t){var l;const n=t.match(/^\{([^}]+)\}$/);return(l=n==null?void 0:n[1])!=null?l:t}static toAppState(t){const n=t.metadata.description||void 0;return{elements:t.elements.map(l=>this.convertTemplateElementToReportElement(l)),canvas_config:this.convertCanvasToCanvasConfig(t.canvas),selected_ids:[],can_undo:!1,can_redo:!1,dirty:!1,...n&&{template_name:n}}}static convertCanvasToCanvasConfig(t){return{width:t.width,height:t.height,zoom:1,offset_x:0,offset_y:0,show_grid:t.grid.enabled,show_rulers:!0,grid_size:t.grid.size,snap_to_grid:t.grid.snap,background_color:t.background.color}}static convertTemplateElementToReportElement(t){const n=this.convertTemplateContentToElementContent(t);return{id:t.id,position:{x:t.position.x,y:t.position.y},size:{width:t.size.width,height:t.size.height},content:n,z_index:t.z_index,visible:t.visible,locked:!1}}static convertTemplateContentToElementContent(t){var n,l,i,s,a,o;switch(t.element_type){case"Text":return{type:"Text",content:t.content.text||"",style:this.convertTemplateStyleToTextStyle(t)};case"DataField":return{type:"DataField",expression:t.content.expression||"{data}",...t.content.format&&{format:t.content.format},style:this.convertTemplateStyleToTextStyle(t),...((n=t.data_binding)==null?void 0:n.source_id)&&{data_source_id:t.data_binding.source_id}};case"Rectangle":return{type:"Rectangle",...((i=(l=t.style)==null?void 0:l.background)==null?void 0:i.color)&&{fill_color:t.style.background.color},...t.content.color&&!((a=(s=t.style)==null?void 0:s.background)!=null&&a.color)&&{fill_color:t.content.color},...((o=t.style)==null?void 0:o.border)&&{border:{color:t.style.border.color,width:t.style.border.width,style:this.mapTemplateBorderStyle(t.style.border.style)}},corner_radius:0,opacity:1};case"Line":return{type:"Line",color:t.content.color||"#000000",width:1,line_style:"Solid",opacity:1};case"Image":return{type:"Image",src:t.content.expression||"",...t.content.text&&{alt:t.content.text}};default:return{type:"Text",content:"Unknown Element",style:this.createDefaultTextStyle()}}}static convertTemplateStyleToTextStyle(t){const n=t.content.font,l=t.content.alignment,i=t.style;return{font_family:(n==null?void 0:n.family)||"Arial",font_size:(n==null?void 0:n.size)||12,font_weight:this.mapTemplateFont(n==null?void 0:n.weight),color:t.content.color||"#000000",align:this.mapTemplateAlignment(l==null?void 0:l.horizontal),background:i!=null&&i.background?{color:i.background.color||"",opacity:1,padding:0}:void 0,border:i!=null&&i.border?{color:i.border.color,width:i.border.width,style:this.mapTemplateBorderStyle(i.border.style),radius:0}:void 0}}static createDefaultTextStyle(){return{font_family:"Arial",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}}static mapFontWeight(t){switch(t){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTemplateFont(t){switch(t){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTextAlign(t){switch(t){case"Center":return"center";case"Right":return"right";default:return"left"}}static mapTemplateAlignment(t){switch(t){case"center":return"Center";case"right":return"Right";default:return"Left"}}static mapBorderStyle(t){switch(t){case"Dashed":return"dashed";case"Dotted":return"dotted";default:return"solid"}}static mapTemplateBorderStyle(t){switch(t){case"dashed":return"Dashed";case"dotted":return"Dotted";default:return"Solid"}}}var ul=m("<span class=text-warning>●"),gl=m("<span class=ml-2> 个元素"),hl=m('<span class="ml-2 text-primary">已选择 <!> 个'),vl=m('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建模板 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开模板 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存模板 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class="toolbar-btn opacity-50 cursor-not-allowed"title="输出预览 - 即将推出 (PDF/打印预览功能)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>输出预览</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const fl=e=>{const{state:t,undo:n,redo:l,updateCanvasConfig:i,setState:s}=Ge(),[a,o]=Y(t.canvas_config.zoom*100),g=async()=>{try{const p=await Et.createEmptyTemplate(),_=Lt.toAppState(p);s(_),console.log("✅ 新建模板成功")}catch(p){console.error("❌ 新建模板失败:",p),alert("新建模板失败")}},c=async()=>{try{const p=await sl({title:"打开模板文件",filters:[{name:"Jasper模板",extensions:["jasper","jbin","jrxml"]}],multiple:!1});if(p&&typeof p=="string"){const _=await Et.loadTemplate(p),C=Lt.toAppState(_);s({...C,template_name:_.metadata.description||"未命名模板"}),console.log("✅ 模板加载成功:",p)}}catch(p){console.error("❌ 加载模板失败:",p),alert("加载模板失败")}},b=async()=>{try{const p=await rl({title:"保存模板文件",filters:[{name:"Jasper模板",extensions:["jasper"]}],defaultPath:t.template_name||"未命名模板"});if(p){const _=Lt.toJasperTemplate(t,{description:t.template_name||"未命名模板"});await Et.saveTemplate(_,p),console.log("✅ 模板保存成功:",p)}}catch(p){console.error("❌ 保存模板失败:",p),alert("保存模板失败")}},u=async p=>{const _=p/100;o(p);try{await i({zoom:_})}catch(C){console.error("Failed to update zoom:",C)}},v=()=>{const p=Math.min(a()+25,500);u(p)},f=()=>{const p=Math.max(a()-25,25);u(p)},d=async()=>{try{await i({show_grid:!t.canvas_config.show_grid})}catch(p){console.error("Failed to toggle grid:",p)}},y=async()=>{try{await i({show_rulers:!t.canvas_config.show_rulers})}catch(p){console.error("Failed to toggle rulers:",p)}},$=async()=>{try{await he("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(p){console.error("Failed to toggle DevTools:",p)}};return(()=>{var p=vl(),_=p.firstChild,C=_.firstChild,E=C.nextSibling,k=E.nextSibling,I=k.nextSibling,N=I.nextSibling,q=N.nextSibling,j=_.nextSibling,D=j.firstChild,L=D.nextSibling,S=L.nextSibling,Q=S.nextSibling,U=Q.nextSibling,w=U.nextSibling,A=w.nextSibling,V=A.nextSibling,z=V.nextSibling,M=z.nextSibling,J=M.nextSibling,de=j.nextSibling,ee=de.firstChild;return C.$$click=g,E.$$click=c,k.$$click=b,r(_,h(Yn,{}),N),N.$$click=()=>{console.log("🔄 数据源按钮被点击！"),e.onOpenDataSources()},q.$$click=()=>{alert(`📄 输出预览即将推出！

✨ 即将支持的功能：
• PDF格式预览
• 打印效果预览
• 分页显示
• 导出设置`)},q.disabled=!0,Te(D,"click",n),Te(L,"click",l),Q.$$click=f,U.addEventListener("change",H=>{const ne=H.target.value;if(ne==="fit")console.log("Fit to window");else{const ve=parseInt(ne.replace("%",""));u(ve)}}),w.$$click=v,V.$$click=d,z.$$click=y,J.$$click=$,r(de,h(R,{get when(){return t.dirty},get children(){return ul()}}),ee),r(ee,()=>t.template_name||"未命名模板"),r(de,h(R,{get when(){return t.elements.length>0},get children(){var H=gl(),ne=H.firstChild;return r(H,()=>t.elements.length,ne),H}}),null),r(de,h(R,{get when(){return t.selected_ids.length>0},get children(){var H=hl(),ne=H.firstChild,ve=ne.nextSibling;return ve.nextSibling,r(H,()=>t.selected_ids.length,ve),H}}),null),P(H=>{var ne=`toolbar-btn-icon ${t.can_undo?"":"opacity-50 cursor-not-allowed"}`,ve=!t.can_undo,ie=`撤销${t.undo_description?` (${t.undo_description})`:""} (Ctrl+Z)`,se=`toolbar-btn-icon ${t.can_redo?"":"opacity-50 cursor-not-allowed"}`,te=!t.can_redo,re=`重做${t.redo_description?` (${t.redo_description})`:""} (Ctrl+Y)`,oe=`toolbar-btn-icon ${t.canvas_config.show_grid?"active":""}`,X=`toolbar-btn-icon ${t.canvas_config.show_rulers?"active":""}`;return ne!==H.e&&$e(D,H.e=ne),ve!==H.t&&(D.disabled=H.t=ve),ie!==H.a&&B(D,"title",H.a=ie),se!==H.o&&$e(L,H.o=se),te!==H.i&&(L.disabled=H.i=te),re!==H.n&&B(L,"title",H.n=re),oe!==H.s&&$e(V,H.s=oe),X!==H.h&&$e(z,H.h=X),H},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),P(()=>U.value=`${Math.round(a())}%`),p})()};De(["click"]);var ml=m('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),bl=m('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const yl=()=>{const{createElement:e}=Ge(),[t,n]=Y(""),l=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:(c==null?void 0:c.text)||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:(c==null?void 0:c.expression)||"${fieldName}",format:c==null?void 0:c.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:(c==null?void 0:c.fill_color)||"transparent",border:{color:(c==null?void 0:c.border_color)||"#000000",width:(c==null?void 0:c.border_width)||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:(c==null?void 0:c.color)||"#000000",width:(c==null?void 0:c.width)||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:(c==null?void 0:c.src)||"",alt:(c==null?void 0:c.alt)||"图片"})}],i=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],s=[...l,...i],a=()=>{const c=t().toLowerCase();return c?s.filter(b=>b.name.toLowerCase().includes(c)||b.description.toLowerCase().includes(c)):s},o=(c,b)=>{if(console.log("Starting drag for component:",c.id),b.dataTransfer){b.dataTransfer.effectAllowed="copy",b.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const u=document.createElement("div");u.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,u.style.position="absolute",u.style.top="-1000px",document.body.appendChild(u),b.dataTransfer.setDragImage(u,50,20),setTimeout(()=>{document.body.removeChild(u)},0)}},g=async c=>{try{const b=await e(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",b)}catch(b){console.error("Failed to create element:",b)}};return(()=>{var c=ml(),b=c.firstChild,u=b.firstChild,v=u.nextSibling,f=b.nextSibling,d=f.firstChild,y=d.firstChild,$=y.firstChild,p=$.nextSibling,_=y.nextSibling,C=_.firstChild,E=C.nextSibling,k=_.nextSibling,I=k.firstChild,N=I.nextSibling;return v.$$input=q=>n(q.target.value),r(p,h(ce,{get each(){return a().filter(q=>q.category==="basic")},children:q=>h(Dt,{component:q,onDrag:j=>o(q,j),onClick:()=>g(q)})})),r(E,h(ce,{get each(){return a().filter(q=>q.category==="data")},children:q=>h(Dt,{component:q,onDrag:j=>o(q,j),onClick:()=>g(q)})})),r(N,h(ce,{get each(){return a().filter(q=>q.category==="bank")},children:q=>h(Dt,{component:q,onDrag:j=>o(q,j),onClick:()=>g(q)})})),P(()=>v.value=t()),c})()},Dt=e=>(()=>{var t=bl(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(t,"click",e.onClick),t.addEventListener("dragstart",s=>e.onDrag(s)),B(t,"draggable",!0),r(l,()=>e.component.icon),r(i,()=>e.component.name),P(()=>B(t,"title",e.component.description)),t})();De(["input","click"]);class we{static async listDataSources(){return he("list_data_sources")}static async deleteDataSource(t){return he("delete_data_source",{source_id:t})}static async updateConfig(t,n){return he("update_data_source_config",{source_id:t,config:n})}static async queryDataSource(t,n){return he("query_data_source",{source_id:t,query:n})}static async getDataPreview(t,n){return he("get_data_preview",{source_id:t,limit:n})}static async testConnection(t,n){return he("test_data_source_connection",{provider_type:t,config:n})}static async discoverSchema(t,n){return he("discover_schema",{provider_type:t,config:n})}static async testDatabaseConnection(t){return he("test_database_connection",{config:t})}static async loadDatabaseSchema(t){return he("load_database_schema",{config:t})}static async executeDatabasePreview(t,n,l){return he("execute_database_preview",{config:t,sql:n,limit:l})}static async validateSqlSyntax(t,n){if(console.log("🔍 验证SQL语法 - 参数:",{sql:t.length+" 字符",databaseType:n}),!t||t.trim().length===0)throw new Error("SQL不能为空");if(!n)throw console.error("❌ databaseType参数为空或未定义:",n),new Error("数据库类型不能为空");try{const l={sql:t,databaseType:n};return console.log("🔍 将传递给Rust的参数:",l),console.log("🔍 参数对象的键:",Object.keys(l)),console.log("🔍 参数JSON:",JSON.stringify(l)),await he("validate_sql_syntax",l)}catch(l){console.error("❌ 调用失败:",l),console.log("🔄 尝试使用database_type键名...");try{return await he("validate_sql_syntax",{sql:t,database_type:n})}catch(i){throw console.error("❌ 容错调用也失败:",i),i}}}static async formatSql(t,n){return he("format_sql",{sql:t,databaseType:n})}static async saveDataSource(t){var n,l;try{const i=t.config;console.log("🔍 saveDataSource 请求参数:",{name:t.name,selected_tables:t.selected_tables,selected_tables_type:typeof t.selected_tables,selected_tables_length:(n=t.selected_tables)==null?void 0:n.length,sql_length:(l=t.sql)==null?void 0:l.length});const s=t.selected_tables||[];console.log("🔍 实际传递的 selectedTables:",s);const a=await he("create_database_source",{name:t.name,description:t.description||null,databaseType:i.database_type,host:i.host,port:i.port,database:i.database,username:i.username,password:i.password||null,sql:t.sql,selectedTables:s,tags:t.tags?t.tags:null});return{success:!0,data_source_id:String(a),message:`数据源 "${t.name}" 创建成功`,warnings:[],errors:[]}}catch(i){return{success:!1,data_source_id:"",message:`保存数据源失败: ${i}`,warnings:[],errors:[String(i)]}}}static async createDataSource(t,n,l){return he("create_data_source",{name:t,provider_type:n,config:l})}static async getPreview(t,n,l){return this.getDataPreview(t,l)}static async queryData(t,n){return this.queryDataSource(t,n||{})}static async evaluateExpression(t,n,l){return he("evaluate_expression",{source_id:t,expression:n,context:l})}static async getAvailableTypes(){return he("get_available_data_source_types")}static async getSchema(t){return he("get_data_source_schema",{source_id:t})}static async getConfigSchema(t){return he("get_config_schema",{provider_type:t})}static async getDefaultConfig(t){return he("get_default_config",{provider_type:t})}static async validateConfig(t,n){return he("validate_config",{provider_type:t,config:n})}static async captureDataPreview(t,n){return this.executeDatabasePreview(t,n,50)}static async validateDataSourceBeforeSave(t){try{console.log("🔍 开始验证数据源保存前检查"),console.log("🔍 请求配置:",t.config),console.log("🔍 数据库类型:",t.config.database_type);const n=await this.testDatabaseConnection(t.config),l=await this.validateSqlSyntax(t.sql,t.config.database_type),i=await this.performSecurityCheck(t.config,t.sql);return{connection_valid:n.success,sql_valid:l.valid,security_passed:i.is_safe,performance_acceptable:!0,warnings:[...l.warnings||[],...i.warnings||[]],errors:[]}}catch(n){return{connection_valid:!1,sql_valid:!1,security_passed:!1,performance_acceptable:!1,warnings:[],errors:[String(n)]}}}static async performSecurityCheck(t,n){const l=[],i=[],s=[/drop\s+table/i,/truncate\s+table/i,/delete\s+from/i,/update\s+.*set/i,/insert\s+into/i,/alter\s+table/i];for(const a of s)if(a.test(n)){l.push("包含可能危险的SQL操作");break}return{is_safe:l.length===0,security_issues:l,warnings:i}}}class pl{constructor(){qe(this,"styles",new Map);qe(this,"elementStyleMap",new Map);qe(this,"observers",new Set);qe(this,"initialized",!1);console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(t){throw console.error("❌ TextStyleManager 初始化失败:",t),t}}createStyle(t){const n=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,l={...t,id:n,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(n,l),this.notifyObservers("style-created",n),this.saveUserStyles(),console.log(`🎨 创建新样式: ${l.name} (${n})`),n}getStyle(t){return this.styles.get(t)||null}updateStyle(t,n){const l=this.styles.get(t);if(!l)return console.warn(`⚠️ 样式 ${t} 不存在`),!1;if(l.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${t}`),!1;const i={...l,style:{...l.style,...n},metadata:{...l.metadata,lastModified:new Date}};return this.styles.set(t,i),this.syncAllStyleInstances(t),this.saveUserStyles(),this.notifyObservers("style-updated",t),console.log(`🔄 样式已更新: ${l.name} (${t})`),!0}deleteStyle(t){const n=this.styles.get(t);if(!n)return!1;if(n.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${t}`),!1;const l=Array.from(this.elementStyleMap.entries()).filter(([i,s])=>s===t).map(([i,s])=>i);return l.length>0?(console.warn(`⚠️ 无法删除样式 ${t}，仍有 ${l.length} 个元素在使用`),!1):(this.styles.delete(t),this.saveUserStyles(),this.notifyObservers("style-deleted",t),console.log(`🗑️ 样式已删除: ${n.name} (${t})`),!0)}applyStyleToElement(t,n){const l=this.styles.get(n);if(!l)return{success:!1,elementId:t,styleId:n,appliedAt:new Date,error:`样式 ${n} 不存在`};try{const i=this.elementStyleMap.get(t);if(this.elementStyleMap.set(t,n),l.metadata.usageCount++,i&&i!==n){const s=this.styles.get(i);s&&(s.metadata.usageCount=Math.max(0,s.metadata.usageCount-1))}return this.applyStyleToDOM(t,l.style),this.notifyObservers("style-applied",{elementId:t,styleId:n}),console.log(`🎯 应用样式: ${l.name} → 元素 ${t}`),{success:!0,elementId:t,styleId:n,appliedAt:new Date}}catch(i){return console.error(`❌ 应用样式失败: ${i}`),{success:!1,elementId:t,styleId:n,appliedAt:new Date,error:i instanceof Error?i.message:String(i)}}}getElementStyleId(t){return this.elementStyleMap.get(t)||null}removeElementStyle(t){const n=this.elementStyleMap.get(t);if(n){this.elementStyleMap.delete(t);const l=this.styles.get(n);l&&(l.metadata.usageCount=Math.max(0,l.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${t}`)}}getStylesByCategory(t){const n=Array.from(this.styles.values());return(t?n.filter(i=>i.category===t):n).sort((i,s)=>i.metadata.isSystemStyle!==s.metadata.isSystemStyle?i.metadata.isSystemStyle?-1:1:s.metadata.usageCount-i.metadata.usageCount)}searchStyles(t,n){const l=this.getStylesByCategory(n),i=t.toLowerCase().trim();return i?l.filter(s=>s.name.toLowerCase().includes(i)||s.description.toLowerCase().includes(i)||s.metadata.tags.some(a=>a.toLowerCase().includes(i))):l}getStyleUsageStats(){const t=[];for(const[n,l]of this.styles){const i=Array.from(this.elementStyleMap.entries()).filter(([s,a])=>a===n).map(([s,a])=>s);t.push({styleId:n,usageCount:i.length,elements:i,lastUsed:l.metadata.lastModified})}return t.sort((n,l)=>l.usageCount-n.usageCount)}cleanupUnusedStyles(){const t=new Set(this.elementStyleMap.values()),n=[];for(const[l,i]of this.styles)!t.has(l)&&!i.metadata.isSystemStyle&&(this.styles.delete(l),n.push(l),console.log(`🧹 清理未使用样式: ${i.name} (${l})`));return n.length>0&&this.saveUserStyles(),n}exportStyles(t){const n=t?t.map(i=>this.styles.get(i)).filter(Boolean):Array.from(this.styles.values()),l=new Set(n.map(i=>i.category));return{version:"2.0.0",exportedAt:new Date,styles:n,metadata:{totalStyles:n.length,categories:Array.from(l),author:"user"}}}async importStyles(t){const n=[];for(const l of t.styles){if(Array.from(this.styles.values()).find(a=>a.name===l.name&&a.category===l.category)){console.warn(`⚠️ 跳过已存在的样式: ${l.name}`);continue}const s=this.createStyle({name:l.name,description:l.description,category:l.category,style:l.style,...l.inheritance&&{inheritance:l.inheritance}});n.push(s)}return console.log(`📦 导入完成，共导入 ${n.length} 个样式`),n}addObserver(t){this.observers.add(t)}removeObserver(t){this.observers.delete(t)}syncAllStyleInstances(t){const n=this.styles.get(t);if(!n)return;const l=[];for(const[i,s]of this.elementStyleMap)s===t&&(this.applyStyleToDOM(i,n.style),l.push(i));this.notifyObservers("styles-synced",{styleId:t,affectedElements:l}),console.log(`🔄 样式同步完成: ${t} → ${l.length} 个元素`)}applyStyleToDOM(t,n){console.log(`🎨 应用样式到DOM: 元素 ${t}`,{font_family:n.font_family,font_size:n.font_size,typography:n.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:t}=await cl(async()=>{const{BANK_TEXT_STYLES:n}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:n}},[]);for(const n of t)this.styles.set(n.id,n);console.log(`🏦 加载了 ${t.length} 个银行预设样式`)}catch(t){console.warn("⚠️ 加载系统样式失败:",t)}}async loadUserStyles(){try{const t=localStorage.getItem("jasper-text-styles");if(t){const n=JSON.parse(t);for(const l of n)l.metadata.createdAt=new Date(l.metadata.createdAt),l.metadata.lastModified=new Date(l.metadata.lastModified),this.styles.set(l.id,l);console.log(`👤 加载了 ${n.length} 个用户自定义样式`)}}catch(t){console.warn("⚠️ 加载用户样式失败:",t)}}saveUserStyles(){try{const t=Array.from(this.styles.values()).filter(n=>!n.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(t)),console.log(`💾 保存了 ${t.length} 个用户自定义样式`)}catch(t){console.error("❌ 保存用户样式失败:",t)}}notifyObservers(t,n){for(const l of this.observers)try{l.onStyleChange(t,n)}catch(i){console.error("❌ 观察者通知失败:",i)}}}const Me=new pl;class $l{calculateUnifiedBounds(t,n,l){const i=this.calculateFontMetrics(n),s=this.measureTextContent(t,n,l.width),a=this.calculateContainerHeight(s,i,l.height),o=this.calculateTextPositioning(n,l,a,i),g={containerBounds:{x:0,y:0,width:l.width,height:a},contentBounds:s.bounds,fontMetrics:i,positioning:o};return s.wrappedLines&&(g.textLayout={wrappedLines:s.wrappedLines,isWrapped:!0,originalLineCount:t.split(`
`).length,wrappedLineCount:s.wrappedLines.length}),g}calculateFontMetrics(t){const n=t.font_size,l=1.2,i=.75,s=.25,a=n*i,o=n*s;return{fontSize:n,lineHeight:n*l,ascender:a,descender:o,baseline:a}}getCharacterWidth(t,n){const l=n.font_size,i=n.font_family,s=/[\u4e00-\u9fa5]/.test(t),a={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},o=i.toLowerCase();let g=a.default;for(const[b,u]of Object.entries(a))if(o.includes(b.toLowerCase())||b.toLowerCase().includes(o)){g=u;break}const c=s?g.chinese:g.english;return l*c}calculateTextWidth(t,n){let l=0;for(const i of t)i!==`
`&&(l+=this.getCharacterWidth(i,n));return l}measureTextContent(t,n,l=0){const i=t.split(`
`),s=i.length;let a=0;for(const c of i){const b=this.calculateTextWidth(c,n);a=Math.max(a,b)}if(l>0&&a>l)return this.calculateWrappedText(t,n,l);const o=l>0?Math.min(a,l):a,g=s*n.font_size*1.2;return{bounds:{x:0,y:0,width:o,height:g},lineCount:s,actualHeight:g}}calculateWrappedText(t,n,l){const i=this.getCharacterWidth("测",n);if(Math.floor(l/i)<1||l<i)return{bounds:{x:0,y:0,width:l,height:n.font_size*1.2},lineCount:1,actualHeight:n.font_size*1.2,wrappedLines:["..."]};const a=this.smartSegmentation(t);let o=[],g="",c=0;for(const u of a){const v=this.calculateTextWidth(u,n),f=c+v;if(f>l)if(g.trim())o.push(g.trim()),g=u,c=v;else{const{truncated:d,remaining:y}=this.forceTruncateSegment(u,l,n);o.push(d),g=y,c=this.calculateTextWidth(y,n)}else g+=u,c=f}g.trim()&&o.push(g.trim());const b=o.length*n.font_size*1.2;return{bounds:{x:0,y:0,width:l,height:b},lineCount:o.length,actualHeight:b,wrappedLines:o}}forceTruncateSegment(t,n,l){let i="",s=0,a=0;for(a=0;a<t.length;a++){const g=t[a];if(!g)break;const c=this.getCharacterWidth(g,l);if(s+c>n)break;i+=g,s+=c}const o=t.substring(a);return{truncated:i,remaining:o}}smartSegmentation(t){const n=[];let l="";for(let i=0;i<t.length;i++){const s=t[i];s&&(/[\u4e00-\u9fa5]/.test(s)?(l&&(n.push(l),l=""),n.push(s)):s===`
`?(l&&(n.push(l),l=""),n.push(`
`)):s===" "?l?(n.push(l+" "),l=""):n.push(" "):l+=s)}return l&&n.push(l),n.filter(i=>i.length>0)}calculateContainerHeight(t,n,l){const i=n.lineHeight*t.lineCount,s=n.ascender+n.descender,a=n.lineHeight,o=Math.max(i,s,a);return Math.max(o,l)}calculateTextPositioning(t,n,l,i){var b;const s=this.calculateHorizontalAnchor(t.align,n.width),a=i.baseline,o=((b=t.background)==null?void 0:b.padding)||0,g=-o,c=-o;return{textAnchorX:s,textAnchorY:a,backgroundX:g,backgroundY:c}}calculateHorizontalAnchor(t,n){switch(t){case"Left":return 0;case"Center":return n/2;case"Right":return n;default:return 0}}getTextAnchor(t){switch(t){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(t,n){}}const et=new $l;class _l{constructor(){qe(this,"initialized",!1);this.initialize()}async initialize(){if(!this.initialized)try{await Me.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(t){console.error("❌ ProfessionalTextRenderer 初始化失败:",t)}}isElementUsingProfessionalStyle(t){return Me.getElementStyleId(t)!==null}adaptLegacyTextStyle(t){return{...t,font_weight:t.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:t.color}}],effects:[]}}renderProfessionalText(t,n=!1){if(t.content.type!=="Text"&&t.content.type!=="DataField")return null;const l=Me.getElementStyleId(t.id);let i;if(l){const o=Me.getStyle(l);if(!o)return console.warn(`⚠️ 找不到样式定义: ${l}`),null;i=o.style,console.log(`🎨 使用专业样式渲染: ${o.name} (${l})`)}else{const o=t.content.type==="Text"||t.content.type==="DataField"?t.content.style:null;if(!o)return null;i=this.adaptLegacyTextStyle(o),console.log("🔄 适配传统样式到专业排版系统")}const s=this.calculateEnhancedBounds(t.content.type==="Text"?t.content.content:t.content.expression||"[数据字段]",i,t.size);return{element:this.createProfessionalTextElement(s,t.content.type==="Text"?t.content.content:t.content.expression||"[数据字段]",i,!1),bounds:s,style:i}}calculateEnhancedBounds(t,n,l){const i=et.calculateUnifiedBounds(t,n,l),s=n.typography,a=this.calculateLetterSpacingEffect(t,s.letterSpacing),o=this.calculateLineHeightEffect(t,n.font_size,s.lineHeight),g=this.calculateParagraphSpacingEffect(t,s.paragraphSpacing);return{containerBounds:i.containerBounds,positioning:i.positioning,fontMetrics:i.fontMetrics,typography:{adjustedWidth:i.containerBounds.width+a.widthIncrease,adjustedHeight:i.containerBounds.height+o.heightIncrease+g.heightIncrease,letterSpacingData:a,lineHeightData:o,paragraphData:g}}}calculateLetterSpacingEffect(t,n){const l=t.split(`
`),i=l.reduce((a,o)=>a+o.length,0),s=Math.max(0,i-l.length);return{spacingValue:n,totalSpaces:s,widthIncrease:s*n,charPositions:[]}}calculateLineHeightEffect(t,n,l){const s=t.split(`
`).length,a=n*l,o=n*1.2,g=a-o;return{lineHeightRatio:l,actualLineHeight:a,lineCount:s,heightIncrease:g*Math.max(0,s-1),baselinePositions:[]}}calculateParagraphSpacingEffect(t,n){const i=t.split(`

`).length;return{spacing:n,paragraphCount:i,heightIncrease:n*Math.max(0,i-1),paragraphPositions:[]}}createProfessionalTextElement(t,n,l,i){const s=document.createElementNS("http://www.w3.org/2000/svg","g");return s.setAttribute("class","professional-text-container"),this.renderMultipleFills(s,t,l.fills),this.renderEffects(s,t,l.effects),this.renderTypographyText(s,t,n,l),this.renderTextDecorations(s,t,n,l.typography.decoration),s}renderMultipleFills(t,n,l){if(l&&l.length>0&&l[0].enabled){const i=l[0];i.type==="solid"&&i.solid&&console.log("🎨 应用纯色填充:",i.solid.color)}}renderEffects(t,n,l){if(!l||l.length===0)return;const i=document.createElementNS("http://www.w3.org/2000/svg","defs"),s=document.createElementNS("http://www.w3.org/2000/svg","filter"),a=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;s.id=a;for(const o of l)if(o.enabled&&o.type==="drop-shadow"&&o.dropShadow){const g=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");g.setAttribute("dx",o.dropShadow.offsetX.toString()),g.setAttribute("dy",o.dropShadow.offsetY.toString()),g.setAttribute("stdDeviation",o.dropShadow.blur.toString()),g.setAttribute("flood-color",o.dropShadow.color),g.setAttribute("flood-opacity",o.dropShadow.opacity.toString()),s.appendChild(g),console.log("✨ 应用投影效果")}s.children.length>0&&(i.appendChild(s),t.appendChild(i),t.setAttribute("filter",`url(#${a})`))}renderTypographyText(t,n,l,i){var g,c;const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("font-family",i.font_family),s.setAttribute("font-size",i.font_size.toString()),s.setAttribute("font-weight",i.font_weight),s.setAttribute("fill",((c=(g=i.fills[0])==null?void 0:g.solid)==null?void 0:c.color)||i.color),s.setAttribute("text-anchor",this.getTextAnchor(i.align));const a=l.split(`
`),o=i.typography;a.forEach((b,u)=>{const v=document.createElementNS("http://www.w3.org/2000/svg","tspan");o.letterSpacing!==0&&v.setAttribute("letter-spacing",`${o.letterSpacing}px`);const f=n.positioning.textAnchorY+u*n.typography.lineHeightData.actualLineHeight;if(v.setAttribute("x",n.positioning.textAnchorX.toString()),v.setAttribute("y",f.toString()),u===0&&o.textIndent!==0){const d=n.positioning.textAnchorX+o.textIndent;v.setAttribute("x",d.toString())}o.textTransform&&o.textTransform!=="none"?v.textContent=this.applyTextTransform(b,o.textTransform):v.textContent=b,s.appendChild(v)}),t.appendChild(s)}renderTextDecorations(t,n,l,i){if(!i.underline&&!i.strikethrough&&!i.overline)return;const s=l.split(`
`),a=i.decorationColor||"#000000",o=i.decorationThickness||1,g=i.decorationStyle==="dashed"?"4,2":i.decorationStyle==="dotted"?"1,1":"none";s.forEach((c,b)=>{if(!c.trim())return;const u=n.positioning.textAnchorY+b*n.typography.lineHeightData.actualLineHeight,v=c.length*n.fontMetrics.fontSize*.6,f=n.positioning.textAnchorX,d=f+v;if(i.underline){const y=u+n.fontMetrics.fontSize*.1;this.createDecorationLine(t,f,y,d,y,a,o,g,"underline")}if(i.strikethrough){const y=u-n.fontMetrics.fontSize*.3;this.createDecorationLine(t,f,y,d,y,a,o,g,"strikethrough")}if(i.overline){const y=u-n.fontMetrics.fontSize*.8;this.createDecorationLine(t,f,y,d,y,a,o,g,"overline")}})}createDecorationLine(t,n,l,i,s,a,o,g,c){const b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",n.toString()),b.setAttribute("y1",l.toString()),b.setAttribute("x2",i.toString()),b.setAttribute("y2",s.toString()),b.setAttribute("stroke",a),b.setAttribute("stroke-width",o.toString()),b.setAttribute("stroke-dasharray",g),b.setAttribute("class",`text-decoration-${c}`),t.appendChild(b)}getTextAnchor(t){switch(t){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(t,n){switch(n){case"uppercase":return t.toUpperCase();case"lowercase":return t.toLowerCase();case"capitalize":return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();default:return t}}}const xl=new _l;var Sl=m("<button class=search-clear title=清除搜索>✕"),wl=m('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),Cl=m("<button><span class=category-icon></span><span class=category-label>"),kl=m("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),Tl=m("<span class=usage-count>"),El=m("<button class=edit-button title=编辑样式>✏️"),Ll=m("<span class=system-badge title=系统预设样式>🔒"),Dl=m("<div class=selection-indicator>✓");const Pl=e=>{const[t,n]=Y("bank-special"),[l,i]=Y(""),[s,a]=Y([]);(async()=>{await Me.initialize();const v=Me.getStylesByCategory();a(v)})();const g=Ce(()=>{let v=s();t()&&(v=v.filter(d=>d.category===t()));const f=l().toLowerCase().trim();return f&&(v=v.filter(d=>d.name.toLowerCase().includes(f)||d.description.toLowerCase().includes(f)||d.metadata.tags.some(y=>y.toLowerCase().includes(f)))),v}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],b=v=>{console.log("🎯 选择样式:",v),e.onStyleSelect(v)},u=v=>{n(v),console.log("📂 切换分类:",v)};return(()=>{var v=wl(),f=v.firstChild,d=f.nextSibling,y=d.firstChild,$=y.firstChild,p=$.nextSibling,_=d.nextSibling,C=_.firstChild,E=_.nextSibling,k=E.firstChild,I=k.firstChild;return r(f,h(ce,{each:c,children:N=>(()=>{var q=Cl(),j=q.firstChild,D=j.nextSibling;return q.$$click=()=>u(N.key),r(j,()=>N.icon),r(D,()=>N.label),P(L=>{var S=`category-button ${t()===N.key?"active":""}`,Q=N.label;return S!==L.e&&$e(q,L.e=S),Q!==L.t&&B(q,"title",L.t=Q),L},{e:void 0,t:void 0}),q})()})),p.$$input=N=>i(N.target.value),r(y,h(R,{get when(){return l()},get children(){var N=Sl();return N.$$click=()=>i(""),N}}),null),r(_,h(ce,{get each(){return g()},children:N=>h(Al,{style:N,get selected(){return e.selectedStyleId===N.id},onClick:()=>b(N.id),onEdit:()=>e.onStyleEdit(N.id)})}),C),Te(C,"click",e.onStyleCreate),r(k,()=>g().length,I),r(k,(()=>{var N=_e(()=>!!l());return()=>N()&&` (搜索: "${l()}")`})(),null),P(()=>p.value=l()),v})()},Al=e=>{const t=()=>{switch(e.style.category){case"bank-special":return e.style.id.includes("amount")?"¥123,456.78":e.style.id.includes("account")?"6222 0012 3456 7890":e.style.id.includes("institution")?e.style.name:e.style.id.includes("date")?"2025-08-19":e.style.name;case"heading":return e.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return e.style.name}},n=Ce(()=>{var a,o,g,c,b,u,v,f;const s=e.style.style;return{fontFamily:s.font_family,fontSize:`${Math.min(s.font_size,14)}px`,fontWeight:s.font_weight,color:((g=(o=(a=s.fills)==null?void 0:a[0])==null?void 0:o.solid)==null?void 0:g.color)||s.color,textAlign:s.align.toLowerCase(),letterSpacing:`${((c=s.typography)==null?void 0:c.letterSpacing)||0}px`,textDecoration:(u=(b=s.typography)==null?void 0:b.decoration)!=null&&u.underline?"underline":(f=(v=s.typography)==null?void 0:v.decoration)!=null&&f.strikethrough?"line-through":"none"}}),l=s=>{s.preventDefault(),e.onClick()},i=s=>{s.preventDefault(),s.stopPropagation(),e.onEdit()};return(()=>{var s=kl(),a=s.firstChild,o=a.nextSibling,g=o.firstChild,c=g.nextSibling,b=c.firstChild,u=o.nextSibling;return s.$$click=l,r(a,t),r(g,()=>e.style.name),r(b,()=>zl(e.style.category)),r(c,(()=>{var v=_e(()=>e.style.metadata.usageCount>0);return()=>v()&&(()=>{var f=Tl();return r(f,()=>e.style.metadata.usageCount),P(()=>B(f,"title",`使用次数: ${e.style.metadata.usageCount}`)),f})()})(),null),r(u,(()=>{var v=_e(()=>!e.style.metadata.isSystemStyle);return()=>v()&&(()=>{var f=El();return f.$$click=i,f})()})(),null),r(u,(()=>{var v=_e(()=>!!e.style.metadata.isSystemStyle);return()=>v()&&Ll()})(),null),r(s,(()=>{var v=_e(()=>!!e.selected);return()=>v()&&Dl()})(),null),P(v=>{var f=`style-card ${e.selected?"selected":""} ${e.style.metadata.isSystemStyle?"system-style":"user-style"}`,d=n();return f!==v.e&&$e(s,v.e=f),v.t=un(a,d,v.t),v},{e:void 0,t:void 0}),s})()};function zl(e){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[e]||e}De(["input","click"]);var Rl=m("<button class=style-picker-toggle>"),Ml=m("<button class=style-reload-btn title=重新加载样式系统>🔄"),Nl=m("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),Ol=m("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),Il=m("<div class=style-picker-panel>"),Ul=m("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),Fl=m("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),ql=m('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),Bl=m("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),jl=m('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const Vt=e=>{const[t,n]=Y(null),[l,i]=Y(!1),[s,a]=Y([]),[o,g]=Y(!1);Ue(async()=>{try{await Me.initialize();const p=Me.getElementStyleId(e.element.id);n(p);const _=Me.getStylesByCategory();a(_),g(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch(p){console.error("❌ 专业文字属性面板初始化失败:",p)}});const c=Ce(()=>{const p=t();return p?Me.getStyle(p):null}),b=Ce(()=>e.element.content.type==="Text"||e.element.content.type==="DataField"),u=async p=>{try{const _=await Me.applyStyleToElement(e.element.id,p);if(_.success){n(p);const C=Me.getStyle(p);if(C){const E=v(C.style);e.onUpdate(e.element.id,"content",{...e.element.content,style:E})}console.log("✅ 样式应用成功:",_)}else console.error("❌ 样式应用失败:",_.error)}catch(_){console.error("❌ 样式选择处理失败:",_)}},v=p=>{var _,C,E;return{font_family:p.font_family,font_size:p.font_size,font_weight:p.font_weight,color:((E=(C=(_=p.fills)==null?void 0:_[0])==null?void 0:C.solid)==null?void 0:E.color)||p.color,align:p.align}},f=()=>{console.log("🆕 创建新样式")},d=p=>{console.log("✏️ 编辑样式:",p)},y=()=>{i(!l())},$=()=>{t()&&(Me.removeElementStyle(e.element.id),n(null),console.log("🗑️ 移除元素样式"))};return b()?(()=>{var p=Bl(),_=p.firstChild,C=_.firstChild,E=C.firstChild,k=E.nextSibling,I=k.nextSibling,N=C.nextSibling;return r(I,h(R,{get when(){return o()},get children(){var q=Rl();return q.$$click=y,r(q,()=>l()?"📝":"📚"),P(()=>B(q,"title",l()?"隐藏样式库":"显示样式库")),q}}),null),r(I,h(R,{get when(){return!o()},get children(){var q=Ml();return q.$$click=()=>window.location.reload(),q}}),null),r(N,h(R,{get when(){return!o()},get children(){var q=Nl(),j=q.firstChild,D=j.firstChild,L=D.nextSibling,S=L.nextSibling,Q=S.firstChild;return Q.$$click=async()=>{try{await Me.initialize();const U=Me.getStylesByCategory();a(U),g(!0),console.log("🔄 样式系统重新初始化成功")}catch(U){console.error("❌ 重新初始化失败:",U)}},q}}),null),r(N,h(R,{get when(){return o()},get children(){return[h(R,{get when(){return c()},children:q=>(()=>{var j=jl(),D=j.firstChild,L=D.firstChild,S=L.firstChild,Q=S.nextSibling,U=L.nextSibling,w=U.firstChild,A=w.nextSibling;return r(S,()=>q().name),r(Q,()=>Ql(q().category)),w.$$click=()=>d(q().id),A.$$click=$,j})()}),h(R,{get when(){return!c()},get children(){var q=Ol(),j=q.firstChild,D=j.nextSibling;return j.$$click=y,D.$$click=f,q}}),h(R,{get when(){return l()},get children(){var q=Il();return r(q,h(Pl,{get selectedStyleId(){return t()},onStyleSelect:u,onStyleCreate:f,onStyleEdit:d})),q}})]}}),null),r(p,h(R,{get when(){return c()},get children(){return Ul()}}),null),r(p,h(R,{get when(){return c()},get children(){return Fl()}}),null),r(p,h(R,{get when(){return!1},get children(){var q=ql(),j=q.firstChild,D=j.nextSibling,L=D.firstChild,S=L.firstChild,Q=S.firstChild,U=Q.nextSibling,w=S.nextSibling,A=w.firstChild,V=A.nextSibling,z=w.nextSibling,M=z.firstChild,J=M.nextSibling,de=J.firstChild,ee=z.nextSibling,H=ee.firstChild,ne=H.nextSibling;return r(U,()=>e.element.id),r(V,()=>t()||"无"),r(J,()=>s().length,de),r(ne,()=>xl.isElementUsingProfessionalStyle(e.element.id)?"是":"否"),q}}),null),p})():null};function Ql(e){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[e]||e}De(["click"]);var Hl=m('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),Jl=m('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),Vl=m("<span class=property-value>"),Wl=m('<span class="property-value text-xs text-muted">'),wt=m("<div class=space-y-2>"),rt=m("<input type=number class=property-input>"),Gl=m('<div class="grid grid-cols-2 gap-2">'),Wt=m("<input type=checkbox class=property-checkbox>"),Kl=m('<div class="p-4 space-y-4">'),Gt=m("<div>"),Yl=m("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),Xl=m("<div class=property-field><label class=property-label>"),Zl=m("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),$n=m('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),_n=m("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),ei=m('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),xn=m("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),ti=m('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),Sn=m('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),wn=m('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),ni=m('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),li=m("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),Kt=m("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),ii=m('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),si=m("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),ri=m("<input type=text class=property-input placeholder=图片描述文字>"),ai=m("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),oi=m("<div class=space-y-3>"),ci=m("<img class=property-image>"),di=m("<div class=property-loading>加载数据源..."),ui=m('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),gi=m('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),hi=m('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),vi=m('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),fi=m("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),mi=m("<div class=space-y-4>"),bi=m("<select class=property-select><option value>选择数据源"),yi=m("<option> (<!>)"),pi=m('<div class=flex><input type=number class="property-input flex-1">'),$i=m("<span class=property-unit>"),_i=m('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),xi=m("<div class=property-alignment-group>"),Si=m("<button>");const wi=()=>{const{state:e,updateElement:t}=Ge(),n=Ce(()=>{const s=new Set(e.selected_ids);return e.elements.filter(a=>s.has(a.id))}),l=Ce(()=>n()[0]),i=async(s,a,o)=>{try{await t(s,{[a]:o})}catch(g){console.error("Failed to update element property:",g)}};return(()=>{var s=Hl(),a=s.firstChild,o=a.nextSibling;return r(o,h(R,{get when(){return l()},get fallback(){return Jl()},get children(){return h(Ci,{get element(){return l()},onUpdate:i})}})),s})()},Ci=e=>{const t=(l,i)=>{const s={...e.element.position,[l]:i};e.onUpdate(e.element.id,"position",s)},n=(l,i)=>{const s={...e.element.size,[l]:Math.max(1,i)};e.onUpdate(e.element.id,"size",s)};return(()=>{var l=Kl();return r(l,h(Ve,{title:"元素信息",icon:"ℹ️",get children(){var i=wt();return r(i,h(pe,{label:"类型",get children(){var s=Vl();return r(s,()=>e.element.content.type),s}}),null),r(i,h(pe,{label:"ID",get children(){var s=Wl();return r(s,()=>e.element.id),s}}),null),i}}),null),r(l,h(Ve,{title:"位置和大小",icon:"📐",get children(){var i=Gl();return r(i,h(pe,{label:"X",get children(){var s=rt();return s.$$input=a=>t("x",parseFloat(a.target.value)||0),P(()=>s.value=e.element.position.x),s}}),null),r(i,h(pe,{label:"Y",get children(){var s=rt();return s.$$input=a=>t("y",parseFloat(a.target.value)||0),P(()=>s.value=e.element.position.y),s}}),null),r(i,h(pe,{label:"宽度",get children(){var s=rt();return s.$$input=a=>n("width",parseFloat(a.target.value)||1),P(()=>s.value=e.element.size.width),s}}),null),r(i,h(pe,{label:"高度",get children(){var s=rt();return s.$$input=a=>n("height",parseFloat(a.target.value)||1),P(()=>s.value=e.element.size.height),s}}),null),i}}),null),r(l,h(Ve,{title:"状态",icon:"👁️",get children(){var i=wt();return r(i,h(pe,{label:"可见",get children(){var s=Wt();return s.addEventListener("change",a=>e.onUpdate(e.element.id,"visible",a.target.checked)),P(()=>s.checked=e.element.visible),s}}),null),r(i,h(pe,{label:"锁定",get children(){var s=Wt();return s.addEventListener("change",a=>e.onUpdate(e.element.id,"locked",a.target.checked)),P(()=>s.checked=e.element.locked),s}}),null),r(i,h(pe,{label:"层级",get children(){var s=rt();return s.$$input=a=>e.onUpdate(e.element.id,"z_index",parseInt(a.target.value)||0),P(()=>s.value=e.element.z_index),s}}),null),i}}),null),r(l,h(qn,{get children(){return[h(st,{get when(){return e.element.content.type==="Text"&&e.element.content},children:i=>(()=>{var s=Gt();return r(s,h(Vt,{get element(){return e.element},get onUpdate(){return e.onUpdate}}),null),r(s,h(ki,{get content(){return i()},onUpdate:a=>{console.log("Text content update:",a),e.onUpdate(e.element.id,"content",a)}}),null),s})()}),h(st,{get when(){return e.element.content.type==="Rectangle"&&e.element.content},children:i=>h(Ti,{get content(){return i()},onUpdate:s=>{console.log("Rectangle content update:",s),e.onUpdate(e.element.id,"content",s)}})}),h(st,{get when(){return e.element.content.type==="Line"&&e.element.content},children:i=>h(Ei,{get content(){return i()},onUpdate:s=>{console.log("Line content update:",s),e.onUpdate(e.element.id,"content",s)}})}),h(st,{get when(){return e.element.content.type==="Image"&&e.element.content},children:i=>h(Li,{get content(){return i()},onUpdate:s=>{console.log("Image content update:",s),e.onUpdate(e.element.id,"content",s)}})}),h(st,{get when(){return e.element.content.type==="DataField"&&e.element.content},children:i=>(()=>{var s=Gt();return r(s,h(Vt,{get element(){return e.element},get onUpdate(){return e.onUpdate}}),null),r(s,h(Di,{get content(){return i()},onUpdate:a=>{console.log("DataField content update:",a),e.onUpdate(e.element.id,"content",a)}}),null),s})()})]}}),null),l})()},Ve=e=>(()=>{var t=Yl(),n=t.firstChild,l=n.firstChild,i=l.nextSibling,s=n.nextSibling;return r(l,()=>e.icon),r(i,()=>e.title),r(s,()=>e.children),t})(),pe=e=>(()=>{var t=Xl(),n=t.firstChild;return r(n,()=>e.label),r(t,()=>e.children,null),t})(),ki=e=>h(Ve,{title:"文字样式",icon:"🔤",get children(){var t=Sn(),n=t.firstChild,l=n.nextSibling;return r(t,h(pe,{label:"内容",get children(){var i=Zl();return i.$$input=s=>e.onUpdate({content:s.target.value}),P(()=>i.value=e.content.content),i}}),n),r(n,h(pe,{label:"字体",get children(){var i=$n();return i.addEventListener("change",s=>e.onUpdate({style:{...e.content.style,font_family:s.target.value}})),P(()=>i.value=e.content.style.font_family),i}}),null),r(n,h(pe,{label:"大小",get children(){return h(He,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:i=>e.onUpdate({style:{...e.content.style,font_size:i}})})}}),null),r(l,h(pe,{label:"字重",get children(){var i=_n();return i.addEventListener("change",s=>e.onUpdate({style:{...e.content.style,font_weight:s.target.value}})),P(()=>i.value=e.content.style.font_weight),i}}),null),r(l,h(pe,{label:"对齐",get children(){return h(Cn,{get value(){return e.content.style.align},onUpdate:i=>e.onUpdate({style:{...e.content.style,align:i}})})}}),null),r(t,h(pe,{label:"颜色",get children(){return h(Ye,{get value(){return e.content.style.color},onUpdate:i=>e.onUpdate({style:{...e.content.style,color:i}})})}}),null),r(t,h(pe,{label:"背景",get children(){var i=ei(),s=i.firstChild;return r(i,h(Ye,{get value(){var a;return((a=e.content.style.background)==null?void 0:a.color)||"transparent"},onUpdate:a=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,color:a}}})}),s),r(s,h(pe,{label:"透明度",get children(){return h(He,{get value(){var a;return((a=e.content.style.background)==null?void 0:a.opacity)||1},min:0,max:1,step:.1,onUpdate:a=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,opacity:a}}})})}}),null),r(s,h(pe,{label:"内边距",get children(){return h(He,{get value(){var a;return((a=e.content.style.background)==null?void 0:a.padding)||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,padding:a}}})})}}),null),i}}),null),r(t,h(pe,{label:"边框",get children(){var i=ti(),s=i.firstChild;return r(i,h(Ye,{get value(){var a;return((a=e.content.style.border)==null?void 0:a.color)||"#000000"},onUpdate:a=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,color:a}}})}),s),r(s,h(pe,{label:"宽度",get children(){return h(He,{get value(){var a;return((a=e.content.style.border)==null?void 0:a.width)||1},min:0,max:10,step:.5,unit:"px",onUpdate:a=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,width:a}}})})}}),null),r(s,h(pe,{label:"样式",get children(){var a=xn();return a.addEventListener("change",o=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,style:o.target.value}}})),P(()=>{var o;return a.value=((o=e.content.style.border)==null?void 0:o.style)||"Solid"}),a}}),null),r(s,h(pe,{label:"圆角",get children(){return h(He,{get value(){var a;return((a=e.content.style.border)==null?void 0:a.radius)||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,radius:a}}})})}}),null),i}}),null),t}}),Ti=e=>h(Ve,{title:"矩形样式",icon:"▭",get children(){var t=ni(),n=t.firstChild,l=n.firstChild;return r(t,h(pe,{label:"填充颜色",get children(){return h(Ye,{get value(){return e.content.fill_color||"#ffffff"},onUpdate:i=>e.onUpdate({fill_color:i})})}}),n),r(n,h(pe,{label:"边框",get children(){var i=wt();return r(i,h(Ye,{get value(){var s;return((s=e.content.border)==null?void 0:s.color)||"#000000"},onUpdate:s=>e.onUpdate({border:{...e.content.border,color:s}})})),i}}),l),r(l,h(pe,{label:"宽度",get children(){return h(He,{get value(){var i;return((i=e.content.border)==null?void 0:i.width)||1},min:0,max:20,step:.5,unit:"px",onUpdate:i=>e.onUpdate({border:{...e.content.border,width:i}})})}}),null),r(l,h(pe,{label:"样式",get children(){var i=xn();return i.addEventListener("change",s=>e.onUpdate({border:{...e.content.border,style:s.target.value}})),P(()=>{var s;return i.value=((s=e.content.border)==null?void 0:s.style)||"Solid"}),i}}),null),r(t,h(pe,{label:"圆角半径",get children(){return h(He,{get value(){return e.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:i=>e.onUpdate({corner_radius:i})})}}),null),r(t,h(pe,{label:"透明度",get children(){var i=wn(),s=i.firstChild,a=s.nextSibling,o=a.firstChild;return s.$$input=g=>e.onUpdate({opacity:parseFloat(g.target.value)/100}),r(a,()=>Math.round((e.content.opacity||1)*100),o),P(()=>s.value=(e.content.opacity||1)*100),i}}),null),t}}),Ei=e=>h(Ve,{title:"线条样式",icon:"━",get children(){var t=ii(),n=t.firstChild;return r(t,h(pe,{label:"颜色",get children(){return h(Ye,{get value(){return e.content.color},onUpdate:l=>e.onUpdate({color:l})})}}),n),r(t,h(pe,{label:"宽度",get children(){return h(He,{get value(){return e.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:l=>e.onUpdate({width:l})})}}),n),r(t,h(pe,{label:"样式",get children(){var l=li();return l.addEventListener("change",i=>e.onUpdate({line_style:i.target.value})),P(()=>l.value=e.content.line_style||"Solid"),l}}),n),r(n,h(pe,{label:"起点",get children(){var l=Kt();return l.addEventListener("change",i=>e.onUpdate({start_cap:i.target.value})),P(()=>l.value=e.content.start_cap||"None"),l}}),null),r(n,h(pe,{label:"终点",get children(){var l=Kt();return l.addEventListener("change",i=>e.onUpdate({end_cap:i.target.value})),P(()=>l.value=e.content.end_cap||"None"),l}}),null),r(t,h(pe,{label:"透明度",get children(){var l=wn(),i=l.firstChild,s=i.nextSibling,a=s.firstChild;return i.$$input=o=>e.onUpdate({opacity:parseFloat(o.target.value)/100}),r(s,()=>Math.round((e.content.opacity||1)*100),a),P(()=>i.value=(e.content.opacity||1)*100),l}}),null),t}}),Li=e=>h(Ve,{title:"图片属性",icon:"🖼️",get children(){var t=oi();return r(t,h(pe,{label:"图片地址",get children(){var n=si();return n.$$input=l=>e.onUpdate({src:l.target.value}),P(()=>n.value=e.content.src),n}}),null),r(t,h(pe,{label:"替代文本",get children(){var n=ri();return n.$$input=l=>e.onUpdate({alt:l.target.value}),P(()=>n.value=e.content.alt||""),n}}),null),r(t,h(pe,{label:"预览",get children(){var n=ai(),l=n.firstChild;return r(n,(()=>{var i=_e(()=>!!e.content.src);return()=>i()?(()=>{var s=ci();return s.addEventListener("load",a=>{const o=a.target,g=o.nextElementSibling;o&&(o.style.display="block"),g&&(g.style.display="none")}),s.addEventListener("error",a=>{const o=a.target,g=o.nextElementSibling;o&&(o.style.display="none"),g&&(g.style.display="flex")}),P(a=>{var o=e.content.src,g=e.content.alt||"图片预览";return o!==a.e&&B(s,"src",a.e=o),g!==a.t&&B(s,"alt",a.t=g),a},{e:void 0,t:void 0}),s})():null})(),l),P(i=>(i=e.content.src?"none":"flex")!=null?l.style.setProperty("display",i):l.style.removeProperty("display")),n}}),null),t}}),Di=e=>{const[t,n]=Y([]),[l,i]=Y(!1);Ue(async()=>{try{i(!0);const o=await we.listDataSources();n(o)}catch(o){console.error("Failed to load data sources:",o)}finally{i(!1)}});const s=o=>{e.onUpdate({data_source_id:o===""?void 0:o})},a=Ce(()=>e.content.data_source_id?t().find(o=>o.id===e.content.data_source_id):null);return(()=>{var o=mi();return r(o,h(Ve,{title:"数据源配置",icon:"🔗",get children(){var g=wt();return r(g,h(pe,{label:"数据源",get children(){return h(R,{get when(){return l()},get fallback(){return(()=>{var c=bi();return c.firstChild,c.addEventListener("change",b=>s(b.currentTarget.value)),r(c,h(ce,{get each(){return t()},children:b=>(()=>{var u=yi(),v=u.firstChild,f=v.nextSibling;return f.nextSibling,r(u,()=>b.name,v),r(u,()=>b.provider_type,f),P(()=>u.value=b.id),u})()}),null),P(()=>c.value=e.content.data_source_id||""),c})()},get children(){return di()}})}}),null),r(g,h(R,{get when(){return a()},get children(){var c=ui(),b=c.firstChild,u=b.firstChild,v=u.firstChild,f=v.nextSibling,d=f.nextSibling,y=u.nextSibling,$=y.firstChild;$.nextSibling;var p=y.nextSibling,_=p.firstChild;return _.nextSibling,r(d,(()=>{var C=_e(()=>a().status==="active");return()=>C()?"活跃":a().status==="error"?"错误":"禁用"})()),r(y,()=>a().provider_type,null),r(p,()=>new Date(a().last_updated).toLocaleString("zh-CN"),null),P(()=>$e(d,a().status==="active"?"text-green-600":a().status==="error"?"text-red-600":"text-gray-600")),c}}),null),r(g,h(pe,{label:"表达式",get children(){var c=gi();return c.$$input=b=>e.onUpdate({expression:b.currentTarget.value}),c.disabled=!1,P(()=>c.value=e.content.expression||""),c}}),null),r(g,h(R,{get when(){return!e.content.expression||!e.content.expression.trim()},get children(){return hi()}}),null),r(g,h(R,{get when(){return e.content.expression&&!e.content.data_source_id},get children(){return vi()}}),null),r(g,h(pe,{label:"格式",get children(){var c=fi();return c.addEventListener("change",b=>e.onUpdate({format:b.currentTarget.value==="default"?void 0:b.currentTarget.value})),P(()=>c.value=e.content.format||"default"),c}}),null),g}}),null),r(o,h(Ve,{title:"字段样式",icon:"🎨",get children(){var g=Sn(),c=g.firstChild,b=c.nextSibling;return r(c,h(pe,{label:"字体",get children(){var u=$n();return u.addEventListener("change",v=>e.onUpdate({style:{...e.content.style,font_family:v.currentTarget.value}})),P(()=>u.value=e.content.style.font_family),u}}),null),r(c,h(pe,{label:"大小",get children(){return h(He,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:u=>e.onUpdate({style:{...e.content.style,font_size:u}})})}}),null),r(b,h(pe,{label:"字重",get children(){var u=_n();return u.addEventListener("change",v=>e.onUpdate({style:{...e.content.style,font_weight:v.currentTarget.value}})),P(()=>u.value=e.content.style.font_weight),u}}),null),r(b,h(pe,{label:"对齐",get children(){return h(Cn,{get value(){return e.content.style.align},onUpdate:u=>e.onUpdate({style:{...e.content.style,align:u}})})}}),null),r(g,h(pe,{label:"颜色",get children(){return h(Ye,{get value(){return e.content.style.color},onUpdate:u=>e.onUpdate({style:{...e.content.style,color:u}})})}}),null),g}}),null),o})()},He=e=>(()=>{var t=pi(),n=t.firstChild;return n.addEventListener("blur",l=>{const i=parseFloat(l.target.value)||e.value,s=Math.max(e.min||-1/0,Math.min(e.max||1/0,i));s!==i&&(l.target.value=s.toString(),e.onUpdate(s))}),n.$$input=l=>{const i=parseFloat(l.target.value);if(!isNaN(i)){const s=Math.max(e.min||-1/0,Math.min(e.max||1/0,i));e.onUpdate(s)}},r(t,(()=>{var l=_e(()=>!!e.unit);return()=>l()&&(()=>{var i=$i();return r(i,()=>e.unit),i})()})(),null),P(l=>{var i=e.min,s=e.max,a=e.step||1;return i!==l.e&&B(n,"min",l.e=i),s!==l.t&&B(n,"max",l.t=s),a!==l.a&&B(n,"step",l.a=a),l},{e:void 0,t:void 0,a:void 0}),P(()=>n.value=e.value),t})(),Ye=e=>(()=>{var t=_i(),n=t.firstChild,l=n.firstChild,i=l.nextSibling,s=n.nextSibling;return l.$$input=a=>e.onUpdate(a.target.value),s.$$input=a=>{const o=a.target.value;(/^#[0-9A-Fa-f]{6}$/.test(o)||/^#[0-9A-Fa-f]{3}$/.test(o))&&e.onUpdate(o)},P(a=>(a=e.value)!=null?i.style.setProperty("background-color",a):i.style.removeProperty("background-color")),P(()=>l.value=e.value),P(()=>s.value=e.value),t})(),Cn=e=>{const t=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var n=xi();return r(n,()=>t.map(l=>(()=>{var i=Si();return i.$$click=()=>e.onUpdate(l.value),r(i,()=>l.icon),P(s=>{var a=`property-alignment-btn ${e.value===l.value?"active":""}`,o=l.label;return a!==s.e&&$e(i,s.e=a),o!==s.t&&B(i,"title",s.t=o),s},{e:void 0,t:void 0}),i})())),n})()};De(["input","click"]);var Pi=m("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),Ai=m("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const zi=e=>h(R,{get when(){return e.config.show_grid},get children(){return[(()=>{var t=Pi(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return P(s=>{var a=e.config.grid_size,o=e.config.grid_size,g=e.config.grid_size,c=e.config.grid_size,b=e.config.grid_size,u=e.config.grid_size,v=e.config.grid_size,f=e.config.grid_size;return a!==s.e&&B(n,"width",s.e=a),o!==s.t&&B(n,"height",s.t=o),g!==s.a&&B(l,"x1",s.a=g),c!==s.o&&B(l,"x2",s.o=c),b!==s.i&&B(l,"y2",s.i=b),u!==s.n&&B(i,"y1",s.n=u),v!==s.s&&B(i,"x2",s.s=v),f!==s.h&&B(i,"y2",s.h=f),s},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),t})(),(()=>{var t=Ai();return P(n=>{var l=e.config.width,i=e.config.height;return l!==n.e&&B(t,"width",n.e=l),i!==n.t&&B(t,"height",n.t=i),n},{e:void 0,t:void 0}),t})()]}});class Ri{constructor(){qe(this,"expressionCache",new Map);qe(this,"maxCacheSize",1e3)}async evaluateExpression(t,n){if(!t||!t.trim())return{success:!1,error:"表达式不能为空"};if(!n)return{success:!1,error:"没有可用的数据上下文"};try{const l=this.preprocessExpression(t),i=this.getCompiledExpression(l),s=await this.executeCompiledExpression(i,n);return{success:!0,value:s.value,type:this.inferValueType(s.value)}}catch(l){return{success:!1,error:l instanceof Error?l.message:String(l)}}}validateExpression(t,n){if(!t||!t.trim())return{valid:!1,error:"表达式不能为空"};try{const l=this.preprocessExpression(t),i=this.compileExpression(l);return this.staticValidation(i,n)}catch(l){return{valid:!1,error:l instanceof Error?l.message:"表达式格式错误"}}}getFieldSuggestions(t,n){if(!n)return[];const l=t.toLowerCase().replace(/[{}]/g,""),i=[];if(n.fields.forEach(s=>{s.name.toLowerCase().includes(l)&&i.push(`{${s.name}}`),s.displayName&&s.displayName.toLowerCase().includes(l)&&i.push(`{${s.name}}`)}),n.currentRecord.data){const s=this.getNestedFieldSuggestions(l,n.currentRecord.data,"");i.push(...s)}return Array.from(new Set(i)).sort((s,a)=>{const o=s.replace(/[{}]/g,""),g=a.replace(/[{}]/g,"");return o===l?-1:g===l?1:o.startsWith(l)?-1:g.startsWith(l)?1:o.localeCompare(g)}).slice(0,20)}preprocessExpression(t){let n=t.trim();return!n.startsWith("{")&&!n.endsWith("}")&&(n=`{${n}}`),n=n.replace(/^\{+/,"{").replace(/\}+$/,"}"),n}getCompiledExpression(t){let n=this.expressionCache.get(t);if(!n){if(n=this.compileExpression(t),this.expressionCache.size>=this.maxCacheSize){const l=this.expressionCache.keys().next().value;l&&this.expressionCache.delete(l)}this.expressionCache.set(t,n)}return n}compileExpression(t){const n=t.slice(1,-1),l=this.parsePath(n);return{original:t,path:l,type:this.determineExpressionType(l)}}parsePath(t){const n=[];let l="",i=!1;for(let s=0;s<t.length;s++){const a=t[s];if(a==="["&&!i)l&&(n.push({type:"field",value:l}),l=""),i=!0;else if(a==="]"&&i){const o=parseInt(l,10);if(isNaN(o))throw new Error(`无效的数组索引: ${l}`);n.push({type:"index",value:o}),l="",i=!1}else a==="."&&!i?l&&(n.push({type:"field",value:l}),l=""):l+=a}if(l){if(i)throw new Error("未闭合的数组索引");n.push({type:"field",value:l})}if(n.length===0)throw new Error("空的字段路径");return n}async executeCompiledExpression(t,n){let l=n.currentRecord.data;for(const i of t.path){if(l==null)throw new Error("无法访问 null/undefined 值的属性");if(i.type==="field"){if(typeof l!="object")throw new Error(`尝试访问非对象类型的字段: ${i.value}`);if(!(i.value in l))throw new Error(`字段不存在: ${i.value}`);l=l[i.value]}else if(i.type==="index"){if(!Array.isArray(l))throw new Error("尝试对非数组类型使用索引访问");const s=i.value;if(s<0||s>=l.length)throw new Error(`数组索引超出范围: ${s}`);l=l[s]}}return{value:l}}staticValidation(t,n){if(!n)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const l=[],i=t.path[0];if(i&&i.type==="field"){const a=i.value;if(!n.fields.some(g=>g.name===a)){const g=n.fields.filter(c=>c.name.toLowerCase().includes(a.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),a.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${a}`,suggestions:g}}}t.path.length>5&&l.push("表达式路径过深，可能影响性能");const s={valid:!0};return l.length>0&&(s.warnings=l),s}getNestedFieldSuggestions(t,n,l){const i=[];if(!n||typeof n!="object")return i;for(const s of Object.keys(n)){const a=l?`${l}.${s}`:s;a.toLowerCase().includes(t)&&i.push(`{${a}}`),l.split(".").length<3&&n[s]&&typeof n[s]=="object"&&i.push(...this.getNestedFieldSuggestions(t,n[s],a))}return i}inferValueType(t){return t==null?"object":typeof t=="string"?"string":typeof t=="number"?"number":typeof t=="boolean"?"boolean":t instanceof Date?"date":typeof t=="object"?"object":"string"}determineExpressionType(t){return t.length===1?"simple":t.length<=3&&t.every(n=>n.type==="field")?"nested":"complex"}levenshteinDistance(t,n){if(t.length===0)return n.length;if(n.length===0)return t.length;const l=new Array(n.length+1);for(let i=0;i<=n.length;i++)l[i]=new Array(t.length+1),l[i][0]=i;for(let i=0;i<=t.length;i++)l[0][i]=i;for(let i=1;i<=n.length;i++)for(let s=1;s<=t.length;s++){const a=t[s-1]===n[i-1]?0:1;l[i][s]=Math.min(l[i-1][s]+1,l[i][s-1]+1,l[i-1][s-1]+a)}return l[n.length][t.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const Pt=new Ri;class Mi{constructor(){qe(this,"context",Y(null));qe(this,"subscribers",[]);this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(t){var n,l;try{const s=(await we.listDataSources()).find(u=>u.id===t);if(!s)throw new Error(`数据源不存在: ${t}`);console.log("🔍 找到数据源:",s);const a=s.provider_type||s.type_name||"json";console.log("🔍 推断的 providerType:",a);const o=await we.getPreview(t,void 0,1);console.log("🔍 预览数据:",o);const g=await we.getSchema(t);console.log("🔍 Schema信息:",g);const c=g.columns.map(u=>({name:u.name,displayName:u.description||u.name,type:this.mapDataType(u.data_type),nullable:u.nullable,sample:u.default_value})),b={dataSource:{id:t,type:this.inferDataSourceType(a),name:s.name,status:this.mapDataSourceStatus(s.status)},currentRecord:{index:0,total:(l=(n=o.total_rows)!=null?n:o.total_count)!=null?l:0,data:o.rows[0]||{}},fields:c};console.log("✅ 创建新的数据上下文:",b),this.context[1](b);try{typeof window<"u"&&window.localStorage&&window.localStorage.setItem("jasper.activeDataSourceId",t)}catch(u){console.warn("无法持久化激活数据源ID:",u)}this.notifySubscribers(b)}catch(i){console.error("设置数据源失败:",i);const s={dataSource:{id:t,type:"json",name:"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:i instanceof Error?i.message:"数据源加载失败",details:i}};this.context[1](s),this.notifySubscribers(s)}}async navigateToRecord(t){const n=this.getCurrentContext();if(!n||t<0||t>=n.currentRecord.total)return!1;try{const l=await we.queryData(n.dataSource.id,{limit:1,offset:t});if(l.rows.length===0)return!1;const i={...n,currentRecord:{...n.currentRecord,index:t,data:l.rows[0]}};return this.context[1](i),this.notifySubscribers(i),!0}catch(l){return console.error("导航到记录失败:",l),!1}}async navigateNext(){const t=this.getCurrentContext();return t?this.navigateToRecord(t.currentRecord.index+1):!1}async navigatePrevious(){const t=this.getCurrentContext();return t?this.navigateToRecord(t.currentRecord.index-1):!1}async evaluateExpression(t){const n=this.getCurrentContext();return await Pt.evaluateExpression(t,n)}validateExpression(t){const n=this.getCurrentContext(),l=Pt.validateExpression(t,n);return{valid:l.valid,...l.error&&{error:l.error},...l.suggestions&&{suggestions:l.suggestions}}}getFieldSuggestions(t){const n=this.getCurrentContext();return Pt.getFieldSuggestions(t,n)}subscribe(t){return this.subscribers.push(t),()=>{const n=this.subscribers.indexOf(t);n>-1&&this.subscribers.splice(n,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(t){this.subscribers.forEach(n=>{try{n(t)}catch(l){console.error("数据上下文订阅回调错误:",l)}})}inferDataSourceType(t){if(!t)return console.warn("providerType is undefined, defaulting to json"),"json";switch(t.toLowerCase()){case"json":return"json";case"excel":return"excel";case"sql":return"sql";case"xml":return"xml";case"csv":return"csv";default:return"json"}}mapDataType(t){switch(t){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(t){if(!t)return console.warn("status is undefined, defaulting to empty"),"empty";switch(t.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${t}, defaulting to empty`),"empty"}}}const Be=new Mi;var Ni=m("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),Yt=m("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),Oi=m("<svg><rect class=text-background-unified></svg>",!1,!0,!1),Ii=m("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),Ui=m("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),Fi=m("<svg><tspan class=text-line-original></svg>",!1,!0,!1),qi=m("<svg><rect x=0 y=0></svg>",!1,!0,!1),Bi=m("<svg><line x1=0></svg>",!1,!0,!1),ji=m("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),Qi=m('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),Hi=m("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),Ji=m("<svg><tspan dy=0></svg>",!1,!0,!1),Vi=m("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),Wi=m("<svg><g></svg>",!1,!0,!1);const Gi=e=>{const{state:t}=hn(),[n,l]=Y("[数据字段]");It(()=>{if(e.element.content.type==="DataField"){const a=e.element.content.expression||"",o=t().mode;Tt.shouldShowExpression(o)?l(a||"[数据字段]"):Tt.shouldEvaluateExpression(o)&&Be.evaluateExpression(a).then(g=>{g.success?l(String(g.value||"")):l(`[错误: ${g.error}]`)}).catch(g=>{l(`[错误: ${g}]`)})}});const i=Ce(()=>{const{position:a}=e.element;return{transform:`translate(${a.x}px, ${a.y}px)`,opacity:e.element.visible?1:.5}}),s=()=>{const{content:a,size:o}=e.element;if(a.type==="Text"&&a.content&&a.style){const g=et.calculateUnifiedBounds(a.content,a.style,o),c=et.getTextAnchor(a.style.align);return(()=>{var b=Ni(),u=b.firstChild;return r(b,(()=>{var v=_e(()=>!!e.selected);return()=>v()&&(()=>{var f=Yt();return P(d=>{var y=g.containerBounds.x,$=g.containerBounds.y,p=g.containerBounds.width,_=g.containerBounds.height;return y!==d.e&&B(f,"x",d.e=y),$!==d.t&&B(f,"y",d.t=$),p!==d.a&&B(f,"width",d.a=p),_!==d.o&&B(f,"height",d.o=_),d},{e:void 0,t:void 0,a:void 0,o:void 0}),f})()})(),u),r(b,(()=>{var v=_e(()=>!!a.style.background);return()=>v()&&(()=>{var f=Oi();return P(d=>{var N,q;var y=g.positioning.backgroundX,$=g.positioning.backgroundY,p=g.containerBounds.width+(a.style.background.padding||0)*2,_=g.containerBounds.height+(a.style.background.padding||0)*2,C=a.style.background.color,E=a.style.background.opacity||1,k=((N=a.style.border)==null?void 0:N.radius)||0,I=((q=a.style.border)==null?void 0:q.radius)||0;return y!==d.e&&B(f,"x",d.e=y),$!==d.t&&B(f,"y",d.t=$),p!==d.a&&B(f,"width",d.a=p),_!==d.o&&B(f,"height",d.o=_),C!==d.i&&B(f,"fill",d.i=C),E!==d.n&&B(f,"fill-opacity",d.n=E),k!==d.s&&B(f,"rx",d.s=k),I!==d.h&&B(f,"ry",d.h=I),d},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),f})()})(),u),r(b,(()=>{var v=_e(()=>!!a.style.border);return()=>v()&&(()=>{var f=Ii();return P(d=>{var q,j;var y=g.positioning.backgroundX,$=g.positioning.backgroundY,p=g.containerBounds.width+(((q=a.style.background)==null?void 0:q.padding)||0)*2,_=g.containerBounds.height+(((j=a.style.background)==null?void 0:j.padding)||0)*2,C=a.style.border.color,E=a.style.border.width,k=a.style.border.style==="Dashed"?"5,5":a.style.border.style==="Dotted"?"2,2":"none",I=a.style.border.radius||0,N=a.style.border.radius||0;return y!==d.e&&B(f,"x",d.e=y),$!==d.t&&B(f,"y",d.t=$),p!==d.a&&B(f,"width",d.a=p),_!==d.o&&B(f,"height",d.o=_),C!==d.i&&B(f,"stroke",d.i=C),E!==d.n&&B(f,"stroke-width",d.n=E),k!==d.s&&B(f,"stroke-dasharray",d.s=k),I!==d.h&&B(f,"rx",d.h=I),N!==d.r&&B(f,"ry",d.r=N),d},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),f})()})(),u),B(u,"text-anchor",c),r(u,(()=>{var v=_e(()=>{var f;return!!((f=g.textLayout)!=null&&f.isWrapped)});return()=>v()?g.textLayout.wrappedLines.map((f,d)=>(()=>{var y=Ui();return r(y,f),P($=>{var p=g.positioning.textAnchorX,_=d===0?0:g.fontMetrics.lineHeight;return p!==$.e&&B(y,"x",$.e=p),_!==$.t&&B(y,"dy",$.t=_),$},{e:void 0,t:void 0}),y})()):a.content.split(`
`).map((f,d)=>(()=>{var y=Fi();return r(y,f),P($=>{var p=g.positioning.textAnchorX,_=d===0?0:g.fontMetrics.lineHeight;return p!==$.e&&B(y,"x",$.e=p),_!==$.t&&B(y,"dy",$.t=_),$},{e:void 0,t:void 0}),y})())})()),P(v=>{var f=g.positioning.textAnchorX,d=g.positioning.textAnchorY,y=a.style.font_family,$=a.style.font_size.toString(),p=a.style.font_weight,_=a.style.color;return f!==v.e&&B(u,"x",v.e=f),d!==v.t&&B(u,"y",v.t=d),y!==v.a&&B(u,"font-family",v.a=y),$!==v.o&&B(u,"font-size",v.o=$),p!==v.i&&B(u,"font-weight",v.i=p),_!==v.n&&B(u,"fill",v.n=_),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),b})()}if(a.type==="Rectangle"){const g=a.opacity!==void 0?a.opacity:1,c=a.corner_radius||0;return(()=>{var b=qi();return B(b,"rx",c),B(b,"ry",c),B(b,"fill-opacity",g),B(b,"stroke-opacity",g),P(u=>{var _,C,E,k;var v=o.width,f=o.height,d=a.fill_color||"transparent",y=((_=a.border)==null?void 0:_.color)||"#000000",$=((C=a.border)==null?void 0:C.width)||1,p=((E=a.border)==null?void 0:E.style)==="Dashed"?"5,5":((k=a.border)==null?void 0:k.style)==="Dotted"?"2,2":"none";return v!==u.e&&B(b,"width",u.e=v),f!==u.t&&B(b,"height",u.t=f),d!==u.a&&B(b,"fill",u.a=d),y!==u.o&&B(b,"stroke",u.o=y),$!==u.i&&B(b,"stroke-width",u.i=$),p!==u.n&&B(b,"stroke-dasharray",u.n=p),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),b})()}if(a.type==="Line"){const g=a.opacity!==void 0?a.opacity:1,c=a.line_style||"Solid",b=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var u=Bi();return B(u,"stroke-opacity",g),B(u,"stroke-dasharray",b),P(v=>{var f=o.height/2,d=o.width,y=o.height/2,$=a.color,p=a.width;return f!==v.e&&B(u,"y1",v.e=f),d!==v.t&&B(u,"x2",v.t=d),y!==v.a&&B(u,"y2",v.a=y),$!==v.o&&B(u,"stroke",v.o=$),p!==v.i&&B(u,"stroke-width",v.i=p),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),u})()}if(a.type==="DataField"&&a.style){const g=n(),c=et.calculateUnifiedBounds(g,a.style,o),b=et.getTextAnchor(a.style.align);return(()=>{var u=ji(),v=u.firstChild;return r(u,(()=>{var f=_e(()=>!!e.selected);return()=>f()&&(()=>{var d=Yt();return P(y=>{var $=c.containerBounds.x,p=c.containerBounds.y,_=c.containerBounds.width,C=c.containerBounds.height;return $!==y.e&&B(d,"x",y.e=$),p!==y.t&&B(d,"y",y.t=p),_!==y.a&&B(d,"width",y.a=_),C!==y.o&&B(d,"height",y.o=C),y},{e:void 0,t:void 0,a:void 0,o:void 0}),d})()})(),v),r(u,(()=>{var f=_e(()=>!!Tt.shouldShowExpression(t().mode));return()=>f()&&(()=>{var d=Qi(),y=d.firstChild,$=y.nextSibling;return P(p=>{var _=c.containerBounds.x+c.containerBounds.width-8,C=c.containerBounds.y+8,E=c.containerBounds.x+c.containerBounds.width-8,k=c.containerBounds.y+8;return _!==p.e&&B(y,"cx",p.e=_),C!==p.t&&B(y,"cy",p.t=C),E!==p.a&&B($,"x",p.a=E),k!==p.o&&B($,"y",p.o=k),p},{e:void 0,t:void 0,a:void 0,o:void 0}),d})()})(),v),B(v,"text-anchor",b),r(v,(()=>{var f=_e(()=>{var d;return!!((d=c.textLayout)!=null&&d.isWrapped)});return()=>f()?c.textLayout.wrappedLines.map((d,y)=>(()=>{var $=Hi();return r($,d),P(p=>{var _=c.positioning.textAnchorX,C=y===0?0:c.fontMetrics.lineHeight;return _!==p.e&&B($,"x",p.e=_),C!==p.t&&B($,"dy",p.t=C),p},{e:void 0,t:void 0}),$})()):(()=>{var d=Ji();return r(d,g),P(()=>B(d,"x",c.positioning.textAnchorX)),d})()})()),P(f=>{var d=t().mode,y=c.positioning.textAnchorX,$=c.positioning.textAnchorY,p=a.style.font_family,_=a.style.font_size.toString(),C=a.style.font_weight,E=g.startsWith("[错误:")?"#ff4d4f":a.style.color,k=`datafield-content-unified ${t().mode}-mode`;return d!==f.e&&B(u,"data-preview-mode",f.e=d),y!==f.t&&B(v,"x",f.t=y),$!==f.a&&B(v,"y",f.a=$),p!==f.o&&B(v,"font-family",f.o=p),_!==f.i&&B(v,"font-size",f.i=_),C!==f.n&&B(v,"font-weight",f.n=C),E!==f.s&&B(v,"fill",f.s=E),k!==f.h&&B(v,"class",f.h=k),f},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),u})()}return(()=>{var g=Vi();return P(c=>{var b=o.width,u=o.height;return b!==c.e&&B(g,"width",c.e=b),u!==c.t&&B(g,"height",c.t=u),c},{e:void 0,t:void 0}),g})()};return(()=>{var a=Wi();return r(a,s),P(o=>{var g=`element ${e.selected&&e.element.content.type!=="Text"&&e.element.content.type!=="DataField"?"element-selected":""}`,c=i(),b=e.element.id,u=e.element.content.type;return g!==o.e&&B(a,"class",o.e=g),o.t=un(a,c,o.t),b!==o.a&&B(a,"data-element-id",o.a=b),u!==o.o&&B(a,"data-element-type",o.o=u),o},{e:void 0,t:void 0,a:void 0,o:void 0}),a})()};var Ki=m("<svg><g class=resize-handles></svg>",!1,!0,!1),Yi=m("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const Xi=e=>{const{updateElement:t,setResizeOperation:n}=Ge(),[l,i]=Y(!1),[s,a]=Y(null),[o,g]=Y({x:0,y:0}),[c,b]=Y({width:0,height:0}),[u,v]=Y({x:0,y:0}),[f,d]=Y({width:0,height:0}),[y,$]=Y({x:0,y:0}),[p,_]=Y(!1),C=Ce(()=>{const{position:D,size:L,content:S}=e.element,U=8/2;let w={x:D.x,y:D.y,width:L.width,height:L.height};if((S.type==="Text"||S.type==="DataField")&&S.style){const ee=S.type==="Text"?S.content:S.expression||"[数据字段]",H=et.calculateUnifiedBounds(ee,S.style,L);w={x:D.x+H.containerBounds.x,y:D.y+H.containerBounds.y,width:H.containerBounds.width,height:H.containerBounds.height}}const A=w.x,V=w.y,z=w.x+w.width,M=w.y+w.height,J=w.x+w.width/2,de=w.y+w.height/2;return[{position:"nw",cursor:"nw-resize",x:A-U,y:V-U},{position:"ne",cursor:"ne-resize",x:z-U,y:V-U},{position:"sw",cursor:"sw-resize",x:A-U,y:M-U},{position:"se",cursor:"se-resize",x:z-U,y:M-U},{position:"n",cursor:"n-resize",x:J-U,y:V-U},{position:"s",cursor:"s-resize",x:J-U,y:M-U},{position:"w",cursor:"w-resize",x:A-U,y:de-U},{position:"e",cursor:"e-resize",x:z-U,y:de-U}]}),E=(D,L,S,Q=!1,U=!1)=>{const w=c(),A=u();let V=w.width,z=w.height,M=A.x,J=A.y;switch(D){case"nw":V=w.width-L,z=w.height-S,M=A.x+L,J=A.y+S;break;case"ne":V=w.width+L,z=w.height-S,J=A.y+S;break;case"sw":V=w.width-L,z=w.height+S,M=A.x+L;break;case"se":V=w.width+L,z=w.height+S;break;case"n":z=w.height-S,J=A.y+S;break;case"s":z=w.height+S;break;case"w":V=w.width-L,M=A.x+L;break;case"e":V=w.width+L;break}if(Q&&(D==="nw"||D==="ne"||D==="sw"||D==="se")){const ee=w.width/w.height;V/z>ee?(V=z*ee,(D==="nw"||D==="sw")&&(M=A.x+(w.width-V))):(z=V/ee,(D==="nw"||D==="ne")&&(J=A.y+(w.height-z)))}if(U){const ee=A.x+w.width/2,H=A.y+w.height/2;M=ee-V/2,J=H-z/2}const de=20;return V=Math.max(de,V),z=Math.max(de,z),{size:{width:V,height:z},position:{x:M,y:J}}},k=D=>(D.preventDefault(),D.stopPropagation(),D.stopImmediatePropagation(),!1),I=(D,L)=>{var S;n(!0),document.addEventListener("click",k,{capture:!0}),i(!0),a(D),g({x:L.clientX,y:L.clientY}),b({width:e.element.size.width,height:e.element.size.height}),v({x:e.element.position.x,y:e.element.position.y}),d(e.element.size),$(e.element.position),_(!1),document.addEventListener("mousemove",q),document.addEventListener("mouseup",j),document.body.style.cursor=((S=C().find(Q=>Q.position===D))==null?void 0:S.cursor)||"default"};let N=0;const q=D=>{if(!l())return;const L=s();if(!L)return;const S=o(),Q=D.clientX-S.x,U=D.clientY-S.y,w=E(L,Q,U,D.shiftKey,D.altKey);d(w.size),$(w.position),_(Math.abs(Q)>2||Math.abs(U)>2);const A=Date.now();if(A-N>50)try{t(e.element.id,{size:w.size,position:w.position}),N=A}catch{}},j=()=>{if(!l()||!s())return;const L=()=>{document.removeEventListener("click",k,{capture:!0}),n(!1),i(!1),a(null),document.body.style.cursor="default",document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",j)};if(p()){const S=f(),Q=y();t(e.element.id,{size:S,position:Q}).catch(U=>{t(e.element.id,{size:c(),position:u()}).catch(w=>{})})}L()};return ut(()=>{n(!1),document.removeEventListener("click",k,{capture:!0}),document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",j),document.body.style.cursor="default"}),(()=>{var D=Ki();return r(D,()=>C().map(L=>(()=>{var S=Yi(),Q=S.firstChild,U=Q.nextSibling;return U.addEventListener("mouseleave",w=>{l()||(document.body.style.cursor="default")}),U.addEventListener("mouseenter",w=>{l()||(document.body.style.cursor=L.cursor)}),U.$$mousedown=w=>{w.stopPropagation(),w.preventDefault(),I(L.position,w)},U.style.setProperty("pointer-events","all"),P(w=>{var A=L.x+4,V=L.y+4,z=L.x,M=L.y,J=L.cursor;return A!==w.e&&B(Q,"cx",w.e=A),V!==w.t&&B(Q,"cy",w.t=V),z!==w.a&&B(U,"x",w.a=z),M!==w.o&&B(U,"y",w.o=M),J!==w.i&&((w.i=J)!=null?U.style.setProperty("cursor",J):U.style.removeProperty("cursor")),w},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),S})())),D})()};De(["mousedown"]);var Oe=(e=>(e.IDLE="idle",e.HOVER="hover",e.SELECTING="selecting",e.DRAGGING="dragging",e))(Oe||{});const Zi={dragThreshold:3,updateThrottle:16};var es=m("<div tabindex=0>"),ts=m("<div>"),ns=m("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),ls=m("<div>拖拽: <!>个元素"),is=m("<div>[<!>]");const ss=e=>{const{resizeOperation:t,setResizeOperation:n}=Ge(),l=Zi;let i;const[s,a]=Y(Oe.IDLE),[o,g]=Y([]),[c,b]=Y(null),[u,v]=Y(null),[f,d]=Y(null),y=(x,T)=>Math.sqrt(Math.pow(x.x-T.x,2)+Math.pow(x.y-T.y,2)),$=(x,T)=>x.length===T.length&&x.every((F,O)=>F===T[O]),p=()=>{d(null)},[_,C]=Y(null);let E="default";const k=(x,T)=>{!i||E===x||(i.style.cursor=x,E=x)},I=(x,...T)=>{console.log(`🎯 [InteractionLayer] ${x}`,...T)},N=x=>{if(!i)return{x:0,y:0};const T=i.getBoundingClientRect();return{x:x.clientX-T.left,y:x.clientY-T.top}},q=(x,T)=>x.x>=T.position.x&&x.x<=T.position.x+T.size.width&&x.y>=T.position.y&&x.y<=T.position.y+T.size.height,j=x=>{var F;const T=D(x);return T.length>0&&(F=T[0])!=null?F:null},D=x=>{const T=e.getAllElements();return T.filter(O=>O&&O.visible&&q(x,O)).sort((O,W)=>{var ye,ke;const le=(ye=O.z_index)!=null?ye:T.indexOf(O);return((ke=W.z_index)!=null?ke:T.indexOf(W))-le})},L=x=>{const T=o();if(T.length===0)return null;const F=e.getAllElements();for(const O of T){const W=F.find(xe=>xe.id===O);if(!W||!W.visible)continue;const le=8,K=le/2,ye=W.position.x,ke=W.position.y,ae=W.position.x+W.size.width,Ae=W.position.y+W.size.height,Pe=W.position.x+W.size.width/2,Ne=W.position.y+W.size.height/2,je=[{direction:"nw",cursor:"nw-resize",x:ye-K,y:ke-K},{direction:"ne",cursor:"ne-resize",x:ae-K,y:ke-K},{direction:"sw",cursor:"sw-resize",x:ye-K,y:Ae-K},{direction:"se",cursor:"se-resize",x:ae-K,y:Ae-K},{direction:"n",cursor:"n-resize",x:Pe-K,y:ke-K},{direction:"s",cursor:"s-resize",x:Pe-K,y:Ae-K},{direction:"w",cursor:"w-resize",x:ye-K,y:Ne-K},{direction:"e",cursor:"e-resize",x:ae-K,y:Ne-K}];for(const xe of je)if(x.x>=xe.x&&x.x<xe.x+le&&x.y>=xe.y&&x.y<xe.y+le)return{elementId:W.id,direction:xe.direction,cursor:xe.cursor}}return null},S=x=>e.getAllElements().filter(F=>{if(!F.visible)return!1;const O={x:F.position.x,y:F.position.y,width:F.size.width,height:F.size.height};return!(O.x>x.x+x.width||O.x+O.width<x.x||O.y>x.y+x.height||O.y+O.height<x.y)}),Q=(x,T)=>{var O,W,le;const F=D(x);return I("重叠选择检测",{elementsCount:F.length,isCtrlClick:T,elementIds:F.map(K=>K.id)}),F.length===0?null:F.length===1?(p(),((O=F[0])==null?void 0:O.id)||null):T?U(x,F):(p(),I("普通点击选中最上层",{elementId:(W=F[0])==null?void 0:W.id}),((le=F[0])==null?void 0:le.id)||null)},U=(x,T)=>{var le,K,ye,ke;const F=f(),O=Date.now();if(I("循环选择开始",{hasContext:!!F,elementIds:T.map(ae=>ae.id)}),!F||y(x,F.clickPoint)>5||O-F.lastClickTime>3e3||!$(T.map(ae=>ae.id),F.overlappingElements.map(ae=>ae.id))){const ae=T.length>1?1:0;return d({clickPoint:x,overlappingElements:T,currentSelectedIndex:ae,lastClickTime:O}),I("循环选择重置",{selectedIndex:ae,selectedId:(le=T[ae])==null?void 0:le.id,reason:F?y(x,F.clickPoint)>5?"position_changed":O-F.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),w(ae+1,T.length,x),((K=T[ae])==null?void 0:K.id)||null}else{const ae=(F.currentSelectedIndex+1)%T.length;return d({...F,currentSelectedIndex:ae,lastClickTime:O}),I("循环选择继续",{selectedIndex:ae,selectedId:(ye=T[ae])==null?void 0:ye.id}),w(ae+1,T.length,x),((ke=T[ae])==null?void 0:ke.id)||null}},w=(x,T,F)=>{const O=document.querySelector(".overlap-indicator");O!=null&&O.parentNode&&O.parentNode.removeChild(O);const W=document.createElement("div");W.className="overlap-indicator",W.textContent=`${x}/${T}`,Object.assign(W.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${F.x+10}px`,top:`${F.y-20}px`}),document.body.appendChild(W),I("显示重叠指示器",{current:x,total:T,point:F}),setTimeout(()=>{W.parentNode&&(W.parentNode.removeChild(W),I("移除重叠指示器"))},1500)},A=x=>{var F;const T=N(x);if(_()){G(T);return}if(s()===Oe.DRAGGING){oe(T);return}if(s()===Oe.SELECTING){X(T);return}if(s()===Oe.IDLE&&c()&&!((F=c())!=null&&F.isDragging)){ie(T);return}s()===Oe.IDLE&&!c()&&!_()&&V(T)},V=x=>{const T=L(x);if(T){k(T.cursor);return}const F=j(x);if(F){const W=o().includes(F.id)?"grab":"pointer";k(W);return}k("default")},z=x=>{const T=N(x),F=L(T);if(F){I("点击ResizeHandle",{elementId:F.elementId,direction:F.direction}),M(F,T);return}if(t()){I("调整大小操作进行中，跳过交互处理");return}const O=Q(T,x.ctrlKey);if(I("鼠标按下",{point:T,selectedElementId:O,currentMode:s(),isCtrlClick:x.ctrlKey}),O){const W=e.getAllElements().find(le=>le.id===O);W&&J(W,T,x)}else de(T)},M=(x,T,F)=>{const O=e.getAllElements().find(W=>W.id===x.elementId);O&&(I("开始resize操作",{elementId:x.elementId,direction:x.direction}),n(!0),C({elementId:x.elementId,handlePosition:x.direction,startPoint:T,initialSize:{width:O.size.width,height:O.size.height},initialPosition:{x:O.position.x,y:O.position.y},cursor:x.cursor}),k(x.cursor),I("resize状态已设置",_()))},J=(x,T,F)=>{const O=o().includes(x.id),W=o(),le=!!f();I("元素点击",{elementId:x.id,isSelected:O,currentlySelected:W,ctrlKey:F.ctrlKey,shiftKey:F.shiftKey,hasOverlapContext:le}),F.ctrlKey&&!le?ee(x.id):F.shiftKey&&o().length>0?H(x.id):O?(I("点击已选中元素，准备拖拽",{selectedCount:W.length}),ve(W,T)):ne(x.id,T)},de=(x,T)=>{var F;I("开始框选",{point:x}),g([]),(F=e.onElementsSelect)==null||F.call(e,[]),p(),a(Oe.SELECTING),k("crosshair"),v({startPoint:x,currentPoint:x,selectedIds:[]})},ee=x=>{var O;const T=o(),F=T.includes(x)?T.filter(W=>W!==x):[...T,x];I("切换选择",{elementId:x,newSelection:F}),g(F),(O=e.onElementsSelect)==null||O.call(e,F)},H=x=>{var F;const T=o();if(!T.includes(x)){const O=[...T,x];I("添加到选择",{elementId:x,newSelection:O}),g(O),(F=e.onElementsSelect)==null||F.call(e,O)}},ne=(x,T,F)=>{var O;I("选择并准备拖拽",{elementId:x,point:T}),g([x]),(O=e.onElementsSelect)==null||O.call(e,[x]),ve([x],T)},ve=(x,T,F)=>{I("准备拖拽操作",{elementIds:x,startPoint:T});const O=e.getAllElements(),W=new Map;x.forEach(le=>{const K=O.find(ye=>ye.id===le);K&&W.set(le,{x:K.position.x,y:K.position.y})}),b({elementIds:x,startPoint:T,startPositions:W,currentOffset:{x:0,y:0},isDragging:!1})},ie=x=>{const T=c();if(!T)return;const F=Math.sqrt(Math.pow(x.x-T.startPoint.x,2)+Math.pow(x.y-T.startPoint.y,2));F>l.dragThreshold&&(I("开始拖拽",{distance:F,threshold:l.dragThreshold}),a(Oe.DRAGGING),k("grabbing"),b({...T,isDragging:!0}))};let se=!1,te=0;const re=(x,T=!1)=>{if(T){x();return}Date.now()-te>=l.updateThrottle&&!se&&(se=!0,requestAnimationFrame(()=>{x(),se=!1,te=Date.now()}))},oe=x=>{const T=c();if(!T)return;const F={x:x.x-T.startPoint.x,y:x.y-T.startPoint.y};b({...T,currentOffset:F}),re(()=>{if(e.onBatchUpdatePositions&&T.elementIds.length>1){const O=T.elementIds.map(W=>{const le=T.startPositions.get(W);return le?{element_id:W,new_position:{x:le.x+F.x,y:le.y+F.y}}:null}).filter(Boolean);O.length>0&&e.onBatchUpdatePositions(O).catch(()=>{})}else if(e.onElementMove){const O=T.elementIds.map(W=>{const le=T.startPositions.get(W);if(le)return e.onElementMove(W,{x:le.x+F.x,y:le.y+F.y})}).filter(Boolean);Promise.allSettled(O).catch(()=>{})}})},X=x=>{const T=u();if(!T)return;const F={...T,currentPoint:x};v(F);const O={x:Math.min(T.startPoint.x,x.x),y:Math.min(T.startPoint.y,x.y),width:Math.abs(x.x-T.startPoint.x),height:Math.abs(x.y-T.startPoint.y)},le=S(O).map(K=>K.id);v({...F,selectedIds:le}),g(le)},G=x=>{const T=_();if(!T)return;const F=x.x-T.startPoint.x,O=x.y-T.startPoint.y,W=fe(T.handlePosition,F,O,T.initialSize,T.initialPosition);re(()=>{e.onElementResize&&e.onElementResize(T.elementId,W.size,W.position)})},fe=(x,T,F,O,W)=>{let le=O.width,K=O.height,ye=W.x,ke=W.y;switch(x){case"nw":le=O.width-T,K=O.height-F,ye=W.x+T,ke=W.y+F;break;case"ne":le=O.width+T,K=O.height-F,ke=W.y+F;break;case"sw":le=O.width-T,K=O.height+F,ye=W.x+T;break;case"se":le=O.width+T,K=O.height+F;break;case"n":K=O.height-F,ke=W.y+F;break;case"s":K=O.height+F;break;case"w":le=O.width-T,ye=W.x+T;break;case"e":le=O.width+T;break}const ae=10;return le=Math.max(ae,le),K=Math.max(ae,K),{size:{width:le,height:K},position:{x:ye,y:ke}}},me=()=>{const x=s();if(I("鼠标释放",{currentMode:x,hasResizeState:!!_()}),_()){Se();return}x===Oe.DRAGGING?be():x===Oe.SELECTING&&ue(),Z()},be=()=>{const x=c();if(!x||!x.isDragging&&x.currentOffset.x===0&&x.currentOffset.y===0){I("拖拽完成，无实际移动");return}if(e.onBatchUpdatePositions&&x.elementIds.length>1){const T=x.elementIds.map(F=>{const O=x.startPositions.get(F);return O?{element_id:F,new_position:{x:O.x+x.currentOffset.x,y:O.y+x.currentOffset.y}}:null}).filter(Boolean);T.length>0&&(I("拖拽完成 - 批量更新",{elementCount:T.length}),e.onBatchUpdatePositions(T).catch(F=>{console.warn("批量更新最终位置失败:",F)}))}},ue=()=>{const x=u();x&&(I("框选完成",{selectedCount:x.selectedIds.length}),e.onElementsSelect&&e.onElementsSelect(x.selectedIds))},Se=()=>{const x=_();x&&(I("完成resize操作",{elementId:x.elementId}),n(!1),C(null))},Z=()=>{a(Oe.IDLE),k("default"),b(null),v(null),C(null),n(!1),p(),I("状态重置完成")};Ue(async()=>{document.addEventListener("mousemove",A),document.addEventListener("mouseup",me),I("修复版交互层已初始化")}),ut(()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",me),I("修复版交互层已清理")});const ge=()=>{const x=u();if(!x||s()!==Oe.SELECTING)return null;const{startPoint:T,currentPoint:F}=x;return{x:Math.min(T.x,F.x),y:Math.min(T.y,F.y),width:Math.abs(F.x-T.x),height:Math.abs(F.y-T.y)}};return(()=>{var x=es();x.$$mousedown=z;var T=i;return typeof T=="function"?Ft(T,x):i=x,x.style.setProperty("position","absolute"),x.style.setProperty("top","0"),x.style.setProperty("left","0"),x.style.setProperty("width","100%"),x.style.setProperty("height","100%"),x.style.setProperty("z-index","10"),x.style.setProperty("pointer-events","all"),x.style.setProperty("background","transparent"),x.style.setProperty("user-select","none"),r(x,(()=>{var F=_e(()=>!!ge());return()=>F()&&(()=>{var O=ts();return O.style.setProperty("position","absolute"),O.style.setProperty("border","1px dashed #007acc"),O.style.setProperty("background","rgba(0, 122, 204, 0.1)"),O.style.setProperty("pointer-events","none"),P(W=>{var le=`${ge().x}px`,K=`${ge().y}px`,ye=`${ge().width}px`,ke=`${ge().height}px`;return le!==W.e&&((W.e=le)!=null?O.style.setProperty("left",le):O.style.removeProperty("left")),K!==W.t&&((W.t=K)!=null?O.style.setProperty("top",K):O.style.removeProperty("top")),ye!==W.a&&((W.a=ye)!=null?O.style.setProperty("width",ye):O.style.removeProperty("width")),ke!==W.o&&((W.o=ke)!=null?O.style.setProperty("height",ke):O.style.removeProperty("height")),W},{e:void 0,t:void 0,a:void 0,o:void 0}),O})()})(),null),r(x,(()=>{var F=_e(()=>!!e.enableDebugMode);return()=>F()&&(()=>{var O=ns(),W=O.firstChild,le=W.nextSibling;le.firstChild;var K=le.nextSibling;K.firstChild;var ye=K.nextSibling;return ye.firstChild,O.style.setProperty("position","fixed"),O.style.setProperty("top","10px"),O.style.setProperty("right","10px"),O.style.setProperty("padding","8px"),O.style.setProperty("background","rgba(0, 0, 0, 0.8)"),O.style.setProperty("color","white"),O.style.setProperty("font-family","monospace"),O.style.setProperty("font-size","12px"),O.style.setProperty("border-radius","4px"),O.style.setProperty("z-index","9999"),O.style.setProperty("pointer-events","none"),r(le,s,null),r(K,()=>o().length,null),r(ye,E,null),r(O,(()=>{var ke=_e(()=>{var ae;return!!((ae=c())!=null&&ae.isDragging)});return()=>ke()&&(()=>{var ae=ls(),Ae=ae.firstChild,Pe=Ae.nextSibling;return Pe.nextSibling,ae.style.setProperty("color","#ffeb3b"),r(ae,()=>{var Ne;return(Ne=c())==null?void 0:Ne.elementIds.length},Pe),ae})()})(),null),r(O,(()=>{var ke=_e(()=>o().length>0);return()=>ke()&&(()=>{var ae=is(),Ae=ae.firstChild,Pe=Ae.nextSibling;return Pe.nextSibling,ae.style.setProperty("font-size","10px"),ae.style.setProperty("color","#ccc"),r(ae,()=>o().slice(0,3).join(", "),Pe),r(ae,()=>o().length>3&&"...",Pe),ae})()})(),null),O})()})(),null),x})()};De(["mousedown"]);var rs=m("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),as=m("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),os=m('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),cs=m('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const ds=(e,t)=>{if(e.length<2)return[];const n=e.map(l=>({x:l.position.x,y:l.position.y,width:l.size.width,height:l.size.height}));return n.map((l,i)=>{let s=l.x,a=l.y;switch(t){case"left":s=Math.min(...n.map(u=>u.x));break;case"right":s=Math.max(...n.map(u=>u.x+u.width))-l.width;break;case"top":a=Math.min(...n.map(u=>u.y));break;case"bottom":a=Math.max(...n.map(u=>u.y+u.height))-l.height;break;case"h_center":s=n.reduce((u,v)=>u+v.x+v.width/2,0)/n.length-l.width/2;break;case"v_center":a=n.reduce((u,v)=>u+v.y+v.height/2,0)/n.length-l.height/2;break}return{element_id:e[i].id,new_position:{x:s,y:a}}})},us=e=>{const{batchUpdatePositions:t,state:n}=Ge(),[l,i]=Y(!1),s=()=>e.selectedElementIds().length>=2,a=()=>{const b=e.selectedElementIds();return n.elements.filter(u=>b.includes(u.id))},o=async b=>{const u=a();if(u.length<2){console.warn("对齐功能需要至少2个元素");return}try{i(!0),console.log(`🎯 执行${b}对齐:`,u.length,"个元素");const v=ds(u,b);await t(v),console.log("✅ 对齐操作完成"),e.onAlignmentComplete&&e.onAlignmentComplete(v)}catch(v){console.error("❌ 对齐操作失败:",v)}finally{i(!1)}},g=()=>a().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>g();return(()=>{var b=cs(),u=b.firstChild,v=u.firstChild,f=v.nextSibling,d=f.firstChild,y=d.nextSibling,$=y.nextSibling,p=u.nextSibling,_=p.firstChild,C=_.nextSibling,E=C.firstChild,k=E.nextSibling,I=k.nextSibling,N=p.nextSibling,q=N.firstChild,j=q.nextSibling,D=j.firstChild,L=D.nextSibling;return d.$$click=()=>o("left"),y.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"h_center")}),y.$$click=()=>o("h_center"),$.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"right")}),$.$$click=()=>o("right"),E.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"top")}),E.$$click=()=>o("top"),k.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"v_center")}),k.$$click=()=>o("v_center"),I.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"bottom")}),I.$$click=()=>o("bottom"),D.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"distribute_h")}),D.$$click=()=>o("distribute_h"),L.addEventListener("mouseenter",()=>{var S;return(S=e.onAlignmentPreview)==null?void 0:S.call(e,"distribute_v")}),L.$$click=()=>o("distribute_v"),r(b,h(R,{get when(){return _e(()=>!!s())()&&c()},get children(){var S=rs(),Q=S.firstChild,U=Q.nextSibling,w=U.firstChild,A=w.nextSibling,V=U.nextSibling;return U.$$click=()=>o(c().recommended),r(A,()=>c().recommended==="left"&&"左对齐",null),r(A,()=>c().recommended==="right"&&"右对齐",null),r(A,()=>c().recommended==="top"&&"顶对齐",null),r(A,()=>c().recommended==="bottom"&&"底对齐",null),r(A,()=>c().recommended==="h_center"&&"水平居中",null),r(A,()=>c().recommended==="v_center"&&"垂直居中",null),r(V,()=>c().reason),P(z=>{var M=l(),J=c().reason;return M!==z.e&&(U.disabled=z.e=M),J!==z.t&&B(U,"title",z.t=J),z},{e:void 0,t:void 0}),S}}),null),r(b,h(R,{get when(){return!s()},get children(){var S=as(),Q=S.firstChild;return Q.firstChild,r(Q,()=>e.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),S}}),null),r(b,h(R,{get when(){return l()},get children(){return os()}}),null),P(S=>{var Q=!s()||l(),U=!s()||l(),w=!s()||l(),A=!s()||l(),V=!s()||l(),z=!s()||l(),M=e.selectedElementIds().length<3||l(),J=e.selectedElementIds().length<3||l();return Q!==S.e&&(d.disabled=S.e=Q),U!==S.t&&(y.disabled=S.t=U),w!==S.a&&($.disabled=S.a=w),A!==S.o&&(E.disabled=S.o=A),V!==S.i&&(k.disabled=S.i=V),z!==S.n&&(I.disabled=S.n=z),M!==S.s&&(D.disabled=S.s=M),J!==S.h&&(L.disabled=S.h=J),S},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),b})()},gs=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const e=document.createElement("style");e.textContent=gs,document.head.appendChild(e)}De(["click"]);var hs=m("<div>"),vs=m('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),fs=m("<span class=ml-2>Zoom: <!>%");const ms=()=>{const{state:e,selectElement:t,clearSelection:n,createElement:l,selectMultiple:i,updateElement:s,batchUpdatePositions:a}=Ge();let o;const[g,c]=Y([]),b=Ce(()=>e.elements.filter(C=>C.visible)),u=(C,E)=>{if(!o)return{x:0,y:0};const k=o.getBoundingClientRect(),I=(C-k.left)/e.canvas_config.zoom,N=(E-k.top)/e.canvas_config.zoom;return{x:I,y:N}},v=async C=>{console.log("🎯 选择元素",C),c([...C]);try{C.length===0?await n():C.length===1?await t(C[0]):await i([...C])}catch(E){console.error("❌ 选择元素失败:",E)}},f=async C=>{try{await a(C)}catch(E){console.error("❌ 批量更新位置失败:",E)}},d=async(C,E)=>{try{await s(C,{position:{x:E.x,y:E.y}})}catch(k){console.error("❌ 移动元素失败:",k)}},y=async(C,E,k)=>{try{await s(C,{size:E,position:k})}catch(I){console.error("❌ 调整大小失败:",I)}},$=async C=>{console.log("🖱️ 画布点击",C)},p=async C=>{var E;C.preventDefault();try{const k=(E=C.dataTransfer)==null?void 0:E.getData("application/json");if(!k)return;const{type:I,component:N}=JSON.parse(k);if(I==="component"){const{x:q,y:j}=u(C.clientX,C.clientY),D=Math.max(0,q-N.default_size.width/2),L=Math.max(0,j-N.default_size.height/2);console.log("🎯 通过拖放创建组件:",N.name,"at",D,L);const S=await l(N.id,{x:D,y:L},N.default_size,N.create_content());console.log("✅ 通过拖放创建元素成功:",S),c([S]),await t(S)}}catch(k){console.error("拖放处理失败:",k)}};Ue(()=>{c([...e.selected_ids])}),Ce(()=>{c([...e.selected_ids])});const _=Ce(()=>{const{width:C,height:E}=e.canvas_config;return`0 0 ${C} ${E}`});return(()=>{var C=vs(),E=C.firstChild,k=E.firstChild,I=k.firstChild,N=I.nextSibling,q=N.nextSibling,j=q.nextSibling,D=j.nextSibling,L=D.nextSibling,S=L.firstChild,Q=S.nextSibling;Q.nextSibling;var U=E.nextSibling,w=U.firstChild,A=w.firstChild,V=A.firstChild,z=V.firstChild,M=z.nextSibling,J=M.nextSibling,de=J.nextSibling;r(k,()=>e.canvas_config.width,N),r(k,()=>e.canvas_config.height,j),r(k,(()=>{var H=_e(()=>e.canvas_config.zoom!==1);return()=>H()&&(()=>{var ne=fs(),ve=ne.firstChild,ie=ve.nextSibling;return ie.nextSibling,r(ne,()=>Math.round(e.canvas_config.zoom*100),ie),ne})()})(),L),r(L,()=>e.elements.length,Q),r(L,()=>g().length,null),A.style.setProperty("position","relative"),V.addEventListener("drop",p),V.addEventListener("dragover",H=>{H.preventDefault(),H.dataTransfer.dropEffect="copy"}),V.$$contextmenu=H=>H.preventDefault();var ee=o;return typeof ee=="function"?Ft(ee,V):o=V,r(V,h(zi,{get config(){return e.canvas_config}}),M),r(J,h(ce,{get each(){return b()},children:H=>h(Gi,{element:H,get selected(){return g().includes(H.id)}})})),r(de,h(ce,{get each(){return b().filter(H=>g().includes(H.id))},children:H=>h(Xi,{element:H})})),r(A,h(ss,{canvasRef:o,getAllElements:()=>[...e.elements],onElementsSelect:v,onElementMove:d,onBatchUpdatePositions:f,onElementResize:y,onCanvasClick:$,get enableDebugMode(){return!1}}),null),r(A,h(R,{get when(){return g().length>=2},get children(){var H=hs();return H.style.setProperty("position","fixed"),H.style.setProperty("top","80px"),H.style.setProperty("right","20px"),H.style.setProperty("z-index","1000"),H.style.setProperty("background","white"),H.style.setProperty("border-radius","8px"),H.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),H.style.setProperty("border","1px solid #e5e7eb"),r(H,h(us,{selectedElementIds:g,onAlignmentComplete:ne=>{console.log("✅ 对齐操作完成:",ne)},onAlignmentPreview:ne=>{console.log("👁️ 对齐预览:",ne)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),H}}),null),P(H=>{var ne=e.canvas_config.width*e.canvas_config.zoom,ve=e.canvas_config.height*e.canvas_config.zoom,ie=_(),se=e.canvas_config.width,te=e.canvas_config.height,re=e.canvas_config.background_color,oe=e.canvas_config.width,X=e.canvas_config.height;return ne!==H.e&&B(V,"width",H.e=ne),ve!==H.t&&B(V,"height",H.t=ve),ie!==H.a&&B(V,"viewBox",H.a=ie),se!==H.o&&B(z,"width",H.o=se),te!==H.i&&B(z,"height",H.i=te),re!==H.n&&B(z,"fill",H.n=re),oe!==H.s&&B(M,"width",H.s=oe),X!==H.h&&B(M,"height",H.h=X),H},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),C})()};De(["contextmenu"]);var bs=m("<div class=wizard-errors>"),ys=m("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),ps=m("<div class=error-message>"),$s=m("<div class=wizard-progress>"),_s=m("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),xs=m("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),Ss=m("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),ws=m("<span class=feature-tag>"),Cs=m("<div class=data-input-step><div class=step-header><h4></h4><p>"),ks=m("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),Ts=m("<div class=file-error>"),Es=m('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),Ls=m("<div class=field-error>"),Ds=m("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),Ps=m('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),As=m('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),zs=m("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),Rs=m("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),Ms=m('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),Ns=m("<span class=status-success>✅ JSON格式正确"),Os=m("<span class=status-error>❌ 格式错误"),Is=m("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),Us=m("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),Fs=m(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),qs=m("<div class=template-item><div class=template-name></div><div class=template-description>"),Bs=m("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),js=m("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Qs=m('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),Hs=m("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),Js=m("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),Vs=m("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),Ws=m("<li>首次配置数据源时，建议先测试连接确保配置正确"),Gs=m("<li>测试过程会验证JSON格式和文件访问权限"),Ks=m("<li>预览功能可以帮助您确认数据结构是否符合预期"),Ys=m("<li>✅ 连接测试成功！您可以继续创建数据源"),Xs=m("<li>预览显示的是实际数据，创建后可用于报表设计"),Zs=m("<li>字段名称将用于数据绑定表达式"),er=m("<li>❌ 请检查JSON格式是否正确"),tr=m("<li>如果是文件类型，请确认文件路径存在且可访问"),nr=m("<li>可以返回上一步修改配置后重新测试"),lr=m("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),ir=m("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),sr=m("<span class=loading-spinner>⏳"),rr=m("<span class=test-button-icon>🔌"),ar=m("<div class=field-tag><span class=field-name>"),or=m("<th>"),cr=m("<tr>"),dr=m("<td><div class=cell-content>"),ur=m("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),gr=m('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),hr=m('<button class="control-btn finish-btn">'),vr=m("<span class=hint-text>选择您的JSON数据来源方式"),Xt=m("<span class=hint-text>"),fr=m("<span class=hint-text>设置数据源名称和选项"),mr=m('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),br=m("<span class=btn-loading>⏳"),yr=m("<span class=btn-text>创建中..."),pr=m("<span class=btn-icon>✓"),$r=m("<span class=btn-text>创建数据源");function kn(e){const[t,n]=Y({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),l=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],i=Ce(()=>{const d=t();switch(d.currentStep){case 1:return d.sourceType!==null;case 2:return s(d);case 3:return a(d);case 4:return o(d);default:return!1}}),s=d=>{var y,$;if(d.sourceType==="file")return!!((y=d.config.file_path)!=null&&y.trim());if(d.sourceType==="content"){const p=($=d.config.json_content)==null?void 0:$.trim();if(!p)return!1;try{return JSON.parse(p),!0}catch{return!1}}return!1},a=d=>{const y=d.name.trim();return!(y.length<2||y.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(y))},o=d=>{var y;return!!((y=d.testResult)!=null&&y.success)},g=d=>{const y=t();n($=>({...$,validation:{...$.validation,errors:[]}})),y.currentStep===1&&y.sourceType?n($=>({...$,currentStep:d,config:{...$.config,source_type:y.sourceType}})):n($=>({...$,currentStep:d}))},c=()=>{const d=t();d.currentStep<4&&i()&&g(d.currentStep+1)},b=()=>{const d=t();d.currentStep>1&&(d.currentStep===4?n(y=>({...y,currentStep:y.currentStep-1,testResult:null})):g(d.currentStep-1))},u=d=>{n(y=>({...y,...d}))},v=async()=>{var y,$;const d=t();u({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const p={...d.config,source_type:d.sourceType};if(await we.testConnection("json",p)){console.log("✅ 连接测试成功，获取预览数据...");const C=await we.discoverSchema("json",p),E=`temp_${Date.now()}`,k=await we.createDataSource(E,"json",p),I=await we.getPreview(k,void 0,5);await we.deleteDataSource(k),u({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:($=(y=I.total_rows)!=null?y:I.total_count)!=null?$:0,fields:C.columns.map(N=>N.name),sample_data:I.rows}},loading:!1})}}catch(p){console.error("❌ 连接测试失败:",p),u({testResult:{success:!1,message:"连接测试失败",error:p instanceof Error?p.message:String(p)},loading:!1})}},f=async()=>{const d=t();u({loading:!0});try{console.log("🔄 开始创建数据源...");const y={...d.config,source_type:d.sourceType},$=await we.createDataSource(d.name,"json",y);console.log("✅ 数据源创建成功，ID:",$);try{await Be.setActiveDataSource($),console.log("✅ 数据源自动激活成功")}catch(p){console.warn("⚠️ 数据源激活失败，但创建成功:",p)}e.onSuccess(),e.onBack()}catch(y){console.error("❌ 创建数据源失败:",y),u({validation:{isValid:!1,errors:[`创建失败: ${y}`],warnings:[]},loading:!1})}};return(()=>{var d=ys(),y=d.firstChild,$=y.firstChild,p=$.nextSibling,_=p.firstChild,C=_.nextSibling,E=y.nextSibling;return Te($,"click",e.onBack),r(C,()=>{var k;return(k=l[t().currentStep-1])==null?void 0:k.description}),r(d,h(_r,{get currentStep(){return t().currentStep},stepInfo:l,onStepClick:g}),E),r(E,h(R,{get when(){return t().currentStep===1},get children(){return h(xr,{get selectedType(){return t().sourceType},onSelect:k=>u({sourceType:k,config:{...t().config,source_type:k}})})}}),null),r(E,h(R,{get when(){return t().currentStep===2},get children(){return h(Sr,{get sourceType(){return t().sourceType},get config(){return t().config},onConfigUpdate:k=>u({config:{...t().config,...k}})})}}),null),r(E,h(R,{get when(){return t().currentStep===3},get children(){return h(Cr,{get name(){return t().name},get config(){return t().config},onNameChange:k=>u({name:k}),onConfigUpdate:k=>u({config:{...t().config,...k}})})}}),null),r(E,h(R,{get when(){return t().currentStep===4},get children(){return h(Tr,{get config(){return t().config},get testResult(){return t().testResult},get loading(){return t().loading},onTest:v})}}),null),r(d,h(Er,{get currentStep(){return t().currentStep},get canProceed(){return i()},get loading(){return t().loading},get testResult(){return t().testResult},onPrevious:b,onNext:c,onFinish:f}),null),r(d,h(R,{get when(){return t().validation.errors.length>0},get children(){var k=bs();return r(k,h(ce,{get each(){return t().validation.errors},children:I=>(()=>{var N=ps();return r(N,I),N})()})),k}}),null),d})()}function _r(e){return(()=>{var t=$s();return r(t,h(ce,{get each(){return e.stepInfo},children:n=>{const l=e.currentStep===n.step,i=e.currentStep>n.step,s=e.currentStep>=n.step;return(()=>{var a=_s(),o=a.firstChild,g=o.firstChild,c=o.nextSibling,b=c.firstChild,u=b.nextSibling;return a.$$click=()=>s&&e.onStepClick(n.step),$e(a,`progress-step ${l?"active":""} ${i?"completed":""}`),r(g,()=>i?"✓":n.step),r(b,()=>n.title),r(u,()=>n.description),a})()}})),t})()}function xr(e){const t=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var n=xs(),l=n.firstChild,i=l.nextSibling;return r(i,h(ce,{each:t,children:s=>(()=>{var a=Ss(),o=a.firstChild,g=o.firstChild,c=g.nextSibling,b=o.nextSibling,u=b.nextSibling,v=u.nextSibling,f=v.firstChild;return a.$$click=()=>e.onSelect(s.type),r(g,()=>s.title),r(c,()=>s.description),r(b,h(ce,{get each(){return s.features},children:d=>(()=>{var y=ws();return r(y,d),y})()})),r(u,()=>s.example),f.addEventListener("change",()=>e.onSelect(s.type)),P(()=>$e(a,`source-option ${e.selectedType===s.type?"selected":""}`)),P(()=>f.checked=e.selectedType===s.type),a})()})),n})()}function Sr(e){return(()=>{var t=Cs(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return r(l,()=>e.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),r(i,()=>e.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),r(t,h(R,{get when(){return e.sourceType==="file"},get children(){return h(wr,{get filePath(){return e.config.file_path||""},onFileSelect:s=>e.onConfigUpdate({file_path:s})})}}),null),r(t,h(R,{get when(){return e.sourceType==="content"},get children(){return h(kr,{get content(){return e.config.json_content||""},onContentChange:s=>e.onConfigUpdate({json_content:s})})}}),null),t})()}function wr(e){const[t,n]=Y(!1),[l,i]=Y(null),s=g=>{var u;const b=(u=g.target.files)==null?void 0:u[0];b&&o(b)},a=g=>{var b,u;g.preventDefault(),n(!1);const c=(u=(b=g.dataTransfer)==null?void 0:b.files)==null?void 0:u[0];c&&o(c)},o=g=>{if(i(null),!g.name.endsWith(".json")){i("请选择JSON文件（.json格式）");return}if(g.size>10*1024*1024){i("文件大小不能超过10MB");return}const c=new FileReader;c.onload=b=>{var u;try{const v=(u=b.target)==null?void 0:u.result;JSON.parse(v),e.onFileSelect(g.name),console.log("✅ 文件选择成功:",g.name)}catch{i("文件内容不是有效的JSON格式")}},c.readAsText(g)};return(()=>{var g=Es(),c=g.firstChild,b=c.nextSibling,u=b.firstChild,v=u.firstChild,f=b.nextSibling;return c.addEventListener("drop",a),c.addEventListener("dragleave",()=>n(!1)),c.addEventListener("dragover",d=>{d.preventDefault(),n(!0)}),v.addEventListener("change",s),r(b,h(R,{get when(){return e.filePath},get children(){var d=ks(),y=d.firstChild,$=y.nextSibling,p=$.nextSibling;return r($,()=>e.filePath),p.$$click=()=>e.onFileSelect(""),d}}),null),r(g,h(R,{get when(){return l()},get children(){var d=Ts();return r(d,l),d}}),f),P(()=>$e(c,`file-drop-zone ${t()?"active":""}`)),g})()}function Cr(e){const[t,n]=Y(null),l=s=>{e.onNameChange(s),s.trim().length===0?n("数据源名称不能为空"):s.trim().length<2?n("数据源名称至少需要2个字符"):s.trim().length>50?n("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(s.trim())?n(null):n("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},i=s=>{const a=parseInt(s);!isNaN(a)&&a>=10&&a<=3600&&e.onConfigUpdate({refresh_interval:a})};return(()=>{var s=Ms(),a=s.firstChild,o=a.nextSibling,g=o.firstChild,c=g.firstChild,b=c.nextSibling,u=b.firstChild,v=u.nextSibling,f=v.nextSibling,d=g.nextSibling,y=d.firstChild,$=y.nextSibling,p=$.firstChild,_=p.firstChild,C=_.nextSibling;return v.$$input=E=>l(E.currentTarget.value),r(b,h(R,{get when(){return t()},get children(){var E=Ls();return r(E,t),E}}),f),r(o,h(R,{get when(){return e.config.source_type==="file"},get children(){var E=Ps(),k=E.firstChild,I=k.nextSibling,N=I.firstChild,q=N.firstChild;return q.addEventListener("change",j=>e.onConfigUpdate({auto_refresh:j.currentTarget.checked})),r(E,h(R,{get when(){return e.config.auto_refresh},get children(){var j=Ds(),D=j.firstChild,L=D.nextSibling,S=L.firstChild,Q=S.nextSibling;return S.$$input=U=>i(U.currentTarget.value),Q.addEventListener("change",U=>i(U.currentTarget.value)),P(()=>S.value=e.config.refresh_interval),P(()=>Q.value=e.config.refresh_interval),j}}),null),P(()=>q.checked=e.config.auto_refresh),E}}),d),r(C,()=>e.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),r($,h(R,{get when(){return e.config.source_type==="file"},get children(){return[(()=>{var E=As(),k=E.firstChild,I=k.nextSibling;return r(I,()=>e.config.file_path||"(未选择文件)"),E})(),(()=>{var E=zs(),k=E.firstChild,I=k.nextSibling;return r(I,()=>e.config.auto_refresh?`✅ 每 ${e.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),E})()]}}),null),r($,h(R,{get when(){return e.config.source_type==="content"},get children(){var E=Rs(),k=E.firstChild,I=k.nextSibling,N=I.firstChild;return r(I,()=>{var q;return((q=e.config.json_content)==null?void 0:q.length)||0},N),E}}),null),P(()=>$e(v,`name-input ${t()?"error":""}`)),P(()=>v.value=e.name),s})()}function kr(e){const[t,n]=Y(null),[l,i]=Y(!1),s=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],a=g=>{if(e.onContentChange(g),g.trim())try{JSON.parse(g),n(null)}catch(c){n(c instanceof Error?c.message:"无效的JSON格式")}else n(null)},o=g=>{e.onContentChange(g.content),n(null),i(!1)};return(()=>{var g=Fs(),c=g.firstChild,b=c.firstChild,u=b.nextSibling,v=u.nextSibling,f=c.nextSibling,d=f.firstChild,y=f.nextSibling;return b.$$click=()=>i(!l()),u.$$click=()=>e.onContentChange(""),r(v,h(R,{get when(){return _e(()=>!t())()&&e.content.trim()},get children(){return Ns()}}),null),r(v,h(R,{get when(){return t()},get children(){return Os()}}),null),r(g,h(R,{get when(){return l()},get children(){var $=Is(),p=$.firstChild,_=p.nextSibling;return r(_,h(ce,{each:s,children:C=>(()=>{var E=qs(),k=E.firstChild,I=k.nextSibling;return E.$$click=()=>o(C),r(k,()=>C.name),r(I,()=>C.description),E})()})),$}}),f),d.$$input=$=>a($.currentTarget.value),r(g,h(R,{get when(){return t()},get children(){var $=Us(),p=$.firstChild,_=p.nextSibling;return r(_,t),$}}),y),P($=>{var p=!e.content,_=`json-textarea ${t()?"error":""}`;return p!==$.e&&(u.disabled=$.e=p),_!==$.t&&$e(d,$.t=_),$},{e:void 0,t:void 0}),P(()=>d.value=e.content),g})()}function Tr(e){const[t,n]=Y(!1),l=()=>e.loading?"🔄":e.testResult?e.testResult.success?"✅":"❌":"⚡",i=()=>e.loading?"测试连接中...":e.testResult?e.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",s=()=>e.loading?"testing":e.testResult?e.testResult.success?"success":"error":"ready",a=o=>typeof o=="object"?JSON.stringify(o,null,2):String(o);return(()=>{var o=ir(),g=o.firstChild,c=g.nextSibling,b=c.firstChild,u=b.firstChild,v=u.firstChild,f=v.firstChild,d=f.nextSibling,y=v.nextSibling,$=b.nextSibling,p=$.firstChild,_=p.nextSibling;return r(f,l),r(d,i),Te(y,"click",e.onTest),r(y,(()=>{var C=_e(()=>!!e.loading);return()=>C()?[sr(),"测试中..."]:[rr(),"测试连接"]})()),r(b,h(R,{get when(){return e.testResult},get children(){var C=js(),E=C.firstChild,k=E.firstChild,I=k.nextSibling;return r(k,l),r(I,()=>e.testResult.message),r(C,h(R,{get when(){return e.testResult.error},get children(){var N=Bs(),q=N.firstChild,j=q.nextSibling;return r(j,()=>e.testResult.error),N}}),null),P(()=>$e(C,`test-result ${s()}`)),C}}),null),r(c,h(R,{get when(){var C;return((C=e.testResult)==null?void 0:C.success)&&e.testResult.preview},get children(){var C=Vs(),E=C.firstChild,k=E.firstChild,I=k.nextSibling,N=I.firstChild,q=N.firstChild,j=q.nextSibling,D=N.nextSibling,L=D.firstChild,S=L.nextSibling,Q=E.nextSibling,U=Q.firstChild,w=U.nextSibling,A=Q.nextSibling,V=A.firstChild,z=V.nextSibling,M=z.firstChild,J=M.firstChild,de=J.firstChild,ee=J.nextSibling,H=A.nextSibling,ne=H.firstChild,ve=ne.firstChild;return r(j,()=>e.testResult.preview.record_count),r(S,()=>e.testResult.preview.fields.length),r(w,h(ce,{get each(){return e.testResult.preview.fields},children:ie=>(()=>{var se=ar(),te=se.firstChild;return r(te,ie),se})()})),r(de,h(ce,{get each(){return e.testResult.preview.fields},children:ie=>(()=>{var se=or();return r(se,ie),se})()})),r(ee,h(ce,{get each(){return e.testResult.preview.sample_data},children:ie=>(()=>{var se=cr();return r(se,h(ce,{get each(){return e.testResult.preview.fields},children:te=>(()=>{var re=dr(),oe=re.firstChild;return r(oe,(()=>{var X=_e(()=>ie[te]!==void 0);return()=>X()?a(ie[te]):"-"})()),re})()})),se})()})),ne.$$click=()=>n(!t()),r(ve,()=>t()?"▼":"▶"),r(H,h(R,{get when(){return t()},get children(){var ie=Js(),se=ie.firstChild,te=se.firstChild,re=te.firstChild,oe=re.nextSibling,X=te.nextSibling;return r(oe,()=>e.config.source_type==="file"?"JSON文件":"JSON内容"),r(se,h(R,{get when(){return e.config.source_type==="file"},get children(){return[(()=>{var G=Qs(),fe=G.firstChild,me=fe.nextSibling;return r(me,()=>e.config.file_path),G})(),(()=>{var G=Hs(),fe=G.firstChild,me=fe.nextSibling;return r(me,()=>e.config.auto_refresh?"已启用":"已禁用"),G})()]}}),X),ie}}),null),C}}),$),r(_,h(R,{get when(){return!e.testResult},get children(){return[Ws(),Gs(),Ks()]}}),null),r(_,h(R,{get when(){var C;return(C=e.testResult)==null?void 0:C.success},get children(){return[Ys(),Xs(),Zs()]}}),null),r(_,h(R,{get when(){return e.testResult&&!e.testResult.success},get children(){return[er(),tr(),nr()]}}),null),r(c,h(R,{get when(){return e.config.source_type==="file"},get children(){return lr()}}),null),P(C=>{var E=`test-button ${s()}`,k=e.loading;return E!==C.e&&$e(y,C.e=E),k!==C.t&&(y.disabled=C.t=k),C},{e:void 0,t:void 0}),o})()}function Er(e){const t=s=>{switch(s){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${s}`}},n=()=>e.currentStep>1,l=()=>e.currentStep<4&&e.canProceed,i=()=>e.currentStep===4&&e.canProceed;return(()=>{var s=mr(),a=s.firstChild,o=a.firstChild,g=o.firstChild,c=g.nextSibling;c.nextSibling;var b=a.nextSibling,u=b.firstChild,v=b.nextSibling;return r(o,()=>e.currentStep,c),r(o,()=>t(e.currentStep),null),r(a,h(R,{get when(){return!e.canProceed&&e.currentStep<4},get children(){return ur()}}),null),Te(u,"click",e.onPrevious),r(b,h(R,{get when(){return e.currentStep<4},get children(){var f=gr();return Te(f,"click",e.onNext),P(()=>f.disabled=!l()||e.loading),f}}),null),r(b,h(R,{get when(){return e.currentStep===4},get children(){var f=hr();return Te(f,"click",e.onFinish),r(f,(()=>{var d=_e(()=>!!e.loading);return()=>d()?[br(),yr()]:[pr(),$r()]})()),P(()=>f.disabled=!i()||e.loading),f}}),null),r(v,h(R,{get when(){return e.currentStep===1},get children(){return vr()}}),null),r(v,h(R,{get when(){return e.currentStep===2},get children(){var f=Xt();return r(f,()=>{var d;return(d=e.testResult)!=null&&d.success?"数据格式验证成功":"请提供JSON数据内容"}),f}}),null),r(v,h(R,{get when(){return e.currentStep===3},get children(){return fr()}}),null),r(v,h(R,{get when(){return e.currentStep===4},get children(){var f=Xt();return r(f,()=>{var d;return(d=e.testResult)!=null&&d.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"}),f}}),null),P(()=>u.disabled=!n()||e.loading),s})()}De(["click","input"]);var Lr=m("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),Dr=m("<div class=error-message>"),Pr=m("<div class=loading-message>加载中..."),Ar=m("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),zr=m("<div class=sources-grid>"),Rr=m("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),Mr=m("<span class=active-badge title=当前激活>当前"),Nr=m('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),Or=m("<span class=changes-indicator>● 有未保存的更改"),Ir=m("<div class=error-details>"),Ur=m("<div><div class=result-message> "),Fr=m("<div class=error-message>❌ "),qr=m("<button type=button class=reset-btn>重置更改"),Br=m('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),jr=m("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),Qr=m("<th>"),Hr=m("<tr>"),Jr=m("<td>");function Vr(e){const[t,n]=Y([]),[l,i]=Y([]),[s,a]=Y("list"),[o,g]=Y(null),[c,b]=Y(null),[u,v]=Y(!1),[f,d]=Y(null),[y,$]=Y(null);Ue(async()=>{var j;try{await p(),await _();const D=Be.subscribe(L=>{$((L==null?void 0:L.dataSource.id)||null)});$(((j=Be.getCurrentContext())==null?void 0:j.dataSource.id)||null),ut(D)}catch(D){console.error("🚨 DataSourcesPanel初始化失败:",D),d(`数据源模块初始化失败: ${D}`)}});const p=async()=>{try{v(!0),console.log("🔄 开始加载数据源列表...");const j=await we.listDataSources();console.log("✅ 数据源列表加载成功:",j),n(j),d(null)}catch(j){console.error("❌ 加载数据源失败:",j),d(`加载数据源失败: ${j}`)}finally{v(!1)}},_=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const j=await we.getAvailableTypes();console.log("✅ 数据源类型加载成功:",j),i(j)}catch(j){console.error("❌ 加载数据源类型失败:",j)}},C=()=>{a("add"),g(null)},E=j=>{g(j),a("edit")},k=async j=>{try{v(!0),d(null),g(j),console.log("🔄 开始预览数据源:",j.name),j.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",j.status),d(`数据源状态为 ${j.status}，可能无法预览数据`));const D=await we.getPreview(j.id);b(D),a("preview"),console.log("✅ 数据预览加载成功:",D)}catch(D){console.error("❌ 数据预览失败:",D);const L=`预览数据源 "${j.name}" 失败: ${D}`;d(L);const S={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},Q=String(D).toLowerCase(),U=Object.keys(S).find(w=>Q.includes(w));U&&d(`预览失败: ${S[U]}`)}finally{v(!1)}},I=async j=>{if(confirm("确定要删除这个数据源吗？"))try{await we.deleteDataSource(j),await p()}catch(D){d(`删除数据源失败: ${D}`)}},N=async j=>{try{v(!0),d(null),await Be.setActiveDataSource(j.id)}catch(D){console.error("❌ 激活数据源失败:",D),d(`激活数据源失败: ${D}`)}finally{v(!1)}},q=async j=>{try{v(!0),d(null),console.log("🔄 开始测试数据源连接:",j);const D=t().find(Q=>Q.id===j);if(!D){const Q=`数据源不存在: ${j}`;console.error("❌",Q),d(Q);return}console.log("📋 数据源信息:",{id:D.id,name:D.name,type_name:D.type_name,provider_type:D.provider_type,config:D.config});let L=D.provider_type||D.type_name;(D.name.includes("MySQL")||D.name.includes("数据库")||JSON.stringify(D.config).includes("mysql")||JSON.stringify(D.config).includes("3306"))&&(L="database",console.log("🗄️ 检测到数据库类型，使用provider_type: database")),console.log("🔍 调用测试连接API:",{providerType:L,config:D.config});const S=await we.testConnection(L,D.config||{});console.log("📨 API返回结果:",S),S?(console.log("✅ 数据源连接测试成功:",j),alert(`✅ 数据源 "${D.name}" 连接测试成功！

🎉 数据库连接正常，可以正常使用`)):(console.log("❌ 数据源连接测试失败:",j),alert(`❌ 数据源 "${D.name}" 连接测试失败

请检查配置信息是否正确`))}catch(D){console.error("❌ 测试连接时发生错误:",D),console.error("❌ 错误详情:",{error:D,errorType:typeof D,errorString:String(D),errorJSON:JSON.stringify(D,null,2)});const L=t().find(Q=>Q.id===j),S=`测试连接失败: ${D}`;d(S),!D||String(D)===""||String(D)==="null"?alert(`❌ 数据源 "${(L==null?void 0:L.name)||j}" 连接测试遇到未知错误

请检查：
• 开发者工具控制台的详细错误信息
• 后端服务是否正常运行
• 配置参数是否正确`):alert(`❌ 数据源 "${(L==null?void 0:L.name)||j}" 连接测试失败:

${D}

💡 如果是空错误，请检查开发者工具控制台获取详细信息`)}finally{v(!1)}};return h(R,{get when(){return e.isOpen},get children(){var j=Lr(),D=j.firstChild,L=D.nextSibling,S=L.firstChild,Q=S.nextSibling,U=Q.nextSibling,w=L.nextSibling;return Te(U,"click",e.onClose),r(w,h(R,{get when(){return s()==="list"},get children(){return h(Wr,{get dataSources(){return t()},get loading(){return u()},get error(){return f()},onAdd:C,onEdit:E,onPreview:k,onDelete:I,onActivate:N,onTestConnection:q,onRefresh:p,get activeId(){return y()}})}}),null),r(w,h(R,{get when(){return s()==="add"},get children(){return h(kn,{get availableTypes(){return l()},onBack:()=>a("list"),onSuccess:p})}}),null),r(w,h(R,{get when(){return _e(()=>s()==="edit")()&&o()},get children(){return h(Gr,{get dataSource(){return o()},onBack:()=>a("list"),onSuccess:p})}}),null),r(w,h(R,{get when(){return _e(()=>!!(s()==="preview"&&o()))()&&c()},get children(){return h(Kr,{get dataSource(){return o()},get data(){return c()},onBack:()=>a("list")})}}),null),j}})}function Wr(e){const t=l=>{switch(l){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=l=>new Date(l).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var l=Rr(),i=l.firstChild,s=i.firstChild,a=s.firstChild,o=a.firstChild,g=o.nextSibling;g.nextSibling;var c=a.nextSibling,b=s.nextSibling;return r(a,()=>e.dataSources.length,g),Te(c,"click",e.onRefresh),Te(b,"click",e.onAdd),r(l,h(R,{get when(){return e.error},get children(){var u=Dr();return r(u,()=>e.error),u}}),null),r(l,h(R,{get when(){return e.loading},get children(){return Pr()}}),null),r(l,h(R,{get when(){return!e.loading&&e.dataSources.length===0},get children(){var u=Ar(),v=u.firstChild,f=v.nextSibling;return Te(f,"click",e.onAdd),u}}),null),r(l,h(R,{get when(){return!e.loading&&e.dataSources.length>0},get children(){var u=zr();return r(u,h(ce,{get each(){return e.dataSources},children:v=>(()=>{var f=Nr(),d=f.firstChild,y=d.firstChild,$=y.firstChild,p=$.nextSibling,_=y.nextSibling,C=d.nextSibling,E=C.firstChild,k=E.firstChild,I=k.nextSibling,N=E.nextSibling,q=N.firstChild,j=q.nextSibling,D=C.nextSibling,L=D.firstChild,S=L.nextSibling,Q=S.nextSibling,U=Q.nextSibling,w=U.nextSibling;return r($,()=>v.name,null),r($,h(R,{get when(){return e.activeId===v.id},get children(){return Mr()}}),null),r(p,()=>v.provider_type),r(I,()=>n(v.created_at)),r(j,()=>n(v.last_updated)),L.$$click=()=>e.onPreview(v),S.$$click=()=>e.onActivate(v),Q.$$click=()=>e.onTestConnection(v.id),U.$$click=()=>e.onEdit(v),w.$$click=()=>e.onDelete(v.id),P(A=>{var V=e.activeId===v.id?"true":"false",z=t(v.status),M=`状态: ${v.status}`,J=v.status!=="active",de=e.activeId===v.id;return V!==A.e&&B(f,"data-active",A.e=V),z!==A.t&&((A.t=z)!=null?_.style.setProperty("background-color",z):_.style.removeProperty("background-color")),M!==A.a&&B(_,"title",A.a=M),J!==A.o&&(L.disabled=A.o=J),de!==A.i&&(S.disabled=A.i=de),A},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),f})()})),u}}),null),P(u=>{var v=e.loading,f=e.loading?"正在刷新数据源列表":"刷新数据源列表",d=e.loading?"正在刷新...":"刷新数据源列表";return v!==u.e&&(c.disabled=u.e=v),f!==u.t&&B(c,"aria-label",u.t=f),d!==u.a&&B(c,"title",u.a=d),u},{e:void 0,t:void 0,a:void 0}),l})()}function Gr(e){const[t,n]=Y({name:e.dataSource.name,config:e.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[l]=Y(JSON.stringify(e.dataSource.config||{})),i=()=>{const b=t(),u=b.name!==e.dataSource.name,v=JSON.stringify(b.config)!==l();n(f=>({...f,hasChanges:u||v}))},s=b=>{n(u=>({...u,name:b})),i()},a=b=>{n(u=>({...u,config:b})),i()},o=async()=>{const b=t();n(u=>({...u,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await we.testConnection(e.dataSource.type_name,b.config)&&(console.log("✅ 连接测试成功"),n(v=>({...v,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(u){console.error("❌ 连接测试失败:",u),n(v=>({...v,testResult:{success:!1,message:"连接测试失败",error:u instanceof Error?u.message:String(u)},loading:!1}))}},g=async()=>{const b=t();if(!b.hasChanges){e.onBack();return}if(!b.name.trim()){n(u=>({...u,error:"数据源名称不能为空"}));return}try{n(u=>({...u,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await we.updateConfig(e.dataSource.id,b.config),b.name!==e.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),n(u=>({...u,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),e.onSuccess(),e.onBack()}catch(u){console.error("❌ 更新数据源失败:",u),n(v=>({...v,error:`更新失败: ${u}`,loading:!1}))}},c=()=>{n(b=>({...b,name:e.dataSource.name,config:e.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var b=Br(),u=b.firstChild,v=u.firstChild,f=v.nextSibling,d=f.firstChild,y=d.nextSibling,$=y.firstChild,p=$.nextSibling;p.firstChild;var _=u.nextSibling,C=_.firstChild,E=C.firstChild,k=E.nextSibling,I=k.firstChild,N=I.nextSibling,q=C.nextSibling,j=q.firstChild;j.firstChild;var D=j.nextSibling,L=D.firstChild,S=L.nextSibling,Q=q.nextSibling,U=Q.firstChild,w=U.firstChild,A=w.nextSibling,V=Q.nextSibling,z=V.firstChild,M=z.nextSibling,J=M.firstChild,de=J.firstChild,ee=de.nextSibling,H=J.nextSibling,ne=H.firstChild,ve=ne.nextSibling,ie=H.nextSibling,se=ie.firstChild,te=se.nextSibling,re=V.nextSibling,oe=re.firstChild,X=oe.nextSibling;return Te(v,"click",e.onBack),r($,()=>e.dataSource.type_name),r(p,()=>e.dataSource.id,null),N.$$input=G=>s(G.currentTarget.value),r(j,h(R,{get when(){return t().hasChanges},get children(){return Or()}}),null),S.$$input=G=>{try{const fe=JSON.parse(G.currentTarget.value);a(fe),n(me=>({...me,error:null}))}catch{n(me=>({...me,error:"配置格式错误，请检查JSON语法"}))}},A.$$click=o,r(A,()=>t().loading?"测试中...":"测试连接"),r(Q,h(R,{get when(){return t().testResult},get children(){var G=Ur(),fe=G.firstChild,me=fe.firstChild;return r(fe,()=>{var be;return(be=t().testResult)!=null&&be.success?"✅":"❌"},me),r(fe,()=>{var be;return(be=t().testResult)==null?void 0:be.message},null),r(G,h(R,{get when(){var be;return(be=t().testResult)==null?void 0:be.error},get children(){var be=Ir();return r(be,()=>{var ue;return(ue=t().testResult)==null?void 0:ue.error}),be}}),null),P(()=>{var be;return $e(G,`test-result ${(be=t().testResult)!=null&&be.success?"success":"error"}`)}),G}}),null),r(ee,()=>e.dataSource.status==="active"?"✅ 活跃":e.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),r(ve,()=>new Date(e.dataSource.created_at).toLocaleString("zh-CN")),r(te,()=>new Date(e.dataSource.last_updated).toLocaleString("zh-CN")),r(_,h(R,{get when(){return t().error},get children(){var G=Fr();return G.firstChild,r(G,()=>t().error,null),G}}),re),Te(oe,"click",e.onBack),r(re,h(R,{get when(){return t().hasChanges},get children(){var G=qr();return G.$$click=c,P(()=>G.disabled=t().loading),G}}),X),X.$$click=g,r(X,(()=>{var G=_e(()=>!!t().loading);return()=>G()?"保存中...":t().hasChanges?"保存更改":"无更改"})()),P(G=>{var ge;var fe=t().error&&!t().name.trim()?"error":"",me=t().error&&((ge=t().error)!=null&&ge.includes("配置格式"))?"error":"",be=t().loading,ue=`status-value status-${e.dataSource.status}`,Se=`save-btn ${t().hasChanges?"has-changes":""}`,Z=t().loading;return fe!==G.e&&$e(N,G.e=fe),me!==G.t&&$e(S,G.t=me),be!==G.a&&(A.disabled=G.a=be),ue!==G.o&&$e(ee,G.o=ue),Se!==G.i&&$e(X,G.i=Se),Z!==G.n&&(X.disabled=G.n=Z),G},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),P(()=>N.value=t().name),P(()=>S.value=JSON.stringify(t().config,null,2)),b})()}function Kr(e){return(()=>{var t=jr(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;i.firstChild;var s=i.nextSibling,a=s.firstChild,o=a.nextSibling,g=o.nextSibling,c=g.nextSibling;c.nextSibling;var b=n.nextSibling,u=b.firstChild,v=u.firstChild,f=v.firstChild,d=v.nextSibling;return Te(l,"click",e.onBack),r(i,()=>e.dataSource.name,null),r(s,()=>e.data.total_rows,o),r(s,()=>e.data.rows.length,c),r(f,h(ce,{get each(){return e.data.columns},children:y=>(()=>{var $=Qr();return r($,y),$})()})),r(d,h(ce,{get each(){return e.data.rows.slice(0,50)},children:y=>(()=>{var $=Hr();return r($,h(ce,{get each(){return e.data.columns},children:p=>(()=>{var _=Jr();return r(_,(()=>{var C=_e(()=>typeof y[p]=="object");return()=>C()?JSON.stringify(y[p]):String(y[p]||"")})()),_})()})),$})()})),t})()}De(["click","input"]);var Yr=m("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Xr=m("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Zr=m("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),ea=m("<div class=current-record>"),ta=m("<div class=empty-record>暂无记录数据"),na=m("<div class=available-fields>"),la=m("<div class=no-fields>暂无可用字段"),ia=m('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),sa=m("<div class=record-field><div class=field-key>:</div><div class=field-value>"),ra=m("<div class=field-display-name>"),aa=m("<div class=field-sample>示例: "),oa=m("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),ca=m("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),da=m('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const ua=()=>{const[e,t]=Y(null),[n,l]=Y(!1);It(()=>{const c=Be.subscribe(b=>{t(b)});return t(Be.getCurrentContext()),c});const i=Ce(()=>{const c=e();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),s=async()=>{l(!0);try{await Be.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{l(!1)}},a=async()=>{l(!0);try{await Be.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{l(!1)}},o=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),g=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Zr(),b=c.firstChild,u=b.firstChild,v=u.nextSibling,f=v.firstChild,d=f.nextSibling;return r(f,()=>i().icon),r(d,()=>i().text),r(c,h(R,{get when(){return e()},children:y=>(()=>{var $=ia(),p=$.firstChild,_=p.firstChild,C=_.nextSibling,E=C.firstChild,k=E.firstChild,I=k.nextSibling,N=E.nextSibling,q=N.firstChild,j=q.nextSibling,D=N.nextSibling,L=D.firstChild,S=L.nextSibling,Q=p.nextSibling,U=Q.firstChild,w=U.nextSibling,A=w.firstChild,V=A.nextSibling,z=V.firstChild,M=V.nextSibling,J=Q.nextSibling;J.firstChild;var de=J.nextSibling,ee=de.firstChild,H=ee.firstChild,ne=H.nextSibling,ve=ne.firstChild,ie=ve.nextSibling;return ie.nextSibling,r(I,()=>y().dataSource.name),r(j,()=>y().dataSource.type.toUpperCase()),r(S,()=>y().dataSource.id),A.$$click=a,r(V,()=>y().currentRecord.index+1,z),r(V,()=>y().currentRecord.total,null),M.$$click=s,r(J,h(R,{get when(){return Object.keys(y().currentRecord.data).length>0},get children(){var se=ea();return r(se,h(ce,{get each(){return Object.entries(y().currentRecord.data)},children:([te,re])=>(()=>{var oe=sa(),X=oe.firstChild,G=X.firstChild,fe=X.nextSibling;return r(X,te,G),r(fe,()=>o(re)),oe})()})),se}}),null),r(J,h(R,{get when(){return Object.keys(y().currentRecord.data).length===0},get children(){return ta()}}),null),r(ne,()=>y().fields.length,ie),r(de,h(R,{get when(){return y().fields.length>0},get children(){var se=na();return r(se,h(ce,{get each(){return y().fields},children:te=>(()=>{var re=oa(),oe=re.firstChild,X=oe.firstChild,G=X.nextSibling,fe=G.firstChild,me=fe.nextSibling;me.nextSibling;var be=oe.nextSibling,ue=be.firstChild,Se=ue.nextSibling;return r(X,()=>te.name),r(G,()=>g(te.type),me),r(re,h(R,{get when(){return te.displayName&&te.displayName!==te.name},get children(){var Z=ra();return r(Z,()=>te.displayName),Z}}),be),r(re,h(R,{get when(){return te.sample!==void 0},get children(){var Z=aa();return Z.firstChild,r(Z,()=>o(te.sample),null),Z}}),be),r(Se,()=>`{${te.name}}`),re})()})),se}}),null),r(de,h(R,{get when(){return y().fields.length===0},get children(){return la()}}),null),r($,h(R,{get when(){return y().error},children:se=>(()=>{var te=da(),re=te.firstChild,oe=re.nextSibling,X=oe.firstChild;X.firstChild;var G=X.nextSibling;return G.firstChild,r(X,()=>se().type,null),r(G,()=>se().message,null),r(oe,h(R,{get when(){return se().details},get children(){var fe=ca(),me=fe.firstChild,be=me.nextSibling;return r(be,()=>JSON.stringify(se().details,null,2)),fe}}),null),te})()}),null),P(se=>{var te=n()||y().currentRecord.index<=0,re=n()||y().currentRecord.index>=y().currentRecord.total-1;return te!==se.e&&(A.disabled=se.e=te),re!==se.t&&(M.disabled=se.t=re),se},{e:void 0,t:void 0}),$})()}),null),r(c,h(R,{get when(){return!e()},get children(){return Yr()}}),null),r(c,h(R,{get when(){return n()},get children(){return Xr()}}),null),P(y=>(y=i().color)!=null?d.style.setProperty("color",y):d.style.removeProperty("color")),c})()};De(["click"]);var ga=m(`<div class=sql-editor><div class=editor-toolbar><div class=toolbar-left><span class=editor-label>SQL编辑器</span><span class=database-type>(<!>)</span></div><div class=toolbar-right><span class=cursor-position>行 <!>, 列 </span><span class=character-count> 字符</span></div></div><div class=template-toolbar><span class=template-label>模板:</span></div><div><textarea class=sql-textarea placeholder="请输入SQL查询语句...

示例:
SELECT u.username, u.email, COUNT(o.id) as order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at >= '2024-01-01'
GROUP BY u.id, u.username, u.email
ORDER BY order_count DESC
LIMIT 10;"rows=15></textarea><div class=line-numbers></div></div><div class=editor-help><div class=help-item><kbd>Tab</kbd> 缩进</div><div class=help-item><kbd>Ctrl+F</kbd> 格式化</div><div class=help-item><kbd>Enter</kbd> 自动缩进</div></div><style>
        .sql-editor {
          display: flex;
          flex-direction: column;
          border: 1px solid #ddd;
          border-radius: 6px;
          background: white;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .editor-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          background: #f8f9fa;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .toolbar-left {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .editor-label {
          font-weight: bold;
          color: #2c3e50;
        }

        .database-type {
          background: #3498db;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
          gap: 12px;
          color: #666;
        }

        .template-toolbar {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f1f3f5;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .template-label {
          color: #666;
          font-weight: bold;
        }

        .template-btn {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 4px;
          padding: 4px 8px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .template-btn:hover:not(:disabled) {
          background: #dee2e6;
          border-color: #adb5bd;
        }

        .template-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .editor-container {
          position: relative;
          flex: 1;
          min-height: 300px;
        }

        .editor-container.focused {
          box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editor-container.disabled {
          opacity: 0.6;
          pointer-events: none;
        }

        .sql-textarea {
          width: 100%;
          height: 100%;
          padding: 12px 12px 12px 48px;
          border: none;
          outline: none;
          resize: vertical;
          font-family: inherit;
          font-size: 14px;
          line-height: 1.5;
          background: transparent;
        }

        .line-numbers {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 36px;
          background: #f8f9fa;
          border-right: 1px solid #e9ecef;
          padding: 12px 4px;
          user-select: none;
          overflow: hidden;
        }

        .line-number {
          text-align: right;
          font-size: 12px;
          color: #6c757d;
          line-height: 1.5;
          padding-right: 8px;
        }

        .editor-help {
          display: flex;
          justify-content: center;
          gap: 16px;
          padding: 6px;
          background: #f8f9fa;
          border-top: 1px solid #ddd;
          font-size: 11px;
          color: #666;
        }

        .help-item {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        kbd {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 3px;
          padding: 2px 4px;
          font-size: 10px;
          font-family: inherit;
        }
      `),ha=m("<button class=template-btn>"),va=m("<div class=line-number>");function fa(e){let t;const[n,l]=Y(!1),[i,s]=Y({line:1,column:1}),a=v=>{const f=v.target;e.onSQLChange(f.value),o()},o=()=>{if(!t)return;const v=t.selectionStart,d=e.sql.substring(0,v).split(`
`);s({line:d.length,column:(d[d.length-1]||"").length+1})},g=v=>{var $;if(!t||e.disabled)return;const f=v.target,d=f.selectionStart,y=f.selectionEnd;if(v.key==="Tab"){v.preventDefault();const p=e.sql.substring(0,d)+"  "+e.sql.substring(y);e.onSQLChange(p),setTimeout(()=>{t&&(t.selectionStart=t.selectionEnd=d+2,o())},0)}else if(v.key==="Enter"){const p=e.sql.substring(0,d).split(`
`),_=p[p.length-1],C=(($=_==null?void 0:_.match(/^\s*/))==null?void 0:$[0])||"",E=(_==null?void 0:_.trim().toUpperCase())||"",I=["SELECT","FROM","WHERE","GROUP BY","ORDER BY","HAVING"].some(N=>E.endsWith(N)||E.includes(N+" "))?C+"  ":C;if(I){v.preventDefault();const N=e.sql.substring(0,d)+`
`+I+e.sql.substring(y);e.onSQLChange(N),setTimeout(()=>{if(t){const q=d+1+I.length;t.selectionStart=t.selectionEnd=q,o()}},0)}}},c=v=>{(v.ctrlKey||v.metaKey)&&v.key==="f"&&(v.preventDefault(),console.log("格式化快捷键触发"))},b=v=>{if(!t||e.disabled)return;const f=t.selectionStart,d=t.selectionEnd,y=e.sql.substring(0,f)+v+e.sql.substring(d);e.onSQLChange(y),setTimeout(()=>{t&&(t.focus(),t.selectionStart=t.selectionEnd=f+v.length,o())},0)};Ue(()=>{o(),t&&(t.addEventListener("selectionchange",o),t.addEventListener("click",o))});const u=[{name:"基础查询",template:"SELECT * FROM table_name WHERE condition;"},{name:"联表查询",template:`SELECT t1.*, t2.*
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.table1_id
WHERE condition;`},{name:"聚合查询",template:`SELECT column, COUNT(*), AVG(value)
FROM table_name
GROUP BY column
HAVING COUNT(*) > 1
ORDER BY column;`},{name:"子查询",template:`SELECT *
FROM table1
WHERE column IN (
  SELECT column
  FROM table2
  WHERE condition
);`}];return(()=>{var v=ga(),f=v.firstChild,d=f.firstChild,y=d.firstChild,$=y.nextSibling,p=$.firstChild,_=p.nextSibling;_.nextSibling;var C=d.nextSibling,E=C.firstChild,k=E.firstChild,I=k.nextSibling;I.nextSibling;var N=E.nextSibling,q=N.firstChild,j=f.nextSibling;j.firstChild;var D=j.nextSibling,L=D.firstChild,S=L.nextSibling;r($,()=>e.databaseType.toUpperCase(),_),r(E,()=>i().line,I),r(E,()=>i().column,null),r(N,()=>e.sql.length,q),r(j,()=>u.map(U=>(()=>{var w=ha();return w.$$click=()=>b(U.template),r(w,()=>U.name),P(A=>{var V=e.disabled,z=`插入${U.name}模板`;return V!==A.e&&(w.disabled=A.e=V),z!==A.t&&B(w,"title",A.t=z),A},{e:void 0,t:void 0}),w})()),null),L.addEventListener("blur",()=>l(!1)),L.addEventListener("focus",()=>l(!0)),L.addEventListener("keypress",c),L.$$keydown=g,L.$$input=a;var Q=t;return typeof Q=="function"?Ft(Q,L):t=L,B(L,"spellcheck",!1),r(S,()=>e.sql.split(`
`).map((U,w)=>(()=>{var A=va();return r(A,w+1),A})())),P(U=>{var w=`editor-container ${n()?"focused":""} ${e.disabled?"disabled":""}`,A=e.disabled;return w!==U.e&&$e(D,U.e=w),A!==U.t&&(L.disabled=U.t=A),U},{e:void 0,t:void 0}),P(()=>L.value=e.sql),v})()}De(["input","keydown","click"]);var ma=m("<div class=empty-message><p>请选择要查询的字段</p><button>自动选择字段"),ba=m("<div class=builder-section><div class=section-header><h4>🔗 表关联 (JOIN)</h4><button class=add-btn>+ 添加关联</button></div><div class=joins-list>"),ya=m(`<div class=visual-query-builder><div class=query-options><label class=option-checkbox><input type=checkbox><span>去重查询 (DISTINCT)</span></label></div><div class=builder-section><div class=section-header><h4>📋 选择字段 (SELECT)</h4><button class=add-btn>+ 添加字段</button></div><div class=fields-list></div></div><div class=builder-section><div class=section-header><h4>🔍 筛选条件 (WHERE)</h4><button class=add-btn>+ 添加条件</button></div><div class=where-list></div></div><div class=builder-section><div class=section-header><h4>⚙️ 其他选项</h4></div><div class=options-grid><div class=option-group><label>限制行数 (LIMIT):</label><input type=number placeholder=无限制 min=1 max=10000></div></div></div><style>
        .visual-query-builder {
          display: flex;
          flex-direction: column;
          gap: 20px;
          padding: 16px;
          background: #f8f9fa;
          border-radius: 8px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .query-options {
          display: flex;
          gap: 16px;
        }

        .option-checkbox {
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
        }

        .builder-section {
          background: white;
          border-radius: 6px;
          padding: 16px;
          border: 1px solid #dee2e6;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e9ecef;
        }

        .section-header h4 {
          margin: 0;
          color: #2c3e50;
          font-size: 14px;
        }

        .add-btn {
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
        }

        .add-btn:hover:not(:disabled) {
          background: #218838;
        }

        .field-item, .join-item, .where-item {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
          padding: 8px;
          background: #f8f9fa;
          border-radius: 4px;
          flex-wrap: wrap;
        }

        .join-condition {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .separator {
          font-weight: bold;
          color: #6c757d;
        }

        select, input {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          border-radius: 3px;
          font-size: 13px;
        }

        select {
          background: white;
        }

        input[type="text"] {
          min-width: 100px;
          flex: 1;
        }

        input[type="number"] {
          width: 100px;
        }

        .remove-btn {
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          cursor: pointer;
          font-size: 14px;
        }

        .remove-btn:hover:not(:disabled) {
          background: #c82333;
        }

        .empty-message {
          text-align: center;
          padding: 20px;
          color: #6c757d;
        }

        .empty-message button {
          background: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 8px 16px;
          cursor: pointer;
          margin-top: 8px;
        }

        .options-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
        }

        .option-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .option-group label {
          font-weight: bold;
          color: #495057;
          font-size: 13px;
        }

        button:disabled, select:disabled, input:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      `),pa=m('<div class=field-item><select></select><span class=separator>.</span><select></select><select><option value>无聚合</option><option value=COUNT>COUNT</option><option value=SUM>SUM</option><option value=AVG>AVG</option><option value=MIN>MIN</option><option value=MAX>MAX</option><option value=DISTINCT>DISTINCT</option></select><input type=text placeholder="别名 (可选)"><button class=remove-btn>×'),Ke=m("<option>"),$a=m("<option> (<!>)"),_a=m("<div class=join-item><select><option value=INNER>INNER JOIN</option><option value=LEFT>LEFT JOIN</option><option value=RIGHT>RIGHT JOIN</option><option value=FULL>FULL JOIN</option></select><div class=join-condition><select></select><select></select><span>=</span><select></select><select></select></div><button class=remove-btn>×"),xa=m("<select><option value=AND>AND</option><option value=OR>OR"),Sa=m("<input type=text>"),wa=m('<div class=where-item><select></select><select></select><select><option value="=">=</option><option value="!=">!=</option><option value=">">&gt;</option><option value="<">&lt;</option><option value=">=">&gt;=</option><option value="<=">&lt;=</option><option value=LIKE>LIKE</option><option value=IN>IN</option><option value="IS NULL">IS NULL</option><option value="IS NOT NULL">IS NOT NULL</option></select><button class=remove-btn>×');function Ca(e){const[t,n]=Y([]),[l,i]=Y([]),[s,a]=Y([]),[o]=Y([]),[g]=Y([]),[c,b]=Y(void 0),[u,v]=Y(!1),f=Ce(()=>{var L,S,Q;return(Q=(S=(L=e.schema)==null?void 0:L.schemas)==null?void 0:S[0])!=null&&Q.tables?e.schema.schemas[0].tables.filter(U=>e.selectedTables.includes(U.name)):[]}),d=L=>{const S=f().find(Q=>Q.name===L);return(S==null?void 0:S.columns)||[]},y=Ce(()=>{var z;const L=f();if(L.length===0||t().length===0)return"";let S="";S+=u()?"SELECT DISTINCT ":"SELECT ";const Q=t().map(M=>{let J=`${M.table}.${M.column}`;return M.aggregate&&(M.aggregate==="DISTINCT"?J=`DISTINCT ${J}`:J=`${M.aggregate}(${J})`),M.alias&&(J+=` AS ${M.alias}`),J});S+=Q.join(`,
       `),S+=`
FROM ${((z=L[0])==null?void 0:z.name)||"table1"}`;const U=l();for(const M of U)S+=`
${M.joinType} JOIN ${M.rightTable} ON ${M.leftTable}.${M.leftColumn} = ${M.rightTable}.${M.rightColumn}`;const w=s();if(w.length>0){S+=`
WHERE `;const M=w.map((J,de)=>{let ee="";return de>0&&(ee+=`${J.logicalOperator} `),ee+=`${J.table}.${J.column} ${J.operator}`,["IS NULL","IS NOT NULL"].includes(J.operator)||(J.operator==="IN"?ee+=` (${J.value})`:J.operator==="LIKE"?ee+=` '%${J.value}%'`:ee+=` '${J.value}'`),ee});S+=M.join(" ")}const A=g();A.length>0&&(S+=`
GROUP BY ${A.join(", ")}`);const V=o();if(V.length>0){const M=V.map(J=>`${J.table}.${J.column} ${J.direction}`);S+=`
ORDER BY ${M.join(", ")}`}return c()&&(S+=`
LIMIT ${c()}`),S});Ue(()=>{p()});const $=()=>{e.onQueryChange(y())},p=()=>{const L=f();if(L.length===0)return;const S=[];L.forEach(Q=>{var w;(((w=Q.columns)==null?void 0:w.slice(0,3))||[]).forEach(A=>{S.push({table:Q.name,column:A.name})})}),n(S),$()},_=()=>{var U,w;const L=f();if(L.length===0)return;const S=L[0];if(!S)return;const Q=((w=(U=S.columns)==null?void 0:U[0])==null?void 0:w.name)||"id";n(A=>[...A,{table:S.name,column:Q}]),$()},C=L=>{n(S=>S.filter((Q,U)=>U!==L)),$()},E=(L,S)=>{n(Q=>Q.map((U,w)=>{if(w===L){const A={...U,...S};return S.hasOwnProperty("aggregate")&&S.aggregate===void 0&&delete A.aggregate,S.hasOwnProperty("alias")&&S.alias===void 0&&delete A.alias,A}return U})),$()},k=()=>{var V,z,M,J;const L=f();if(L.length<2)return;const S=L[0],Q=L[1];if(!S||!Q)return;const U=((z=(V=S.columns)==null?void 0:V[0])==null?void 0:z.name)||"id",w=((J=(M=Q.columns)==null?void 0:M[0])==null?void 0:J.name)||"id",A={id:Date.now().toString(),leftTable:S.name,leftColumn:U,rightTable:Q.name,rightColumn:w,joinType:"INNER"};i(de=>[...de,A]),$()},I=L=>{i(S=>S.filter(Q=>Q.id!==L)),$()},N=(L,S)=>{i(Q=>Q.map(U=>U.id===L?{...U,...S}:U)),$()},q=()=>{var w,A;const L=f();if(L.length===0)return;const S=L[0];if(!S)return;const Q=((A=(w=S.columns)==null?void 0:w[0])==null?void 0:A.name)||"id",U={id:Date.now().toString(),table:S.name,column:Q,operator:"=",value:"",logicalOperator:"AND"};a(V=>[...V,U]),$()},j=L=>{a(S=>S.filter(Q=>Q.id!==L)),$()},D=(L,S)=>{a(Q=>Q.map(U=>U.id===L?{...U,...S}:U)),$()};return(()=>{var L=ya(),S=L.firstChild,Q=S.firstChild,U=Q.firstChild,w=S.nextSibling,A=w.firstChild,V=A.firstChild,z=V.nextSibling,M=A.nextSibling,J=w.nextSibling,de=J.firstChild,ee=de.firstChild,H=ee.nextSibling,ne=de.nextSibling,ve=J.nextSibling,ie=ve.firstChild,se=ie.nextSibling,te=se.firstChild,re=te.firstChild,oe=re.nextSibling;return U.addEventListener("change",X=>{v(X.currentTarget.checked),$()}),z.$$click=_,r(M,h(ce,{get each(){return t()},children:(X,G)=>(()=>{var fe=pa(),me=fe.firstChild,be=me.nextSibling,ue=be.nextSibling,Se=ue.nextSibling,Z=Se.nextSibling,ge=Z.nextSibling;return me.addEventListener("change",x=>{var W,le;const F=f().find(K=>K.name===x.currentTarget.value),O=((le=(W=F==null?void 0:F.columns)==null?void 0:W[0])==null?void 0:le.name)||"id";E(G(),{table:x.currentTarget.value,column:O})}),r(me,h(ce,{get each(){return f()},children:x=>(()=>{var T=Ke();return r(T,()=>x.name),P(()=>T.value=x.name),T})()})),ue.addEventListener("change",x=>E(G(),{column:x.currentTarget.value})),r(ue,h(ce,{get each(){return d(X.table)},children:x=>(()=>{var T=$a(),F=T.firstChild,O=F.nextSibling;return O.nextSibling,r(T,()=>x.name,F),r(T,()=>x.data_type,O),P(()=>T.value=x.name),T})()})),Se.addEventListener("change",x=>{const T=x.currentTarget.value;T===""?E(G(),{aggregate:void 0}):E(G(),{aggregate:T})}),Z.$$input=x=>{const T=x.currentTarget.value;T===""?E(G(),{alias:void 0}):E(G(),{alias:T})},ge.$$click=()=>C(G()),P(x=>{var T=e.disabled,F=e.disabled,O=e.disabled,W=e.disabled,le=e.disabled;return T!==x.e&&(me.disabled=x.e=T),F!==x.t&&(ue.disabled=x.t=F),O!==x.a&&(Se.disabled=x.a=O),W!==x.o&&(Z.disabled=x.o=W),le!==x.i&&(ge.disabled=x.i=le),x},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),P(()=>me.value=X.table),P(()=>ue.value=X.column),P(()=>Se.value=X.aggregate||""),P(()=>Z.value=X.alias||""),fe})()}),null),r(M,h(R,{get when(){return t().length===0},get children(){var X=ma(),G=X.firstChild,fe=G.nextSibling;return fe.$$click=p,P(()=>fe.disabled=e.disabled),X}}),null),r(L,h(R,{get when(){return f().length>1},get children(){var X=ba(),G=X.firstChild,fe=G.firstChild,me=fe.nextSibling,be=G.nextSibling;return me.$$click=k,r(be,h(ce,{get each(){return l()},children:ue=>(()=>{var Se=_a(),Z=Se.firstChild,ge=Z.nextSibling,x=ge.firstChild,T=x.nextSibling,F=T.nextSibling,O=F.nextSibling,W=O.nextSibling,le=ge.nextSibling;return Z.addEventListener("change",K=>N(ue.id,{joinType:K.currentTarget.value})),x.addEventListener("change",K=>N(ue.id,{leftTable:K.currentTarget.value})),r(x,h(ce,{get each(){return f()},children:K=>(()=>{var ye=Ke();return r(ye,()=>K.name),P(()=>ye.value=K.name),ye})()})),T.addEventListener("change",K=>N(ue.id,{leftColumn:K.currentTarget.value})),r(T,h(ce,{get each(){return d(ue.leftTable)},children:K=>(()=>{var ye=Ke();return r(ye,()=>K.name),P(()=>ye.value=K.name),ye})()})),O.addEventListener("change",K=>N(ue.id,{rightTable:K.currentTarget.value})),r(O,h(ce,{get each(){return f()},children:K=>(()=>{var ye=Ke();return r(ye,()=>K.name),P(()=>ye.value=K.name),ye})()})),W.addEventListener("change",K=>N(ue.id,{rightColumn:K.currentTarget.value})),r(W,h(ce,{get each(){return d(ue.rightTable)},children:K=>(()=>{var ye=Ke();return r(ye,()=>K.name),P(()=>ye.value=K.name),ye})()})),le.$$click=()=>I(ue.id),P(K=>{var ye=e.disabled,ke=e.disabled,ae=e.disabled,Ae=e.disabled,Pe=e.disabled,Ne=e.disabled;return ye!==K.e&&(Z.disabled=K.e=ye),ke!==K.t&&(x.disabled=K.t=ke),ae!==K.a&&(T.disabled=K.a=ae),Ae!==K.o&&(O.disabled=K.o=Ae),Pe!==K.i&&(W.disabled=K.i=Pe),Ne!==K.n&&(le.disabled=K.n=Ne),K},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),P(()=>Z.value=ue.joinType),P(()=>x.value=ue.leftTable),P(()=>T.value=ue.leftColumn),P(()=>O.value=ue.rightTable),P(()=>W.value=ue.rightColumn),Se})()})),P(()=>me.disabled=e.disabled),X}}),J),H.$$click=q,r(ne,h(ce,{get each(){return s()},children:(X,G)=>(()=>{var fe=wa(),me=fe.firstChild,be=me.nextSibling,ue=be.nextSibling,Se=ue.nextSibling;return r(fe,h(R,{get when(){return G()>0},get children(){var Z=xa();return Z.addEventListener("change",ge=>D(X.id,{logicalOperator:ge.currentTarget.value})),P(()=>Z.disabled=e.disabled),P(()=>Z.value=X.logicalOperator),Z}}),me),me.addEventListener("change",Z=>D(X.id,{table:Z.currentTarget.value})),r(me,h(ce,{get each(){return f()},children:Z=>(()=>{var ge=Ke();return r(ge,()=>Z.name),P(()=>ge.value=Z.name),ge})()})),be.addEventListener("change",Z=>D(X.id,{column:Z.currentTarget.value})),r(be,h(ce,{get each(){return d(X.table)},children:Z=>(()=>{var ge=Ke();return r(ge,()=>Z.name),P(()=>ge.value=Z.name),ge})()})),ue.addEventListener("change",Z=>D(X.id,{operator:Z.currentTarget.value})),r(fe,h(R,{get when(){return!["IS NULL","IS NOT NULL"].includes(X.operator)},get children(){var Z=Sa();return Z.$$input=ge=>D(X.id,{value:ge.currentTarget.value}),P(ge=>{var x=X.operator==="IN"?"值1,值2,值3":"值",T=e.disabled;return x!==ge.e&&B(Z,"placeholder",ge.e=x),T!==ge.t&&(Z.disabled=ge.t=T),ge},{e:void 0,t:void 0}),P(()=>Z.value=X.value),Z}}),Se),Se.$$click=()=>j(X.id),P(Z=>{var ge=e.disabled,x=e.disabled,T=e.disabled,F=e.disabled;return ge!==Z.e&&(me.disabled=Z.e=ge),x!==Z.t&&(be.disabled=Z.t=x),T!==Z.a&&(ue.disabled=Z.a=T),F!==Z.o&&(Se.disabled=Z.o=F),Z},{e:void 0,t:void 0,a:void 0,o:void 0}),P(()=>me.value=X.table),P(()=>be.value=X.column),P(()=>ue.value=X.operator),fe})()})),oe.$$input=X=>{const G=parseInt(X.currentTarget.value)||void 0;b(G),$()},P(X=>{var G=e.disabled,fe=e.disabled,me=e.disabled,be=e.disabled;return G!==X.e&&(U.disabled=X.e=G),fe!==X.t&&(z.disabled=X.t=fe),me!==X.a&&(H.disabled=X.a=me),be!==X.o&&(oe.disabled=X.o=be),X},{e:void 0,t:void 0,a:void 0,o:void 0}),P(()=>U.checked=u()),P(()=>oe.value=c()||""),L})()}De(["click","input"]);var ka=m('<button class="action-btn close-btn"title=关闭预览>✕'),Ta=m("<table class=result-table><thead><tr></tr></thead><tbody>"),Ea=m("<div class=pagination><div class=pagination-info>显示 <!> - <!>/ <!> 行</div><div class=pagination-controls><select><option value=10>10行/页</option><option value=25>25行/页</option><option value=50>50行/页</option><option value=100>100行/页</option></select><div class=page-buttons><button>首页</button><button>上一页</button><span class=page-info> / </span><button>下一页</button><button>末页"),La=m(`<div class=query-preview><div class=preview-header><div class=header-info><h4>📊 查询结果预览</h4><div class=result-stats><span class=stat-item>📋 <!> 行数据</span><span class=stat-item>📊 <!> 列</span><span class=stat-item>⏱️ <!>ms</span></div></div><div class=header-actions><button class="action-btn export-btn"title=导出为CSV文件>📤 导出CSV</button></div></div><div class=query-info><details><summary>🔍 查询详情</summary><div class=query-details><div class=query-sql><strong>SQL查询:</strong><pre class=sql-code></pre></div><div class=query-metadata><div class=metadata-item><strong>执行时间:</strong> <!>ms</div><div class=metadata-item><strong>返回行数:</strong> </div><div class=metadata-item><strong>列数量:</strong> </div></div></div></details></div><div class=table-container></div><style>
        .query-preview {
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          overflow: hidden;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .preview-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          padding: 16px;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
        }

        .header-info h4 {
          margin: 0 0 8px 0;
          color: #2c3e50;
        }

        .result-stats {
          display: flex;
          gap: 16px;
          font-size: 13px;
        }

        .stat-item {
          color: #6c757d;
        }

        .header-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border: 1px solid #ced4da;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s;
        }

        .export-btn:hover {
          background: #28a745;
          color: white;
          border-color: #28a745;
        }

        .close-btn:hover {
          background: #dc3545;
          color: white;
          border-color: #dc3545;
        }

        .query-info {
          padding: 12px 16px;
          border-bottom: 1px solid #e9ecef;
        }

        .query-details {
          margin-top: 8px;
        }

        .query-sql {
          margin-bottom: 12px;
        }

        .sql-code {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px;
          font-family: 'Monaco', 'Consolas', monospace;
          font-size: 12px;
          overflow-x: auto;
          margin: 4px 0;
        }

        .query-metadata {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
          font-size: 13px;
        }

        .metadata-item {
          color: #495057;
        }

        .table-container {
          overflow: auto;
          max-height: 500px;
        }

        .result-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .result-table th {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 8px 12px;
          text-align: left;
          font-weight: 600;
          position: sticky;
          top: 0;
          z-index: 1;
        }

        .result-table th.sortable {
          cursor: pointer;
          user-select: none;
        }

        .result-table th.sortable:hover {
          background: #e9ecef;
        }

        .column-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .sort-indicator {
          opacity: 0.5;
          font-size: 12px;
        }

        .result-table th.sorted-asc .sort-indicator,
        .result-table th.sorted-desc .sort-indicator {
          opacity: 1;
          color: #007bff;
        }

        .result-table td {
          border: 1px solid #dee2e6;
          padding: 6px 12px;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .result-table tr.even {
          background: #f8f9fa;
        }

        .result-table tr:hover {
          background: #e3f2fd;
        }

        .cell-null {
          color: #6c757d;
          font-style: italic;
        }

        .cell-boolean {
          text-align: center;
          font-weight: bold;
        }

        .cell-integer, .cell-float {
          text-align: right;
          font-family: 'Monaco', 'Consolas', monospace;
        }

        .cell-datetime {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #6f42c1;
        }

        .cell-object {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #e83e8c;
        }

        .empty-result {
          text-align: center;
          padding: 40px 20px;
          color: #6c757d;
        }

        .empty-icon {
          font-size: 48px;
          margin-bottom: 16px;
        }

        .empty-text {
          font-size: 18px;
          font-weight: 500;
          margin-bottom: 8px;
        }

        .empty-hint {
          font-size: 14px;
        }

        .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          background: #f8f9fa;
          border-top: 1px solid #dee2e6;
          font-size: 13px;
        }

        .pagination-controls {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .page-buttons {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .page-buttons button {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          background: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }

        .page-buttons button:hover:not(:disabled) {
          background: #e9ecef;
        }

        .page-buttons button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .page-info {
          margin: 0 8px;
          font-weight: 500;
        }

        details summary {
          cursor: pointer;
          font-weight: 500;
          color: #495057;
        }

        details[open] summary {
          margin-bottom: 8px;
        }
      `),Da=m("<div class=empty-result><div class=empty-icon>📭</div><div class=empty-text>查询未返回任何数据</div><div class=empty-hint>请检查查询条件或数据源"),Pa=m("<th><div class=column-header><span class=column-name></span><span class=sort-indicator>"),Aa=m("<tr>"),za=m("<td>");function Ra(e){const[t,n]=Y(1),[l,i]=Y(10),[s,a]=Y(null),[o,g]=Y("asc"),c=Ce(()=>{let d=[...e.result.rows];if(s()){const p=s();d.sort((_,C)=>{const E=_[p],k=C[p];if(E==null)return 1;if(k==null)return-1;const I=String(E).localeCompare(String(k),void 0,{numeric:!0});return o()==="asc"?I:-I})}const y=(t()-1)*l(),$=y+l();return{data:d.slice(y,$),totalPages:Math.ceil(d.length/l()),totalRows:d.length}}),b=d=>{s()===d?g(y=>y==="asc"?"desc":"asc"):(a(d),g("asc"))},u=d=>{if(d==null)return"";if(typeof d=="object")return JSON.stringify(d);if(typeof d=="boolean")return d?"✓":"✗";if(typeof d=="number")return Number.isInteger(d)?d.toLocaleString():d.toFixed(2);const y=String(d);if(y.match(/^\d{4}-\d{2}-\d{2}/)||y.includes("T"))try{const $=new Date(y);if(!isNaN($.getTime()))return $.toLocaleString("zh-CN")}catch{}return y.length>50?y.substring(0,47)+"...":y},v=d=>{if(d==null)return"null";if(typeof d=="boolean")return"boolean";if(typeof d=="number")return Number.isInteger(d)?"integer":"float";if(typeof d=="object")return"object";const y=String(d);if(y.match(/^\d{4}-\d{2}-\d{2}/)||y.includes("T"))try{const $=new Date(y);if(!isNaN($.getTime()))return"datetime"}catch{}return"string"},f=()=>{const d=e.result.columns.join(","),y=e.result.rows.map(E=>e.result.columns.map(k=>{const I=E[k],N=u(I);return N.includes(",")||N.includes('"')||N.includes(`
`)?`"${N.replace(/"/g,'""')}"`:N}).join(",")).join(`
`),$=d+`
`+y,p=new Blob([$],{type:"text/csv;charset=utf-8;"}),_=document.createElement("a"),C=URL.createObjectURL(p);_.setAttribute("href",C),_.setAttribute("download",`query_result_${Date.now()}.csv`),document.body.appendChild(_),_.click(),document.body.removeChild(_)};return(()=>{var d=La(),y=d.firstChild,$=y.firstChild,p=$.firstChild,_=p.nextSibling,C=_.firstChild,E=C.firstChild,k=E.nextSibling;k.nextSibling;var I=C.nextSibling,N=I.firstChild,q=N.nextSibling;q.nextSibling;var j=I.nextSibling,D=j.firstChild,L=D.nextSibling;L.nextSibling;var S=$.nextSibling,Q=S.firstChild,U=y.nextSibling,w=U.firstChild,A=w.firstChild,V=A.nextSibling,z=V.firstChild,M=z.firstChild,J=M.nextSibling,de=z.nextSibling,ee=de.firstChild,H=ee.firstChild,ne=H.nextSibling,ve=ne.nextSibling;ve.nextSibling;var ie=ee.nextSibling,se=ie.firstChild;se.nextSibling;var te=ie.nextSibling,re=te.firstChild;re.nextSibling;var oe=U.nextSibling,X=oe.nextSibling;return r(C,()=>e.result.total_rows,k),r(I,()=>e.result.columns.length,q),r(j,()=>e.result.execution_time,L),Q.$$click=f,r(S,h(R,{get when(){return e.onClose},get children(){var G=ka();return Te(G,"click",e.onClose),G}}),null),r(J,()=>e.result.query),r(ee,()=>e.result.execution_time,ve),r(ie,()=>e.result.total_rows,null),r(te,()=>e.result.columns.length,null),r(oe,h(R,{get when(){return e.result.rows.length>0},get fallback(){return Da()},get children(){var G=Ta(),fe=G.firstChild,me=fe.firstChild,be=fe.nextSibling;return r(me,h(ce,{get each(){return e.result.columns},children:ue=>(()=>{var Se=Pa(),Z=Se.firstChild,ge=Z.firstChild,x=ge.nextSibling;return Se.$$click=()=>b(ue),B(Se,"title",`点击排序 ${ue}`),r(ge,ue),r(x,(()=>{var T=_e(()=>s()===ue);return()=>T()?o()==="asc"?"↑":"↓":"↕"})()),P(()=>$e(Se,`sortable ${s()===ue?`sorted-${o()}`:""}`)),Se})()})),r(be,h(ce,{get each(){return c().data},children:(ue,Se)=>(()=>{var Z=Aa();return r(Z,h(ce,{get each(){return e.result.columns},children:ge=>(()=>{var x=za();return r(x,()=>u(ue[ge])),P(T=>{var F=`cell-${v(ue[ge])}`,O=`${ge}: ${u(ue[ge])}`;return F!==T.e&&$e(x,T.e=F),O!==T.t&&B(x,"title",T.t=O),T},{e:void 0,t:void 0}),x})()})),P(()=>$e(Z,Se()%2===0?"even":"odd")),Z})()})),G}})),r(d,h(R,{get when(){return c().totalPages>1},get children(){var G=Ea(),fe=G.firstChild,me=fe.firstChild,be=me.nextSibling,ue=be.nextSibling,Se=ue.nextSibling,Z=Se.nextSibling,ge=Z.nextSibling;ge.nextSibling;var x=fe.nextSibling,T=x.firstChild,F=T.nextSibling,O=F.firstChild,W=O.nextSibling,le=W.nextSibling,K=le.firstChild,ye=le.nextSibling,ke=ye.nextSibling;return r(fe,()=>(t()-1)*l()+1,be),r(fe,()=>Math.min(t()*l(),c().totalRows),Se),r(fe,()=>c().totalRows,ge),T.addEventListener("change",ae=>{i(parseInt(ae.currentTarget.value)),n(1)}),O.$$click=()=>n(1),W.$$click=()=>n(ae=>Math.max(1,ae-1)),r(le,t,K),r(le,()=>c().totalPages,null),ye.$$click=()=>n(ae=>Math.min(c().totalPages,ae+1)),ke.$$click=()=>n(c().totalPages),P(ae=>{var Ae=t()===1,Pe=t()===1,Ne=t()===c().totalPages,je=t()===c().totalPages;return Ae!==ae.e&&(O.disabled=ae.e=Ae),Pe!==ae.t&&(W.disabled=ae.t=Pe),Ne!==ae.a&&(ye.disabled=ae.a=Ne),je!==ae.o&&(ke.disabled=ae.o=je),ae},{e:void 0,t:void 0,a:void 0,o:void 0}),P(()=>T.value=l()),G}}),X),d})()}De(["click"]);var Ma=m("<span>通过可视化界面构建查询，适合初学者使用"),Na=m("<span>直接编写SQL语句，适合有经验的用户"),Oa=m("<div class=error-message>❌ "),Ia=m("<div class=validation-errors><strong>错误:</strong><ul>"),Ua=m("<div class=validation-warnings><strong>警告:</strong><ul>"),Fa=m("<div class=validation-suggestions><strong>建议:</strong><ul>"),qa=m("<div><div class=validation-header><span class=validation-status></span><span class=security-status>"),Ba=m('<div class=sql-query-builder><div class=query-mode-selector><div class=mode-tabs><button>🎯 可视化构建</button><button>💻 自定义SQL</button></div><div class=mode-description></div></div><div class=query-content></div><div class=query-preview-section><div class=preview-header><h4>📋 SQL查询预览</h4><div class=preview-actions><button class="action-btn format-btn"title=格式化SQL代码>🎨 格式化</button><button class="action-btn validate-btn"title=验证SQL语法>✓ 验证语法</button><button class="action-btn copy-btn"title=复制SQL到剪贴板>📋 复制</button><button class="action-btn execute-btn"title=执行查询预览></button></div></div><div class=sql-display><pre class=sql-code><code></code></pre></div></div><div class=query-help><details><summary>💡 查询构建帮助</summary><div class=help-content><div class=help-section><h5>可视化构建:</h5><ul><li>选择表和字段来自动生成查询</li><li>支持JOIN关联、WHERE条件、ORDER BY排序</li><li>适合SQL初学者使用</li></ul></div><div class=help-section><h5>自定义SQL:</h5><ul><li>直接编写SQL语句，支持复杂查询</li><li>提供语法验证和格式化功能</li><li>适合有经验的用户</li></ul></div><div class=help-section><h5>安全提示:</h5><ul><li>系统会自动检测SQL注入风险</li><li>预览查询限制返回行数，避免性能问题</li><li>建议先验证语法，再执行预览'),At=m("<li>");function ja(e){const[t,n]=Y("visual"),[l,i]=Y(!1),[s,a]=Y(null),[o,g]=Y(null),[c,b]=Y(null),[u,v]=Y(""),f=Ce(()=>t()==="visual"?u():e.sql),d=Ce(()=>o()),y=async()=>{const E=f().trim();if(!E){g(null),e.onValidationChange(null);return}try{if(i(!0),a(null),console.log("🔍 验证SQL语法:",E),console.log("🔍 SQLQueryBuilder config对象:",e.config),console.log("🔍 config对象的键:",Object.keys(e.config)),console.log("🔍 database_type字段:",e.config.database_type),["database_type","databaseType","dbType","type"].forEach(N=>{e.config[N]&&console.log(`🔍 找到字段 ${N}:`,e.config[N])}),!e.config.database_type)throw new Error(`database_type字段缺失，config内容: ${JSON.stringify(e.config)}`);const I=await we.validateSqlSyntax(E,e.config.database_type);g(I),e.onValidationChange(I),console.log("✅ SQL验证结果:",I)}catch(k){console.error("❌ SQL验证失败:",k);const I={valid:!1,errors:[`验证失败: ${k}`],warnings:[],suggestions:[],is_safe:!1,security_issues:["无法验证查询安全性"]};g(I),e.onValidationChange(I),a(`SQL验证失败: ${k}`)}finally{i(!1)}},$=async()=>{const E=f().trim();if(E)try{i(!0),a(null),console.log("🎨 格式化SQL:",E);const k=await we.formatSql(E,e.config.database_type);t()==="visual"?v(k):e.onSQLChange(k),console.log("✅ SQL格式化完成")}catch(k){console.error("❌ SQL格式化失败:",k),a(`格式化失败: ${k}`)}finally{i(!1)}},p=async()=>{const E=f().trim();if(!E){a("请输入SQL查询语句");return}try{i(!0),a(null),console.log("▶️ 执行查询预览:",E),await y();const k=o();if(k&&!k.valid){a("SQL语法验证失败，请修正后重试");return}const I=await we.executeDatabasePreview(e.config,E,50);b(I),e.onQueryResult(I),console.log("✅ 查询预览成功:",I)}catch(k){console.error("❌ 查询预览失败:",k),a(`查询执行失败: ${k}`),b(null),e.onQueryResult(null)}finally{i(!1)}},_=async()=>{const E=f();if(E)try{await navigator.clipboard.writeText(E),console.log("📋 SQL已复制到剪贴板")}catch(k){console.error("❌ 复制失败:",k),a(`复制失败: ${k}`)}},C=E=>{n(E),a(null),E==="custom"&&u()&&e.onSQLChange(u())};return(()=>{var E=Ba(),k=E.firstChild,I=k.firstChild,N=I.firstChild,q=N.nextSibling,j=I.nextSibling,D=k.nextSibling,L=D.nextSibling,S=L.firstChild,Q=S.firstChild,U=Q.nextSibling,w=U.firstChild,A=w.nextSibling,V=A.nextSibling,z=V.nextSibling,M=S.nextSibling,J=M.firstChild,de=J.firstChild;return N.$$click=()=>C("visual"),q.$$click=()=>C("custom"),r(j,h(R,{get when(){return t()==="visual"},get children(){return Ma()}}),null),r(j,h(R,{get when(){return t()==="custom"},get children(){return Na()}}),null),r(E,h(R,{get when(){return s()},get children(){var ee=Oa();return ee.firstChild,r(ee,s,null),ee}}),D),r(D,h(R,{get when(){return t()==="visual"},get children(){return h(Ca,{get selectedTables(){return e.selectedTables},get schema(){return e.schema},onQueryChange:v,get disabled(){return l()}})}}),null),r(D,h(R,{get when(){return t()==="custom"},get children(){return h(fa,{get sql(){return e.sql},get onSQLChange(){return e.onSQLChange},get databaseType(){return e.config.database_type},get disabled(){return l()}})}}),null),w.$$click=$,A.$$click=y,V.$$click=_,z.$$click=p,r(z,()=>l()?"⏳ 执行中...":"▶️ 预览查询"),r(de,()=>f()||"-- 请构建或输入SQL查询语句"),r(L,h(R,{get when(){return d()},get children(){var ee=qa(),H=ee.firstChild,ne=H.firstChild,ve=ne.nextSibling;return r(ne,()=>d().valid?"✅ 语法正确":"❌ 语法错误"),r(ve,()=>d().is_safe?"🔒 查询安全":"⚠️ 安全警告"),r(ee,h(R,{get when(){return _e(()=>!!d().errors)()&&d().errors.length>0},get children(){var ie=Ia(),se=ie.firstChild,te=se.nextSibling;return r(te,h(ce,{get each(){return d().errors},children:re=>(()=>{var oe=At();return r(oe,re),oe})()})),ie}}),null),r(ee,h(R,{get when(){return _e(()=>{var ie;return!!((ie=d())!=null&&ie.warnings)})()&&d().warnings.length>0},get children(){var ie=Ua(),se=ie.firstChild,te=se.nextSibling;return r(te,h(ce,{get each(){return d().warnings},children:re=>(()=>{var oe=At();return r(oe,re),oe})()})),ie}}),null),r(ee,h(R,{get when(){return _e(()=>{var ie;return!!((ie=d())!=null&&ie.suggestions)})()&&d().suggestions.length>0},get children(){var ie=Fa(),se=ie.firstChild,te=se.nextSibling;return r(te,h(ce,{get each(){return d().suggestions},children:re=>(()=>{var oe=At();return r(oe,re),oe})()})),ie}}),null),P(()=>{var ie;return $e(ee,`validation-result ${(ie=d())!=null&&ie.valid?"valid":"invalid"}`)}),ee}}),null),r(L,h(R,{get when(){return c()},get children(){return h(Ra,{get result(){return c()},onClose:()=>{b(null),e.onQueryResult(null)}})}}),null),P(ee=>{var H=`mode-tab ${t()==="visual"?"active":""}`,ne=l(),ve=`mode-tab ${t()==="custom"?"active":""}`,ie=l(),se=l()||!f(),te=l()||!f(),re=l()||!f(),oe=l()||!f();return H!==ee.e&&$e(N,ee.e=H),ne!==ee.t&&(N.disabled=ee.t=ne),ve!==ee.a&&$e(q,ee.a=ve),ie!==ee.o&&(q.disabled=ee.o=ie),se!==ee.i&&(w.disabled=ee.i=se),te!==ee.n&&(A.disabled=ee.n=te),re!==ee.s&&(V.disabled=ee.s=re),oe!==ee.h&&(z.disabled=ee.h=oe),ee},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),E})()}De(["click"]);var Qa=m("<div class=error-messages>"),Ha=m("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>处理中..."),Ja=m('<div class=form-row><div class="form-group flex-2"><label>主机地址</label><input type=text placeholder=localhost></div><div class="form-group flex-1"><label>端口</label><input type=number>'),Va=m("<div class=form-group><label>数据库文件路径</label><input type=text placeholder=/path/to/database.db>"),Wa=m("<div class=form-group><label>数据库名</label><input type=text placeholder=myapp_production>"),Ga=m("<div class=form-row><div class=form-group><label>用户名</label><input type=text></div><div class=form-group><label>密码</label><input type=password>"),Tn=m("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Ka=m("<div class=connection-step><div class=step-header><h4>🔌 数据库连接配置</h4><p>请填写数据库连接信息</p></div><div class=form-section><div class=form-group><label>数据库类型</label><select><option value=mysql>MySQL</option><option value=postgresql>PostgreSQL</option><option value=sqlite>SQLite</option><option value=sqlserver>SQL Server</option><option value=oracle>Oracle</option></select></div><div class=connection-test><button class=test-connection-btn>"),Ya=m("<div class=schema-loading><button class=load-schema-btn>🔄 加载表结构</button><p class=loading-hint>点击按钮加载数据库的表结构信息"),Xa=m("<div class=views-section><h5>👁️ 数据视图列表</h5><div class=views-list>"),Za=m("<div class=schema-content><div class=schema-summary><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>表数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>视图数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>加载时间:</span><span class=summary-value></span></div></div><div class=tables-section><h5>📋 数据表列表</h5><div class=tables-grid>"),eo=m("<div class=schema-step><div class=step-header><h4>🗂️ 数据库表结构</h4><p>选择要查询的数据表和字段"),to=m('<div class=database-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>🗄️ 创建数据库数据源</h3><p>连接数据库并配置查询语句</p></div></div><div class=wizard-progress><div><div class=step-indicator>1</div><div class=step-info><div class=step-title>数据库连接</div><div class=step-description>配置连接信息</div></div></div><div><div class=step-indicator>2</div><div class=step-info><div class=step-title>表结构</div><div class=step-description>选择数据表</div></div></div><div><div class=step-indicator>3</div><div class=step-info><div class=step-title>查询构建</div><div class=step-description>编写SQL查询</div></div></div><div><div class=step-indicator>4</div><div class=step-info><div class=step-title>预览保存</div><div class=step-description>测试并保存</div></div></div></div><div class=wizard-content></div><div class=wizard-controls><div class=control-buttons><button class="control-btn back-btn">← 上一步</button><button class="control-btn next-btn">下一步 →'),no=m("<div class=error-message>❌ "),lo=m("<span class=view-comment>"),io=m("<div class=view-item><div class=view-info><span class=view-name></span><span class=view-schema>"),so=m("<div class=table-comment>"),ro=m("<div class=more-columns>+<!> 个字段..."),ao=m("<span class=more-indexes>+"),oo=m("<div class=table-indexes><h6>索引 (<!>)</h6><div class=indexes-list>"),co=m("<span class=more-relations>+"),uo=m("<div class=table-relations><h6>关联 (<!>)</h6><div class=relations-list>"),go=m("<div><div class=table-card-header><div class=table-card-title><label class=table-checkbox><input type=checkbox><span class=table-name>📋 </span></label></div><div class=table-card-stats><span class=row-count title=预估行数> 行</span><span class=table-size title=预估大小></span></div></div><div class=table-columns><h6>字段 (<!>)</h6><div class=columns-preview>"),ho=m("<span class=pk-badge title=主键>🔑"),vo=m("<span class=fk-badge title=外键>🔗"),fo=m("<div class=column-item><span class=column-icon></span><span class=column-name></span><span class=column-type>"),mo=m("<span> "),bo=m("<span class=relation-badge>🔗 "),yo=m('<div class=preview-step><div class=step-header><h4>👁️ 预览和保存</h4><p>验证配置、预览数据并保存数据源</p></div><div class=basic-info-section><h5>📝 基本信息</h5><div class=form-row><div class="form-group flex-2"><label>数据源名称 *</label><input type=text placeholder=输入数据源名称... required></div><div class="form-group flex-1"><label>标签</label><input type=text placeholder="标签1, 标签2"></div></div><div class=form-group><label>描述</label><textarea placeholder=描述这个数据源的用途... rows=3>'),po=m("<div class=config-summary><h5>⚙️ 配置摘要</h5><div class=summary-grid><div class=summary-item><span class=summary-label>数据库类型:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>连接地址:</span><span class=summary-value>:</span></div><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>用户名:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>选中表:</span><span class=summary-value> 个表</span></div><div class=summary-item><span class=summary-label>查询长度:</span><span class=summary-value> 字符</span></div></div><div class=sql-preview><h6>SQL查询预览:</h6><pre class=sql-code>"),$o=m("<div class=validation-warnings><h6>⚠️ 警告"),_o=m("<div class=validation-errors><h6>❌ 错误"),xo=m("<div class=validation-suggestions><h6>💡 建议"),So=m("<div class=validation-results><div class=validation-checks>"),wo=m("<div class=validation-section><div class=section-header><h5>✅ 验证状态</h5><button class=validate-btn>"),Co=m("<div class=warning-item>"),ko=m("<div class=error-item>"),To=m("<div class=suggestion-item>"),Eo=m("<div><span class=check-icon></span><span class=check-label></span><span>"),Lo=m("<div class=no-data>没有查询到数据"),Do=m("<div class=preview-results><div class=preview-stats><div class=stat-item><span class=stat-label>样本行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>预估总行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>执行时间:</span><span class=stat-value>ms</span></div></div><div class=preview-data>"),Po=m("<div class=data-preview-section><div class=section-header><h5>📊 数据预览</h5><button class=preview-btn>"),Ao=m("<div class=no-data>没有数据"),zo=m("<div class=table-footer>显示前10行，共 <!> 行数据"),Ro=m("<div class=data-table-container><table class=data-table><thead><tr></tr></thead><tbody>"),Mo=m("<th>"),No=m("<tr>"),Oo=m("<td>"),Io=m('<div class=save-requirements><div class=requirements-header>❗ 保存要求检查：</div><div class=requirements-list><div class=requirement-item>数据源名称: <!> "<!>"</div><div class=requirement-item>自定义SQL: <!> </div><div class=requirement-item>测试连接: <!> </div><div class=requirement-item>保存状态: </div></div><div class=requirements-note>'),Uo=m("<div class=result-details><div class=detail-item><span class=detail-label>数据源ID:</span><span class=detail-value>"),Fo=m("<div class=result-warnings>"),qo=m("<div class=result-errors>"),Bo=m("<div class=save-requirements><h6>保存前需要完成:</h6><ul><li>填写数据源名称</li><li>确保SQL查询有效</li><li>通过基本验证检查"),jo=m("<div class=save-section><div class=section-header><h5>💾 保存数据源</h5><button>"),Qo=m("<div class=warning-item>⚠️ "),Ho=m("<div class=error-item>❌ ");const Jo={database_type:"mysql",host:"localhost",port:3306,database:"",username:"",password:"",ssl_enabled:!1,max_connections:10,min_connections:1,connection_timeout:30,idle_timeout:600,sql:"",use_custom_sql:!1,query_timeout:60,default_limit:1e3,enable_caching:!0,cache_ttl:300};function Vo(e){const[t,n]=Y({currentStep:"connection",name:"",description:"",tags:[],config:{...Jo},schema:null,selectedTables:[],generatedSQL:"",customSQL:"",useCustomSQL:!1,testResult:null,queryResult:null,validation:null,dataSourceValidation:null,dataPreview:null,loading:!1,errors:[],isSaving:!1,saveResult:null}),l=Ce(()=>{var d;const f=t();return{connection:((d=f.testResult)==null?void 0:d.success)||!1,schema:f.schema!==null&&f.selectedTables.length>0,query:f.customSQL.trim().length>0,preview:f.name.trim().length>0&&f.customSQL.trim().length>0}}),i=f=>{n(d=>({...d,...f}))},s=f=>{n(d=>({...d,config:{...d.config,...f}}))},a=async()=>{i({loading:!0,errors:[]});try{const f=await we.testDatabaseConnection(t().config);i({testResult:f,loading:!1,errors:f.success?[]:[f.message]}),f.success&&setTimeout(()=>{i({currentStep:"schema"}),o()},1e3)}catch(f){i({loading:!1,errors:[`连接测试失败: ${f}`],testResult:{success:!1,message:String(f)}})}},o=async()=>{i({loading:!0,errors:[]});try{const f=await we.loadDatabaseSchema(t().config);i({schema:f,loading:!1,errors:[]})}catch(f){i({loading:!1,errors:[`架构加载失败: ${f}`],schema:null})}},g=async()=>{i({loading:!0,errors:[]});try{const f={name:t().name,config:t().config,selected_tables:t().selectedTables,sql:t().customSQL,description:t().description,tags:t().tags,validate_before_save:!0},d=await we.validateDataSourceBeforeSave(f);return i({dataSourceValidation:d,loading:!1,errors:d.errors}),d}catch(f){return i({loading:!1,errors:[`验证失败: ${f}`]}),null}},c=async()=>{i({loading:!0,errors:[]});try{const f=await we.captureDataPreview(t().config,t().customSQL);return i({dataPreview:f,loading:!1}),f}catch(f){return i({loading:!1,errors:[`数据预览失败: ${f}`]}),null}},b=async()=>{var f,d,y;i({isSaving:!0,errors:[]});try{console.log("🔍 DatabaseWizard 保存前状态:",{selectedTables:t().selectedTables,selectedTables_type:typeof t().selectedTables,selectedTables_length:(f=t().selectedTables)==null?void 0:f.length,customSQL_length:(d=t().customSQL)==null?void 0:d.length,name:t().name});const $={name:t().name,config:t().config,selected_tables:t().selectedTables,sql:t().customSQL,description:t().description,tags:t().tags,validate_before_save:!0,capture_schema_snapshot:!0,capture_data_preview:!0,preview_row_limit:10};console.log("🔍 构建的 SaveDataSourceRequest:",{selected_tables:$.selected_tables,selected_tables_type:typeof $.selected_tables,selected_tables_length:(y=$.selected_tables)==null?void 0:y.length});const p=await we.saveDataSource($);return i({saveResult:p,isSaving:!1}),p.success&&setTimeout(()=>{e.onSuccess()},2e3),p}catch($){return i({isSaving:!1,errors:[`保存失败: ${$}`]}),null}},u=f=>{i({currentStep:f})},v=()=>{switch(t().currentStep){case"schema":i({currentStep:"connection"});break;case"query":i({currentStep:"schema"});break;case"preview":i({currentStep:"query"});break;default:e.onBack()}};return(()=>{var f=to(),d=f.firstChild,y=d.firstChild,$=d.nextSibling,p=$.firstChild,_=p.nextSibling,C=_.nextSibling,E=C.nextSibling,k=$.nextSibling,I=k.nextSibling,N=I.firstChild,q=N.firstChild,j=q.nextSibling;return y.$$click=v,p.$$click=()=>u("connection"),_.$$click=()=>l().connection&&u("schema"),C.$$click=()=>l().schema&&u("query"),E.$$click=()=>l().query&&u("preview"),r(k,h(R,{get when(){return t().errors.length>0},get children(){var D=Qa();return r(D,h(ce,{get each(){return t().errors},children:L=>(()=>{var S=no();return S.firstChild,r(S,L,null),S})()})),D}}),null),r(k,h(R,{get when(){return t().loading},get children(){return Ha()}}),null),r(k,h(R,{get when(){return t().currentStep==="connection"},get children(){var D=Ka(),L=D.firstChild,S=L.nextSibling,Q=S.firstChild,U=Q.firstChild,w=U.nextSibling,A=Q.nextSibling,V=A.firstChild;return w.addEventListener("change",z=>{const M=z.currentTarget.value,J={mysql:3306,postgresql:5432,sqlserver:1433,oracle:1521,sqlite:0}[M];s({database_type:M,port:J})}),r(S,h(R,{get when(){return t().config.database_type!=="sqlite"},get children(){var z=Ja(),M=z.firstChild,J=M.firstChild,de=J.nextSibling,ee=M.nextSibling,H=ee.firstChild,ne=H.nextSibling;return de.addEventListener("change",ve=>s({host:ve.currentTarget.value})),ne.addEventListener("change",ve=>s({port:parseInt(ve.currentTarget.value)||3306})),P(()=>de.value=t().config.host),P(()=>ne.value=t().config.port),z}}),A),r(S,h(R,{get when(){return t().config.database_type==="sqlite"},get children(){var z=Va(),M=z.firstChild,J=M.nextSibling;return J.addEventListener("change",de=>s({database:de.currentTarget.value})),P(()=>J.value=t().config.database),z}}),A),r(S,h(R,{get when(){return t().config.database_type!=="sqlite"},get children(){return[(()=>{var z=Wa(),M=z.firstChild,J=M.nextSibling;return J.addEventListener("change",de=>s({database:de.currentTarget.value})),P(()=>J.value=t().config.database),z})(),(()=>{var z=Ga(),M=z.firstChild,J=M.firstChild,de=J.nextSibling,ee=M.nextSibling,H=ee.firstChild,ne=H.nextSibling;return de.addEventListener("change",ve=>s({username:ve.currentTarget.value})),ne.addEventListener("change",ve=>s({password:ve.currentTarget.value})),P(()=>de.value=t().config.username),P(()=>ne.value=t().config.password),z})()]}}),A),V.$$click=a,r(V,()=>t().loading?"⏳ 测试中...":"🔗 测试连接"),r(A,h(R,{get when(){return t().testResult},get children(){var z=Tn(),M=z.firstChild,J=M.firstChild,de=J.nextSibling;return r(J,()=>{var ee;return(ee=t().testResult)!=null&&ee.success?"✅":"❌"}),r(de,()=>{var ee;return(ee=t().testResult)==null?void 0:ee.message}),P(()=>{var ee;return $e(z,`test-result ${(ee=t().testResult)!=null&&ee.success?"success":"error"}`)}),z}}),null),P(()=>V.disabled=t().loading),P(()=>w.value=t().config.database_type),D}}),null),r(k,h(R,{get when(){return t().currentStep==="schema"},get children(){var D=eo();return D.firstChild,r(D,h(R,{get when(){return _e(()=>!t().schema)()&&!t().loading},get children(){var L=Ya(),S=L.firstChild;return S.$$click=o,L}}),null),r(D,h(R,{get when(){return t().schema},get children(){var L=Za(),S=L.firstChild,Q=S.firstChild,U=Q.firstChild,w=U.nextSibling,A=Q.nextSibling,V=A.firstChild,z=V.nextSibling,M=A.nextSibling,J=M.firstChild,de=J.nextSibling,ee=M.nextSibling,H=ee.firstChild,ne=H.nextSibling,ve=S.nextSibling,ie=ve.firstChild,se=ie.nextSibling;return r(w,()=>{var te;return(te=t().schema)==null?void 0:te.database_name}),r(z,()=>{var te,re,oe;return((oe=(re=(te=t().schema)==null?void 0:te.schemas[0])==null?void 0:re.tables)==null?void 0:oe.length)||0}),r(de,()=>{var te,re,oe;return((oe=(re=(te=t().schema)==null?void 0:te.schemas[0])==null?void 0:re.views)==null?void 0:oe.length)||0}),r(ne,()=>{var te;return new Date(((te=t().schema)==null?void 0:te.loaded_at)||"").toLocaleString("zh-CN")}),r(se,h(ce,{get each(){var te,re;return((re=(te=t().schema)==null?void 0:te.schemas[0])==null?void 0:re.tables)||[]},children:te=>h(Wo,{table:te,get selected(){return t().selectedTables.includes(te.name)},onToggle:(re,oe)=>{const X=t().selectedTables;i(oe?{selectedTables:[...X,re]}:{selectedTables:X.filter(G=>G!==re)})}})})),r(L,h(R,{get when(){return _e(()=>{var te,re;return!!((re=(te=t().schema)==null?void 0:te.schemas[0])!=null&&re.views)})()&&t().schema.schemas[0].views.length>0},get children(){var te=Xa(),re=te.firstChild,oe=re.nextSibling;return r(oe,h(ce,{get each(){var X,G;return((G=(X=t().schema)==null?void 0:X.schemas[0])==null?void 0:G.views)||[]},children:X=>(()=>{var G=io(),fe=G.firstChild,me=fe.firstChild,be=me.nextSibling;return r(me,()=>X.name),r(be,()=>X.schema),r(G,h(R,{get when(){return X.comment},get children(){var ue=lo();return r(ue,()=>X.comment),ue}}),null),G})()})),te}}),null),L}}),null),D}}),null),r(k,h(R,{get when(){return t().currentStep==="query"},get children(){return h(ja,{get selectedTables(){return t().selectedTables},get schema(){return t().schema},get config(){return t().config},get sql(){return t().customSQL},onSQLChange:D=>i({customSQL:D}),onQueryResult:D=>i({queryResult:D}),onValidationChange:D=>i({validation:D})})}}),null),r(k,h(R,{get when(){return t().currentStep==="preview"},get children(){return h(Go,{get state(){return t()},onStateUpdate:i,onSave:b,onValidate:g,onPreviewData:c})}}),null),q.$$click=v,j.$$click=()=>{var L;const D=t();D.currentStep==="connection"&&((L=D.testResult)!=null&&L.success)?(i({currentStep:"schema"}),D.schema||o()):D.currentStep==="schema"?i({currentStep:"query"}):D.currentStep==="query"&&i({currentStep:"preview"})},P(D=>{var L=`progress-step ${t().currentStep==="connection"?"active":""} ${l().connection?"completed":""}`,S=`progress-step ${t().currentStep==="schema"?"active":""} ${l().schema?"completed":""}`,Q=`progress-step ${t().currentStep==="query"?"active":""} ${l().query?"completed":""}`,U=`progress-step ${t().currentStep==="preview"?"active":""} ${l().preview?"completed":""}`,w=t().loading;return L!==D.e&&$e(p,D.e=L),S!==D.t&&$e(_,D.t=S),Q!==D.a&&$e(C,D.a=Q),U!==D.o&&$e(E,D.o=U),w!==D.i&&(j.disabled=D.i=w),D},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),f})()}function Wo(e){const t=l=>l<1e3?l.toString():l<1e6?`${(l/1e3).toFixed(1)}K`:`${(l/1e6).toFixed(1)}M`,n=l=>{const i=l.toLowerCase();return i.includes("int")||i.includes("number")||i.includes("decimal")?"🔢":i.includes("varchar")||i.includes("text")||i.includes("char")?"📝":i.includes("date")||i.includes("time")?"📅":i.includes("bool")?"✅":"📋"};return(()=>{var l=go(),i=l.firstChild,s=i.firstChild,a=s.firstChild,o=a.firstChild,g=o.nextSibling;g.firstChild;var c=s.nextSibling,b=c.firstChild,u=b.firstChild,v=b.nextSibling,f=i.nextSibling,d=f.firstChild,y=d.firstChild,$=y.nextSibling;$.nextSibling;var p=d.nextSibling;return o.addEventListener("change",_=>e.onToggle(e.table.name,_.currentTarget.checked)),r(g,()=>e.table.name,null),r(b,()=>t(e.table.row_count_estimate),u),r(v,()=>e.table.size_estimate),r(l,h(R,{get when(){return e.table.comment},get children(){var _=so();return r(_,()=>e.table.comment),_}}),f),r(d,()=>{var _;return((_=e.table.columns)==null?void 0:_.length)||0},$),r(p,h(ce,{get each(){return(e.table.columns||[]).slice(0,6)},children:_=>(()=>{var C=fo(),E=C.firstChild,k=E.nextSibling,I=k.nextSibling;return r(E,()=>n(_.data_type)),r(k,()=>_.name),r(I,()=>_.data_type),r(C,h(R,{get when(){return _.is_primary_key},get children(){return ho()}}),null),r(C,h(R,{get when(){return _.is_foreign_key},get children(){return vo()}}),null),C})()}),null),r(p,h(R,{get when(){var _;return(((_=e.table.columns)==null?void 0:_.length)||0)>6},get children(){var _=ro(),C=_.firstChild,E=C.nextSibling;return E.nextSibling,r(_,()=>{var k;return(((k=e.table.columns)==null?void 0:k.length)||0)-6},E),_}}),null),r(l,h(R,{get when(){return e.table.indexes&&e.table.indexes.length>0},get children(){var _=oo(),C=_.firstChild,E=C.firstChild,k=E.nextSibling;k.nextSibling;var I=C.nextSibling;return r(C,()=>e.table.indexes.length,k),r(I,h(ce,{get each(){return e.table.indexes.slice(0,3)},children:N=>(()=>{var q=mo(),j=q.firstChild;return r(q,()=>N.unique?"🔐":"📇",j),r(q,()=>N.name,null),P(D=>{var L=`index-badge ${N.unique?"unique":""}`,S=N.columns.join(", ");return L!==D.e&&$e(q,D.e=L),S!==D.t&&B(q,"title",D.t=S),D},{e:void 0,t:void 0}),q})()}),null),r(I,h(R,{get when(){return e.table.indexes.length>3},get children(){var N=ao();return N.firstChild,r(N,()=>e.table.indexes.length-3,null),N}}),null),_}}),null),r(l,h(R,{get when(){return e.table.foreign_keys&&e.table.foreign_keys.length>0},get children(){var _=uo(),C=_.firstChild,E=C.firstChild,k=E.nextSibling;k.nextSibling;var I=C.nextSibling;return r(C,()=>e.table.foreign_keys.length,k),r(I,h(ce,{get each(){return e.table.foreign_keys.slice(0,2)},children:N=>(()=>{var q=bo();return q.firstChild,r(q,()=>N.referenced_table,null),P(()=>B(q,"title",`${N.column_name} → ${N.referenced_table}.${N.referenced_column}`)),q})()}),null),r(I,h(R,{get when(){return e.table.foreign_keys.length>2},get children(){var N=co();return N.firstChild,r(N,()=>e.table.foreign_keys.length-2,null),N}}),null),_}}),null),P(()=>$e(l,`table-card ${e.selected?"selected":""}`)),P(()=>o.checked=e.selected),l})()}function Go(e){return(()=>{var t=yo(),n=t.firstChild,l=n.nextSibling,i=l.firstChild,s=i.nextSibling,a=s.firstChild,o=a.firstChild,g=o.nextSibling,c=a.nextSibling,b=c.firstChild,u=b.nextSibling,v=s.nextSibling,f=v.firstChild,d=f.nextSibling;return g.$$input=y=>e.onStateUpdate({name:y.currentTarget.value}),u.$$input=y=>{const $=y.currentTarget.value.split(",").map(p=>p.trim()).filter(p=>p);e.onStateUpdate({tags:$})},d.$$input=y=>e.onStateUpdate({description:y.currentTarget.value}),r(t,h(Ko,{get state(){return e.state}}),null),r(t,h(Yo,{get validation(){return e.state.dataSourceValidation},get onValidate(){return e.onValidate},get loading(){return e.state.loading}}),null),r(t,h(Xo,{get preview(){return e.state.dataPreview},get onPreviewData(){return e.onPreviewData},get loading(){return e.state.loading}}),null),r(t,h(ec,{get state(){return e.state},get saveResult(){return e.state.saveResult},get onSave(){return e.onSave},get isSaving(){return e.state.isSaving},get canSave(){return tc(e.state)}}),null),P(()=>g.value=e.state.name),P(()=>u.value=e.state.tags.join(", ")),P(()=>d.value=e.state.description),t})()}function Ko(e){return(()=>{var t=po(),n=t.firstChild,l=n.nextSibling,i=l.firstChild,s=i.firstChild,a=s.nextSibling,o=i.nextSibling,g=o.firstChild,c=g.nextSibling,b=c.firstChild,u=o.nextSibling,v=u.firstChild,f=v.nextSibling,d=u.nextSibling,y=d.firstChild,$=y.nextSibling,p=d.nextSibling,_=p.firstChild,C=_.nextSibling,E=C.firstChild,k=p.nextSibling,I=k.firstChild,N=I.nextSibling,q=N.firstChild,j=l.nextSibling,D=j.firstChild,L=D.nextSibling;return r(a,()=>e.state.config.database_type.toUpperCase()),r(c,()=>e.state.config.host,b),r(c,()=>e.state.config.port,null),r(f,()=>e.state.config.database),r($,()=>e.state.config.username),r(C,()=>e.state.selectedTables.length,E),r(N,()=>e.state.customSQL.length,q),r(L,()=>e.state.customSQL.slice(0,200),null),r(L,()=>e.state.customSQL.length>200?"...":"",null),t})()}function Yo(e){return(()=>{var t=wo(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(i,"click",e.onValidate),r(i,()=>e.loading?"⏳ 验证中...":"🔍 开始验证"),r(t,h(R,{get when(){return e.validation},get children(){var s=So(),a=s.firstChild;return r(a,h(vt,{label:"数据库连接",get status(){var o;return(o=e.validation)!=null&&o.connection_valid?"success":"error"},get icon(){var o;return(o=e.validation)!=null&&o.connection_valid?"✅":"❌"}}),null),r(a,h(vt,{label:"SQL语法",get status(){var o;return(o=e.validation)!=null&&o.sql_valid?"success":"error"},get icon(){var o;return(o=e.validation)!=null&&o.sql_valid?"✅":"❌"}}),null),r(a,h(vt,{label:"安全检查",get status(){var o;return(o=e.validation)!=null&&o.security_passed?"success":"warning"},get icon(){var o;return(o=e.validation)!=null&&o.security_passed?"✅":"⚠️"}}),null),r(a,h(vt,{label:"性能评估",get status(){var o;return(o=e.validation)!=null&&o.performance_acceptable?"success":"info"},get icon(){var o;return(o=e.validation)!=null&&o.performance_acceptable?"✅":"ℹ️"}}),null),r(s,h(R,{get when(){return e.validation&&e.validation.warnings.length>0},get children(){var o=$o();return o.firstChild,r(o,h(ce,{get each(){return e.validation.warnings||[]},children:g=>(()=>{var c=Co();return r(c,g),c})()}),null),o}}),null),r(s,h(R,{get when(){return e.validation&&e.validation.errors.length>0},get children(){var o=_o();return o.firstChild,r(o,h(ce,{get each(){return e.validation.errors||[]},children:g=>(()=>{var c=ko();return r(c,g),c})()}),null),o}}),null),r(s,h(R,{get when(){return e.validation&&e.validation.suggestions&&e.validation.suggestions.length>0},get children(){var o=xo();return o.firstChild,r(o,h(ce,{get each(){return e.validation.suggestions||[]},children:g=>(()=>{var c=To();return r(c,g),c})()}),null),o}}),null),s}}),null),P(()=>i.disabled=e.loading),t})()}function vt(e){return(()=>{var t=Eo(),n=t.firstChild,l=n.nextSibling,i=l.nextSibling;return r(n,()=>e.icon),r(l,()=>e.label),r(i,()=>e.status==="success"?"通过":e.status==="error"?"失败":e.status==="warning"?"警告":"信息"),P(s=>{var a=`validation-check ${e.status}`,o=`check-status ${e.status}`;return a!==s.e&&$e(t,s.e=a),o!==s.t&&$e(i,s.t=o),s},{e:void 0,t:void 0}),t})()}function Xo(e){return(()=>{var t=Po(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(i,"click",e.onPreviewData),r(i,()=>e.loading?"⏳ 加载中...":"👁️ 预览数据"),r(t,h(R,{get when(){return e.preview},get children(){var s=Do(),a=s.firstChild,o=a.firstChild,g=o.firstChild,c=g.nextSibling,b=o.nextSibling,u=b.firstChild,v=u.nextSibling,f=b.nextSibling,d=f.firstChild,y=d.nextSibling,$=y.firstChild,p=a.nextSibling;return r(c,()=>{var _;return((_=e.preview)==null?void 0:_.sample_data.length)||0}),r(v,()=>{var _;return((_=e.preview)==null?void 0:_.total_estimated_rows.toLocaleString())||"未知"}),r(y,()=>{var _;return((_=e.preview)==null?void 0:_.execution_stats.execution_time)||0},$),r(p,h(R,{get when(){return e.preview&&e.preview.sample_data.length>0},get children(){return h(Zo,{get data(){return e.preview.sample_data||[]}})}}),null),r(p,h(R,{get when(){return!e.preview||e.preview.sample_data.length===0},get children(){return Lo()}}),null),s}}),null),P(()=>i.disabled=e.loading),t})()}function Zo(e){if(!e.data||e.data.length===0)return Ao();const t=Object.keys(e.data[0]);return(()=>{var n=Ro(),l=n.firstChild,i=l.firstChild,s=i.firstChild,a=i.nextSibling;return r(s,h(ce,{each:t,children:o=>(()=>{var g=Mo();return r(g,o),g})()})),r(a,h(ce,{get each(){return e.data.slice(0,10)},children:o=>(()=>{var g=No();return r(g,h(ce,{each:t,children:c=>(()=>{var b=Oo();return r(b,()=>nc(o[c])),b})()})),g})()})),r(n,h(R,{get when(){return e.data.length>10},get children(){var o=zo(),g=o.firstChild,c=g.nextSibling;return c.nextSibling,r(o,()=>e.data.length,c),o}}),null),n})()}function ec(e){return(()=>{var t=jo(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(i,"click",e.onSave),r(i,()=>e.isSaving?"💾 保存中...":"💾 保存数据源"),r(t,h(R,{get when(){return!e.canSave&&!e.isSaving},get children(){var s=Io(),a=s.firstChild,o=a.nextSibling,g=o.firstChild,c=g.firstChild,b=c.nextSibling,u=b.nextSibling,v=u.nextSibling;v.nextSibling;var f=g.nextSibling,d=f.firstChild,y=d.nextSibling;y.nextSibling;var $=f.nextSibling,p=$.firstChild,_=p.nextSibling;_.nextSibling;var C=$.nextSibling;C.firstChild;var E=o.nextSibling;return r(g,()=>e.state.name?"✅":"❌",b),r(g,()=>e.state.name,v),r(f,()=>e.state.customSQL?"✅":"❌",y),r(f,()=>e.state.customSQL?`(${e.state.customSQL.length} 字符)`:"(空)",null),r($,()=>{var k;return(k=e.state.testResult)!=null&&k.success?"✅":"❌"},_),r($,()=>{var k;return(k=e.state.testResult)!=null&&k.success?"成功":e.state.testResult?`失败: ${e.state.testResult.message}`:"未测试"},null),r(C,()=>e.isSaving?"❌ 正在保存中":"✅ 空闲",null),r(E,()=>{var k;return(k=e.state.testResult)!=null&&k.success?"所有条件都已满足，但按钮仍然禁用。这可能是一个bug。":"请返回第1步完成连接测试，然后才能保存数据源。"}),s}}),null),r(t,h(R,{get when(){return e.saveResult},get children(){var s=Tn(),a=s.firstChild,o=a.firstChild,g=o.nextSibling;return r(o,()=>{var c;return(c=e.saveResult)!=null&&c.success?"✅":"❌"}),r(g,()=>{var c;return(c=e.saveResult)==null?void 0:c.message}),r(s,h(R,{get when(){var c;return((c=e.saveResult)==null?void 0:c.success)&&e.saveResult.data_source_id},get children(){var c=Uo(),b=c.firstChild,u=b.firstChild,v=u.nextSibling;return r(v,()=>e.saveResult.data_source_id),c}}),null),r(s,h(R,{get when(){return e.saveResult&&e.saveResult.warnings&&e.saveResult.warnings.length>0},get children(){var c=Fo();return r(c,h(ce,{get each(){return e.saveResult.warnings||[]},children:b=>(()=>{var u=Qo();return u.firstChild,r(u,b,null),u})()})),c}}),null),r(s,h(R,{get when(){return e.saveResult&&e.saveResult.errors&&e.saveResult.errors.length>0},get children(){var c=qo();return r(c,h(ce,{get each(){return e.saveResult.errors||[]},children:b=>(()=>{var u=Ho();return u.firstChild,r(u,b,null),u})()})),c}}),null),P(()=>{var c;return $e(s,`save-result ${(c=e.saveResult)!=null&&c.success?"success":"error"}`)}),s}}),null),r(t,h(R,{get when(){return!e.canSave},get children(){return Bo()}}),null),P(s=>{var a=`save-btn ${e.canSave?"primary":"disabled"}`,o=e.isSaving||!e.canSave;return a!==s.e&&$e(i,s.e=a),o!==s.t&&(i.disabled=s.t=o),s},{e:void 0,t:void 0}),t})()}function tc(e){var s;const t=e.name.trim().length>0,n=e.customSQL.trim().length>0,l=(s=e.testResult)==null?void 0:s.success,i=!e.isSaving;return console.log("🔍 保存条件检查:",{hasName:t,hasSQL:n,hasSuccessfulTest:l,notSaving:i,testResult:e.testResult,name:e.name,sql:e.customSQL}),!!(t&&n&&l&&i)}function nc(e){return e==null?"(null)":typeof e=="string"&&e.length>50?e.substring(0,47)+"...":String(e)}De(["click","input"]);var lc=m("<input type=text class=search-input placeholder=搜索数据源...>"),ic=m("<div class=add-buttons-group><button class=add-data-source-btn>📄 文件数据源</button><button class=add-database-source-btn>🗄️ 数据库数据源"),sc=m("<div class=error-message>"),rc=m("<div class=loading-message>加载中..."),ac=m("<div class=empty-state><p></p><button>添加第一个数据源"),oc=m("<div class=data-source-grid>"),cc=m("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),dc=m("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),uc=m("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),gc=m("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),hc=m("<li><button> <!> (<!>)"),vc=m("<th>"),fc=m("<tr>"),mc=m("<td>"),bc=m('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function yc(e){console.log("🏗️  DataSourceManagementCenter 组件渲染，isOpen:",e.isOpen);const[t,n]=Y([]),[l,i]=Y([]),[s,a]=Y("main"),[o,g]=Y(null),[c,b]=Y(null),[u,v]=Y(!1),[f,d]=Y(null),[y,$]=Y(""),[p,_]=Y("all"),[C,E]=Y("all");Ue(async()=>{try{await k(),await I()}catch(z){console.error("🚨 数据源管理中心初始化失败:",z),d(`初始化失败: ${z}`)}});const k=async()=>{try{v(!0),console.log("🔄 加载数据源列表...");const z=await we.listDataSources();console.log("✅ 数据源列表加载成功:",z),n(z),d(null)}catch(z){console.error("❌ 加载数据源失败:",z),d(`加载数据源失败: ${z}`)}finally{v(!1)}},I=async()=>{try{console.log("🔄 加载可用数据源类型...");const z=await we.getAvailableTypes();console.log("✅ 数据源类型加载成功:",z),i(z)}catch(z){console.error("❌ 加载数据源类型失败:",z)}},N=z=>{const M=(z.type_name||z.provider_type||"").toLowerCase();return M.includes("database_mysql")?"mysql":M.includes("database_postgresql")?"postgresql":M.includes("database")?"database":M.includes("json")?"json":M.includes("csv")?"csv":M.includes("excel")?"excel":M.includes("api")?"api":M||"unknown"},q=()=>{let z=t();if(y()){const M=y().toLowerCase();z=z.filter(J=>(J.name||"").toLowerCase().includes(M)||N(J).includes(M))}return p()!=="all"&&(z=z.filter(M=>M.status===p())),C()!=="all"&&(z=z.filter(M=>N(M)===C())),z},j=z=>t().filter(M=>M.status===z).length,D=z=>t().filter(M=>N(M)===z).length,L=()=>{a("add"),g(null)},S=()=>{a("add-database"),g(null)},Q=z=>{g(z),a("edit")},U=async z=>{try{v(!0),d(null),g(z),console.log("🔄 开始预览数据源:",z.name);const M=await we.getPreview(z.id);b(M),a("preview"),console.log("✅ 数据预览加载成功:",M)}catch(M){console.error("❌ 数据预览失败:",M),d(`预览数据源 "${z.name}" 失败: ${M}`)}finally{v(!1)}},w=async z=>{try{v(!0);const M=t().find(de=>de.id===z);if(!M){d(`数据源不存在: ${z}`);return}const J=await we.testConnection(M.provider_type,M.config||{});alert(J?`✅ 数据源 "${M.name}" 连接测试成功！`:`❌ 数据源 "${M.name}" 连接测试失败`)}catch(M){console.error("❌ 测试连接失败:",M);const J=t().find(de=>de.id===z);alert(`❌ 数据源 "${(J==null?void 0:J.name)||z}" 连接测试失败:
${M}`)}finally{v(!1)}},A=async z=>{const M=t().find(J=>J.id===z);if(confirm(`确定要删除数据源 "${M==null?void 0:M.name}" 吗？`))try{await we.deleteDataSource(z),await k()}catch(J){d(`删除数据源失败: ${J}`)}},V=()=>{a("main"),g(null),b(null),d(null)};return h(R,{get when(){return e.isOpen},get children(){var z=gc(),M=z.firstChild,J=M.firstChild,de=J.nextSibling,ee=de.nextSibling,H=M.nextSibling;return Te(J,"click",e.onClose),r(ee,h(R,{get when(){return s()==="main"},get children(){return[(()=>{var ne=lc();return ne.$$input=ve=>$(ve.currentTarget.value),P(()=>ne.value=y()),ne})(),(()=>{var ne=ic(),ve=ne.firstChild,ie=ve.nextSibling;return ve.$$click=L,ie.$$click=S,ne})()]}})),r(H,h(R,{get when(){return s()==="main"},get children(){var ne=cc(),ve=ne.firstChild,ie=ve.firstChild,se=ie.firstChild,te=se.nextSibling,re=te.firstChild,oe=re.firstChild,X=oe.firstChild,G=X.nextSibling;G.nextSibling;var fe=ie.nextSibling,me=fe.firstChild,be=me.nextSibling,ue=be.firstChild,Se=ue.firstChild,Z=Se.firstChild,ge=Z.nextSibling;ge.nextSibling;var x=ue.nextSibling,T=x.firstChild,F=T.firstChild,O=F.nextSibling;O.nextSibling;var W=x.nextSibling,le=W.firstChild,K=le.firstChild,ye=K.nextSibling;ye.nextSibling;var ke=fe.nextSibling,ae=ke.firstChild,Ae=ae.nextSibling,Pe=Ae.firstChild,Ne=Pe.firstChild,je=ve.nextSibling;return oe.$$click=()=>_("all"),r(oe,()=>t().length,G),Se.$$click=()=>_("active"),r(Se,()=>j("active"),ge),T.$$click=()=>_("error"),r(T,()=>j("error"),O),le.$$click=()=>_("disabled"),r(le,()=>j("disabled"),ye),Ne.$$click=()=>E("all"),r(Ae,h(ce,{get each(){return l()},children:xe=>(()=>{var Re=hc(),Fe=Re.firstChild,lt=Fe.firstChild,it=lt.nextSibling,ht=it.nextSibling,qt=ht.nextSibling;return qt.nextSibling,Fe.$$click=()=>E(xe.type_name),r(Fe,()=>xe.category==="file"?"📄":xe.category==="api"?"🌐":xe.category==="database"?"🗄️":"📊",lt),r(Fe,()=>xe.display_name,it),r(Fe,()=>D(xe.type_name),qt),P(()=>$e(Re,C()===xe.type_name?"active":"")),Re})()}),null),r(je,h(R,{get when(){return f()},get children(){var xe=sc();return r(xe,f),xe}}),null),r(je,h(R,{get when(){return u()},get children(){return rc()}}),null),r(je,h(R,{get when(){return _e(()=>!u())()&&q().length===0},get children(){var xe=ac(),Re=xe.firstChild,Fe=Re.nextSibling;return r(Re,()=>y()||p()!=="all"||C()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),Fe.$$click=L,xe}}),null),r(je,h(R,{get when(){return _e(()=>!u())()&&q().length>0},get children(){var xe=oc();return r(xe,h(ce,{get each(){return q()},children:Re=>h(pc,{source:Re,onPreview:()=>U(Re),onTest:()=>w(Re.id),onEdit:()=>Q(Re),onDelete:()=>A(Re.id)})})),xe}}),null),P(xe=>{var Re=p()==="all"?"active":"",Fe=p()==="active"?"active":"",lt=p()==="error"?"active":"",it=p()==="disabled"?"active":"",ht=C()==="all"?"active":"";return Re!==xe.e&&$e(re,xe.e=Re),Fe!==xe.t&&$e(ue,xe.t=Fe),lt!==xe.a&&$e(x,xe.a=lt),it!==xe.o&&$e(W,xe.o=it),ht!==xe.i&&$e(Pe,xe.i=ht),xe},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ne}}),null),r(H,h(R,{get when(){return s()==="add"},get children(){return h(kn,{get availableTypes(){return l()},onBack:V,onSuccess:()=>{k(),V()}})}}),null),r(H,h(R,{get when(){return s()==="add-database"},get children(){return h(Vo,{onBack:V,onSuccess:()=>{k(),V()}})}}),null),r(H,h(R,{get when(){return _e(()=>s()==="edit")()&&o()},get children(){var ne=dc(),ve=ne.firstChild,ie=ve.firstChild,se=ie.nextSibling;return se.firstChild,ie.$$click=V,r(se,()=>{var te;return(te=o())==null?void 0:te.name},null),ne}}),null),r(H,h(R,{get when(){return _e(()=>!!(s()==="preview"&&o()))()&&c()},get children(){var ne=uc(),ve=ne.firstChild,ie=ve.firstChild,se=ie.nextSibling;se.firstChild;var te=se.nextSibling,re=te.firstChild,oe=re.nextSibling,X=oe.nextSibling,G=X.nextSibling;G.nextSibling;var fe=ve.nextSibling,me=fe.firstChild,be=me.firstChild,ue=be.firstChild,Se=be.nextSibling;return ie.$$click=V,r(se,()=>{var Z;return(Z=o())==null?void 0:Z.name},null),r(te,()=>{var Z;return(Z=c())==null?void 0:Z.total_rows},oe),r(te,()=>{var Z;return(Z=c())==null?void 0:Z.rows.length},G),r(ue,h(ce,{get each(){var Z;return(Z=c())==null?void 0:Z.columns},children:Z=>(()=>{var ge=vc();return r(ge,Z),ge})()})),r(Se,h(ce,{get each(){var Z;return(Z=c())==null?void 0:Z.rows.slice(0,50)},children:Z=>(()=>{var ge=fc();return r(ge,h(ce,{get each(){var x;return((x=c())==null?void 0:x.columns)||[]},children:x=>(()=>{var T=mc();return r(T,(()=>{var F=_e(()=>typeof Z[x]=="object");return()=>F()?JSON.stringify(Z[x]):String(Z[x]||"")})()),T})()})),ge})()})),ne}}),null),z}})}function pc(e){const t=a=>{switch(a){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=a=>{switch(a){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},l=a=>{const o=new Date,g=new Date(a),c=o.getTime()-g.getTime(),b=Math.floor(c/(1e3*60*60));return b<1?"刚刚更新":b<24?`${b}小时前`:g.toLocaleDateString("zh-CN")},i=a=>{const o=(a||"").toLowerCase();return o.includes("json")?"📄":o.includes("api")?"🌐":o.includes("csv")?"📊":o.includes("database")?"🗄️":"📋"},s=a=>{const o=(a.type_name||a.provider_type||"").toLowerCase();return o.includes("database_mysql")?"MySQL":o.includes("database_postgresql")?"PostgreSQL":o==="json"?"JSON":o==="csv"?"CSV":o==="excel"?"Excel":o.startsWith("api")?"API":o.startsWith("database")?"Database":a.type_name||a.provider_type||"Unknown"};return(()=>{var a=bc(),o=a.firstChild,g=o.firstChild,c=g.firstChild,b=c.nextSibling,u=g.nextSibling,v=o.nextSibling,f=v.firstChild,d=f.firstChild,y=d.nextSibling,$=f.nextSibling,p=$.firstChild,_=p.nextSibling,C=$.nextSibling,E=C.firstChild,k=E.nextSibling,I=v.nextSibling,N=I.firstChild,q=N.nextSibling,j=q.nextSibling,D=j.nextSibling;return r(c,()=>i(e.source.type_name||e.source.provider_type)),r(b,()=>e.source.name),r(y,()=>s(e.source)),r(_,()=>n(e.source.status)),r(k,()=>l(e.source.last_updated)),Te(N,"click",e.onPreview),Te(q,"click",e.onTest),Te(j,"click",e.onEdit),Te(D,"click",e.onDelete),P(L=>{var S=t(e.source.status),Q=`状态: ${n(e.source.status)}`,U=e.source.status!=="active";return S!==L.e&&((L.e=S)!=null?u.style.setProperty("background-color",S):u.style.removeProperty("background-color")),Q!==L.t&&B(u,"title",L.t=Q),U!==L.a&&(N.disabled=L.a=U),L},{e:void 0,t:void 0,a:void 0}),a})()}De(["click","input"]);var $c=m('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden"><div class="w-80 bg-primary border-r border-default flex flex-col"></div><div class="flex-1 flex flex-col bg-tertiary"></div><div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">');const _c=()=>{const[e,t]=Y(!1),[n,l]=Y(!1);console.log("🖥️  MainLayout渲染，管理中心状态:",n());const i=()=>{console.log("🔄 数据源按钮被点击，准备打开管理中心"),console.log("📊 当前管理中心状态:",n()),l(!0),console.log("✅ 管理中心状态已设置为 true"),console.log("📊 设置后的管理中心状态:",n())},s=()=>t(!1),a=()=>l(!1);return h(Kn,{get children(){var o=$c(),g=o.firstChild,c=g.firstChild,b=c.nextSibling,u=b.nextSibling,v=u.firstChild,f=v.firstChild,d=f.nextSibling;return r(o,h(fl,{onOpenDataSources:i}),g),r(c,h(yl,{})),r(b,h(ms,{})),r(f,h(wi,{})),r(d,h(ua,{})),r(o,h(yc,{get isOpen(){return n()},onClose:a}),null),r(o,h(Vr,{get isOpen(){return e()},onClose:s}),null),o}})},xc={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},Sc=()=>{const{state:e,copySelectedElements:t,pasteElements:n,deleteElements:l,undo:i,redo:s,selectAllElements:a,clearSelection:o,moveElements:g}=Ge(),c=(d,y)=>{const $=d.key.toLowerCase()===y.key.toLowerCase()||d.key===y.key,p=!!y.ctrl===(d.ctrlKey||d.metaKey),_=!!y.alt===d.altKey,C=!!y.shift===d.shiftKey;return $&&p&&_&&C},b=async d=>{console.log("🎯 执行快捷键:",d);try{switch(d){case"copy":e.selected_ids.length>0&&(await t(),v("复制成功","✅"));break;case"paste":const y={x:20,y:20},$=await n(y.x,y.y);$.length>0&&v(`粘贴 ${$.length} 个元素`,"📋");break;case"cut":e.selected_ids.length>0&&(await t(),await l([...e.selected_ids]),v("剪切成功","✂️"));break;case"delete":if(e.selected_ids.length>0){const p=e.selected_ids.length;await l([...e.selected_ids]),v(`删除 ${p} 个元素`,"🗑️")}break;case"undo":await i(),v("撤销","↶");break;case"redo":await s(),v("重做","↷");break;case"selectAll":await a(),v(`全选 ${e.elements.length} 个元素`,"🎯");break;case"clearSelection":e.selected_ids.length>0&&(o(),v("清除选择","⭕"));break;case"duplicate":if(e.selected_ids.length>0){await t();const p=await n(20,20);v(`复制 ${p.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await u(d);break;default:console.warn("未知的快捷键动作:",d)}}catch(y){console.error("快捷键执行失败:",y),v("操作失败","❌")}},u=async d=>{if(e.selected_ids.length===0)return;const y=d.includes("Fast"),$=y?10:1;let p=0,_=0;switch(d){case"moveUp":case"moveFastUp":_=-$;break;case"moveDown":case"moveFastDown":_=$;break;case"moveLeft":case"moveFastLeft":p=-$;break;case"moveRight":case"moveFastRight":p=$;break}(p!==0||_!==0)&&(await g([...e.selected_ids],p,_),y&&v(`快速移动 ${$}px`,"🔄"))},v=(d,y)=>{const $=document.createElement("div");$.className="keyboard-feedback",$.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${y}</span>
        <span class="feedback-text">${d}</span>
      </div>
    `,document.body.appendChild($),setTimeout(()=>{$.parentNode&&$.parentNode.removeChild($)},2e3)},f=d=>{const y=d.target;if(!(y.tagName==="INPUT"||y.tagName==="TEXTAREA"||y.contentEditable==="true")){for(const[p,_]of Object.entries(xc))if(c(d,_.combination)){d.preventDefault(),d.stopPropagation(),console.log("🎹 快捷键触发:",p,_.action),b(_.action);return}}};return Ue(()=>{if(document.addEventListener("keydown",f,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const d=document.createElement("style");d.id="keyboard-feedback-styles",d.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(d)}}),ut(()=>{document.removeEventListener("keydown",f,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},wc=()=>(Ue(()=>{document.addEventListener("contextmenu",e=>e.preventDefault());try{const e=typeof window<"u"?window.localStorage.getItem("jasper.activeDataSourceId"):null;e&&Be.setActiveDataSource(e).catch(t=>{console.warn("恢复激活数据源失败:",t)})}catch(e){console.warn("读取本地激活数据源失败:",e)}}),h(il,{get children(){return[h(Sc,{}),h(_c,{})]}})),Cc=document.getElementById("root");jn(()=>h(wc,{}),Cc);
