(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))l(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function l(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const qn=!1,Bn=(e,t)=>e===t,et=Symbol("solid-proxy"),qt=Symbol("solid-track"),_t={equals:Bn};let fn=_n;const We=1,xt=2,vn={owned:null,cleanups:null,context:null,owner:null},At={};var Ce=null;let zt=null,jn=null,Le=null,ze=null,He=null,Dt=0;function yt(e,t){const n=Le,l=Ce,i=e.length===0,r=t===void 0?l:t,a=i?vn:{owned:null,cleanups:null,context:r?r.context:null,owner:r},o=i?e:()=>e(()=>Me(()=>ut(a)));Ce=a,Le=null;try{return Ve(o,!0)}finally{Le=n,Ce=l}}function G(e,t){t=t?Object.assign({},_t,t):_t;const n={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},l=i=>(typeof i=="function"&&(i=i(n.value)),$n(n,i));return[yn.bind(n),l]}function Qn(e,t,n){const l=Pt(e,t,!0,We);st(l)}function P(e,t,n){const l=Pt(e,t,!1,We);st(l)}function vt(e,t,n){fn=Yn;const l=Pt(e,t,!1,We);l.user=!0,He?He.push(l):st(l)}function we(e,t,n){n=n?Object.assign({},_t,n):_t;const l=Pt(e,t,!0,0);return l.observers=null,l.observerSlots=null,l.comparator=n.equals||void 0,st(l),yn.bind(l)}function Hn(e){return e&&typeof e=="object"&&"then"in e}function Gt(e,t,n){let l,i,r;l=!0,i=e,r={};let a=null,o=At,g=!1,c="initialValue"in r,f=typeof l=="function"&&we(l);const h=new Set,[m,b]=(r.storage||G)(r.initialValue),[u,y]=G(void 0),[_,$]=G(void 0,{equals:!1}),[T,L]=G(c?"ready":"unresolved");function E(O,p,S,x){return a===O&&(a=null,x!==void 0&&(c=!0),(O===o||p===o)&&r.onHydrated&&queueMicrotask(()=>r.onHydrated(x,{value:p})),o=At,k(p,S)),p}function k(O,p){Ve(()=>{p===void 0&&b(()=>O),L(p!==void 0?"errored":c?"ready":"unresolved"),y(p);for(const S of h.keys())S.decrement();h.clear()},!1)}function R(){const O=Wn,p=m(),S=u();if(S!==void 0&&!a)throw S;return Le&&Le.user,p}function M(O=!0){if(O!==!1&&g)return;g=!1;const p=f?f():l;if(p==null||p===!1){E(a,Me(m));return}let S;const x=o!==At?o:Me(()=>{try{return i(p,{value:m(),refetching:O})}catch(I){S=I}});if(S!==void 0){E(a,void 0,$t(S),p);return}else if(!Hn(x))return E(a,x,void 0,p),x;return a=x,"v"in x?(x.s===1?E(a,x.v,void 0,p):E(a,void 0,$t(x.v),p),x):(g=!0,queueMicrotask(()=>g=!1),Ve(()=>{L(c?"refreshing":"pending"),$()},!1),x.then(I=>E(x,I,void 0,p),I=>E(x,void 0,$t(I),p)))}Object.defineProperties(R,{state:{get:()=>T()},error:{get:()=>u()},loading:{get(){const O=T();return O==="pending"||O==="refreshing"}},latest:{get(){if(!c)return R();const O=u();if(O&&!a)throw O;return m()}}});let U=Ce;return f?Qn(()=>(U=Ce,M(!1))):M(!1),[R,{refetch:O=>Vn(U,()=>M(O)),mutate:b}]}function Jn(e){return Ve(e,!1)}function Me(e){if(Le===null)return e();const t=Le;Le=null;try{return e()}finally{Le=t}}function Fe(e){vt(()=>Me(e))}function rt(e){return Ce===null||(Ce.cleanups===null?Ce.cleanups=[e]:Ce.cleanups.push(e)),e}function Bt(){return Le}function Vn(e,t){const n=Ce,l=Le;Ce=e,Le=null;try{return Ve(t,!0)}catch(i){Jt(i)}finally{Ce=n,Le=l}}const[rd,sd]=G(!1);function mn(e,t){const n=Symbol("context");return{id:n,Provider:Xn(n),defaultValue:e}}function bn(e){let t;return Ce&&Ce.context&&(t=Ce.context[e.id])!==void 0?t:e.defaultValue}function pn(e){const t=we(e),n=we(()=>jt(t()));return n.toArray=()=>{const l=n();return Array.isArray(l)?l:l!=null?[l]:[]},n}let Wn;function yn(){if(this.sources&&this.state)if(this.state===We)st(this);else{const e=ze;ze=null,Ve(()=>wt(this),!1),ze=e}if(Le){const e=this.observers?this.observers.length:0;Le.sources?(Le.sources.push(this),Le.sourceSlots.push(e)):(Le.sources=[this],Le.sourceSlots=[e]),this.observers?(this.observers.push(Le),this.observerSlots.push(Le.sources.length-1)):(this.observers=[Le],this.observerSlots=[Le.sources.length-1])}return this.value}function $n(e,t,n){let l=e.value;return(!e.comparator||!e.comparator(l,t))&&(e.value=t,e.observers&&e.observers.length&&Ve(()=>{for(let i=0;i<e.observers.length;i+=1){const r=e.observers[i],a=zt&&zt.running;a&&zt.disposed.has(r),(a?!r.tState:!r.state)&&(r.pure?ze.push(r):He.push(r),r.observers&&xn(r)),a||(r.state=We)}if(ze.length>1e6)throw ze=[],new Error},!1)),t}function st(e){if(!e.fn)return;ut(e);const t=Dt;Gn(e,e.value,t)}function Gn(e,t,n){let l;const i=Ce,r=Le;Le=Ce=e;try{l=e.fn(t)}catch(a){return e.pure&&(e.state=We,e.owned&&e.owned.forEach(ut),e.owned=null),e.updatedAt=n+1,Jt(a)}finally{Le=r,Ce=i}(!e.updatedAt||e.updatedAt<=n)&&(e.updatedAt!=null&&"observers"in e?$n(e,l):e.value=l,e.updatedAt=n)}function Pt(e,t,n,l=We,i){const r={fn:e,state:l,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:Ce,context:Ce?Ce.context:null,pure:n};return Ce===null||Ce!==vn&&(Ce.owned?Ce.owned.push(r):Ce.owned=[r]),r}function St(e){if(e.state===0)return;if(e.state===xt)return wt(e);if(e.suspense&&Me(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<Dt);)e.state&&t.push(e);for(let n=t.length-1;n>=0;n--)if(e=t[n],e.state===We)st(e);else if(e.state===xt){const l=ze;ze=null,Ve(()=>wt(e,t[0]),!1),ze=l}}function Ve(e,t){if(ze)return e();let n=!1;t||(ze=[]),He?n=!0:He=[],Dt++;try{const l=e();return Kn(n),l}catch(l){n||(He=null),ze=null,Jt(l)}}function Kn(e){if(ze&&(_n(ze),ze=null),e)return;const t=He;He=null,t.length&&Ve(()=>fn(t),!1)}function _n(e){for(let t=0;t<e.length;t++)St(e[t])}function Yn(e){let t,n=0;for(t=0;t<e.length;t++){const l=e[t];l.user?e[n++]=l:St(l)}for(t=0;t<n;t++)St(e[t])}function wt(e,t){e.state=0;for(let n=0;n<e.sources.length;n+=1){const l=e.sources[n];if(l.sources){const i=l.state;i===We?l!==t&&(!l.updatedAt||l.updatedAt<Dt)&&St(l):i===xt&&wt(l,t)}}}function xn(e){for(let t=0;t<e.observers.length;t+=1){const n=e.observers[t];n.state||(n.state=xt,n.pure?ze.push(n):He.push(n),n.observers&&xn(n))}}function ut(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),l=e.sourceSlots.pop(),i=n.observers;if(i&&i.length){const r=i.pop(),a=n.observerSlots.pop();l<i.length&&(r.sourceSlots[a]=l,i[l]=r,n.observerSlots[l]=a)}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)ut(e.tOwned[t]);delete e.tOwned}if(e.owned){for(t=e.owned.length-1;t>=0;t--)ut(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function $t(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function Jt(e,t=Ce){throw $t(e)}function jt(e){if(typeof e=="function"&&!e.length)return jt(e());if(Array.isArray(e)){const t=[];for(let n=0;n<e.length;n++){const l=jt(e[n]);Array.isArray(l)?t.push.apply(t,l):t.push(l)}return t}return e}function Xn(e,t){return function(l){let i;return P(()=>i=Me(()=>(Ce.context={...Ce.context,[e]:l.value},pn(()=>l.children))),void 0),i}}const Zn=Symbol("fallback");function Kt(e){for(let t=0;t<e.length;t++)e[t]()}function el(e,t,n={}){let l=[],i=[],r=[],a=0,o=t.length>1?[]:null;return rt(()=>Kt(r)),()=>{let g=e()||[],c=g.length,f,h;return g[qt],Me(()=>{let b,u,y,_,$,T,L,E,k;if(c===0)a!==0&&(Kt(r),r=[],l=[],i=[],a=0,o&&(o=[])),n.fallback&&(l=[Zn],i[0]=yt(R=>(r[0]=R,n.fallback())),a=1);else if(a===0){for(i=new Array(c),h=0;h<c;h++)l[h]=g[h],i[h]=yt(m);a=c}else{for(y=new Array(c),_=new Array(c),o&&($=new Array(c)),T=0,L=Math.min(a,c);T<L&&l[T]===g[T];T++);for(L=a-1,E=c-1;L>=T&&E>=T&&l[L]===g[E];L--,E--)y[E]=i[L],_[E]=r[L],o&&($[E]=o[L]);for(b=new Map,u=new Array(E+1),h=E;h>=T;h--)k=g[h],f=b.get(k),u[h]=f===void 0?-1:f,b.set(k,h);for(f=T;f<=L;f++)k=l[f],h=b.get(k),h!==void 0&&h!==-1?(y[h]=i[f],_[h]=r[f],o&&($[h]=o[f]),h=u[h],b.set(k,h)):r[f]();for(h=T;h<c;h++)h in y?(i[h]=y[h],r[h]=_[h],o&&(o[h]=$[h],o[h](h))):i[h]=yt(m);i=i.slice(0,a=c),l=g.slice(0)}return i});function m(b){if(r[h]=b,o){const[u,y]=G(h);return o[h]=y,t(g[h],u)}return t(g[h])}}}function d(e,t){return Me(()=>e(t||{}))}const Sn=e=>`Stale read from <${e}>.`;function ae(e){const t="fallback"in e&&{fallback:()=>e.fallback};return we(el(()=>e.each,e.children,t||void 0))}function z(e){const t=e.keyed,n=we(()=>e.when,void 0,void 0),l=t?n:we(n,void 0,{equals:(i,r)=>!i==!r});return we(()=>{const i=l();if(i){const r=e.children;return typeof r=="function"&&r.length>0?Me(()=>r(t?i:()=>{if(!Me(l))throw Sn("Show");return n()})):r}return e.fallback},void 0,void 0)}function wn(e){const t=pn(()=>e.children),n=we(()=>{const l=t(),i=Array.isArray(l)?l:[l];let r=()=>{};for(let a=0;a<i.length;a++){const o=a,g=i[a],c=r,f=we(()=>c()?void 0:g.when,void 0,void 0),h=g.keyed?f:we(f,void 0,{equals:(m,b)=>!m==!b});r=()=>c()||(h()?[o,f,g]:void 0)}return r});return we(()=>{const l=n()();if(!l)return e.fallback;const[i,r,a]=l,o=a.children;return typeof o=="function"&&o.length>0?Me(()=>o(a.keyed?r():()=>{if(Me(n)()?.[0]!==i)throw Sn("Match");return r()})):o},void 0,void 0)}function Ke(e){return e}const be=e=>we(()=>e());function tl(e,t,n){let l=n.length,i=t.length,r=l,a=0,o=0,g=t[i-1].nextSibling,c=null;for(;a<i||o<r;){if(t[a]===n[o]){a++,o++;continue}for(;t[i-1]===n[r-1];)i--,r--;if(i===a){const f=r<l?o?n[o-1].nextSibling:n[r-o]:g;for(;o<r;)e.insertBefore(n[o++],f)}else if(r===o)for(;a<i;)(!c||!c.has(t[a]))&&t[a].remove(),a++;else if(t[a]===n[r-1]&&n[o]===t[i-1]){const f=t[--i].nextSibling;e.insertBefore(n[o++],t[a++].nextSibling),e.insertBefore(n[--r],f),t[i]=n[r]}else{if(!c){c=new Map;let h=o;for(;h<r;)c.set(n[h],h++)}const f=c.get(t[a]);if(f!=null)if(o<f&&f<r){let h=a,m=1,b;for(;++h<i&&h<r&&!((b=c.get(t[h]))==null||b!==f+m);)m++;if(m>f-o){const u=t[a];for(;o<f;)e.insertBefore(n[o++],u)}else e.replaceChild(n[o++],t[a++])}else a++;else t[a++].remove()}}}const Yt="_$DX_DELEGATE";function nl(e,t,n,l={}){let i;return yt(r=>{i=r,t===document?e():s(t,e(),t.firstChild?null:void 0,n)},l.owner),()=>{i(),t.textContent=""}}function v(e,t,n,l){let i;const r=()=>{const o=l?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return o.innerHTML=e,n?o.content.firstChild.firstChild:l?o.firstChild:o.content.firstChild},a=t?()=>Me(()=>document.importNode(i||(i=r()),!0)):()=>(i||(i=r())).cloneNode(!0);return a.cloneNode=a,a}function De(e,t=window.document){const n=t[Yt]||(t[Yt]=new Set);for(let l=0,i=e.length;l<i;l++){const r=e[l];n.has(r)||(n.add(r),t.addEventListener(r,ll))}}function j(e,t,n){n==null?e.removeAttribute(t):e.setAttribute(t,n)}function me(e,t){t==null?e.removeAttribute("class"):e.className=t}function Te(e,t,n,l){Array.isArray(n)?(e[`$$${t}`]=n[0],e[`$$${t}Data`]=n[1]):e[`$$${t}`]=n}function Vt(e,t,n){if(!t)return n?j(e,"style"):t;const l=e.style;if(typeof t=="string")return l.cssText=t;typeof n=="string"&&(l.cssText=n=void 0),n||(n={}),t||(t={});let i,r;for(r in n)t[r]==null&&l.removeProperty(r),delete n[r];for(r in t)i=t[r],i!==n[r]&&(l.setProperty(r,i),n[r]=i);return n}function gt(e,t,n){return Me(()=>e(t,n))}function s(e,t,n,l){if(n!==void 0&&!l&&(l=[]),typeof t!="function")return Ct(e,t,l,n);P(i=>Ct(e,t(),i,n),l)}function ll(e){let t=e.target;const n=`$$${e.type}`,l=e.target,i=e.currentTarget,r=g=>Object.defineProperty(e,"target",{configurable:!0,value:g}),a=()=>{const g=t[n];if(g&&!t.disabled){const c=t[`${n}Data`];if(c!==void 0?g.call(t,c,e):g.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&r(t.host),!0},o=()=>{for(;a()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const g=e.composedPath();r(g[0]);for(let c=0;c<g.length-2&&(t=g[c],!!a());c++){if(t._$host){t=t._$host,o();break}if(t.parentNode===i)break}}else o();r(l)}function Ct(e,t,n,l,i){for(;typeof n=="function";)n=n();if(t===n)return n;const r=typeof t,a=l!==void 0;if(e=a&&n[0]&&n[0].parentNode||e,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===n))return n;if(a){let o=n[0];o&&o.nodeType===3?o.data!==t&&(o.data=t):o=document.createTextNode(t),n=tt(e,n,l,o)}else n!==""&&typeof n=="string"?n=e.firstChild.data=t:n=e.textContent=t}else if(t==null||r==="boolean")n=tt(e,n,l);else{if(r==="function")return P(()=>{let o=t();for(;typeof o=="function";)o=o();n=Ct(e,o,n,l)}),()=>n;if(Array.isArray(t)){const o=[],g=n&&Array.isArray(n);if(Qt(o,t,n,i))return P(()=>n=Ct(e,o,n,l,!0)),()=>n;if(o.length===0){if(n=tt(e,n,l),a)return n}else g?n.length===0?Xt(e,o,l):tl(e,n,o):(n&&tt(e),Xt(e,o));n=o}else if(t.nodeType){if(Array.isArray(n)){if(a)return n=tt(e,n,l,t);tt(e,n,null,t)}else n==null||n===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);n=t}}return n}function Qt(e,t,n,l){let i=!1;for(let r=0,a=t.length;r<a;r++){let o=t[r],g=n&&n[e.length],c;if(!(o==null||o===!0||o===!1))if((c=typeof o)=="object"&&o.nodeType)e.push(o);else if(Array.isArray(o))i=Qt(e,o,g)||i;else if(c==="function")if(l){for(;typeof o=="function";)o=o();i=Qt(e,Array.isArray(o)?o:[o],Array.isArray(g)?g:[g])||i}else e.push(o),i=!0;else{const f=String(o);g&&g.nodeType===3&&g.data===f?e.push(g):e.push(document.createTextNode(f))}}return i}function Xt(e,t,n=null){for(let l=0,i=t.length;l<i;l++)e.insertBefore(t[l],n)}function tt(e,t,n,l){if(n===void 0)return e.textContent="";const i=l||document.createTextNode("");if(t.length){let r=!1;for(let a=t.length-1;a>=0;a--){const o=t[a];if(i!==o){const g=o.parentNode===e;!r&&!a?g?e.replaceChild(i,o):e.insertBefore(i,n):g&&o.remove()}else r=!0}}else e.insertBefore(i,n);return[i]}var il=v("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),rl=v("<span class=loading-indicator>⏳"),sl=v("<button><span class=button-icon></span><span class=button-text>"),al=v("<div class=error-indicator>❌");const Cn=mn(),ol=e=>{const[t,n]=G({mode:"design",loading:!1,error:void 0}),l=h=>{n(m=>({...m,mode:h,error:void 0})),console.log(`🎯 预览模式切换: ${h==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:h,timestamp:Date.now()}}))},f={state:t,actions:{setMode:l,toggleMode:()=>{const h=t().mode;l(h==="design"?"data":h==="data"?"preview":"design")},setLoading:h=>{n(m=>({...m,loading:h}))},setError:h=>{n(m=>({...m,error:h,loading:!1}))},isDesignMode:()=>t().mode==="design",isDataMode:()=>t().mode==="data",isPreviewMode:()=>t().mode==="preview"}};return d(Cn.Provider,{value:f,get children(){return e.children}})},Rt=()=>{const e=bn(Cn);if(!e)throw new Error("usePreview必须在PreviewProvider内使用");return e},cl=()=>{const{state:e,actions:t}=Rt(),n=i=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[i],l=()=>n(e().mode);return(()=>{var i=il(),r=i.firstChild,a=r.firstChild,o=a.nextSibling,g=r.nextSibling;return s(a,()=>l().icon),s(o,()=>l().text),s(r,(()=>{var c=be(()=>!!e().loading);return()=>c()&&rl()})(),null),s(g,()=>["design","data","preview"].map(c=>{const f=n(c),h=e().mode===c;return(()=>{var m=sl(),b=m.firstChild,u=b.nextSibling;return m.$$click=()=>t.setMode(c),me(m,`mode-btn ${h?"active":""}`),s(b,()=>f.icon),s(u,()=>f.text),P(y=>{var _=e().loading,$=`切换到${f.text}`;return _!==y.e&&(m.disabled=y.e=_),$!==y.t&&j(m,"title",y.t=$),y},{e:void 0,t:void 0}),m})()})),s(i,(()=>{var c=be(()=>!!e().error);return()=>c()&&(()=>{var f=al();return P(()=>j(f,"title",e().error)),f})()})(),null),i})()},Ot={getModeDisplayText:e=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[e],getModeIcon:e=>({design:"🎨",data:"🔗",preview:"🔍"})[e],shouldShowExpression:e=>e==="design",shouldEvaluateExpression:e=>e==="data"||e==="preview",shouldShowDesignAids:e=>e==="design"||e==="data",shouldAllowInteraction:e=>e==="design"||e==="data",isReadOnlyMode:e=>e==="preview",getModeTransitionClass:e=>`mode-${e}-active`};De(["click"]);const Ht=Symbol("store-raw"),it=Symbol("store-node"),je=Symbol("store-has"),kn=Symbol("store-self");function Tn(e){let t=e[et];if(!t&&(Object.defineProperty(e,et,{value:t=new Proxy(e,gl)}),!Array.isArray(e))){const n=Object.keys(e),l=Object.getOwnPropertyDescriptors(e);for(let i=0,r=n.length;i<r;i++){const a=n[i];l[a].get&&Object.defineProperty(e,a,{enumerable:l[a].enumerable,get:l[a].get.bind(t)})}}return t}function kt(e){let t;return e!=null&&typeof e=="object"&&(e[et]||!(t=Object.getPrototypeOf(e))||t===Object.prototype||Array.isArray(e))}function ht(e,t=new Set){let n,l,i,r;if(n=e!=null&&e[Ht])return n;if(!kt(e)||t.has(e))return e;if(Array.isArray(e)){Object.isFrozen(e)?e=e.slice(0):t.add(e);for(let a=0,o=e.length;a<o;a++)i=e[a],(l=ht(i,t))!==i&&(e[a]=l)}else{Object.isFrozen(e)?e=Object.assign({},e):t.add(e);const a=Object.keys(e),o=Object.getOwnPropertyDescriptors(e);for(let g=0,c=a.length;g<c;g++)r=a[g],!o[r].get&&(i=e[r],(l=ht(i,t))!==i&&(e[r]=l))}return e}function Tt(e,t){let n=e[t];return n||Object.defineProperty(e,t,{value:n=Object.create(null)}),n}function ft(e,t,n){if(e[t])return e[t];const[l,i]=G(n,{equals:!1,internal:!0});return l.$=i,e[t]=l}function dl(e,t){const n=Reflect.getOwnPropertyDescriptor(e,t);return!n||n.get||!n.configurable||t===et||t===it||(delete n.value,delete n.writable,n.get=()=>e[et][t]),n}function En(e){Bt()&&ft(Tt(e,it),kn)()}function ul(e){return En(e),Reflect.ownKeys(e)}const gl={get(e,t,n){if(t===Ht)return e;if(t===et)return n;if(t===qt)return En(e),n;const l=Tt(e,it),i=l[t];let r=i?i():e[t];if(t===it||t===je||t==="__proto__")return r;if(!i){const a=Object.getOwnPropertyDescriptor(e,t);Bt()&&(typeof r!="function"||e.hasOwnProperty(t))&&!(a&&a.get)&&(r=ft(l,t,r)())}return kt(r)?Tn(r):r},has(e,t){return t===Ht||t===et||t===qt||t===it||t===je||t==="__proto__"?!0:(Bt()&&ft(Tt(e,je),t)(),t in e)},set(){return!0},deleteProperty(){return!0},ownKeys:ul,getOwnPropertyDescriptor:dl};function Et(e,t,n,l=!1){if(!l&&e[t]===n)return;const i=e[t],r=e.length;n===void 0?(delete e[t],e[je]&&e[je][t]&&i!==void 0&&e[je][t].$()):(e[t]=n,e[je]&&e[je][t]&&i===void 0&&e[je][t].$());let a=Tt(e,it),o;if((o=ft(a,t,i))&&o.$(()=>n),Array.isArray(e)&&e.length!==r){for(let g=e.length;g<r;g++)(o=a[g])&&o.$();(o=ft(a,"length",r))&&o.$(e.length)}(o=a[kn])&&o.$()}function Ln(e,t){const n=Object.keys(t);for(let l=0;l<n.length;l+=1){const i=n[l];Et(e,i,t[i])}}function hl(e,t){if(typeof t=="function"&&(t=t(e)),t=ht(t),Array.isArray(t)){if(e===t)return;let n=0,l=t.length;for(;n<l;n++){const i=t[n];e[n]!==i&&Et(e,n,i)}Et(e,"length",l)}else Ln(e,t)}function dt(e,t,n=[]){let l,i=e;if(t.length>1){l=t.shift();const a=typeof l,o=Array.isArray(e);if(Array.isArray(l)){for(let g=0;g<l.length;g++)dt(e,[l[g]].concat(t),n);return}else if(o&&a==="function"){for(let g=0;g<e.length;g++)l(e[g],g)&&dt(e,[g].concat(t),n);return}else if(o&&a==="object"){const{from:g=0,to:c=e.length-1,by:f=1}=l;for(let h=g;h<=c;h+=f)dt(e,[h].concat(t),n);return}else if(t.length>1){dt(e[l],t,[l].concat(n));return}i=e[l],n=[l].concat(n)}let r=t[0];typeof r=="function"&&(r=r(i,n),r===i)||l===void 0&&r==null||(r=ht(r),l===void 0||kt(i)&&kt(r)&&!Array.isArray(r)?Ln(i,r):Et(e,l,r))}function fl(...[e,t]){const n=ht(e||{}),l=Array.isArray(n),i=Tn(n);function r(...a){Jn(()=>{l&&a.length===1?hl(n,a[0]):dt(n,a)})}return[i,r]}function vl(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Zt(e,t=!1){const n=vl(),l=`_${n}`;return Object.defineProperty(window,l,{value:i=>(t&&Reflect.deleteProperty(window,l),e?.(i)),writable:!1,configurable:!0}),n}async function re(e,t={}){return new Promise((n,l)=>{const i=Zt(a=>{n(a),Reflect.deleteProperty(window,`_${r}`)},!0),r=Zt(a=>{l(a),Reflect.deleteProperty(window,`_${i}`)},!0);window.__TAURI_IPC__({cmd:e,callback:i,error:r,...t})})}const Dn=mn(),ml=e=>{const[t,n]=fl({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[l,i]=G(!1),[r,a]=G(null),[o,g]=G(!1),c=async()=>{try{i(!0),console.log("🔄 Loading app state...");const C=await re("get_app_state");console.log("🔄 App state loaded, selected_ids:",C.selected_ids),n(C)}catch(C){console.error("Failed to load app state:",C)}finally{i(!1)}};Fe(()=>{c()});const f=async(C,A,V,B={})=>{try{i(!0);const H=await re("create_element",{request:{element_type:C,position:A,size:V,content_data:B}});return await c(),H}catch(H){throw console.error("Failed to create element:",H),H}finally{i(!1)}},h=async(C,A)=>{try{i(!0),await re("update_element",{request:{id:C,updates:A}}),await c()}catch(V){throw console.error("Failed to update element:",V),V}finally{i(!1)}},m=async C=>{try{i(!0),await re("batch_update_positions",{request:{updates:C}}),n(A=>{const V=A.elements.map(B=>{const H=C.find(ee=>ee.element_id===B.id);return H?{...B,position:H.new_position}:B});return{...A,elements:V,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(A){throw console.error("Failed to batch update positions:",A),await c(),A}finally{i(!1)}},b=async C=>{try{i(!0),await re("delete_element",{elementId:C}),await c()}catch(A){throw console.error("Failed to delete element:",A),A}finally{i(!1)}},u=async C=>{try{console.log("Selecting element:",C),await re("select_element",{elementId:C}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",t.selected_ids)}catch(A){throw console.error("Failed to select element:",A),A}},y=async C=>{try{console.log("Selecting multiple elements:",C),C.length>0?(await re("select_multiple",{elementIds:C}),console.log("✅ Multi-select completed for:",C.length,"elements")):await re("clear_selection"),await c()}catch(A){throw console.error("Failed to select multiple elements:",A),A}},_=async C=>{try{console.log("Adding to selection:",C),await re("add_to_selection",{elementId:C}),await c()}catch(A){throw console.error("Failed to add to selection:",A),A}},$=async C=>{try{console.log("Removing from selection:",C),await re("remove_from_selection",{elementId:C}),await c()}catch(A){throw console.error("Failed to remove from selection:",A),A}},T=async C=>{try{console.log("Toggling selection:",C),await re("toggle_selection",{elementId:C}),await c()}catch(A){throw console.error("Failed to toggle selection:",A),A}},L=async()=>{try{await re("clear_selection"),await c()}catch(C){throw console.error("Failed to clear selection:",C),C}},E=async()=>{try{await re("copy_selected")}catch(C){throw console.error("Failed to copy selected elements:",C),C}},N={state:t,setState:n,createElement:f,updateElement:h,batchUpdatePositions:m,deleteElement:b,selectElement:u,selectMultiple:y,addToSelection:_,removeFromSelection:$,toggleSelection:T,clearSelection:L,copySelected:E,copySelectedElements:async()=>E(),pasteElements:async(C,A)=>{try{i(!0);const V=await re("paste_elements",{offsetX:C,offsetY:A});return await c(),V}catch(V){throw console.error("Failed to paste elements:",V),V}finally{i(!1)}},deleteElements:async C=>{try{i(!0);for(const A of C)await re("delete_element",{elementId:A});await c()}catch(A){throw console.error("Failed to delete elements:",A),A}finally{i(!1)}},selectAllElements:async()=>{try{const C=t.elements.map(A=>A.id);await y(C)}catch(C){throw console.error("Failed to select all elements:",C),C}},moveElements:async(C,A,V)=>{try{i(!0);const B=t.elements.filter(H=>C.includes(H.id)).map(H=>({element_id:H.id,new_position:{x:H.position.x+A,y:H.position.y+V}}));B.length>0&&await m(B)}catch(B){throw console.error("Failed to move elements:",B),B}finally{i(!1)}},undo:async()=>{try{i(!0),await re("undo"),await c()}catch(C){throw console.error("Failed to undo:",C),C}finally{i(!1)}},redo:async()=>{try{i(!0),await re("redo"),await c()}catch(C){throw console.error("Failed to redo:",C),C}finally{i(!1)}},updateCanvasConfig:async C=>{try{i(!0),await re("update_canvas_config",{request:C}),await c()}catch(A){throw console.error("Failed to update canvas config:",A),A}finally{i(!1)}},getElementsAtPoint:async(C,A)=>{try{return await re("get_elements_at_point",{x:C,y:A})}catch(V){return console.error("Failed to get elements at point:",V),[]}},isLoading:l,setLoading:i,dragOperation:r,setDragOperation:a,resizeOperation:o,setResizeOperation:g};return d(Dn.Provider,{value:N,get children(){return e.children}})},Ge=()=>{const e=bn(Dn);if(!e)throw new Error("useAppContext must be used within an AppProvider");return e};async function Pn(e){return re("tauri",e)}async function bl(e={}){return typeof e=="object"&&Object.freeze(e),Pn({__tauriModule:"Dialog",message:{cmd:"openDialog",options:e}})}async function pl(e={}){return typeof e=="object"&&Object.freeze(e),Pn({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:e}})}class Mt{static async loadTemplate(t){return await re("load_jasper_template",{filePath:t})}static async saveTemplate(t,n){await re("save_jasper_template",{template:t,filePath:n})}static async saveTemplateAs(t,n,l){await re("save_template_as",{template:t,filePath:n,format:l})}static async validateTemplate(t){return await re("validate_template",{template:t})}static async createEmptyTemplate(){return await re("create_empty_template")}static async getTemplateInfo(t){return await re("get_template_info",{filePath:t})}static async detectTemplateFormat(t){return await re("detect_template_format",{filePath:t})}static async generateTemplatePreview(t){return await re("generate_template_preview",{template:t})}static async exportTemplateJson(t){return await re("export_template_json",{template:t})}static async importTemplateJson(t){return await re("import_template_json",{jsonData:t})}static async cloneTemplate(t){return await re("clone_template",{template:t})}static async mergeTemplates(t,n){return await re("merge_templates",{baseTemplate:t,overlayTemplate:n})}static async extractTemplateElements(t,n){return await re("extract_template_elements",{template:t,elementIds:n})}}const yl="modulepreload",$l=function(e){return"/"+e},en={},_l=function(t,n,l){let i=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=a?.nonce||a?.getAttribute("nonce");i=Promise.allSettled(n.map(g=>{if(g=$l(g),g in en)return;en[g]=!0;const c=g.endsWith(".css"),f=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${g}"]${f}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":yl,c||(h.as="script"),h.crossOrigin="",h.href=g,o&&h.setAttribute("nonce",o),document.head.appendChild(h),c)return new Promise((m,b)=>{h.addEventListener("load",m),h.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${g}`)))})}))}function r(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return i.then(a=>{for(const o of a||[])o.status==="rejected"&&r(o.reason);return t().catch(r)})},xl=()=>({metadata:{version:"2.0.0",format_version:"1.0.0",created_at:new Date().toISOString(),last_modified:new Date().toISOString(),created_by:"jasper-designer-v2",tags:[],compatibility:{min_jasper_version:"2.0.0",jasperreports_version:"6.20.0"}},canvas:{width:595,height:842,unit:"pt",orientation:"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:!0,size:10,snap:!0,visible:!0},background:{color:"#ffffff"}},data_sources:[],elements:[],parameters:[],variables:[],groups:[]});class Nt{static toJasperTemplate(t,n){const l={...xl()},i={...l.metadata,...n,last_modified:new Date().toISOString()},r=this.convertCanvasConfig(t.canvas_config),a=t.elements.map(o=>this.convertReportElementToTemplateElement(o));return{...l,metadata:i,canvas:r,elements:a}}static convertCanvasConfig(t){return{width:t.width,height:t.height,unit:"pt",orientation:t.width>t.height?"landscape":"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:t.show_grid,size:t.grid_size,snap:t.snap_to_grid,visible:t.show_grid},background:{color:t.background_color}}}static convertReportElementToTemplateElement(t){const n=this.getElementType(t.content),l=this.convertElementContent(t.content),i=this.convertElementStyle(t.content);return{id:t.id,element_type:n,position:{x:t.position.x,y:t.position.y},size:{width:t.size.width,height:t.size.height},z_index:t.z_index,visible:t.visible,content:l,style:i,data_binding:this.extractDataBinding(t.content)}}static getElementType(t){switch(t.type){case"Text":return"Text";case"DataField":return"DataField";case"Rectangle":return"Rectangle";case"Line":return"Line";case"Image":return"Image";default:return"Text"}}static convertElementContent(t){switch(t.type){case"Text":return{text:t.content,font:this.convertTextStyleToFont(t.style),alignment:this.convertTextStyleToAlignment(t.style),color:t.style.color};case"DataField":return{expression:t.expression,format:t.format,font:this.convertTextStyleToFont(t.style),alignment:this.convertTextStyleToAlignment(t.style),color:t.style.color};case"Rectangle":return{color:t.fill_color};case"Line":return{color:t.color};case"Image":return{expression:t.src,text:t.alt};default:return{}}}static convertTextStyleToFont(t){return{family:t.font_family||"Arial",size:t.font_size||12,weight:this.mapFontWeight(t.font_weight),style:"normal"}}static convertTextStyleToAlignment(t){return{horizontal:this.mapTextAlign(t.align),vertical:"middle"}}static convertElementStyle(t){const n={};switch(t.type){case"Rectangle":t.fill_color&&(n.background={color:t.fill_color}),t.border&&(n.border={width:t.border.width,color:t.border.color,style:this.mapBorderStyle(t.border.style)});break;case"Text":case"DataField":t.style.background&&(n.background={color:t.style.background.color}),t.style.border&&(n.border={width:t.style.border.width,color:t.style.border.color,style:this.mapBorderStyle(t.style.border.style)});break}return n}static extractDataBinding(t){if(t.type==="DataField"&&t.data_source_id)return{source_id:t.data_source_id,field_name:this.extractFieldNameFromExpression(t.expression)}}static extractFieldNameFromExpression(t){return t.match(/^\{([^}]+)\}$/)?.[1]??t}static toAppState(t){const n=t.metadata.description||void 0;return{elements:t.elements.map(l=>this.convertTemplateElementToReportElement(l)),canvas_config:this.convertCanvasToCanvasConfig(t.canvas),selected_ids:[],can_undo:!1,can_redo:!1,dirty:!1,...n&&{template_name:n}}}static convertCanvasToCanvasConfig(t){return{width:t.width,height:t.height,zoom:1,offset_x:0,offset_y:0,show_grid:t.grid.enabled,show_rulers:!0,grid_size:t.grid.size,snap_to_grid:t.grid.snap,background_color:t.background.color}}static convertTemplateElementToReportElement(t){const n=this.convertTemplateContentToElementContent(t);return{id:t.id,position:{x:t.position.x,y:t.position.y},size:{width:t.size.width,height:t.size.height},content:n,z_index:t.z_index,visible:t.visible,locked:!1}}static convertTemplateContentToElementContent(t){switch(t.element_type){case"Text":return{type:"Text",content:t.content.text||"",style:this.convertTemplateStyleToTextStyle(t)};case"DataField":return{type:"DataField",expression:t.content.expression||"{data}",...t.content.format&&{format:t.content.format},style:this.convertTemplateStyleToTextStyle(t),...t.data_binding?.source_id&&{data_source_id:t.data_binding.source_id}};case"Rectangle":return{type:"Rectangle",...t.style?.background?.color&&{fill_color:t.style.background.color},...t.content.color&&!t.style?.background?.color&&{fill_color:t.content.color},...t.style?.border&&{border:{color:t.style.border.color,width:t.style.border.width,style:this.mapTemplateBorderStyle(t.style.border.style)}},corner_radius:0,opacity:1};case"Line":return{type:"Line",color:t.content.color||"#000000",width:1,line_style:"Solid",opacity:1};case"Image":return{type:"Image",src:t.content.expression||"",...t.content.text&&{alt:t.content.text}};default:return{type:"Text",content:"Unknown Element",style:this.createDefaultTextStyle()}}}static convertTemplateStyleToTextStyle(t){const n=t.content.font,l=t.content.alignment,i=t.style;return{font_family:n?.family||"Arial",font_size:n?.size||12,font_weight:this.mapTemplateFont(n?.weight),color:t.content.color||"#000000",align:this.mapTemplateAlignment(l?.horizontal),background:i?.background?{color:i.background.color||"",opacity:1,padding:0}:void 0,border:i?.border?{color:i.border.color,width:i.border.width,style:this.mapTemplateBorderStyle(i.border.style),radius:0}:void 0}}static createDefaultTextStyle(){return{font_family:"Arial",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}}static mapFontWeight(t){switch(t){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTemplateFont(t){switch(t){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTextAlign(t){switch(t){case"Center":return"center";case"Right":return"right";default:return"left"}}static mapTemplateAlignment(t){switch(t){case"center":return"Center";case"right":return"Right";default:return"Left"}}static mapBorderStyle(t){switch(t){case"Dashed":return"dashed";case"Dotted":return"dotted";default:return"solid"}}static mapTemplateBorderStyle(t){switch(t){case"dashed":return"Dashed";case"dotted":return"Dotted";default:return"Solid"}}}var Sl=v("<span class=text-warning>●"),wl=v("<span class=ml-2> 个元素"),Cl=v('<span class="ml-2 text-primary">已选择 <!> 个'),kl=v('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建模板 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开模板 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存模板 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class="toolbar-btn opacity-50 cursor-not-allowed"title="输出预览 - 即将推出 (PDF/打印预览功能)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>输出预览</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const Tl=e=>{const{state:t,undo:n,redo:l,updateCanvasConfig:i,setState:r}=Ge(),[a,o]=G(t.canvas_config.zoom*100),g=async()=>{try{const $=await Mt.createEmptyTemplate(),T=Nt.toAppState($);r(T),console.log("✅ 新建模板成功")}catch($){console.error("❌ 新建模板失败:",$),alert("新建模板失败")}},c=async()=>{try{const $=await bl({title:"打开模板文件",filters:[{name:"Jasper模板",extensions:["jasper","jbin","jrxml"]}],multiple:!1});if($&&typeof $=="string"){const T=await Mt.loadTemplate($),L=Nt.toAppState(T);r({...L,template_name:T.metadata.description||"未命名模板"}),console.log("✅ 模板加载成功:",$)}}catch($){console.error("❌ 加载模板失败:",$),alert("加载模板失败")}},f=async()=>{try{const $=await pl({title:"保存模板文件",filters:[{name:"Jasper模板",extensions:["jasper"]}],defaultPath:t.template_name||"未命名模板"});if($){const T=Nt.toJasperTemplate(t,{description:t.template_name||"未命名模板"});await Mt.saveTemplate(T,$),console.log("✅ 模板保存成功:",$)}}catch($){console.error("❌ 保存模板失败:",$),alert("保存模板失败")}},h=async $=>{const T=$/100;o($);try{await i({zoom:T})}catch(L){console.error("Failed to update zoom:",L)}},m=()=>{const $=Math.min(a()+25,500);h($)},b=()=>{const $=Math.max(a()-25,25);h($)},u=async()=>{try{await i({show_grid:!t.canvas_config.show_grid})}catch($){console.error("Failed to toggle grid:",$)}},y=async()=>{try{await i({show_rulers:!t.canvas_config.show_rulers})}catch($){console.error("Failed to toggle rulers:",$)}},_=async()=>{try{await re("toggle_devtools"),console.log("🔧 DevTools toggled")}catch($){console.error("Failed to toggle DevTools:",$)}};return(()=>{var $=kl(),T=$.firstChild,L=T.firstChild,E=L.nextSibling,k=E.nextSibling,R=k.nextSibling,M=R.nextSibling,U=M.nextSibling,O=T.nextSibling,p=O.firstChild,S=p.nextSibling,x=S.nextSibling,I=x.nextSibling,N=I.nextSibling,C=N.nextSibling,A=C.nextSibling,V=A.nextSibling,B=V.nextSibling,H=B.nextSibling,ee=H.nextSibling,W=O.nextSibling,J=W.firstChild;return L.$$click=g,E.$$click=c,k.$$click=f,s(T,d(cl,{}),M),M.$$click=()=>{console.log("🔄 数据源按钮被点击！"),e.onOpenDataSources()},U.$$click=()=>{alert(`📄 输出预览即将推出！

✨ 即将支持的功能：
• PDF格式预览
• 打印效果预览
• 分页显示
• 导出设置`)},U.disabled=!0,Te(p,"click",n),Te(S,"click",l),I.$$click=b,N.addEventListener("change",q=>{const oe=q.target.value;if(oe==="fit")console.log("Fit to window");else{const pe=parseInt(oe.replace("%",""));h(pe)}}),C.$$click=m,V.$$click=u,B.$$click=y,ee.$$click=_,s(W,d(z,{get when(){return t.dirty},get children(){return Sl()}}),J),s(J,()=>t.template_name||"未命名模板"),s(W,d(z,{get when(){return t.elements.length>0},get children(){var q=wl(),oe=q.firstChild;return s(q,()=>t.elements.length,oe),q}}),null),s(W,d(z,{get when(){return t.selected_ids.length>0},get children(){var q=Cl(),oe=q.firstChild,pe=oe.nextSibling;return pe.nextSibling,s(q,()=>t.selected_ids.length,pe),q}}),null),P(q=>{var oe=`toolbar-btn-icon ${t.can_undo?"":"opacity-50 cursor-not-allowed"}`,pe=!t.can_undo,he=`撤销${t.undo_description?` (${t.undo_description})`:""} (Ctrl+Z)`,te=`toolbar-btn-icon ${t.can_redo?"":"opacity-50 cursor-not-allowed"}`,ie=!t.can_redo,se=`重做${t.redo_description?` (${t.redo_description})`:""} (Ctrl+Y)`,de=`toolbar-btn-icon ${t.canvas_config.show_grid?"active":""}`,X=`toolbar-btn-icon ${t.canvas_config.show_rulers?"active":""}`;return oe!==q.e&&me(p,q.e=oe),pe!==q.t&&(p.disabled=q.t=pe),he!==q.a&&j(p,"title",q.a=he),te!==q.o&&me(S,q.o=te),ie!==q.i&&(S.disabled=q.i=ie),se!==q.n&&j(S,"title",q.n=se),de!==q.s&&me(V,q.s=de),X!==q.h&&me(B,q.h=X),q},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),P(()=>N.value=`${Math.round(a())}%`),$})()};De(["click"]);var El=v('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),Ll=v('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const tn=()=>{const{createElement:e}=Ge(),[t,n]=G(""),l=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:c?.text||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:c?.expression||"${fieldName}",format:c?.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:c?.fill_color||"transparent",border:{color:c?.border_color||"#000000",width:c?.border_width||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:c?.color||"#000000",width:c?.width||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:c?.src||"",alt:c?.alt||"图片"})}],i=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],r=[...l,...i],a=()=>{const c=t().toLowerCase();return c?r.filter(f=>f.name.toLowerCase().includes(c)||f.description.toLowerCase().includes(c)):r},o=(c,f)=>{if(console.log("Starting drag for component:",c.id),f.dataTransfer){f.dataTransfer.effectAllowed="copy",f.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const h=document.createElement("div");h.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,h.style.position="absolute",h.style.top="-1000px",document.body.appendChild(h),f.dataTransfer.setDragImage(h,50,20),setTimeout(()=>{document.body.removeChild(h)},0)}},g=async c=>{try{const f=await e(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",f)}catch(f){console.error("Failed to create element:",f)}};return(()=>{var c=El(),f=c.firstChild,h=f.firstChild,m=h.nextSibling,b=f.nextSibling,u=b.firstChild,y=u.firstChild,_=y.firstChild,$=_.nextSibling,T=y.nextSibling,L=T.firstChild,E=L.nextSibling,k=T.nextSibling,R=k.firstChild,M=R.nextSibling;return m.$$input=U=>n(U.target.value),s($,d(ae,{get each(){return a().filter(U=>U.category==="basic")},children:U=>d(It,{component:U,onDrag:O=>o(U,O),onClick:()=>g(U)})})),s(E,d(ae,{get each(){return a().filter(U=>U.category==="data")},children:U=>d(It,{component:U,onDrag:O=>o(U,O),onClick:()=>g(U)})})),s(M,d(ae,{get each(){return a().filter(U=>U.category==="bank")},children:U=>d(It,{component:U,onDrag:O=>o(U,O),onClick:()=>g(U)})})),P(()=>m.value=t()),c})()},It=e=>(()=>{var t=Ll(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(t,"click",e.onClick),t.addEventListener("dragstart",r=>e.onDrag(r)),j(t,"draggable",!0),s(l,()=>e.component.icon),s(i,()=>e.component.name),P(()=>j(t,"title",e.component.description)),t})();De(["input","click"]);class Se{static async listDataSources(){return re("list_data_sources")}static async deleteDataSource(t){return re("delete_data_source",{req:{sourceId:t}})}static async updateConfig(t,n){return re("update_data_source_config",{req:{sourceId:t,config:n}})}static async queryDataSource(t,n){return re("query_data_source",{req:{sourceId:t,query:n}})}static async getDataPreview(t,n){return re("get_data_preview",{req:{sourceId:t,limit:n}})}static async testConnection(t,n){return re("test_data_source_connection",{req:{providerType:t,config:n}})}static async discoverSchema(t,n){return re("discover_schema",{req:{providerType:t,config:n}})}static async testDatabaseConnection(t){return re("test_database_connection",{config:t})}static async loadDatabaseSchema(t){return re("load_database_schema",{config:t})}static async executeDatabasePreview(t,n,l){return re("execute_database_preview",{req:{config:t,sql:n,limit:l}})}static async validateSqlSyntax(t,n){if(console.log("🔍 验证SQL语法 - 参数:",{sql:t.length+" 字符",databaseType:n}),!t||t.trim().length===0)throw new Error("SQL不能为空");if(!n)throw console.error("❌ databaseType参数为空或未定义:",n),new Error("数据库类型不能为空");try{const l={sql:t,databaseType:n};return console.log("🔍 将传递给Rust的参数:",l),console.log("🔍 参数对象的键:",Object.keys(l)),console.log("🔍 参数JSON:",JSON.stringify(l)),await re("validate_sql_syntax",{req:l})}catch(l){throw console.error("❌ 调用失败:",l),l}}static async formatSql(t,n){return re("format_sql",{req:{sql:t,databaseType:n}})}static async saveDataSource(t){try{const n=t.config;console.log("🔍 saveDataSource 请求参数:",{name:t.name,selected_tables:t.selected_tables,selected_tables_type:typeof t.selected_tables,selected_tables_length:t.selected_tables?.length,sql_length:t.sql?.length});const l=t.selected_tables||[];console.log("🔍 实际传递的 selectedTables:",l);const i=await re("create_database_source",{req:{name:t.name,description:t.description||null,databaseType:n.database_type,host:n.host,port:n.port,database:n.database,username:n.username,password:n.password||null,sql:t.sql,selectedTables:l,tags:t.tags?t.tags:null}});return{success:!0,data_source_id:String(i),message:`数据源 "${t.name}" 创建成功`,warnings:[],errors:[]}}catch(n){return{success:!1,data_source_id:"",message:`保存数据源失败: ${n}`,warnings:[],errors:[String(n)]}}}static async createDataSource(t,n,l){return re("create_data_source",{req:{name:t,providerType:n,config:l}})}static async getPreview(t,n,l){return this.getDataPreview(t,l)}static async queryData(t,n){return this.queryDataSource(t,n||{})}static async evaluateExpression(t,n,l){return re("evaluate_expression",{req:{sourceId:t,expression:n,context:l}})}static async getAvailableTypes(){return re("get_available_data_source_types")}static async getSchema(t){return re("get_data_source_schema",{req:{sourceId:t}})}static async getConfigSchema(t){return re("get_config_schema",{req:{providerType:t}})}static async getDefaultConfig(t){return re("get_default_config",{req:{providerType:t}})}static async validateConfig(t,n){return re("validate_config",{req:{providerType:t,config:n}})}static async captureDataPreview(t,n){return this.executeDatabasePreview(t,n,50)}static async validateDataSourceBeforeSave(t){try{console.log("🔍 开始验证数据源保存前检查"),console.log("🔍 请求配置:",t.config),console.log("🔍 数据库类型:",t.config.database_type);const n=await this.testDatabaseConnection(t.config),l=await this.validateSqlSyntax(t.sql,t.config.database_type),i=await this.performSecurityCheck(t.config,t.sql);return{connection_valid:n.success,sql_valid:l.valid,security_passed:i.is_safe,performance_acceptable:!0,warnings:[...l.warnings||[],...i.warnings||[]],errors:[]}}catch(n){return{connection_valid:!1,sql_valid:!1,security_passed:!1,performance_acceptable:!1,warnings:[],errors:[String(n)]}}}static async performSecurityCheck(t,n){const l=[],i=[],r=[/drop\s+table/i,/truncate\s+table/i,/delete\s+from/i,/update\s+.*set/i,/insert\s+into/i,/alter\s+table/i];for(const a of r)if(a.test(n)){l.push("包含可能危险的SQL操作");break}return{is_safe:l.length===0,security_issues:l,warnings:i}}}class Dl{styles=new Map;elementStyleMap=new Map;observers=new Set;initialized=!1;constructor(){console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(t){throw console.error("❌ TextStyleManager 初始化失败:",t),t}}createStyle(t){const n=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,l={...t,id:n,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(n,l),this.notifyObservers("style-created",n),this.saveUserStyles(),console.log(`🎨 创建新样式: ${l.name} (${n})`),n}getStyle(t){return this.styles.get(t)||null}updateStyle(t,n){const l=this.styles.get(t);if(!l)return console.warn(`⚠️ 样式 ${t} 不存在`),!1;if(l.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${t}`),!1;const i={...l,style:{...l.style,...n},metadata:{...l.metadata,lastModified:new Date}};return this.styles.set(t,i),this.syncAllStyleInstances(t),this.saveUserStyles(),this.notifyObservers("style-updated",t),console.log(`🔄 样式已更新: ${l.name} (${t})`),!0}deleteStyle(t){const n=this.styles.get(t);if(!n)return!1;if(n.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${t}`),!1;const l=Array.from(this.elementStyleMap.entries()).filter(([i,r])=>r===t).map(([i,r])=>i);return l.length>0?(console.warn(`⚠️ 无法删除样式 ${t}，仍有 ${l.length} 个元素在使用`),!1):(this.styles.delete(t),this.saveUserStyles(),this.notifyObservers("style-deleted",t),console.log(`🗑️ 样式已删除: ${n.name} (${t})`),!0)}applyStyleToElement(t,n){const l=this.styles.get(n);if(!l)return{success:!1,elementId:t,styleId:n,appliedAt:new Date,error:`样式 ${n} 不存在`};try{const i=this.elementStyleMap.get(t);if(this.elementStyleMap.set(t,n),l.metadata.usageCount++,i&&i!==n){const r=this.styles.get(i);r&&(r.metadata.usageCount=Math.max(0,r.metadata.usageCount-1))}return this.applyStyleToDOM(t,l.style),this.notifyObservers("style-applied",{elementId:t,styleId:n}),console.log(`🎯 应用样式: ${l.name} → 元素 ${t}`),{success:!0,elementId:t,styleId:n,appliedAt:new Date}}catch(i){return console.error(`❌ 应用样式失败: ${i}`),{success:!1,elementId:t,styleId:n,appliedAt:new Date,error:i instanceof Error?i.message:String(i)}}}getElementStyleId(t){return this.elementStyleMap.get(t)||null}removeElementStyle(t){const n=this.elementStyleMap.get(t);if(n){this.elementStyleMap.delete(t);const l=this.styles.get(n);l&&(l.metadata.usageCount=Math.max(0,l.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${t}`)}}getStylesByCategory(t){const n=Array.from(this.styles.values());return(t?n.filter(i=>i.category===t):n).sort((i,r)=>i.metadata.isSystemStyle!==r.metadata.isSystemStyle?i.metadata.isSystemStyle?-1:1:r.metadata.usageCount-i.metadata.usageCount)}searchStyles(t,n){const l=this.getStylesByCategory(n),i=t.toLowerCase().trim();return i?l.filter(r=>r.name.toLowerCase().includes(i)||r.description.toLowerCase().includes(i)||r.metadata.tags.some(a=>a.toLowerCase().includes(i))):l}getStyleUsageStats(){const t=[];for(const[n,l]of this.styles){const i=Array.from(this.elementStyleMap.entries()).filter(([r,a])=>a===n).map(([r,a])=>r);t.push({styleId:n,usageCount:i.length,elements:i,lastUsed:l.metadata.lastModified})}return t.sort((n,l)=>l.usageCount-n.usageCount)}cleanupUnusedStyles(){const t=new Set(this.elementStyleMap.values()),n=[];for(const[l,i]of this.styles)!t.has(l)&&!i.metadata.isSystemStyle&&(this.styles.delete(l),n.push(l),console.log(`🧹 清理未使用样式: ${i.name} (${l})`));return n.length>0&&this.saveUserStyles(),n}exportStyles(t){const n=t?t.map(i=>this.styles.get(i)).filter(Boolean):Array.from(this.styles.values()),l=new Set(n.map(i=>i.category));return{version:"2.0.0",exportedAt:new Date,styles:n,metadata:{totalStyles:n.length,categories:Array.from(l),author:"user"}}}async importStyles(t){const n=[];for(const l of t.styles){if(Array.from(this.styles.values()).find(a=>a.name===l.name&&a.category===l.category)){console.warn(`⚠️ 跳过已存在的样式: ${l.name}`);continue}const r=this.createStyle({name:l.name,description:l.description,category:l.category,style:l.style,...l.inheritance&&{inheritance:l.inheritance}});n.push(r)}return console.log(`📦 导入完成，共导入 ${n.length} 个样式`),n}addObserver(t){this.observers.add(t)}removeObserver(t){this.observers.delete(t)}syncAllStyleInstances(t){const n=this.styles.get(t);if(!n)return;const l=[];for(const[i,r]of this.elementStyleMap)r===t&&(this.applyStyleToDOM(i,n.style),l.push(i));this.notifyObservers("styles-synced",{styleId:t,affectedElements:l}),console.log(`🔄 样式同步完成: ${t} → ${l.length} 个元素`)}applyStyleToDOM(t,n){console.log(`🎨 应用样式到DOM: 元素 ${t}`,{font_family:n.font_family,font_size:n.font_size,typography:n.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:t}=await _l(async()=>{const{BANK_TEXT_STYLES:n}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:n}},[]);for(const n of t)this.styles.set(n.id,n);console.log(`🏦 加载了 ${t.length} 个银行预设样式`)}catch(t){console.warn("⚠️ 加载系统样式失败:",t)}}async loadUserStyles(){try{const t=localStorage.getItem("jasper-text-styles");if(t){const n=JSON.parse(t);for(const l of n)l.metadata.createdAt=new Date(l.metadata.createdAt),l.metadata.lastModified=new Date(l.metadata.lastModified),this.styles.set(l.id,l);console.log(`👤 加载了 ${n.length} 个用户自定义样式`)}}catch(t){console.warn("⚠️ 加载用户样式失败:",t)}}saveUserStyles(){try{const t=Array.from(this.styles.values()).filter(n=>!n.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(t)),console.log(`💾 保存了 ${t.length} 个用户自定义样式`)}catch(t){console.error("❌ 保存用户样式失败:",t)}}notifyObservers(t,n){for(const l of this.observers)try{l.onStyleChange(t,n)}catch(i){console.error("❌ 观察者通知失败:",i)}}}const Oe=new Dl;class Pl{calculateUnifiedBounds(t,n,l){const i=this.calculateFontMetrics(n),r=this.measureTextContent(t,n,l.width),a=this.calculateContainerHeight(r,i,l.height),o=this.calculateTextPositioning(n,l,a,i),g={containerBounds:{x:0,y:0,width:l.width,height:a},contentBounds:r.bounds,fontMetrics:i,positioning:o};return r.wrappedLines&&(g.textLayout={wrappedLines:r.wrappedLines,isWrapped:!0,originalLineCount:t.split(`
`).length,wrappedLineCount:r.wrappedLines.length}),g}calculateFontMetrics(t){const n=t.font_size,l=1.2,i=.75,r=.25,a=n*i,o=n*r;return{fontSize:n,lineHeight:n*l,ascender:a,descender:o,baseline:a}}getCharacterWidth(t,n){const l=n.font_size,i=n.font_family,r=/[\u4e00-\u9fa5]/.test(t),a={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},o=i.toLowerCase();let g=a.default;for(const[f,h]of Object.entries(a))if(o.includes(f.toLowerCase())||f.toLowerCase().includes(o)){g=h;break}const c=r?g.chinese:g.english;return l*c}calculateTextWidth(t,n){let l=0;for(const i of t)i!==`
`&&(l+=this.getCharacterWidth(i,n));return l}measureTextContent(t,n,l=0){const i=t.split(`
`),r=i.length;let a=0;for(const c of i){const f=this.calculateTextWidth(c,n);a=Math.max(a,f)}if(l>0&&a>l)return this.calculateWrappedText(t,n,l);const o=l>0?Math.min(a,l):a,g=r*n.font_size*1.2;return{bounds:{x:0,y:0,width:o,height:g},lineCount:r,actualHeight:g}}calculateWrappedText(t,n,l){const i=this.getCharacterWidth("测",n);if(Math.floor(l/i)<1||l<i)return{bounds:{x:0,y:0,width:l,height:n.font_size*1.2},lineCount:1,actualHeight:n.font_size*1.2,wrappedLines:["..."]};const a=this.smartSegmentation(t);let o=[],g="",c=0;for(const h of a){const m=this.calculateTextWidth(h,n),b=c+m;if(b>l)if(g.trim())o.push(g.trim()),g=h,c=m;else{const{truncated:u,remaining:y}=this.forceTruncateSegment(h,l,n);o.push(u),g=y,c=this.calculateTextWidth(y,n)}else g+=h,c=b}g.trim()&&o.push(g.trim());const f=o.length*n.font_size*1.2;return{bounds:{x:0,y:0,width:l,height:f},lineCount:o.length,actualHeight:f,wrappedLines:o}}forceTruncateSegment(t,n,l){let i="",r=0,a=0;for(a=0;a<t.length;a++){const g=t[a];if(!g)break;const c=this.getCharacterWidth(g,l);if(r+c>n)break;i+=g,r+=c}const o=t.substring(a);return{truncated:i,remaining:o}}smartSegmentation(t){const n=[];let l="";for(let i=0;i<t.length;i++){const r=t[i];r&&(/[\u4e00-\u9fa5]/.test(r)?(l&&(n.push(l),l=""),n.push(r)):r===`
`?(l&&(n.push(l),l=""),n.push(`
`)):r===" "?l?(n.push(l+" "),l=""):n.push(" "):l+=r)}return l&&n.push(l),n.filter(i=>i.length>0)}calculateContainerHeight(t,n,l){const i=n.lineHeight*t.lineCount,r=n.ascender+n.descender,a=n.lineHeight,o=Math.max(i,r,a);return Math.max(o,l)}calculateTextPositioning(t,n,l,i){const r=this.calculateHorizontalAnchor(t.align,n.width),a=i.baseline,o=t.background?.padding||0,g=-o,c=-o;return{textAnchorX:r,textAnchorY:a,backgroundX:g,backgroundY:c}}calculateHorizontalAnchor(t,n){switch(t){case"Left":return 0;case"Center":return n/2;case"Right":return n;default:return 0}}getTextAnchor(t){switch(t){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(t,n){}}const lt=new Pl;class Rl{initialized=!1;constructor(){this.initialize()}async initialize(){if(!this.initialized)try{await Oe.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(t){console.error("❌ ProfessionalTextRenderer 初始化失败:",t)}}isElementUsingProfessionalStyle(t){return Oe.getElementStyleId(t)!==null}adaptLegacyTextStyle(t){return{...t,font_weight:t.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:t.color}}],effects:[]}}renderProfessionalText(t,n=!1){if(t.content.type!=="Text"&&t.content.type!=="DataField")return null;const l=Oe.getElementStyleId(t.id);let i;if(l){const o=Oe.getStyle(l);if(!o)return console.warn(`⚠️ 找不到样式定义: ${l}`),null;i=o.style,console.log(`🎨 使用专业样式渲染: ${o.name} (${l})`)}else{const o=t.content.type==="Text"||t.content.type==="DataField"?t.content.style:null;if(!o)return null;i=this.adaptLegacyTextStyle(o),console.log("🔄 适配传统样式到专业排版系统")}const r=this.calculateEnhancedBounds(t.content.type==="Text"?t.content.content:t.content.expression||"[数据字段]",i,t.size);return{element:this.createProfessionalTextElement(r,t.content.type==="Text"?t.content.content:t.content.expression||"[数据字段]",i,!1),bounds:r,style:i}}calculateEnhancedBounds(t,n,l){const i=lt.calculateUnifiedBounds(t,n,l),r=n.typography,a=this.calculateLetterSpacingEffect(t,r.letterSpacing),o=this.calculateLineHeightEffect(t,n.font_size,r.lineHeight),g=this.calculateParagraphSpacingEffect(t,r.paragraphSpacing);return{containerBounds:i.containerBounds,positioning:i.positioning,fontMetrics:i.fontMetrics,typography:{adjustedWidth:i.containerBounds.width+a.widthIncrease,adjustedHeight:i.containerBounds.height+o.heightIncrease+g.heightIncrease,letterSpacingData:a,lineHeightData:o,paragraphData:g}}}calculateLetterSpacingEffect(t,n){const l=t.split(`
`),i=l.reduce((a,o)=>a+o.length,0),r=Math.max(0,i-l.length);return{spacingValue:n,totalSpaces:r,widthIncrease:r*n,charPositions:[]}}calculateLineHeightEffect(t,n,l){const r=t.split(`
`).length,a=n*l,o=n*1.2,g=a-o;return{lineHeightRatio:l,actualLineHeight:a,lineCount:r,heightIncrease:g*Math.max(0,r-1),baselinePositions:[]}}calculateParagraphSpacingEffect(t,n){const i=t.split(`

`).length;return{spacing:n,paragraphCount:i,heightIncrease:n*Math.max(0,i-1),paragraphPositions:[]}}createProfessionalTextElement(t,n,l,i){const r=document.createElementNS("http://www.w3.org/2000/svg","g");return r.setAttribute("class","professional-text-container"),this.renderMultipleFills(r,t,l.fills),this.renderEffects(r,t,l.effects),this.renderTypographyText(r,t,n,l),this.renderTextDecorations(r,t,n,l.typography.decoration),r}renderMultipleFills(t,n,l){if(l&&l.length>0&&l[0].enabled){const i=l[0];i.type==="solid"&&i.solid&&console.log("🎨 应用纯色填充:",i.solid.color)}}renderEffects(t,n,l){if(!l||l.length===0)return;const i=document.createElementNS("http://www.w3.org/2000/svg","defs"),r=document.createElementNS("http://www.w3.org/2000/svg","filter"),a=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;r.id=a;for(const o of l)if(o.enabled&&o.type==="drop-shadow"&&o.dropShadow){const g=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");g.setAttribute("dx",o.dropShadow.offsetX.toString()),g.setAttribute("dy",o.dropShadow.offsetY.toString()),g.setAttribute("stdDeviation",o.dropShadow.blur.toString()),g.setAttribute("flood-color",o.dropShadow.color),g.setAttribute("flood-opacity",o.dropShadow.opacity.toString()),r.appendChild(g),console.log("✨ 应用投影效果")}r.children.length>0&&(i.appendChild(r),t.appendChild(i),t.setAttribute("filter",`url(#${a})`))}renderTypographyText(t,n,l,i){const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("font-family",i.font_family),r.setAttribute("font-size",i.font_size.toString()),r.setAttribute("font-weight",i.font_weight),r.setAttribute("fill",i.fills[0]?.solid?.color||i.color),r.setAttribute("text-anchor",this.getTextAnchor(i.align));const a=l.split(`
`),o=i.typography;a.forEach((g,c)=>{const f=document.createElementNS("http://www.w3.org/2000/svg","tspan");o.letterSpacing!==0&&f.setAttribute("letter-spacing",`${o.letterSpacing}px`);const h=n.positioning.textAnchorY+c*n.typography.lineHeightData.actualLineHeight;if(f.setAttribute("x",n.positioning.textAnchorX.toString()),f.setAttribute("y",h.toString()),c===0&&o.textIndent!==0){const m=n.positioning.textAnchorX+o.textIndent;f.setAttribute("x",m.toString())}o.textTransform&&o.textTransform!=="none"?f.textContent=this.applyTextTransform(g,o.textTransform):f.textContent=g,r.appendChild(f)}),t.appendChild(r)}renderTextDecorations(t,n,l,i){if(!i.underline&&!i.strikethrough&&!i.overline)return;const r=l.split(`
`),a=i.decorationColor||"#000000",o=i.decorationThickness||1,g=i.decorationStyle==="dashed"?"4,2":i.decorationStyle==="dotted"?"1,1":"none";r.forEach((c,f)=>{if(!c.trim())return;const h=n.positioning.textAnchorY+f*n.typography.lineHeightData.actualLineHeight,m=c.length*n.fontMetrics.fontSize*.6,b=n.positioning.textAnchorX,u=b+m;if(i.underline){const y=h+n.fontMetrics.fontSize*.1;this.createDecorationLine(t,b,y,u,y,a,o,g,"underline")}if(i.strikethrough){const y=h-n.fontMetrics.fontSize*.3;this.createDecorationLine(t,b,y,u,y,a,o,g,"strikethrough")}if(i.overline){const y=h-n.fontMetrics.fontSize*.8;this.createDecorationLine(t,b,y,u,y,a,o,g,"overline")}})}createDecorationLine(t,n,l,i,r,a,o,g,c){const f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",n.toString()),f.setAttribute("y1",l.toString()),f.setAttribute("x2",i.toString()),f.setAttribute("y2",r.toString()),f.setAttribute("stroke",a),f.setAttribute("stroke-width",o.toString()),f.setAttribute("stroke-dasharray",g),f.setAttribute("class",`text-decoration-${c}`),t.appendChild(f)}getTextAnchor(t){switch(t){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(t,n){switch(n){case"uppercase":return t.toUpperCase();case"lowercase":return t.toLowerCase();case"capitalize":return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();default:return t}}}const Al=new Rl;var zl=v("<button class=search-clear title=清除搜索>✕"),Ol=v('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),Ml=v("<button><span class=category-icon></span><span class=category-label>"),Nl=v("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),Il=v("<span class=usage-count>"),Fl=v("<button class=edit-button title=编辑样式>✏️"),Ul=v("<span class=system-badge title=系统预设样式>🔒"),ql=v("<div class=selection-indicator>✓");const Bl=e=>{const[t,n]=G("bank-special"),[l,i]=G(""),[r,a]=G([]);(async()=>{await Oe.initialize();const m=Oe.getStylesByCategory();a(m)})();const g=we(()=>{let m=r();t()&&(m=m.filter(u=>u.category===t()));const b=l().toLowerCase().trim();return b&&(m=m.filter(u=>u.name.toLowerCase().includes(b)||u.description.toLowerCase().includes(b)||u.metadata.tags.some(y=>y.toLowerCase().includes(b)))),m}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],f=m=>{console.log("🎯 选择样式:",m),e.onStyleSelect(m)},h=m=>{n(m),console.log("📂 切换分类:",m)};return(()=>{var m=Ol(),b=m.firstChild,u=b.nextSibling,y=u.firstChild,_=y.firstChild,$=_.nextSibling,T=u.nextSibling,L=T.firstChild,E=T.nextSibling,k=E.firstChild,R=k.firstChild;return s(b,d(ae,{each:c,children:M=>(()=>{var U=Ml(),O=U.firstChild,p=O.nextSibling;return U.$$click=()=>h(M.key),s(O,()=>M.icon),s(p,()=>M.label),P(S=>{var x=`category-button ${t()===M.key?"active":""}`,I=M.label;return x!==S.e&&me(U,S.e=x),I!==S.t&&j(U,"title",S.t=I),S},{e:void 0,t:void 0}),U})()})),$.$$input=M=>i(M.target.value),s(y,d(z,{get when(){return l()},get children(){var M=zl();return M.$$click=()=>i(""),M}}),null),s(T,d(ae,{get each(){return g()},children:M=>d(jl,{style:M,get selected(){return e.selectedStyleId===M.id},onClick:()=>f(M.id),onEdit:()=>e.onStyleEdit(M.id)})}),L),Te(L,"click",e.onStyleCreate),s(k,()=>g().length,R),s(k,(()=>{var M=be(()=>!!l());return()=>M()&&` (搜索: "${l()}")`})(),null),P(()=>$.value=l()),m})()},jl=e=>{const t=()=>{switch(e.style.category){case"bank-special":return e.style.id.includes("amount")?"¥123,456.78":e.style.id.includes("account")?"6222 0012 3456 7890":e.style.id.includes("institution")?e.style.name:e.style.id.includes("date")?"2025-08-19":e.style.name;case"heading":return e.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return e.style.name}},n=we(()=>{const r=e.style.style;return{fontFamily:r.font_family,fontSize:`${Math.min(r.font_size,14)}px`,fontWeight:r.font_weight,color:r.fills?.[0]?.solid?.color||r.color,textAlign:r.align.toLowerCase(),letterSpacing:`${r.typography?.letterSpacing||0}px`,textDecoration:r.typography?.decoration?.underline?"underline":r.typography?.decoration?.strikethrough?"line-through":"none"}}),l=r=>{r.preventDefault(),e.onClick()},i=r=>{r.preventDefault(),r.stopPropagation(),e.onEdit()};return(()=>{var r=Nl(),a=r.firstChild,o=a.nextSibling,g=o.firstChild,c=g.nextSibling,f=c.firstChild,h=o.nextSibling;return r.$$click=l,s(a,t),s(g,()=>e.style.name),s(f,()=>Ql(e.style.category)),s(c,(()=>{var m=be(()=>e.style.metadata.usageCount>0);return()=>m()&&(()=>{var b=Il();return s(b,()=>e.style.metadata.usageCount),P(()=>j(b,"title",`使用次数: ${e.style.metadata.usageCount}`)),b})()})(),null),s(h,(()=>{var m=be(()=>!e.style.metadata.isSystemStyle);return()=>m()&&(()=>{var b=Fl();return b.$$click=i,b})()})(),null),s(h,(()=>{var m=be(()=>!!e.style.metadata.isSystemStyle);return()=>m()&&Ul()})(),null),s(r,(()=>{var m=be(()=>!!e.selected);return()=>m()&&ql()})(),null),P(m=>{var b=`style-card ${e.selected?"selected":""} ${e.style.metadata.isSystemStyle?"system-style":"user-style"}`,u=n();return b!==m.e&&me(r,m.e=b),m.t=Vt(a,u,m.t),m},{e:void 0,t:void 0}),r})()};function Ql(e){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[e]||e}De(["input","click"]);var Hl=v("<button class=style-picker-toggle>"),Jl=v("<button class=style-reload-btn title=重新加载样式系统>🔄"),Vl=v("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),Wl=v("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),Gl=v("<div class=style-picker-panel>"),Kl=v("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),Yl=v("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),Xl=v('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),Zl=v("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),ei=v('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const nn=e=>{const[t,n]=G(null),[l,i]=G(!1),[r,a]=G([]),[o,g]=G(!1);Fe(async()=>{try{await Oe.initialize();const $=Oe.getElementStyleId(e.element.id);n($);const T=Oe.getStylesByCategory();a(T),g(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch($){console.error("❌ 专业文字属性面板初始化失败:",$)}});const c=we(()=>{const $=t();return $?Oe.getStyle($):null}),f=we(()=>e.element.content.type==="Text"||e.element.content.type==="DataField"),h=async $=>{try{const T=await Oe.applyStyleToElement(e.element.id,$);if(T.success){n($);const L=Oe.getStyle($);if(L){const E=m(L.style);e.onUpdate(e.element.id,"content",{...e.element.content,style:E})}console.log("✅ 样式应用成功:",T)}else console.error("❌ 样式应用失败:",T.error)}catch(T){console.error("❌ 样式选择处理失败:",T)}},m=$=>({font_family:$.font_family,font_size:$.font_size,font_weight:$.font_weight,color:$.fills?.[0]?.solid?.color||$.color,align:$.align}),b=()=>{console.log("🆕 创建新样式")},u=$=>{console.log("✏️ 编辑样式:",$)},y=()=>{i(!l())},_=()=>{t()&&(Oe.removeElementStyle(e.element.id),n(null),console.log("🗑️ 移除元素样式"))};return f()?(()=>{var $=Zl(),T=$.firstChild,L=T.firstChild,E=L.firstChild,k=E.nextSibling,R=k.nextSibling,M=L.nextSibling;return s(R,d(z,{get when(){return o()},get children(){var U=Hl();return U.$$click=y,s(U,()=>l()?"📝":"📚"),P(()=>j(U,"title",l()?"隐藏样式库":"显示样式库")),U}}),null),s(R,d(z,{get when(){return!o()},get children(){var U=Jl();return U.$$click=()=>window.location.reload(),U}}),null),s(M,d(z,{get when(){return!o()},get children(){var U=Vl(),O=U.firstChild,p=O.firstChild,S=p.nextSibling,x=S.nextSibling,I=x.firstChild;return I.$$click=async()=>{try{await Oe.initialize();const N=Oe.getStylesByCategory();a(N),g(!0),console.log("🔄 样式系统重新初始化成功")}catch(N){console.error("❌ 重新初始化失败:",N)}},U}}),null),s(M,d(z,{get when(){return o()},get children(){return[d(z,{get when(){return c()},children:U=>(()=>{var O=ei(),p=O.firstChild,S=p.firstChild,x=S.firstChild,I=x.nextSibling,N=S.nextSibling,C=N.firstChild,A=C.nextSibling;return s(x,()=>U().name),s(I,()=>ti(U().category)),C.$$click=()=>u(U().id),A.$$click=_,O})()}),d(z,{get when(){return!c()},get children(){var U=Wl(),O=U.firstChild,p=O.nextSibling;return O.$$click=y,p.$$click=b,U}}),d(z,{get when(){return l()},get children(){var U=Gl();return s(U,d(Bl,{get selectedStyleId(){return t()},onStyleSelect:h,onStyleCreate:b,onStyleEdit:u})),U}})]}}),null),s($,d(z,{get when(){return c()},get children(){return Kl()}}),null),s($,d(z,{get when(){return c()},get children(){return Yl()}}),null),s($,d(z,{get when(){return!1},get children(){var U=Xl(),O=U.firstChild,p=O.nextSibling,S=p.firstChild,x=S.firstChild,I=x.firstChild,N=I.nextSibling,C=x.nextSibling,A=C.firstChild,V=A.nextSibling,B=C.nextSibling,H=B.firstChild,ee=H.nextSibling,W=ee.firstChild,J=B.nextSibling,q=J.firstChild,oe=q.nextSibling;return s(N,()=>e.element.id),s(V,()=>t()||"无"),s(ee,()=>r().length,W),s(oe,()=>Al.isElementUsingProfessionalStyle(e.element.id)?"是":"否"),U}}),null),$})():null};function ti(e){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[e]||e}De(["click"]);var ni=v('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),li=v('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),ii=v("<span class=property-value>"),ri=v('<span class="property-value text-xs text-muted">'),Lt=v("<div class=space-y-2>"),ct=v("<input type=number class=property-input>"),si=v('<div class="grid grid-cols-2 gap-2">'),ln=v("<input type=checkbox class=property-checkbox>"),ai=v('<div class="p-4 space-y-4">'),rn=v("<div>"),oi=v("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),ci=v("<div class=property-field><label class=property-label>"),di=v("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),Rn=v('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),An=v("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),ui=v('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),zn=v("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),gi=v('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),On=v('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),Mn=v('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),hi=v('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),fi=v("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),sn=v("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),vi=v('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),mi=v("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),bi=v("<input type=text class=property-input placeholder=图片描述文字>"),pi=v("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),yi=v("<div class=space-y-3>"),$i=v("<img class=property-image>"),_i=v("<div class=property-loading>加载数据源..."),xi=v('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),Si=v('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),wi=v('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),Ci=v('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),ki=v("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),Ti=v("<div class=space-y-4>"),Ei=v("<select class=property-select><option value>选择数据源"),Li=v("<option> (<!>)"),Di=v('<div class=flex><input type=number class="property-input flex-1">'),Pi=v("<span class=property-unit>"),Ri=v('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),Ai=v("<div class=property-alignment-group>"),zi=v("<button>");const an=()=>{const{state:e,updateElement:t}=Ge(),n=we(()=>{const r=new Set(e.selected_ids);return e.elements.filter(a=>r.has(a.id))}),l=we(()=>n()[0]),i=async(r,a,o)=>{try{await t(r,{[a]:o})}catch(g){console.error("Failed to update element property:",g)}};return(()=>{var r=ni(),a=r.firstChild,o=a.nextSibling;return s(o,d(z,{get when(){return l()},get fallback(){return li()},get children(){return d(Oi,{get element(){return l()},onUpdate:i})}})),r})()},Oi=e=>{const t=(l,i)=>{const r={...e.element.position,[l]:i};e.onUpdate(e.element.id,"position",r)},n=(l,i)=>{const r={...e.element.size,[l]:Math.max(1,i)};e.onUpdate(e.element.id,"size",r)};return(()=>{var l=ai();return s(l,d(Je,{title:"元素信息",icon:"ℹ️",get children(){var i=Lt();return s(i,d(ye,{label:"类型",get children(){var r=ii();return s(r,()=>e.element.content.type),r}}),null),s(i,d(ye,{label:"ID",get children(){var r=ri();return s(r,()=>e.element.id),r}}),null),i}}),null),s(l,d(Je,{title:"位置和大小",icon:"📐",get children(){var i=si();return s(i,d(ye,{label:"X",get children(){var r=ct();return r.$$input=a=>t("x",parseFloat(a.target.value)||0),P(()=>r.value=e.element.position.x),r}}),null),s(i,d(ye,{label:"Y",get children(){var r=ct();return r.$$input=a=>t("y",parseFloat(a.target.value)||0),P(()=>r.value=e.element.position.y),r}}),null),s(i,d(ye,{label:"宽度",get children(){var r=ct();return r.$$input=a=>n("width",parseFloat(a.target.value)||1),P(()=>r.value=e.element.size.width),r}}),null),s(i,d(ye,{label:"高度",get children(){var r=ct();return r.$$input=a=>n("height",parseFloat(a.target.value)||1),P(()=>r.value=e.element.size.height),r}}),null),i}}),null),s(l,d(Je,{title:"状态",icon:"👁️",get children(){var i=Lt();return s(i,d(ye,{label:"可见",get children(){var r=ln();return r.addEventListener("change",a=>e.onUpdate(e.element.id,"visible",a.target.checked)),P(()=>r.checked=e.element.visible),r}}),null),s(i,d(ye,{label:"锁定",get children(){var r=ln();return r.addEventListener("change",a=>e.onUpdate(e.element.id,"locked",a.target.checked)),P(()=>r.checked=e.element.locked),r}}),null),s(i,d(ye,{label:"层级",get children(){var r=ct();return r.$$input=a=>e.onUpdate(e.element.id,"z_index",parseInt(a.target.value)||0),P(()=>r.value=e.element.z_index),r}}),null),i}}),null),s(l,d(wn,{get children(){return[d(Ke,{get when(){return e.element.content.type==="Text"&&e.element.content},children:i=>(()=>{var r=rn();return s(r,d(nn,{get element(){return e.element},get onUpdate(){return e.onUpdate}}),null),s(r,d(Mi,{get content(){return i()},onUpdate:a=>{console.log("Text content update:",a),e.onUpdate(e.element.id,"content",a)}}),null),r})()}),d(Ke,{get when(){return e.element.content.type==="Rectangle"&&e.element.content},children:i=>d(Ni,{get content(){return i()},onUpdate:r=>{console.log("Rectangle content update:",r),e.onUpdate(e.element.id,"content",r)}})}),d(Ke,{get when(){return e.element.content.type==="Line"&&e.element.content},children:i=>d(Ii,{get content(){return i()},onUpdate:r=>{console.log("Line content update:",r),e.onUpdate(e.element.id,"content",r)}})}),d(Ke,{get when(){return e.element.content.type==="Image"&&e.element.content},children:i=>d(Fi,{get content(){return i()},onUpdate:r=>{console.log("Image content update:",r),e.onUpdate(e.element.id,"content",r)}})}),d(Ke,{get when(){return e.element.content.type==="DataField"&&e.element.content},children:i=>(()=>{var r=rn();return s(r,d(nn,{get element(){return e.element},get onUpdate(){return e.onUpdate}}),null),s(r,d(Ui,{get content(){return i()},onUpdate:a=>{console.log("🔍 [PropertiesPanel] DataField content update 接收到:",{更新内容:a,元素ID:e.element.id,当前content:i(),更新前data_source_id:i().data_source_id}),e.onUpdate(e.element.id,"content",a),console.log("🔍 [PropertiesPanel] 已调用 props.onUpdate")}}),null),r})()})]}}),null),l})()},Je=e=>(()=>{var t=oi(),n=t.firstChild,l=n.firstChild,i=l.nextSibling,r=n.nextSibling;return s(l,()=>e.icon),s(i,()=>e.title),s(r,()=>e.children),t})(),ye=e=>(()=>{var t=ci(),n=t.firstChild;return s(n,()=>e.label),s(t,()=>e.children,null),t})(),Mi=e=>d(Je,{title:"文字样式",icon:"🔤",get children(){var t=On(),n=t.firstChild,l=n.nextSibling;return s(t,d(ye,{label:"内容",get children(){var i=di();return i.$$input=r=>e.onUpdate({content:r.target.value}),P(()=>i.value=e.content.content),i}}),n),s(n,d(ye,{label:"字体",get children(){var i=Rn();return i.addEventListener("change",r=>e.onUpdate({style:{...e.content.style,font_family:r.target.value}})),P(()=>i.value=e.content.style.font_family),i}}),null),s(n,d(ye,{label:"大小",get children(){return d(Qe,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:i=>e.onUpdate({style:{...e.content.style,font_size:i}})})}}),null),s(l,d(ye,{label:"字重",get children(){var i=An();return i.addEventListener("change",r=>e.onUpdate({style:{...e.content.style,font_weight:r.target.value}})),P(()=>i.value=e.content.style.font_weight),i}}),null),s(l,d(ye,{label:"对齐",get children(){return d(Nn,{get value(){return e.content.style.align},onUpdate:i=>e.onUpdate({style:{...e.content.style,align:i}})})}}),null),s(t,d(ye,{label:"颜色",get children(){return d(Ze,{get value(){return e.content.style.color},onUpdate:i=>e.onUpdate({style:{...e.content.style,color:i}})})}}),null),s(t,d(ye,{label:"背景",get children(){var i=ui(),r=i.firstChild;return s(i,d(Ze,{get value(){return e.content.style.background?.color||"transparent"},onUpdate:a=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,color:a}}})}),r),s(r,d(ye,{label:"透明度",get children(){return d(Qe,{get value(){return e.content.style.background?.opacity||1},min:0,max:1,step:.1,onUpdate:a=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,opacity:a}}})})}}),null),s(r,d(ye,{label:"内边距",get children(){return d(Qe,{get value(){return e.content.style.background?.padding||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>e.onUpdate({style:{...e.content.style,background:{...e.content.style.background,padding:a}}})})}}),null),i}}),null),s(t,d(ye,{label:"边框",get children(){var i=gi(),r=i.firstChild;return s(i,d(Ze,{get value(){return e.content.style.border?.color||"#000000"},onUpdate:a=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,color:a}}})}),r),s(r,d(ye,{label:"宽度",get children(){return d(Qe,{get value(){return e.content.style.border?.width||1},min:0,max:10,step:.5,unit:"px",onUpdate:a=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,width:a}}})})}}),null),s(r,d(ye,{label:"样式",get children(){var a=zn();return a.addEventListener("change",o=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,style:o.target.value}}})),P(()=>a.value=e.content.style.border?.style||"Solid"),a}}),null),s(r,d(ye,{label:"圆角",get children(){return d(Qe,{get value(){return e.content.style.border?.radius||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>e.onUpdate({style:{...e.content.style,border:{...e.content.style.border,radius:a}}})})}}),null),i}}),null),t}}),Ni=e=>d(Je,{title:"矩形样式",icon:"▭",get children(){var t=hi(),n=t.firstChild,l=n.firstChild;return s(t,d(ye,{label:"填充颜色",get children(){return d(Ze,{get value(){return e.content.fill_color||"#ffffff"},onUpdate:i=>e.onUpdate({fill_color:i})})}}),n),s(n,d(ye,{label:"边框",get children(){var i=Lt();return s(i,d(Ze,{get value(){return e.content.border?.color||"#000000"},onUpdate:r=>e.onUpdate({border:{...e.content.border,color:r}})})),i}}),l),s(l,d(ye,{label:"宽度",get children(){return d(Qe,{get value(){return e.content.border?.width||1},min:0,max:20,step:.5,unit:"px",onUpdate:i=>e.onUpdate({border:{...e.content.border,width:i}})})}}),null),s(l,d(ye,{label:"样式",get children(){var i=zn();return i.addEventListener("change",r=>e.onUpdate({border:{...e.content.border,style:r.target.value}})),P(()=>i.value=e.content.border?.style||"Solid"),i}}),null),s(t,d(ye,{label:"圆角半径",get children(){return d(Qe,{get value(){return e.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:i=>e.onUpdate({corner_radius:i})})}}),null),s(t,d(ye,{label:"透明度",get children(){var i=Mn(),r=i.firstChild,a=r.nextSibling,o=a.firstChild;return r.$$input=g=>e.onUpdate({opacity:parseFloat(g.target.value)/100}),s(a,()=>Math.round((e.content.opacity||1)*100),o),P(()=>r.value=(e.content.opacity||1)*100),i}}),null),t}}),Ii=e=>d(Je,{title:"线条样式",icon:"━",get children(){var t=vi(),n=t.firstChild;return s(t,d(ye,{label:"颜色",get children(){return d(Ze,{get value(){return e.content.color},onUpdate:l=>e.onUpdate({color:l})})}}),n),s(t,d(ye,{label:"宽度",get children(){return d(Qe,{get value(){return e.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:l=>e.onUpdate({width:l})})}}),n),s(t,d(ye,{label:"样式",get children(){var l=fi();return l.addEventListener("change",i=>e.onUpdate({line_style:i.target.value})),P(()=>l.value=e.content.line_style||"Solid"),l}}),n),s(n,d(ye,{label:"起点",get children(){var l=sn();return l.addEventListener("change",i=>e.onUpdate({start_cap:i.target.value})),P(()=>l.value=e.content.start_cap||"None"),l}}),null),s(n,d(ye,{label:"终点",get children(){var l=sn();return l.addEventListener("change",i=>e.onUpdate({end_cap:i.target.value})),P(()=>l.value=e.content.end_cap||"None"),l}}),null),s(t,d(ye,{label:"透明度",get children(){var l=Mn(),i=l.firstChild,r=i.nextSibling,a=r.firstChild;return i.$$input=o=>e.onUpdate({opacity:parseFloat(o.target.value)/100}),s(r,()=>Math.round((e.content.opacity||1)*100),a),P(()=>i.value=(e.content.opacity||1)*100),l}}),null),t}}),Fi=e=>d(Je,{title:"图片属性",icon:"🖼️",get children(){var t=yi();return s(t,d(ye,{label:"图片地址",get children(){var n=mi();return n.$$input=l=>e.onUpdate({src:l.target.value}),P(()=>n.value=e.content.src),n}}),null),s(t,d(ye,{label:"替代文本",get children(){var n=bi();return n.$$input=l=>e.onUpdate({alt:l.target.value}),P(()=>n.value=e.content.alt||""),n}}),null),s(t,d(ye,{label:"预览",get children(){var n=pi(),l=n.firstChild;return s(n,(()=>{var i=be(()=>!!e.content.src);return()=>i()?(()=>{var r=$i();return r.addEventListener("load",a=>{const o=a.target,g=o.nextElementSibling;o&&(o.style.display="block"),g&&(g.style.display="none")}),r.addEventListener("error",a=>{const o=a.target,g=o.nextElementSibling;o&&(o.style.display="none"),g&&(g.style.display="flex")}),P(a=>{var o=e.content.src,g=e.content.alt||"图片预览";return o!==a.e&&j(r,"src",a.e=o),g!==a.t&&j(r,"alt",a.t=g),a},{e:void 0,t:void 0}),r})():null})(),l),P(i=>(i=e.content.src?"none":"flex")!=null?l.style.setProperty("display",i):l.style.removeProperty("display")),n}}),null),t}}),Ui=e=>{const[t,n]=G([]),[l,i]=G(!1);vt(()=>{console.log("🔍 [DataFieldProperties] props.content 变化:",{data_source_id:e.content.data_source_id,expression:e.content.expression,完整content:e.content})}),Fe(async()=>{try{i(!0);const o=await Se.listDataSources();n(o)}catch(o){console.error("Failed to load data sources:",o)}finally{i(!1)}});const r=o=>{console.log("🔍 [DataField] handleDataSourceChange 触发:",{新值:o,当前值:e.content.data_source_id,是否为空:o==="",将要更新的值:o===""?void 0:o}),e.onUpdate({data_source_id:o===""?void 0:o}),console.log("🔍 [DataField] onUpdate 已调用，等待父组件更新"),setTimeout(()=>{console.log("🔍 [DataField] 更新后检查:",{更新后的值:e.content.data_source_id,是否更新成功:e.content.data_source_id===(o===""?void 0:o)})},100)},a=we(()=>e.content.data_source_id?t().find(o=>o.id===e.content.data_source_id):null);return(()=>{var o=Ti();return s(o,d(Je,{title:"数据源配置",icon:"🔗",get children(){var g=Lt();return s(g,d(ye,{label:"数据源",get children(){return d(z,{get when(){return l()},get fallback(){return(()=>{var c=Ei();return c.firstChild,c.$$input=f=>{console.log("🔍 [DataField] select onInput 事件触发:",f.currentTarget.value)},c.addEventListener("change",f=>{console.log("🔍 [DataField] select onChange 事件触发:",{target:f.target,currentTarget:f.currentTarget,value:f.currentTarget.value,selectedIndex:f.currentTarget.selectedIndex,selectedOption:f.currentTarget.options[f.currentTarget.selectedIndex]?.text}),r(f.currentTarget.value)}),s(c,d(ae,{get each(){return t()},children:f=>(console.log("🔍 [DataField] 渲染数据源选项:",{id:f.id,name:f.name,当前选中:e.content.data_source_id===f.id}),(()=>{var h=Li(),m=h.firstChild,b=m.nextSibling;return b.nextSibling,s(h,()=>f.name,m),s(h,()=>f.providerType||f.provider_type,b),P(()=>h.value=f.id),h})())}),null),P(()=>c.value=e.content.data_source_id||""),c})()},get children(){return _i()}})}}),null),s(g,d(z,{get when(){return a()},get children(){var c=xi(),f=c.firstChild,h=f.firstChild,m=h.firstChild,b=m.nextSibling,u=b.nextSibling,y=h.nextSibling,_=y.firstChild;_.nextSibling;var $=y.nextSibling,T=$.firstChild;return T.nextSibling,s(u,(()=>{var L=be(()=>a().status==="active");return()=>L()?"活跃":a().status==="error"?"错误":"禁用"})()),s(y,()=>a().providerType||a().provider_type,null),s($,()=>new Date(a().lastUpdated||a().last_updated).toLocaleString("zh-CN"),null),P(()=>me(u,a().status==="active"?"text-green-600":a().status==="error"?"text-red-600":"text-gray-600")),c}}),null),s(g,d(ye,{label:"表达式",get children(){var c=Si();return c.$$input=f=>e.onUpdate({expression:f.currentTarget.value}),c.disabled=!1,P(()=>c.value=e.content.expression||""),c}}),null),s(g,d(z,{get when(){return!e.content.expression||!e.content.expression.trim()},get children(){return wi()}}),null),s(g,d(z,{get when(){return e.content.expression&&!e.content.data_source_id},get children(){return Ci()}}),null),s(g,d(ye,{label:"格式",get children(){var c=ki();return c.addEventListener("change",f=>e.onUpdate({format:f.currentTarget.value==="default"?void 0:f.currentTarget.value})),P(()=>c.value=e.content.format||"default"),c}}),null),g}}),null),s(o,d(Je,{title:"字段样式",icon:"🎨",get children(){var g=On(),c=g.firstChild,f=c.nextSibling;return s(c,d(ye,{label:"字体",get children(){var h=Rn();return h.addEventListener("change",m=>e.onUpdate({style:{...e.content.style,font_family:m.currentTarget.value}})),P(()=>h.value=e.content.style.font_family),h}}),null),s(c,d(ye,{label:"大小",get children(){return d(Qe,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:h=>e.onUpdate({style:{...e.content.style,font_size:h}})})}}),null),s(f,d(ye,{label:"字重",get children(){var h=An();return h.addEventListener("change",m=>e.onUpdate({style:{...e.content.style,font_weight:m.currentTarget.value}})),P(()=>h.value=e.content.style.font_weight),h}}),null),s(f,d(ye,{label:"对齐",get children(){return d(Nn,{get value(){return e.content.style.align},onUpdate:h=>e.onUpdate({style:{...e.content.style,align:h}})})}}),null),s(g,d(ye,{label:"颜色",get children(){return d(Ze,{get value(){return e.content.style.color},onUpdate:h=>e.onUpdate({style:{...e.content.style,color:h}})})}}),null),g}}),null),o})()},Qe=e=>(()=>{var t=Di(),n=t.firstChild;return n.addEventListener("blur",l=>{const i=parseFloat(l.target.value)||e.value,r=Math.max(e.min||-1/0,Math.min(e.max||1/0,i));r!==i&&(l.target.value=r.toString(),e.onUpdate(r))}),n.$$input=l=>{const i=parseFloat(l.target.value);if(!isNaN(i)){const r=Math.max(e.min||-1/0,Math.min(e.max||1/0,i));e.onUpdate(r)}},s(t,(()=>{var l=be(()=>!!e.unit);return()=>l()&&(()=>{var i=Pi();return s(i,()=>e.unit),i})()})(),null),P(l=>{var i=e.min,r=e.max,a=e.step||1;return i!==l.e&&j(n,"min",l.e=i),r!==l.t&&j(n,"max",l.t=r),a!==l.a&&j(n,"step",l.a=a),l},{e:void 0,t:void 0,a:void 0}),P(()=>n.value=e.value),t})(),Ze=e=>(()=>{var t=Ri(),n=t.firstChild,l=n.firstChild,i=l.nextSibling,r=n.nextSibling;return l.$$input=a=>e.onUpdate(a.target.value),r.$$input=a=>{const o=a.target.value;(/^#[0-9A-Fa-f]{6}$/.test(o)||/^#[0-9A-Fa-f]{3}$/.test(o))&&e.onUpdate(o)},P(a=>(a=e.value)!=null?i.style.setProperty("background-color",a):i.style.removeProperty("background-color")),P(()=>l.value=e.value),P(()=>r.value=e.value),t})(),Nn=e=>{const t=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var n=Ai();return s(n,()=>t.map(l=>(()=>{var i=zi();return i.$$click=()=>e.onUpdate(l.value),s(i,()=>l.icon),P(r=>{var a=`property-alignment-btn ${e.value===l.value?"active":""}`,o=l.label;return a!==r.e&&me(i,r.e=a),o!==r.t&&j(i,"title",r.t=o),r},{e:void 0,t:void 0}),i})())),n})()};De(["input","click"]);var qi=v("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),Bi=v("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const ji=e=>d(z,{get when(){return e.config.show_grid},get children(){return[(()=>{var t=qi(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return P(r=>{var a=e.config.grid_size,o=e.config.grid_size,g=e.config.grid_size,c=e.config.grid_size,f=e.config.grid_size,h=e.config.grid_size,m=e.config.grid_size,b=e.config.grid_size;return a!==r.e&&j(n,"width",r.e=a),o!==r.t&&j(n,"height",r.t=o),g!==r.a&&j(l,"x1",r.a=g),c!==r.o&&j(l,"x2",r.o=c),f!==r.i&&j(l,"y2",r.i=f),h!==r.n&&j(i,"y1",r.n=h),m!==r.s&&j(i,"x2",r.s=m),b!==r.h&&j(i,"y2",r.h=b),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),t})(),(()=>{var t=Bi();return P(n=>{var l=e.config.width,i=e.config.height;return l!==n.e&&j(t,"width",n.e=l),i!==n.t&&j(t,"height",n.t=i),n},{e:void 0,t:void 0}),t})()]}});class Qi{expressionCache=new Map;maxCacheSize=1e3;async evaluateExpression(t,n){if(!t||!t.trim())return{success:!1,error:"表达式不能为空"};if(!n)return{success:!1,error:"没有可用的数据上下文"};try{const l=this.preprocessExpression(t),i=this.getCompiledExpression(l),r=await this.executeCompiledExpression(i,n);return{success:!0,value:r.value,type:this.inferValueType(r.value)}}catch(l){return{success:!1,error:l instanceof Error?l.message:String(l)}}}validateExpression(t,n){if(!t||!t.trim())return{valid:!1,error:"表达式不能为空"};try{const l=this.preprocessExpression(t),i=this.compileExpression(l);return this.staticValidation(i,n)}catch(l){return{valid:!1,error:l instanceof Error?l.message:"表达式格式错误"}}}getFieldSuggestions(t,n){if(!n)return[];const l=t.toLowerCase().replace(/[{}]/g,""),i=[];if(n.fields.forEach(r=>{r.name.toLowerCase().includes(l)&&i.push(`{${r.name}}`),r.displayName&&r.displayName.toLowerCase().includes(l)&&i.push(`{${r.name}}`)}),n.currentRecord.data){const r=this.getNestedFieldSuggestions(l,n.currentRecord.data,"");i.push(...r)}return Array.from(new Set(i)).sort((r,a)=>{const o=r.replace(/[{}]/g,""),g=a.replace(/[{}]/g,"");return o===l?-1:g===l?1:o.startsWith(l)?-1:g.startsWith(l)?1:o.localeCompare(g)}).slice(0,20)}preprocessExpression(t){let n=t.trim();return!n.startsWith("{")&&!n.endsWith("}")&&(n=`{${n}}`),n=n.replace(/^\{+/,"{").replace(/\}+$/,"}"),n}getCompiledExpression(t){let n=this.expressionCache.get(t);if(!n){if(n=this.compileExpression(t),this.expressionCache.size>=this.maxCacheSize){const l=this.expressionCache.keys().next().value;l&&this.expressionCache.delete(l)}this.expressionCache.set(t,n)}return n}compileExpression(t){const n=t.slice(1,-1),l=this.parsePath(n);return{original:t,path:l,type:this.determineExpressionType(l)}}parsePath(t){const n=[];let l="",i=!1;for(let r=0;r<t.length;r++){const a=t[r];if(a==="["&&!i)l&&(n.push({type:"field",value:l}),l=""),i=!0;else if(a==="]"&&i){const o=parseInt(l,10);if(isNaN(o))throw new Error(`无效的数组索引: ${l}`);n.push({type:"index",value:o}),l="",i=!1}else a==="."&&!i?l&&(n.push({type:"field",value:l}),l=""):l+=a}if(l){if(i)throw new Error("未闭合的数组索引");n.push({type:"field",value:l})}if(n.length===0)throw new Error("空的字段路径");return n}async executeCompiledExpression(t,n){let l=n.currentRecord.data;for(const i of t.path){if(l==null)throw new Error("无法访问 null/undefined 值的属性");if(i.type==="field"){if(typeof l!="object")throw new Error(`尝试访问非对象类型的字段: ${i.value}`);if(!(i.value in l))throw new Error(`字段不存在: ${i.value}`);l=l[i.value]}else if(i.type==="index"){if(!Array.isArray(l))throw new Error("尝试对非数组类型使用索引访问");const r=i.value;if(r<0||r>=l.length)throw new Error(`数组索引超出范围: ${r}`);l=l[r]}}return{value:l}}staticValidation(t,n){if(!n)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const l=[],i=t.path[0];if(i&&i.type==="field"){const a=i.value;if(!n.fields.some(g=>g.name===a)){const g=n.fields.filter(c=>c.name.toLowerCase().includes(a.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),a.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${a}`,suggestions:g}}}t.path.length>5&&l.push("表达式路径过深，可能影响性能");const r={valid:!0};return l.length>0&&(r.warnings=l),r}getNestedFieldSuggestions(t,n,l){const i=[];if(!n||typeof n!="object")return i;for(const r of Object.keys(n)){const a=l?`${l}.${r}`:r;a.toLowerCase().includes(t)&&i.push(`{${a}}`),l.split(".").length<3&&n[r]&&typeof n[r]=="object"&&i.push(...this.getNestedFieldSuggestions(t,n[r],a))}return i}inferValueType(t){return t==null?"object":typeof t=="string"?"string":typeof t=="number"?"number":typeof t=="boolean"?"boolean":t instanceof Date?"date":typeof t=="object"?"object":"string"}determineExpressionType(t){return t.length===1?"simple":t.length<=3&&t.every(n=>n.type==="field")?"nested":"complex"}levenshteinDistance(t,n){if(t.length===0)return n.length;if(n.length===0)return t.length;const l=new Array(n.length+1);for(let i=0;i<=n.length;i++)l[i]=new Array(t.length+1),l[i][0]=i;for(let i=0;i<=t.length;i++)l[0][i]=i;for(let i=1;i<=n.length;i++)for(let r=1;r<=t.length;r++){const a=t[r-1]===n[i-1]?0:1;l[i][r]=Math.min(l[i-1][r]+1,l[i][r-1]+1,l[i-1][r-1]+a)}return l[n.length][t.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const Ft=new Qi;class Hi{context=G(null);subscribers=[];constructor(){this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(t){try{const l=(await Se.listDataSources()).find(f=>f.id===t);if(!l)throw new Error(`数据源不存在: ${t}`);console.log("🔍 找到数据源:",l);const i=l.providerType||l.provider_type||l.type_name||"json";console.log("🔍 推断的 providerType:",i);let r={rows:[],totalCount:0},a={columns:[]},o=null;try{r=await Se.getPreview(t,void 0,1),console.log("🔍 预览数据:",r)}catch(f){console.warn("⚠️  获取数据预览失败，继续构建上下文:",f),o=f}try{a=await Se.getSchema(t),console.log("🔍 Schema信息:",a)}catch(f){console.warn("⚠️  获取Schema失败，继续构建上下文:",f),o||(o=f)}const g=Array.isArray(a.columns)?a.columns.map(f=>({name:f.name,displayName:f.description||f.name,type:this.mapDataType(f.data_type),nullable:!!f.nullable,sample:f.default_value})):[],c={dataSource:{id:t,type:this.inferDataSourceType(i),name:l.name,status:this.mapDataSourceStatus(l.status)},currentRecord:{index:0,total:r.totalCount??r.total_rows??r.total_count??0,data:r&&r.rows&&r.rows[0]?r.rows[0]:{}},fields:g,...o?{error:{type:"system",message:String(o),details:o}}:{}};console.log("✅ 创建新的数据上下文:",c),this.context[1](c);try{typeof window<"u"&&window.localStorage&&window.localStorage.setItem("jasper.activeDataSourceId",t)}catch(f){console.warn("无法持久化激活数据源ID:",f)}this.notifySubscribers(c)}catch(n){console.error("设置数据源失败:",n);let l="",i;try{const o=(await Se.listDataSources()).find(g=>g.id===t);o&&(l=o.name,i=o.providerType||o.provider_type||o.type_name)}catch{}const r={dataSource:{id:t,type:this.inferDataSourceType(i||"json"),name:l||"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:n instanceof Error?n.message:"数据源加载失败",details:n}};this.context[1](r),this.notifySubscribers(r)}}async navigateToRecord(t){const n=this.getCurrentContext();if(!n||t<0||t>=n.currentRecord.total)return!1;try{const l=await Se.queryData(n.dataSource.id,{limit:1,offset:t});if(l.rows.length===0)return!1;const i={...n,currentRecord:{...n.currentRecord,index:t,data:l.rows[0]}};return this.context[1](i),this.notifySubscribers(i),!0}catch(l){return console.error("导航到记录失败:",l),!1}}async navigateNext(){const t=this.getCurrentContext();return t?this.navigateToRecord(t.currentRecord.index+1):!1}async navigatePrevious(){const t=this.getCurrentContext();return t?this.navigateToRecord(t.currentRecord.index-1):!1}async evaluateExpression(t){const n=this.getCurrentContext();return await Ft.evaluateExpression(t,n)}validateExpression(t){const n=this.getCurrentContext(),l=Ft.validateExpression(t,n);return{valid:l.valid,...l.error&&{error:l.error},...l.suggestions&&{suggestions:l.suggestions}}}getFieldSuggestions(t){const n=this.getCurrentContext();return Ft.getFieldSuggestions(t,n)}subscribe(t){return this.subscribers.push(t),()=>{const n=this.subscribers.indexOf(t);n>-1&&this.subscribers.splice(n,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(t){this.subscribers.forEach(n=>{try{n(t)}catch(l){console.error("数据上下文订阅回调错误:",l)}})}inferDataSourceType(t){if(!t)return console.warn("providerType is undefined, defaulting to json"),"json";const n=t.toLowerCase();return n==="json"?"json":n==="excel"?"excel":n==="sql"?"sql":n==="xml"?"xml":n==="csv"?"csv":n.startsWith("database")?"sql":"json"}mapDataType(t){switch(t){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(t){if(!t)return console.warn("status is undefined, defaulting to empty"),"empty";switch(t.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${t}, defaulting to empty`),"empty"}}}const Ne=new Hi;var Ji=v("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),on=v("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),Vi=v("<svg><rect class=text-background-unified></svg>",!1,!0,!1),Wi=v("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),Gi=v("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),Ki=v("<svg><tspan class=text-line-original></svg>",!1,!0,!1),Yi=v("<svg><rect x=0 y=0></svg>",!1,!0,!1),Xi=v("<svg><line x1=0></svg>",!1,!0,!1),Zi=v("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),er=v('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),tr=v("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),nr=v("<svg><tspan dy=0></svg>",!1,!0,!1),lr=v("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),ir=v("<svg><g></svg>",!1,!0,!1);const rr=e=>{const{state:t}=Rt(),[n,l]=G("[数据字段]");vt(()=>{if(e.element.content.type==="DataField"){const a=e.element.content.expression||"",o=t().mode;Ot.shouldShowExpression(o)?l(a||"[数据字段]"):Ot.shouldEvaluateExpression(o)&&Ne.evaluateExpression(a).then(g=>{g.success?l(String(g.value||"")):l(`[错误: ${g.error}]`)}).catch(g=>{l(`[错误: ${g}]`)})}});const i=we(()=>{const{position:a}=e.element;return{transform:`translate(${a.x}px, ${a.y}px)`,opacity:e.element.visible?1:.5}}),r=()=>{const{content:a,size:o}=e.element;if(a.type==="Text"&&a.content&&a.style){const g=lt.calculateUnifiedBounds(a.content,a.style,o),c=lt.getTextAnchor(a.style.align);return(()=>{var f=Ji(),h=f.firstChild;return s(f,(()=>{var m=be(()=>!!e.selected);return()=>m()&&(()=>{var b=on();return P(u=>{var y=g.containerBounds.x,_=g.containerBounds.y,$=g.containerBounds.width,T=g.containerBounds.height;return y!==u.e&&j(b,"x",u.e=y),_!==u.t&&j(b,"y",u.t=_),$!==u.a&&j(b,"width",u.a=$),T!==u.o&&j(b,"height",u.o=T),u},{e:void 0,t:void 0,a:void 0,o:void 0}),b})()})(),h),s(f,(()=>{var m=be(()=>!!a.style.background);return()=>m()&&(()=>{var b=Vi();return P(u=>{var y=g.positioning.backgroundX,_=g.positioning.backgroundY,$=g.containerBounds.width+(a.style.background.padding||0)*2,T=g.containerBounds.height+(a.style.background.padding||0)*2,L=a.style.background.color,E=a.style.background.opacity||1,k=a.style.border?.radius||0,R=a.style.border?.radius||0;return y!==u.e&&j(b,"x",u.e=y),_!==u.t&&j(b,"y",u.t=_),$!==u.a&&j(b,"width",u.a=$),T!==u.o&&j(b,"height",u.o=T),L!==u.i&&j(b,"fill",u.i=L),E!==u.n&&j(b,"fill-opacity",u.n=E),k!==u.s&&j(b,"rx",u.s=k),R!==u.h&&j(b,"ry",u.h=R),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),b})()})(),h),s(f,(()=>{var m=be(()=>!!a.style.border);return()=>m()&&(()=>{var b=Wi();return P(u=>{var y=g.positioning.backgroundX,_=g.positioning.backgroundY,$=g.containerBounds.width+(a.style.background?.padding||0)*2,T=g.containerBounds.height+(a.style.background?.padding||0)*2,L=a.style.border.color,E=a.style.border.width,k=a.style.border.style==="Dashed"?"5,5":a.style.border.style==="Dotted"?"2,2":"none",R=a.style.border.radius||0,M=a.style.border.radius||0;return y!==u.e&&j(b,"x",u.e=y),_!==u.t&&j(b,"y",u.t=_),$!==u.a&&j(b,"width",u.a=$),T!==u.o&&j(b,"height",u.o=T),L!==u.i&&j(b,"stroke",u.i=L),E!==u.n&&j(b,"stroke-width",u.n=E),k!==u.s&&j(b,"stroke-dasharray",u.s=k),R!==u.h&&j(b,"rx",u.h=R),M!==u.r&&j(b,"ry",u.r=M),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),b})()})(),h),j(h,"text-anchor",c),s(h,(()=>{var m=be(()=>!!g.textLayout?.isWrapped);return()=>m()?g.textLayout.wrappedLines.map((b,u)=>(()=>{var y=Gi();return s(y,b),P(_=>{var $=g.positioning.textAnchorX,T=u===0?0:g.fontMetrics.lineHeight;return $!==_.e&&j(y,"x",_.e=$),T!==_.t&&j(y,"dy",_.t=T),_},{e:void 0,t:void 0}),y})()):a.content.split(`
`).map((b,u)=>(()=>{var y=Ki();return s(y,b),P(_=>{var $=g.positioning.textAnchorX,T=u===0?0:g.fontMetrics.lineHeight;return $!==_.e&&j(y,"x",_.e=$),T!==_.t&&j(y,"dy",_.t=T),_},{e:void 0,t:void 0}),y})())})()),P(m=>{var b=g.positioning.textAnchorX,u=g.positioning.textAnchorY,y=a.style.font_family,_=a.style.font_size.toString(),$=a.style.font_weight,T=a.style.color;return b!==m.e&&j(h,"x",m.e=b),u!==m.t&&j(h,"y",m.t=u),y!==m.a&&j(h,"font-family",m.a=y),_!==m.o&&j(h,"font-size",m.o=_),$!==m.i&&j(h,"font-weight",m.i=$),T!==m.n&&j(h,"fill",m.n=T),m},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),f})()}if(a.type==="Rectangle"){const g=a.opacity!==void 0?a.opacity:1,c=a.corner_radius||0;return(()=>{var f=Yi();return j(f,"rx",c),j(f,"ry",c),j(f,"fill-opacity",g),j(f,"stroke-opacity",g),P(h=>{var m=o.width,b=o.height,u=a.fill_color||"transparent",y=a.border?.color||"#000000",_=a.border?.width||1,$=a.border?.style==="Dashed"?"5,5":a.border?.style==="Dotted"?"2,2":"none";return m!==h.e&&j(f,"width",h.e=m),b!==h.t&&j(f,"height",h.t=b),u!==h.a&&j(f,"fill",h.a=u),y!==h.o&&j(f,"stroke",h.o=y),_!==h.i&&j(f,"stroke-width",h.i=_),$!==h.n&&j(f,"stroke-dasharray",h.n=$),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),f})()}if(a.type==="Line"){const g=a.opacity!==void 0?a.opacity:1,c=a.line_style||"Solid",f=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var h=Xi();return j(h,"stroke-opacity",g),j(h,"stroke-dasharray",f),P(m=>{var b=o.height/2,u=o.width,y=o.height/2,_=a.color,$=a.width;return b!==m.e&&j(h,"y1",m.e=b),u!==m.t&&j(h,"x2",m.t=u),y!==m.a&&j(h,"y2",m.a=y),_!==m.o&&j(h,"stroke",m.o=_),$!==m.i&&j(h,"stroke-width",m.i=$),m},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),h})()}if(a.type==="DataField"&&a.style){const g=n(),c=lt.calculateUnifiedBounds(g,a.style,o),f=lt.getTextAnchor(a.style.align);return(()=>{var h=Zi(),m=h.firstChild;return s(h,(()=>{var b=be(()=>!!e.selected);return()=>b()&&(()=>{var u=on();return P(y=>{var _=c.containerBounds.x,$=c.containerBounds.y,T=c.containerBounds.width,L=c.containerBounds.height;return _!==y.e&&j(u,"x",y.e=_),$!==y.t&&j(u,"y",y.t=$),T!==y.a&&j(u,"width",y.a=T),L!==y.o&&j(u,"height",y.o=L),y},{e:void 0,t:void 0,a:void 0,o:void 0}),u})()})(),m),s(h,(()=>{var b=be(()=>!!Ot.shouldShowExpression(t().mode));return()=>b()&&(()=>{var u=er(),y=u.firstChild,_=y.nextSibling;return P($=>{var T=c.containerBounds.x+c.containerBounds.width-8,L=c.containerBounds.y+8,E=c.containerBounds.x+c.containerBounds.width-8,k=c.containerBounds.y+8;return T!==$.e&&j(y,"cx",$.e=T),L!==$.t&&j(y,"cy",$.t=L),E!==$.a&&j(_,"x",$.a=E),k!==$.o&&j(_,"y",$.o=k),$},{e:void 0,t:void 0,a:void 0,o:void 0}),u})()})(),m),j(m,"text-anchor",f),s(m,(()=>{var b=be(()=>!!c.textLayout?.isWrapped);return()=>b()?c.textLayout.wrappedLines.map((u,y)=>(()=>{var _=tr();return s(_,u),P($=>{var T=c.positioning.textAnchorX,L=y===0?0:c.fontMetrics.lineHeight;return T!==$.e&&j(_,"x",$.e=T),L!==$.t&&j(_,"dy",$.t=L),$},{e:void 0,t:void 0}),_})()):(()=>{var u=nr();return s(u,g),P(()=>j(u,"x",c.positioning.textAnchorX)),u})()})()),P(b=>{var u=t().mode,y=c.positioning.textAnchorX,_=c.positioning.textAnchorY,$=a.style.font_family,T=a.style.font_size.toString(),L=a.style.font_weight,E=g.startsWith("[错误:")?"#ff4d4f":a.style.color,k=`datafield-content-unified ${t().mode}-mode`;return u!==b.e&&j(h,"data-preview-mode",b.e=u),y!==b.t&&j(m,"x",b.t=y),_!==b.a&&j(m,"y",b.a=_),$!==b.o&&j(m,"font-family",b.o=$),T!==b.i&&j(m,"font-size",b.i=T),L!==b.n&&j(m,"font-weight",b.n=L),E!==b.s&&j(m,"fill",b.s=E),k!==b.h&&j(m,"class",b.h=k),b},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),h})()}return(()=>{var g=lr();return P(c=>{var f=o.width,h=o.height;return f!==c.e&&j(g,"width",c.e=f),h!==c.t&&j(g,"height",c.t=h),c},{e:void 0,t:void 0}),g})()};return(()=>{var a=ir();return s(a,r),P(o=>{var g=`element ${e.selected&&e.element.content.type!=="Text"&&e.element.content.type!=="DataField"?"element-selected":""}`,c=i(),f=e.element.id,h=e.element.content.type;return g!==o.e&&j(a,"class",o.e=g),o.t=Vt(a,c,o.t),f!==o.a&&j(a,"data-element-id",o.a=f),h!==o.o&&j(a,"data-element-type",o.o=h),o},{e:void 0,t:void 0,a:void 0,o:void 0}),a})()};var sr=v("<svg><g class=resize-handles></svg>",!1,!0,!1),ar=v("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const or=e=>{const{updateElement:t,setResizeOperation:n}=Ge(),[l,i]=G(!1),[r,a]=G(null),[o,g]=G({x:0,y:0}),[c,f]=G({width:0,height:0}),[h,m]=G({x:0,y:0}),[b,u]=G({width:0,height:0}),[y,_]=G({x:0,y:0}),[$,T]=G(!1),L=we(()=>{const{position:p,size:S,content:x}=e.element,N=8/2;let C={x:p.x,y:p.y,width:S.width,height:S.height};if((x.type==="Text"||x.type==="DataField")&&x.style){const J=x.type==="Text"?x.content:x.expression||"[数据字段]",q=lt.calculateUnifiedBounds(J,x.style,S);C={x:p.x+q.containerBounds.x,y:p.y+q.containerBounds.y,width:q.containerBounds.width,height:q.containerBounds.height}}const A=C.x,V=C.y,B=C.x+C.width,H=C.y+C.height,ee=C.x+C.width/2,W=C.y+C.height/2;return[{position:"nw",cursor:"nw-resize",x:A-N,y:V-N},{position:"ne",cursor:"ne-resize",x:B-N,y:V-N},{position:"sw",cursor:"sw-resize",x:A-N,y:H-N},{position:"se",cursor:"se-resize",x:B-N,y:H-N},{position:"n",cursor:"n-resize",x:ee-N,y:V-N},{position:"s",cursor:"s-resize",x:ee-N,y:H-N},{position:"w",cursor:"w-resize",x:A-N,y:W-N},{position:"e",cursor:"e-resize",x:B-N,y:W-N}]}),E=(p,S,x,I=!1,N=!1)=>{const C=c(),A=h();let V=C.width,B=C.height,H=A.x,ee=A.y;switch(p){case"nw":V=C.width-S,B=C.height-x,H=A.x+S,ee=A.y+x;break;case"ne":V=C.width+S,B=C.height-x,ee=A.y+x;break;case"sw":V=C.width-S,B=C.height+x,H=A.x+S;break;case"se":V=C.width+S,B=C.height+x;break;case"n":B=C.height-x,ee=A.y+x;break;case"s":B=C.height+x;break;case"w":V=C.width-S,H=A.x+S;break;case"e":V=C.width+S;break}if(I&&(p==="nw"||p==="ne"||p==="sw"||p==="se")){const J=C.width/C.height;V/B>J?(V=B*J,(p==="nw"||p==="sw")&&(H=A.x+(C.width-V))):(B=V/J,(p==="nw"||p==="ne")&&(ee=A.y+(C.height-B)))}if(N){const J=A.x+C.width/2,q=A.y+C.height/2;H=J-V/2,ee=q-B/2}const W=20;return V=Math.max(W,V),B=Math.max(W,B),{size:{width:V,height:B},position:{x:H,y:ee}}},k=p=>(p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation(),!1),R=(p,S)=>{n(!0),document.addEventListener("click",k,{capture:!0}),i(!0),a(p),g({x:S.clientX,y:S.clientY}),f({width:e.element.size.width,height:e.element.size.height}),m({x:e.element.position.x,y:e.element.position.y}),u(e.element.size),_(e.element.position),T(!1),document.addEventListener("mousemove",U),document.addEventListener("mouseup",O),document.body.style.cursor=L().find(x=>x.position===p)?.cursor||"default"};let M=0;const U=p=>{if(!l())return;const S=r();if(!S)return;const x=o(),I=p.clientX-x.x,N=p.clientY-x.y,C=E(S,I,N,p.shiftKey,p.altKey);u(C.size),_(C.position),T(Math.abs(I)>2||Math.abs(N)>2);const A=Date.now();if(A-M>50)try{t(e.element.id,{size:C.size,position:C.position}),M=A}catch{}},O=()=>{if(!l()||!r())return;const S=()=>{document.removeEventListener("click",k,{capture:!0}),n(!1),i(!1),a(null),document.body.style.cursor="default",document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",O)};if($()){const x=b(),I=y();t(e.element.id,{size:x,position:I}).catch(N=>{t(e.element.id,{size:c(),position:h()}).catch(C=>{})})}S()};return rt(()=>{n(!1),document.removeEventListener("click",k,{capture:!0}),document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",O),document.body.style.cursor="default"}),(()=>{var p=sr();return s(p,()=>L().map(S=>(()=>{var x=ar(),I=x.firstChild,N=I.nextSibling;return N.addEventListener("mouseleave",C=>{l()||(document.body.style.cursor="default")}),N.addEventListener("mouseenter",C=>{l()||(document.body.style.cursor=S.cursor)}),N.$$mousedown=C=>{C.stopPropagation(),C.preventDefault(),R(S.position,C)},N.style.setProperty("pointer-events","all"),P(C=>{var A=S.x+4,V=S.y+4,B=S.x,H=S.y,ee=S.cursor;return A!==C.e&&j(I,"cx",C.e=A),V!==C.t&&j(I,"cy",C.t=V),B!==C.a&&j(N,"x",C.a=B),H!==C.o&&j(N,"y",C.o=H),ee!==C.i&&((C.i=ee)!=null?N.style.setProperty("cursor",ee):N.style.removeProperty("cursor")),C},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),x})())),p})()};De(["mousedown"]);var Ie=(e=>(e.IDLE="idle",e.HOVER="hover",e.SELECTING="selecting",e.DRAGGING="dragging",e))(Ie||{});const cr={dragThreshold:3,updateThrottle:16};var dr=v("<div tabindex=0>"),ur=v("<div>"),gr=v("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),hr=v("<div>拖拽: <!>个元素"),fr=v("<div>[<!>]");const vr=e=>{const{resizeOperation:t,setResizeOperation:n}=Ge(),l=cr;let i;const[r,a]=G(Ie.IDLE),[o,g]=G([]),[c,f]=G(null),[h,m]=G(null),[b,u]=G(null),y=(w,D)=>Math.sqrt(Math.pow(w.x-D.x,2)+Math.pow(w.y-D.y,2)),_=(w,D)=>w.length===D.length&&w.every((Q,F)=>Q===D[F]),$=()=>{u(null)},[T,L]=G(null);let E="default";const k=(w,D)=>{!i||E===w||(i.style.cursor=w,E=w)},R=(w,...D)=>{console.log(`🎯 [InteractionLayer] ${w}`,...D)},M=w=>{if(!i)return{x:0,y:0};const D=i.getBoundingClientRect();return{x:w.clientX-D.left,y:w.clientY-D.top}},U=(w,D)=>w.x>=D.position.x&&w.x<=D.position.x+D.size.width&&w.y>=D.position.y&&w.y<=D.position.y+D.size.height,O=w=>{const D=p(w);return D.length>0?D[0]??null:null},p=w=>{const D=e.getAllElements();return D.filter(F=>F&&F.visible&&U(w,F)).sort((F,K)=>{const le=F.z_index??D.indexOf(F);return(K.z_index??D.indexOf(K))-le})},S=w=>{const D=o();if(D.length===0)return null;const Q=e.getAllElements();for(const F of D){const K=Q.find(Ue=>Ue.id===F);if(!K||!K.visible)continue;const le=8,Z=le/2,$e=K.position.x,Ee=K.position.y,xe=K.position.x+K.size.width,Ae=K.position.y+K.size.height,Pe=K.position.x+K.size.width/2,qe=K.position.y+K.size.height/2,Ye=[{direction:"nw",cursor:"nw-resize",x:$e-Z,y:Ee-Z},{direction:"ne",cursor:"ne-resize",x:xe-Z,y:Ee-Z},{direction:"sw",cursor:"sw-resize",x:$e-Z,y:Ae-Z},{direction:"se",cursor:"se-resize",x:xe-Z,y:Ae-Z},{direction:"n",cursor:"n-resize",x:Pe-Z,y:Ee-Z},{direction:"s",cursor:"s-resize",x:Pe-Z,y:Ae-Z},{direction:"w",cursor:"w-resize",x:$e-Z,y:qe-Z},{direction:"e",cursor:"e-resize",x:xe-Z,y:qe-Z}];for(const Ue of Ye)if(w.x>=Ue.x&&w.x<Ue.x+le&&w.y>=Ue.y&&w.y<Ue.y+le)return{elementId:K.id,direction:Ue.direction,cursor:Ue.cursor}}return null},x=w=>e.getAllElements().filter(Q=>{if(!Q.visible)return!1;const F={x:Q.position.x,y:Q.position.y,width:Q.size.width,height:Q.size.height};return!(F.x>w.x+w.width||F.x+F.width<w.x||F.y>w.y+w.height||F.y+F.height<w.y)}),I=(w,D)=>{const Q=p(w);return R("重叠选择检测",{elementsCount:Q.length,isCtrlClick:D,elementIds:Q.map(F=>F.id)}),Q.length===0?null:Q.length===1?($(),Q[0]?.id||null):D?N(w,Q):($(),R("普通点击选中最上层",{elementId:Q[0]?.id}),Q[0]?.id||null)},N=(w,D)=>{const Q=b(),F=Date.now();if(R("循环选择开始",{hasContext:!!Q,elementIds:D.map(le=>le.id)}),!Q||y(w,Q.clickPoint)>5||F-Q.lastClickTime>3e3||!_(D.map(le=>le.id),Q.overlappingElements.map(le=>le.id))){const le=D.length>1?1:0;return u({clickPoint:w,overlappingElements:D,currentSelectedIndex:le,lastClickTime:F}),R("循环选择重置",{selectedIndex:le,selectedId:D[le]?.id,reason:Q?y(w,Q.clickPoint)>5?"position_changed":F-Q.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),C(le+1,D.length,w),D[le]?.id||null}else{const le=(Q.currentSelectedIndex+1)%D.length;return u({...Q,currentSelectedIndex:le,lastClickTime:F}),R("循环选择继续",{selectedIndex:le,selectedId:D[le]?.id}),C(le+1,D.length,w),D[le]?.id||null}},C=(w,D,Q)=>{const F=document.querySelector(".overlap-indicator");F?.parentNode&&F.parentNode.removeChild(F);const K=document.createElement("div");K.className="overlap-indicator",K.textContent=`${w}/${D}`,Object.assign(K.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${Q.x+10}px`,top:`${Q.y-20}px`}),document.body.appendChild(K),R("显示重叠指示器",{current:w,total:D,point:Q}),setTimeout(()=>{K.parentNode&&(K.parentNode.removeChild(K),R("移除重叠指示器"))},1500)},A=w=>{const D=M(w);if(T()){Y(D);return}if(r()===Ie.DRAGGING){de(D);return}if(r()===Ie.SELECTING){X(D);return}if(r()===Ie.IDLE&&c()&&!c()?.isDragging){he(D);return}r()===Ie.IDLE&&!c()&&!T()&&V(D)},V=w=>{const D=S(w);if(D){k(D.cursor);return}const Q=O(w);if(Q){const K=o().includes(Q.id)?"grab":"pointer";k(K);return}k("default")},B=w=>{const D=M(w),Q=S(D);if(Q){R("点击ResizeHandle",{elementId:Q.elementId,direction:Q.direction}),H(Q,D);return}if(t()){R("调整大小操作进行中，跳过交互处理");return}const F=I(D,w.ctrlKey);if(R("鼠标按下",{point:D,selectedElementId:F,currentMode:r(),isCtrlClick:w.ctrlKey}),F){const K=e.getAllElements().find(le=>le.id===F);K&&ee(K,D,w)}else W(D)},H=(w,D,Q)=>{const F=e.getAllElements().find(K=>K.id===w.elementId);F&&(R("开始resize操作",{elementId:w.elementId,direction:w.direction}),n(!0),L({elementId:w.elementId,handlePosition:w.direction,startPoint:D,initialSize:{width:F.size.width,height:F.size.height},initialPosition:{x:F.position.x,y:F.position.y},cursor:w.cursor}),k(w.cursor),R("resize状态已设置",T()))},ee=(w,D,Q)=>{const F=o().includes(w.id),K=o(),le=!!b();R("元素点击",{elementId:w.id,isSelected:F,currentlySelected:K,ctrlKey:Q.ctrlKey,shiftKey:Q.shiftKey,hasOverlapContext:le}),Q.ctrlKey&&!le?J(w.id):Q.shiftKey&&o().length>0?q(w.id):F?(R("点击已选中元素，准备拖拽",{selectedCount:K.length}),pe(K,D)):oe(w.id,D)},W=(w,D)=>{R("开始框选",{point:w}),g([]),e.onElementsSelect?.([]),$(),a(Ie.SELECTING),k("crosshair"),m({startPoint:w,currentPoint:w,selectedIds:[]})},J=w=>{const D=o(),Q=D.includes(w)?D.filter(F=>F!==w):[...D,w];R("切换选择",{elementId:w,newSelection:Q}),g(Q),e.onElementsSelect?.(Q)},q=w=>{const D=o();if(!D.includes(w)){const Q=[...D,w];R("添加到选择",{elementId:w,newSelection:Q}),g(Q),e.onElementsSelect?.(Q)}},oe=(w,D,Q)=>{R("选择并准备拖拽",{elementId:w,point:D}),g([w]),e.onElementsSelect?.([w]),pe([w],D)},pe=(w,D,Q)=>{R("准备拖拽操作",{elementIds:w,startPoint:D});const F=e.getAllElements(),K=new Map;w.forEach(le=>{const Z=F.find($e=>$e.id===le);Z&&K.set(le,{x:Z.position.x,y:Z.position.y})}),f({elementIds:w,startPoint:D,startPositions:K,currentOffset:{x:0,y:0},isDragging:!1})},he=w=>{const D=c();if(!D)return;const Q=Math.sqrt(Math.pow(w.x-D.startPoint.x,2)+Math.pow(w.y-D.startPoint.y,2));Q>l.dragThreshold&&(R("开始拖拽",{distance:Q,threshold:l.dragThreshold}),a(Ie.DRAGGING),k("grabbing"),f({...D,isDragging:!0}))};let te=!1,ie=0;const se=(w,D=!1)=>{if(D){w();return}Date.now()-ie>=l.updateThrottle&&!te&&(te=!0,requestAnimationFrame(()=>{w(),te=!1,ie=Date.now()}))},de=w=>{const D=c();if(!D)return;const Q={x:w.x-D.startPoint.x,y:w.y-D.startPoint.y};f({...D,currentOffset:Q}),se(()=>{if(e.onBatchUpdatePositions&&D.elementIds.length>1){const F=D.elementIds.map(K=>{const le=D.startPositions.get(K);return le?{element_id:K,new_position:{x:le.x+Q.x,y:le.y+Q.y}}:null}).filter(Boolean);F.length>0&&e.onBatchUpdatePositions(F).catch(()=>{})}else if(e.onElementMove){const F=D.elementIds.map(K=>{const le=D.startPositions.get(K);if(le)return e.onElementMove(K,{x:le.x+Q.x,y:le.y+Q.y})}).filter(Boolean);Promise.allSettled(F).catch(()=>{})}})},X=w=>{const D=h();if(!D)return;const Q={...D,currentPoint:w};m(Q);const F={x:Math.min(D.startPoint.x,w.x),y:Math.min(D.startPoint.y,w.y),width:Math.abs(w.x-D.startPoint.x),height:Math.abs(w.y-D.startPoint.y)},le=x(F).map(Z=>Z.id);m({...Q,selectedIds:le}),g(le)},Y=w=>{const D=T();if(!D)return;const Q=w.x-D.startPoint.x,F=w.y-D.startPoint.y,K=ce(D.handlePosition,Q,F,D.initialSize,D.initialPosition);se(()=>{e.onElementResize&&e.onElementResize(D.elementId,K.size,K.position)})},ce=(w,D,Q,F,K)=>{let le=F.width,Z=F.height,$e=K.x,Ee=K.y;switch(w){case"nw":le=F.width-D,Z=F.height-Q,$e=K.x+D,Ee=K.y+Q;break;case"ne":le=F.width+D,Z=F.height-Q,Ee=K.y+Q;break;case"sw":le=F.width-D,Z=F.height+Q,$e=K.x+D;break;case"se":le=F.width+D,Z=F.height+Q;break;case"n":Z=F.height-Q,Ee=K.y+Q;break;case"s":Z=F.height+Q;break;case"w":le=F.width-D,$e=K.x+D;break;case"e":le=F.width+D;break}const xe=10;return le=Math.max(xe,le),Z=Math.max(xe,Z),{size:{width:le,height:Z},position:{x:$e,y:Ee}}},fe=()=>{const w=r();if(R("鼠标释放",{currentMode:w,hasResizeState:!!T()}),T()){ve();return}w===Ie.DRAGGING?_e():w===Ie.SELECTING&&ge(),ne()},_e=()=>{const w=c();if(!w||!w.isDragging&&w.currentOffset.x===0&&w.currentOffset.y===0){R("拖拽完成，无实际移动");return}if(e.onBatchUpdatePositions&&w.elementIds.length>1){const D=w.elementIds.map(Q=>{const F=w.startPositions.get(Q);return F?{element_id:Q,new_position:{x:F.x+w.currentOffset.x,y:F.y+w.currentOffset.y}}:null}).filter(Boolean);D.length>0&&(R("拖拽完成 - 批量更新",{elementCount:D.length}),e.onBatchUpdatePositions(D).catch(Q=>{console.warn("批量更新最终位置失败:",Q)}))}},ge=()=>{const w=h();w&&(R("框选完成",{selectedCount:w.selectedIds.length}),e.onElementsSelect&&e.onElementsSelect(w.selectedIds))},ve=()=>{const w=T();w&&(R("完成resize操作",{elementId:w.elementId}),n(!1),L(null))},ne=()=>{a(Ie.IDLE),k("default"),f(null),m(null),L(null),n(!1),$(),R("状态重置完成")};Fe(async()=>{document.addEventListener("mousemove",A),document.addEventListener("mouseup",fe),R("修复版交互层已初始化")}),rt(()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",fe),R("修复版交互层已清理")});const ue=()=>{const w=h();if(!w||r()!==Ie.SELECTING)return null;const{startPoint:D,currentPoint:Q}=w;return{x:Math.min(D.x,Q.x),y:Math.min(D.y,Q.y),width:Math.abs(Q.x-D.x),height:Math.abs(Q.y-D.y)}};return(()=>{var w=dr();w.$$mousedown=B;var D=i;return typeof D=="function"?gt(D,w):i=w,w.style.setProperty("position","absolute"),w.style.setProperty("top","0"),w.style.setProperty("left","0"),w.style.setProperty("width","100%"),w.style.setProperty("height","100%"),w.style.setProperty("z-index","10"),w.style.setProperty("pointer-events","all"),w.style.setProperty("background","transparent"),w.style.setProperty("user-select","none"),s(w,(()=>{var Q=be(()=>!!ue());return()=>Q()&&(()=>{var F=ur();return F.style.setProperty("position","absolute"),F.style.setProperty("border","1px dashed #007acc"),F.style.setProperty("background","rgba(0, 122, 204, 0.1)"),F.style.setProperty("pointer-events","none"),P(K=>{var le=`${ue().x}px`,Z=`${ue().y}px`,$e=`${ue().width}px`,Ee=`${ue().height}px`;return le!==K.e&&((K.e=le)!=null?F.style.setProperty("left",le):F.style.removeProperty("left")),Z!==K.t&&((K.t=Z)!=null?F.style.setProperty("top",Z):F.style.removeProperty("top")),$e!==K.a&&((K.a=$e)!=null?F.style.setProperty("width",$e):F.style.removeProperty("width")),Ee!==K.o&&((K.o=Ee)!=null?F.style.setProperty("height",Ee):F.style.removeProperty("height")),K},{e:void 0,t:void 0,a:void 0,o:void 0}),F})()})(),null),s(w,(()=>{var Q=be(()=>!!e.enableDebugMode);return()=>Q()&&(()=>{var F=gr(),K=F.firstChild,le=K.nextSibling;le.firstChild;var Z=le.nextSibling;Z.firstChild;var $e=Z.nextSibling;return $e.firstChild,F.style.setProperty("position","fixed"),F.style.setProperty("top","10px"),F.style.setProperty("right","10px"),F.style.setProperty("padding","8px"),F.style.setProperty("background","rgba(0, 0, 0, 0.8)"),F.style.setProperty("color","white"),F.style.setProperty("font-family","monospace"),F.style.setProperty("font-size","12px"),F.style.setProperty("border-radius","4px"),F.style.setProperty("z-index","9999"),F.style.setProperty("pointer-events","none"),s(le,r,null),s(Z,()=>o().length,null),s($e,E,null),s(F,(()=>{var Ee=be(()=>!!c()?.isDragging);return()=>Ee()&&(()=>{var xe=hr(),Ae=xe.firstChild,Pe=Ae.nextSibling;return Pe.nextSibling,xe.style.setProperty("color","#ffeb3b"),s(xe,()=>c()?.elementIds.length,Pe),xe})()})(),null),s(F,(()=>{var Ee=be(()=>o().length>0);return()=>Ee()&&(()=>{var xe=fr(),Ae=xe.firstChild,Pe=Ae.nextSibling;return Pe.nextSibling,xe.style.setProperty("font-size","10px"),xe.style.setProperty("color","#ccc"),s(xe,()=>o().slice(0,3).join(", "),Pe),s(xe,()=>o().length>3&&"...",Pe),xe})()})(),null),F})()})(),null),w})()};De(["mousedown"]);var mr=v("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),br=v("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),pr=v('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),yr=v('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const $r=(e,t)=>{if(e.length<2)return[];const n=e.map(l=>({x:l.position.x,y:l.position.y,width:l.size.width,height:l.size.height}));return n.map((l,i)=>{let r=l.x,a=l.y;switch(t){case"left":r=Math.min(...n.map(h=>h.x));break;case"right":r=Math.max(...n.map(h=>h.x+h.width))-l.width;break;case"top":a=Math.min(...n.map(h=>h.y));break;case"bottom":a=Math.max(...n.map(h=>h.y+h.height))-l.height;break;case"h_center":r=n.reduce((h,m)=>h+m.x+m.width/2,0)/n.length-l.width/2;break;case"v_center":a=n.reduce((h,m)=>h+m.y+m.height/2,0)/n.length-l.height/2;break}return{element_id:e[i].id,new_position:{x:r,y:a}}})},_r=e=>{const{batchUpdatePositions:t,state:n}=Ge(),[l,i]=G(!1),r=()=>e.selectedElementIds().length>=2,a=()=>{const f=e.selectedElementIds();return n.elements.filter(h=>f.includes(h.id))},o=async f=>{const h=a();if(h.length<2){console.warn("对齐功能需要至少2个元素");return}try{i(!0),console.log(`🎯 执行${f}对齐:`,h.length,"个元素");const m=$r(h,f);await t(m),console.log("✅ 对齐操作完成"),e.onAlignmentComplete&&e.onAlignmentComplete(m)}catch(m){console.error("❌ 对齐操作失败:",m)}finally{i(!1)}},g=()=>a().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>g();return(()=>{var f=yr(),h=f.firstChild,m=h.firstChild,b=m.nextSibling,u=b.firstChild,y=u.nextSibling,_=y.nextSibling,$=h.nextSibling,T=$.firstChild,L=T.nextSibling,E=L.firstChild,k=E.nextSibling,R=k.nextSibling,M=$.nextSibling,U=M.firstChild,O=U.nextSibling,p=O.firstChild,S=p.nextSibling;return u.$$click=()=>o("left"),y.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("h_center")),y.$$click=()=>o("h_center"),_.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("right")),_.$$click=()=>o("right"),E.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("top")),E.$$click=()=>o("top"),k.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("v_center")),k.$$click=()=>o("v_center"),R.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("bottom")),R.$$click=()=>o("bottom"),p.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("distribute_h")),p.$$click=()=>o("distribute_h"),S.addEventListener("mouseenter",()=>e.onAlignmentPreview?.("distribute_v")),S.$$click=()=>o("distribute_v"),s(f,d(z,{get when(){return be(()=>!!r())()&&c()},get children(){var x=mr(),I=x.firstChild,N=I.nextSibling,C=N.firstChild,A=C.nextSibling,V=N.nextSibling;return N.$$click=()=>o(c().recommended),s(A,()=>c().recommended==="left"&&"左对齐",null),s(A,()=>c().recommended==="right"&&"右对齐",null),s(A,()=>c().recommended==="top"&&"顶对齐",null),s(A,()=>c().recommended==="bottom"&&"底对齐",null),s(A,()=>c().recommended==="h_center"&&"水平居中",null),s(A,()=>c().recommended==="v_center"&&"垂直居中",null),s(V,()=>c().reason),P(B=>{var H=l(),ee=c().reason;return H!==B.e&&(N.disabled=B.e=H),ee!==B.t&&j(N,"title",B.t=ee),B},{e:void 0,t:void 0}),x}}),null),s(f,d(z,{get when(){return!r()},get children(){var x=br(),I=x.firstChild;return I.firstChild,s(I,()=>e.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),x}}),null),s(f,d(z,{get when(){return l()},get children(){return pr()}}),null),P(x=>{var I=!r()||l(),N=!r()||l(),C=!r()||l(),A=!r()||l(),V=!r()||l(),B=!r()||l(),H=e.selectedElementIds().length<3||l(),ee=e.selectedElementIds().length<3||l();return I!==x.e&&(u.disabled=x.e=I),N!==x.t&&(y.disabled=x.t=N),C!==x.a&&(_.disabled=x.a=C),A!==x.o&&(E.disabled=x.o=A),V!==x.i&&(k.disabled=x.i=V),B!==x.n&&(R.disabled=x.n=B),H!==x.s&&(p.disabled=x.s=H),ee!==x.h&&(S.disabled=x.h=ee),x},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),f})()},xr=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const e=document.createElement("style");e.textContent=xr,document.head.appendChild(e)}De(["click"]);var Sr=v("<div>"),wr=v('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),Cr=v("<span class=ml-2>Zoom: <!>%");const cn=()=>{const{state:e,selectElement:t,clearSelection:n,createElement:l,selectMultiple:i,updateElement:r,batchUpdatePositions:a}=Ge();let o;const[g,c]=G([]),f=we(()=>e.elements.filter(L=>L.visible)),h=(L,E)=>{if(!o)return{x:0,y:0};const k=o.getBoundingClientRect(),R=(L-k.left)/e.canvas_config.zoom,M=(E-k.top)/e.canvas_config.zoom;return{x:R,y:M}},m=async L=>{console.log("🎯 选择元素",L),c([...L]);try{L.length===0?await n():L.length===1?await t(L[0]):await i([...L])}catch(E){console.error("❌ 选择元素失败:",E)}},b=async L=>{try{await a(L)}catch(E){console.error("❌ 批量更新位置失败:",E)}},u=async(L,E)=>{try{await r(L,{position:{x:E.x,y:E.y}})}catch(k){console.error("❌ 移动元素失败:",k)}},y=async(L,E,k)=>{try{await r(L,{size:E,position:k})}catch(R){console.error("❌ 调整大小失败:",R)}},_=async L=>{console.log("🖱️ 画布点击",L)},$=async L=>{L.preventDefault();try{const E=L.dataTransfer?.getData("application/json");if(!E)return;const{type:k,component:R}=JSON.parse(E);if(k==="component"){const{x:M,y:U}=h(L.clientX,L.clientY),O=Math.max(0,M-R.default_size.width/2),p=Math.max(0,U-R.default_size.height/2);console.log("🎯 通过拖放创建组件:",R.name,"at",O,p);const S=await l(R.id,{x:O,y:p},R.default_size,R.create_content());console.log("✅ 通过拖放创建元素成功:",S),c([S]),await t(S)}}catch(E){console.error("拖放处理失败:",E)}};Fe(()=>{c([...e.selected_ids])}),we(()=>{c([...e.selected_ids])});const T=we(()=>{const{width:L,height:E}=e.canvas_config;return`0 0 ${L} ${E}`});return(()=>{var L=wr(),E=L.firstChild,k=E.firstChild,R=k.firstChild,M=R.nextSibling,U=M.nextSibling,O=U.nextSibling,p=O.nextSibling,S=p.nextSibling,x=S.firstChild,I=x.nextSibling;I.nextSibling;var N=E.nextSibling,C=N.firstChild,A=C.firstChild,V=A.firstChild,B=V.firstChild,H=B.nextSibling,ee=H.nextSibling,W=ee.nextSibling;s(k,()=>e.canvas_config.width,M),s(k,()=>e.canvas_config.height,O),s(k,(()=>{var q=be(()=>e.canvas_config.zoom!==1);return()=>q()&&(()=>{var oe=Cr(),pe=oe.firstChild,he=pe.nextSibling;return he.nextSibling,s(oe,()=>Math.round(e.canvas_config.zoom*100),he),oe})()})(),S),s(S,()=>e.elements.length,I),s(S,()=>g().length,null),A.style.setProperty("position","relative"),V.addEventListener("drop",$),V.addEventListener("dragover",q=>{q.preventDefault(),q.dataTransfer.dropEffect="copy"}),V.$$contextmenu=q=>q.preventDefault();var J=o;return typeof J=="function"?gt(J,V):o=V,s(V,d(ji,{get config(){return e.canvas_config}}),H),s(ee,d(ae,{get each(){return f()},children:q=>d(rr,{element:q,get selected(){return g().includes(q.id)}})})),s(W,d(ae,{get each(){return f().filter(q=>g().includes(q.id))},children:q=>d(or,{element:q})})),s(A,d(vr,{canvasRef:o,getAllElements:()=>[...e.elements],onElementsSelect:m,onElementMove:u,onBatchUpdatePositions:b,onElementResize:y,onCanvasClick:_,get enableDebugMode(){return!1}}),null),s(A,d(z,{get when(){return g().length>=2},get children(){var q=Sr();return q.style.setProperty("position","fixed"),q.style.setProperty("top","80px"),q.style.setProperty("right","20px"),q.style.setProperty("z-index","1000"),q.style.setProperty("background","white"),q.style.setProperty("border-radius","8px"),q.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),q.style.setProperty("border","1px solid #e5e7eb"),s(q,d(_r,{selectedElementIds:g,onAlignmentComplete:oe=>{console.log("✅ 对齐操作完成:",oe)},onAlignmentPreview:oe=>{console.log("👁️ 对齐预览:",oe)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),q}}),null),P(q=>{var oe=e.canvas_config.width*e.canvas_config.zoom,pe=e.canvas_config.height*e.canvas_config.zoom,he=T(),te=e.canvas_config.width,ie=e.canvas_config.height,se=e.canvas_config.background_color,de=e.canvas_config.width,X=e.canvas_config.height;return oe!==q.e&&j(V,"width",q.e=oe),pe!==q.t&&j(V,"height",q.t=pe),he!==q.a&&j(V,"viewBox",q.a=he),te!==q.o&&j(B,"width",q.o=te),ie!==q.i&&j(B,"height",q.i=ie),se!==q.n&&j(B,"fill",q.n=se),de!==q.s&&j(H,"width",q.s=de),X!==q.h&&j(H,"height",q.h=X),q},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),L})()};De(["contextmenu"]);class nt{static async generatePreview(t){return await re("generate_preview",{request:t})}static async batchRender(t){return await re("batch_render",{request:t})}static async generateThumbnail(t,n,l){return await re("generate_thumbnail",{elements:t,width:n,height:l})}static async getSupportedFormats(){return await re("get_supported_formats")}static async getDefaultRenderOptions(t){return await re("get_default_render_options",{format:t})}static async validateRenderOptions(t){return await re("validate_render_options",{options:t})}static async getRenderStats(){return await re("get_render_stats")}static async clearRenderCache(){return await re("clear_render_cache")}static async exportToFile(t,n){return await re("export_to_file",{request:t,filePath:n})}static downloadResult(t,n){if(!t.data||!t.success)throw new Error("No data to download");const l=new Blob([t.data],{type:this.getMimeType(t.format)}),i=URL.createObjectURL(l),r=document.createElement("a");r.href=i,r.download=n,r.click(),URL.revokeObjectURL(i)}static getMimeType(t){return{pdf:"application/pdf",png:"image/png",jpg:"image/jpeg",webp:"image/webp",svg:"image/svg+xml",excel:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",powerpoint:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}[t]||"application/octet-stream"}}function kr(){const[e,t]=G({format:"pdf",quality:"high",useCache:!0}),[n,l]=G(null),[i,r]=G(!1),[a,o]=G(null),[g]=Gt(()=>nt.getRenderStats()),[c]=Gt(()=>nt.getSupportedFormats());return{renderOptions:e,renderResult:n,isRendering:i,renderError:a,stats:g,supportedFormats:c,setRenderOptions:t,setRenderError:o,setFormat:async u=>{try{const y=await nt.getDefaultRenderOptions(u);t(y)}catch(y){console.error("Failed to get default options:",y),t(_=>({..._,format:u}))}},render:async u=>{try{r(!0),o(null);const y=await nt.generatePreview({...u,options:e()});return l(y),y}catch(y){const _=y instanceof Error?y.message:"Unknown error";throw o(_),y}finally{r(!1)}},download:u=>{const y=n();if(!y)throw new Error("No render result to download");const _=`preview.${y.format}`;nt.downloadResult(y,u||_)},clearCache:async()=>{await nt.clearRenderCache()}}}var Tr=v('<button class="download-btn px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">📥 下载'),Er=v('<div class="preview-canvas-container h-full flex flex-col bg-tertiary"><div class="canvas-toolbar flex items-center justify-between px-4 py-2 bg-primary border-b border-default"><div class="toolbar-left flex items-center gap-2"><div class="fit-controls flex items-center gap-1"><button>适应</button><button>适宽</button><button>实际</button></div><div class="zoom-controls flex items-center gap-1"><button class="zoom-btn px-2 py-1 text-xs bg-secondary text-primary rounded hover:bg-tertiary">-</button><span class="zoom-display px-2 py-1 text-xs bg-tertiary text-primary rounded">%</span><button class="zoom-btn px-2 py-1 text-xs bg-secondary text-primary rounded hover:bg-tertiary">+</button></div></div><div class=toolbar-right></div></div><div class="canvas-area flex-1 overflow-hidden flex items-center justify-center p-4"><canvas class="preview-canvas shadow-lg"></canvas></div><div class="canvas-status px-4 py-2 bg-primary border-t border-default text-xs text-muted"><div class="flex justify-between items-center"><div>格式: <!> • 大小: <!>KB • 渲染: <!>ms</div><div>'),Lr=v("<span> × <!> ");const Dr=e=>{let t,n;const[l,i]=G(1),[r,a]=G(!1),[o,g]=G({x:0,y:0}),[c,f]=G({x:0,y:0}),[h,m]=G("fit");Fe(()=>{b()});const b=()=>{if(!n||!e.result?.data)return;const p=n.getContext("2d");if(p){switch(e.result.format){case"png":case"jpg":case"webp":u(p);break;case"pdf":y(p);break;case"svg":_(p);break;case"excel":case"powerpoint":$(p);break;default:T(p)}L()}},u=p=>{const S=new Image;S.onload=()=>{n&&(n.width=S.width,n.height=S.height,p.clearRect(0,0,S.width,S.height),p.drawImage(S,0,0))};const x=new Blob([e.result.data],{type:U(e.result.format)});S.src=URL.createObjectURL(x)},y=p=>{n&&(n.width=600,n.height=800,p.fillStyle="#ffffff",p.fillRect(0,0,600,800),p.fillStyle="#dc2626",p.font="48px sans-serif",p.textAlign="center",p.fillText("📄",300,200),p.fillStyle="#374151",p.font="24px sans-serif",p.fillText("PDF 文档",300,280),p.font="16px sans-serif",p.fillStyle="#6b7280",p.fillText(`大小: ${Math.round(e.result.fileSize/1024)}KB`,300,320),p.fillText(`页数: ${e.result.metadata.pageCount}`,300,350),p.fillText(`渲染时间: ${e.result.renderTimeMs}ms`,300,380),p.strokeStyle="#e5e7eb",p.lineWidth=2,p.strokeRect(50,50,500,700))},_=p=>{if(!(!e.result.data||!n))try{const S=new TextDecoder().decode(e.result.data),x=new Image;x.onload=()=>{n.width=x.width||800,n.height=x.height||600,p.clearRect(0,0,n.width,n.height),p.drawImage(x,0,0)};const I=new Blob([S],{type:"image/svg+xml"});x.src=URL.createObjectURL(I)}catch(S){console.error("SVG渲染失败:",S),T(p)}},$=p=>{if(!n)return;n.width=600,n.height=400,p.fillStyle="#ffffff",p.fillRect(0,0,600,400);const S=e.result.format==="excel"?"📊":"📋",x=e.result.format==="excel"?"Excel 工作表":"PowerPoint 演示文稿";p.fillStyle=e.result.format==="excel"?"#16a34a":"#dc2626",p.font="48px sans-serif",p.textAlign="center",p.fillText(S,300,150),p.fillStyle="#374151",p.font="24px sans-serif",p.fillText(x,300,200),p.font="16px sans-serif",p.fillStyle="#6b7280",p.fillText(`大小: ${Math.round(e.result.fileSize/1024)}KB`,300,240),p.strokeStyle="#e5e7eb",p.lineWidth=2,p.strokeRect(50,50,500,300)},T=p=>{n&&(n.width=400,n.height=300,p.fillStyle="#f9fafb",p.fillRect(0,0,400,300),p.fillStyle="#6b7280",p.font="48px sans-serif",p.textAlign="center",p.fillText("📄",200,120),p.font="18px sans-serif",p.fillStyle="#374151",p.fillText("预览不可用",200,160),p.font="14px sans-serif",p.fillStyle="#9ca3af",p.fillText("点击下载查看完整内容",200,190))},L=()=>{if(!t||!n)return;const p=t.getBoundingClientRect(),S=n.width,x=n.height;let I=1;switch(h()){case"fit":const N=(p.width-40)/S,C=(p.height-40)/x;I=Math.min(N,C,1);break;case"width":I=(p.width-40)/S;break;case"actual":I=1;break}i(Math.max(.1,Math.min(5,I))),f({x:0,y:0})},E=p=>{i(S=>Math.max(.1,Math.min(5,S+p)))},k=p=>{a(!0),g({x:p.clientX,y:p.clientY})},R=p=>{if(!r())return;const S=p.clientX-o().x,x=p.clientY-o().y;f(I=>({x:I.x+S,y:I.y+x})),g({x:p.clientX,y:p.clientY})},M=()=>{a(!1)},U=p=>({png:"image/png",jpg:"image/jpeg",webp:"image/webp",svg:"image/svg+xml",pdf:"application/pdf"})[p]||"application/octet-stream",O=()=>({transform:`scale(${l()}) translate(${c().x}px, ${c().y}px)`,cursor:r()?"grabbing":"grab","transform-origin":"center center"});return(()=>{var p=Er(),S=p.firstChild,x=S.firstChild,I=x.firstChild,N=I.firstChild,C=N.nextSibling,A=C.nextSibling,V=I.nextSibling,B=V.firstChild,H=B.nextSibling,ee=H.firstChild,W=H.nextSibling,J=x.nextSibling,q=S.nextSibling,oe=q.firstChild,pe=q.nextSibling,he=pe.firstChild,te=he.firstChild,ie=te.firstChild,se=ie.nextSibling,de=se.nextSibling,X=de.nextSibling,Y=X.nextSibling,ce=Y.nextSibling;ce.nextSibling;var fe=te.nextSibling;N.$$click=()=>m("fit"),C.$$click=()=>m("width"),A.$$click=()=>m("actual"),B.$$click=()=>E(-.1),s(H,()=>Math.round(l()*100),ee),W.$$click=()=>E(.1),s(J,d(z,{get when(){return e.onDownload},get children(){var ve=Tr();return ve.$$click=()=>e.onDownload?.(),ve}})),q.addEventListener("mouseleave",M),q.$$mouseup=M,q.$$mousemove=R,q.$$mousedown=k;var _e=t;typeof _e=="function"?gt(_e,q):t=q;var ge=n;return typeof ge=="function"?gt(ge,oe):n=oe,s(te,()=>e.result.format.toUpperCase(),se),s(te,()=>Math.round(e.result.fileSize/1024),X),s(te,()=>e.result.renderTimeMs,ce),s(fe,d(z,{get when(){return e.result.metadata.dimensions},children:ve=>(()=>{var ne=Lr(),ue=ne.firstChild,w=ue.nextSibling;return w.nextSibling,s(ne,()=>ve().width,ue),s(ne,()=>ve().height,w),s(ne,()=>ve().unit,null),ne})()})),P(ve=>{var ne=`fit-btn px-2 py-1 text-xs rounded ${h()==="fit"?"bg-blue-500 text-white":"bg-secondary text-primary"}`,ue=`fit-btn px-2 py-1 text-xs rounded ${h()==="width"?"bg-blue-500 text-white":"bg-secondary text-primary"}`,w=`fit-btn px-2 py-1 text-xs rounded ${h()==="actual"?"bg-blue-500 text-white":"bg-secondary text-primary"}`,D=O();return ne!==ve.e&&me(N,ve.e=ne),ue!==ve.t&&me(C,ve.t=ue),w!==ve.a&&me(A,ve.a=w),ve.o=Vt(oe,D,ve.o),ve},{e:void 0,t:void 0,a:void 0,o:void 0}),p})()};De(["click","mousedown","mousemove","mouseup"]);var Pr=v('<div class="pdf-options space-y-2"><h4 class="text-sm font-medium text-secondary">PDF 选项</h4><div class=option-item><label class="flex items-center gap-2 text-sm"><input type=checkbox class=rounded>嵌入字体</label></div><div class=option-item><label class="flex items-center gap-2 text-sm"><input type=checkbox class=rounded>压缩图片'),Rr=v('<div class="image-options space-y-2"><h4 class="text-sm font-medium text-secondary">图片选项</h4><div class=option-item><label class="block text-sm">DPI:<input type=number min=72 max=300 class="mt-1 w-full px-2 py-1 border border-default rounded bg-secondary text-primary"></label></div><div class=option-item><label class="block text-sm">压缩质量:<input type=range min=0 max=1 step=0.1 class="mt-1 w-full"><span class="text-xs text-muted">%'),Ar=v('<div class="excel-options space-y-2"><h4 class="text-sm font-medium text-secondary">Excel 选项</h4><div class=option-item><label class="block text-sm">工作表名:<input type=text class="mt-1 w-full px-2 py-1 border border-default rounded bg-secondary text-primary"></label></div><div class=option-item><label class="flex items-center gap-2 text-sm"><input type=checkbox class=rounded>包含格式</label></div><div class=option-item><label class="flex items-center gap-2 text-sm"><input type=checkbox class=rounded>自动调整列宽'),zr=v('<div class="advanced-options mt-4 pt-4 border-t border-default"><div class="options-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">'),Or=v('<div class="preview-controls bg-primary border-b border-default p-4"><div class="controls-container flex flex-wrap items-center gap-4"><div class="format-selector flex items-center gap-2"><label class="text-sm font-medium text-secondary">格式:</label><select class="px-3 py-1 border border-default rounded bg-secondary text-primary focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div><div class="quality-selector flex items-center gap-2"><label class="text-sm font-medium text-secondary">质量:</label><select class="px-3 py-1 border border-default rounded bg-secondary text-primary focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div><div class="auto-preview-toggle flex items-center gap-2"><label class="text-sm font-medium text-secondary">自动预览:</label><button></button></div><div class="action-buttons flex items-center gap-2"><button class="refresh-btn px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"></button><button class="download-btn px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">📥 下载</button><button class="advanced-toggle px-3 py-2 bg-secondary text-primary border border-default rounded hover:bg-tertiary transition-colors">'),Mr=v("<option> "),Nr=v("<option>"),Ir=v('<div class="stats-display flex items-center gap-4 text-sm text-muted"><span>渲染次数: </span><span>缓存命中: <!>%</span><span>平均耗时: <!>ms');const Fr=e=>{const[t,n]=G(!1),l=()=>[{value:"pdf",label:"PDF",icon:"📄"},{value:"png",label:"PNG",icon:"🖼️"},{value:"jpg",label:"JPEG",icon:"📷"},{value:"webp",label:"WebP",icon:"🖼️"},{value:"svg",label:"SVG",icon:"🎨"},{value:"excel",label:"Excel",icon:"📊"},{value:"powerpoint",label:"PPT",icon:"📋"}].filter(a=>!e.supportedFormats||e.supportedFormats.includes(a.value)),i=[{value:"draft",label:"草稿"},{value:"standard",label:"标准"},{value:"high",label:"高质量"},{value:"print",label:"印刷质量"}],r=a=>{e.onOptionsChange({...e.renderOptions,...a})};return(()=>{var a=Or(),o=a.firstChild,g=o.firstChild,c=g.firstChild,f=c.nextSibling,h=g.nextSibling,m=h.firstChild,b=m.nextSibling,u=h.nextSibling,y=u.firstChild,_=y.nextSibling,$=u.nextSibling,T=$.firstChild,L=T.nextSibling,E=L.nextSibling;return f.addEventListener("change",k=>e.onFormatChange(k.target.value)),s(f,d(ae,{get each(){return l()},children:k=>(()=>{var R=Mr(),M=R.firstChild;return s(R,()=>k.icon,M),s(R,()=>k.label,null),P(()=>R.value=k.value),R})()})),b.addEventListener("change",k=>r({quality:k.target.value})),s(b,d(ae,{each:i,children:k=>(()=>{var R=Nr();return s(R,()=>k.label),P(()=>R.value=k.value),R})()})),_.$$click=()=>e.onAutoPreviewChange(!e.autoPreview),s(_,()=>e.autoPreview?"开启":"关闭"),Te(T,"click",e.onRefresh),s(T,()=>e.isRendering?"渲染中...":"🔄 刷新"),Te(L,"click",e.onDownload),E.$$click=()=>n(!t()),s(E,()=>t()?"收起":"高级"),s(o,d(z,{get when(){return e.stats},children:k=>(()=>{var R=Ir(),M=R.firstChild;M.firstChild;var U=M.nextSibling,O=U.firstChild,p=O.nextSibling;p.nextSibling;var S=U.nextSibling,x=S.firstChild,I=x.nextSibling;return I.nextSibling,s(M,()=>k().totalRenders,null),s(U,()=>Math.round(k().cacheHits/Math.max(k().totalRenders,1)*100),p),s(S,()=>Math.round(k().averageRenderTimeMs),I),R})()}),null),s(a,d(z,{get when(){return t()},get children(){var k=zr(),R=k.firstChild;return s(R,d(z,{get when(){return e.renderOptions.format==="pdf"},get children(){var M=Pr(),U=M.firstChild,O=U.nextSibling,p=O.firstChild,S=p.firstChild,x=O.nextSibling,I=x.firstChild,N=I.firstChild;return S.addEventListener("change",C=>r({pdfOptions:{pageSize:"a4",orientation:"portrait",margins:{top:20,right:20,bottom:20,left:20},embedFonts:C.target.checked,compressImages:!0,pdfVersion:"1.7",...e.renderOptions.pdfOptions}})),N.addEventListener("change",C=>r({pdfOptions:{pageSize:"a4",orientation:"portrait",margins:{top:20,right:20,bottom:20,left:20},embedFonts:!0,pdfVersion:"1.7",...e.renderOptions.pdfOptions,compressImages:C.target.checked}})),P(()=>S.checked=e.renderOptions.pdfOptions?.embedFonts??!0),P(()=>N.checked=e.renderOptions.pdfOptions?.compressImages??!0),M}}),null),s(R,d(z,{get when(){return["png","jpg","webp"].includes(e.renderOptions.format)},get children(){var M=Rr(),U=M.firstChild,O=U.nextSibling,p=O.firstChild,S=p.firstChild,x=S.nextSibling,I=O.nextSibling,N=I.firstChild,C=N.firstChild,A=C.nextSibling,V=A.nextSibling,B=V.firstChild;return x.addEventListener("change",H=>r({imageQuality:{dpi:parseInt(H.target.value),compression:.9,colorSpace:"srgb",antiAliasing:!0,...e.renderOptions.imageQuality}})),A.addEventListener("change",H=>r({imageQuality:{dpi:150,colorSpace:"srgb",antiAliasing:!0,...e.renderOptions.imageQuality,compression:parseFloat(H.target.value)}})),s(V,()=>Math.round((e.renderOptions.imageQuality?.compression??.9)*100),B),P(()=>x.value=e.renderOptions.imageQuality?.dpi??150),P(()=>A.value=e.renderOptions.imageQuality?.compression??.9),M}}),null),s(R,d(z,{get when(){return e.renderOptions.format==="excel"},get children(){var M=Ar(),U=M.firstChild,O=U.nextSibling,p=O.firstChild,S=p.firstChild,x=S.nextSibling,I=O.nextSibling,N=I.firstChild,C=N.firstChild,A=I.nextSibling,V=A.firstChild,B=V.firstChild;return x.addEventListener("change",H=>r({excelOptions:{sheetName:H.target.value,includeFormatting:!0,autoFitColumns:!0,freezeHeader:!0,cellMappingStrategy:"position_based",...e.renderOptions.excelOptions}})),C.addEventListener("change",H=>r({excelOptions:{sheetName:"Report",autoFitColumns:!0,freezeHeader:!0,cellMappingStrategy:"position_based",...e.renderOptions.excelOptions,includeFormatting:H.target.checked}})),B.addEventListener("change",H=>r({excelOptions:{sheetName:"Report",includeFormatting:!0,freezeHeader:!0,cellMappingStrategy:"position_based",...e.renderOptions.excelOptions,autoFitColumns:H.target.checked}})),P(()=>x.value=e.renderOptions.excelOptions?.sheetName??"Report"),P(()=>C.checked=e.renderOptions.excelOptions?.includeFormatting??!0),P(()=>B.checked=e.renderOptions.excelOptions?.autoFitColumns??!0),M}}),null),k}}),null),P(k=>{var R=e.isRendering,M=e.isRendering,U=`toggle-switch px-3 py-1 rounded text-sm font-medium transition-colors ${e.autoPreview?"bg-blue-500 text-white":"bg-secondary text-primary border border-default"}`,O=e.isRendering,p=e.isRendering;return R!==k.e&&(f.disabled=k.e=R),M!==k.t&&(b.disabled=k.t=M),U!==k.a&&me(_,k.a=U),O!==k.o&&(T.disabled=k.o=O),p!==k.i&&(L.disabled=k.i=p),k},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),P(()=>f.value=e.renderOptions.format),P(()=>b.value=e.renderOptions.quality),a})()};De(["click"]);var Ur=v('<div class="preview-error-toast fixed bottom-4 right-4 bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded shadow-lg"><div class="flex items-center"><span class=mr-2>⚠️</span><span></span><button class="ml-4 text-red-900 hover:text-red-800">✕'),qr=v('<div class="preview-renderer-container h-full flex flex-col bg-tertiary"><div class="preview-toolbar border-b border-default p-4 bg-primary"></div><div class="preview-canvas-area flex-1 overflow-hidden"></div><div class="preview-status-bar border-t border-default p-2 bg-primary text-xs text-muted flex justify-between"><div class=status-left></div><div class=status-right>'),Br=v('<div class="preview-loading h-full flex items-center justify-center"><div class=text-center><div class="loading-spinner mb-4">⏳</div><div class=text-muted>正在生成预览...'),jr=v('<div class="preview-empty h-full flex items-center justify-center"><div class="text-center text-muted"><div class=mb-4>🔍</div><div>点击刷新按钮生成预览');const Qr=()=>{const{state:e}=Ge(),{state:t}=Rt(),n=kr(),[l,i]=G(!0),[r,a]=G(null);vt(()=>{if(!l()||t().mode!=="preview")return;const c=setTimeout(()=>{o()},500);return()=>clearTimeout(c)});const o=async()=>{try{const c={elements:[...e.elements],canvasConfig:e.canvas_config,options:n.renderOptions(),useCache:!0};await n.render(c),a(new Date)}catch(c){console.error("Preview generation failed:",c)}},g=()=>{o()};return(()=>{var c=qr(),f=c.firstChild,h=f.nextSibling,m=h.nextSibling,b=m.firstChild,u=b.nextSibling;return s(f,d(Fr,{get isRendering(){return n.isRendering()},get renderOptions(){return n.renderOptions()},get onOptionsChange(){return n.setRenderOptions},get onFormatChange(){return n.setFormat},onRefresh:g,onDownload:()=>n.download(),get autoPreview(){return l()},onAutoPreviewChange:i,get supportedFormats(){return n.supportedFormats()||[]},get stats(){return n.stats()||void 0}})),s(h,d(z,{get when(){return!n.isRendering()},get fallback(){return Br()},get children(){return d(z,{get when(){return n.renderResult()},get fallback(){return jr()},get children(){return d(Dr,{get result(){return n.renderResult()},onDownload:y=>n.download(y)})}})}})),s(b,d(z,{get when(){return r()},get children(){return["上次更新: ",be(()=>r()?.toLocaleTimeString())]}})),s(u,d(z,{get when(){return n.renderResult()},children:y=>[be(()=>y().format.toUpperCase())," • ",be(()=>Math.round(y().fileSize/1024)),"KB • ",be(()=>y().renderTimeMs),"ms"]})),s(c,d(z,{get when(){return n.renderError()},get children(){var y=Ur(),_=y.firstChild,$=_.firstChild,T=$.nextSibling,L=T.nextSibling;return s(T,()=>n.renderError()),L.$$click=()=>n.setRenderError(null),y}}),null),c})()};De(["click"]);var Hr=v("<div class=wizard-errors>"),Jr=v("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),Vr=v("<div class=error-message>"),Wr=v("<div class=wizard-progress>"),Gr=v("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),Kr=v("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),Yr=v("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),Xr=v("<span class=feature-tag>"),Zr=v("<div class=data-input-step><div class=step-header><h4></h4><p>"),es=v("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),ts=v("<div class=file-error>"),ns=v('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),ls=v("<div class=field-error>"),is=v("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),rs=v('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),ss=v('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),as=v("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),os=v("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),cs=v('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),ds=v("<span class=status-success>✅ JSON格式正确"),us=v("<span class=status-error>❌ 格式错误"),gs=v("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),hs=v("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),fs=v(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),vs=v("<div class=template-item><div class=template-name></div><div class=template-description>"),ms=v("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),bs=v("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),ps=v('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),ys=v("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),$s=v("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),_s=v("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),xs=v("<li>首次配置数据源时，建议先测试连接确保配置正确"),Ss=v("<li>测试过程会验证JSON格式和文件访问权限"),ws=v("<li>预览功能可以帮助您确认数据结构是否符合预期"),Cs=v("<li>✅ 连接测试成功！您可以继续创建数据源"),ks=v("<li>预览显示的是实际数据，创建后可用于报表设计"),Ts=v("<li>字段名称将用于数据绑定表达式"),Es=v("<li>❌ 请检查JSON格式是否正确"),Ls=v("<li>如果是文件类型，请确认文件路径存在且可访问"),Ds=v("<li>可以返回上一步修改配置后重新测试"),Ps=v("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),Rs=v("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),As=v("<span class=loading-spinner>⏳"),zs=v("<span class=test-button-icon>🔌"),Os=v("<div class=field-tag><span class=field-name>"),Ms=v("<th>"),Ns=v("<tr>"),Is=v("<td><div class=cell-content>"),Fs=v("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),Us=v('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),qs=v('<button class="control-btn finish-btn">'),Bs=v("<span class=hint-text>选择您的JSON数据来源方式"),dn=v("<span class=hint-text>"),js=v("<span class=hint-text>设置数据源名称和选项"),Qs=v('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),Hs=v("<span class=btn-loading>⏳"),Js=v("<span class=btn-text>创建中..."),Vs=v("<span class=btn-icon>✓"),Ws=v("<span class=btn-text>创建数据源");function In(e){const[t,n]=G({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),l=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],i=we(()=>{const u=t();switch(u.currentStep){case 1:return u.sourceType!==null;case 2:return r(u);case 3:return a(u);case 4:return o(u);default:return!1}}),r=u=>{if(u.sourceType==="file")return!!u.config.file_path?.trim();if(u.sourceType==="content"){const y=u.config.json_content?.trim();if(!y)return!1;try{return JSON.parse(y),!0}catch{return!1}}return!1},a=u=>{const y=u.name.trim();return!(y.length<2||y.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(y))},o=u=>!!u.testResult?.success,g=u=>{const y=t();n(_=>({..._,validation:{..._.validation,errors:[]}})),y.currentStep===1&&y.sourceType?n(_=>({..._,currentStep:u,config:{..._.config,source_type:y.sourceType}})):n(_=>({..._,currentStep:u}))},c=()=>{const u=t();u.currentStep<4&&i()&&g(u.currentStep+1)},f=()=>{const u=t();u.currentStep>1&&(u.currentStep===4?n(y=>({...y,currentStep:y.currentStep-1,testResult:null})):g(u.currentStep-1))},h=u=>{n(y=>({...y,...u}))},m=async()=>{const u=t();h({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const y={...u.config,source_type:u.sourceType};if(await Se.testConnection("json",y)){console.log("✅ 连接测试成功，获取预览数据...");const $=await Se.discoverSchema("json",y),T=`temp_${Date.now()}`,L=await Se.createDataSource(T,"json",y),E=await Se.getPreview(L,void 0,5);await Se.deleteDataSource(L),h({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:E.totalCount??E.total_rows??E.total_count??0,fields:$.columns.map(k=>k.name),sample_data:E.rows}},loading:!1})}}catch(y){console.error("❌ 连接测试失败:",y),h({testResult:{success:!1,message:"连接测试失败",error:y instanceof Error?y.message:String(y)},loading:!1})}},b=async()=>{const u=t();h({loading:!0});try{console.log("🔄 开始创建数据源...");const y={...u.config,source_type:u.sourceType},_=await Se.createDataSource(u.name,"json",y);console.log("✅ 数据源创建成功，ID:",_);try{await Ne.setActiveDataSource(_),console.log("✅ 数据源自动激活成功")}catch($){console.warn("⚠️ 数据源激活失败，但创建成功:",$)}e.onSuccess(),e.onBack()}catch(y){console.error("❌ 创建数据源失败:",y),h({validation:{isValid:!1,errors:[`创建失败: ${y}`],warnings:[]},loading:!1})}};return(()=>{var u=Jr(),y=u.firstChild,_=y.firstChild,$=_.nextSibling,T=$.firstChild,L=T.nextSibling,E=y.nextSibling;return Te(_,"click",e.onBack),s(L,()=>l[t().currentStep-1]?.description),s(u,d(Gs,{get currentStep(){return t().currentStep},stepInfo:l,onStepClick:g}),E),s(E,d(z,{get when(){return t().currentStep===1},get children(){return d(Ks,{get selectedType(){return t().sourceType},onSelect:k=>h({sourceType:k,config:{...t().config,source_type:k}})})}}),null),s(E,d(z,{get when(){return t().currentStep===2},get children(){return d(Ys,{get sourceType(){return t().sourceType},get config(){return t().config},onConfigUpdate:k=>h({config:{...t().config,...k}})})}}),null),s(E,d(z,{get when(){return t().currentStep===3},get children(){return d(Zs,{get name(){return t().name},get config(){return t().config},onNameChange:k=>h({name:k}),onConfigUpdate:k=>h({config:{...t().config,...k}})})}}),null),s(E,d(z,{get when(){return t().currentStep===4},get children(){return d(ta,{get config(){return t().config},get testResult(){return t().testResult},get loading(){return t().loading},onTest:m})}}),null),s(u,d(na,{get currentStep(){return t().currentStep},get canProceed(){return i()},get loading(){return t().loading},get testResult(){return t().testResult},onPrevious:f,onNext:c,onFinish:b}),null),s(u,d(z,{get when(){return t().validation.errors.length>0},get children(){var k=Hr();return s(k,d(ae,{get each(){return t().validation.errors},children:R=>(()=>{var M=Vr();return s(M,R),M})()})),k}}),null),u})()}function Gs(e){return(()=>{var t=Wr();return s(t,d(ae,{get each(){return e.stepInfo},children:n=>{const l=e.currentStep===n.step,i=e.currentStep>n.step,r=e.currentStep>=n.step;return(()=>{var a=Gr(),o=a.firstChild,g=o.firstChild,c=o.nextSibling,f=c.firstChild,h=f.nextSibling;return a.$$click=()=>r&&e.onStepClick(n.step),me(a,`progress-step ${l?"active":""} ${i?"completed":""}`),s(g,()=>i?"✓":n.step),s(f,()=>n.title),s(h,()=>n.description),a})()}})),t})()}function Ks(e){const t=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var n=Kr(),l=n.firstChild,i=l.nextSibling;return s(i,d(ae,{each:t,children:r=>(()=>{var a=Yr(),o=a.firstChild,g=o.firstChild,c=g.nextSibling,f=o.nextSibling,h=f.nextSibling,m=h.nextSibling,b=m.firstChild;return a.$$click=()=>e.onSelect(r.type),s(g,()=>r.title),s(c,()=>r.description),s(f,d(ae,{get each(){return r.features},children:u=>(()=>{var y=Xr();return s(y,u),y})()})),s(h,()=>r.example),b.addEventListener("change",()=>e.onSelect(r.type)),P(()=>me(a,`source-option ${e.selectedType===r.type?"selected":""}`)),P(()=>b.checked=e.selectedType===r.type),a})()})),n})()}function Ys(e){return(()=>{var t=Zr(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return s(l,()=>e.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),s(i,()=>e.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),s(t,d(z,{get when(){return e.sourceType==="file"},get children(){return d(Xs,{get filePath(){return e.config.file_path||""},onFileSelect:r=>e.onConfigUpdate({file_path:r})})}}),null),s(t,d(z,{get when(){return e.sourceType==="content"},get children(){return d(ea,{get content(){return e.config.json_content||""},onContentChange:r=>e.onConfigUpdate({json_content:r})})}}),null),t})()}function Xs(e){const[t,n]=G(!1),[l,i]=G(null),r=g=>{const f=g.target.files?.[0];f&&o(f)},a=g=>{g.preventDefault(),n(!1);const c=g.dataTransfer?.files?.[0];c&&o(c)},o=g=>{if(i(null),!g.name.endsWith(".json")){i("请选择JSON文件（.json格式）");return}if(g.size>10*1024*1024){i("文件大小不能超过10MB");return}const c=new FileReader;c.onload=f=>{try{const h=f.target?.result;JSON.parse(h),e.onFileSelect(g.name),console.log("✅ 文件选择成功:",g.name)}catch{i("文件内容不是有效的JSON格式")}},c.readAsText(g)};return(()=>{var g=ns(),c=g.firstChild,f=c.nextSibling,h=f.firstChild,m=h.firstChild,b=f.nextSibling;return c.addEventListener("drop",a),c.addEventListener("dragleave",()=>n(!1)),c.addEventListener("dragover",u=>{u.preventDefault(),n(!0)}),m.addEventListener("change",r),s(f,d(z,{get when(){return e.filePath},get children(){var u=es(),y=u.firstChild,_=y.nextSibling,$=_.nextSibling;return s(_,()=>e.filePath),$.$$click=()=>e.onFileSelect(""),u}}),null),s(g,d(z,{get when(){return l()},get children(){var u=ts();return s(u,l),u}}),b),P(()=>me(c,`file-drop-zone ${t()?"active":""}`)),g})()}function Zs(e){const[t,n]=G(null),l=r=>{e.onNameChange(r),r.trim().length===0?n("数据源名称不能为空"):r.trim().length<2?n("数据源名称至少需要2个字符"):r.trim().length>50?n("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(r.trim())?n(null):n("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},i=r=>{const a=parseInt(r);!isNaN(a)&&a>=10&&a<=3600&&e.onConfigUpdate({refresh_interval:a})};return(()=>{var r=cs(),a=r.firstChild,o=a.nextSibling,g=o.firstChild,c=g.firstChild,f=c.nextSibling,h=f.firstChild,m=h.nextSibling,b=m.nextSibling,u=g.nextSibling,y=u.firstChild,_=y.nextSibling,$=_.firstChild,T=$.firstChild,L=T.nextSibling;return m.$$input=E=>l(E.currentTarget.value),s(f,d(z,{get when(){return t()},get children(){var E=ls();return s(E,t),E}}),b),s(o,d(z,{get when(){return e.config.source_type==="file"},get children(){var E=rs(),k=E.firstChild,R=k.nextSibling,M=R.firstChild,U=M.firstChild;return U.addEventListener("change",O=>e.onConfigUpdate({auto_refresh:O.currentTarget.checked})),s(E,d(z,{get when(){return e.config.auto_refresh},get children(){var O=is(),p=O.firstChild,S=p.nextSibling,x=S.firstChild,I=x.nextSibling;return x.$$input=N=>i(N.currentTarget.value),I.addEventListener("change",N=>i(N.currentTarget.value)),P(()=>x.value=e.config.refresh_interval),P(()=>I.value=e.config.refresh_interval),O}}),null),P(()=>U.checked=e.config.auto_refresh),E}}),u),s(L,()=>e.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),s(_,d(z,{get when(){return e.config.source_type==="file"},get children(){return[(()=>{var E=ss(),k=E.firstChild,R=k.nextSibling;return s(R,()=>e.config.file_path||"(未选择文件)"),E})(),(()=>{var E=as(),k=E.firstChild,R=k.nextSibling;return s(R,()=>e.config.auto_refresh?`✅ 每 ${e.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),E})()]}}),null),s(_,d(z,{get when(){return e.config.source_type==="content"},get children(){var E=os(),k=E.firstChild,R=k.nextSibling,M=R.firstChild;return s(R,()=>e.config.json_content?.length||0,M),E}}),null),P(()=>me(m,`name-input ${t()?"error":""}`)),P(()=>m.value=e.name),r})()}function ea(e){const[t,n]=G(null),[l,i]=G(!1),r=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],a=g=>{if(e.onContentChange(g),g.trim())try{JSON.parse(g),n(null)}catch(c){n(c instanceof Error?c.message:"无效的JSON格式")}else n(null)},o=g=>{e.onContentChange(g.content),n(null),i(!1)};return(()=>{var g=fs(),c=g.firstChild,f=c.firstChild,h=f.nextSibling,m=h.nextSibling,b=c.nextSibling,u=b.firstChild,y=b.nextSibling;return f.$$click=()=>i(!l()),h.$$click=()=>e.onContentChange(""),s(m,d(z,{get when(){return be(()=>!t())()&&e.content.trim()},get children(){return ds()}}),null),s(m,d(z,{get when(){return t()},get children(){return us()}}),null),s(g,d(z,{get when(){return l()},get children(){var _=gs(),$=_.firstChild,T=$.nextSibling;return s(T,d(ae,{each:r,children:L=>(()=>{var E=vs(),k=E.firstChild,R=k.nextSibling;return E.$$click=()=>o(L),s(k,()=>L.name),s(R,()=>L.description),E})()})),_}}),b),u.$$input=_=>a(_.currentTarget.value),s(g,d(z,{get when(){return t()},get children(){var _=hs(),$=_.firstChild,T=$.nextSibling;return s(T,t),_}}),y),P(_=>{var $=!e.content,T=`json-textarea ${t()?"error":""}`;return $!==_.e&&(h.disabled=_.e=$),T!==_.t&&me(u,_.t=T),_},{e:void 0,t:void 0}),P(()=>u.value=e.content),g})()}function ta(e){const[t,n]=G(!1),l=()=>e.loading?"🔄":e.testResult?e.testResult.success?"✅":"❌":"⚡",i=()=>e.loading?"测试连接中...":e.testResult?e.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",r=()=>e.loading?"testing":e.testResult?e.testResult.success?"success":"error":"ready",a=o=>typeof o=="object"?JSON.stringify(o,null,2):String(o);return(()=>{var o=Rs(),g=o.firstChild,c=g.nextSibling,f=c.firstChild,h=f.firstChild,m=h.firstChild,b=m.firstChild,u=b.nextSibling,y=m.nextSibling,_=f.nextSibling,$=_.firstChild,T=$.nextSibling;return s(b,l),s(u,i),Te(y,"click",e.onTest),s(y,(()=>{var L=be(()=>!!e.loading);return()=>L()?[As(),"测试中..."]:[zs(),"测试连接"]})()),s(f,d(z,{get when(){return e.testResult},get children(){var L=bs(),E=L.firstChild,k=E.firstChild,R=k.nextSibling;return s(k,l),s(R,()=>e.testResult.message),s(L,d(z,{get when(){return e.testResult.error},get children(){var M=ms(),U=M.firstChild,O=U.nextSibling;return s(O,()=>e.testResult.error),M}}),null),P(()=>me(L,`test-result ${r()}`)),L}}),null),s(c,d(z,{get when(){return e.testResult?.success&&e.testResult.preview},get children(){var L=_s(),E=L.firstChild,k=E.firstChild,R=k.nextSibling,M=R.firstChild,U=M.firstChild,O=U.nextSibling,p=M.nextSibling,S=p.firstChild,x=S.nextSibling,I=E.nextSibling,N=I.firstChild,C=N.nextSibling,A=I.nextSibling,V=A.firstChild,B=V.nextSibling,H=B.firstChild,ee=H.firstChild,W=ee.firstChild,J=ee.nextSibling,q=A.nextSibling,oe=q.firstChild,pe=oe.firstChild;return s(O,()=>e.testResult.preview.record_count),s(x,()=>e.testResult.preview.fields.length),s(C,d(ae,{get each(){return e.testResult.preview.fields},children:he=>(()=>{var te=Os(),ie=te.firstChild;return s(ie,he),te})()})),s(W,d(ae,{get each(){return e.testResult.preview.fields},children:he=>(()=>{var te=Ms();return s(te,he),te})()})),s(J,d(ae,{get each(){return e.testResult.preview.sample_data},children:he=>(()=>{var te=Ns();return s(te,d(ae,{get each(){return e.testResult.preview.fields},children:ie=>(()=>{var se=Is(),de=se.firstChild;return s(de,(()=>{var X=be(()=>he[ie]!==void 0);return()=>X()?a(he[ie]):"-"})()),se})()})),te})()})),oe.$$click=()=>n(!t()),s(pe,()=>t()?"▼":"▶"),s(q,d(z,{get when(){return t()},get children(){var he=$s(),te=he.firstChild,ie=te.firstChild,se=ie.firstChild,de=se.nextSibling,X=ie.nextSibling;return s(de,()=>e.config.source_type==="file"?"JSON文件":"JSON内容"),s(te,d(z,{get when(){return e.config.source_type==="file"},get children(){return[(()=>{var Y=ps(),ce=Y.firstChild,fe=ce.nextSibling;return s(fe,()=>e.config.file_path),Y})(),(()=>{var Y=ys(),ce=Y.firstChild,fe=ce.nextSibling;return s(fe,()=>e.config.auto_refresh?"已启用":"已禁用"),Y})()]}}),X),he}}),null),L}}),_),s(T,d(z,{get when(){return!e.testResult},get children(){return[xs(),Ss(),ws()]}}),null),s(T,d(z,{get when(){return e.testResult?.success},get children(){return[Cs(),ks(),Ts()]}}),null),s(T,d(z,{get when(){return e.testResult&&!e.testResult.success},get children(){return[Es(),Ls(),Ds()]}}),null),s(c,d(z,{get when(){return e.config.source_type==="file"},get children(){return Ps()}}),null),P(L=>{var E=`test-button ${r()}`,k=e.loading;return E!==L.e&&me(y,L.e=E),k!==L.t&&(y.disabled=L.t=k),L},{e:void 0,t:void 0}),o})()}function na(e){const t=r=>{switch(r){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${r}`}},n=()=>e.currentStep>1,l=()=>e.currentStep<4&&e.canProceed,i=()=>e.currentStep===4&&e.canProceed;return(()=>{var r=Qs(),a=r.firstChild,o=a.firstChild,g=o.firstChild,c=g.nextSibling;c.nextSibling;var f=a.nextSibling,h=f.firstChild,m=f.nextSibling;return s(o,()=>e.currentStep,c),s(o,()=>t(e.currentStep),null),s(a,d(z,{get when(){return!e.canProceed&&e.currentStep<4},get children(){return Fs()}}),null),Te(h,"click",e.onPrevious),s(f,d(z,{get when(){return e.currentStep<4},get children(){var b=Us();return Te(b,"click",e.onNext),P(()=>b.disabled=!l()||e.loading),b}}),null),s(f,d(z,{get when(){return e.currentStep===4},get children(){var b=qs();return Te(b,"click",e.onFinish),s(b,(()=>{var u=be(()=>!!e.loading);return()=>u()?[Hs(),Js()]:[Vs(),Ws()]})()),P(()=>b.disabled=!i()||e.loading),b}}),null),s(m,d(z,{get when(){return e.currentStep===1},get children(){return Bs()}}),null),s(m,d(z,{get when(){return e.currentStep===2},get children(){var b=dn();return s(b,()=>e.testResult?.success?"数据格式验证成功":"请提供JSON数据内容"),b}}),null),s(m,d(z,{get when(){return e.currentStep===3},get children(){return js()}}),null),s(m,d(z,{get when(){return e.currentStep===4},get children(){var b=dn();return s(b,()=>e.testResult?.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"),b}}),null),P(()=>h.disabled=!n()||e.loading),r})()}De(["click","input"]);var la=v("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),ia=v("<div class=error-message>"),ra=v("<div class=loading-message>加载中..."),sa=v("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),aa=v("<div class=sources-grid>"),oa=v("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),ca=v("<span class=active-badge title=当前激活>当前"),da=v('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),ua=v("<span class=changes-indicator>● 有未保存的更改"),ga=v("<div class=error-details>"),ha=v("<div><div class=result-message> "),fa=v("<div class=error-message>❌ "),va=v("<button type=button class=reset-btn>重置更改"),ma=v('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),ba=v("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),pa=v("<th>"),ya=v("<tr>"),$a=v("<td>");const _a=e=>{const t=(e.type_name||e.provider_type||e.providerType||"").toLowerCase();return t.includes("database_mysql")?"MySQL":t.includes("database_postgresql")?"PostgreSQL":t==="json"?"JSON":t==="csv"?"CSV":t==="excel"?"Excel":t.startsWith("api")?"API":t.startsWith("database")?"Database":e.type_name||e.provider_type||e.providerType||"Unknown"};function xa(e){const[t,n]=G([]),[l,i]=G([]),[r,a]=G("list"),[o,g]=G(null),[c,f]=G(null),[h,m]=G(!1),[b,u]=G(null),[y,_]=G(null);Fe(async()=>{try{await $(),await T();const O=Ne.subscribe(p=>{_(p?.dataSource.id||null)});_(Ne.getCurrentContext()?.dataSource.id||null),rt(O)}catch(O){console.error("🚨 DataSourcesPanel初始化失败:",O),u(`数据源模块初始化失败: ${O}`)}});const $=async()=>{try{m(!0),console.log("🔄 开始加载数据源列表...");const O=await Se.listDataSources();console.log("✅ 数据源列表加载成功:",O),n(O),u(null)}catch(O){console.error("❌ 加载数据源失败:",O),u(`加载数据源失败: ${O}`)}finally{m(!1)}},T=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const O=await Se.getAvailableTypes();console.log("✅ 数据源类型加载成功:",O),i(O)}catch(O){console.error("❌ 加载数据源类型失败:",O)}},L=()=>{a("add"),g(null)},E=O=>{g(O),a("edit")},k=async O=>{try{m(!0),u(null),g(O),console.log("🔄 开始预览数据源:",O.name),O.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",O.status),u(`数据源状态为 ${O.status}，可能无法预览数据`));const p=await Se.getPreview(O.id);f(p),a("preview"),console.log("✅ 数据预览加载成功:",p)}catch(p){console.error("❌ 数据预览失败:",p);const S=`预览数据源 "${O.name}" 失败: ${p}`;u(S);const x={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},I=String(p).toLowerCase(),N=Object.keys(x).find(C=>I.includes(C));N&&u(`预览失败: ${x[N]}`)}finally{m(!1)}},R=async O=>{if(confirm("确定要删除这个数据源吗？"))try{await Se.deleteDataSource(O),await $()}catch(p){u(`删除数据源失败: ${p}`)}},M=async O=>{try{m(!0),u(null),await Ne.setActiveDataSource(O.id)}catch(p){console.error("❌ 激活数据源失败:",p),u(`激活数据源失败: ${p}`)}finally{m(!1)}},U=async O=>{try{m(!0),u(null),console.log("🔄 开始测试数据源连接:",O);const p=t().find(I=>I.id===O);if(!p){const I=`数据源不存在: ${O}`;console.error("❌",I),u(I);return}console.log("📋 数据源信息:",{id:p.id,name:p.name,providerType:p.providerType||p.provider_type,config:p.config});let S=p.providerType||p.provider_type||p.type_name;(p.name.includes("MySQL")||p.name.includes("数据库")||JSON.stringify(p.config).includes("mysql")||JSON.stringify(p.config).includes("3306"))&&(S="database",console.log("🗄️ 检测到数据库类型，使用provider_type: database")),console.log("🔍 调用测试连接API:",{providerType:S,config:p.config});const x=await Se.testConnection(S,p.config||{});console.log("📨 API返回结果:",x),x?(console.log("✅ 数据源连接测试成功:",O),alert(`✅ 数据源 "${p.name}" 连接测试成功！

🎉 数据库连接正常，可以正常使用`)):(console.log("❌ 数据源连接测试失败:",O),alert(`❌ 数据源 "${p.name}" 连接测试失败

请检查配置信息是否正确`))}catch(p){console.error("❌ 测试连接时发生错误:",p),console.error("❌ 错误详情:",{error:p,errorType:typeof p,errorString:String(p),errorJSON:JSON.stringify(p,null,2)});const S=t().find(I=>I.id===O),x=`测试连接失败: ${p}`;u(x),!p||String(p)===""||String(p)==="null"?alert(`❌ 数据源 "${S?.name||O}" 连接测试遇到未知错误

请检查：
• 开发者工具控制台的详细错误信息
• 后端服务是否正常运行
• 配置参数是否正确`):alert(`❌ 数据源 "${S?.name||O}" 连接测试失败:

${p}

💡 如果是空错误，请检查开发者工具控制台获取详细信息`)}finally{m(!1)}};return d(z,{get when(){return e.isOpen},get children(){var O=la(),p=O.firstChild,S=p.nextSibling,x=S.firstChild,I=x.nextSibling,N=I.nextSibling,C=S.nextSibling;return Te(N,"click",e.onClose),s(C,d(z,{get when(){return r()==="list"},get children(){return d(Sa,{get dataSources(){return t()},get loading(){return h()},get error(){return b()},onAdd:L,onEdit:E,onPreview:k,onDelete:R,onActivate:M,onTestConnection:U,onRefresh:$,get activeId(){return y()}})}}),null),s(C,d(z,{get when(){return r()==="add"},get children(){return d(In,{get availableTypes(){return l()},onBack:()=>a("list"),onSuccess:$})}}),null),s(C,d(z,{get when(){return be(()=>r()==="edit")()&&o()},get children(){return d(wa,{get dataSource(){return o()},onBack:()=>a("list"),onSuccess:$})}}),null),s(C,d(z,{get when(){return be(()=>!!(r()==="preview"&&o()))()&&c()},get children(){return d(Ca,{get dataSource(){return o()},get data(){return c()},onBack:()=>a("list")})}}),null),O}})}function Sa(e){const t=l=>{switch(l){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=l=>new Date(l).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var l=oa(),i=l.firstChild,r=i.firstChild,a=r.firstChild,o=a.firstChild,g=o.nextSibling;g.nextSibling;var c=a.nextSibling,f=r.nextSibling;return s(a,()=>e.dataSources.length,g),Te(c,"click",e.onRefresh),Te(f,"click",e.onAdd),s(l,d(z,{get when(){return e.error},get children(){var h=ia();return s(h,()=>e.error),h}}),null),s(l,d(z,{get when(){return e.loading},get children(){return ra()}}),null),s(l,d(z,{get when(){return!e.loading&&e.dataSources.length===0},get children(){var h=sa(),m=h.firstChild,b=m.nextSibling;return Te(b,"click",e.onAdd),h}}),null),s(l,d(z,{get when(){return!e.loading&&e.dataSources.length>0},get children(){var h=aa();return s(h,d(ae,{get each(){return e.dataSources},children:m=>(()=>{var b=da(),u=b.firstChild,y=u.firstChild,_=y.firstChild,$=_.nextSibling,T=y.nextSibling,L=u.nextSibling,E=L.firstChild,k=E.firstChild,R=k.nextSibling,M=E.nextSibling,U=M.firstChild,O=U.nextSibling,p=L.nextSibling,S=p.firstChild,x=S.nextSibling,I=x.nextSibling,N=I.nextSibling,C=N.nextSibling;return s(_,()=>m.name,null),s(_,d(z,{get when(){return e.activeId===m.id},get children(){return ca()}}),null),s($,()=>_a(m)),s(R,()=>n(m.createdAt||m.created_at)),s(O,()=>n(m.lastUpdated||m.last_updated)),S.$$click=()=>e.onPreview(m),x.$$click=()=>e.onActivate(m),I.$$click=()=>e.onTestConnection(m.id),N.$$click=()=>e.onEdit(m),C.$$click=()=>e.onDelete(m.id),P(A=>{var V=e.activeId===m.id?"true":"false",B=t(m.status),H=`状态: ${m.status}`,ee=m.status!=="active",W=e.activeId===m.id;return V!==A.e&&j(b,"data-active",A.e=V),B!==A.t&&((A.t=B)!=null?T.style.setProperty("background-color",B):T.style.removeProperty("background-color")),H!==A.a&&j(T,"title",A.a=H),ee!==A.o&&(S.disabled=A.o=ee),W!==A.i&&(x.disabled=A.i=W),A},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),b})()})),h}}),null),P(h=>{var m=e.loading,b=e.loading?"正在刷新数据源列表":"刷新数据源列表",u=e.loading?"正在刷新...":"刷新数据源列表";return m!==h.e&&(c.disabled=h.e=m),b!==h.t&&j(c,"aria-label",h.t=b),u!==h.a&&j(c,"title",h.a=u),h},{e:void 0,t:void 0,a:void 0}),l})()}function wa(e){const[t,n]=G({name:e.dataSource.name,config:e.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[l]=G(JSON.stringify(e.dataSource.config||{})),i=()=>{const f=t(),h=f.name!==e.dataSource.name,m=JSON.stringify(f.config)!==l();n(b=>({...b,hasChanges:h||m}))},r=f=>{n(h=>({...h,name:f})),i()},a=f=>{n(h=>({...h,config:f})),i()},o=async()=>{const f=t();n(h=>({...h,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await Se.testConnection(e.dataSource.providerType||e.dataSource.provider_type,f.config)&&(console.log("✅ 连接测试成功"),n(m=>({...m,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(h){console.error("❌ 连接测试失败:",h),n(m=>({...m,testResult:{success:!1,message:"连接测试失败",error:h instanceof Error?h.message:String(h)},loading:!1}))}},g=async()=>{const f=t();if(!f.hasChanges){e.onBack();return}if(!f.name.trim()){n(h=>({...h,error:"数据源名称不能为空"}));return}try{n(h=>({...h,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await Se.updateConfig(e.dataSource.id,f.config),f.name!==e.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),n(h=>({...h,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),e.onSuccess(),e.onBack()}catch(h){console.error("❌ 更新数据源失败:",h),n(m=>({...m,error:`更新失败: ${h}`,loading:!1}))}},c=()=>{n(f=>({...f,name:e.dataSource.name,config:e.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var f=ma(),h=f.firstChild,m=h.firstChild,b=m.nextSibling,u=b.firstChild,y=u.nextSibling,_=y.firstChild,$=_.nextSibling;$.firstChild;var T=h.nextSibling,L=T.firstChild,E=L.firstChild,k=E.nextSibling,R=k.firstChild,M=R.nextSibling,U=L.nextSibling,O=U.firstChild;O.firstChild;var p=O.nextSibling,S=p.firstChild,x=S.nextSibling,I=U.nextSibling,N=I.firstChild,C=N.firstChild,A=C.nextSibling,V=I.nextSibling,B=V.firstChild,H=B.nextSibling,ee=H.firstChild,W=ee.firstChild,J=W.nextSibling,q=ee.nextSibling,oe=q.firstChild,pe=oe.nextSibling,he=q.nextSibling,te=he.firstChild,ie=te.nextSibling,se=V.nextSibling,de=se.firstChild,X=de.nextSibling;return Te(m,"click",e.onBack),s(_,()=>e.dataSource.providerType||e.dataSource.type_name),s($,()=>e.dataSource.id,null),M.$$input=Y=>r(Y.currentTarget.value),s(O,d(z,{get when(){return t().hasChanges},get children(){return ua()}}),null),x.$$input=Y=>{try{const ce=JSON.parse(Y.currentTarget.value);a(ce),n(fe=>({...fe,error:null}))}catch{n(fe=>({...fe,error:"配置格式错误，请检查JSON语法"}))}},A.$$click=o,s(A,()=>t().loading?"测试中...":"测试连接"),s(I,d(z,{get when(){return t().testResult},get children(){var Y=ha(),ce=Y.firstChild,fe=ce.firstChild;return s(ce,()=>t().testResult?.success?"✅":"❌",fe),s(ce,()=>t().testResult?.message,null),s(Y,d(z,{get when(){return t().testResult?.error},get children(){var _e=ga();return s(_e,()=>t().testResult?.error),_e}}),null),P(()=>me(Y,`test-result ${t().testResult?.success?"success":"error"}`)),Y}}),null),s(J,()=>e.dataSource.status==="active"?"✅ 活跃":e.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),s(pe,()=>new Date(e.dataSource.createdAt||e.dataSource.created_at).toLocaleString("zh-CN")),s(ie,()=>new Date(e.dataSource.lastUpdated||e.dataSource.last_updated).toLocaleString("zh-CN")),s(T,d(z,{get when(){return t().error},get children(){var Y=fa();return Y.firstChild,s(Y,()=>t().error,null),Y}}),se),Te(de,"click",e.onBack),s(se,d(z,{get when(){return t().hasChanges},get children(){var Y=va();return Y.$$click=c,P(()=>Y.disabled=t().loading),Y}}),X),X.$$click=g,s(X,(()=>{var Y=be(()=>!!t().loading);return()=>Y()?"保存中...":t().hasChanges?"保存更改":"无更改"})()),P(Y=>{var ce=t().error&&!t().name.trim()?"error":"",fe=t().error&&t().error?.includes("配置格式")?"error":"",_e=t().loading,ge=`status-value status-${e.dataSource.status}`,ve=`save-btn ${t().hasChanges?"has-changes":""}`,ne=t().loading;return ce!==Y.e&&me(M,Y.e=ce),fe!==Y.t&&me(x,Y.t=fe),_e!==Y.a&&(A.disabled=Y.a=_e),ge!==Y.o&&me(J,Y.o=ge),ve!==Y.i&&me(X,Y.i=ve),ne!==Y.n&&(X.disabled=Y.n=ne),Y},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),P(()=>M.value=t().name),P(()=>x.value=JSON.stringify(t().config,null,2)),f})()}function Ca(e){return(()=>{var t=ba(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;i.firstChild;var r=i.nextSibling,a=r.firstChild,o=a.nextSibling,g=o.nextSibling,c=g.nextSibling;c.nextSibling;var f=n.nextSibling,h=f.firstChild,m=h.firstChild,b=m.firstChild,u=m.nextSibling;return Te(l,"click",e.onBack),s(i,()=>e.dataSource.name,null),s(r,()=>e.data.totalCount??e.data.total_rows,o),s(r,()=>e.data.rows.length,c),s(b,d(ae,{get each(){return e.data.columns},children:y=>(()=>{var _=pa();return s(_,y),_})()})),s(u,d(ae,{get each(){return e.data.rows.slice(0,50)},children:y=>(()=>{var _=ya();return s(_,d(ae,{get each(){return e.data.columns},children:$=>(()=>{var T=$a();return s(T,(()=>{var L=be(()=>typeof y[$]=="object");return()=>L()?JSON.stringify(y[$]):String(y[$]||"")})()),T})()})),_})()})),t})()}De(["click","input"]);var ka=v("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Ta=v("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Ea=v("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),La=v("<div class=current-record>"),Da=v("<div class=empty-record>暂无记录数据"),Pa=v("<div class=available-fields>"),Ra=v("<div class=no-fields>暂无可用字段"),Aa=v('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),za=v("<div class=record-field><div class=field-key>:</div><div class=field-value>"),Oa=v("<div class=field-display-name>"),Ma=v("<div class=field-sample>示例: "),Na=v("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),Ia=v("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),Fa=v('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const un=()=>{const[e,t]=G(null),[n,l]=G(!1);vt(()=>{const c=Ne.subscribe(f=>{t(f)});return t(Ne.getCurrentContext()),c});const i=we(()=>{const c=e();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),r=async()=>{l(!0);try{await Ne.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{l(!1)}},a=async()=>{l(!0);try{await Ne.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{l(!1)}},o=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),g=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Ea(),f=c.firstChild,h=f.firstChild,m=h.nextSibling,b=m.firstChild,u=b.nextSibling;return s(b,()=>i().icon),s(u,()=>i().text),s(c,d(z,{get when(){return e()},children:y=>(()=>{var _=Aa(),$=_.firstChild,T=$.firstChild,L=T.nextSibling,E=L.firstChild,k=E.firstChild,R=k.nextSibling,M=E.nextSibling,U=M.firstChild,O=U.nextSibling,p=M.nextSibling,S=p.firstChild,x=S.nextSibling,I=$.nextSibling,N=I.firstChild,C=N.nextSibling,A=C.firstChild,V=A.nextSibling,B=V.firstChild,H=V.nextSibling,ee=I.nextSibling;ee.firstChild;var W=ee.nextSibling,J=W.firstChild,q=J.firstChild,oe=q.nextSibling,pe=oe.firstChild,he=pe.nextSibling;return he.nextSibling,s(R,()=>y().dataSource.name),s(O,()=>y().dataSource.type.toUpperCase()),s(x,()=>y().dataSource.id),A.$$click=a,s(V,()=>y().currentRecord.index+1,B),s(V,()=>y().currentRecord.total,null),H.$$click=r,s(ee,d(z,{get when(){return Object.keys(y().currentRecord.data).length>0},get children(){var te=La();return s(te,d(ae,{get each(){return Object.entries(y().currentRecord.data)},children:([ie,se])=>(()=>{var de=za(),X=de.firstChild,Y=X.firstChild,ce=X.nextSibling;return s(X,ie,Y),s(ce,()=>o(se)),de})()})),te}}),null),s(ee,d(z,{get when(){return Object.keys(y().currentRecord.data).length===0},get children(){return Da()}}),null),s(oe,()=>y().fields.length,he),s(W,d(z,{get when(){return y().fields.length>0},get children(){var te=Pa();return s(te,d(ae,{get each(){return y().fields},children:ie=>(()=>{var se=Na(),de=se.firstChild,X=de.firstChild,Y=X.nextSibling,ce=Y.firstChild,fe=ce.nextSibling;fe.nextSibling;var _e=de.nextSibling,ge=_e.firstChild,ve=ge.nextSibling;return s(X,()=>ie.name),s(Y,()=>g(ie.type),fe),s(se,d(z,{get when(){return ie.displayName&&ie.displayName!==ie.name},get children(){var ne=Oa();return s(ne,()=>ie.displayName),ne}}),_e),s(se,d(z,{get when(){return ie.sample!==void 0},get children(){var ne=Ma();return ne.firstChild,s(ne,()=>o(ie.sample),null),ne}}),_e),s(ve,()=>`{${ie.name}}`),se})()})),te}}),null),s(W,d(z,{get when(){return y().fields.length===0},get children(){return Ra()}}),null),s(_,d(z,{get when(){return y().error},children:te=>(()=>{var ie=Fa(),se=ie.firstChild,de=se.nextSibling,X=de.firstChild;X.firstChild;var Y=X.nextSibling;return Y.firstChild,s(X,()=>te().type,null),s(Y,()=>te().message,null),s(de,d(z,{get when(){return te().details},get children(){var ce=Ia(),fe=ce.firstChild,_e=fe.nextSibling;return s(_e,()=>JSON.stringify(te().details,null,2)),ce}}),null),ie})()}),null),P(te=>{var ie=n()||y().currentRecord.index<=0,se=n()||y().currentRecord.index>=y().currentRecord.total-1;return ie!==te.e&&(A.disabled=te.e=ie),se!==te.t&&(H.disabled=te.t=se),te},{e:void 0,t:void 0}),_})()}),null),s(c,d(z,{get when(){return!e()},get children(){return ka()}}),null),s(c,d(z,{get when(){return n()},get children(){return Ta()}}),null),P(y=>(y=i().color)!=null?u.style.setProperty("color",y):u.style.removeProperty("color")),c})()};De(["click"]);var Ua=v(`<div class=sql-editor><div class=editor-toolbar><div class=toolbar-left><span class=editor-label>SQL编辑器</span><span class=database-type>(<!>)</span></div><div class=toolbar-right><span class=cursor-position>行 <!>, 列 </span><span class=character-count> 字符</span></div></div><div class=template-toolbar><span class=template-label>模板:</span></div><div><textarea class=sql-textarea placeholder="请输入SQL查询语句...

示例:
SELECT u.username, u.email, COUNT(o.id) as order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at >= '2024-01-01'
GROUP BY u.id, u.username, u.email
ORDER BY order_count DESC
LIMIT 10;"rows=15></textarea><div class=line-numbers></div></div><div class=editor-help><div class=help-item><kbd>Tab</kbd> 缩进</div><div class=help-item><kbd>Ctrl+F</kbd> 格式化</div><div class=help-item><kbd>Enter</kbd> 自动缩进</div></div><style>
        .sql-editor {
          display: flex;
          flex-direction: column;
          border: 1px solid #ddd;
          border-radius: 6px;
          background: white;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .editor-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          background: #f8f9fa;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .toolbar-left {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .editor-label {
          font-weight: bold;
          color: #2c3e50;
        }

        .database-type {
          background: #3498db;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
          gap: 12px;
          color: #666;
        }

        .template-toolbar {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f1f3f5;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .template-label {
          color: #666;
          font-weight: bold;
        }

        .template-btn {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 4px;
          padding: 4px 8px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .template-btn:hover:not(:disabled) {
          background: #dee2e6;
          border-color: #adb5bd;
        }

        .template-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .editor-container {
          position: relative;
          flex: 1;
          min-height: 300px;
        }

        .editor-container.focused {
          box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editor-container.disabled {
          opacity: 0.6;
          pointer-events: none;
        }

        .sql-textarea {
          width: 100%;
          height: 100%;
          padding: 12px 12px 12px 48px;
          border: none;
          outline: none;
          resize: vertical;
          font-family: inherit;
          font-size: 14px;
          line-height: 1.5;
          background: transparent;
        }

        .line-numbers {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 36px;
          background: #f8f9fa;
          border-right: 1px solid #e9ecef;
          padding: 12px 4px;
          user-select: none;
          overflow: hidden;
        }

        .line-number {
          text-align: right;
          font-size: 12px;
          color: #6c757d;
          line-height: 1.5;
          padding-right: 8px;
        }

        .editor-help {
          display: flex;
          justify-content: center;
          gap: 16px;
          padding: 6px;
          background: #f8f9fa;
          border-top: 1px solid #ddd;
          font-size: 11px;
          color: #666;
        }

        .help-item {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        kbd {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 3px;
          padding: 2px 4px;
          font-size: 10px;
          font-family: inherit;
        }
      `),qa=v("<button class=template-btn>"),Ba=v("<div class=line-number>");function ja(e){let t;const[n,l]=G(!1),[i,r]=G({line:1,column:1}),a=m=>{const b=m.target;e.onSQLChange(b.value),o()},o=()=>{if(!t)return;const m=t.selectionStart,u=e.sql.substring(0,m).split(`
`);r({line:u.length,column:(u[u.length-1]||"").length+1})},g=m=>{if(!t||e.disabled)return;const b=m.target,u=b.selectionStart,y=b.selectionEnd;if(m.key==="Tab"){m.preventDefault();const _=e.sql.substring(0,u)+"  "+e.sql.substring(y);e.onSQLChange(_),setTimeout(()=>{t&&(t.selectionStart=t.selectionEnd=u+2,o())},0)}else if(m.key==="Enter"){const _=e.sql.substring(0,u).split(`
`),$=_[_.length-1],T=$?.match(/^\s*/)?.[0]||"",L=$?.trim().toUpperCase()||"",k=["SELECT","FROM","WHERE","GROUP BY","ORDER BY","HAVING"].some(R=>L.endsWith(R)||L.includes(R+" "))?T+"  ":T;if(k){m.preventDefault();const R=e.sql.substring(0,u)+`
`+k+e.sql.substring(y);e.onSQLChange(R),setTimeout(()=>{if(t){const M=u+1+k.length;t.selectionStart=t.selectionEnd=M,o()}},0)}}},c=m=>{(m.ctrlKey||m.metaKey)&&m.key==="f"&&(m.preventDefault(),console.log("格式化快捷键触发"))},f=m=>{if(!t||e.disabled)return;const b=t.selectionStart,u=t.selectionEnd,y=e.sql.substring(0,b)+m+e.sql.substring(u);e.onSQLChange(y),setTimeout(()=>{t&&(t.focus(),t.selectionStart=t.selectionEnd=b+m.length,o())},0)};Fe(()=>{o(),t&&(t.addEventListener("selectionchange",o),t.addEventListener("click",o))});const h=[{name:"基础查询",template:"SELECT * FROM table_name WHERE condition;"},{name:"联表查询",template:`SELECT t1.*, t2.*
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.table1_id
WHERE condition;`},{name:"聚合查询",template:`SELECT column, COUNT(*), AVG(value)
FROM table_name
GROUP BY column
HAVING COUNT(*) > 1
ORDER BY column;`},{name:"子查询",template:`SELECT *
FROM table1
WHERE column IN (
  SELECT column
  FROM table2
  WHERE condition
);`}];return(()=>{var m=Ua(),b=m.firstChild,u=b.firstChild,y=u.firstChild,_=y.nextSibling,$=_.firstChild,T=$.nextSibling;T.nextSibling;var L=u.nextSibling,E=L.firstChild,k=E.firstChild,R=k.nextSibling;R.nextSibling;var M=E.nextSibling,U=M.firstChild,O=b.nextSibling;O.firstChild;var p=O.nextSibling,S=p.firstChild,x=S.nextSibling;s(_,()=>e.databaseType.toUpperCase(),T),s(E,()=>i().line,R),s(E,()=>i().column,null),s(M,()=>e.sql.length,U),s(O,()=>h.map(N=>(()=>{var C=qa();return C.$$click=()=>f(N.template),s(C,()=>N.name),P(A=>{var V=e.disabled,B=`插入${N.name}模板`;return V!==A.e&&(C.disabled=A.e=V),B!==A.t&&j(C,"title",A.t=B),A},{e:void 0,t:void 0}),C})()),null),S.addEventListener("blur",()=>l(!1)),S.addEventListener("focus",()=>l(!0)),S.addEventListener("keypress",c),S.$$keydown=g,S.$$input=a;var I=t;return typeof I=="function"?gt(I,S):t=S,j(S,"spellcheck",!1),s(x,()=>e.sql.split(`
`).map((N,C)=>(()=>{var A=Ba();return s(A,C+1),A})())),P(N=>{var C=`editor-container ${n()?"focused":""} ${e.disabled?"disabled":""}`,A=e.disabled;return C!==N.e&&me(p,N.e=C),A!==N.t&&(S.disabled=N.t=A),N},{e:void 0,t:void 0}),P(()=>S.value=e.sql),m})()}De(["input","keydown","click"]);var Qa=v("<div class=empty-message><p>请选择要查询的字段</p><button>自动选择字段"),Ha=v("<div class=builder-section><div class=section-header><h4>🔗 表关联 (JOIN)</h4><button class=add-btn>+ 添加关联</button></div><div class=joins-list>"),Ja=v(`<div class=visual-query-builder><div class=query-options><label class=option-checkbox><input type=checkbox><span>去重查询 (DISTINCT)</span></label></div><div class=builder-section><div class=section-header><h4>📋 选择字段 (SELECT)</h4><button class=add-btn>+ 添加字段</button></div><div class=fields-list></div></div><div class=builder-section><div class=section-header><h4>🔍 筛选条件 (WHERE)</h4><button class=add-btn>+ 添加条件</button></div><div class=where-list></div></div><div class=builder-section><div class=section-header><h4>⚙️ 其他选项</h4></div><div class=options-grid><div class=option-group><label>限制行数 (LIMIT):</label><input type=number placeholder=无限制 min=1 max=10000></div></div></div><style>
        .visual-query-builder {
          display: flex;
          flex-direction: column;
          gap: 20px;
          padding: 16px;
          background: #f8f9fa;
          border-radius: 8px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .query-options {
          display: flex;
          gap: 16px;
        }

        .option-checkbox {
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
        }

        .builder-section {
          background: white;
          border-radius: 6px;
          padding: 16px;
          border: 1px solid #dee2e6;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e9ecef;
        }

        .section-header h4 {
          margin: 0;
          color: #2c3e50;
          font-size: 14px;
        }

        .add-btn {
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
        }

        .add-btn:hover:not(:disabled) {
          background: #218838;
        }

        .field-item, .join-item, .where-item {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
          padding: 8px;
          background: #f8f9fa;
          border-radius: 4px;
          flex-wrap: wrap;
        }

        .join-condition {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .separator {
          font-weight: bold;
          color: #6c757d;
        }

        select, input {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          border-radius: 3px;
          font-size: 13px;
        }

        select {
          background: white;
        }

        input[type="text"] {
          min-width: 100px;
          flex: 1;
        }

        input[type="number"] {
          width: 100px;
        }

        .remove-btn {
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          cursor: pointer;
          font-size: 14px;
        }

        .remove-btn:hover:not(:disabled) {
          background: #c82333;
        }

        .empty-message {
          text-align: center;
          padding: 20px;
          color: #6c757d;
        }

        .empty-message button {
          background: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 8px 16px;
          cursor: pointer;
          margin-top: 8px;
        }

        .options-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
        }

        .option-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .option-group label {
          font-weight: bold;
          color: #495057;
          font-size: 13px;
        }

        button:disabled, select:disabled, input:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      `),Va=v('<div class=field-item><select></select><span class=separator>.</span><select></select><select><option value>无聚合</option><option value=COUNT>COUNT</option><option value=SUM>SUM</option><option value=AVG>AVG</option><option value=MIN>MIN</option><option value=MAX>MAX</option><option value=DISTINCT>DISTINCT</option></select><input type=text placeholder="别名 (可选)"><button class=remove-btn>×'),Xe=v("<option>"),Wa=v("<option> (<!>)"),Ga=v("<div class=join-item><select><option value=INNER>INNER JOIN</option><option value=LEFT>LEFT JOIN</option><option value=RIGHT>RIGHT JOIN</option><option value=FULL>FULL JOIN</option></select><div class=join-condition><select></select><select></select><span>=</span><select></select><select></select></div><button class=remove-btn>×"),Ka=v("<select><option value=AND>AND</option><option value=OR>OR"),Ya=v("<input type=text>"),Xa=v('<div class=where-item><select></select><select></select><select><option value="=">=</option><option value="!=">!=</option><option value=">">&gt;</option><option value="<">&lt;</option><option value=">=">&gt;=</option><option value="<=">&lt;=</option><option value=LIKE>LIKE</option><option value=IN>IN</option><option value="IS NULL">IS NULL</option><option value="IS NOT NULL">IS NOT NULL</option></select><button class=remove-btn>×');function Za(e){const[t,n]=G([]),[l,i]=G([]),[r,a]=G([]),[o]=G([]),[g]=G([]),[c,f]=G(void 0),[h,m]=G(!1),b=we(()=>e.schema?.schemas?.[0]?.tables?e.schema.schemas[0].tables.filter(S=>e.selectedTables.includes(S.name)):[]),u=S=>b().find(I=>I.name===S)?.columns||[],y=we(()=>{const S=b();if(S.length===0||t().length===0)return"";let x="";x+=h()?"SELECT DISTINCT ":"SELECT ";const I=t().map(B=>{let H=`${B.table}.${B.column}`;return B.aggregate&&(B.aggregate==="DISTINCT"?H=`DISTINCT ${H}`:H=`${B.aggregate}(${H})`),B.alias&&(H+=` AS ${B.alias}`),H});x+=I.join(`,
       `),x+=`
FROM ${S[0]?.name||"table1"}`;const N=l();for(const B of N)x+=`
${B.joinType} JOIN ${B.rightTable} ON ${B.leftTable}.${B.leftColumn} = ${B.rightTable}.${B.rightColumn}`;const C=r();if(C.length>0){x+=`
WHERE `;const B=C.map((H,ee)=>{let W="";return ee>0&&(W+=`${H.logicalOperator} `),W+=`${H.table}.${H.column} ${H.operator}`,["IS NULL","IS NOT NULL"].includes(H.operator)||(H.operator==="IN"?W+=` (${H.value})`:H.operator==="LIKE"?W+=` '%${H.value}%'`:W+=` '${H.value}'`),W});x+=B.join(" ")}const A=g();A.length>0&&(x+=`
GROUP BY ${A.join(", ")}`);const V=o();if(V.length>0){const B=V.map(H=>`${H.table}.${H.column} ${H.direction}`);x+=`
ORDER BY ${B.join(", ")}`}return c()&&(x+=`
LIMIT ${c()}`),x});Fe(()=>{$()});const _=()=>{e.onQueryChange(y())},$=()=>{const S=b();if(S.length===0)return;const x=[];S.forEach(I=>{(I.columns?.slice(0,3)||[]).forEach(C=>{x.push({table:I.name,column:C.name})})}),n(x),_()},T=()=>{const S=b();if(S.length===0)return;const x=S[0];if(!x)return;const I=x.columns?.[0]?.name||"id";n(N=>[...N,{table:x.name,column:I}]),_()},L=S=>{n(x=>x.filter((I,N)=>N!==S)),_()},E=(S,x)=>{n(I=>I.map((N,C)=>{if(C===S){const A={...N,...x};return x.hasOwnProperty("aggregate")&&x.aggregate===void 0&&delete A.aggregate,x.hasOwnProperty("alias")&&x.alias===void 0&&delete A.alias,A}return N})),_()},k=()=>{const S=b();if(S.length<2)return;const x=S[0],I=S[1];if(!x||!I)return;const N=x.columns?.[0]?.name||"id",C=I.columns?.[0]?.name||"id",A={id:Date.now().toString(),leftTable:x.name,leftColumn:N,rightTable:I.name,rightColumn:C,joinType:"INNER"};i(V=>[...V,A]),_()},R=S=>{i(x=>x.filter(I=>I.id!==S)),_()},M=(S,x)=>{i(I=>I.map(N=>N.id===S?{...N,...x}:N)),_()},U=()=>{const S=b();if(S.length===0)return;const x=S[0];if(!x)return;const I=x.columns?.[0]?.name||"id",N={id:Date.now().toString(),table:x.name,column:I,operator:"=",value:"",logicalOperator:"AND"};a(C=>[...C,N]),_()},O=S=>{a(x=>x.filter(I=>I.id!==S)),_()},p=(S,x)=>{a(I=>I.map(N=>N.id===S?{...N,...x}:N)),_()};return(()=>{var S=Ja(),x=S.firstChild,I=x.firstChild,N=I.firstChild,C=x.nextSibling,A=C.firstChild,V=A.firstChild,B=V.nextSibling,H=A.nextSibling,ee=C.nextSibling,W=ee.firstChild,J=W.firstChild,q=J.nextSibling,oe=W.nextSibling,pe=ee.nextSibling,he=pe.firstChild,te=he.nextSibling,ie=te.firstChild,se=ie.firstChild,de=se.nextSibling;return N.addEventListener("change",X=>{m(X.currentTarget.checked),_()}),B.$$click=T,s(H,d(ae,{get each(){return t()},children:(X,Y)=>(()=>{var ce=Va(),fe=ce.firstChild,_e=fe.nextSibling,ge=_e.nextSibling,ve=ge.nextSibling,ne=ve.nextSibling,ue=ne.nextSibling;return fe.addEventListener("change",w=>{const F=b().find(K=>K.name===w.currentTarget.value)?.columns?.[0]?.name||"id";E(Y(),{table:w.currentTarget.value,column:F})}),s(fe,d(ae,{get each(){return b()},children:w=>(()=>{var D=Xe();return s(D,()=>w.name),P(()=>D.value=w.name),D})()})),ge.addEventListener("change",w=>E(Y(),{column:w.currentTarget.value})),s(ge,d(ae,{get each(){return u(X.table)},children:w=>(()=>{var D=Wa(),Q=D.firstChild,F=Q.nextSibling;return F.nextSibling,s(D,()=>w.name,Q),s(D,()=>w.data_type,F),P(()=>D.value=w.name),D})()})),ve.addEventListener("change",w=>{const D=w.currentTarget.value;D===""?E(Y(),{aggregate:void 0}):E(Y(),{aggregate:D})}),ne.$$input=w=>{const D=w.currentTarget.value;D===""?E(Y(),{alias:void 0}):E(Y(),{alias:D})},ue.$$click=()=>L(Y()),P(w=>{var D=e.disabled,Q=e.disabled,F=e.disabled,K=e.disabled,le=e.disabled;return D!==w.e&&(fe.disabled=w.e=D),Q!==w.t&&(ge.disabled=w.t=Q),F!==w.a&&(ve.disabled=w.a=F),K!==w.o&&(ne.disabled=w.o=K),le!==w.i&&(ue.disabled=w.i=le),w},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),P(()=>fe.value=X.table),P(()=>ge.value=X.column),P(()=>ve.value=X.aggregate||""),P(()=>ne.value=X.alias||""),ce})()}),null),s(H,d(z,{get when(){return t().length===0},get children(){var X=Qa(),Y=X.firstChild,ce=Y.nextSibling;return ce.$$click=$,P(()=>ce.disabled=e.disabled),X}}),null),s(S,d(z,{get when(){return b().length>1},get children(){var X=Ha(),Y=X.firstChild,ce=Y.firstChild,fe=ce.nextSibling,_e=Y.nextSibling;return fe.$$click=k,s(_e,d(ae,{get each(){return l()},children:ge=>(()=>{var ve=Ga(),ne=ve.firstChild,ue=ne.nextSibling,w=ue.firstChild,D=w.nextSibling,Q=D.nextSibling,F=Q.nextSibling,K=F.nextSibling,le=ue.nextSibling;return ne.addEventListener("change",Z=>M(ge.id,{joinType:Z.currentTarget.value})),w.addEventListener("change",Z=>M(ge.id,{leftTable:Z.currentTarget.value})),s(w,d(ae,{get each(){return b()},children:Z=>(()=>{var $e=Xe();return s($e,()=>Z.name),P(()=>$e.value=Z.name),$e})()})),D.addEventListener("change",Z=>M(ge.id,{leftColumn:Z.currentTarget.value})),s(D,d(ae,{get each(){return u(ge.leftTable)},children:Z=>(()=>{var $e=Xe();return s($e,()=>Z.name),P(()=>$e.value=Z.name),$e})()})),F.addEventListener("change",Z=>M(ge.id,{rightTable:Z.currentTarget.value})),s(F,d(ae,{get each(){return b()},children:Z=>(()=>{var $e=Xe();return s($e,()=>Z.name),P(()=>$e.value=Z.name),$e})()})),K.addEventListener("change",Z=>M(ge.id,{rightColumn:Z.currentTarget.value})),s(K,d(ae,{get each(){return u(ge.rightTable)},children:Z=>(()=>{var $e=Xe();return s($e,()=>Z.name),P(()=>$e.value=Z.name),$e})()})),le.$$click=()=>R(ge.id),P(Z=>{var $e=e.disabled,Ee=e.disabled,xe=e.disabled,Ae=e.disabled,Pe=e.disabled,qe=e.disabled;return $e!==Z.e&&(ne.disabled=Z.e=$e),Ee!==Z.t&&(w.disabled=Z.t=Ee),xe!==Z.a&&(D.disabled=Z.a=xe),Ae!==Z.o&&(F.disabled=Z.o=Ae),Pe!==Z.i&&(K.disabled=Z.i=Pe),qe!==Z.n&&(le.disabled=Z.n=qe),Z},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),P(()=>ne.value=ge.joinType),P(()=>w.value=ge.leftTable),P(()=>D.value=ge.leftColumn),P(()=>F.value=ge.rightTable),P(()=>K.value=ge.rightColumn),ve})()})),P(()=>fe.disabled=e.disabled),X}}),ee),q.$$click=U,s(oe,d(ae,{get each(){return r()},children:(X,Y)=>(()=>{var ce=Xa(),fe=ce.firstChild,_e=fe.nextSibling,ge=_e.nextSibling,ve=ge.nextSibling;return s(ce,d(z,{get when(){return Y()>0},get children(){var ne=Ka();return ne.addEventListener("change",ue=>p(X.id,{logicalOperator:ue.currentTarget.value})),P(()=>ne.disabled=e.disabled),P(()=>ne.value=X.logicalOperator),ne}}),fe),fe.addEventListener("change",ne=>p(X.id,{table:ne.currentTarget.value})),s(fe,d(ae,{get each(){return b()},children:ne=>(()=>{var ue=Xe();return s(ue,()=>ne.name),P(()=>ue.value=ne.name),ue})()})),_e.addEventListener("change",ne=>p(X.id,{column:ne.currentTarget.value})),s(_e,d(ae,{get each(){return u(X.table)},children:ne=>(()=>{var ue=Xe();return s(ue,()=>ne.name),P(()=>ue.value=ne.name),ue})()})),ge.addEventListener("change",ne=>p(X.id,{operator:ne.currentTarget.value})),s(ce,d(z,{get when(){return!["IS NULL","IS NOT NULL"].includes(X.operator)},get children(){var ne=Ya();return ne.$$input=ue=>p(X.id,{value:ue.currentTarget.value}),P(ue=>{var w=X.operator==="IN"?"值1,值2,值3":"值",D=e.disabled;return w!==ue.e&&j(ne,"placeholder",ue.e=w),D!==ue.t&&(ne.disabled=ue.t=D),ue},{e:void 0,t:void 0}),P(()=>ne.value=X.value),ne}}),ve),ve.$$click=()=>O(X.id),P(ne=>{var ue=e.disabled,w=e.disabled,D=e.disabled,Q=e.disabled;return ue!==ne.e&&(fe.disabled=ne.e=ue),w!==ne.t&&(_e.disabled=ne.t=w),D!==ne.a&&(ge.disabled=ne.a=D),Q!==ne.o&&(ve.disabled=ne.o=Q),ne},{e:void 0,t:void 0,a:void 0,o:void 0}),P(()=>fe.value=X.table),P(()=>_e.value=X.column),P(()=>ge.value=X.operator),ce})()})),de.$$input=X=>{const Y=parseInt(X.currentTarget.value)||void 0;f(Y),_()},P(X=>{var Y=e.disabled,ce=e.disabled,fe=e.disabled,_e=e.disabled;return Y!==X.e&&(N.disabled=X.e=Y),ce!==X.t&&(B.disabled=X.t=ce),fe!==X.a&&(q.disabled=X.a=fe),_e!==X.o&&(de.disabled=X.o=_e),X},{e:void 0,t:void 0,a:void 0,o:void 0}),P(()=>N.checked=h()),P(()=>de.value=c()||""),S})()}De(["click","input"]);var eo=v('<button class="action-btn close-btn"title=关闭预览>✕'),to=v("<table class=result-table><thead><tr></tr></thead><tbody>"),no=v("<div class=pagination><div class=pagination-info>显示 <!> - <!>/ <!> 行</div><div class=pagination-controls><select><option value=10>10行/页</option><option value=25>25行/页</option><option value=50>50行/页</option><option value=100>100行/页</option></select><div class=page-buttons><button>首页</button><button>上一页</button><span class=page-info> / </span><button>下一页</button><button>末页"),lo=v(`<div class=query-preview><div class=preview-header><div class=header-info><h4>📊 查询结果预览</h4><div class=result-stats><span class=stat-item>📋 <!> 行数据</span><span class=stat-item>📊 <!> 列</span><span class=stat-item>⏱️ <!>ms</span></div></div><div class=header-actions><button class="action-btn export-btn"title=导出为CSV文件>📤 导出CSV</button></div></div><div class=query-info><details><summary>🔍 查询详情</summary><div class=query-details><div class=query-sql><strong>SQL查询:</strong><pre class=sql-code></pre></div><div class=query-metadata><div class=metadata-item><strong>执行时间:</strong> <!>ms</div><div class=metadata-item><strong>返回行数:</strong> </div><div class=metadata-item><strong>列数量:</strong> </div></div></div></details></div><div class=table-container></div><style>
        .query-preview {
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          overflow: hidden;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .preview-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          padding: 16px;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
        }

        .header-info h4 {
          margin: 0 0 8px 0;
          color: #2c3e50;
        }

        .result-stats {
          display: flex;
          gap: 16px;
          font-size: 13px;
        }

        .stat-item {
          color: #6c757d;
        }

        .header-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border: 1px solid #ced4da;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s;
        }

        .export-btn:hover {
          background: #28a745;
          color: white;
          border-color: #28a745;
        }

        .close-btn:hover {
          background: #dc3545;
          color: white;
          border-color: #dc3545;
        }

        .query-info {
          padding: 12px 16px;
          border-bottom: 1px solid #e9ecef;
        }

        .query-details {
          margin-top: 8px;
        }

        .query-sql {
          margin-bottom: 12px;
        }

        .sql-code {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px;
          font-family: 'Monaco', 'Consolas', monospace;
          font-size: 12px;
          overflow-x: auto;
          margin: 4px 0;
        }

        .query-metadata {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
          font-size: 13px;
        }

        .metadata-item {
          color: #495057;
        }

        .table-container {
          overflow: auto;
          max-height: 500px;
        }

        .result-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .result-table th {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 8px 12px;
          text-align: left;
          font-weight: 600;
          position: sticky;
          top: 0;
          z-index: 1;
        }

        .result-table th.sortable {
          cursor: pointer;
          user-select: none;
        }

        .result-table th.sortable:hover {
          background: #e9ecef;
        }

        .column-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .sort-indicator {
          opacity: 0.5;
          font-size: 12px;
        }

        .result-table th.sorted-asc .sort-indicator,
        .result-table th.sorted-desc .sort-indicator {
          opacity: 1;
          color: #007bff;
        }

        .result-table td {
          border: 1px solid #dee2e6;
          padding: 6px 12px;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .result-table tr.even {
          background: #f8f9fa;
        }

        .result-table tr:hover {
          background: #e3f2fd;
        }

        .cell-null {
          color: #6c757d;
          font-style: italic;
        }

        .cell-boolean {
          text-align: center;
          font-weight: bold;
        }

        .cell-integer, .cell-float {
          text-align: right;
          font-family: 'Monaco', 'Consolas', monospace;
        }

        .cell-datetime {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #6f42c1;
        }

        .cell-object {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #e83e8c;
        }

        .empty-result {
          text-align: center;
          padding: 40px 20px;
          color: #6c757d;
        }

        .empty-icon {
          font-size: 48px;
          margin-bottom: 16px;
        }

        .empty-text {
          font-size: 18px;
          font-weight: 500;
          margin-bottom: 8px;
        }

        .empty-hint {
          font-size: 14px;
        }

        .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          background: #f8f9fa;
          border-top: 1px solid #dee2e6;
          font-size: 13px;
        }

        .pagination-controls {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .page-buttons {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .page-buttons button {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          background: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }

        .page-buttons button:hover:not(:disabled) {
          background: #e9ecef;
        }

        .page-buttons button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .page-info {
          margin: 0 8px;
          font-weight: 500;
        }

        details summary {
          cursor: pointer;
          font-weight: 500;
          color: #495057;
        }

        details[open] summary {
          margin-bottom: 8px;
        }
      `),io=v("<div class=empty-result><div class=empty-icon>📭</div><div class=empty-text>查询未返回任何数据</div><div class=empty-hint>请检查查询条件或数据源"),ro=v("<th><div class=column-header><span class=column-name></span><span class=sort-indicator>"),so=v("<tr>"),ao=v("<td>");function oo(e){const[t,n]=G(1),[l,i]=G(10),[r,a]=G(null),[o,g]=G("asc"),c=we(()=>{let u=[...e.result.rows];if(r()){const $=r();u.sort((T,L)=>{const E=T[$],k=L[$];if(E==null)return 1;if(k==null)return-1;const R=String(E).localeCompare(String(k),void 0,{numeric:!0});return o()==="asc"?R:-R})}const y=(t()-1)*l(),_=y+l();return{data:u.slice(y,_),totalPages:Math.ceil(u.length/l()),totalRows:u.length}}),f=u=>{r()===u?g(y=>y==="asc"?"desc":"asc"):(a(u),g("asc"))},h=u=>{if(u==null)return"";if(typeof u=="object")return JSON.stringify(u);if(typeof u=="boolean")return u?"✓":"✗";if(typeof u=="number")return Number.isInteger(u)?u.toLocaleString():u.toFixed(2);const y=String(u);if(y.match(/^\d{4}-\d{2}-\d{2}/)||y.includes("T"))try{const _=new Date(y);if(!isNaN(_.getTime()))return _.toLocaleString("zh-CN")}catch{}return y.length>50?y.substring(0,47)+"...":y},m=u=>{if(u==null)return"null";if(typeof u=="boolean")return"boolean";if(typeof u=="number")return Number.isInteger(u)?"integer":"float";if(typeof u=="object")return"object";const y=String(u);if(y.match(/^\d{4}-\d{2}-\d{2}/)||y.includes("T"))try{const _=new Date(y);if(!isNaN(_.getTime()))return"datetime"}catch{}return"string"},b=()=>{const u=e.result.columns.join(","),y=e.result.rows.map(E=>e.result.columns.map(k=>{const R=E[k],M=h(R);return M.includes(",")||M.includes('"')||M.includes(`
`)?`"${M.replace(/"/g,'""')}"`:M}).join(",")).join(`
`),_=u+`
`+y,$=new Blob([_],{type:"text/csv;charset=utf-8;"}),T=document.createElement("a"),L=URL.createObjectURL($);T.setAttribute("href",L),T.setAttribute("download",`query_result_${Date.now()}.csv`),document.body.appendChild(T),T.click(),document.body.removeChild(T)};return(()=>{var u=lo(),y=u.firstChild,_=y.firstChild,$=_.firstChild,T=$.nextSibling,L=T.firstChild,E=L.firstChild,k=E.nextSibling;k.nextSibling;var R=L.nextSibling,M=R.firstChild,U=M.nextSibling;U.nextSibling;var O=R.nextSibling,p=O.firstChild,S=p.nextSibling;S.nextSibling;var x=_.nextSibling,I=x.firstChild,N=y.nextSibling,C=N.firstChild,A=C.firstChild,V=A.nextSibling,B=V.firstChild,H=B.firstChild,ee=H.nextSibling,W=B.nextSibling,J=W.firstChild,q=J.firstChild,oe=q.nextSibling,pe=oe.nextSibling;pe.nextSibling;var he=J.nextSibling,te=he.firstChild;te.nextSibling;var ie=he.nextSibling,se=ie.firstChild;se.nextSibling;var de=N.nextSibling,X=de.nextSibling;return s(L,()=>e.result.totalCount??e.result.total_rows,k),s(R,()=>e.result.columns.length,U),s(O,()=>e.result.execution_time,S),I.$$click=b,s(x,d(z,{get when(){return e.onClose},get children(){var Y=eo();return Te(Y,"click",e.onClose),Y}}),null),s(ee,()=>e.result.query),s(J,()=>e.result.execution_time,pe),s(he,()=>e.result.totalCount??e.result.total_rows,null),s(ie,()=>e.result.columns.length,null),s(de,d(z,{get when(){return e.result.rows.length>0},get fallback(){return io()},get children(){var Y=to(),ce=Y.firstChild,fe=ce.firstChild,_e=ce.nextSibling;return s(fe,d(ae,{get each(){return e.result.columns},children:ge=>(()=>{var ve=ro(),ne=ve.firstChild,ue=ne.firstChild,w=ue.nextSibling;return ve.$$click=()=>f(ge),j(ve,"title",`点击排序 ${ge}`),s(ue,ge),s(w,(()=>{var D=be(()=>r()===ge);return()=>D()?o()==="asc"?"↑":"↓":"↕"})()),P(()=>me(ve,`sortable ${r()===ge?`sorted-${o()}`:""}`)),ve})()})),s(_e,d(ae,{get each(){return c().data},children:(ge,ve)=>(()=>{var ne=so();return s(ne,d(ae,{get each(){return e.result.columns},children:ue=>(()=>{var w=ao();return s(w,()=>h(ge[ue])),P(D=>{var Q=`cell-${m(ge[ue])}`,F=`${ue}: ${h(ge[ue])}`;return Q!==D.e&&me(w,D.e=Q),F!==D.t&&j(w,"title",D.t=F),D},{e:void 0,t:void 0}),w})()})),P(()=>me(ne,ve()%2===0?"even":"odd")),ne})()})),Y}})),s(u,d(z,{get when(){return c().totalPages>1},get children(){var Y=no(),ce=Y.firstChild,fe=ce.firstChild,_e=fe.nextSibling,ge=_e.nextSibling,ve=ge.nextSibling,ne=ve.nextSibling,ue=ne.nextSibling;ue.nextSibling;var w=ce.nextSibling,D=w.firstChild,Q=D.nextSibling,F=Q.firstChild,K=F.nextSibling,le=K.nextSibling,Z=le.firstChild,$e=le.nextSibling,Ee=$e.nextSibling;return s(ce,()=>(t()-1)*l()+1,_e),s(ce,()=>Math.min(t()*l(),c().totalRows),ve),s(ce,()=>c().totalRows,ue),D.addEventListener("change",xe=>{i(parseInt(xe.currentTarget.value)),n(1)}),F.$$click=()=>n(1),K.$$click=()=>n(xe=>Math.max(1,xe-1)),s(le,t,Z),s(le,()=>c().totalPages,null),$e.$$click=()=>n(xe=>Math.min(c().totalPages,xe+1)),Ee.$$click=()=>n(c().totalPages),P(xe=>{var Ae=t()===1,Pe=t()===1,qe=t()===c().totalPages,Ye=t()===c().totalPages;return Ae!==xe.e&&(F.disabled=xe.e=Ae),Pe!==xe.t&&(K.disabled=xe.t=Pe),qe!==xe.a&&($e.disabled=xe.a=qe),Ye!==xe.o&&(Ee.disabled=xe.o=Ye),xe},{e:void 0,t:void 0,a:void 0,o:void 0}),P(()=>D.value=l()),Y}}),X),u})()}De(["click"]);var co=v("<span>通过可视化界面构建查询，适合初学者使用"),uo=v("<span>直接编写SQL语句，适合有经验的用户"),go=v("<div class=error-message>❌ "),ho=v("<div class=validation-errors><strong>错误:</strong><ul>"),fo=v("<div class=validation-warnings><strong>警告:</strong><ul>"),vo=v("<div class=validation-suggestions><strong>建议:</strong><ul>"),mo=v("<div><div class=validation-header><span class=validation-status></span><span class=security-status>"),bo=v('<div class=sql-query-builder><div class=query-mode-selector><div class=mode-tabs><button>🎯 可视化构建</button><button>💻 自定义SQL</button></div><div class=mode-description></div></div><div class=query-content></div><div class=query-preview-section><div class=preview-header><h4>📋 SQL查询预览</h4><div class=preview-actions><button class="action-btn format-btn"title=格式化SQL代码>🎨 格式化</button><button class="action-btn validate-btn"title=验证SQL语法>✓ 验证语法</button><button class="action-btn copy-btn"title=复制SQL到剪贴板>📋 复制</button><button class="action-btn execute-btn"title=执行查询预览></button></div></div><div class=sql-display><pre class=sql-code><code></code></pre></div></div><div class=query-help><details><summary>💡 查询构建帮助</summary><div class=help-content><div class=help-section><h5>可视化构建:</h5><ul><li>选择表和字段来自动生成查询</li><li>支持JOIN关联、WHERE条件、ORDER BY排序</li><li>适合SQL初学者使用</li></ul></div><div class=help-section><h5>自定义SQL:</h5><ul><li>直接编写SQL语句，支持复杂查询</li><li>提供语法验证和格式化功能</li><li>适合有经验的用户</li></ul></div><div class=help-section><h5>安全提示:</h5><ul><li>系统会自动检测SQL注入风险</li><li>预览查询限制返回行数，避免性能问题</li><li>建议先验证语法，再执行预览'),Ut=v("<li>");function po(e){const[t,n]=G("visual"),[l,i]=G(!1),[r,a]=G(null),[o,g]=G(null),[c,f]=G(null),[h,m]=G(""),b=we(()=>t()==="visual"?h():e.sql),u=we(()=>o()),y=async()=>{const E=b().trim();if(!E){g(null),e.onValidationChange(null);return}try{if(i(!0),a(null),console.log("🔍 验证SQL语法:",E),console.log("🔍 SQLQueryBuilder config对象:",e.config),console.log("🔍 config对象的键:",Object.keys(e.config)),console.log("🔍 database_type字段:",e.config.database_type),["database_type","databaseType","dbType","type"].forEach(M=>{e.config[M]&&console.log(`🔍 找到字段 ${M}:`,e.config[M])}),!e.config.database_type)throw new Error(`database_type字段缺失，config内容: ${JSON.stringify(e.config)}`);const R=await Se.validateSqlSyntax(E,e.config.database_type);g(R),e.onValidationChange(R),console.log("✅ SQL验证结果:",R)}catch(k){console.error("❌ SQL验证失败:",k);const R={valid:!1,errors:[`验证失败: ${k}`],warnings:[],suggestions:[],is_safe:!1,security_issues:["无法验证查询安全性"]};g(R),e.onValidationChange(R),a(`SQL验证失败: ${k}`)}finally{i(!1)}},_=async()=>{const E=b().trim();if(E)try{i(!0),a(null),console.log("🎨 格式化SQL:",E);const k=await Se.formatSql(E,e.config.database_type);t()==="visual"?m(k):e.onSQLChange(k),console.log("✅ SQL格式化完成")}catch(k){console.error("❌ SQL格式化失败:",k),a(`格式化失败: ${k}`)}finally{i(!1)}},$=async()=>{const E=b().trim();if(!E){a("请输入SQL查询语句");return}try{i(!0),a(null),console.log("▶️ 执行查询预览:",E),await y();const k=o();if(k&&!k.valid){a("SQL语法验证失败，请修正后重试");return}const R=await Se.executeDatabasePreview(e.config,E,50);f(R),e.onQueryResult(R),console.log("✅ 查询预览成功:",R)}catch(k){console.error("❌ 查询预览失败:",k),a(`查询执行失败: ${k}`),f(null),e.onQueryResult(null)}finally{i(!1)}},T=async()=>{const E=b();if(E)try{await navigator.clipboard.writeText(E),console.log("📋 SQL已复制到剪贴板")}catch(k){console.error("❌ 复制失败:",k),a(`复制失败: ${k}`)}},L=E=>{n(E),a(null),E==="custom"&&h()&&e.onSQLChange(h())};return(()=>{var E=bo(),k=E.firstChild,R=k.firstChild,M=R.firstChild,U=M.nextSibling,O=R.nextSibling,p=k.nextSibling,S=p.nextSibling,x=S.firstChild,I=x.firstChild,N=I.nextSibling,C=N.firstChild,A=C.nextSibling,V=A.nextSibling,B=V.nextSibling,H=x.nextSibling,ee=H.firstChild,W=ee.firstChild;return M.$$click=()=>L("visual"),U.$$click=()=>L("custom"),s(O,d(z,{get when(){return t()==="visual"},get children(){return co()}}),null),s(O,d(z,{get when(){return t()==="custom"},get children(){return uo()}}),null),s(E,d(z,{get when(){return r()},get children(){var J=go();return J.firstChild,s(J,r,null),J}}),p),s(p,d(z,{get when(){return t()==="visual"},get children(){return d(Za,{get selectedTables(){return e.selectedTables},get schema(){return e.schema},onQueryChange:m,get disabled(){return l()}})}}),null),s(p,d(z,{get when(){return t()==="custom"},get children(){return d(ja,{get sql(){return e.sql},get onSQLChange(){return e.onSQLChange},get databaseType(){return e.config.database_type},get disabled(){return l()}})}}),null),C.$$click=_,A.$$click=y,V.$$click=T,B.$$click=$,s(B,()=>l()?"⏳ 执行中...":"▶️ 预览查询"),s(W,()=>b()||"-- 请构建或输入SQL查询语句"),s(S,d(z,{get when(){return u()},get children(){var J=mo(),q=J.firstChild,oe=q.firstChild,pe=oe.nextSibling;return s(oe,()=>u().valid?"✅ 语法正确":"❌ 语法错误"),s(pe,()=>u().is_safe?"🔒 查询安全":"⚠️ 安全警告"),s(J,d(z,{get when(){return be(()=>!!u().errors)()&&u().errors.length>0},get children(){var he=ho(),te=he.firstChild,ie=te.nextSibling;return s(ie,d(ae,{get each(){return u().errors},children:se=>(()=>{var de=Ut();return s(de,se),de})()})),he}}),null),s(J,d(z,{get when(){return be(()=>!!u()?.warnings)()&&u().warnings.length>0},get children(){var he=fo(),te=he.firstChild,ie=te.nextSibling;return s(ie,d(ae,{get each(){return u().warnings},children:se=>(()=>{var de=Ut();return s(de,se),de})()})),he}}),null),s(J,d(z,{get when(){return be(()=>!!u()?.suggestions)()&&u().suggestions.length>0},get children(){var he=vo(),te=he.firstChild,ie=te.nextSibling;return s(ie,d(ae,{get each(){return u().suggestions},children:se=>(()=>{var de=Ut();return s(de,se),de})()})),he}}),null),P(()=>me(J,`validation-result ${u()?.valid?"valid":"invalid"}`)),J}}),null),s(S,d(z,{get when(){return c()},get children(){return d(oo,{get result(){return c()},onClose:()=>{f(null),e.onQueryResult(null)}})}}),null),P(J=>{var q=`mode-tab ${t()==="visual"?"active":""}`,oe=l(),pe=`mode-tab ${t()==="custom"?"active":""}`,he=l(),te=l()||!b(),ie=l()||!b(),se=l()||!b(),de=l()||!b();return q!==J.e&&me(M,J.e=q),oe!==J.t&&(M.disabled=J.t=oe),pe!==J.a&&me(U,J.a=pe),he!==J.o&&(U.disabled=J.o=he),te!==J.i&&(C.disabled=J.i=te),ie!==J.n&&(A.disabled=J.n=ie),se!==J.s&&(V.disabled=J.s=se),de!==J.h&&(B.disabled=J.h=de),J},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),E})()}De(["click"]);var yo=v("<div class=error-messages>"),$o=v("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>处理中..."),_o=v('<div class=form-row><div class="form-group flex-2"><label>主机地址</label><input type=text placeholder=localhost></div><div class="form-group flex-1"><label>端口</label><input type=number>'),xo=v("<div class=form-group><label>数据库文件路径</label><input type=text placeholder=/path/to/database.db>"),So=v("<div class=form-group><label>数据库名</label><input type=text placeholder=myapp_production>"),wo=v("<div class=form-row><div class=form-group><label>用户名</label><input type=text></div><div class=form-group><label>密码</label><input type=password>"),Fn=v("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Co=v("<div class=connection-step><div class=step-header><h4>🔌 数据库连接配置</h4><p>请填写数据库连接信息</p></div><div class=form-section><div class=form-group><label>数据库类型</label><select><option value=mysql>MySQL</option><option value=postgresql>PostgreSQL</option><option value=sqlite>SQLite</option><option value=sqlserver>SQL Server</option><option value=oracle>Oracle</option></select></div><div class=connection-test><button class=test-connection-btn>"),ko=v("<div class=schema-loading><button class=load-schema-btn>🔄 加载表结构</button><p class=loading-hint>点击按钮加载数据库的表结构信息"),To=v("<div class=views-section><h5>👁️ 数据视图列表</h5><div class=views-list>"),Eo=v("<div class=schema-content><div class=schema-summary><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>表数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>视图数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>加载时间:</span><span class=summary-value></span></div></div><div class=tables-section><h5>📋 数据表列表</h5><div class=tables-grid>"),Lo=v("<div class=schema-step><div class=step-header><h4>🗂️ 数据库表结构</h4><p>选择要查询的数据表和字段"),Do=v('<div class=database-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>🗄️ 创建数据库数据源</h3><p>连接数据库并配置查询语句</p></div></div><div class=wizard-progress><div><div class=step-indicator>1</div><div class=step-info><div class=step-title>数据库连接</div><div class=step-description>配置连接信息</div></div></div><div><div class=step-indicator>2</div><div class=step-info><div class=step-title>表结构</div><div class=step-description>选择数据表</div></div></div><div><div class=step-indicator>3</div><div class=step-info><div class=step-title>查询构建</div><div class=step-description>编写SQL查询</div></div></div><div><div class=step-indicator>4</div><div class=step-info><div class=step-title>预览保存</div><div class=step-description>测试并保存</div></div></div></div><div class=wizard-content></div><div class=wizard-controls><div class=control-buttons><button class="control-btn back-btn">← 上一步</button><button class="control-btn next-btn">下一步 →'),Po=v("<div class=error-message>❌ "),Ro=v("<span class=view-comment>"),Ao=v("<div class=view-item><div class=view-info><span class=view-name></span><span class=view-schema>"),zo=v("<div class=table-comment>"),Oo=v("<div class=more-columns>+<!> 个字段..."),Mo=v("<span class=more-indexes>+"),No=v("<div class=table-indexes><h6>索引 (<!>)</h6><div class=indexes-list>"),Io=v("<span class=more-relations>+"),Fo=v("<div class=table-relations><h6>关联 (<!>)</h6><div class=relations-list>"),Uo=v("<div><div class=table-card-header><div class=table-card-title><label class=table-checkbox><input type=checkbox><span class=table-name>📋 </span></label></div><div class=table-card-stats><span class=row-count title=预估行数> 行</span><span class=table-size title=预估大小></span></div></div><div class=table-columns><h6>字段 (<!>)</h6><div class=columns-preview>"),qo=v("<span class=pk-badge title=主键>🔑"),Bo=v("<span class=fk-badge title=外键>🔗"),jo=v("<div class=column-item><span class=column-icon></span><span class=column-name></span><span class=column-type>"),Qo=v("<span> "),Ho=v("<span class=relation-badge>🔗 "),Jo=v('<div class=preview-step><div class=step-header><h4>👁️ 预览和保存</h4><p>验证配置、预览数据并保存数据源</p></div><div class=basic-info-section><h5>📝 基本信息</h5><div class=form-row><div class="form-group flex-2"><label>数据源名称 *</label><input type=text placeholder=输入数据源名称... required></div><div class="form-group flex-1"><label>标签</label><input type=text placeholder="标签1, 标签2"></div></div><div class=form-group><label>描述</label><textarea placeholder=描述这个数据源的用途... rows=3>'),Vo=v("<div class=config-summary><h5>⚙️ 配置摘要</h5><div class=summary-grid><div class=summary-item><span class=summary-label>数据库类型:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>连接地址:</span><span class=summary-value>:</span></div><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>用户名:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>选中表:</span><span class=summary-value> 个表</span></div><div class=summary-item><span class=summary-label>查询长度:</span><span class=summary-value> 字符</span></div></div><div class=sql-preview><h6>SQL查询预览:</h6><pre class=sql-code>"),Wo=v("<div class=validation-warnings><h6>⚠️ 警告"),Go=v("<div class=validation-errors><h6>❌ 错误"),Ko=v("<div class=validation-suggestions><h6>💡 建议"),Yo=v("<div class=validation-results><div class=validation-checks>"),Xo=v("<div class=validation-section><div class=section-header><h5>✅ 验证状态</h5><button class=validate-btn>"),Zo=v("<div class=warning-item>"),ec=v("<div class=error-item>"),tc=v("<div class=suggestion-item>"),nc=v("<div><span class=check-icon></span><span class=check-label></span><span>"),lc=v("<div class=no-data>没有查询到数据"),ic=v("<div class=preview-results><div class=preview-stats><div class=stat-item><span class=stat-label>样本行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>预估总行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>执行时间:</span><span class=stat-value>ms</span></div></div><div class=preview-data>"),rc=v("<div class=data-preview-section><div class=section-header><h5>📊 数据预览</h5><button class=preview-btn>"),sc=v("<div class=no-data>没有数据"),ac=v("<div class=table-footer>显示前10行，共 <!> 行数据"),oc=v("<div class=data-table-container><table class=data-table><thead><tr></tr></thead><tbody>"),cc=v("<th>"),dc=v("<tr>"),uc=v("<td>"),gc=v('<div class=save-requirements><div class=requirements-header>❗ 保存要求检查：</div><div class=requirements-list><div class=requirement-item>数据源名称: <!> "<!>"</div><div class=requirement-item>自定义SQL: <!> </div><div class=requirement-item>测试连接: <!> </div><div class=requirement-item>保存状态: </div></div><div class=requirements-note>'),hc=v("<div class=result-details><div class=detail-item><span class=detail-label>数据源ID:</span><span class=detail-value>"),fc=v("<div class=result-warnings>"),vc=v("<div class=result-errors>"),mc=v("<div class=save-requirements><h6>保存前需要完成:</h6><ul><li>填写数据源名称</li><li>确保SQL查询有效</li><li>通过基本验证检查"),bc=v("<div class=save-section><div class=section-header><h5>💾 保存数据源</h5><button>"),pc=v("<div class=warning-item>⚠️ "),yc=v("<div class=error-item>❌ ");const $c={database_type:"mysql",host:"localhost",port:3306,database:"",username:"",password:"",ssl_enabled:!1,max_connections:10,min_connections:1,connection_timeout:30,idle_timeout:600,sql:"",use_custom_sql:!1,query_timeout:60,default_limit:1e3,enable_caching:!0,cache_ttl:300};function _c(e){const[t,n]=G({currentStep:"connection",name:"",description:"",tags:[],config:{...$c},schema:null,selectedTables:[],generatedSQL:"",customSQL:"",useCustomSQL:!1,testResult:null,queryResult:null,validation:null,dataSourceValidation:null,dataPreview:null,loading:!1,errors:[],isSaving:!1,saveResult:null}),l=we(()=>{const b=t();return{connection:b.testResult?.success||!1,schema:b.schema!==null&&b.selectedTables.length>0,query:b.customSQL.trim().length>0,preview:b.name.trim().length>0&&b.customSQL.trim().length>0}}),i=b=>{n(u=>({...u,...b}))},r=b=>{n(u=>({...u,config:{...u.config,...b}}))},a=async()=>{i({loading:!0,errors:[]});try{const b=await Se.testDatabaseConnection(t().config);i({testResult:b,loading:!1,errors:b.success?[]:[b.message]}),b.success&&setTimeout(()=>{i({currentStep:"schema"}),o()},1e3)}catch(b){i({loading:!1,errors:[`连接测试失败: ${b}`],testResult:{success:!1,message:String(b)}})}},o=async()=>{i({loading:!0,errors:[]});try{const b=await Se.loadDatabaseSchema(t().config);i({schema:b,loading:!1,errors:[]})}catch(b){i({loading:!1,errors:[`架构加载失败: ${b}`],schema:null})}},g=async()=>{i({loading:!0,errors:[]});try{const b={name:t().name,config:t().config,selected_tables:t().selectedTables,sql:t().customSQL,description:t().description,tags:t().tags,validate_before_save:!0},u=await Se.validateDataSourceBeforeSave(b);return i({dataSourceValidation:u,loading:!1,errors:u.errors}),u}catch(b){return i({loading:!1,errors:[`验证失败: ${b}`]}),null}},c=async()=>{i({loading:!0,errors:[]});try{const b=await Se.captureDataPreview(t().config,t().customSQL);return i({dataPreview:b,loading:!1}),b}catch(b){return i({loading:!1,errors:[`数据预览失败: ${b}`]}),null}},f=async()=>{i({isSaving:!0,errors:[]});try{console.log("🔍 DatabaseWizard 保存前状态:",{selectedTables:t().selectedTables,selectedTables_type:typeof t().selectedTables,selectedTables_length:t().selectedTables?.length,customSQL_length:t().customSQL?.length,name:t().name});const b={name:t().name,config:t().config,selected_tables:t().selectedTables,sql:t().customSQL,description:t().description,tags:t().tags,validate_before_save:!0,capture_schema_snapshot:!0,capture_data_preview:!0,preview_row_limit:10};console.log("🔍 构建的 SaveDataSourceRequest:",{selected_tables:b.selected_tables,selected_tables_type:typeof b.selected_tables,selected_tables_length:b.selected_tables?.length});const u=await Se.saveDataSource(b);return i({saveResult:u,isSaving:!1}),u.success&&setTimeout(()=>{e.onSuccess()},2e3),u}catch(b){return i({isSaving:!1,errors:[`保存失败: ${b}`]}),null}},h=b=>{i({currentStep:b})},m=()=>{switch(t().currentStep){case"schema":i({currentStep:"connection"});break;case"query":i({currentStep:"schema"});break;case"preview":i({currentStep:"query"});break;default:e.onBack()}};return(()=>{var b=Do(),u=b.firstChild,y=u.firstChild,_=u.nextSibling,$=_.firstChild,T=$.nextSibling,L=T.nextSibling,E=L.nextSibling,k=_.nextSibling,R=k.nextSibling,M=R.firstChild,U=M.firstChild,O=U.nextSibling;return y.$$click=m,$.$$click=()=>h("connection"),T.$$click=()=>l().connection&&h("schema"),L.$$click=()=>l().schema&&h("query"),E.$$click=()=>l().query&&h("preview"),s(k,d(z,{get when(){return t().errors.length>0},get children(){var p=yo();return s(p,d(ae,{get each(){return t().errors},children:S=>(()=>{var x=Po();return x.firstChild,s(x,S,null),x})()})),p}}),null),s(k,d(z,{get when(){return t().loading},get children(){return $o()}}),null),s(k,d(z,{get when(){return t().currentStep==="connection"},get children(){var p=Co(),S=p.firstChild,x=S.nextSibling,I=x.firstChild,N=I.firstChild,C=N.nextSibling,A=I.nextSibling,V=A.firstChild;return C.addEventListener("change",B=>{const H=B.currentTarget.value,ee={mysql:3306,postgresql:5432,sqlserver:1433,oracle:1521,sqlite:0}[H];r({database_type:H,port:ee})}),s(x,d(z,{get when(){return t().config.database_type!=="sqlite"},get children(){var B=_o(),H=B.firstChild,ee=H.firstChild,W=ee.nextSibling,J=H.nextSibling,q=J.firstChild,oe=q.nextSibling;return W.addEventListener("change",pe=>r({host:pe.currentTarget.value})),oe.addEventListener("change",pe=>r({port:parseInt(pe.currentTarget.value)||3306})),P(()=>W.value=t().config.host),P(()=>oe.value=t().config.port),B}}),A),s(x,d(z,{get when(){return t().config.database_type==="sqlite"},get children(){var B=xo(),H=B.firstChild,ee=H.nextSibling;return ee.addEventListener("change",W=>r({database:W.currentTarget.value})),P(()=>ee.value=t().config.database),B}}),A),s(x,d(z,{get when(){return t().config.database_type!=="sqlite"},get children(){return[(()=>{var B=So(),H=B.firstChild,ee=H.nextSibling;return ee.addEventListener("change",W=>r({database:W.currentTarget.value})),P(()=>ee.value=t().config.database),B})(),(()=>{var B=wo(),H=B.firstChild,ee=H.firstChild,W=ee.nextSibling,J=H.nextSibling,q=J.firstChild,oe=q.nextSibling;return W.addEventListener("change",pe=>r({username:pe.currentTarget.value})),oe.addEventListener("change",pe=>r({password:pe.currentTarget.value})),P(()=>W.value=t().config.username),P(()=>oe.value=t().config.password),B})()]}}),A),V.$$click=a,s(V,()=>t().loading?"⏳ 测试中...":"🔗 测试连接"),s(A,d(z,{get when(){return t().testResult},get children(){var B=Fn(),H=B.firstChild,ee=H.firstChild,W=ee.nextSibling;return s(ee,()=>t().testResult?.success?"✅":"❌"),s(W,()=>t().testResult?.message),P(()=>me(B,`test-result ${t().testResult?.success?"success":"error"}`)),B}}),null),P(()=>V.disabled=t().loading),P(()=>C.value=t().config.database_type),p}}),null),s(k,d(z,{get when(){return t().currentStep==="schema"},get children(){var p=Lo();return p.firstChild,s(p,d(z,{get when(){return be(()=>!t().schema)()&&!t().loading},get children(){var S=ko(),x=S.firstChild;return x.$$click=o,S}}),null),s(p,d(z,{get when(){return t().schema},get children(){var S=Eo(),x=S.firstChild,I=x.firstChild,N=I.firstChild,C=N.nextSibling,A=I.nextSibling,V=A.firstChild,B=V.nextSibling,H=A.nextSibling,ee=H.firstChild,W=ee.nextSibling,J=H.nextSibling,q=J.firstChild,oe=q.nextSibling,pe=x.nextSibling,he=pe.firstChild,te=he.nextSibling;return s(C,()=>t().schema?.database_name),s(B,()=>t().schema?.schemas[0]?.tables?.length||0),s(W,()=>t().schema?.schemas[0]?.views?.length||0),s(oe,()=>new Date(t().schema?.loaded_at||"").toLocaleString("zh-CN")),s(te,d(ae,{get each(){return t().schema?.schemas[0]?.tables||[]},children:ie=>d(xc,{table:ie,get selected(){return t().selectedTables.includes(ie.name)},onToggle:(se,de)=>{const X=t().selectedTables;i(de?{selectedTables:[...X,se]}:{selectedTables:X.filter(Y=>Y!==se)})}})})),s(S,d(z,{get when(){return be(()=>!!t().schema?.schemas[0]?.views)()&&t().schema.schemas[0].views.length>0},get children(){var ie=To(),se=ie.firstChild,de=se.nextSibling;return s(de,d(ae,{get each(){return t().schema?.schemas[0]?.views||[]},children:X=>(()=>{var Y=Ao(),ce=Y.firstChild,fe=ce.firstChild,_e=fe.nextSibling;return s(fe,()=>X.name),s(_e,()=>X.schema),s(Y,d(z,{get when(){return X.comment},get children(){var ge=Ro();return s(ge,()=>X.comment),ge}}),null),Y})()})),ie}}),null),S}}),null),p}}),null),s(k,d(z,{get when(){return t().currentStep==="query"},get children(){return d(po,{get selectedTables(){return t().selectedTables},get schema(){return t().schema},get config(){return t().config},get sql(){return t().customSQL},onSQLChange:p=>i({customSQL:p}),onQueryResult:p=>i({queryResult:p}),onValidationChange:p=>i({validation:p})})}}),null),s(k,d(z,{get when(){return t().currentStep==="preview"},get children(){return d(Sc,{get state(){return t()},onStateUpdate:i,onSave:f,onValidate:g,onPreviewData:c})}}),null),U.$$click=m,O.$$click=()=>{const p=t();p.currentStep==="connection"&&p.testResult?.success?(i({currentStep:"schema"}),p.schema||o()):p.currentStep==="schema"?i({currentStep:"query"}):p.currentStep==="query"&&i({currentStep:"preview"})},P(p=>{var S=`progress-step ${t().currentStep==="connection"?"active":""} ${l().connection?"completed":""}`,x=`progress-step ${t().currentStep==="schema"?"active":""} ${l().schema?"completed":""}`,I=`progress-step ${t().currentStep==="query"?"active":""} ${l().query?"completed":""}`,N=`progress-step ${t().currentStep==="preview"?"active":""} ${l().preview?"completed":""}`,C=t().loading;return S!==p.e&&me($,p.e=S),x!==p.t&&me(T,p.t=x),I!==p.a&&me(L,p.a=I),N!==p.o&&me(E,p.o=N),C!==p.i&&(O.disabled=p.i=C),p},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),b})()}function xc(e){const t=l=>l<1e3?l.toString():l<1e6?`${(l/1e3).toFixed(1)}K`:`${(l/1e6).toFixed(1)}M`,n=l=>{const i=l.toLowerCase();return i.includes("int")||i.includes("number")||i.includes("decimal")?"🔢":i.includes("varchar")||i.includes("text")||i.includes("char")?"📝":i.includes("date")||i.includes("time")?"📅":i.includes("bool")?"✅":"📋"};return(()=>{var l=Uo(),i=l.firstChild,r=i.firstChild,a=r.firstChild,o=a.firstChild,g=o.nextSibling;g.firstChild;var c=r.nextSibling,f=c.firstChild,h=f.firstChild,m=f.nextSibling,b=i.nextSibling,u=b.firstChild,y=u.firstChild,_=y.nextSibling;_.nextSibling;var $=u.nextSibling;return o.addEventListener("change",T=>e.onToggle(e.table.name,T.currentTarget.checked)),s(g,()=>e.table.name,null),s(f,()=>t(e.table.row_count_estimate),h),s(m,()=>e.table.size_estimate),s(l,d(z,{get when(){return e.table.comment},get children(){var T=zo();return s(T,()=>e.table.comment),T}}),b),s(u,()=>e.table.columns?.length||0,_),s($,d(ae,{get each(){return(e.table.columns||[]).slice(0,6)},children:T=>(()=>{var L=jo(),E=L.firstChild,k=E.nextSibling,R=k.nextSibling;return s(E,()=>n(T.data_type)),s(k,()=>T.name),s(R,()=>T.data_type),s(L,d(z,{get when(){return T.is_primary_key},get children(){return qo()}}),null),s(L,d(z,{get when(){return T.is_foreign_key},get children(){return Bo()}}),null),L})()}),null),s($,d(z,{get when(){return(e.table.columns?.length||0)>6},get children(){var T=Oo(),L=T.firstChild,E=L.nextSibling;return E.nextSibling,s(T,()=>(e.table.columns?.length||0)-6,E),T}}),null),s(l,d(z,{get when(){return e.table.indexes&&e.table.indexes.length>0},get children(){var T=No(),L=T.firstChild,E=L.firstChild,k=E.nextSibling;k.nextSibling;var R=L.nextSibling;return s(L,()=>e.table.indexes.length,k),s(R,d(ae,{get each(){return e.table.indexes.slice(0,3)},children:M=>(()=>{var U=Qo(),O=U.firstChild;return s(U,()=>M.unique?"🔐":"📇",O),s(U,()=>M.name,null),P(p=>{var S=`index-badge ${M.unique?"unique":""}`,x=M.columns.join(", ");return S!==p.e&&me(U,p.e=S),x!==p.t&&j(U,"title",p.t=x),p},{e:void 0,t:void 0}),U})()}),null),s(R,d(z,{get when(){return e.table.indexes.length>3},get children(){var M=Mo();return M.firstChild,s(M,()=>e.table.indexes.length-3,null),M}}),null),T}}),null),s(l,d(z,{get when(){return e.table.foreign_keys&&e.table.foreign_keys.length>0},get children(){var T=Fo(),L=T.firstChild,E=L.firstChild,k=E.nextSibling;k.nextSibling;var R=L.nextSibling;return s(L,()=>e.table.foreign_keys.length,k),s(R,d(ae,{get each(){return e.table.foreign_keys.slice(0,2)},children:M=>(()=>{var U=Ho();return U.firstChild,s(U,()=>M.referenced_table,null),P(()=>j(U,"title",`${M.column_name} → ${M.referenced_table}.${M.referenced_column}`)),U})()}),null),s(R,d(z,{get when(){return e.table.foreign_keys.length>2},get children(){var M=Io();return M.firstChild,s(M,()=>e.table.foreign_keys.length-2,null),M}}),null),T}}),null),P(()=>me(l,`table-card ${e.selected?"selected":""}`)),P(()=>o.checked=e.selected),l})()}function Sc(e){return(()=>{var t=Jo(),n=t.firstChild,l=n.nextSibling,i=l.firstChild,r=i.nextSibling,a=r.firstChild,o=a.firstChild,g=o.nextSibling,c=a.nextSibling,f=c.firstChild,h=f.nextSibling,m=r.nextSibling,b=m.firstChild,u=b.nextSibling;return g.$$input=y=>e.onStateUpdate({name:y.currentTarget.value}),h.$$input=y=>{const _=y.currentTarget.value.split(",").map($=>$.trim()).filter($=>$);e.onStateUpdate({tags:_})},u.$$input=y=>e.onStateUpdate({description:y.currentTarget.value}),s(t,d(wc,{get state(){return e.state}}),null),s(t,d(Cc,{get validation(){return e.state.dataSourceValidation},get onValidate(){return e.onValidate},get loading(){return e.state.loading}}),null),s(t,d(kc,{get preview(){return e.state.dataPreview},get onPreviewData(){return e.onPreviewData},get loading(){return e.state.loading}}),null),s(t,d(Ec,{get state(){return e.state},get saveResult(){return e.state.saveResult},get onSave(){return e.onSave},get isSaving(){return e.state.isSaving},get canSave(){return Lc(e.state)}}),null),P(()=>g.value=e.state.name),P(()=>h.value=e.state.tags.join(", ")),P(()=>u.value=e.state.description),t})()}function wc(e){return(()=>{var t=Vo(),n=t.firstChild,l=n.nextSibling,i=l.firstChild,r=i.firstChild,a=r.nextSibling,o=i.nextSibling,g=o.firstChild,c=g.nextSibling,f=c.firstChild,h=o.nextSibling,m=h.firstChild,b=m.nextSibling,u=h.nextSibling,y=u.firstChild,_=y.nextSibling,$=u.nextSibling,T=$.firstChild,L=T.nextSibling,E=L.firstChild,k=$.nextSibling,R=k.firstChild,M=R.nextSibling,U=M.firstChild,O=l.nextSibling,p=O.firstChild,S=p.nextSibling;return s(a,()=>e.state.config.database_type.toUpperCase()),s(c,()=>e.state.config.host,f),s(c,()=>e.state.config.port,null),s(b,()=>e.state.config.database),s(_,()=>e.state.config.username),s(L,()=>e.state.selectedTables.length,E),s(M,()=>e.state.customSQL.length,U),s(S,()=>e.state.customSQL.slice(0,200),null),s(S,()=>e.state.customSQL.length>200?"...":"",null),t})()}function Cc(e){return(()=>{var t=Xo(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(i,"click",e.onValidate),s(i,()=>e.loading?"⏳ 验证中...":"🔍 开始验证"),s(t,d(z,{get when(){return e.validation},get children(){var r=Yo(),a=r.firstChild;return s(a,d(pt,{label:"数据库连接",get status(){return e.validation?.connection_valid?"success":"error"},get icon(){return e.validation?.connection_valid?"✅":"❌"}}),null),s(a,d(pt,{label:"SQL语法",get status(){return e.validation?.sql_valid?"success":"error"},get icon(){return e.validation?.sql_valid?"✅":"❌"}}),null),s(a,d(pt,{label:"安全检查",get status(){return e.validation?.security_passed?"success":"warning"},get icon(){return e.validation?.security_passed?"✅":"⚠️"}}),null),s(a,d(pt,{label:"性能评估",get status(){return e.validation?.performance_acceptable?"success":"info"},get icon(){return e.validation?.performance_acceptable?"✅":"ℹ️"}}),null),s(r,d(z,{get when(){return e.validation&&e.validation.warnings.length>0},get children(){var o=Wo();return o.firstChild,s(o,d(ae,{get each(){return e.validation.warnings||[]},children:g=>(()=>{var c=Zo();return s(c,g),c})()}),null),o}}),null),s(r,d(z,{get when(){return e.validation&&e.validation.errors.length>0},get children(){var o=Go();return o.firstChild,s(o,d(ae,{get each(){return e.validation.errors||[]},children:g=>(()=>{var c=ec();return s(c,g),c})()}),null),o}}),null),s(r,d(z,{get when(){return e.validation&&e.validation.suggestions&&e.validation.suggestions.length>0},get children(){var o=Ko();return o.firstChild,s(o,d(ae,{get each(){return e.validation.suggestions||[]},children:g=>(()=>{var c=tc();return s(c,g),c})()}),null),o}}),null),r}}),null),P(()=>i.disabled=e.loading),t})()}function pt(e){return(()=>{var t=nc(),n=t.firstChild,l=n.nextSibling,i=l.nextSibling;return s(n,()=>e.icon),s(l,()=>e.label),s(i,()=>e.status==="success"?"通过":e.status==="error"?"失败":e.status==="warning"?"警告":"信息"),P(r=>{var a=`validation-check ${e.status}`,o=`check-status ${e.status}`;return a!==r.e&&me(t,r.e=a),o!==r.t&&me(i,r.t=o),r},{e:void 0,t:void 0}),t})()}function kc(e){return(()=>{var t=rc(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(i,"click",e.onPreviewData),s(i,()=>e.loading?"⏳ 加载中...":"👁️ 预览数据"),s(t,d(z,{get when(){return e.preview},get children(){var r=ic(),a=r.firstChild,o=a.firstChild,g=o.firstChild,c=g.nextSibling,f=o.nextSibling,h=f.firstChild,m=h.nextSibling,b=f.nextSibling,u=b.firstChild,y=u.nextSibling,_=y.firstChild,$=a.nextSibling;return s(c,()=>e.preview?.sample_data.length||0),s(m,()=>e.preview?.total_estimated_rows.toLocaleString()||"未知"),s(y,()=>e.preview?.execution_stats.execution_time||0,_),s($,d(z,{get when(){return e.preview&&e.preview.sample_data.length>0},get children(){return d(Tc,{get data(){return e.preview.sample_data||[]}})}}),null),s($,d(z,{get when(){return!e.preview||e.preview.sample_data.length===0},get children(){return lc()}}),null),r}}),null),P(()=>i.disabled=e.loading),t})()}function Tc(e){if(!e.data||e.data.length===0)return sc();const t=Object.keys(e.data[0]);return(()=>{var n=oc(),l=n.firstChild,i=l.firstChild,r=i.firstChild,a=i.nextSibling;return s(r,d(ae,{each:t,children:o=>(()=>{var g=cc();return s(g,o),g})()})),s(a,d(ae,{get each(){return e.data.slice(0,10)},children:o=>(()=>{var g=dc();return s(g,d(ae,{each:t,children:c=>(()=>{var f=uc();return s(f,()=>Dc(o[c])),f})()})),g})()})),s(n,d(z,{get when(){return e.data.length>10},get children(){var o=ac(),g=o.firstChild,c=g.nextSibling;return c.nextSibling,s(o,()=>e.data.length,c),o}}),null),n})()}function Ec(e){return(()=>{var t=bc(),n=t.firstChild,l=n.firstChild,i=l.nextSibling;return Te(i,"click",e.onSave),s(i,()=>e.isSaving?"💾 保存中...":"💾 保存数据源"),s(t,d(z,{get when(){return!e.canSave&&!e.isSaving},get children(){var r=gc(),a=r.firstChild,o=a.nextSibling,g=o.firstChild,c=g.firstChild,f=c.nextSibling,h=f.nextSibling,m=h.nextSibling;m.nextSibling;var b=g.nextSibling,u=b.firstChild,y=u.nextSibling;y.nextSibling;var _=b.nextSibling,$=_.firstChild,T=$.nextSibling;T.nextSibling;var L=_.nextSibling;L.firstChild;var E=o.nextSibling;return s(g,()=>e.state.name?"✅":"❌",f),s(g,()=>e.state.name,m),s(b,()=>e.state.customSQL?"✅":"❌",y),s(b,()=>e.state.customSQL?`(${e.state.customSQL.length} 字符)`:"(空)",null),s(_,()=>e.state.testResult?.success?"✅":"❌",T),s(_,()=>e.state.testResult?.success?"成功":e.state.testResult?`失败: ${e.state.testResult.message}`:"未测试",null),s(L,()=>e.isSaving?"❌ 正在保存中":"✅ 空闲",null),s(E,()=>e.state.testResult?.success?"所有条件都已满足，但按钮仍然禁用。这可能是一个bug。":"请返回第1步完成连接测试，然后才能保存数据源。"),r}}),null),s(t,d(z,{get when(){return e.saveResult},get children(){var r=Fn(),a=r.firstChild,o=a.firstChild,g=o.nextSibling;return s(o,()=>e.saveResult?.success?"✅":"❌"),s(g,()=>e.saveResult?.message),s(r,d(z,{get when(){return e.saveResult?.success&&e.saveResult.data_source_id},get children(){var c=hc(),f=c.firstChild,h=f.firstChild,m=h.nextSibling;return s(m,()=>e.saveResult.data_source_id),c}}),null),s(r,d(z,{get when(){return e.saveResult&&e.saveResult.warnings&&e.saveResult.warnings.length>0},get children(){var c=fc();return s(c,d(ae,{get each(){return e.saveResult.warnings||[]},children:f=>(()=>{var h=pc();return h.firstChild,s(h,f,null),h})()})),c}}),null),s(r,d(z,{get when(){return e.saveResult&&e.saveResult.errors&&e.saveResult.errors.length>0},get children(){var c=vc();return s(c,d(ae,{get each(){return e.saveResult.errors||[]},children:f=>(()=>{var h=yc();return h.firstChild,s(h,f,null),h})()})),c}}),null),P(()=>me(r,`save-result ${e.saveResult?.success?"success":"error"}`)),r}}),null),s(t,d(z,{get when(){return!e.canSave},get children(){return mc()}}),null),P(r=>{var a=`save-btn ${e.canSave?"primary":"disabled"}`,o=e.isSaving||!e.canSave;return a!==r.e&&me(i,r.e=a),o!==r.t&&(i.disabled=r.t=o),r},{e:void 0,t:void 0}),t})()}function Lc(e){const t=e.name.trim().length>0,n=e.customSQL.trim().length>0,l=e.testResult?.success,i=!e.isSaving;return console.log("🔍 保存条件检查:",{hasName:t,hasSQL:n,hasSuccessfulTest:l,notSaving:i,testResult:e.testResult,name:e.name,sql:e.customSQL}),!!(t&&n&&l&&i)}function Dc(e){return e==null?"(null)":typeof e=="string"&&e.length>50?e.substring(0,47)+"...":String(e)}De(["click","input"]);var Pc=v("<input type=text class=search-input placeholder=搜索数据源...>"),Rc=v("<div class=add-buttons-group><button class=add-data-source-btn>📄 文件数据源</button><button class=add-database-source-btn>🗄️ 数据库数据源"),Ac=v("<div class=error-message>"),zc=v("<div class=loading-message>加载中..."),Oc=v("<div class=empty-state><p></p><button>添加第一个数据源"),Mc=v("<div class=data-source-grid>"),Nc=v("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),Ic=v("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),Fc=v("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),Uc=v("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),qc=v("<li><button> <!> (<!>)"),Bc=v("<th>"),jc=v("<tr>"),Qc=v("<td>"),Hc=v("<span class=active-badge title=当前激活>当前"),Jc=v('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function Vc(e){console.log("🏗️  DataSourceManagementCenter 组件渲染，isOpen:",e.isOpen);const[t,n]=G([]),[l,i]=G([]),[r,a]=G("main"),[o,g]=G(null),[c,f]=G(null),[h,m]=G(!1),[b,u]=G(null),[y,_]=G(null),[$,T]=G(""),[L,E]=G("all"),[k,R]=G("all");Fe(async()=>{try{await M(),await U();const W=Ne.subscribe(J=>{_(J?.dataSource.id||null)});_(Ne.getCurrentContext()?.dataSource.id||null),rt(W)}catch(W){console.error("🚨 数据源管理中心初始化失败:",W),u(`初始化失败: ${W}`)}});const M=async()=>{try{m(!0),console.log("🔄 加载数据源列表...");const W=await Se.listDataSources();console.log("✅ 数据源列表加载成功:",W),n(W),u(null)}catch(W){console.error("❌ 加载数据源失败:",W),u(`加载数据源失败: ${W}`)}finally{m(!1)}},U=async()=>{try{console.log("🔄 加载可用数据源类型...");const W=await Se.getAvailableTypes();console.log("✅ 数据源类型加载成功:",W),i(W)}catch(W){console.error("❌ 加载数据源类型失败:",W)}},O=W=>{const J=(W.providerType||"").toLowerCase();return J.includes("database_mysql")?"mysql":J.includes("database_postgresql")?"postgresql":J.includes("database")?"database":J.includes("json")?"json":J.includes("csv")?"csv":J.includes("excel")?"excel":J.includes("api")?"api":J||"unknown"},p=()=>{let W=t();if($()){const J=$().toLowerCase();W=W.filter(q=>(q.name||"").toLowerCase().includes(J)||O(q).includes(J))}return L()!=="all"&&(W=W.filter(J=>J.status===L())),k()!=="all"&&(W=W.filter(J=>O(J)===k())),W},S=W=>t().filter(J=>J.status===W).length,x=W=>t().filter(J=>O(J)===W).length,I=()=>{a("add"),g(null)},N=()=>{a("add-database"),g(null)},C=W=>{g(W),a("edit")},A=async W=>{try{m(!0),u(null),g(W),console.log("🔄 开始预览数据源:",W.name);const J=await Se.getPreview(W.id);f(J),a("preview"),console.log("✅ 数据预览加载成功:",J)}catch(J){console.error("❌ 数据预览失败:",J),u(`预览数据源 "${W.name}" 失败: ${J}`)}finally{m(!1)}},V=async W=>{try{m(!0),await Ne.setActiveDataSource(W.id)}catch(J){console.error("❌ 激活数据源失败:",J),u(`激活数据源失败: ${J}`)}finally{m(!1)}},B=async W=>{try{m(!0);const J=t().find(oe=>oe.id===W);if(!J){u(`数据源不存在: ${W}`);return}const q=await Se.testConnection(J.providerType||J.provider_type,J.config||{});alert(q?`✅ 数据源 "${J.name}" 连接测试成功！`:`❌ 数据源 "${J.name}" 连接测试失败`)}catch(J){console.error("❌ 测试连接失败:",J);const q=t().find(oe=>oe.id===W);alert(`❌ 数据源 "${q?.name||W}" 连接测试失败:
${J}`)}finally{m(!1)}},H=async W=>{const J=t().find(q=>q.id===W);if(confirm(`确定要删除数据源 "${J?.name}" 吗？`))try{await Se.deleteDataSource(W),await M()}catch(q){u(`删除数据源失败: ${q}`)}},ee=()=>{a("main"),g(null),f(null),u(null)};return d(z,{get when(){return e.isOpen},get children(){var W=Uc(),J=W.firstChild,q=J.firstChild,oe=q.nextSibling,pe=oe.nextSibling,he=J.nextSibling;return Te(q,"click",e.onClose),s(pe,d(z,{get when(){return r()==="main"},get children(){return[(()=>{var te=Pc();return te.$$input=ie=>T(ie.currentTarget.value),P(()=>te.value=$()),te})(),(()=>{var te=Rc(),ie=te.firstChild,se=ie.nextSibling;return ie.$$click=I,se.$$click=N,te})()]}})),s(he,d(z,{get when(){return r()==="main"},get children(){var te=Nc(),ie=te.firstChild,se=ie.firstChild,de=se.firstChild,X=de.nextSibling,Y=X.firstChild,ce=Y.firstChild,fe=ce.firstChild,_e=fe.nextSibling;_e.nextSibling;var ge=se.nextSibling,ve=ge.firstChild,ne=ve.nextSibling,ue=ne.firstChild,w=ue.firstChild,D=w.firstChild,Q=D.nextSibling;Q.nextSibling;var F=ue.nextSibling,K=F.firstChild,le=K.firstChild,Z=le.nextSibling;Z.nextSibling;var $e=F.nextSibling,Ee=$e.firstChild,xe=Ee.firstChild,Ae=xe.nextSibling;Ae.nextSibling;var Pe=ge.nextSibling,qe=Pe.firstChild,Ye=qe.nextSibling,Ue=Ye.firstChild,Un=Ue.firstChild,mt=ie.nextSibling;return ce.$$click=()=>E("all"),s(ce,()=>t().length,_e),w.$$click=()=>E("active"),s(w,()=>S("active"),Q),K.$$click=()=>E("error"),s(K,()=>S("error"),Z),Ee.$$click=()=>E("disabled"),s(Ee,()=>S("disabled"),Ae),Un.$$click=()=>R("all"),s(Ye,d(ae,{get each(){return l()},children:ke=>(()=>{var Re=qc(),Be=Re.firstChild,at=Be.firstChild,ot=at.nextSibling,bt=ot.nextSibling,Wt=bt.nextSibling;return Wt.nextSibling,Be.$$click=()=>R(ke.typeName),s(Be,()=>ke.category==="file"?"📄":ke.category==="api"?"🌐":ke.category==="database"?"🗄️":"📊",at),s(Be,()=>ke.displayName,ot),s(Be,()=>x(ke.typeName),Wt),P(()=>me(Re,k()===ke.typeName?"active":"")),Re})()}),null),s(mt,d(z,{get when(){return b()},get children(){var ke=Ac();return s(ke,b),ke}}),null),s(mt,d(z,{get when(){return h()},get children(){return zc()}}),null),s(mt,d(z,{get when(){return be(()=>!h())()&&p().length===0},get children(){var ke=Oc(),Re=ke.firstChild,Be=Re.nextSibling;return s(Re,()=>$()||L()!=="all"||k()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),Be.$$click=I,ke}}),null),s(mt,d(z,{get when(){return be(()=>!h())()&&p().length>0},get children(){var ke=Mc();return s(ke,d(ae,{get each(){return p()},children:Re=>d(Wc,{source:Re,onPreview:()=>A(Re),onTest:()=>B(Re.id),onEdit:()=>C(Re),onDelete:()=>H(Re.id),onActivate:()=>V(Re),get active(){return y()===Re.id}})})),ke}}),null),P(ke=>{var Re=L()==="all"?"active":"",Be=L()==="active"?"active":"",at=L()==="error"?"active":"",ot=L()==="disabled"?"active":"",bt=k()==="all"?"active":"";return Re!==ke.e&&me(Y,ke.e=Re),Be!==ke.t&&me(ue,ke.t=Be),at!==ke.a&&me(F,ke.a=at),ot!==ke.o&&me($e,ke.o=ot),bt!==ke.i&&me(Ue,ke.i=bt),ke},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),te}}),null),s(he,d(z,{get when(){return r()==="add"},get children(){return d(In,{get availableTypes(){return l()},onBack:ee,onSuccess:()=>{M(),ee()}})}}),null),s(he,d(z,{get when(){return r()==="add-database"},get children(){return d(_c,{onBack:ee,onSuccess:()=>{M(),ee()}})}}),null),s(he,d(z,{get when(){return be(()=>r()==="edit")()&&o()},get children(){var te=Ic(),ie=te.firstChild,se=ie.firstChild,de=se.nextSibling;return de.firstChild,se.$$click=ee,s(de,()=>o()?.name,null),te}}),null),s(he,d(z,{get when(){return be(()=>!!(r()==="preview"&&o()))()&&c()},get children(){var te=Fc(),ie=te.firstChild,se=ie.firstChild,de=se.nextSibling;de.firstChild;var X=de.nextSibling,Y=X.firstChild,ce=Y.nextSibling,fe=ce.nextSibling,_e=fe.nextSibling;_e.nextSibling;var ge=ie.nextSibling,ve=ge.firstChild,ne=ve.firstChild,ue=ne.firstChild,w=ne.nextSibling;return se.$$click=ee,s(de,()=>o()?.name,null),s(X,()=>c()?.totalCount??c()?.total_rows,ce),s(X,()=>c()?.rows.length,_e),s(ue,d(ae,{get each(){return c()?.columns},children:D=>(()=>{var Q=Bc();return s(Q,D),Q})()})),s(w,d(ae,{get each(){return c()?.rows.slice(0,50)},children:D=>(()=>{var Q=jc();return s(Q,d(ae,{get each(){return c()?.columns||[]},children:F=>(()=>{var K=Qc();return s(K,(()=>{var le=be(()=>typeof D[F]=="object");return()=>le()?JSON.stringify(D[F]):String(D[F]||"")})()),K})()})),Q})()})),te}}),null),W}})}function Wc(e){const t=a=>{switch(a){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},n=a=>{switch(a){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},l=a=>{const o=new Date,g=new Date(a),c=o.getTime()-g.getTime(),f=Math.floor(c/(1e3*60*60));return f<1?"刚刚更新":f<24?`${f}小时前`:g.toLocaleDateString("zh-CN")},i=a=>{const o=(a||"").toLowerCase();return o.includes("json")?"📄":o.includes("api")?"🌐":o.includes("csv")?"📊":o.includes("database")?"🗄️":"📋"},r=a=>{const o=(a.providerType||a.provider_type||"").toLowerCase();return o.includes("database_mysql")?"MySQL":o.includes("database_postgresql")?"PostgreSQL":o==="json"?"JSON":o==="csv"?"CSV":o==="excel"?"Excel":o.startsWith("api")?"API":o.startsWith("database")?"Database":a.providerType||a.provider_type||"Unknown"};return(()=>{var a=Jc(),o=a.firstChild,g=o.firstChild,c=g.firstChild,f=c.nextSibling,h=g.nextSibling,m=o.nextSibling,b=m.firstChild,u=b.firstChild,y=u.nextSibling,_=b.nextSibling,$=_.firstChild,T=$.nextSibling,L=_.nextSibling,E=L.firstChild,k=E.nextSibling,R=m.nextSibling,M=R.firstChild,U=M.nextSibling,O=U.nextSibling,p=O.nextSibling,S=p.nextSibling;return s(c,()=>i(e.source.providerType)),s(f,()=>e.source.name,null),s(f,d(z,{get when(){return e.active},get children(){return Hc()}}),null),s(y,()=>r(e.source)),s(T,()=>n(e.source.status)),s(k,()=>l(e.source.lastUpdated)),Te(M,"click",e.onPreview),Te(U,"click",e.onTest),Te(O,"click",e.onEdit),Te(p,"click",e.onActivate),Te(S,"click",e.onDelete),P(x=>{var I=e.active?"true":"false",N=t(e.source.status),C=`状态: ${n(e.source.status)}`,A=e.source.status!=="active",V=e.active;return I!==x.e&&j(a,"data-active",x.e=I),N!==x.t&&((x.t=N)!=null?h.style.setProperty("background-color",N):h.style.removeProperty("background-color")),C!==x.a&&j(h,"title",x.a=C),A!==x.o&&(M.disabled=x.o=A),V!==x.i&&(p.disabled=x.i=V),x},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),a})()}De(["click","input"]);var Gc=v("<div class=flex-1>"),gn=v('<div class="w-80 bg-primary border-r border-default flex flex-col">'),hn=v('<div class="flex-1 flex flex-col bg-tertiary">'),Kc=v('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">'),Yc=v('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class="border-b border-default min-h-fit"></div><div class=min-h-fit>'),Xc=v('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden">');const Zc=()=>{const{state:e}=Rt(),[t,n]=G(!1),[l,i]=G(!1);console.log("🖥️  MainLayout渲染，当前模式:",e().mode);const r=()=>{console.log("🔄 数据源按钮被点击，准备打开管理中心"),console.log("📊 当前管理中心状态:",l()),i(!0),console.log("✅ 管理中心状态已设置为 true"),console.log("📊 设置后的管理中心状态:",l())},a=()=>n(!1),o=()=>i(!1);return(()=>{var g=Xc(),c=g.firstChild;return s(g,d(Tl,{onOpenDataSources:r}),c),s(c,d(wn,{get children(){return[d(Ke,{get when(){return e().mode==="preview"},get children(){var f=Gc();return s(f,d(Qr,{})),f}}),d(Ke,{get when(){return e().mode==="design"},get children(){return[(()=>{var f=gn();return s(f,d(tn,{})),f})(),(()=>{var f=hn();return s(f,d(cn,{})),f})(),(()=>{var f=Kc(),h=f.firstChild,m=h.firstChild,b=m.nextSibling;return s(m,d(an,{})),s(b,d(un,{})),f})()]}}),d(Ke,{get when(){return e().mode==="data"},get children(){return[(()=>{var f=gn();return s(f,d(tn,{})),f})(),(()=>{var f=hn();return s(f,d(cn,{})),f})(),(()=>{var f=Yc(),h=f.firstChild,m=h.firstChild,b=m.nextSibling;return s(m,d(un,{})),s(b,d(an,{})),f})()]}})]}})),s(g,d(Vc,{get isOpen(){return l()},onClose:o}),null),s(g,d(xa,{get isOpen(){return t()},onClose:a}),null),g})()},ed=()=>d(ol,{get children(){return d(Zc,{})}}),td={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},nd=()=>{const{state:e,copySelectedElements:t,pasteElements:n,deleteElements:l,undo:i,redo:r,selectAllElements:a,clearSelection:o,moveElements:g}=Ge(),c=(u,y)=>{const _=u.key.toLowerCase()===y.key.toLowerCase()||u.key===y.key,$=!!y.ctrl===(u.ctrlKey||u.metaKey),T=!!y.alt===u.altKey,L=!!y.shift===u.shiftKey;return _&&$&&T&&L},f=async u=>{console.log("🎯 执行快捷键:",u);try{switch(u){case"copy":e.selected_ids.length>0&&(await t(),m("复制成功","✅"));break;case"paste":const y={x:20,y:20},_=await n(y.x,y.y);_.length>0&&m(`粘贴 ${_.length} 个元素`,"📋");break;case"cut":e.selected_ids.length>0&&(await t(),await l([...e.selected_ids]),m("剪切成功","✂️"));break;case"delete":if(e.selected_ids.length>0){const $=e.selected_ids.length;await l([...e.selected_ids]),m(`删除 ${$} 个元素`,"🗑️")}break;case"undo":await i(),m("撤销","↶");break;case"redo":await r(),m("重做","↷");break;case"selectAll":await a(),m(`全选 ${e.elements.length} 个元素`,"🎯");break;case"clearSelection":e.selected_ids.length>0&&(o(),m("清除选择","⭕"));break;case"duplicate":if(e.selected_ids.length>0){await t();const $=await n(20,20);m(`复制 ${$.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await h(u);break;default:console.warn("未知的快捷键动作:",u)}}catch(y){console.error("快捷键执行失败:",y),m("操作失败","❌")}},h=async u=>{if(e.selected_ids.length===0)return;const y=u.includes("Fast"),_=y?10:1;let $=0,T=0;switch(u){case"moveUp":case"moveFastUp":T=-_;break;case"moveDown":case"moveFastDown":T=_;break;case"moveLeft":case"moveFastLeft":$=-_;break;case"moveRight":case"moveFastRight":$=_;break}($!==0||T!==0)&&(await g([...e.selected_ids],$,T),y&&m(`快速移动 ${_}px`,"🔄"))},m=(u,y)=>{const _=document.createElement("div");_.className="keyboard-feedback",_.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${y}</span>
        <span class="feedback-text">${u}</span>
      </div>
    `,document.body.appendChild(_),setTimeout(()=>{_.parentNode&&_.parentNode.removeChild(_)},2e3)},b=u=>{const y=u.target;if(!(y.tagName==="INPUT"||y.tagName==="TEXTAREA"||y.contentEditable==="true")){for(const[$,T]of Object.entries(td))if(c(u,T.combination)){u.preventDefault(),u.stopPropagation(),console.log("🎹 快捷键触发:",$,T.action),f(T.action);return}}};return Fe(()=>{if(document.addEventListener("keydown",b,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const u=document.createElement("style");u.id="keyboard-feedback-styles",u.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(u)}}),rt(()=>{document.removeEventListener("keydown",b,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},ld=()=>(Fe(()=>{document.addEventListener("contextmenu",e=>e.preventDefault());try{const e=typeof window<"u"?window.localStorage.getItem("jasper.activeDataSourceId"):null;e&&Ne.setActiveDataSource(e).catch(t=>{console.warn("恢复激活数据源失败:",t)})}catch(e){console.warn("读取本地激活数据源失败:",e)}}),d(ml,{get children(){return[d(nd,{}),d(ed,{})]}})),id=document.getElementById("root");nl(()=>d(ld,{}),id);
