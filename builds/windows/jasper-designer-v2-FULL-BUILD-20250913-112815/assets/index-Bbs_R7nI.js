(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const Nr=!1,zr=(n,e)=>n===e,Dt=Symbol("solid-proxy"),vi=Symbol("solid-track"),Nn={equals:zr};let Rs=zs;const wt=1,zn=2,Ls={owned:null,cleanups:null,context:null,owner:null};var Ge=null;let Zn=null,Fr=null,Ue=null,Ve=null,ft=null,Yn=0;function Dn(n,e){const t=Ue,i=Ge,s=n.length===0,r=e===void 0?i:e,a=s?Ls:{owned:null,cleanups:null,context:r?r.context:null,owner:r},l=s?n:()=>n(()=>it(()=>gn(a)));Ge=a,Ue=null;try{return Vt(l,!0)}finally{Ue=t,Ge=i}}function Z(n,e){e=e?Object.assign({},Nn,e):Nn;const t={value:n,observers:null,observerSlots:null,comparator:e.equals||void 0},i=s=>(typeof s=="function"&&(s=s(t.value)),Ns(t,s));return[Is.bind(t),i]}function B(n,e,t){const i=Ri(n,e,!1,wt);bn(i)}function mn(n,e,t){Rs=Hr;const i=Ri(n,e,!1,wt);i.user=!0,ft?ft.push(i):bn(i)}function Me(n,e,t){t=t?Object.assign({},Nn,t):Nn;const i=Ri(n,e,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=t.equals||void 0,bn(i),Is.bind(i)}function Gr(n){return Vt(n,!1)}function it(n){if(Ue===null)return n();const e=Ue;Ue=null;try{return n()}finally{Ue=e}}function et(n){mn(()=>it(n))}function $t(n){return Ge===null||(Ge.cleanups===null?Ge.cleanups=[n]:Ge.cleanups.push(n)),n}function pi(){return Ue}const[h0,u0]=Z(!1);function Ms(n,e){const t=Symbol("context");return{id:t,Provider:Wr(t),defaultValue:n}}function Ds(n){let e;return Ge&&Ge.context&&(e=Ge.context[n.id])!==void 0?e:n.defaultValue}function Os(n){const e=Me(n),t=Me(()=>mi(e()));return t.toArray=()=>{const i=t();return Array.isArray(i)?i:i!=null?[i]:[]},t}function Is(){if(this.sources&&this.state)if(this.state===wt)bn(this);else{const n=Ve;Ve=null,Vt(()=>Gn(this),!1),Ve=n}if(Ue){const n=this.observers?this.observers.length:0;Ue.sources?(Ue.sources.push(this),Ue.sourceSlots.push(n)):(Ue.sources=[this],Ue.sourceSlots=[n]),this.observers?(this.observers.push(Ue),this.observerSlots.push(Ue.sources.length-1)):(this.observers=[Ue],this.observerSlots=[Ue.sources.length-1])}return this.value}function Ns(n,e,t){let i=n.value;return(!n.comparator||!n.comparator(i,e))&&(n.value=e,n.observers&&n.observers.length&&Vt(()=>{for(let s=0;s<n.observers.length;s+=1){const r=n.observers[s],a=Zn&&Zn.running;a&&Zn.disposed.has(r),(a?!r.tState:!r.state)&&(r.pure?Ve.push(r):ft.push(r),r.observers&&Fs(r)),a||(r.state=wt)}if(Ve.length>1e6)throw Ve=[],new Error},!1)),e}function bn(n){if(!n.fn)return;gn(n);const e=Yn;Br(n,n.value,e)}function Br(n,e,t){let i;const s=Ge,r=Ue;Ue=Ge=n;try{i=n.fn(e)}catch(a){return n.pure&&(n.state=wt,n.owned&&n.owned.forEach(gn),n.owned=null),n.updatedAt=t+1,Gs(a)}finally{Ue=r,Ge=s}(!n.updatedAt||n.updatedAt<=t)&&(n.updatedAt!=null&&"observers"in n?Ns(n,i):n.value=i,n.updatedAt=t)}function Ri(n,e,t,i=wt,s){const r={fn:n,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:Ge,context:Ge?Ge.context:null,pure:t};return Ge===null||Ge!==Ls&&(Ge.owned?Ge.owned.push(r):Ge.owned=[r]),r}function Fn(n){if(n.state===0)return;if(n.state===zn)return Gn(n);if(n.suspense&&it(n.suspense.inFallback))return n.suspense.effects.push(n);const e=[n];for(;(n=n.owner)&&(!n.updatedAt||n.updatedAt<Yn);)n.state&&e.push(n);for(let t=e.length-1;t>=0;t--)if(n=e[t],n.state===wt)bn(n);else if(n.state===zn){const i=Ve;Ve=null,Vt(()=>Gn(n,e[0]),!1),Ve=i}}function Vt(n,e){if(Ve)return n();let t=!1;e||(Ve=[]),ft?t=!0:ft=[],Yn++;try{const i=n();return Ur(t),i}catch(i){t||(ft=null),Ve=null,Gs(i)}}function Ur(n){if(Ve&&(zs(Ve),Ve=null),n)return;const e=ft;ft=null,e.length&&Vt(()=>Rs(e),!1)}function zs(n){for(let e=0;e<n.length;e++)Fn(n[e])}function Hr(n){let e,t=0;for(e=0;e<n.length;e++){const i=n[e];i.user?n[t++]=i:Fn(i)}for(e=0;e<t;e++)Fn(n[e])}function Gn(n,e){n.state=0;for(let t=0;t<n.sources.length;t+=1){const i=n.sources[t];if(i.sources){const s=i.state;s===wt?i!==e&&(!i.updatedAt||i.updatedAt<Yn)&&Fn(i):s===zn&&Gn(i,e)}}}function Fs(n){for(let e=0;e<n.observers.length;e+=1){const t=n.observers[e];t.state||(t.state=zn,t.pure?Ve.push(t):ft.push(t),t.observers&&Fs(t))}}function gn(n){let e;if(n.sources)for(;n.sources.length;){const t=n.sources.pop(),i=n.sourceSlots.pop(),s=t.observers;if(s&&s.length){const r=s.pop(),a=t.observerSlots.pop();i<s.length&&(r.sourceSlots[a]=i,s[i]=r,t.observerSlots[i]=a)}}if(n.tOwned){for(e=n.tOwned.length-1;e>=0;e--)gn(n.tOwned[e]);delete n.tOwned}if(n.owned){for(e=n.owned.length-1;e>=0;e--)gn(n.owned[e]);n.owned=null}if(n.cleanups){for(e=n.cleanups.length-1;e>=0;e--)n.cleanups[e]();n.cleanups=null}n.state=0}function qr(n){return n instanceof Error?n:new Error(typeof n=="string"?n:"Unknown error",{cause:n})}function Gs(n,e=Ge){throw qr(n)}function mi(n){if(typeof n=="function"&&!n.length)return mi(n());if(Array.isArray(n)){const e=[];for(let t=0;t<n.length;t++){const i=mi(n[t]);Array.isArray(i)?e.push.apply(e,i):e.push(i)}return e}return n}function Wr(n,e){return function(i){let s;return B(()=>s=it(()=>(Ge.context={...Ge.context,[n]:i.value},Os(()=>i.children))),void 0),s}}const jr=Symbol("fallback");function Fi(n){for(let e=0;e<n.length;e++)n[e]()}function Yr(n,e,t={}){let i=[],s=[],r=[],a=0,l=e.length>1?[]:null;return $t(()=>Fi(r)),()=>{let o=n()||[],c=o.length,d,h;return o[vi],it(()=>{let v,f,p,b,m,_,w,x,C;if(c===0)a!==0&&(Fi(r),r=[],i=[],s=[],a=0,l&&(l=[])),t.fallback&&(i=[jr],s[0]=Dn(A=>(r[0]=A,t.fallback())),a=1);else if(a===0){for(s=new Array(c),h=0;h<c;h++)i[h]=o[h],s[h]=Dn(u);a=c}else{for(p=new Array(c),b=new Array(c),l&&(m=new Array(c)),_=0,w=Math.min(a,c);_<w&&i[_]===o[_];_++);for(w=a-1,x=c-1;w>=_&&x>=_&&i[w]===o[x];w--,x--)p[x]=s[w],b[x]=r[w],l&&(m[x]=l[w]);for(v=new Map,f=new Array(x+1),h=x;h>=_;h--)C=o[h],d=v.get(C),f[h]=d===void 0?-1:d,v.set(C,h);for(d=_;d<=w;d++)C=i[d],h=v.get(C),h!==void 0&&h!==-1?(p[h]=s[d],b[h]=r[d],l&&(m[h]=l[d]),h=f[h],v.set(C,h)):r[d]();for(h=_;h<c;h++)h in p?(s[h]=p[h],r[h]=b[h],l&&(l[h]=m[h],l[h](h))):s[h]=Dn(u);s=s.slice(0,a=c),i=o.slice(0)}return s});function u(v){if(r[h]=v,l){const[f,p]=Z(h);return l[h]=p,e(o[h],f)}return e(o[h])}}}function y(n,e){return it(()=>n(e||{}))}const Bs=n=>`Stale read from <${n}>.`;function fe(n){const e="fallback"in n&&{fallback:()=>n.fallback};return Me(Yr(()=>n.each,n.children,e||void 0))}function H(n){const e=n.keyed,t=Me(()=>n.when,void 0,void 0),i=e?t:Me(t,void 0,{equals:(s,r)=>!s==!r});return Me(()=>{const s=i();if(s){const r=n.children;return typeof r=="function"&&r.length>0?it(()=>r(e?s:()=>{if(!it(i))throw Bs("Show");return t()})):r}return n.fallback},void 0,void 0)}function Us(n){const e=Os(()=>n.children),t=Me(()=>{const i=e(),s=Array.isArray(i)?i:[i];let r=()=>{};for(let a=0;a<s.length;a++){const l=a,o=s[a],c=r,d=Me(()=>c()?void 0:o.when,void 0,void 0),h=o.keyed?d:Me(d,void 0,{equals:(u,v)=>!u==!v});r=()=>c()||(h()?[l,d,o]:void 0)}return r});return Me(()=>{const i=t()();if(!i)return n.fallback;const[s,r,a]=i,l=a.children;return typeof l=="function"&&l.length>0?it(()=>l(a.keyed?r():()=>{if(it(t)()?.[0]!==s)throw Bs("Match");return r()})):l},void 0,void 0)}function xt(n){return n}const Ce=n=>Me(()=>n());function Vr(n,e,t){let i=t.length,s=e.length,r=i,a=0,l=0,o=e[s-1].nextSibling,c=null;for(;a<s||l<r;){if(e[a]===t[l]){a++,l++;continue}for(;e[s-1]===t[r-1];)s--,r--;if(s===a){const d=r<i?l?t[l-1].nextSibling:t[r-l]:o;for(;l<r;)n.insertBefore(t[l++],d)}else if(r===l)for(;a<s;)(!c||!c.has(e[a]))&&e[a].remove(),a++;else if(e[a]===t[r-1]&&t[l]===e[s-1]){const d=e[--s].nextSibling;n.insertBefore(t[l++],e[a++].nextSibling),n.insertBefore(t[--r],d),e[s]=t[r]}else{if(!c){c=new Map;let h=l;for(;h<r;)c.set(t[h],h++)}const d=c.get(e[a]);if(d!=null)if(l<d&&d<r){let h=a,u=1,v;for(;++h<s&&h<r&&!((v=c.get(e[h]))==null||v!==d+u);)u++;if(u>d-l){const f=e[a];for(;l<d;)n.insertBefore(t[l++],f)}else n.replaceChild(t[l++],e[a++])}else a++;else e[a++].remove()}}}const Gi="_$DX_DELEGATE";function Xr(n,e,t,i={}){let s;return Dn(r=>{s=r,e===document?n():g(e,n(),e.firstChild?null:void 0,t)},i.owner),()=>{s(),e.textContent=""}}function S(n,e,t,i){let s;const r=()=>{const l=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return l.innerHTML=n,t?l.content.firstChild.firstChild:i?l.firstChild:l.content.firstChild},a=e?()=>it(()=>document.importNode(s||(s=r()),!0)):()=>(s||(s=r())).cloneNode(!0);return a.cloneNode=a,a}function He(n,e=window.document){const t=e[Gi]||(e[Gi]=new Set);for(let i=0,s=n.length;i<s;i++){const r=n[i];t.has(r)||(t.add(r),e.addEventListener(r,Qr))}}function X(n,e,t){t==null?n.removeAttribute(e):n.setAttribute(e,t)}function Se(n,e){e==null?n.removeAttribute("class"):n.className=e}function Le(n,e,t,i){Array.isArray(t)?(n[`$$${e}`]=t[0],n[`$$${e}Data`]=t[1]):n[`$$${e}`]=t}function Hs(n,e,t){if(!e)return t?X(n,"style"):e;const i=n.style;if(typeof e=="string")return i.cssText=e;typeof t=="string"&&(i.cssText=t=void 0),t||(t={}),e||(e={});let s,r;for(r in t)e[r]==null&&i.removeProperty(r),delete t[r];for(r in e)s=e[r],s!==t[r]&&(i.setProperty(r,s),t[r]=s);return t}function Vn(n,e,t){return it(()=>n(e,t))}function g(n,e,t,i){if(t!==void 0&&!i&&(i=[]),typeof e!="function")return Bn(n,e,i,t);B(s=>Bn(n,e(),s,t),i)}function Qr(n){let e=n.target;const t=`$$${n.type}`,i=n.target,s=n.currentTarget,r=o=>Object.defineProperty(n,"target",{configurable:!0,value:o}),a=()=>{const o=e[t];if(o&&!e.disabled){const c=e[`${t}Data`];if(c!==void 0?o.call(e,c,n):o.call(e,n),n.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(n.target)&&r(e.host),!0},l=()=>{for(;a()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(n,"currentTarget",{configurable:!0,get(){return e||document}}),n.composedPath){const o=n.composedPath();r(o[0]);for(let c=0;c<o.length-2&&(e=o[c],!!a());c++){if(e._$host){e=e._$host,l();break}if(e.parentNode===s)break}}else l();r(i)}function Bn(n,e,t,i,s){for(;typeof t=="function";)t=t();if(e===t)return t;const r=typeof e,a=i!==void 0;if(n=a&&t[0]&&t[0].parentNode||n,r==="string"||r==="number"){if(r==="number"&&(e=e.toString(),e===t))return t;if(a){let l=t[0];l&&l.nodeType===3?l.data!==e&&(l.data=e):l=document.createTextNode(e),t=Gt(n,t,i,l)}else t!==""&&typeof t=="string"?t=n.firstChild.data=e:t=n.textContent=e}else if(e==null||r==="boolean")t=Gt(n,t,i);else{if(r==="function")return B(()=>{let l=e();for(;typeof l=="function";)l=l();t=Bn(n,l,t,i)}),()=>t;if(Array.isArray(e)){const l=[],o=t&&Array.isArray(t);if(bi(l,e,t,s))return B(()=>t=Bn(n,l,t,i,!0)),()=>t;if(l.length===0){if(t=Gt(n,t,i),a)return t}else o?t.length===0?Bi(n,l,i):Vr(n,t,l):(t&&Gt(n),Bi(n,l));t=l}else if(e.nodeType){if(Array.isArray(t)){if(a)return t=Gt(n,t,i,e);Gt(n,t,null,e)}else t==null||t===""||!n.firstChild?n.appendChild(e):n.replaceChild(e,n.firstChild);t=e}}return t}function bi(n,e,t,i){let s=!1;for(let r=0,a=e.length;r<a;r++){let l=e[r],o=t&&t[n.length],c;if(!(l==null||l===!0||l===!1))if((c=typeof l)=="object"&&l.nodeType)n.push(l);else if(Array.isArray(l))s=bi(n,l,o)||s;else if(c==="function")if(i){for(;typeof l=="function";)l=l();s=bi(n,Array.isArray(l)?l:[l],Array.isArray(o)?o:[o])||s}else n.push(l),s=!0;else{const d=String(l);o&&o.nodeType===3&&o.data===d?n.push(o):n.push(document.createTextNode(d))}}return s}function Bi(n,e,t=null){for(let i=0,s=e.length;i<s;i++)n.insertBefore(e[i],t)}function Gt(n,e,t,i){if(t===void 0)return n.textContent="";const s=i||document.createTextNode("");if(e.length){let r=!1;for(let a=e.length-1;a>=0;a--){const l=e[a];if(s!==l){const o=l.parentNode===n;!r&&!a?o?n.replaceChild(s,l):n.insertBefore(s,t):o&&l.remove()}else r=!0}}else n.insertBefore(s,t);return[s]}var Kr=S("<div class=preview-toggle-container><div class=current-mode-indicator><span class=mode-icon></span><span class=mode-text></span></div><div class=mode-toggle-group>"),Jr=S("<span class=loading-indicator>⏳"),Zr=S("<button><span class=button-icon></span><span class=button-text>"),ea=S("<div class=error-indicator>❌");const qs=Ms(),ta=n=>{const[e,t]=Z({mode:"design",loading:!1,error:void 0}),i=h=>{t(u=>({...u,mode:h,error:void 0})),console.log(`🎯 预览模式切换: ${h==="design"?"设计模式":"预览模式"}`),window.dispatchEvent(new CustomEvent("preview-mode-changed",{detail:{mode:h,timestamp:Date.now()}}))},d={state:e,actions:{setMode:i,toggleMode:()=>{const h=e().mode;i(h==="design"?"data":h==="data"?"preview":"design")},setLoading:h=>{t(u=>({...u,loading:h}))},setError:h=>{t(u=>({...u,error:h,loading:!1}))},isDesignMode:()=>e().mode==="design",isDataMode:()=>e().mode==="data",isPreviewMode:()=>e().mode==="preview"}};return y(qs.Provider,{value:d,get children(){return n.children}})},Xn=()=>{const n=Ds(qs);if(!n)throw new Error("usePreview必须在PreviewProvider内使用");return n},na=()=>{const{state:n,actions:e}=Xn(),t=s=>({design:{icon:"🎨",text:"设计模式",color:"blue"},data:{icon:"🔗",text:"数据模式",color:"green"},preview:{icon:"🔍",text:"预览模式",color:"purple"}})[s],i=()=>t(n().mode);return(()=>{var s=Kr(),r=s.firstChild,a=r.firstChild,l=a.nextSibling,o=r.nextSibling;return g(a,()=>i().icon),g(l,()=>i().text),g(r,(()=>{var c=Ce(()=>!!n().loading);return()=>c()&&Jr()})(),null),g(o,()=>["design","data","preview"].map(c=>{const d=t(c),h=n().mode===c;return(()=>{var u=Zr(),v=u.firstChild,f=v.nextSibling;return u.$$click=()=>e.setMode(c),Se(u,`mode-btn ${h?"active":""}`),g(v,()=>d.icon),g(f,()=>d.text),B(p=>{var b=n().loading,m=`切换到${d.text}`;return b!==p.e&&(u.disabled=p.e=b),m!==p.t&&X(u,"title",p.t=m),p},{e:void 0,t:void 0}),u})()})),g(s,(()=>{var c=Ce(()=>!!n().error);return()=>c()&&(()=>{var d=ea();return B(()=>X(d,"title",n().error)),d})()})(),null),s})()},ei={getModeDisplayText:n=>({design:"设计模式",data:"数据模式",preview:"预览模式"})[n],getModeIcon:n=>({design:"🎨",data:"🔗",preview:"🔍"})[n],shouldShowExpression:n=>n==="design",shouldEvaluateExpression:n=>n==="data"||n==="preview",shouldShowDesignAids:n=>n==="design"||n==="data",shouldAllowInteraction:n=>n==="design"||n==="data",isReadOnlyMode:n=>n==="preview",getModeTransitionClass:n=>`mode-${n}-active`};He(["click"]);const yi=Symbol("store-raw"),jt=Symbol("store-node"),ut=Symbol("store-has"),Ws=Symbol("store-self");function js(n){let e=n[Dt];if(!e&&(Object.defineProperty(n,Dt,{value:e=new Proxy(n,ra)}),!Array.isArray(n))){const t=Object.keys(n),i=Object.getOwnPropertyDescriptors(n);for(let s=0,r=t.length;s<r;s++){const a=t[s];i[a].get&&Object.defineProperty(n,a,{enumerable:i[a].enumerable,get:i[a].get.bind(e)})}}return e}function Un(n){let e;return n!=null&&typeof n=="object"&&(n[Dt]||!(e=Object.getPrototypeOf(n))||e===Object.prototype||Array.isArray(n))}function fn(n,e=new Set){let t,i,s,r;if(t=n!=null&&n[yi])return t;if(!Un(n)||e.has(n))return n;if(Array.isArray(n)){Object.isFrozen(n)?n=n.slice(0):e.add(n);for(let a=0,l=n.length;a<l;a++)s=n[a],(i=fn(s,e))!==s&&(n[a]=i)}else{Object.isFrozen(n)?n=Object.assign({},n):e.add(n);const a=Object.keys(n),l=Object.getOwnPropertyDescriptors(n);for(let o=0,c=a.length;o<c;o++)r=a[o],!l[r].get&&(s=n[r],(i=fn(s,e))!==s&&(n[r]=i))}return n}function Hn(n,e){let t=n[e];return t||Object.defineProperty(n,e,{value:t=Object.create(null)}),t}function vn(n,e,t){if(n[e])return n[e];const[i,s]=Z(t,{equals:!1,internal:!0});return i.$=s,n[e]=i}function ia(n,e){const t=Reflect.getOwnPropertyDescriptor(n,e);return!t||t.get||!t.configurable||e===Dt||e===jt||(delete t.value,delete t.writable,t.get=()=>n[Dt][e]),t}function Ys(n){pi()&&vn(Hn(n,jt),Ws)()}function sa(n){return Ys(n),Reflect.ownKeys(n)}const ra={get(n,e,t){if(e===yi)return n;if(e===Dt)return t;if(e===vi)return Ys(n),t;const i=Hn(n,jt),s=i[e];let r=s?s():n[e];if(e===jt||e===ut||e==="__proto__")return r;if(!s){const a=Object.getOwnPropertyDescriptor(n,e);pi()&&(typeof r!="function"||n.hasOwnProperty(e))&&!(a&&a.get)&&(r=vn(i,e,r)())}return Un(r)?js(r):r},has(n,e){return e===yi||e===Dt||e===vi||e===jt||e===ut||e==="__proto__"?!0:(pi()&&vn(Hn(n,ut),e)(),e in n)},set(){return!0},deleteProperty(){return!0},ownKeys:sa,getOwnPropertyDescriptor:ia};function qn(n,e,t,i=!1){if(!i&&n[e]===t)return;const s=n[e],r=n.length;t===void 0?(delete n[e],n[ut]&&n[ut][e]&&s!==void 0&&n[ut][e].$()):(n[e]=t,n[ut]&&n[ut][e]&&s===void 0&&n[ut][e].$());let a=Hn(n,jt),l;if((l=vn(a,e,s))&&l.$(()=>t),Array.isArray(n)&&n.length!==r){for(let o=n.length;o<r;o++)(l=a[o])&&l.$();(l=vn(a,"length",r))&&l.$(n.length)}(l=a[Ws])&&l.$()}function Vs(n,e){const t=Object.keys(e);for(let i=0;i<t.length;i+=1){const s=t[i];qn(n,s,e[s])}}function aa(n,e){if(typeof e=="function"&&(e=e(n)),e=fn(e),Array.isArray(e)){if(n===e)return;let t=0,i=e.length;for(;t<i;t++){const s=e[t];n[t]!==s&&qn(n,t,s)}qn(n,"length",i)}else Vs(n,e)}function nn(n,e,t=[]){let i,s=n;if(e.length>1){i=e.shift();const a=typeof i,l=Array.isArray(n);if(Array.isArray(i)){for(let o=0;o<i.length;o++)nn(n,[i[o]].concat(e),t);return}else if(l&&a==="function"){for(let o=0;o<n.length;o++)i(n[o],o)&&nn(n,[o].concat(e),t);return}else if(l&&a==="object"){const{from:o=0,to:c=n.length-1,by:d=1}=i;for(let h=o;h<=c;h+=d)nn(n,[h].concat(e),t);return}else if(e.length>1){nn(n[i],e,[i].concat(t));return}s=n[i],t=[i].concat(t)}let r=e[0];typeof r=="function"&&(r=r(s,t),r===s)||i===void 0&&r==null||(r=fn(r),i===void 0||Un(s)&&Un(r)&&!Array.isArray(r)?Vs(s,r):qn(n,i,r))}function la(...[n,e]){const t=fn(n||{}),i=Array.isArray(t),s=js(t);function r(...a){Gr(()=>{i&&a.length===1?aa(t,a[0]):nn(t,a)})}return[s,r]}function oa(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Ui(n,e=!1){const t=oa(),i=`_${t}`;return Object.defineProperty(window,i,{value:s=>(e&&Reflect.deleteProperty(window,i),n?.(s)),writable:!1,configurable:!0}),t}async function me(n,e={}){return new Promise((t,i)=>{const s=Ui(a=>{t(a),Reflect.deleteProperty(window,`_${r}`)},!0),r=Ui(a=>{i(a),Reflect.deleteProperty(window,`_${s}`)},!0);window.__TAURI_IPC__({cmd:n,callback:s,error:r,...e})})}const Xs=Ms(),ca=n=>{const[e,t]=la({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[i,s]=Z(!1),[r,a]=Z(null),[l,o]=Z(!1),c=async()=>{try{s(!0),console.log("🔄 Loading app state...");const $=await me("get_app_state");console.log("🔄 App state loaded, selected_ids:",$.selected_ids),t($)}catch($){console.error("Failed to load app state:",$)}finally{s(!1)}};et(()=>{c()});const d=async($,P,Q,G={})=>{try{s(!0);const D=await me("create_element",{request:{element_type:$,position:P,size:Q,content_data:G}});return await c(),D}catch(D){throw console.error("Failed to create element:",D),D}finally{s(!1)}},h=async($,P)=>{try{s(!0),await me("update_element",{request:{id:$,updates:P}}),await c()}catch(Q){throw console.error("Failed to update element:",Q),Q}finally{s(!1)}},u=async $=>{try{s(!0),await me("batch_update_positions",{request:{updates:$}}),t(P=>{const Q=P.elements.map(G=>{const D=$.find(V=>V.element_id===G.id);return D?{...G,position:D.new_position}:G});return{...P,elements:Q,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(P){throw console.error("Failed to batch update positions:",P),await c(),P}finally{s(!1)}},v=async $=>{try{s(!0),await me("delete_element",{elementId:$}),await c()}catch(P){throw console.error("Failed to delete element:",P),P}finally{s(!1)}},f=async $=>{try{console.log("Selecting element:",$),await me("select_element",{elementId:$}),console.log("Select command completed, reloading state..."),await c(),console.log("State reloaded, selected_ids:",e.selected_ids)}catch(P){throw console.error("Failed to select element:",P),P}},p=async $=>{try{console.log("Selecting multiple elements:",$),$.length>0?(await me("select_multiple",{elementIds:$}),console.log("✅ Multi-select completed for:",$.length,"elements")):await me("clear_selection"),await c()}catch(P){throw console.error("Failed to select multiple elements:",P),P}},b=async $=>{try{console.log("Adding to selection:",$),await me("add_to_selection",{elementId:$}),await c()}catch(P){throw console.error("Failed to add to selection:",P),P}},m=async $=>{try{console.log("Removing from selection:",$),await me("remove_from_selection",{elementId:$}),await c()}catch(P){throw console.error("Failed to remove from selection:",P),P}},_=async $=>{try{console.log("Toggling selection:",$),await me("toggle_selection",{elementId:$}),await c()}catch(P){throw console.error("Failed to toggle selection:",P),P}},w=async()=>{try{await me("clear_selection"),await c()}catch($){throw console.error("Failed to clear selection:",$),$}},x=async()=>{try{await me("copy_selected")}catch($){throw console.error("Failed to copy selected elements:",$),$}},N={state:e,setState:t,createElement:d,updateElement:h,batchUpdatePositions:u,deleteElement:v,selectElement:f,selectMultiple:p,addToSelection:b,removeFromSelection:m,toggleSelection:_,clearSelection:w,copySelected:x,copySelectedElements:async()=>x(),pasteElements:async($,P)=>{try{s(!0);const Q=await me("paste_elements",{offsetX:$,offsetY:P});return await c(),Q}catch(Q){throw console.error("Failed to paste elements:",Q),Q}finally{s(!1)}},deleteElements:async $=>{try{s(!0);for(const P of $)await me("delete_element",{elementId:P});await c()}catch(P){throw console.error("Failed to delete elements:",P),P}finally{s(!1)}},selectAllElements:async()=>{try{const $=e.elements.map(P=>P.id);await p($)}catch($){throw console.error("Failed to select all elements:",$),$}},moveElements:async($,P,Q)=>{try{s(!0);const G=e.elements.filter(D=>$.includes(D.id)).map(D=>({element_id:D.id,new_position:{x:D.position.x+P,y:D.position.y+Q}}));G.length>0&&await u(G)}catch(G){throw console.error("Failed to move elements:",G),G}finally{s(!1)}},undo:async()=>{try{s(!0),await me("undo"),await c()}catch($){throw console.error("Failed to undo:",$),$}finally{s(!1)}},redo:async()=>{try{s(!0),await me("redo"),await c()}catch($){throw console.error("Failed to redo:",$),$}finally{s(!1)}},updateCanvasConfig:async $=>{try{s(!0),await me("update_canvas_config",{request:$}),await c()}catch(P){throw console.error("Failed to update canvas config:",P),P}finally{s(!1)}},getElementsAtPoint:async($,P)=>{try{return await me("get_elements_at_point",{x:$,y:P})}catch(Q){return console.error("Failed to get elements at point:",Q),[]}},isLoading:i,setLoading:s,dragOperation:r,setDragOperation:a,resizeOperation:l,setResizeOperation:o};return y(Xs.Provider,{value:N,get children(){return n.children}})},ct=()=>{const n=Ds(Xs);if(!n)throw new Error("useAppContext must be used within an AppProvider");return n};async function Qs(n){return me("tauri",n)}async function da(n={}){return typeof n=="object"&&Object.freeze(n),Qs({__tauriModule:"Dialog",message:{cmd:"openDialog",options:n}})}async function ha(n={}){return typeof n=="object"&&Object.freeze(n),Qs({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:n}})}class ti{static async loadTemplate(e){return await me("load_jasper_template",{filePath:e})}static async saveTemplate(e,t){await me("save_jasper_template",{template:e,filePath:t})}static async saveTemplateAs(e,t,i){await me("save_template_as",{template:e,filePath:t,format:i})}static async validateTemplate(e){return await me("validate_template",{template:e})}static async createEmptyTemplate(){return await me("create_empty_template")}static async getTemplateInfo(e){return await me("get_template_info",{filePath:e})}static async detectTemplateFormat(e){return await me("detect_template_format",{filePath:e})}static async generateTemplatePreview(e){return await me("generate_template_preview",{template:e})}static async exportTemplateJson(e){return await me("export_template_json",{template:e})}static async importTemplateJson(e){return await me("import_template_json",{jsonData:e})}static async cloneTemplate(e){return await me("clone_template",{template:e})}static async mergeTemplates(e,t){return await me("merge_templates",{baseTemplate:e,overlayTemplate:t})}static async extractTemplateElements(e,t){return await me("extract_template_elements",{template:e,elementIds:t})}}const ua="modulepreload",ga=function(n){return"/"+n},Hi={},fa=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");s=Promise.allSettled(t.map(o=>{if(o=ga(o),o in Hi)return;Hi[o]=!0;const c=o.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${d}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":ua,c||(h.as="script"),h.crossOrigin="",h.href=o,l&&h.setAttribute("nonce",l),document.head.appendChild(h),c)return new Promise((u,v)=>{h.addEventListener("load",u),h.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${o}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return s.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return e().catch(r)})},va=()=>({metadata:{version:"2.0.0",format_version:"1.0.0",created_at:new Date().toISOString(),last_modified:new Date().toISOString(),created_by:"jasper-designer-v2",tags:[],compatibility:{min_jasper_version:"2.0.0",jasperreports_version:"6.20.0"}},canvas:{width:595,height:842,unit:"pt",orientation:"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:!0,size:10,snap:!0,visible:!0},background:{color:"#ffffff"}},data_sources:[],elements:[],parameters:[],variables:[],groups:[]});class ni{static toJasperTemplate(e,t){const i={...va()},s={...i.metadata,...t,last_modified:new Date().toISOString()},r=this.convertCanvasConfig(e.canvas_config),a=e.elements.map(l=>this.convertReportElementToTemplateElement(l));return{...i,metadata:s,canvas:r,elements:a}}static convertCanvasConfig(e){return{width:e.width,height:e.height,unit:"pt",orientation:e.width>e.height?"landscape":"portrait",margins:{top:20,bottom:20,left:20,right:20},grid:{enabled:e.show_grid,size:e.grid_size,snap:e.snap_to_grid,visible:e.show_grid},background:{color:e.background_color}}}static convertReportElementToTemplateElement(e){const t=this.getElementType(e.content),i=this.convertElementContent(e.content),s=this.convertElementStyle(e.content);return{id:e.id,element_type:t,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},z_index:e.z_index,visible:e.visible,content:i,style:s,data_binding:this.extractDataBinding(e.content)}}static getElementType(e){switch(e.type){case"Text":return"Text";case"DataField":return"DataField";case"Rectangle":return"Rectangle";case"Line":return"Line";case"Image":return"Image";default:return"Text"}}static convertElementContent(e){switch(e.type){case"Text":return{text:e.content,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"DataField":return{expression:e.expression,format:e.format,font:this.convertTextStyleToFont(e.style),alignment:this.convertTextStyleToAlignment(e.style),color:e.style.color};case"Rectangle":return{color:e.fill_color};case"Line":return{color:e.color};case"Image":return{expression:e.src,text:e.alt};default:return{}}}static convertTextStyleToFont(e){return{family:e.font_family||"Arial",size:e.font_size||12,weight:this.mapFontWeight(e.font_weight),style:"normal"}}static convertTextStyleToAlignment(e){return{horizontal:this.mapTextAlign(e.align),vertical:"middle"}}static convertElementStyle(e){const t={};switch(e.type){case"Rectangle":e.fill_color&&(t.background={color:e.fill_color}),e.border&&(t.border={width:e.border.width,color:e.border.color,style:this.mapBorderStyle(e.border.style)});break;case"Text":case"DataField":e.style.background&&(t.background={color:e.style.background.color}),e.style.border&&(t.border={width:e.style.border.width,color:e.style.border.color,style:this.mapBorderStyle(e.style.border.style)});break}return t}static extractDataBinding(e){if(e.type==="DataField"&&e.data_source_id)return{source_id:e.data_source_id,field_name:this.extractFieldNameFromExpression(e.expression)}}static extractFieldNameFromExpression(e){return e.match(/^\{([^}]+)\}$/)?.[1]??e}static toAppState(e){const t=e.metadata.description||void 0;return{elements:e.elements.map(i=>this.convertTemplateElementToReportElement(i)),canvas_config:this.convertCanvasToCanvasConfig(e.canvas),selected_ids:[],can_undo:!1,can_redo:!1,dirty:!1,...t&&{template_name:t}}}static convertCanvasToCanvasConfig(e){return{width:e.width,height:e.height,zoom:1,offset_x:0,offset_y:0,show_grid:e.grid.enabled,show_rulers:!0,grid_size:e.grid.size,snap_to_grid:e.grid.snap,background_color:e.background.color}}static convertTemplateElementToReportElement(e){const t=this.convertTemplateContentToElementContent(e);return{id:e.id,position:{x:e.position.x,y:e.position.y},size:{width:e.size.width,height:e.size.height},content:t,z_index:e.z_index,visible:e.visible,locked:!1}}static convertTemplateContentToElementContent(e){switch(e.element_type){case"Text":return{type:"Text",content:e.content.text||"",style:this.convertTemplateStyleToTextStyle(e)};case"DataField":return{type:"DataField",expression:e.content.expression||"{data}",...e.content.format&&{format:e.content.format},style:this.convertTemplateStyleToTextStyle(e),...e.data_binding?.source_id&&{data_source_id:e.data_binding.source_id}};case"Rectangle":return{type:"Rectangle",...e.style?.background?.color&&{fill_color:e.style.background.color},...e.content.color&&!e.style?.background?.color&&{fill_color:e.content.color},...e.style?.border&&{border:{color:e.style.border.color,width:e.style.border.width,style:this.mapTemplateBorderStyle(e.style.border.style)}},corner_radius:0,opacity:1};case"Line":return{type:"Line",color:e.content.color||"#000000",width:1,line_style:"Solid",opacity:1};case"Image":return{type:"Image",src:e.content.expression||"",...e.content.text&&{alt:e.content.text}};default:return{type:"Text",content:"Unknown Element",style:this.createDefaultTextStyle()}}}static convertTemplateStyleToTextStyle(e){const t=e.content.font,i=e.content.alignment,s=e.style;return{font_family:t?.family||"Arial",font_size:t?.size||12,font_weight:this.mapTemplateFont(t?.weight),color:e.content.color||"#000000",align:this.mapTemplateAlignment(i?.horizontal),background:s?.background?{color:s.background.color||"",opacity:1,padding:0}:void 0,border:s?.border?{color:s.border.color,width:s.border.width,style:this.mapTemplateBorderStyle(s.border.style),radius:0}:void 0}}static createDefaultTextStyle(){return{font_family:"Arial",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}}static mapFontWeight(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTemplateFont(e){switch(e){case"bold":return"bold";case"light":return"light";default:return"normal"}}static mapTextAlign(e){switch(e){case"Center":return"center";case"Right":return"right";default:return"left"}}static mapTemplateAlignment(e){switch(e){case"center":return"Center";case"right":return"Right";default:return"Left"}}static mapBorderStyle(e){switch(e){case"Dashed":return"dashed";case"Dotted":return"dotted";default:return"solid"}}static mapTemplateBorderStyle(e){switch(e){case"dashed":return"Dashed";case"dotted":return"Dotted";default:return"Solid"}}}var pa=S("<span class=text-warning>●"),ma=S("<span class=ml-2> 个元素"),ba=S('<span class="ml-2 text-primary">已选择 <!> 个'),ya=S('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建模板 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开模板 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存模板 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=数据源管理><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg><span>数据源</span></button><button class="toolbar-btn opacity-50 cursor-not-allowed"title="输出预览 - 即将推出 (PDF/打印预览功能)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>输出预览</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const _a=n=>{const{state:e,undo:t,redo:i,updateCanvasConfig:s,setState:r}=ct(),[a,l]=Z(e.canvas_config.zoom*100),o=async()=>{try{const m=await ti.createEmptyTemplate(),_=ni.toAppState(m);r(_),console.log("✅ 新建模板成功")}catch(m){console.error("❌ 新建模板失败:",m),alert("新建模板失败")}},c=async()=>{try{const m=await da({title:"打开模板文件",filters:[{name:"Jasper模板",extensions:["jasper","jbin","jrxml"]}],multiple:!1});if(m&&typeof m=="string"){const _=await ti.loadTemplate(m),w=ni.toAppState(_);r({...w,template_name:_.metadata.description||"未命名模板"}),console.log("✅ 模板加载成功:",m)}}catch(m){console.error("❌ 加载模板失败:",m),alert("加载模板失败")}},d=async()=>{try{const m=await ha({title:"保存模板文件",filters:[{name:"Jasper模板",extensions:["jasper"]}],defaultPath:e.template_name||"未命名模板"});if(m){const _=ni.toJasperTemplate(e,{description:e.template_name||"未命名模板"});await ti.saveTemplate(_,m),console.log("✅ 模板保存成功:",m)}}catch(m){console.error("❌ 保存模板失败:",m),alert("保存模板失败")}},h=async m=>{const _=m/100;l(m);try{await s({zoom:_})}catch(w){console.error("Failed to update zoom:",w)}},u=()=>{const m=Math.min(a()+25,500);h(m)},v=()=>{const m=Math.max(a()-25,25);h(m)},f=async()=>{try{await s({show_grid:!e.canvas_config.show_grid})}catch(m){console.error("Failed to toggle grid:",m)}},p=async()=>{try{await s({show_rulers:!e.canvas_config.show_rulers})}catch(m){console.error("Failed to toggle rulers:",m)}},b=async()=>{try{await me("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(m){console.error("Failed to toggle DevTools:",m)}};return(()=>{var m=ya(),_=m.firstChild,w=_.firstChild,x=w.nextSibling,C=x.nextSibling,A=C.nextSibling,M=A.nextSibling,I=M.nextSibling,z=_.nextSibling,E=z.firstChild,R=E.nextSibling,T=R.nextSibling,U=T.nextSibling,N=U.nextSibling,$=N.nextSibling,P=$.nextSibling,Q=P.nextSibling,G=Q.nextSibling,D=G.nextSibling,V=D.nextSibling,q=z.nextSibling,W=q.firstChild;return w.$$click=o,x.$$click=c,C.$$click=d,g(_,y(na,{}),M),M.$$click=()=>{console.log("🔄 数据源按钮被点击！"),n.onOpenDataSources()},I.$$click=()=>{alert(`📄 输出预览即将推出！

✨ 即将支持的功能：
• PDF格式预览
• 打印效果预览
• 分页显示
• 导出设置`)},I.disabled=!0,Le(E,"click",t),Le(R,"click",i),U.$$click=v,N.addEventListener("change",j=>{const he=j.target.value;if(he==="fit")console.log("Fit to window");else{const _e=parseInt(he.replace("%",""));h(_e)}}),$.$$click=u,Q.$$click=f,G.$$click=p,V.$$click=b,g(q,y(H,{get when(){return e.dirty},get children(){return pa()}}),W),g(W,()=>e.template_name||"未命名模板"),g(q,y(H,{get when(){return e.elements.length>0},get children(){var j=ma(),he=j.firstChild;return g(j,()=>e.elements.length,he),j}}),null),g(q,y(H,{get when(){return e.selected_ids.length>0},get children(){var j=ba(),he=j.firstChild,_e=he.nextSibling;return _e.nextSibling,g(j,()=>e.selected_ids.length,_e),j}}),null),B(j=>{var he=`toolbar-btn-icon ${e.can_undo?"":"opacity-50 cursor-not-allowed"}`,_e=!e.can_undo,pe=`撤销${e.undo_description?` (${e.undo_description})`:""} (Ctrl+Z)`,se=`toolbar-btn-icon ${e.can_redo?"":"opacity-50 cursor-not-allowed"}`,ce=!e.can_redo,ue=`重做${e.redo_description?` (${e.redo_description})`:""} (Ctrl+Y)`,ve=`toolbar-btn-icon ${e.canvas_config.show_grid?"active":""}`,ne=`toolbar-btn-icon ${e.canvas_config.show_rulers?"active":""}`;return he!==j.e&&Se(E,j.e=he),_e!==j.t&&(E.disabled=j.t=_e),pe!==j.a&&X(E,"title",j.a=pe),se!==j.o&&Se(R,j.o=se),ce!==j.i&&(R.disabled=j.i=ce),ue!==j.n&&X(R,"title",j.n=ue),ve!==j.s&&Se(Q,j.s=ve),ne!==j.h&&Se(G,j.h=ne),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),B(()=>N.value=`${Math.round(a())}%`),m})()};He(["click"]);var xa=S('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),Sa=S('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const qi=()=>{const{createElement:n}=ct(),[e,t]=Z(""),i=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:c=>({type:"Text",content:c?.text||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:c=>({type:"DataField",expression:c?.expression||"${fieldName}",format:c?.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:c=>({type:"Rectangle",fill_color:c?.fill_color||"transparent",border:{color:c?.border_color||"#000000",width:c?.border_width||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:c=>({type:"Line",color:c?.color||"#000000",width:c?.width||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:c=>({type:"Image",src:c?.src||"",alt:c?.alt||"图片"})}],s=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left",border:{color:"#cccccc",width:1,style:"Solid",radius:0},background:{color:"#f8f9fa",opacity:.8,padding:2}}})}],r=[...i,...s],a=()=>{const c=e().toLowerCase();return c?r.filter(d=>d.name.toLowerCase().includes(c)||d.description.toLowerCase().includes(c)):r},l=(c,d)=>{if(console.log("Starting drag for component:",c.id),d.dataTransfer){d.dataTransfer.effectAllowed="copy",d.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:c}));const h=document.createElement("div");h.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${c.icon} ${c.name}
        </div>
      `,h.style.position="absolute",h.style.top="-1000px",document.body.appendChild(h),d.dataTransfer.setDragImage(h,50,20),setTimeout(()=>{document.body.removeChild(h)},0)}},o=async c=>{try{const d=await n(c.id,{x:100,y:100},c.default_size,c.create_content());console.log("Created element:",d)}catch(d){console.error("Failed to create element:",d)}};return(()=>{var c=xa(),d=c.firstChild,h=d.firstChild,u=h.nextSibling,v=d.nextSibling,f=v.firstChild,p=f.firstChild,b=p.firstChild,m=b.nextSibling,_=p.nextSibling,w=_.firstChild,x=w.nextSibling,C=_.nextSibling,A=C.firstChild,M=A.nextSibling;return u.$$input=I=>t(I.target.value),g(m,y(fe,{get each(){return a().filter(I=>I.category==="basic")},children:I=>y(ii,{component:I,onDrag:z=>l(I,z),onClick:()=>o(I)})})),g(x,y(fe,{get each(){return a().filter(I=>I.category==="data")},children:I=>y(ii,{component:I,onDrag:z=>l(I,z),onClick:()=>o(I)})})),g(M,y(fe,{get each(){return a().filter(I=>I.category==="bank")},children:I=>y(ii,{component:I,onDrag:z=>l(I,z),onClick:()=>o(I)})})),B(()=>u.value=e()),c})()},ii=n=>(()=>{var e=Sa(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Le(e,"click",n.onClick),e.addEventListener("dragstart",r=>n.onDrag(r)),X(e,"draggable",!0),g(i,()=>n.component.icon),g(s,()=>n.component.name),B(()=>X(e,"title",n.component.description)),e})();He(["input","click"]);class Ae{static async listDataSources(){return me("list_data_sources")}static async deleteDataSource(e){return me("delete_data_source",{req:{sourceId:e}})}static async updateConfig(e,t){return me("update_data_source_config",{req:{sourceId:e,config:t}})}static async queryDataSource(e,t){return me("query_data_source",{req:{sourceId:e,query:t}})}static async getDataPreview(e,t){return me("get_data_preview",{req:{sourceId:e,limit:t}})}static async testConnection(e,t){return me("test_data_source_connection",{req:{providerType:e,config:t}})}static async discoverSchema(e,t){return me("discover_schema",{req:{providerType:e,config:t}})}static async testDatabaseConnection(e){return me("test_database_connection",{config:e})}static async loadDatabaseSchema(e){return me("load_database_schema",{config:e})}static async executeDatabasePreview(e,t,i){return me("execute_database_preview",{req:{config:e,sql:t,limit:i}})}static async validateSqlSyntax(e,t){if(console.log("🔍 验证SQL语法 - 参数:",{sql:e.length+" 字符",databaseType:t}),!e||e.trim().length===0)throw new Error("SQL不能为空");if(!t)throw console.error("❌ databaseType参数为空或未定义:",t),new Error("数据库类型不能为空");try{const i={sql:e,databaseType:t};return console.log("🔍 将传递给Rust的参数:",i),console.log("🔍 参数对象的键:",Object.keys(i)),console.log("🔍 参数JSON:",JSON.stringify(i)),await me("validate_sql_syntax",{req:i})}catch(i){throw console.error("❌ 调用失败:",i),i}}static async formatSql(e,t){return me("format_sql",{req:{sql:e,databaseType:t}})}static async saveDataSource(e){try{const t=e.config;console.log("🔍 saveDataSource 请求参数:",{name:e.name,selected_tables:e.selected_tables,selected_tables_type:typeof e.selected_tables,selected_tables_length:e.selected_tables?.length,sql_length:e.sql?.length});const i=e.selected_tables||[];console.log("🔍 实际传递的 selectedTables:",i);const s=await me("create_database_source",{req:{name:e.name,description:e.description||null,databaseType:t.database_type,host:t.host,port:t.port,database:t.database,username:t.username,password:t.password||null,sql:e.sql,selectedTables:i,tags:e.tags?e.tags:null}});return{success:!0,data_source_id:String(s),message:`数据源 "${e.name}" 创建成功`,warnings:[],errors:[]}}catch(t){return{success:!1,data_source_id:"",message:`保存数据源失败: ${t}`,warnings:[],errors:[String(t)]}}}static async createDataSource(e,t,i){return me("create_data_source",{req:{name:e,providerType:t,config:i}})}static async getPreview(e,t,i){return this.getDataPreview(e,i)}static async queryData(e,t){return this.queryDataSource(e,t||{})}static async evaluateExpression(e,t,i){return me("evaluate_expression",{req:{sourceId:e,expression:t,context:i}})}static async getAvailableTypes(){return me("get_available_data_source_types")}static async getSchema(e){return me("get_data_source_schema",{req:{sourceId:e}})}static async getConfigSchema(e){return me("get_config_schema",{req:{providerType:e}})}static async getDefaultConfig(e){return me("get_default_config",{req:{providerType:e}})}static async validateConfig(e,t){return me("validate_config",{req:{providerType:e,config:t}})}static async captureDataPreview(e,t){return this.executeDatabasePreview(e,t,50)}static async validateDataSourceBeforeSave(e){try{console.log("🔍 开始验证数据源保存前检查"),console.log("🔍 请求配置:",e.config),console.log("🔍 数据库类型:",e.config.database_type);const t=await this.testDatabaseConnection(e.config),i=await this.validateSqlSyntax(e.sql,e.config.database_type),s=await this.performSecurityCheck(e.config,e.sql);return{connection_valid:t.success,sql_valid:i.valid,security_passed:s.is_safe,performance_acceptable:!0,warnings:[...i.warnings||[],...s.warnings||[]],errors:[]}}catch(t){return{connection_valid:!1,sql_valid:!1,security_passed:!1,performance_acceptable:!1,warnings:[],errors:[String(t)]}}}static async performSecurityCheck(e,t){const i=[],s=[],r=[/drop\s+table/i,/truncate\s+table/i,/delete\s+from/i,/update\s+.*set/i,/insert\s+into/i,/alter\s+table/i];for(const a of r)if(a.test(t)){i.push("包含可能危险的SQL操作");break}return{is_safe:i.length===0,security_issues:i,warnings:s}}}class wa{styles=new Map;elementStyleMap=new Map;observers=new Set;initialized=!1;constructor(){console.log("🎨 TextStyleManager 初始化中...")}async initialize(){if(!this.initialized)try{await this.loadSystemStyles(),await this.loadUserStyles(),this.initialized=!0,console.log(`✅ TextStyleManager 初始化完成，加载了 ${this.styles.size} 个样式`)}catch(e){throw console.error("❌ TextStyleManager 初始化失败:",e),e}}createStyle(e){const t=`style_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={...e,id:t,metadata:{createdAt:new Date,lastModified:new Date,author:"user",usageCount:0,isSystemStyle:!1,tags:[]}};return this.styles.set(t,i),this.notifyObservers("style-created",t),this.saveUserStyles(),console.log(`🎨 创建新样式: ${i.name} (${t})`),t}getStyle(e){return this.styles.get(e)||null}updateStyle(e,t){const i=this.styles.get(e);if(!i)return console.warn(`⚠️ 样式 ${e} 不存在`),!1;if(i.metadata.isSystemStyle)return console.warn(`⚠️ 无法修改系统预设样式 ${e}`),!1;const s={...i,style:{...i.style,...t},metadata:{...i.metadata,lastModified:new Date}};return this.styles.set(e,s),this.syncAllStyleInstances(e),this.saveUserStyles(),this.notifyObservers("style-updated",e),console.log(`🔄 样式已更新: ${i.name} (${e})`),!0}deleteStyle(e){const t=this.styles.get(e);if(!t)return!1;if(t.metadata.isSystemStyle)return console.warn(`⚠️ 无法删除系统预设样式 ${e}`),!1;const i=Array.from(this.elementStyleMap.entries()).filter(([s,r])=>r===e).map(([s,r])=>s);return i.length>0?(console.warn(`⚠️ 无法删除样式 ${e}，仍有 ${i.length} 个元素在使用`),!1):(this.styles.delete(e),this.saveUserStyles(),this.notifyObservers("style-deleted",e),console.log(`🗑️ 样式已删除: ${t.name} (${e})`),!0)}applyStyleToElement(e,t){const i=this.styles.get(t);if(!i)return{success:!1,elementId:e,styleId:t,appliedAt:new Date,error:`样式 ${t} 不存在`};try{const s=this.elementStyleMap.get(e);if(this.elementStyleMap.set(e,t),i.metadata.usageCount++,s&&s!==t){const r=this.styles.get(s);r&&(r.metadata.usageCount=Math.max(0,r.metadata.usageCount-1))}return this.applyStyleToDOM(e,i.style),this.notifyObservers("style-applied",{elementId:e,styleId:t}),console.log(`🎯 应用样式: ${i.name} → 元素 ${e}`),{success:!0,elementId:e,styleId:t,appliedAt:new Date}}catch(s){return console.error(`❌ 应用样式失败: ${s}`),{success:!1,elementId:e,styleId:t,appliedAt:new Date,error:s instanceof Error?s.message:String(s)}}}getElementStyleId(e){return this.elementStyleMap.get(e)||null}removeElementStyle(e){const t=this.elementStyleMap.get(e);if(t){this.elementStyleMap.delete(e);const i=this.styles.get(t);i&&(i.metadata.usageCount=Math.max(0,i.metadata.usageCount-1)),console.log(`🔗 移除元素样式映射: 元素 ${e}`)}}getStylesByCategory(e){const t=Array.from(this.styles.values());return(e?t.filter(s=>s.category===e):t).sort((s,r)=>s.metadata.isSystemStyle!==r.metadata.isSystemStyle?s.metadata.isSystemStyle?-1:1:r.metadata.usageCount-s.metadata.usageCount)}searchStyles(e,t){const i=this.getStylesByCategory(t),s=e.toLowerCase().trim();return s?i.filter(r=>r.name.toLowerCase().includes(s)||r.description.toLowerCase().includes(s)||r.metadata.tags.some(a=>a.toLowerCase().includes(s))):i}getStyleUsageStats(){const e=[];for(const[t,i]of this.styles){const s=Array.from(this.elementStyleMap.entries()).filter(([r,a])=>a===t).map(([r,a])=>r);e.push({styleId:t,usageCount:s.length,elements:s,lastUsed:i.metadata.lastModified})}return e.sort((t,i)=>i.usageCount-t.usageCount)}cleanupUnusedStyles(){const e=new Set(this.elementStyleMap.values()),t=[];for(const[i,s]of this.styles)!e.has(i)&&!s.metadata.isSystemStyle&&(this.styles.delete(i),t.push(i),console.log(`🧹 清理未使用样式: ${s.name} (${i})`));return t.length>0&&this.saveUserStyles(),t}exportStyles(e){const t=e?e.map(s=>this.styles.get(s)).filter(Boolean):Array.from(this.styles.values()),i=new Set(t.map(s=>s.category));return{version:"2.0.0",exportedAt:new Date,styles:t,metadata:{totalStyles:t.length,categories:Array.from(i),author:"user"}}}async importStyles(e){const t=[];for(const i of e.styles){if(Array.from(this.styles.values()).find(a=>a.name===i.name&&a.category===i.category)){console.warn(`⚠️ 跳过已存在的样式: ${i.name}`);continue}const r=this.createStyle({name:i.name,description:i.description,category:i.category,style:i.style,...i.inheritance&&{inheritance:i.inheritance}});t.push(r)}return console.log(`📦 导入完成，共导入 ${t.length} 个样式`),t}addObserver(e){this.observers.add(e)}removeObserver(e){this.observers.delete(e)}syncAllStyleInstances(e){const t=this.styles.get(e);if(!t)return;const i=[];for(const[s,r]of this.elementStyleMap)r===e&&(this.applyStyleToDOM(s,t.style),i.push(s));this.notifyObservers("styles-synced",{styleId:e,affectedElements:i}),console.log(`🔄 样式同步完成: ${e} → ${i.length} 个元素`)}applyStyleToDOM(e,t){console.log(`🎨 应用样式到DOM: 元素 ${e}`,{font_family:t.font_family,font_size:t.font_size,typography:t.typography})}async loadSystemStyles(){try{const{BANK_TEXT_STYLES:e}=await fa(async()=>{const{BANK_TEXT_STYLES:t}=await import("./bank-text-styles-BtzE7aIi.js");return{BANK_TEXT_STYLES:t}},[]);for(const t of e)this.styles.set(t.id,t);console.log(`🏦 加载了 ${e.length} 个银行预设样式`)}catch(e){console.warn("⚠️ 加载系统样式失败:",e)}}async loadUserStyles(){try{const e=localStorage.getItem("jasper-text-styles");if(e){const t=JSON.parse(e);for(const i of t)i.metadata.createdAt=new Date(i.metadata.createdAt),i.metadata.lastModified=new Date(i.metadata.lastModified),this.styles.set(i.id,i);console.log(`👤 加载了 ${t.length} 个用户自定义样式`)}}catch(e){console.warn("⚠️ 加载用户样式失败:",e)}}saveUserStyles(){try{const e=Array.from(this.styles.values()).filter(t=>!t.metadata.isSystemStyle);localStorage.setItem("jasper-text-styles",JSON.stringify(e)),console.log(`💾 保存了 ${e.length} 个用户自定义样式`)}catch(e){console.error("❌ 保存用户样式失败:",e)}}notifyObservers(e,t){for(const i of this.observers)try{i.onStyleChange(e,t)}catch(s){console.error("❌ 观察者通知失败:",s)}}}const Xe=new wa;class $a{calculateUnifiedBounds(e,t,i){const s=this.calculateFontMetrics(t),r=this.measureTextContent(e,t,i.width),a=this.calculateContainerHeight(r,s,i.height),l=this.calculateTextPositioning(t,i,a,s),o={containerBounds:{x:0,y:0,width:i.width,height:a},contentBounds:r.bounds,fontMetrics:s,positioning:l};return r.wrappedLines&&(o.textLayout={wrappedLines:r.wrappedLines,isWrapped:!0,originalLineCount:e.split(`
`).length,wrappedLineCount:r.wrappedLines.length}),o}calculateFontMetrics(e){const t=e.font_size,i=1.2,s=.75,r=.25,a=t*s,l=t*r;return{fontSize:t,lineHeight:t*i,ascender:a,descender:l,baseline:a}}getCharacterWidth(e,t){const i=t.font_size,s=t.font_family,r=/[\u4e00-\u9fa5]/.test(e),a={"Courier New":{chinese:.6,english:.6},Monaco:{chinese:.6,english:.6},Consolas:{chinese:.6,english:.6},SimSun:{chinese:1,english:.5},SimHei:{chinese:1,english:.5},KaiTi:{chinese:1.1,english:.6},FangSong:{chinese:1,english:.55},Arial:{chinese:1,english:.55},Helvetica:{chinese:1,english:.55},"Times New Roman":{chinese:1,english:.5},"Microsoft YaHei":{chinese:1,english:.52},"PingFang SC":{chinese:1,english:.52},"Noto Sans":{chinese:1,english:.53},default:{chinese:1,english:.55}},l=s.toLowerCase();let o=a.default;for(const[d,h]of Object.entries(a))if(l.includes(d.toLowerCase())||d.toLowerCase().includes(l)){o=h;break}const c=r?o.chinese:o.english;return i*c}calculateTextWidth(e,t){let i=0;for(const s of e)s!==`
`&&(i+=this.getCharacterWidth(s,t));return i}measureTextContent(e,t,i=0){const s=e.split(`
`),r=s.length;let a=0;for(const c of s){const d=this.calculateTextWidth(c,t);a=Math.max(a,d)}if(i>0&&a>i)return this.calculateWrappedText(e,t,i);const l=i>0?Math.min(a,i):a,o=r*t.font_size*1.2;return{bounds:{x:0,y:0,width:l,height:o},lineCount:r,actualHeight:o}}calculateWrappedText(e,t,i){const s=this.getCharacterWidth("测",t);if(Math.floor(i/s)<1||i<s)return{bounds:{x:0,y:0,width:i,height:t.font_size*1.2},lineCount:1,actualHeight:t.font_size*1.2,wrappedLines:["..."]};const a=this.smartSegmentation(e);let l=[],o="",c=0;for(const h of a){const u=this.calculateTextWidth(h,t),v=c+u;if(v>i)if(o.trim())l.push(o.trim()),o=h,c=u;else{const{truncated:f,remaining:p}=this.forceTruncateSegment(h,i,t);l.push(f),o=p,c=this.calculateTextWidth(p,t)}else o+=h,c=v}o.trim()&&l.push(o.trim());const d=l.length*t.font_size*1.2;return{bounds:{x:0,y:0,width:i,height:d},lineCount:l.length,actualHeight:d,wrappedLines:l}}forceTruncateSegment(e,t,i){let s="",r=0,a=0;for(a=0;a<e.length;a++){const o=e[a];if(!o)break;const c=this.getCharacterWidth(o,i);if(r+c>t)break;s+=o,r+=c}const l=e.substring(a);return{truncated:s,remaining:l}}smartSegmentation(e){const t=[];let i="";for(let s=0;s<e.length;s++){const r=e[s];r&&(/[\u4e00-\u9fa5]/.test(r)?(i&&(t.push(i),i=""),t.push(r)):r===`
`?(i&&(t.push(i),i=""),t.push(`
`)):r===" "?i?(t.push(i+" "),i=""):t.push(" "):i+=r)}return i&&t.push(i),t.filter(s=>s.length>0)}calculateContainerHeight(e,t,i){const s=t.lineHeight*e.lineCount,r=t.ascender+t.descender,a=t.lineHeight,l=Math.max(s,r,a);return Math.max(l,i)}calculateTextPositioning(e,t,i,s){const r=this.calculateHorizontalAnchor(e.align,t.width),a=s.baseline,l=e.background?.padding||0,o=-l,c=-l;return{textAnchorX:r,textAnchorY:a,backgroundX:o,backgroundY:c}}calculateHorizontalAnchor(e,t){switch(e){case"Left":return 0;case"Center":return t/2;case"Right":return t;default:return 0}}getTextAnchor(e){switch(e){case"Left":return"start";case"Center":return"middle";case"Right":return"end";default:return"start"}}debugBounds(e,t){}}const qt=new $a;class Ca{initialized=!1;constructor(){this.initialize()}async initialize(){if(!this.initialized)try{await Xe.initialize(),this.initialized=!0,console.log("🎨 ProfessionalTextRenderer 已初始化")}catch(e){console.error("❌ ProfessionalTextRenderer 初始化失败:",e)}}isElementUsingProfessionalStyle(e){return Xe.getElementStyleId(e)!==null}adaptLegacyTextStyle(e){return{...e,font_weight:e.font_weight,typography:{letterSpacing:0,lineHeight:1.2,paragraphSpacing:0,textIndent:0,decoration:{underline:!1,strikethrough:!1,overline:!1,decorationStyle:"solid"},textTransform:"none",whiteSpace:"normal"},fills:[{type:"solid",enabled:!0,opacity:1,solid:{color:e.color}}],effects:[]}}renderProfessionalText(e,t=!1){if(e.content.type!=="Text"&&e.content.type!=="DataField")return null;const i=Xe.getElementStyleId(e.id);let s;if(i){const l=Xe.getStyle(i);if(!l)return console.warn(`⚠️ 找不到样式定义: ${i}`),null;s=l.style,console.log(`🎨 使用专业样式渲染: ${l.name} (${i})`)}else{const l=e.content.type==="Text"||e.content.type==="DataField"?e.content.style:null;if(!l)return null;s=this.adaptLegacyTextStyle(l),console.log("🔄 适配传统样式到专业排版系统")}const r=this.calculateEnhancedBounds(e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",s,e.size);return{element:this.createProfessionalTextElement(r,e.content.type==="Text"?e.content.content:e.content.expression||"[数据字段]",s,!1),bounds:r,style:s}}calculateEnhancedBounds(e,t,i){const s=qt.calculateUnifiedBounds(e,t,i),r=t.typography,a=this.calculateLetterSpacingEffect(e,r.letterSpacing),l=this.calculateLineHeightEffect(e,t.font_size,r.lineHeight),o=this.calculateParagraphSpacingEffect(e,r.paragraphSpacing);return{containerBounds:s.containerBounds,positioning:s.positioning,fontMetrics:s.fontMetrics,typography:{adjustedWidth:s.containerBounds.width+a.widthIncrease,adjustedHeight:s.containerBounds.height+l.heightIncrease+o.heightIncrease,letterSpacingData:a,lineHeightData:l,paragraphData:o}}}calculateLetterSpacingEffect(e,t){const i=e.split(`
`),s=i.reduce((a,l)=>a+l.length,0),r=Math.max(0,s-i.length);return{spacingValue:t,totalSpaces:r,widthIncrease:r*t,charPositions:[]}}calculateLineHeightEffect(e,t,i){const r=e.split(`
`).length,a=t*i,l=t*1.2,o=a-l;return{lineHeightRatio:i,actualLineHeight:a,lineCount:r,heightIncrease:o*Math.max(0,r-1),baselinePositions:[]}}calculateParagraphSpacingEffect(e,t){const s=e.split(`

`).length;return{spacing:t,paragraphCount:s,heightIncrease:t*Math.max(0,s-1),paragraphPositions:[]}}createProfessionalTextElement(e,t,i,s){const r=document.createElementNS("http://www.w3.org/2000/svg","g");return r.setAttribute("class","professional-text-container"),this.renderMultipleFills(r,e,i.fills),this.renderEffects(r,e,i.effects),this.renderTypographyText(r,e,t,i),this.renderTextDecorations(r,e,t,i.typography.decoration),r}renderMultipleFills(e,t,i){if(i&&i.length>0&&i[0].enabled){const s=i[0];s.type==="solid"&&s.solid&&console.log("🎨 应用纯色填充:",s.solid.color)}}renderEffects(e,t,i){if(!i||i.length===0)return;const s=document.createElementNS("http://www.w3.org/2000/svg","defs"),r=document.createElementNS("http://www.w3.org/2000/svg","filter"),a=`text-effects-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;r.id=a;for(const l of i)if(l.enabled&&l.type==="drop-shadow"&&l.dropShadow){const o=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");o.setAttribute("dx",l.dropShadow.offsetX.toString()),o.setAttribute("dy",l.dropShadow.offsetY.toString()),o.setAttribute("stdDeviation",l.dropShadow.blur.toString()),o.setAttribute("flood-color",l.dropShadow.color),o.setAttribute("flood-opacity",l.dropShadow.opacity.toString()),r.appendChild(o),console.log("✨ 应用投影效果")}r.children.length>0&&(s.appendChild(r),e.appendChild(s),e.setAttribute("filter",`url(#${a})`))}renderTypographyText(e,t,i,s){const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("font-family",s.font_family),r.setAttribute("font-size",s.font_size.toString()),r.setAttribute("font-weight",s.font_weight),r.setAttribute("fill",s.fills[0]?.solid?.color||s.color),r.setAttribute("text-anchor",this.getTextAnchor(s.align));const a=i.split(`
`),l=s.typography;a.forEach((o,c)=>{const d=document.createElementNS("http://www.w3.org/2000/svg","tspan");l.letterSpacing!==0&&d.setAttribute("letter-spacing",`${l.letterSpacing}px`);const h=t.positioning.textAnchorY+c*t.typography.lineHeightData.actualLineHeight;if(d.setAttribute("x",t.positioning.textAnchorX.toString()),d.setAttribute("y",h.toString()),c===0&&l.textIndent!==0){const u=t.positioning.textAnchorX+l.textIndent;d.setAttribute("x",u.toString())}l.textTransform&&l.textTransform!=="none"?d.textContent=this.applyTextTransform(o,l.textTransform):d.textContent=o,r.appendChild(d)}),e.appendChild(r)}renderTextDecorations(e,t,i,s){if(!s.underline&&!s.strikethrough&&!s.overline)return;const r=i.split(`
`),a=s.decorationColor||"#000000",l=s.decorationThickness||1,o=s.decorationStyle==="dashed"?"4,2":s.decorationStyle==="dotted"?"1,1":"none";r.forEach((c,d)=>{if(!c.trim())return;const h=t.positioning.textAnchorY+d*t.typography.lineHeightData.actualLineHeight,u=c.length*t.fontMetrics.fontSize*.6,v=t.positioning.textAnchorX,f=v+u;if(s.underline){const p=h+t.fontMetrics.fontSize*.1;this.createDecorationLine(e,v,p,f,p,a,l,o,"underline")}if(s.strikethrough){const p=h-t.fontMetrics.fontSize*.3;this.createDecorationLine(e,v,p,f,p,a,l,o,"strikethrough")}if(s.overline){const p=h-t.fontMetrics.fontSize*.8;this.createDecorationLine(e,v,p,f,p,a,l,o,"overline")}})}createDecorationLine(e,t,i,s,r,a,l,o,c){const d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",t.toString()),d.setAttribute("y1",i.toString()),d.setAttribute("x2",s.toString()),d.setAttribute("y2",r.toString()),d.setAttribute("stroke",a),d.setAttribute("stroke-width",l.toString()),d.setAttribute("stroke-dasharray",o),d.setAttribute("class",`text-decoration-${c}`),e.appendChild(d)}getTextAnchor(e){switch(e){case"Center":return"middle";case"Right":return"end";case"Left":default:return"start"}}applyTextTransform(e,t){switch(t){case"uppercase":return e.toUpperCase();case"lowercase":return e.toLowerCase();case"capitalize":return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase();default:return e}}}const ka=new Ca;var Ta=S("<button class=search-clear title=清除搜索>✕"),Ea=S('<div class=style-picker-container><div class=style-categories></div><div class=style-search><div class=search-input-container><span class=search-icon>🔍</span><input type=text placeholder=搜索样式... class=search-input></div></div><div class=style-grid><div class="style-card create-style-card"><div class=create-style-content><div class=create-style-icon>➕</div><div class=create-style-label>新建样式</div></div></div></div><div class=style-stats><span class=stats-text> 个样式'),Pa=S("<button><span class=category-icon></span><span class=category-label>"),Aa=S("<div><div class=style-preview></div><div class=style-info><div class=style-name></div><div class=style-meta><span class=style-category></span></div></div><div class=style-actions>"),Ra=S("<span class=usage-count>"),La=S("<button class=edit-button title=编辑样式>✏️"),Ma=S("<span class=system-badge title=系统预设样式>🔒"),Da=S("<div class=selection-indicator>✓");const Oa=n=>{const[e,t]=Z("bank-special"),[i,s]=Z(""),[r,a]=Z([]);(async()=>{await Xe.initialize();const u=Xe.getStylesByCategory();a(u)})();const o=Me(()=>{let u=r();e()&&(u=u.filter(f=>f.category===e()));const v=i().toLowerCase().trim();return v&&(u=u.filter(f=>f.name.toLowerCase().includes(v)||f.description.toLowerCase().includes(v)||f.metadata.tags.some(p=>p.toLowerCase().includes(v)))),u}),c=[{key:"bank-special",label:"银行专用",icon:"🏦"},{key:"heading",label:"标题",icon:"📰"},{key:"body",label:"正文",icon:"📝"},{key:"caption",label:"说明",icon:"💬"},{key:"custom",label:"自定义",icon:"⚙️"}],d=u=>{console.log("🎯 选择样式:",u),n.onStyleSelect(u)},h=u=>{t(u),console.log("📂 切换分类:",u)};return(()=>{var u=Ea(),v=u.firstChild,f=v.nextSibling,p=f.firstChild,b=p.firstChild,m=b.nextSibling,_=f.nextSibling,w=_.firstChild,x=_.nextSibling,C=x.firstChild,A=C.firstChild;return g(v,y(fe,{each:c,children:M=>(()=>{var I=Pa(),z=I.firstChild,E=z.nextSibling;return I.$$click=()=>h(M.key),g(z,()=>M.icon),g(E,()=>M.label),B(R=>{var T=`category-button ${e()===M.key?"active":""}`,U=M.label;return T!==R.e&&Se(I,R.e=T),U!==R.t&&X(I,"title",R.t=U),R},{e:void 0,t:void 0}),I})()})),m.$$input=M=>s(M.target.value),g(p,y(H,{get when(){return i()},get children(){var M=Ta();return M.$$click=()=>s(""),M}}),null),g(_,y(fe,{get each(){return o()},children:M=>y(Ia,{style:M,get selected(){return n.selectedStyleId===M.id},onClick:()=>d(M.id),onEdit:()=>n.onStyleEdit(M.id)})}),w),Le(w,"click",n.onStyleCreate),g(C,()=>o().length,A),g(C,(()=>{var M=Ce(()=>!!i());return()=>M()&&` (搜索: "${i()}")`})(),null),B(()=>m.value=i()),u})()},Ia=n=>{const e=()=>{switch(n.style.category){case"bank-special":return n.style.id.includes("amount")?"¥123,456.78":n.style.id.includes("account")?"6222 0012 3456 7890":n.style.id.includes("institution")?n.style.name:n.style.id.includes("date")?"2025-08-19":n.style.name;case"heading":return n.style.name;case"body":return"正文示例文字 Abc";case"caption":return"说明文字";default:return n.style.name}},t=Me(()=>{const r=n.style.style;return{fontFamily:r.font_family,fontSize:`${Math.min(r.font_size,14)}px`,fontWeight:r.font_weight,color:r.fills?.[0]?.solid?.color||r.color,textAlign:r.align.toLowerCase(),letterSpacing:`${r.typography?.letterSpacing||0}px`,textDecoration:r.typography?.decoration?.underline?"underline":r.typography?.decoration?.strikethrough?"line-through":"none"}}),i=r=>{r.preventDefault(),n.onClick()},s=r=>{r.preventDefault(),r.stopPropagation(),n.onEdit()};return(()=>{var r=Aa(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.nextSibling,d=c.firstChild,h=l.nextSibling;return r.$$click=i,g(a,e),g(o,()=>n.style.name),g(d,()=>Na(n.style.category)),g(c,(()=>{var u=Ce(()=>n.style.metadata.usageCount>0);return()=>u()&&(()=>{var v=Ra();return g(v,()=>n.style.metadata.usageCount),B(()=>X(v,"title",`使用次数: ${n.style.metadata.usageCount}`)),v})()})(),null),g(h,(()=>{var u=Ce(()=>!n.style.metadata.isSystemStyle);return()=>u()&&(()=>{var v=La();return v.$$click=s,v})()})(),null),g(h,(()=>{var u=Ce(()=>!!n.style.metadata.isSystemStyle);return()=>u()&&Ma()})(),null),g(r,(()=>{var u=Ce(()=>!!n.selected);return()=>u()&&Da()})(),null),B(u=>{var v=`style-card ${n.selected?"selected":""} ${n.style.metadata.isSystemStyle?"system-style":"user-style"}`,f=t();return v!==u.e&&Se(r,u.e=v),u.t=Hs(a,f,u.t),u},{e:void 0,t:void 0}),r})()};function Na(n){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[n]||n}He(["input","click"]);var za=S("<button class=style-picker-toggle>"),Fa=S("<button class=style-reload-btn title=重新加载样式系统>🔄"),Ga=S("<div class=initialization-fallback><div class=fallback-content><span class=fallback-icon>⏳</span><span class=fallback-text>专业样式系统加载中...</span><div class=fallback-actions><button class=retry-btn>重试加载"),Ba=S("<div class=quick-style-actions><button class=apply-style-btn><span class=btn-icon>🎨</span><span class=btn-text>选择样式</span></button><button class=create-style-btn title=基于当前设置创建新样式><span class=btn-icon>➕</span><span class=btn-text>新建"),Ua=S("<div class=style-picker-panel>"),Ha=S("<div class=property-group><div class=property-group-title><span>📐</span><span>排版控制</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=typography-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>⚙️</span><span class=placeholder-text>高级排版控制功能</span><span class=placeholder-subtitle>字间距、行高、装饰等"),qa=S("<div class=property-group><div class=property-group-title><span>✨</span><span>视觉效果</span><div class=coming-soon-badge>即将推出</div></div><div class=property-group-content><div class=effects-controls-placeholder><div class=placeholder-content><span class=placeholder-icon>🌈</span><span class=placeholder-text>多重填充 & 阴影效果</span><span class=placeholder-subtitle>渐变、投影、发光等"),Wa=S('<div class="property-group debug-panel"><div class=property-group-title><span>🔧</span><span>调试信息</span></div><div class=property-group-content><div class=debug-info><div class=debug-item><span class=debug-label>元素ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>当前样式ID:</span><span class=debug-value></span></div><div class=debug-item><span class=debug-label>可用样式:</span><span class=debug-value> 个</span></div><div class=debug-item><span class=debug-label>使用专业渲染:</span><span class=debug-value>'),ja=S("<div class=professional-text-properties><div class=property-group><div class=property-group-title><span>🎨</span><span>专业文字样式</span><div class=property-group-actions></div></div><div class=property-group-content>"),Ya=S('<div class=current-style-info><div class=current-style-preview><div class=style-preview-badge><span class=style-name></span><span class=style-category></span></div><div class=style-actions><button class="style-action-btn edit-btn"title=编辑样式>✏️</button><button class="style-action-btn remove-btn"title=移除样式>🗑️');const Wi=n=>{const[e,t]=Z(null),[i,s]=Z(!1),[r,a]=Z([]),[l,o]=Z(!1);et(async()=>{try{await Xe.initialize();const m=Xe.getElementStyleId(n.element.id);t(m);const _=Xe.getStylesByCategory();a(_),o(!0),console.log("🎨 ProfessionalTextPropertiesPanel 初始化完成")}catch(m){console.error("❌ 专业文字属性面板初始化失败:",m)}});const c=Me(()=>{const m=e();return m?Xe.getStyle(m):null}),d=Me(()=>n.element.content.type==="Text"||n.element.content.type==="DataField"),h=async m=>{try{const _=await Xe.applyStyleToElement(n.element.id,m);if(_.success){t(m);const w=Xe.getStyle(m);if(w){const x=u(w.style);n.onUpdate(n.element.id,"content",{...n.element.content,style:x})}console.log("✅ 样式应用成功:",_)}else console.error("❌ 样式应用失败:",_.error)}catch(_){console.error("❌ 样式选择处理失败:",_)}},u=m=>({font_family:m.font_family,font_size:m.font_size,font_weight:m.font_weight,color:m.fills?.[0]?.solid?.color||m.color,align:m.align}),v=()=>{console.log("🆕 创建新样式")},f=m=>{console.log("✏️ 编辑样式:",m)},p=()=>{s(!i())},b=()=>{e()&&(Xe.removeElementStyle(n.element.id),t(null),console.log("🗑️ 移除元素样式"))};return d()?(()=>{var m=ja(),_=m.firstChild,w=_.firstChild,x=w.firstChild,C=x.nextSibling,A=C.nextSibling,M=w.nextSibling;return g(A,y(H,{get when(){return l()},get children(){var I=za();return I.$$click=p,g(I,()=>i()?"📝":"📚"),B(()=>X(I,"title",i()?"隐藏样式库":"显示样式库")),I}}),null),g(A,y(H,{get when(){return!l()},get children(){var I=Fa();return I.$$click=()=>window.location.reload(),I}}),null),g(M,y(H,{get when(){return!l()},get children(){var I=Ga(),z=I.firstChild,E=z.firstChild,R=E.nextSibling,T=R.nextSibling,U=T.firstChild;return U.$$click=async()=>{try{await Xe.initialize();const N=Xe.getStylesByCategory();a(N),o(!0),console.log("🔄 样式系统重新初始化成功")}catch(N){console.error("❌ 重新初始化失败:",N)}},I}}),null),g(M,y(H,{get when(){return l()},get children(){return[y(H,{get when(){return c()},children:I=>(()=>{var z=Ya(),E=z.firstChild,R=E.firstChild,T=R.firstChild,U=T.nextSibling,N=R.nextSibling,$=N.firstChild,P=$.nextSibling;return g(T,()=>I().name),g(U,()=>Va(I().category)),$.$$click=()=>f(I().id),P.$$click=b,z})()}),y(H,{get when(){return!c()},get children(){var I=Ba(),z=I.firstChild,E=z.nextSibling;return z.$$click=p,E.$$click=v,I}}),y(H,{get when(){return i()},get children(){var I=Ua();return g(I,y(Oa,{get selectedStyleId(){return e()},onStyleSelect:h,onStyleCreate:v,onStyleEdit:f})),I}})]}}),null),g(m,y(H,{get when(){return c()},get children(){return Ha()}}),null),g(m,y(H,{get when(){return c()},get children(){return qa()}}),null),g(m,y(H,{get when(){return!1},get children(){var I=Wa(),z=I.firstChild,E=z.nextSibling,R=E.firstChild,T=R.firstChild,U=T.firstChild,N=U.nextSibling,$=T.nextSibling,P=$.firstChild,Q=P.nextSibling,G=$.nextSibling,D=G.firstChild,V=D.nextSibling,q=V.firstChild,W=G.nextSibling,j=W.firstChild,he=j.nextSibling;return g(N,()=>n.element.id),g(Q,()=>e()||"无"),g(V,()=>r().length,q),g(he,()=>ka.isElementUsingProfessionalStyle(n.element.id)?"是":"否"),I}}),null),m})():null};function Va(n){return{"bank-special":"银行",heading:"标题",body:"正文",caption:"说明",custom:"自定义"}[n]||n}He(["click"]);var Xa=S('<div class="flex flex-col h-auto"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class=p-0>'),Qa=S('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),Ka=S("<span class=property-value>"),Ja=S('<span class="property-value text-xs text-muted">'),Wn=S("<div class=space-y-2>"),Jt=S("<input type=number class=property-input>"),Za=S('<div class="grid grid-cols-2 gap-2">'),ji=S("<input type=checkbox class=property-checkbox>"),el=S('<div class="p-4 space-y-4">'),Yi=S("<div>"),tl=S("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),nl=S("<div class=property-field><label class=property-label>"),il=S("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),Ks=S('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),Js=S("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),sl=S('<div class=space-y-2><div class="grid grid-cols-2 gap-2">'),Zs=S("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),rl=S('<div class=space-y-2><div class="grid grid-cols-3 gap-2">'),er=S('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),tr=S('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),al=S('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),ll=S("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),Vi=S("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),ol=S('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),cl=S("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),dl=S("<input type=text class=property-input placeholder=图片描述文字>"),hl=S("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),ul=S("<div class=space-y-3>"),gl=S("<img class=property-image>"),fl=S("<div class=property-loading>加载数据源..."),vl=S('<div class=data-source-info><div class="text-xs text-muted"><div><span class=font-medium>状态:</span> <span></span></div><div><span class=font-medium>类型:</span> </div><div><span class=font-medium>更新:</span> '),pl=S('<input type=text class=property-input placeholder="{name} 或 {user.email} 格式"title="使用 {fieldName} 语法引用数据字段，如 {name}, {price}, {user.email} 等">'),ml=S('<div class="text-xs text-blue-600">💡 提示: 使用 {fieldName} 语法，如 {name}, {price}, {user.email} 等'),bl=S('<div class="text-xs text-orange-600">⚠️ 注意: 选择数据源后表达式才能在预览模式下求值'),yl=S("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),_l=S("<div class=space-y-4>"),xl=S("<select class=property-select><option value>选择数据源"),Sl=S("<option> (<!>)"),wl=S('<div class=flex><input type=number class="property-input flex-1">'),$l=S("<span class=property-unit>"),Cl=S('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),kl=S("<div class=property-alignment-group>"),Tl=S("<button>");const Xi=()=>{const{state:n,updateElement:e}=ct(),t=Me(()=>{const r=new Set(n.selected_ids);return n.elements.filter(a=>r.has(a.id))}),i=Me(()=>t()[0]),s=async(r,a,l)=>{try{await e(r,{[a]:l})}catch(o){console.error("Failed to update element property:",o)}};return(()=>{var r=Xa(),a=r.firstChild,l=a.nextSibling;return g(l,y(H,{get when(){return i()},get fallback(){return Qa()},get children(){return y(El,{get element(){return i()},onUpdate:s})}})),r})()},El=n=>{const e=(i,s)=>{const r={...n.element.position,[i]:s};n.onUpdate(n.element.id,"position",r)},t=(i,s)=>{const r={...n.element.size,[i]:Math.max(1,s)};n.onUpdate(n.element.id,"size",r)};return(()=>{var i=el();return g(i,y(vt,{title:"元素信息",icon:"ℹ️",get children(){var s=Wn();return g(s,y(we,{label:"类型",get children(){var r=Ka();return g(r,()=>n.element.content.type),r}}),null),g(s,y(we,{label:"ID",get children(){var r=Ja();return g(r,()=>n.element.id),r}}),null),s}}),null),g(i,y(vt,{title:"位置和大小",icon:"📐",get children(){var s=Za();return g(s,y(we,{label:"X",get children(){var r=Jt();return r.$$input=a=>e("x",parseFloat(a.target.value)||0),B(()=>r.value=n.element.position.x),r}}),null),g(s,y(we,{label:"Y",get children(){var r=Jt();return r.$$input=a=>e("y",parseFloat(a.target.value)||0),B(()=>r.value=n.element.position.y),r}}),null),g(s,y(we,{label:"宽度",get children(){var r=Jt();return r.$$input=a=>t("width",parseFloat(a.target.value)||1),B(()=>r.value=n.element.size.width),r}}),null),g(s,y(we,{label:"高度",get children(){var r=Jt();return r.$$input=a=>t("height",parseFloat(a.target.value)||1),B(()=>r.value=n.element.size.height),r}}),null),s}}),null),g(i,y(vt,{title:"状态",icon:"👁️",get children(){var s=Wn();return g(s,y(we,{label:"可见",get children(){var r=ji();return r.addEventListener("change",a=>n.onUpdate(n.element.id,"visible",a.target.checked)),B(()=>r.checked=n.element.visible),r}}),null),g(s,y(we,{label:"锁定",get children(){var r=ji();return r.addEventListener("change",a=>n.onUpdate(n.element.id,"locked",a.target.checked)),B(()=>r.checked=n.element.locked),r}}),null),g(s,y(we,{label:"层级",get children(){var r=Jt();return r.$$input=a=>n.onUpdate(n.element.id,"z_index",parseInt(a.target.value)||0),B(()=>r.value=n.element.z_index),r}}),null),s}}),null),g(i,y(Us,{get children(){return[y(xt,{get when(){return n.element.content.type==="Text"&&n.element.content},children:s=>(()=>{var r=Yi();return g(r,y(Wi,{get element(){return n.element},get onUpdate(){return n.onUpdate}}),null),g(r,y(Pl,{get content(){return s()},onUpdate:a=>{console.log("Text content update:",a),n.onUpdate(n.element.id,"content",a)}}),null),r})()}),y(xt,{get when(){return n.element.content.type==="Rectangle"&&n.element.content},children:s=>y(Al,{get content(){return s()},onUpdate:r=>{console.log("Rectangle content update:",r),n.onUpdate(n.element.id,"content",r)}})}),y(xt,{get when(){return n.element.content.type==="Line"&&n.element.content},children:s=>y(Rl,{get content(){return s()},onUpdate:r=>{console.log("Line content update:",r),n.onUpdate(n.element.id,"content",r)}})}),y(xt,{get when(){return n.element.content.type==="Image"&&n.element.content},children:s=>y(Ll,{get content(){return s()},onUpdate:r=>{console.log("Image content update:",r),n.onUpdate(n.element.id,"content",r)}})}),y(xt,{get when(){return n.element.content.type==="DataField"&&n.element.content},children:s=>(()=>{var r=Yi();return g(r,y(Wi,{get element(){return n.element},get onUpdate(){return n.onUpdate}}),null),g(r,y(Ml,{get content(){return s()},onUpdate:a=>{console.log("🔍 [PropertiesPanel] DataField content update 接收到:",{更新内容:a,元素ID:n.element.id,当前content:s(),更新前data_source_id:s().data_source_id}),n.onUpdate(n.element.id,"content",a),console.log("🔍 [PropertiesPanel] 已调用 props.onUpdate")}}),null),r})()})]}}),null),i})()},vt=n=>(()=>{var e=tl(),t=e.firstChild,i=t.firstChild,s=i.nextSibling,r=t.nextSibling;return g(i,()=>n.icon),g(s,()=>n.title),g(r,()=>n.children),e})(),we=n=>(()=>{var e=nl(),t=e.firstChild;return g(t,()=>n.label),g(e,()=>n.children,null),e})(),Pl=n=>y(vt,{title:"文字样式",icon:"🔤",get children(){var e=er(),t=e.firstChild,i=t.nextSibling;return g(e,y(we,{label:"内容",get children(){var s=il();return s.$$input=r=>n.onUpdate({content:r.target.value}),B(()=>s.value=n.content.content),s}}),t),g(t,y(we,{label:"字体",get children(){var s=Ks();return s.addEventListener("change",r=>n.onUpdate({style:{...n.content.style,font_family:r.target.value}})),B(()=>s.value=n.content.style.font_family),s}}),null),g(t,y(we,{label:"大小",get children(){return y(gt,{get value(){return n.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:s=>n.onUpdate({style:{...n.content.style,font_size:s}})})}}),null),g(i,y(we,{label:"字重",get children(){var s=Js();return s.addEventListener("change",r=>n.onUpdate({style:{...n.content.style,font_weight:r.target.value}})),B(()=>s.value=n.content.style.font_weight),s}}),null),g(i,y(we,{label:"对齐",get children(){return y(nr,{get value(){return n.content.style.align},onUpdate:s=>n.onUpdate({style:{...n.content.style,align:s}})})}}),null),g(e,y(we,{label:"颜色",get children(){return y(Mt,{get value(){return n.content.style.color},onUpdate:s=>n.onUpdate({style:{...n.content.style,color:s}})})}}),null),g(e,y(we,{label:"背景",get children(){var s=sl(),r=s.firstChild;return g(s,y(Mt,{get value(){return n.content.style.background?.color||"transparent"},onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,color:a}}})}),r),g(r,y(we,{label:"透明度",get children(){return y(gt,{get value(){return n.content.style.background?.opacity||1},min:0,max:1,step:.1,onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,opacity:a}}})})}}),null),g(r,y(we,{label:"内边距",get children(){return y(gt,{get value(){return n.content.style.background?.padding||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,background:{...n.content.style.background,padding:a}}})})}}),null),s}}),null),g(e,y(we,{label:"边框",get children(){var s=rl(),r=s.firstChild;return g(s,y(Mt,{get value(){return n.content.style.border?.color||"#000000"},onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,color:a}}})}),r),g(r,y(we,{label:"宽度",get children(){return y(gt,{get value(){return n.content.style.border?.width||1},min:0,max:10,step:.5,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,width:a}}})})}}),null),g(r,y(we,{label:"样式",get children(){var a=Zs();return a.addEventListener("change",l=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,style:l.target.value}}})),B(()=>a.value=n.content.style.border?.style||"Solid"),a}}),null),g(r,y(we,{label:"圆角",get children(){return y(gt,{get value(){return n.content.style.border?.radius||0},min:0,max:20,step:1,unit:"px",onUpdate:a=>n.onUpdate({style:{...n.content.style,border:{...n.content.style.border,radius:a}}})})}}),null),s}}),null),e}}),Al=n=>y(vt,{title:"矩形样式",icon:"▭",get children(){var e=al(),t=e.firstChild,i=t.firstChild;return g(e,y(we,{label:"填充颜色",get children(){return y(Mt,{get value(){return n.content.fill_color||"#ffffff"},onUpdate:s=>n.onUpdate({fill_color:s})})}}),t),g(t,y(we,{label:"边框",get children(){var s=Wn();return g(s,y(Mt,{get value(){return n.content.border?.color||"#000000"},onUpdate:r=>n.onUpdate({border:{...n.content.border,color:r}})})),s}}),i),g(i,y(we,{label:"宽度",get children(){return y(gt,{get value(){return n.content.border?.width||1},min:0,max:20,step:.5,unit:"px",onUpdate:s=>n.onUpdate({border:{...n.content.border,width:s}})})}}),null),g(i,y(we,{label:"样式",get children(){var s=Zs();return s.addEventListener("change",r=>n.onUpdate({border:{...n.content.border,style:r.target.value}})),B(()=>s.value=n.content.border?.style||"Solid"),s}}),null),g(e,y(we,{label:"圆角半径",get children(){return y(gt,{get value(){return n.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:s=>n.onUpdate({corner_radius:s})})}}),null),g(e,y(we,{label:"透明度",get children(){var s=tr(),r=s.firstChild,a=r.nextSibling,l=a.firstChild;return r.$$input=o=>n.onUpdate({opacity:parseFloat(o.target.value)/100}),g(a,()=>Math.round((n.content.opacity||1)*100),l),B(()=>r.value=(n.content.opacity||1)*100),s}}),null),e}}),Rl=n=>y(vt,{title:"线条样式",icon:"━",get children(){var e=ol(),t=e.firstChild;return g(e,y(we,{label:"颜色",get children(){return y(Mt,{get value(){return n.content.color},onUpdate:i=>n.onUpdate({color:i})})}}),t),g(e,y(we,{label:"宽度",get children(){return y(gt,{get value(){return n.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:i=>n.onUpdate({width:i})})}}),t),g(e,y(we,{label:"样式",get children(){var i=ll();return i.addEventListener("change",s=>n.onUpdate({line_style:s.target.value})),B(()=>i.value=n.content.line_style||"Solid"),i}}),t),g(t,y(we,{label:"起点",get children(){var i=Vi();return i.addEventListener("change",s=>n.onUpdate({start_cap:s.target.value})),B(()=>i.value=n.content.start_cap||"None"),i}}),null),g(t,y(we,{label:"终点",get children(){var i=Vi();return i.addEventListener("change",s=>n.onUpdate({end_cap:s.target.value})),B(()=>i.value=n.content.end_cap||"None"),i}}),null),g(e,y(we,{label:"透明度",get children(){var i=tr(),s=i.firstChild,r=s.nextSibling,a=r.firstChild;return s.$$input=l=>n.onUpdate({opacity:parseFloat(l.target.value)/100}),g(r,()=>Math.round((n.content.opacity||1)*100),a),B(()=>s.value=(n.content.opacity||1)*100),i}}),null),e}}),Ll=n=>y(vt,{title:"图片属性",icon:"🖼️",get children(){var e=ul();return g(e,y(we,{label:"图片地址",get children(){var t=cl();return t.$$input=i=>n.onUpdate({src:i.target.value}),B(()=>t.value=n.content.src),t}}),null),g(e,y(we,{label:"替代文本",get children(){var t=dl();return t.$$input=i=>n.onUpdate({alt:i.target.value}),B(()=>t.value=n.content.alt||""),t}}),null),g(e,y(we,{label:"预览",get children(){var t=hl(),i=t.firstChild;return g(t,(()=>{var s=Ce(()=>!!n.content.src);return()=>s()?(()=>{var r=gl();return r.addEventListener("load",a=>{const l=a.target,o=l.nextElementSibling;l&&(l.style.display="block"),o&&(o.style.display="none")}),r.addEventListener("error",a=>{const l=a.target,o=l.nextElementSibling;l&&(l.style.display="none"),o&&(o.style.display="flex")}),B(a=>{var l=n.content.src,o=n.content.alt||"图片预览";return l!==a.e&&X(r,"src",a.e=l),o!==a.t&&X(r,"alt",a.t=o),a},{e:void 0,t:void 0}),r})():null})(),i),B(s=>(s=n.content.src?"none":"flex")!=null?i.style.setProperty("display",s):i.style.removeProperty("display")),t}}),null),e}}),Ml=n=>{const[e,t]=Z([]),[i,s]=Z(!1);mn(()=>{console.log("🔍 [DataFieldProperties] props.content 变化:",{data_source_id:n.content.data_source_id,expression:n.content.expression,完整content:n.content})}),et(async()=>{try{s(!0);const l=await Ae.listDataSources();t(l)}catch(l){console.error("Failed to load data sources:",l)}finally{s(!1)}});const r=l=>{console.log("🔍 [DataField] handleDataSourceChange 触发:",{新值:l,当前值:n.content.data_source_id,是否为空:l==="",将要更新的值:l===""?void 0:l}),n.onUpdate({data_source_id:l===""?void 0:l}),console.log("🔍 [DataField] onUpdate 已调用，等待父组件更新"),setTimeout(()=>{console.log("🔍 [DataField] 更新后检查:",{更新后的值:n.content.data_source_id,是否更新成功:n.content.data_source_id===(l===""?void 0:l)})},100)},a=Me(()=>n.content.data_source_id?e().find(l=>l.id===n.content.data_source_id):null);return(()=>{var l=_l();return g(l,y(vt,{title:"数据源配置",icon:"🔗",get children(){var o=Wn();return g(o,y(we,{label:"数据源",get children(){return y(H,{get when(){return i()},get fallback(){return(()=>{var c=xl();return c.firstChild,c.$$input=d=>{console.log("🔍 [DataField] select onInput 事件触发:",d.currentTarget.value)},c.addEventListener("change",d=>{console.log("🔍 [DataField] select onChange 事件触发:",{target:d.target,currentTarget:d.currentTarget,value:d.currentTarget.value,selectedIndex:d.currentTarget.selectedIndex,selectedOption:d.currentTarget.options[d.currentTarget.selectedIndex]?.text}),r(d.currentTarget.value)}),g(c,y(fe,{get each(){return e()},children:d=>(console.log("🔍 [DataField] 渲染数据源选项:",{id:d.id,name:d.name,当前选中:n.content.data_source_id===d.id}),(()=>{var h=Sl(),u=h.firstChild,v=u.nextSibling;return v.nextSibling,g(h,()=>d.name,u),g(h,()=>d.providerType||d.provider_type,v),B(()=>h.value=d.id),h})())}),null),B(()=>c.value=n.content.data_source_id||""),c})()},get children(){return fl()}})}}),null),g(o,y(H,{get when(){return a()},get children(){var c=vl(),d=c.firstChild,h=d.firstChild,u=h.firstChild,v=u.nextSibling,f=v.nextSibling,p=h.nextSibling,b=p.firstChild;b.nextSibling;var m=p.nextSibling,_=m.firstChild;return _.nextSibling,g(f,(()=>{var w=Ce(()=>a().status==="active");return()=>w()?"活跃":a().status==="error"?"错误":"禁用"})()),g(p,()=>a().providerType||a().provider_type,null),g(m,()=>new Date(a().lastUpdated||a().last_updated).toLocaleString("zh-CN"),null),B(()=>Se(f,a().status==="active"?"text-green-600":a().status==="error"?"text-red-600":"text-gray-600")),c}}),null),g(o,y(we,{label:"表达式",get children(){var c=pl();return c.$$input=d=>n.onUpdate({expression:d.currentTarget.value}),c.disabled=!1,B(()=>c.value=n.content.expression||""),c}}),null),g(o,y(H,{get when(){return!n.content.expression||!n.content.expression.trim()},get children(){return ml()}}),null),g(o,y(H,{get when(){return n.content.expression&&!n.content.data_source_id},get children(){return bl()}}),null),g(o,y(we,{label:"格式",get children(){var c=yl();return c.addEventListener("change",d=>n.onUpdate({format:d.currentTarget.value==="default"?void 0:d.currentTarget.value})),B(()=>c.value=n.content.format||"default"),c}}),null),o}}),null),g(l,y(vt,{title:"字段样式",icon:"🎨",get children(){var o=er(),c=o.firstChild,d=c.nextSibling;return g(c,y(we,{label:"字体",get children(){var h=Ks();return h.addEventListener("change",u=>n.onUpdate({style:{...n.content.style,font_family:u.currentTarget.value}})),B(()=>h.value=n.content.style.font_family),h}}),null),g(c,y(we,{label:"大小",get children(){return y(gt,{get value(){return n.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:h=>n.onUpdate({style:{...n.content.style,font_size:h}})})}}),null),g(d,y(we,{label:"字重",get children(){var h=Js();return h.addEventListener("change",u=>n.onUpdate({style:{...n.content.style,font_weight:u.currentTarget.value}})),B(()=>h.value=n.content.style.font_weight),h}}),null),g(d,y(we,{label:"对齐",get children(){return y(nr,{get value(){return n.content.style.align},onUpdate:h=>n.onUpdate({style:{...n.content.style,align:h}})})}}),null),g(o,y(we,{label:"颜色",get children(){return y(Mt,{get value(){return n.content.style.color},onUpdate:h=>n.onUpdate({style:{...n.content.style,color:h}})})}}),null),o}}),null),l})()},gt=n=>(()=>{var e=wl(),t=e.firstChild;return t.addEventListener("blur",i=>{const s=parseFloat(i.target.value)||n.value,r=Math.max(n.min||-1/0,Math.min(n.max||1/0,s));r!==s&&(i.target.value=r.toString(),n.onUpdate(r))}),t.$$input=i=>{const s=parseFloat(i.target.value);if(!isNaN(s)){const r=Math.max(n.min||-1/0,Math.min(n.max||1/0,s));n.onUpdate(r)}},g(e,(()=>{var i=Ce(()=>!!n.unit);return()=>i()&&(()=>{var s=$l();return g(s,()=>n.unit),s})()})(),null),B(i=>{var s=n.min,r=n.max,a=n.step||1;return s!==i.e&&X(t,"min",i.e=s),r!==i.t&&X(t,"max",i.t=r),a!==i.a&&X(t,"step",i.a=a),i},{e:void 0,t:void 0,a:void 0}),B(()=>t.value=n.value),e})(),Mt=n=>(()=>{var e=Cl(),t=e.firstChild,i=t.firstChild,s=i.nextSibling,r=t.nextSibling;return i.$$input=a=>n.onUpdate(a.target.value),r.$$input=a=>{const l=a.target.value;(/^#[0-9A-Fa-f]{6}$/.test(l)||/^#[0-9A-Fa-f]{3}$/.test(l))&&n.onUpdate(l)},B(a=>(a=n.value)!=null?s.style.setProperty("background-color",a):s.style.removeProperty("background-color")),B(()=>i.value=n.value),B(()=>r.value=n.value),e})(),nr=n=>{const e=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var t=kl();return g(t,()=>e.map(i=>(()=>{var s=Tl();return s.$$click=()=>n.onUpdate(i.value),g(s,()=>i.icon),B(r=>{var a=`property-alignment-btn ${n.value===i.value?"active":""}`,l=i.label;return a!==r.e&&Se(s,r.e=a),l!==r.t&&X(s,"title",r.t=l),r},{e:void 0,t:void 0}),s})())),t})()};He(["input","click"]);var Dl=S("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),Ol=S("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const Il=n=>y(H,{get when(){return n.config.show_grid},get children(){return[(()=>{var e=Dl(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return B(r=>{var a=n.config.grid_size,l=n.config.grid_size,o=n.config.grid_size,c=n.config.grid_size,d=n.config.grid_size,h=n.config.grid_size,u=n.config.grid_size,v=n.config.grid_size;return a!==r.e&&X(t,"width",r.e=a),l!==r.t&&X(t,"height",r.t=l),o!==r.a&&X(i,"x1",r.a=o),c!==r.o&&X(i,"x2",r.o=c),d!==r.i&&X(i,"y2",r.i=d),h!==r.n&&X(s,"y1",r.n=h),u!==r.s&&X(s,"x2",r.s=u),v!==r.h&&X(s,"y2",r.h=v),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),e})(),(()=>{var e=Ol();return B(t=>{var i=n.config.width,s=n.config.height;return i!==t.e&&X(e,"width",t.e=i),s!==t.t&&X(e,"height",t.t=s),t},{e:void 0,t:void 0}),e})()]}});class Nl{expressionCache=new Map;maxCacheSize=1e3;async evaluateExpression(e,t){if(!e||!e.trim())return{success:!1,error:"表达式不能为空"};if(!t)return{success:!1,error:"没有可用的数据上下文"};try{const i=this.preprocessExpression(e),s=this.getCompiledExpression(i),r=await this.executeCompiledExpression(s,t);return{success:!0,value:r.value,type:this.inferValueType(r.value)}}catch(i){return{success:!1,error:i instanceof Error?i.message:String(i)}}}validateExpression(e,t){if(!e||!e.trim())return{valid:!1,error:"表达式不能为空"};try{const i=this.preprocessExpression(e),s=this.compileExpression(i);return this.staticValidation(s,t)}catch(i){return{valid:!1,error:i instanceof Error?i.message:"表达式格式错误"}}}getFieldSuggestions(e,t){if(!t)return[];const i=e.toLowerCase().replace(/[{}]/g,""),s=[];if(t.fields.forEach(r=>{r.name.toLowerCase().includes(i)&&s.push(`{${r.name}}`),r.displayName&&r.displayName.toLowerCase().includes(i)&&s.push(`{${r.name}}`)}),t.currentRecord.data){const r=this.getNestedFieldSuggestions(i,t.currentRecord.data,"");s.push(...r)}return Array.from(new Set(s)).sort((r,a)=>{const l=r.replace(/[{}]/g,""),o=a.replace(/[{}]/g,"");return l===i?-1:o===i?1:l.startsWith(i)?-1:o.startsWith(i)?1:l.localeCompare(o)}).slice(0,20)}preprocessExpression(e){let t=e.trim();return!t.startsWith("{")&&!t.endsWith("}")&&(t=`{${t}}`),t=t.replace(/^\{+/,"{").replace(/\}+$/,"}"),t}getCompiledExpression(e){let t=this.expressionCache.get(e);if(!t){if(t=this.compileExpression(e),this.expressionCache.size>=this.maxCacheSize){const i=this.expressionCache.keys().next().value;i&&this.expressionCache.delete(i)}this.expressionCache.set(e,t)}return t}compileExpression(e){const t=e.slice(1,-1),i=this.parsePath(t);return{original:e,path:i,type:this.determineExpressionType(i)}}parsePath(e){const t=[];let i="",s=!1;for(let r=0;r<e.length;r++){const a=e[r];if(a==="["&&!s)i&&(t.push({type:"field",value:i}),i=""),s=!0;else if(a==="]"&&s){const l=parseInt(i,10);if(isNaN(l))throw new Error(`无效的数组索引: ${i}`);t.push({type:"index",value:l}),i="",s=!1}else a==="."&&!s?i&&(t.push({type:"field",value:i}),i=""):i+=a}if(i){if(s)throw new Error("未闭合的数组索引");t.push({type:"field",value:i})}if(t.length===0)throw new Error("空的字段路径");return t}async executeCompiledExpression(e,t){let i=t.currentRecord.data;for(const s of e.path){if(i==null)throw new Error("无法访问 null/undefined 值的属性");if(s.type==="field"){if(typeof i!="object")throw new Error(`尝试访问非对象类型的字段: ${s.value}`);if(!(s.value in i))throw new Error(`字段不存在: ${s.value}`);i=i[s.value]}else if(s.type==="index"){if(!Array.isArray(i))throw new Error("尝试对非数组类型使用索引访问");const r=s.value;if(r<0||r>=i.length)throw new Error(`数组索引超出范围: ${r}`);i=i[r]}}return{value:i}}staticValidation(e,t){if(!t)return{valid:!0,warnings:["没有数据上下文，无法验证字段是否存在"]};const i=[],s=e.path[0];if(s&&s.type==="field"){const a=s.value;if(!t.fields.some(o=>o.name===a)){const o=t.fields.filter(c=>c.name.toLowerCase().includes(a.toLowerCase())||this.levenshteinDistance(c.name.toLowerCase(),a.toLowerCase())<=2).map(c=>`{${c.name}}`).slice(0,5);return{valid:!1,error:`字段不存在: ${a}`,suggestions:o}}}e.path.length>5&&i.push("表达式路径过深，可能影响性能");const r={valid:!0};return i.length>0&&(r.warnings=i),r}getNestedFieldSuggestions(e,t,i){const s=[];if(!t||typeof t!="object")return s;for(const r of Object.keys(t)){const a=i?`${i}.${r}`:r;a.toLowerCase().includes(e)&&s.push(`{${a}}`),i.split(".").length<3&&t[r]&&typeof t[r]=="object"&&s.push(...this.getNestedFieldSuggestions(e,t[r],a))}return s}inferValueType(e){return e==null?"object":typeof e=="string"?"string":typeof e=="number"?"number":typeof e=="boolean"?"boolean":e instanceof Date?"date":typeof e=="object"?"object":"string"}determineExpressionType(e){return e.length===1?"simple":e.length<=3&&e.every(t=>t.type==="field")?"nested":"complex"}levenshteinDistance(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const i=new Array(t.length+1);for(let s=0;s<=t.length;s++)i[s]=new Array(e.length+1),i[s][0]=s;for(let s=0;s<=e.length;s++)i[0][s]=s;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++){const a=e[r-1]===t[s-1]?0:1;i[s][r]=Math.min(i[s-1][r]+1,i[s][r-1]+1,i[s-1][r-1]+a)}return i[t.length][e.length]}clearCache(){this.expressionCache.clear()}getCacheStats(){return{size:this.expressionCache.size,maxSize:this.maxCacheSize,hitRate:0}}}const si=new Nl;class zl{context=Z(null);subscribers=[];constructor(){this.context[1](null)}getCurrentContext(){return this.context[0]()}async setActiveDataSource(e){try{const i=(await Ae.listDataSources()).find(d=>d.id===e);if(!i)throw new Error(`数据源不存在: ${e}`);console.log("🔍 找到数据源:",i);const s=i.providerType||i.provider_type||i.type_name||"json";console.log("🔍 推断的 providerType:",s);let r={rows:[],totalCount:0},a={columns:[]},l=null;try{r=await Ae.getPreview(e,void 0,1),console.log("🔍 预览数据:",r)}catch(d){console.warn("⚠️  获取数据预览失败，继续构建上下文:",d),l=d}try{a=await Ae.getSchema(e),console.log("🔍 Schema信息:",a)}catch(d){console.warn("⚠️  获取Schema失败，继续构建上下文:",d),l||(l=d)}const o=Array.isArray(a.columns)?a.columns.map(d=>({name:d.name,displayName:d.description||d.name,type:this.mapDataType(d.data_type),nullable:!!d.nullable,sample:d.default_value})):[],c={dataSource:{id:e,type:this.inferDataSourceType(s),name:i.name,status:this.mapDataSourceStatus(i.status)},currentRecord:{index:0,total:r.totalCount??r.total_rows??r.total_count??0,data:r&&r.rows&&r.rows[0]?r.rows[0]:{}},fields:o,...l?{error:{type:"system",message:String(l),details:l}}:{}};console.log("✅ 创建新的数据上下文:",c),this.context[1](c);try{typeof window<"u"&&window.localStorage&&window.localStorage.setItem("jasper.activeDataSourceId",e)}catch(d){console.warn("无法持久化激活数据源ID:",d)}this.notifySubscribers(c)}catch(t){console.error("设置数据源失败:",t);let i="",s;try{const l=(await Ae.listDataSources()).find(o=>o.id===e);l&&(i=l.name,s=l.providerType||l.provider_type||l.type_name)}catch{}const r={dataSource:{id:e,type:this.inferDataSourceType(s||"json"),name:i||"未知数据源",status:"error"},currentRecord:{index:0,total:0,data:{}},fields:[],error:{type:"system",message:t instanceof Error?t.message:"数据源加载失败",details:t}};this.context[1](r),this.notifySubscribers(r)}}async navigateToRecord(e){const t=this.getCurrentContext();if(!t||e<0||e>=t.currentRecord.total)return!1;try{const i=await Ae.queryData(t.dataSource.id,{limit:1,offset:e});if(i.rows.length===0)return!1;const s={...t,currentRecord:{...t.currentRecord,index:e,data:i.rows[0]}};return this.context[1](s),this.notifySubscribers(s),!0}catch(i){return console.error("导航到记录失败:",i),!1}}async navigateNext(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index+1):!1}async navigatePrevious(){const e=this.getCurrentContext();return e?this.navigateToRecord(e.currentRecord.index-1):!1}async evaluateExpression(e){const t=this.getCurrentContext();return await si.evaluateExpression(e,t)}validateExpression(e){const t=this.getCurrentContext(),i=si.validateExpression(e,t);return{valid:i.valid,...i.error&&{error:i.error},...i.suggestions&&{suggestions:i.suggestions}}}getFieldSuggestions(e){const t=this.getCurrentContext();return si.getFieldSuggestions(e,t)}subscribe(e){return this.subscribers.push(e),()=>{const t=this.subscribers.indexOf(e);t>-1&&this.subscribers.splice(t,1)}}destroy(){this.subscribers.length=0,this.context[1](null)}notifySubscribers(e){this.subscribers.forEach(t=>{try{t(e)}catch(i){console.error("数据上下文订阅回调错误:",i)}})}inferDataSourceType(e){if(!e)return console.warn("providerType is undefined, defaulting to json"),"json";const t=e.toLowerCase();return t==="json"?"json":t==="excel"?"excel":t==="sql"?"sql":t==="xml"?"xml":t==="csv"?"csv":t.startsWith("database")?"sql":"json"}mapDataType(e){switch(e){case"String":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Date":case"DateTime":return"date";case"Array":return"array";case"Object":return"object";default:return"string"}}mapDataSourceStatus(e){if(!e)return console.warn("status is undefined, defaulting to empty"),"empty";switch(e.toLowerCase()){case"active":case"connected":case"ready":return"ready";case"error":case"failed":return"error";case"loading":case"processing":case"connecting":return"loading";case"disabled":case"disconnected":case"inactive":return"empty";default:return console.warn(`Unknown status: ${e}, defaulting to empty`),"empty"}}}const Je=new zl;var Fl=S("<svg><g class=text-element-unified-container data-bounds-version=unified-v2><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto class=text-content-unified></svg>",!1,!0,!1),Qi=S("<svg><rect class=text-selection-unified></svg>",!1,!0,!1),Gl=S("<svg><rect class=text-background-unified></svg>",!1,!0,!1),Bl=S("<svg><rect fill=none class=text-border-unified></svg>",!1,!0,!1),Ul=S("<svg><tspan class=text-line-wrapped></svg>",!1,!0,!1),Hl=S("<svg><tspan class=text-line-original></svg>",!1,!0,!1),ql=S("<svg><rect x=0 y=0></svg>",!1,!0,!1),Wl=S("<svg><line x1=0></svg>",!1,!0,!1),jl=S("<svg><g class=datafield-element-unified-container><text dominant-baseline=hanging text-rendering=optimizeLegibility shape-rendering=geometricPrecision font-kerning=auto></svg>",!1,!0,!1),Yl=S('<svg><g class=design-mode-indicator><circle r=6 fill="rgba(24, 144, 255, 0.1)"stroke=#1890ff stroke-width=1></circle><text text-anchor=middle dominant-baseline=middle font-size=8 font-weight=bold fill=#1890ff></svg>',!1,!0,!1),Vl=S("<svg><tspan class=datafield-line-wrapped></svg>",!1,!0,!1),Xl=S("<svg><tspan dy=0></svg>",!1,!0,!1),Ql=S("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),Kl=S("<svg><g></svg>",!1,!0,!1);const Jl=n=>{const{state:e}=Xn(),[t,i]=Z("[数据字段]");mn(()=>{if(n.element.content.type==="DataField"){const a=n.element.content.expression||"",l=e().mode;ei.shouldShowExpression(l)?i(a||"[数据字段]"):ei.shouldEvaluateExpression(l)&&Je.evaluateExpression(a).then(o=>{o.success?i(String(o.value||"")):i(`[错误: ${o.error}]`)}).catch(o=>{i(`[错误: ${o}]`)})}});const s=Me(()=>{const{position:a}=n.element;return{transform:`translate(${a.x}px, ${a.y}px)`,opacity:n.element.visible?1:.5}}),r=()=>{const{content:a,size:l}=n.element;if(a.type==="Text"&&a.content&&a.style){const o=qt.calculateUnifiedBounds(a.content,a.style,l),c=qt.getTextAnchor(a.style.align);return(()=>{var d=Fl(),h=d.firstChild;return g(d,(()=>{var u=Ce(()=>!!n.selected);return()=>u()&&(()=>{var v=Qi();return B(f=>{var p=o.containerBounds.x,b=o.containerBounds.y,m=o.containerBounds.width,_=o.containerBounds.height;return p!==f.e&&X(v,"x",f.e=p),b!==f.t&&X(v,"y",f.t=b),m!==f.a&&X(v,"width",f.a=m),_!==f.o&&X(v,"height",f.o=_),f},{e:void 0,t:void 0,a:void 0,o:void 0}),v})()})(),h),g(d,(()=>{var u=Ce(()=>!!a.style.background);return()=>u()&&(()=>{var v=Gl();return B(f=>{var p=o.positioning.backgroundX,b=o.positioning.backgroundY,m=o.containerBounds.width+(a.style.background.padding||0)*2,_=o.containerBounds.height+(a.style.background.padding||0)*2,w=a.style.background.color,x=a.style.background.opacity||1,C=a.style.border?.radius||0,A=a.style.border?.radius||0;return p!==f.e&&X(v,"x",f.e=p),b!==f.t&&X(v,"y",f.t=b),m!==f.a&&X(v,"width",f.a=m),_!==f.o&&X(v,"height",f.o=_),w!==f.i&&X(v,"fill",f.i=w),x!==f.n&&X(v,"fill-opacity",f.n=x),C!==f.s&&X(v,"rx",f.s=C),A!==f.h&&X(v,"ry",f.h=A),f},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),v})()})(),h),g(d,(()=>{var u=Ce(()=>!!a.style.border);return()=>u()&&(()=>{var v=Bl();return B(f=>{var p=o.positioning.backgroundX,b=o.positioning.backgroundY,m=o.containerBounds.width+(a.style.background?.padding||0)*2,_=o.containerBounds.height+(a.style.background?.padding||0)*2,w=a.style.border.color,x=a.style.border.width,C=a.style.border.style==="Dashed"?"5,5":a.style.border.style==="Dotted"?"2,2":"none",A=a.style.border.radius||0,M=a.style.border.radius||0;return p!==f.e&&X(v,"x",f.e=p),b!==f.t&&X(v,"y",f.t=b),m!==f.a&&X(v,"width",f.a=m),_!==f.o&&X(v,"height",f.o=_),w!==f.i&&X(v,"stroke",f.i=w),x!==f.n&&X(v,"stroke-width",f.n=x),C!==f.s&&X(v,"stroke-dasharray",f.s=C),A!==f.h&&X(v,"rx",f.h=A),M!==f.r&&X(v,"ry",f.r=M),f},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),v})()})(),h),X(h,"text-anchor",c),g(h,(()=>{var u=Ce(()=>!!o.textLayout?.isWrapped);return()=>u()?o.textLayout.wrappedLines.map((v,f)=>(()=>{var p=Ul();return g(p,v),B(b=>{var m=o.positioning.textAnchorX,_=f===0?0:o.fontMetrics.lineHeight;return m!==b.e&&X(p,"x",b.e=m),_!==b.t&&X(p,"dy",b.t=_),b},{e:void 0,t:void 0}),p})()):a.content.split(`
`).map((v,f)=>(()=>{var p=Hl();return g(p,v),B(b=>{var m=o.positioning.textAnchorX,_=f===0?0:o.fontMetrics.lineHeight;return m!==b.e&&X(p,"x",b.e=m),_!==b.t&&X(p,"dy",b.t=_),b},{e:void 0,t:void 0}),p})())})()),B(u=>{var v=o.positioning.textAnchorX,f=o.positioning.textAnchorY,p=a.style.font_family,b=a.style.font_size.toString(),m=a.style.font_weight,_=a.style.color;return v!==u.e&&X(h,"x",u.e=v),f!==u.t&&X(h,"y",u.t=f),p!==u.a&&X(h,"font-family",u.a=p),b!==u.o&&X(h,"font-size",u.o=b),m!==u.i&&X(h,"font-weight",u.i=m),_!==u.n&&X(h,"fill",u.n=_),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),d})()}if(a.type==="Rectangle"){const o=a.opacity!==void 0?a.opacity:1,c=a.corner_radius||0;return(()=>{var d=ql();return X(d,"rx",c),X(d,"ry",c),X(d,"fill-opacity",o),X(d,"stroke-opacity",o),B(h=>{var u=l.width,v=l.height,f=a.fill_color||"transparent",p=a.border?.color||"#000000",b=a.border?.width||1,m=a.border?.style==="Dashed"?"5,5":a.border?.style==="Dotted"?"2,2":"none";return u!==h.e&&X(d,"width",h.e=u),v!==h.t&&X(d,"height",h.t=v),f!==h.a&&X(d,"fill",h.a=f),p!==h.o&&X(d,"stroke",h.o=p),b!==h.i&&X(d,"stroke-width",h.i=b),m!==h.n&&X(d,"stroke-dasharray",h.n=m),h},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),d})()}if(a.type==="Line"){const o=a.opacity!==void 0?a.opacity:1,c=a.line_style||"Solid",d=c==="Dashed"?"8,4":c==="Dotted"?"2,2":c==="DashDot"?"8,4,2,4":"none";return(()=>{var h=Wl();return X(h,"stroke-opacity",o),X(h,"stroke-dasharray",d),B(u=>{var v=l.height/2,f=l.width,p=l.height/2,b=a.color,m=a.width;return v!==u.e&&X(h,"y1",u.e=v),f!==u.t&&X(h,"x2",u.t=f),p!==u.a&&X(h,"y2",u.a=p),b!==u.o&&X(h,"stroke",u.o=b),m!==u.i&&X(h,"stroke-width",u.i=m),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),h})()}if(a.type==="DataField"&&a.style){const o=t(),c=qt.calculateUnifiedBounds(o,a.style,l),d=qt.getTextAnchor(a.style.align);return(()=>{var h=jl(),u=h.firstChild;return g(h,(()=>{var v=Ce(()=>!!n.selected);return()=>v()&&(()=>{var f=Qi();return B(p=>{var b=c.containerBounds.x,m=c.containerBounds.y,_=c.containerBounds.width,w=c.containerBounds.height;return b!==p.e&&X(f,"x",p.e=b),m!==p.t&&X(f,"y",p.t=m),_!==p.a&&X(f,"width",p.a=_),w!==p.o&&X(f,"height",p.o=w),p},{e:void 0,t:void 0,a:void 0,o:void 0}),f})()})(),u),g(h,(()=>{var v=Ce(()=>!!ei.shouldShowExpression(e().mode));return()=>v()&&(()=>{var f=Yl(),p=f.firstChild,b=p.nextSibling;return B(m=>{var _=c.containerBounds.x+c.containerBounds.width-8,w=c.containerBounds.y+8,x=c.containerBounds.x+c.containerBounds.width-8,C=c.containerBounds.y+8;return _!==m.e&&X(p,"cx",m.e=_),w!==m.t&&X(p,"cy",m.t=w),x!==m.a&&X(b,"x",m.a=x),C!==m.o&&X(b,"y",m.o=C),m},{e:void 0,t:void 0,a:void 0,o:void 0}),f})()})(),u),X(u,"text-anchor",d),g(u,(()=>{var v=Ce(()=>!!c.textLayout?.isWrapped);return()=>v()?c.textLayout.wrappedLines.map((f,p)=>(()=>{var b=Vl();return g(b,f),B(m=>{var _=c.positioning.textAnchorX,w=p===0?0:c.fontMetrics.lineHeight;return _!==m.e&&X(b,"x",m.e=_),w!==m.t&&X(b,"dy",m.t=w),m},{e:void 0,t:void 0}),b})()):(()=>{var f=Xl();return g(f,o),B(()=>X(f,"x",c.positioning.textAnchorX)),f})()})()),B(v=>{var f=e().mode,p=c.positioning.textAnchorX,b=c.positioning.textAnchorY,m=a.style.font_family,_=a.style.font_size.toString(),w=a.style.font_weight,x=o.startsWith("[错误:")?"#ff4d4f":a.style.color,C=`datafield-content-unified ${e().mode}-mode`;return f!==v.e&&X(h,"data-preview-mode",v.e=f),p!==v.t&&X(u,"x",v.t=p),b!==v.a&&X(u,"y",v.a=b),m!==v.o&&X(u,"font-family",v.o=m),_!==v.i&&X(u,"font-size",v.i=_),w!==v.n&&X(u,"font-weight",v.n=w),x!==v.s&&X(u,"fill",v.s=x),C!==v.h&&X(u,"class",v.h=C),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),h})()}return(()=>{var o=Ql();return B(c=>{var d=l.width,h=l.height;return d!==c.e&&X(o,"width",c.e=d),h!==c.t&&X(o,"height",c.t=h),c},{e:void 0,t:void 0}),o})()};return(()=>{var a=Kl();return g(a,r),B(l=>{var o=`element ${n.selected&&n.element.content.type!=="Text"&&n.element.content.type!=="DataField"?"element-selected":""}`,c=s(),d=n.element.id,h=n.element.content.type;return o!==l.e&&X(a,"class",l.e=o),l.t=Hs(a,c,l.t),d!==l.a&&X(a,"data-element-id",l.a=d),h!==l.o&&X(a,"data-element-type",l.o=h),l},{e:void 0,t:void 0,a:void 0,o:void 0}),a})()};var Zl=S("<svg><g class=resize-handles></svg>",!1,!0,!1),eo=S("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const to=n=>{const{updateElement:e,setResizeOperation:t}=ct(),[i,s]=Z(!1),[r,a]=Z(null),[l,o]=Z({x:0,y:0}),[c,d]=Z({width:0,height:0}),[h,u]=Z({x:0,y:0}),[v,f]=Z({width:0,height:0}),[p,b]=Z({x:0,y:0}),[m,_]=Z(!1),w=Me(()=>{const{position:E,size:R,content:T}=n.element,N=8/2;let $={x:E.x,y:E.y,width:R.width,height:R.height};if((T.type==="Text"||T.type==="DataField")&&T.style){const W=T.type==="Text"?T.content:T.expression||"[数据字段]",j=qt.calculateUnifiedBounds(W,T.style,R);$={x:E.x+j.containerBounds.x,y:E.y+j.containerBounds.y,width:j.containerBounds.width,height:j.containerBounds.height}}const P=$.x,Q=$.y,G=$.x+$.width,D=$.y+$.height,V=$.x+$.width/2,q=$.y+$.height/2;return[{position:"nw",cursor:"nw-resize",x:P-N,y:Q-N},{position:"ne",cursor:"ne-resize",x:G-N,y:Q-N},{position:"sw",cursor:"sw-resize",x:P-N,y:D-N},{position:"se",cursor:"se-resize",x:G-N,y:D-N},{position:"n",cursor:"n-resize",x:V-N,y:Q-N},{position:"s",cursor:"s-resize",x:V-N,y:D-N},{position:"w",cursor:"w-resize",x:P-N,y:q-N},{position:"e",cursor:"e-resize",x:G-N,y:q-N}]}),x=(E,R,T,U=!1,N=!1)=>{const $=c(),P=h();let Q=$.width,G=$.height,D=P.x,V=P.y;switch(E){case"nw":Q=$.width-R,G=$.height-T,D=P.x+R,V=P.y+T;break;case"ne":Q=$.width+R,G=$.height-T,V=P.y+T;break;case"sw":Q=$.width-R,G=$.height+T,D=P.x+R;break;case"se":Q=$.width+R,G=$.height+T;break;case"n":G=$.height-T,V=P.y+T;break;case"s":G=$.height+T;break;case"w":Q=$.width-R,D=P.x+R;break;case"e":Q=$.width+R;break}if(U&&(E==="nw"||E==="ne"||E==="sw"||E==="se")){const W=$.width/$.height;Q/G>W?(Q=G*W,(E==="nw"||E==="sw")&&(D=P.x+($.width-Q))):(G=Q/W,(E==="nw"||E==="ne")&&(V=P.y+($.height-G)))}if(N){const W=P.x+$.width/2,j=P.y+$.height/2;D=W-Q/2,V=j-G/2}const q=20;return Q=Math.max(q,Q),G=Math.max(q,G),{size:{width:Q,height:G},position:{x:D,y:V}}},C=E=>(E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation(),!1),A=(E,R)=>{t(!0),document.addEventListener("click",C,{capture:!0}),s(!0),a(E),o({x:R.clientX,y:R.clientY}),d({width:n.element.size.width,height:n.element.size.height}),u({x:n.element.position.x,y:n.element.position.y}),f(n.element.size),b(n.element.position),_(!1),document.addEventListener("mousemove",I),document.addEventListener("mouseup",z),document.body.style.cursor=w().find(T=>T.position===E)?.cursor||"default"};let M=0;const I=E=>{if(!i())return;const R=r();if(!R)return;const T=l(),U=E.clientX-T.x,N=E.clientY-T.y,$=x(R,U,N,E.shiftKey,E.altKey);f($.size),b($.position),_(Math.abs(U)>2||Math.abs(N)>2);const P=Date.now();if(P-M>50)try{e(n.element.id,{size:$.size,position:$.position}),M=P}catch{}},z=()=>{if(!i()||!r())return;const R=()=>{document.removeEventListener("click",C,{capture:!0}),t(!1),s(!1),a(null),document.body.style.cursor="default",document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",z)};if(m()){const T=v(),U=p();e(n.element.id,{size:T,position:U}).catch(N=>{e(n.element.id,{size:c(),position:h()}).catch($=>{})})}R()};return $t(()=>{t(!1),document.removeEventListener("click",C,{capture:!0}),document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",z),document.body.style.cursor="default"}),(()=>{var E=Zl();return g(E,()=>w().map(R=>(()=>{var T=eo(),U=T.firstChild,N=U.nextSibling;return N.addEventListener("mouseleave",$=>{i()||(document.body.style.cursor="default")}),N.addEventListener("mouseenter",$=>{i()||(document.body.style.cursor=R.cursor)}),N.$$mousedown=$=>{$.stopPropagation(),$.preventDefault(),A(R.position,$)},N.style.setProperty("pointer-events","all"),B($=>{var P=R.x+4,Q=R.y+4,G=R.x,D=R.y,V=R.cursor;return P!==$.e&&X(U,"cx",$.e=P),Q!==$.t&&X(U,"cy",$.t=Q),G!==$.a&&X(N,"x",$.a=G),D!==$.o&&X(N,"y",$.o=D),V!==$.i&&(($.i=V)!=null?N.style.setProperty("cursor",V):N.style.removeProperty("cursor")),$},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),T})())),E})()};He(["mousedown"]);var tt=(n=>(n.IDLE="idle",n.HOVER="hover",n.SELECTING="selecting",n.DRAGGING="dragging",n))(tt||{});const no={dragThreshold:3,updateThrottle:16};var io=S("<div tabindex=0>"),so=S("<div>"),ro=S("<div><div>🎯 修复版交互层</div><div>模式: </div><div>选中: </div><div>光标: "),ao=S("<div>拖拽: <!>个元素"),lo=S("<div>[<!>]");const oo=n=>{const{resizeOperation:e,setResizeOperation:t}=ct(),i=no;let s;const[r,a]=Z(tt.IDLE),[l,o]=Z([]),[c,d]=Z(null),[h,u]=Z(null),[v,f]=Z(null),p=(L,O)=>Math.sqrt(Math.pow(L.x-O.x,2)+Math.pow(L.y-O.y,2)),b=(L,O)=>L.length===O.length&&L.every((K,Y)=>K===O[Y]),m=()=>{f(null)},[_,w]=Z(null);let x="default";const C=(L,O)=>{!s||x===L||(s.style.cursor=L,x=L)},A=(L,...O)=>{console.log(`🎯 [InteractionLayer] ${L}`,...O)},M=L=>{if(!s)return{x:0,y:0};const O=s.getBoundingClientRect();return{x:L.clientX-O.left,y:L.clientY-O.top}},I=(L,O)=>L.x>=O.position.x&&L.x<=O.position.x+O.size.width&&L.y>=O.position.y&&L.y<=O.position.y+O.size.height,z=L=>{const O=E(L);return O.length>0?O[0]??null:null},E=L=>{const O=n.getAllElements();return O.filter(Y=>Y&&Y.visible&&I(L,Y)).sort((Y,te)=>{const oe=Y.z_index??O.indexOf(Y);return(te.z_index??O.indexOf(te))-oe})},R=L=>{const O=l();if(O.length===0)return null;const K=n.getAllElements();for(const Y of O){const te=K.find(rt=>rt.id===Y);if(!te||!te.visible)continue;const oe=8,ae=oe/2,$e=te.position.x,Ie=te.position.y,Te=te.position.x+te.size.width,Ye=te.position.y+te.size.height,We=te.position.x+te.size.width/2,lt=te.position.y+te.size.height/2,Pt=[{direction:"nw",cursor:"nw-resize",x:$e-ae,y:Ie-ae},{direction:"ne",cursor:"ne-resize",x:Te-ae,y:Ie-ae},{direction:"sw",cursor:"sw-resize",x:$e-ae,y:Ye-ae},{direction:"se",cursor:"se-resize",x:Te-ae,y:Ye-ae},{direction:"n",cursor:"n-resize",x:We-ae,y:Ie-ae},{direction:"s",cursor:"s-resize",x:We-ae,y:Ye-ae},{direction:"w",cursor:"w-resize",x:$e-ae,y:lt-ae},{direction:"e",cursor:"e-resize",x:Te-ae,y:lt-ae}];for(const rt of Pt)if(L.x>=rt.x&&L.x<rt.x+oe&&L.y>=rt.y&&L.y<rt.y+oe)return{elementId:te.id,direction:rt.direction,cursor:rt.cursor}}return null},T=L=>n.getAllElements().filter(K=>{if(!K.visible)return!1;const Y={x:K.position.x,y:K.position.y,width:K.size.width,height:K.size.height};return!(Y.x>L.x+L.width||Y.x+Y.width<L.x||Y.y>L.y+L.height||Y.y+Y.height<L.y)}),U=(L,O)=>{const K=E(L);return A("重叠选择检测",{elementsCount:K.length,isCtrlClick:O,elementIds:K.map(Y=>Y.id)}),K.length===0?null:K.length===1?(m(),K[0]?.id||null):O?N(L,K):(m(),A("普通点击选中最上层",{elementId:K[0]?.id}),K[0]?.id||null)},N=(L,O)=>{const K=v(),Y=Date.now();if(A("循环选择开始",{hasContext:!!K,elementIds:O.map(oe=>oe.id)}),!K||p(L,K.clickPoint)>5||Y-K.lastClickTime>3e3||!b(O.map(oe=>oe.id),K.overlappingElements.map(oe=>oe.id))){const oe=O.length>1?1:0;return f({clickPoint:L,overlappingElements:O,currentSelectedIndex:oe,lastClickTime:Y}),A("循环选择重置",{selectedIndex:oe,selectedId:O[oe]?.id,reason:K?p(L,K.clickPoint)>5?"position_changed":Y-K.lastClickTime>3e3?"timeout":"elements_changed":"no_context"}),$(oe+1,O.length,L),O[oe]?.id||null}else{const oe=(K.currentSelectedIndex+1)%O.length;return f({...K,currentSelectedIndex:oe,lastClickTime:Y}),A("循环选择继续",{selectedIndex:oe,selectedId:O[oe]?.id}),$(oe+1,O.length,L),O[oe]?.id||null}},$=(L,O,K)=>{const Y=document.querySelector(".overlap-indicator");Y?.parentNode&&Y.parentNode.removeChild(Y);const te=document.createElement("div");te.className="overlap-indicator",te.textContent=`${L}/${O}`,Object.assign(te.style,{position:"fixed",background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"2px 6px",fontSize:"11px",fontFamily:"monospace",borderRadius:"3px",pointerEvents:"none",zIndex:"9999",whiteSpace:"nowrap",left:`${K.x+10}px`,top:`${K.y-20}px`}),document.body.appendChild(te),A("显示重叠指示器",{current:L,total:O,point:K}),setTimeout(()=>{te.parentNode&&(te.parentNode.removeChild(te),A("移除重叠指示器"))},1500)},P=L=>{const O=M(L);if(_()){ee(O);return}if(r()===tt.DRAGGING){ve(O);return}if(r()===tt.SELECTING){ne(O);return}if(r()===tt.IDLE&&c()&&!c()?.isDragging){pe(O);return}r()===tt.IDLE&&!c()&&!_()&&Q(O)},Q=L=>{const O=R(L);if(O){C(O.cursor);return}const K=z(L);if(K){const te=l().includes(K.id)?"grab":"pointer";C(te);return}C("default")},G=L=>{const O=M(L),K=R(O);if(K){A("点击ResizeHandle",{elementId:K.elementId,direction:K.direction}),D(K,O);return}if(e()){A("调整大小操作进行中，跳过交互处理");return}const Y=U(O,L.ctrlKey);if(A("鼠标按下",{point:O,selectedElementId:Y,currentMode:r(),isCtrlClick:L.ctrlKey}),Y){const te=n.getAllElements().find(oe=>oe.id===Y);te&&V(te,O,L)}else q(O)},D=(L,O,K)=>{const Y=n.getAllElements().find(te=>te.id===L.elementId);Y&&(A("开始resize操作",{elementId:L.elementId,direction:L.direction}),t(!0),w({elementId:L.elementId,handlePosition:L.direction,startPoint:O,initialSize:{width:Y.size.width,height:Y.size.height},initialPosition:{x:Y.position.x,y:Y.position.y},cursor:L.cursor}),C(L.cursor),A("resize状态已设置",_()))},V=(L,O,K)=>{const Y=l().includes(L.id),te=l(),oe=!!v();A("元素点击",{elementId:L.id,isSelected:Y,currentlySelected:te,ctrlKey:K.ctrlKey,shiftKey:K.shiftKey,hasOverlapContext:oe}),K.ctrlKey&&!oe?W(L.id):K.shiftKey&&l().length>0?j(L.id):Y?(A("点击已选中元素，准备拖拽",{selectedCount:te.length}),_e(te,O)):he(L.id,O)},q=(L,O)=>{A("开始框选",{point:L}),o([]),n.onElementsSelect?.([]),m(),a(tt.SELECTING),C("crosshair"),u({startPoint:L,currentPoint:L,selectedIds:[]})},W=L=>{const O=l(),K=O.includes(L)?O.filter(Y=>Y!==L):[...O,L];A("切换选择",{elementId:L,newSelection:K}),o(K),n.onElementsSelect?.(K)},j=L=>{const O=l();if(!O.includes(L)){const K=[...O,L];A("添加到选择",{elementId:L,newSelection:K}),o(K),n.onElementsSelect?.(K)}},he=(L,O,K)=>{A("选择并准备拖拽",{elementId:L,point:O}),o([L]),n.onElementsSelect?.([L]),_e([L],O)},_e=(L,O,K)=>{A("准备拖拽操作",{elementIds:L,startPoint:O});const Y=n.getAllElements(),te=new Map;L.forEach(oe=>{const ae=Y.find($e=>$e.id===oe);ae&&te.set(oe,{x:ae.position.x,y:ae.position.y})}),d({elementIds:L,startPoint:O,startPositions:te,currentOffset:{x:0,y:0},isDragging:!1})},pe=L=>{const O=c();if(!O)return;const K=Math.sqrt(Math.pow(L.x-O.startPoint.x,2)+Math.pow(L.y-O.startPoint.y,2));K>i.dragThreshold&&(A("开始拖拽",{distance:K,threshold:i.dragThreshold}),a(tt.DRAGGING),C("grabbing"),d({...O,isDragging:!0}))};let se=!1,ce=0;const ue=(L,O=!1)=>{if(O){L();return}Date.now()-ce>=i.updateThrottle&&!se&&(se=!0,requestAnimationFrame(()=>{L(),se=!1,ce=Date.now()}))},ve=L=>{const O=c();if(!O)return;const K={x:L.x-O.startPoint.x,y:L.y-O.startPoint.y};d({...O,currentOffset:K}),ue(()=>{if(n.onBatchUpdatePositions&&O.elementIds.length>1){const Y=O.elementIds.map(te=>{const oe=O.startPositions.get(te);return oe?{element_id:te,new_position:{x:oe.x+K.x,y:oe.y+K.y}}:null}).filter(Boolean);Y.length>0&&n.onBatchUpdatePositions(Y).catch(()=>{})}else if(n.onElementMove){const Y=O.elementIds.map(te=>{const oe=O.startPositions.get(te);if(oe)return n.onElementMove(te,{x:oe.x+K.x,y:oe.y+K.y})}).filter(Boolean);Promise.allSettled(Y).catch(()=>{})}})},ne=L=>{const O=h();if(!O)return;const K={...O,currentPoint:L};u(K);const Y={x:Math.min(O.startPoint.x,L.x),y:Math.min(O.startPoint.y,L.y),width:Math.abs(L.x-O.startPoint.x),height:Math.abs(L.y-O.startPoint.y)},oe=T(Y).map(ae=>ae.id);u({...K,selectedIds:oe}),o(oe)},ee=L=>{const O=_();if(!O)return;const K=L.x-O.startPoint.x,Y=L.y-O.startPoint.y,te=ge(O.handlePosition,K,Y,O.initialSize,O.initialPosition);ue(()=>{n.onElementResize&&n.onElementResize(O.elementId,te.size,te.position)})},ge=(L,O,K,Y,te)=>{let oe=Y.width,ae=Y.height,$e=te.x,Ie=te.y;switch(L){case"nw":oe=Y.width-O,ae=Y.height-K,$e=te.x+O,Ie=te.y+K;break;case"ne":oe=Y.width+O,ae=Y.height-K,Ie=te.y+K;break;case"sw":oe=Y.width-O,ae=Y.height+K,$e=te.x+O;break;case"se":oe=Y.width+O,ae=Y.height+K;break;case"n":ae=Y.height-K,Ie=te.y+K;break;case"s":ae=Y.height+K;break;case"w":oe=Y.width-O,$e=te.x+O;break;case"e":oe=Y.width+O;break}const Te=10;return oe=Math.max(Te,oe),ae=Math.max(Te,ae),{size:{width:oe,height:ae},position:{x:$e,y:Ie}}},be=()=>{const L=r();if(A("鼠标释放",{currentMode:L,hasResizeState:!!_()}),_()){Pe();return}L===tt.DRAGGING?ke():L===tt.SELECTING&&ye(),de()},ke=()=>{const L=c();if(!L||!L.isDragging&&L.currentOffset.x===0&&L.currentOffset.y===0){A("拖拽完成，无实际移动");return}if(n.onBatchUpdatePositions&&L.elementIds.length>1){const O=L.elementIds.map(K=>{const Y=L.startPositions.get(K);return Y?{element_id:K,new_position:{x:Y.x+L.currentOffset.x,y:Y.y+L.currentOffset.y}}:null}).filter(Boolean);O.length>0&&(A("拖拽完成 - 批量更新",{elementCount:O.length}),n.onBatchUpdatePositions(O).catch(K=>{console.warn("批量更新最终位置失败:",K)}))}},ye=()=>{const L=h();L&&(A("框选完成",{selectedCount:L.selectedIds.length}),n.onElementsSelect&&n.onElementsSelect(L.selectedIds))},Pe=()=>{const L=_();L&&(A("完成resize操作",{elementId:L.elementId}),t(!1),w(null))},de=()=>{a(tt.IDLE),C("default"),d(null),u(null),w(null),t(!1),m(),A("状态重置完成")};et(async()=>{document.addEventListener("mousemove",P),document.addEventListener("mouseup",be),A("修复版交互层已初始化")}),$t(()=>{document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",be),A("修复版交互层已清理")});const xe=()=>{const L=h();if(!L||r()!==tt.SELECTING)return null;const{startPoint:O,currentPoint:K}=L;return{x:Math.min(O.x,K.x),y:Math.min(O.y,K.y),width:Math.abs(K.x-O.x),height:Math.abs(K.y-O.y)}};return(()=>{var L=io();L.$$mousedown=G;var O=s;return typeof O=="function"?Vn(O,L):s=L,L.style.setProperty("position","absolute"),L.style.setProperty("top","0"),L.style.setProperty("left","0"),L.style.setProperty("width","100%"),L.style.setProperty("height","100%"),L.style.setProperty("z-index","10"),L.style.setProperty("pointer-events","all"),L.style.setProperty("background","transparent"),L.style.setProperty("user-select","none"),g(L,(()=>{var K=Ce(()=>!!xe());return()=>K()&&(()=>{var Y=so();return Y.style.setProperty("position","absolute"),Y.style.setProperty("border","1px dashed #007acc"),Y.style.setProperty("background","rgba(0, 122, 204, 0.1)"),Y.style.setProperty("pointer-events","none"),B(te=>{var oe=`${xe().x}px`,ae=`${xe().y}px`,$e=`${xe().width}px`,Ie=`${xe().height}px`;return oe!==te.e&&((te.e=oe)!=null?Y.style.setProperty("left",oe):Y.style.removeProperty("left")),ae!==te.t&&((te.t=ae)!=null?Y.style.setProperty("top",ae):Y.style.removeProperty("top")),$e!==te.a&&((te.a=$e)!=null?Y.style.setProperty("width",$e):Y.style.removeProperty("width")),Ie!==te.o&&((te.o=Ie)!=null?Y.style.setProperty("height",Ie):Y.style.removeProperty("height")),te},{e:void 0,t:void 0,a:void 0,o:void 0}),Y})()})(),null),g(L,(()=>{var K=Ce(()=>!!n.enableDebugMode);return()=>K()&&(()=>{var Y=ro(),te=Y.firstChild,oe=te.nextSibling;oe.firstChild;var ae=oe.nextSibling;ae.firstChild;var $e=ae.nextSibling;return $e.firstChild,Y.style.setProperty("position","fixed"),Y.style.setProperty("top","10px"),Y.style.setProperty("right","10px"),Y.style.setProperty("padding","8px"),Y.style.setProperty("background","rgba(0, 0, 0, 0.8)"),Y.style.setProperty("color","white"),Y.style.setProperty("font-family","monospace"),Y.style.setProperty("font-size","12px"),Y.style.setProperty("border-radius","4px"),Y.style.setProperty("z-index","9999"),Y.style.setProperty("pointer-events","none"),g(oe,r,null),g(ae,()=>l().length,null),g($e,x,null),g(Y,(()=>{var Ie=Ce(()=>!!c()?.isDragging);return()=>Ie()&&(()=>{var Te=ao(),Ye=Te.firstChild,We=Ye.nextSibling;return We.nextSibling,Te.style.setProperty("color","#ffeb3b"),g(Te,()=>c()?.elementIds.length,We),Te})()})(),null),g(Y,(()=>{var Ie=Ce(()=>l().length>0);return()=>Ie()&&(()=>{var Te=lo(),Ye=Te.firstChild,We=Ye.nextSibling;return We.nextSibling,Te.style.setProperty("font-size","10px"),Te.style.setProperty("color","#ccc"),g(Te,()=>l().slice(0,3).join(", "),We),g(Te,()=>l().length>3&&"...",We),Te})()})(),null),Y})()})(),null),L})()};He(["mousedown"]);var co=S("<div class=toolbar-section><div class=section-title>智能建议</div><button class=smart-align-button><div class=smart-icon>🎯</div><div class=smart-text></div></button><div class=smart-reason>"),ho=S("<div class=toolbar-status><div class=status-text>选择至少2个元素以使用对齐功能"),uo=S('<div class=toolbar-status><div class="status-text aligning"><div class=spinner></div>正在执行对齐操作...'),go=S('<div class=alignment-toolbar><div class=toolbar-section><div class=section-title>对齐</div><div class=button-group><button class="align-button left"title=左对齐><div class=align-icon><div class="line left-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button h-center"title=水平居中对齐><div class=align-icon><div class="line center-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button right"title=右对齐><div class=align-icon><div class="line right-line"></div><div class=shapes><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>垂直对齐</div><div class=button-group><button class="align-button top"title=顶部对齐><div class="align-icon vertical"><div class="line top-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button v-center"title=垂直居中对齐><div class="align-icon vertical"><div class="line v-center-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button><button class="align-button bottom"title=底部对齐><div class="align-icon vertical"><div class="line bottom-line"></div><div class="shapes vertical"><div class=shape></div><div class=shape></div><div class=shape></div></div></div></button></div></div><div class=toolbar-section><div class=section-title>分布</div><div class=button-group><button class="align-button distribute-h"title=水平均匀分布><div class=align-icon><div class="shapes distribute"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape></div></div></div></button><button class="align-button distribute-v"title=垂直均匀分布><div class="align-icon vertical"><div class="shapes distribute vertical"><div class=shape></div><div class=spacer></div><div class=shape></div><div class=spacer></div><div class=shape>');const fo=(n,e)=>{if(n.length<2)return[];const t=n.map(i=>({x:i.position.x,y:i.position.y,width:i.size.width,height:i.size.height}));return t.map((i,s)=>{let r=i.x,a=i.y;switch(e){case"left":r=Math.min(...t.map(h=>h.x));break;case"right":r=Math.max(...t.map(h=>h.x+h.width))-i.width;break;case"top":a=Math.min(...t.map(h=>h.y));break;case"bottom":a=Math.max(...t.map(h=>h.y+h.height))-i.height;break;case"h_center":r=t.reduce((h,u)=>h+u.x+u.width/2,0)/t.length-i.width/2;break;case"v_center":a=t.reduce((h,u)=>h+u.y+u.height/2,0)/t.length-i.height/2;break}return{element_id:n[s].id,new_position:{x:r,y:a}}})},vo=n=>{const{batchUpdatePositions:e,state:t}=ct(),[i,s]=Z(!1),r=()=>n.selectedElementIds().length>=2,a=()=>{const d=n.selectedElementIds();return t.elements.filter(h=>d.includes(h.id))},l=async d=>{const h=a();if(h.length<2){console.warn("对齐功能需要至少2个元素");return}try{s(!0),console.log(`🎯 执行${d}对齐:`,h.length,"个元素");const u=fo(h,d);await e(u),console.log("✅ 对齐操作完成"),n.onAlignmentComplete&&n.onAlignmentComplete(u)}catch(u){console.error("❌ 对齐操作失败:",u)}finally{s(!1)}},o=()=>a().length<2?null:{recommended:"left",reason:"建议左对齐",results:[]},c=()=>o();return(()=>{var d=go(),h=d.firstChild,u=h.firstChild,v=u.nextSibling,f=v.firstChild,p=f.nextSibling,b=p.nextSibling,m=h.nextSibling,_=m.firstChild,w=_.nextSibling,x=w.firstChild,C=x.nextSibling,A=C.nextSibling,M=m.nextSibling,I=M.firstChild,z=I.nextSibling,E=z.firstChild,R=E.nextSibling;return f.$$click=()=>l("left"),p.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("h_center")),p.$$click=()=>l("h_center"),b.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("right")),b.$$click=()=>l("right"),x.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("top")),x.$$click=()=>l("top"),C.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("v_center")),C.$$click=()=>l("v_center"),A.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("bottom")),A.$$click=()=>l("bottom"),E.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("distribute_h")),E.$$click=()=>l("distribute_h"),R.addEventListener("mouseenter",()=>n.onAlignmentPreview?.("distribute_v")),R.$$click=()=>l("distribute_v"),g(d,y(H,{get when(){return Ce(()=>!!r())()&&c()},get children(){var T=co(),U=T.firstChild,N=U.nextSibling,$=N.firstChild,P=$.nextSibling,Q=N.nextSibling;return N.$$click=()=>l(c().recommended),g(P,()=>c().recommended==="left"&&"左对齐",null),g(P,()=>c().recommended==="right"&&"右对齐",null),g(P,()=>c().recommended==="top"&&"顶对齐",null),g(P,()=>c().recommended==="bottom"&&"底对齐",null),g(P,()=>c().recommended==="h_center"&&"水平居中",null),g(P,()=>c().recommended==="v_center"&&"垂直居中",null),g(Q,()=>c().reason),B(G=>{var D=i(),V=c().reason;return D!==G.e&&(N.disabled=G.e=D),V!==G.t&&X(N,"title",G.t=V),G},{e:void 0,t:void 0}),T}}),null),g(d,y(H,{get when(){return!r()},get children(){var T=ho(),U=T.firstChild;return U.firstChild,g(U,()=>n.selectedElementIds().length<3&&"，至少3个元素以使用分布功能",null),T}}),null),g(d,y(H,{get when(){return i()},get children(){return uo()}}),null),B(T=>{var U=!r()||i(),N=!r()||i(),$=!r()||i(),P=!r()||i(),Q=!r()||i(),G=!r()||i(),D=n.selectedElementIds().length<3||i(),V=n.selectedElementIds().length<3||i();return U!==T.e&&(f.disabled=T.e=U),N!==T.t&&(p.disabled=T.t=N),$!==T.a&&(b.disabled=T.a=$),P!==T.o&&(x.disabled=T.o=P),Q!==T.i&&(C.disabled=T.i=Q),G!==T.n&&(A.disabled=T.n=G),D!==T.s&&(E.disabled=T.s=D),V!==T.h&&(R.disabled=T.h=V),T},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d})()},po=`
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;if(typeof document<"u"){const n=document.createElement("style");n.textContent=po,document.head.appendChild(n)}He(["click"]);var mo=S("<div>"),bo=S('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),yo=S("<span class=ml-2>Zoom: <!>%");const Ki=()=>{const{state:n,selectElement:e,clearSelection:t,createElement:i,selectMultiple:s,updateElement:r,batchUpdatePositions:a}=ct();let l;const[o,c]=Z([]),d=Me(()=>n.elements.filter(w=>w.visible)),h=(w,x)=>{if(!l)return{x:0,y:0};const C=l.getBoundingClientRect(),A=(w-C.left)/n.canvas_config.zoom,M=(x-C.top)/n.canvas_config.zoom;return{x:A,y:M}},u=async w=>{console.log("🎯 选择元素",w),c([...w]);try{w.length===0?await t():w.length===1?await e(w[0]):await s([...w])}catch(x){console.error("❌ 选择元素失败:",x)}},v=async w=>{try{await a(w)}catch(x){console.error("❌ 批量更新位置失败:",x)}},f=async(w,x)=>{try{await r(w,{position:{x:x.x,y:x.y}})}catch(C){console.error("❌ 移动元素失败:",C)}},p=async(w,x,C)=>{try{await r(w,{size:x,position:C})}catch(A){console.error("❌ 调整大小失败:",A)}},b=async w=>{console.log("🖱️ 画布点击",w)},m=async w=>{w.preventDefault();try{const x=w.dataTransfer?.getData("application/json");if(!x)return;const{type:C,component:A}=JSON.parse(x);if(C==="component"){const{x:M,y:I}=h(w.clientX,w.clientY),z=Math.max(0,M-A.default_size.width/2),E=Math.max(0,I-A.default_size.height/2);console.log("🎯 通过拖放创建组件:",A.name,"at",z,E);const R=await i(A.id,{x:z,y:E},A.default_size,A.create_content());console.log("✅ 通过拖放创建元素成功:",R),c([R]),await e(R)}}catch(x){console.error("拖放处理失败:",x)}};et(()=>{c([...n.selected_ids])}),Me(()=>{c([...n.selected_ids])});const _=Me(()=>{const{width:w,height:x}=n.canvas_config;return`0 0 ${w} ${x}`});return(()=>{var w=bo(),x=w.firstChild,C=x.firstChild,A=C.firstChild,M=A.nextSibling,I=M.nextSibling,z=I.nextSibling,E=z.nextSibling,R=E.nextSibling,T=R.firstChild,U=T.nextSibling;U.nextSibling;var N=x.nextSibling,$=N.firstChild,P=$.firstChild,Q=P.firstChild,G=Q.firstChild,D=G.nextSibling,V=D.nextSibling,q=V.nextSibling;g(C,()=>n.canvas_config.width,M),g(C,()=>n.canvas_config.height,z),g(C,(()=>{var j=Ce(()=>n.canvas_config.zoom!==1);return()=>j()&&(()=>{var he=yo(),_e=he.firstChild,pe=_e.nextSibling;return pe.nextSibling,g(he,()=>Math.round(n.canvas_config.zoom*100),pe),he})()})(),R),g(R,()=>n.elements.length,U),g(R,()=>o().length,null),P.style.setProperty("position","relative"),Q.addEventListener("drop",m),Q.addEventListener("dragover",j=>{j.preventDefault(),j.dataTransfer.dropEffect="copy"}),Q.$$contextmenu=j=>j.preventDefault();var W=l;return typeof W=="function"?Vn(W,Q):l=Q,g(Q,y(Il,{get config(){return n.canvas_config}}),D),g(V,y(fe,{get each(){return d()},children:j=>y(Jl,{element:j,get selected(){return o().includes(j.id)}})})),g(q,y(fe,{get each(){return d().filter(j=>o().includes(j.id))},children:j=>y(to,{element:j})})),g(P,y(oo,{canvasRef:l,getAllElements:()=>[...n.elements],onElementsSelect:u,onElementMove:f,onBatchUpdatePositions:v,onElementResize:p,onCanvasClick:b,get enableDebugMode(){return!1}}),null),g(P,y(H,{get when(){return o().length>=2},get children(){var j=mo();return j.style.setProperty("position","fixed"),j.style.setProperty("top","80px"),j.style.setProperty("right","20px"),j.style.setProperty("z-index","1000"),j.style.setProperty("background","white"),j.style.setProperty("border-radius","8px"),j.style.setProperty("box-shadow","0 4px 12px rgba(0, 0, 0, 0.15)"),j.style.setProperty("border","1px solid #e5e7eb"),g(j,y(vo,{selectedElementIds:o,onAlignmentComplete:he=>{console.log("✅ 对齐操作完成:",he)},onAlignmentPreview:he=>{console.log("👁️ 对齐预览:",he)},onPreviewCancel:()=>{console.log("❌ 取消对齐预览")}})),j}}),null),B(j=>{var he=n.canvas_config.width*n.canvas_config.zoom,_e=n.canvas_config.height*n.canvas_config.zoom,pe=_(),se=n.canvas_config.width,ce=n.canvas_config.height,ue=n.canvas_config.background_color,ve=n.canvas_config.width,ne=n.canvas_config.height;return he!==j.e&&X(Q,"width",j.e=he),_e!==j.t&&X(Q,"height",j.t=_e),pe!==j.a&&X(Q,"viewBox",j.a=pe),se!==j.o&&X(G,"width",j.o=se),ce!==j.i&&X(G,"height",j.i=ce),ue!==j.n&&X(G,"fill",j.n=ue),ve!==j.s&&X(D,"width",j.s=ve),ne!==j.h&&X(D,"height",j.h=ne),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),w})()};He(["contextmenu"]);const _o=Math.PI/180;function xo(){return typeof window<"u"&&({}.toString.call(window)==="[object Window]"||{}.toString.call(window)==="[object global]")}const Lt=typeof global<"u"?global:typeof window<"u"?window:typeof WorkerGlobalScope<"u"?self:{},le={_global:Lt,version:"10.0.2",isBrowser:xo(),isUnminified:/param/.test(function(n){}.toString()),dblClickWindow:400,getAngle(n){return le.angleDeg?n*_o:n},enableTrace:!1,pointerEventsEnabled:!0,autoDrawEnabled:!0,hitOnDragEnabled:!1,capturePointerEventsEnabled:!1,_mouseListenClick:!1,_touchListenClick:!1,_pointerListenClick:!1,_mouseInDblClickWindow:!1,_touchInDblClickWindow:!1,_pointerInDblClickWindow:!1,_mouseDblClickPointerId:null,_touchDblClickPointerId:null,_pointerDblClickPointerId:null,_renderBackend:"web",legacyTextRendering:!1,pixelRatio:typeof window<"u"&&window.devicePixelRatio||1,dragDistance:3,angleDeg:!0,showWarnings:!0,dragButtons:[0,1],isDragging(){return le.DD.isDragging},isTransforming(){var n,e;return(e=(n=le.Transformer)===null||n===void 0?void 0:n.isTransforming())!==null&&e!==void 0?e:!1},isDragReady(){return!!le.DD.node},releaseCanvasOnDestroy:!0,document:Lt.document,_injectGlobal(n){typeof Lt.Konva<"u"&&console.error("Severa Konva instances detected. It is not recommended to use multiple Konva instances in the same environment."),Lt.Konva=n}},Be=n=>{le[n.prototype.getClassName()]=n};le._injectGlobal(le);const So=`Konva.js unsupported environment.

Looks like you are trying to use Konva.js in Node.js environment. because "document" object is undefined.

To use Konva.js in Node.js environment, you need to use the "canvas-backend" or "skia-backend" module.

bash: npm install canvas
js: import "konva/canvas-backend";

or

bash: npm install skia-canvas
js: import "konva/skia-backend";
`,Ji=()=>{if(typeof document>"u")throw new Error(So)};class Ke{constructor(e=[1,0,0,1,0,0]){this.dirty=!1,this.m=e&&e.slice()||[1,0,0,1,0,0]}reset(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=1,this.m[4]=0,this.m[5]=0}copy(){return new Ke(this.m)}copyInto(e){e.m[0]=this.m[0],e.m[1]=this.m[1],e.m[2]=this.m[2],e.m[3]=this.m[3],e.m[4]=this.m[4],e.m[5]=this.m[5]}point(e){const t=this.m;return{x:t[0]*e.x+t[2]*e.y+t[4],y:t[1]*e.x+t[3]*e.y+t[5]}}translate(e,t){return this.m[4]+=this.m[0]*e+this.m[2]*t,this.m[5]+=this.m[1]*e+this.m[3]*t,this}scale(e,t){return this.m[0]*=e,this.m[1]*=e,this.m[2]*=t,this.m[3]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),s=this.m[0]*t+this.m[2]*i,r=this.m[1]*t+this.m[3]*i,a=this.m[0]*-i+this.m[2]*t,l=this.m[1]*-i+this.m[3]*t;return this.m[0]=s,this.m[1]=r,this.m[2]=a,this.m[3]=l,this}getTranslation(){return{x:this.m[4],y:this.m[5]}}skew(e,t){const i=this.m[0]+this.m[2]*t,s=this.m[1]+this.m[3]*t,r=this.m[2]+this.m[0]*e,a=this.m[3]+this.m[1]*e;return this.m[0]=i,this.m[1]=s,this.m[2]=r,this.m[3]=a,this}multiply(e){const t=this.m[0]*e.m[0]+this.m[2]*e.m[1],i=this.m[1]*e.m[0]+this.m[3]*e.m[1],s=this.m[0]*e.m[2]+this.m[2]*e.m[3],r=this.m[1]*e.m[2]+this.m[3]*e.m[3],a=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],l=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];return this.m[0]=t,this.m[1]=i,this.m[2]=s,this.m[3]=r,this.m[4]=a,this.m[5]=l,this}invert(){const e=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),t=this.m[3]*e,i=-this.m[1]*e,s=-this.m[2]*e,r=this.m[0]*e,a=e*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),l=e*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=t,this.m[1]=i,this.m[2]=s,this.m[3]=r,this.m[4]=a,this.m[5]=l,this}getMatrix(){return this.m}decompose(){const e=this.m[0],t=this.m[1],i=this.m[2],s=this.m[3],r=this.m[4],a=this.m[5],l=e*s-t*i,o={x:r,y:a,rotation:0,scaleX:0,scaleY:0,skewX:0,skewY:0};if(e!=0||t!=0){const c=Math.sqrt(e*e+t*t);o.rotation=t>0?Math.acos(e/c):-Math.acos(e/c),o.scaleX=c,o.scaleY=l/c,o.skewX=(e*i+t*s)/l,o.skewY=0}else if(i!=0||s!=0){const c=Math.sqrt(i*i+s*s);o.rotation=Math.PI/2-(s>0?Math.acos(-i/c):-Math.acos(i/c)),o.scaleX=l/c,o.scaleY=c,o.skewX=0,o.skewY=(e*i+t*s)/l}return o.rotation=F._getRotation(o.rotation),o}}const wo="[object Array]",$o="[object Number]",Co="[object String]",ko="[object Boolean]",To=Math.PI/180,Eo=180/Math.PI,ri="#",Po="",Ao="0",Ro="Konva warning: ",Zi="Konva error: ",Lo="rgb(",ai={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},Mo=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;let Sn=[];const Do=typeof requestAnimationFrame<"u"&&requestAnimationFrame||function(n){setTimeout(n,60)},F={_isElement(n){return!!(n&&n.nodeType==1)},_isFunction(n){return!!(n&&n.constructor&&n.call&&n.apply)},_isPlainObject(n){return!!n&&n.constructor===Object},_isArray(n){return Object.prototype.toString.call(n)===wo},_isNumber(n){return Object.prototype.toString.call(n)===$o&&!isNaN(n)&&isFinite(n)},_isString(n){return Object.prototype.toString.call(n)===Co},_isBoolean(n){return Object.prototype.toString.call(n)===ko},isObject(n){return n instanceof Object},isValidSelector(n){if(typeof n!="string")return!1;const e=n[0];return e==="#"||e==="."||e===e.toUpperCase()},_sign(n){return n===0||n>0?1:-1},requestAnimFrame(n){Sn.push(n),Sn.length===1&&Do(function(){const e=Sn;Sn=[],e.forEach(function(t){t()})})},createCanvasElement(){Ji();const n=document.createElement("canvas");try{n.style=n.style||{}}catch{}return n},createImageElement(){return Ji(),document.createElement("img")},_isInDocument(n){for(;n=n.parentNode;)if(n==document)return!0;return!1},_urlToImage(n,e){const t=F.createImageElement();t.onload=function(){e(t)},t.src=n},_rgbToHex(n,e,t){return((1<<24)+(n<<16)+(e<<8)+t).toString(16).slice(1)},_hexToRgb(n){n=n.replace(ri,Po);const e=parseInt(n,16);return{r:e>>16&255,g:e>>8&255,b:e&255}},getRandomColor(){let n=(Math.random()*16777215<<0).toString(16);for(;n.length<6;)n=Ao+n;return ri+n},getRGB(n){let e;return n in ai?(e=ai[n],{r:e[0],g:e[1],b:e[2]}):n[0]===ri?this._hexToRgb(n.substring(1)):n.substr(0,4)===Lo?(e=Mo.exec(n.replace(/ /g,"")),{r:parseInt(e[1],10),g:parseInt(e[2],10),b:parseInt(e[3],10)}):{r:0,g:0,b:0}},colorToRGBA(n){return n=n||"black",F._namedColorToRBA(n)||F._hex3ColorToRGBA(n)||F._hex4ColorToRGBA(n)||F._hex6ColorToRGBA(n)||F._hex8ColorToRGBA(n)||F._rgbColorToRGBA(n)||F._rgbaColorToRGBA(n)||F._hslColorToRGBA(n)},_namedColorToRBA(n){const e=ai[n.toLowerCase()];return e?{r:e[0],g:e[1],b:e[2],a:1}:null},_rgbColorToRGBA(n){if(n.indexOf("rgb(")===0){n=n.match(/rgb\(([^)]+)\)/)[1];const e=n.split(/ *, */).map(Number);return{r:e[0],g:e[1],b:e[2],a:1}}},_rgbaColorToRGBA(n){if(n.indexOf("rgba(")===0){n=n.match(/rgba\(([^)]+)\)/)[1];const e=n.split(/ *, */).map((t,i)=>t.slice(-1)==="%"?i===3?parseInt(t)/100:parseInt(t)/100*255:Number(t));return{r:e[0],g:e[1],b:e[2],a:e[3]}}},_hex8ColorToRGBA(n){if(n[0]==="#"&&n.length===9)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:parseInt(n.slice(7,9),16)/255}},_hex6ColorToRGBA(n){if(n[0]==="#"&&n.length===7)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:1}},_hex4ColorToRGBA(n){if(n[0]==="#"&&n.length===5)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:parseInt(n[4]+n[4],16)/255}},_hex3ColorToRGBA(n){if(n[0]==="#"&&n.length===4)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:1}},_hslColorToRGBA(n){if(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.test(n)){const[e,...t]=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(n),i=Number(t[0])/360,s=Number(t[1])/100,r=Number(t[2])/100;let a,l,o;if(s===0)return o=r*255,{r:Math.round(o),g:Math.round(o),b:Math.round(o),a:1};r<.5?a=r*(1+s):a=r+s-r*s;const c=2*r-a,d=[0,0,0];for(let h=0;h<3;h++)l=i+1/3*-(h-1),l<0&&l++,l>1&&l--,6*l<1?o=c+(a-c)*6*l:2*l<1?o=a:3*l<2?o=c+(a-c)*(2/3-l)*6:o=c,d[h]=o*255;return{r:Math.round(d[0]),g:Math.round(d[1]),b:Math.round(d[2]),a:1}}},haveIntersection(n,e){return!(e.x>n.x+n.width||e.x+e.width<n.x||e.y>n.y+n.height||e.y+e.height<n.y)},cloneObject(n){const e={};for(const t in n)this._isPlainObject(n[t])?e[t]=this.cloneObject(n[t]):this._isArray(n[t])?e[t]=this.cloneArray(n[t]):e[t]=n[t];return e},cloneArray(n){return n.slice(0)},degToRad(n){return n*To},radToDeg(n){return n*Eo},_degToRad(n){return F.warn("Util._degToRad is removed. Please use public Util.degToRad instead."),F.degToRad(n)},_radToDeg(n){return F.warn("Util._radToDeg is removed. Please use public Util.radToDeg instead."),F.radToDeg(n)},_getRotation(n){return le.angleDeg?F.radToDeg(n):n},_capitalize(n){return n.charAt(0).toUpperCase()+n.slice(1)},throw(n){throw new Error(Zi+n)},error(n){console.error(Zi+n)},warn(n){le.showWarnings&&console.warn(Ro+n)},each(n,e){for(const t in n)e(t,n[t])},_inRange(n,e,t){return e<=n&&n<t},_getProjectionToSegment(n,e,t,i,s,r){let a,l,o;const c=(n-t)*(n-t)+(e-i)*(e-i);if(c==0)a=n,l=e,o=(s-t)*(s-t)+(r-i)*(r-i);else{const d=((s-n)*(t-n)+(r-e)*(i-e))/c;d<0?(a=n,l=e,o=(n-s)*(n-s)+(e-r)*(e-r)):d>1?(a=t,l=i,o=(t-s)*(t-s)+(i-r)*(i-r)):(a=n+d*(t-n),l=e+d*(i-e),o=(a-s)*(a-s)+(l-r)*(l-r))}return[a,l,o]},_getProjectionToLine(n,e,t){const i=F.cloneObject(n);let s=Number.MAX_VALUE;return e.forEach(function(r,a){if(!t&&a===e.length-1)return;const l=e[(a+1)%e.length],o=F._getProjectionToSegment(r.x,r.y,l.x,l.y,n.x,n.y),c=o[0],d=o[1],h=o[2];h<s&&(i.x=c,i.y=d,s=h)}),i},_prepareArrayForTween(n,e,t){const i=[],s=[];if(n.length>e.length){const a=e;e=n,n=a}for(let a=0;a<n.length;a+=2)i.push({x:n[a],y:n[a+1]});for(let a=0;a<e.length;a+=2)s.push({x:e[a],y:e[a+1]});const r=[];return s.forEach(function(a){const l=F._getProjectionToLine(a,i,t);r.push(l.x),r.push(l.y)}),r},_prepareToStringify(n){let e;n.visitedByCircularReferenceRemoval=!0;for(const t in n)if(n.hasOwnProperty(t)&&n[t]&&typeof n[t]=="object"){if(e=Object.getOwnPropertyDescriptor(n,t),n[t].visitedByCircularReferenceRemoval||F._isElement(n[t]))if(e.configurable)delete n[t];else return null;else if(F._prepareToStringify(n[t])===null)if(e.configurable)delete n[t];else return null}return delete n.visitedByCircularReferenceRemoval,n},_assign(n,e){for(const t in e)n[t]=e[t];return n},_getFirstPointerId(n){return n.touches?n.changedTouches[0].identifier:n.pointerId||999},releaseCanvas(...n){le.releaseCanvasOnDestroy&&n.forEach(e=>{e.width=0,e.height=0})},drawRoundedRectPath(n,e,t,i){let s=e<0?e:0,r=t<0?t:0;e=Math.abs(e),t=Math.abs(t);let a=0,l=0,o=0,c=0;typeof i=="number"?a=l=o=c=Math.min(i,e/2,t/2):(a=Math.min(i[0]||0,e/2,t/2),l=Math.min(i[1]||0,e/2,t/2),c=Math.min(i[2]||0,e/2,t/2),o=Math.min(i[3]||0,e/2,t/2)),n.moveTo(s+a,r),n.lineTo(s+e-l,r),n.arc(s+e-l,r+l,l,Math.PI*3/2,0,!1),n.lineTo(s+e,r+t-c),n.arc(s+e-c,r+t-c,c,0,Math.PI/2,!1),n.lineTo(s+o,r+t),n.arc(s+o,r+t-o,o,Math.PI/2,Math.PI,!1),n.lineTo(s,r+a),n.arc(s+a,r+a,a,Math.PI,Math.PI*3/2,!1)},drawRoundedPolygonPath(n,e,t,i,s){i=Math.abs(i);for(let r=0;r<t;r++){const a=e[(r-1+t)%t],l=e[r],o=e[(r+1)%t],c={x:l.x-a.x,y:l.y-a.y},d={x:o.x-l.x,y:o.y-l.y},h=Math.hypot(c.x,c.y),u=Math.hypot(d.x,d.y);let v;typeof s=="number"?v=s:v=r<s.length?s[r]:0,v=i*Math.cos(Math.PI/t)*Math.min(1,v/i*2);const p={x:c.x/h,y:c.y/h},b={x:d.x/u,y:d.y/u},m={x:l.x-p.x*v,y:l.y-p.y*v},_={x:l.x+b.x*v,y:l.y+b.y*v};r===0?n.moveTo(m.x,m.y):n.lineTo(m.x,m.y),n.arcTo(l.x,l.y,_.x,_.y,v)}}};function Oo(n){const e=[],t=n.length,i=F;for(let s=0;s<t;s++){let r=n[s];i._isNumber(r)?r=Math.round(r*1e3)/1e3:i._isString(r)||(r=r+""),e.push(r)}return e}const es=",",Io="(",No=")",zo="([",Fo="])",Go=";",Bo="()",Uo="=",ts=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","ellipse","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","roundRect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"],Ho=["fillStyle","strokeStyle","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","letterSpacing","lineCap","lineDashOffset","lineJoin","lineWidth","miterLimit","direction","font","textAlign","textBaseline","globalAlpha","globalCompositeOperation","imageSmoothingEnabled","filter"],qo=100;let wn=null;function ns(){if(wn!==null)return wn;try{const e=F.createCanvasElement().getContext("2d");return e?!!e&&"filter"in e:(wn=!1,!1)}catch{return wn=!1,!1}}class Qn{constructor(e){this.canvas=e,le.enableTrace&&(this.traceArr=[],this._enableTrace())}fillShape(e){e.fillEnabled()&&this._fill(e)}_fill(e){}strokeShape(e){e.hasStroke()&&this._stroke(e)}_stroke(e){}fillStrokeShape(e){e.attrs.fillAfterStrokeEnabled?(this.strokeShape(e),this.fillShape(e)):(this.fillShape(e),this.strokeShape(e))}getTrace(e,t){let i=this.traceArr,s=i.length,r="",a,l,o,c;for(a=0;a<s;a++)l=i[a],o=l.method,o?(c=l.args,r+=o,e?r+=Bo:F._isArray(c[0])?r+=zo+c.join(es)+Fo:(t&&(c=c.map(d=>typeof d=="number"?Math.floor(d):d)),r+=Io+c.join(es)+No)):(r+=l.property,e||(r+=Uo+l.val)),r+=Go;return r}clearTrace(){this.traceArr=[]}_trace(e){let t=this.traceArr,i;t.push(e),i=t.length,i>=qo&&t.shift()}reset(){const e=this.getCanvas().getPixelRatio();this.setTransform(1*e,0,0,1*e,0,0)}getCanvas(){return this.canvas}clear(e){const t=this.getCanvas();e?this.clearRect(e.x||0,e.y||0,e.width||0,e.height||0):this.clearRect(0,0,t.getWidth()/t.pixelRatio,t.getHeight()/t.pixelRatio)}_applyLineCap(e){const t=e.attrs.lineCap;t&&this.setAttr("lineCap",t)}_applyOpacity(e){const t=e.getAbsoluteOpacity();t!==1&&this.setAttr("globalAlpha",t)}_applyLineJoin(e){const t=e.attrs.lineJoin;t&&this.setAttr("lineJoin",t)}_applyMiterLimit(e){const t=e.attrs.miterLimit;t!=null&&this.setAttr("miterLimit",t)}setAttr(e,t){this._context[e]=t}arc(e,t,i,s,r,a){this._context.arc(e,t,i,s,r,a)}arcTo(e,t,i,s,r){this._context.arcTo(e,t,i,s,r)}beginPath(){this._context.beginPath()}bezierCurveTo(e,t,i,s,r,a){this._context.bezierCurveTo(e,t,i,s,r,a)}clearRect(e,t,i,s){this._context.clearRect(e,t,i,s)}clip(...e){this._context.clip.apply(this._context,e)}closePath(){this._context.closePath()}createImageData(e,t){const i=arguments;if(i.length===2)return this._context.createImageData(e,t);if(i.length===1)return this._context.createImageData(e)}createLinearGradient(e,t,i,s){return this._context.createLinearGradient(e,t,i,s)}createPattern(e,t){return this._context.createPattern(e,t)}createRadialGradient(e,t,i,s,r,a){return this._context.createRadialGradient(e,t,i,s,r,a)}drawImage(e,t,i,s,r,a,l,o,c){const d=arguments,h=this._context;d.length===3?h.drawImage(e,t,i):d.length===5?h.drawImage(e,t,i,s,r):d.length===9&&h.drawImage(e,t,i,s,r,a,l,o,c)}ellipse(e,t,i,s,r,a,l,o){this._context.ellipse(e,t,i,s,r,a,l,o)}isPointInPath(e,t,i,s){return i?this._context.isPointInPath(i,e,t,s):this._context.isPointInPath(e,t,s)}fill(...e){this._context.fill.apply(this._context,e)}fillRect(e,t,i,s){this._context.fillRect(e,t,i,s)}strokeRect(e,t,i,s){this._context.strokeRect(e,t,i,s)}fillText(e,t,i,s){s?this._context.fillText(e,t,i,s):this._context.fillText(e,t,i)}measureText(e){return this._context.measureText(e)}getImageData(e,t,i,s){return this._context.getImageData(e,t,i,s)}lineTo(e,t){this._context.lineTo(e,t)}moveTo(e,t){this._context.moveTo(e,t)}rect(e,t,i,s){this._context.rect(e,t,i,s)}roundRect(e,t,i,s,r){this._context.roundRect(e,t,i,s,r)}putImageData(e,t,i){this._context.putImageData(e,t,i)}quadraticCurveTo(e,t,i,s){this._context.quadraticCurveTo(e,t,i,s)}restore(){this._context.restore()}rotate(e){this._context.rotate(e)}save(){this._context.save()}scale(e,t){this._context.scale(e,t)}setLineDash(e){this._context.setLineDash?this._context.setLineDash(e):"mozDash"in this._context?this._context.mozDash=e:"webkitLineDash"in this._context&&(this._context.webkitLineDash=e)}getLineDash(){return this._context.getLineDash()}setTransform(e,t,i,s,r,a){this._context.setTransform(e,t,i,s,r,a)}stroke(e){e?this._context.stroke(e):this._context.stroke()}strokeText(e,t,i,s){this._context.strokeText(e,t,i,s)}transform(e,t,i,s,r,a){this._context.transform(e,t,i,s,r,a)}translate(e,t){this._context.translate(e,t)}_enableTrace(){let e=this,t=ts.length,i=this.setAttr,s,r;const a=function(l){let o=e[l],c;e[l]=function(){return r=Oo(Array.prototype.slice.call(arguments,0)),c=o.apply(e,arguments),e._trace({method:l,args:r}),c}};for(s=0;s<t;s++)a(ts[s]);e.setAttr=function(){i.apply(e,arguments);const l=arguments[0];let o=arguments[1];(l==="shadowOffsetX"||l==="shadowOffsetY"||l==="shadowBlur")&&(o=o/this.canvas.getPixelRatio()),e._trace({property:l,val:o})}}_applyGlobalCompositeOperation(e){const t=e.attrs.globalCompositeOperation;!t||t==="source-over"||this.setAttr("globalCompositeOperation",t)}}Ho.forEach(function(n){Object.defineProperty(Qn.prototype,n,{get(){return this._context[n]},set(e){this._context[n]=e}})});class Wo extends Qn{constructor(e,{willReadFrequently:t=!1}={}){super(e),this._context=e._canvas.getContext("2d",{willReadFrequently:t})}_fillColor(e){const t=e.fill();this.setAttr("fillStyle",t),e._fillFunc(this)}_fillPattern(e){this.setAttr("fillStyle",e._getFillPattern()),e._fillFunc(this)}_fillLinearGradient(e){const t=e._getLinearGradient();t&&(this.setAttr("fillStyle",t),e._fillFunc(this))}_fillRadialGradient(e){const t=e._getRadialGradient();t&&(this.setAttr("fillStyle",t),e._fillFunc(this))}_fill(e){const t=e.fill(),i=e.getFillPriority();if(t&&i==="color"){this._fillColor(e);return}const s=e.getFillPatternImage();if(s&&i==="pattern"){this._fillPattern(e);return}const r=e.getFillLinearGradientColorStops();if(r&&i==="linear-gradient"){this._fillLinearGradient(e);return}const a=e.getFillRadialGradientColorStops();if(a&&i==="radial-gradient"){this._fillRadialGradient(e);return}t?this._fillColor(e):s?this._fillPattern(e):r?this._fillLinearGradient(e):a&&this._fillRadialGradient(e)}_strokeLinearGradient(e){const t=e.getStrokeLinearGradientStartPoint(),i=e.getStrokeLinearGradientEndPoint(),s=e.getStrokeLinearGradientColorStops(),r=this.createLinearGradient(t.x,t.y,i.x,i.y);if(s){for(let a=0;a<s.length;a+=2)r.addColorStop(s[a],s[a+1]);this.setAttr("strokeStyle",r)}}_stroke(e){const t=e.dash(),i=e.getStrokeScaleEnabled();if(e.hasStroke()){if(!i){this.save();const r=this.getCanvas().getPixelRatio();this.setTransform(r,0,0,r,0,0)}this._applyLineCap(e),t&&e.dashEnabled()&&(this.setLineDash(t),this.setAttr("lineDashOffset",e.dashOffset())),this.setAttr("lineWidth",e.strokeWidth()),e.getShadowForStrokeEnabled()||this.setAttr("shadowColor","rgba(0,0,0,0)"),e.getStrokeLinearGradientColorStops()?this._strokeLinearGradient(e):this.setAttr("strokeStyle",e.stroke()),e._strokeFunc(this),i||this.restore()}}_applyShadow(e){var t,i,s;const r=(t=e.getShadowRGBA())!==null&&t!==void 0?t:"black",a=(i=e.getShadowBlur())!==null&&i!==void 0?i:5,l=(s=e.getShadowOffset())!==null&&s!==void 0?s:{x:0,y:0},o=e.getAbsoluteScale(),c=this.canvas.getPixelRatio(),d=o.x*c,h=o.y*c;this.setAttr("shadowColor",r),this.setAttr("shadowBlur",a*Math.min(Math.abs(d),Math.abs(h))),this.setAttr("shadowOffsetX",l.x*d),this.setAttr("shadowOffsetY",l.y*h)}}class jo extends Qn{constructor(e){super(e),this._context=e._canvas.getContext("2d",{willReadFrequently:!0})}_fill(e){this.save(),this.setAttr("fillStyle",e.colorKey),e._fillFuncHit(this),this.restore()}strokeShape(e){e.hasHitStroke()&&this._stroke(e)}_stroke(e){if(e.hasHitStroke()){const t=e.getStrokeScaleEnabled();if(!t){this.save();const r=this.getCanvas().getPixelRatio();this.setTransform(r,0,0,r,0,0)}this._applyLineCap(e);const i=e.hitStrokeWidth(),s=i==="auto"?e.strokeWidth():i;this.setAttr("lineWidth",s),this.setAttr("strokeStyle",e.colorKey),e._strokeFuncHit(this),t||this.restore()}}}let $n;function Yo(){if($n)return $n;const n=F.createCanvasElement(),e=n.getContext("2d");return $n=function(){const t=le._global.devicePixelRatio||1,i=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return t/i}(),F.releaseCanvas(n),$n}class Li{constructor(e){this.pixelRatio=1,this.width=0,this.height=0,this.isCache=!1;const i=(e||{}).pixelRatio||le.pixelRatio||Yo();this.pixelRatio=i,this._canvas=F.createCanvasElement(),this._canvas.style.padding="0",this._canvas.style.margin="0",this._canvas.style.border="0",this._canvas.style.background="transparent",this._canvas.style.position="absolute",this._canvas.style.top="0",this._canvas.style.left="0"}getContext(){return this.context}getPixelRatio(){return this.pixelRatio}setPixelRatio(e){const t=this.pixelRatio;this.pixelRatio=e,this.setSize(this.getWidth()/t,this.getHeight()/t)}setWidth(e){this.width=this._canvas.width=e*this.pixelRatio,this._canvas.style.width=e+"px";const t=this.pixelRatio;this.getContext()._context.scale(t,t)}setHeight(e){this.height=this._canvas.height=e*this.pixelRatio,this._canvas.style.height=e+"px";const t=this.pixelRatio;this.getContext()._context.scale(t,t)}getWidth(){return this.width}getHeight(){return this.height}setSize(e,t){this.setWidth(e||0),this.setHeight(t||0)}toDataURL(e,t){try{return this._canvas.toDataURL(e,t)}catch{try{return this._canvas.toDataURL()}catch(s){return F.error("Unable to get data URL. "+s.message+" For more info read https://konvajs.org/docs/posts/Tainted_Canvas.html."),""}}}}class St extends Li{constructor(e={width:0,height:0,willReadFrequently:!1}){super(e),this.context=new Wo(this,{willReadFrequently:e.willReadFrequently}),this.setSize(e.width,e.height)}}function is(){const n=F.createCanvasElement();n.width=1,n.height=1;const e=n.getContext("2d",{willReadFrequently:!0});e.clearRect(0,0,1,1),e.fillStyle="rgba(255,0,255,1)",e.fillRect(0,0,1,1);const t=e.getImageData(0,0,1,1).data;return!(t[0]===255&&t[1]===0&&t[2]===255&&t[3]===255)}function ss(){var n,e;return typeof navigator>"u"?!1:(e=(n=navigator.brave)===null||n===void 0?void 0:n.isBrave())!==null&&e!==void 0?e:!1}let rs=!1;function Vo(){return ss()&&is()&&!rs&&(rs=!0,F.error('Looks like you have "Brave shield" enabled in your browser. It breaks KonvaJS internals. Please disable it. You may need to ask your users to do the same.')),ss()&&is()}class Mi extends Li{constructor(e={width:0,height:0}){super(e),this.hitCanvas=!0,this.context=new jo(this),this.setSize(e.width,e.height),Vo()}}const Re={get isDragging(){let n=!1;return Re._dragElements.forEach(e=>{e.dragStatus==="dragging"&&(n=!0)}),n},justDragged:!1,get node(){let n;return Re._dragElements.forEach(e=>{n=e.node}),n},_dragElements:new Map,_drag(n){const e=[];Re._dragElements.forEach((t,i)=>{const{node:s}=t,r=s.getStage();r.setPointersPositions(n),t.pointerId===void 0&&(t.pointerId=F._getFirstPointerId(n));const a=r._changedPointerPositions.find(l=>l.id===t.pointerId);if(a){if(t.dragStatus!=="dragging"){const l=s.dragDistance();if(Math.max(Math.abs(a.x-t.startPointerPos.x),Math.abs(a.y-t.startPointerPos.y))<l||(s.startDrag({evt:n}),!s.isDragging()))return}s._setDragPosition(n,t),e.push(s)}}),e.forEach(t=>{t.fire("dragmove",{type:"dragmove",target:t,evt:n},!0)})},_endDragBefore(n){const e=[];Re._dragElements.forEach(t=>{const{node:i}=t,s=i.getStage();if(n&&s.setPointersPositions(n),!s._changedPointerPositions.find(l=>l.id===t.pointerId))return;(t.dragStatus==="dragging"||t.dragStatus==="stopped")&&(Re.justDragged=!0,le._mouseListenClick=!1,le._touchListenClick=!1,le._pointerListenClick=!1,t.dragStatus="stopped");const a=t.node.getLayer()||t.node instanceof le.Stage&&t.node;a&&e.indexOf(a)===-1&&e.push(a)}),e.forEach(t=>{t.draw()})},_endDragAfter(n){Re._dragElements.forEach((e,t)=>{e.dragStatus==="stopped"&&e.node.fire("dragend",{type:"dragend",target:e.node,evt:n},!0),e.dragStatus!=="dragging"&&Re._dragElements.delete(t)})}};le.isBrowser&&(window.addEventListener("mouseup",Re._endDragBefore,!0),window.addEventListener("touchend",Re._endDragBefore,!0),window.addEventListener("touchcancel",Re._endDragBefore,!0),window.addEventListener("mousemove",Re._drag),window.addEventListener("touchmove",Re._drag),window.addEventListener("mouseup",Re._endDragAfter,!1),window.addEventListener("touchend",Re._endDragAfter,!1),window.addEventListener("touchcancel",Re._endDragAfter,!1));function Ct(n){return F._isString(n)?'"'+n+'"':Object.prototype.toString.call(n)==="[object Number]"||F._isBoolean(n)?n:Object.prototype.toString.call(n)}function ir(n){return n>255?255:n<0?0:Math.round(n)}function re(){if(le.isUnminified)return function(n,e){return F._isNumber(n)||F.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a number.'),n}}function Kn(n){if(le.isUnminified)return function(e,t){let i=F._isNumber(e),s=F._isArray(e)&&e.length==n;return!i&&!s&&F.warn(Ct(e)+' is a not valid value for "'+t+'" attribute. The value should be a number or Array<number>('+n+")"),e}}function Di(){if(le.isUnminified)return function(n,e){return F._isNumber(n)||n==="auto"||F.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a number or "auto".'),n}}function Ot(){if(le.isUnminified)return function(n,e){return F._isString(n)||F.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a string.'),n}}function sr(){if(le.isUnminified)return function(n,e){const t=F._isString(n),i=Object.prototype.toString.call(n)==="[object CanvasGradient]"||n&&n.addColorStop;return t||i||F.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a string or a native gradient.'),n}}function Xo(){if(le.isUnminified)return function(n,e){const t=Int8Array?Object.getPrototypeOf(Int8Array):null;return t&&n instanceof t||(F._isArray(n)?n.forEach(function(i){F._isNumber(i)||F.warn('"'+e+'" attribute has non numeric element '+i+". Make sure that all elements are numbers.")}):F.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a array of numbers.')),n}}function at(){if(le.isUnminified)return function(n,e){return n===!0||n===!1||F.warn(Ct(n)+' is a not valid value for "'+e+'" attribute. The value should be a boolean.'),n}}function Qo(n){if(le.isUnminified)return function(e,t){return e==null||F.isObject(e)||F.warn(Ct(e)+' is a not valid value for "'+t+'" attribute. The value should be an object with properties '+n),e}}const Zt="get",en="set",k={addGetterSetter(n,e,t,i,s){k.addGetter(n,e,t),k.addSetter(n,e,i,s),k.addOverloadedGetterSetter(n,e)},addGetter(n,e,t){const i=Zt+F._capitalize(e);n.prototype[i]=n.prototype[i]||function(){const s=this.attrs[e];return s===void 0?t:s}},addSetter(n,e,t,i){const s=en+F._capitalize(e);n.prototype[s]||k.overWriteSetter(n,e,t,i)},overWriteSetter(n,e,t,i){const s=en+F._capitalize(e);n.prototype[s]=function(r){return t&&r!==void 0&&r!==null&&(r=t.call(this,r,e)),this._setAttr(e,r),i&&i.call(this),this}},addComponentsGetterSetter(n,e,t,i,s){const r=t.length,a=F._capitalize,l=Zt+a(e),o=en+a(e);n.prototype[l]=function(){const d={};for(let h=0;h<r;h++){const u=t[h];d[u]=this.getAttr(e+a(u))}return d};const c=Qo(t);n.prototype[o]=function(d){const h=this.attrs[e];i&&(d=i.call(this,d,e)),c&&c.call(this,d,e);for(const u in d)d.hasOwnProperty(u)&&this._setAttr(e+a(u),d[u]);return d||t.forEach(u=>{this._setAttr(e+a(u),void 0)}),this._fireChangeEvent(e,h,d),s&&s.call(this),this},k.addOverloadedGetterSetter(n,e)},addOverloadedGetterSetter(n,e){const t=F._capitalize(e),i=en+t,s=Zt+t;n.prototype[e]=function(){return arguments.length?(this[i](arguments[0]),this):this[s]()}},addDeprecatedGetterSetter(n,e,t,i){F.error("Adding deprecated "+e);const s=Zt+F._capitalize(e),r=e+" property is deprecated and will be removed soon. Look at Konva change log for more information.";n.prototype[s]=function(){F.error(r);const a=this.attrs[e];return a===void 0?t:a},k.addSetter(n,e,i,function(){F.error(r)}),k.addOverloadedGetterSetter(n,e)},backCompat(n,e){F.each(e,function(t,i){const s=n.prototype[i],r=Zt+F._capitalize(t),a=en+F._capitalize(t);function l(){s.apply(this,arguments),F.error('"'+t+'" method is deprecated and will be removed soon. Use ""'+i+'" instead.')}n.prototype[t]=l,n.prototype[r]=l,n.prototype[a]=l})},afterSetFilter(){this._filterUpToDate=!1}};function Ko(n){const e=/(\w+)\(([^)]+)\)/g;let t;for(;(t=e.exec(n))!==null;){const[,i,s]=t;switch(i){case"blur":{const r=parseFloat(s.replace("px",""));return function(a){this.blurRadius(r*.5);const l=le.Filters;l&&l.Blur&&l.Blur.call(this,a)}}case"brightness":{const r=s.includes("%")?parseFloat(s)/100:parseFloat(s);return function(a){this.brightness(r);const l=le.Filters;l&&l.Brightness&&l.Brightness.call(this,a)}}case"contrast":{const r=parseFloat(s);return function(a){const l=100*(Math.sqrt(r)-1);this.contrast(l);const o=le.Filters;o&&o.Contrast&&o.Contrast.call(this,a)}}case"grayscale":return function(r){const a=le.Filters;a&&a.Grayscale&&a.Grayscale.call(this,r)};case"sepia":return function(r){const a=le.Filters;a&&a.Sepia&&a.Sepia.call(this,r)};case"invert":return function(r){const a=le.Filters;a&&a.Invert&&a.Invert.call(this,r)};default:F.warn(`CSS filter "${i}" is not supported in fallback mode. Consider using function filters for better compatibility.`);break}}return()=>{}}const On="absoluteOpacity",Cn="allEventListeners",ht="absoluteTransform",as="absoluteScale",At="canvas",Jo="Change",Zo="children",ec="konva",_i="listening",tc="mouseenter",nc="mouseleave",ic="pointerenter",sc="pointerleave",rc="touchenter",ac="touchleave",ls="set",os="Shape",In=" ",cs="stage",yt="transform",lc="Stage",xi="visible",oc=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(In);let cc=1;class ie{constructor(e){this._id=cc++,this.eventListeners={},this.attrs={},this.index=0,this._allEventListeners=null,this.parent=null,this._cache=new Map,this._attachedDepsListeners=new Map,this._lastPos=null,this._batchingTransformChange=!1,this._needClearTransformCache=!1,this._filterUpToDate=!1,this._isUnderCache=!1,this._dragEventId=null,this._shouldFireChangeEvents=!1,this.setAttrs(e),this._shouldFireChangeEvents=!0}hasChildren(){return!1}_clearCache(e){(e===yt||e===ht)&&this._cache.get(e)?this._cache.get(e).dirty=!0:e?this._cache.delete(e):this._cache.clear()}_getCache(e,t){let i=this._cache.get(e);return(i===void 0||(e===yt||e===ht)&&i.dirty===!0)&&(i=t.call(this),this._cache.set(e,i)),i}_calculate(e,t,i){if(!this._attachedDepsListeners.get(e)){const s=t.map(r=>r+"Change.konva").join(In);this.on(s,()=>{this._clearCache(e)}),this._attachedDepsListeners.set(e,!0)}return this._getCache(e,i)}_getCanvasCache(){return this._cache.get(At)}_clearSelfAndDescendantCache(e){this._clearCache(e),e===ht&&this.fire("absoluteTransformChange")}clearCache(){if(this._cache.has(At)){const{scene:e,filter:t,hit:i,buffer:s}=this._cache.get(At);F.releaseCanvas(e,t,i,s),this._cache.delete(At)}return this._clearSelfAndDescendantCache(),this._requestDraw(),this}cache(e){const t=e||{};let i={};(t.x===void 0||t.y===void 0||t.width===void 0||t.height===void 0)&&(i=this.getClientRect({skipTransform:!0,relativeTo:this.getParent()||void 0}));let s=Math.ceil(t.width||i.width),r=Math.ceil(t.height||i.height),a=t.pixelRatio,l=t.x===void 0?Math.floor(i.x):t.x,o=t.y===void 0?Math.floor(i.y):t.y,c=t.offset||0,d=t.drawBorder||!1,h=t.hitCanvasPixelRatio||1;if(!s||!r){F.error("Can not cache the node. Width or height of the node equals 0. Caching is skipped.");return}const u=Math.abs(Math.round(i.x)-l)>.5?1:0,v=Math.abs(Math.round(i.y)-o)>.5?1:0;s+=c*2+u,r+=c*2+v,l-=c,o-=c;const f=new St({pixelRatio:a,width:s,height:r}),p=new St({pixelRatio:a,width:0,height:0,willReadFrequently:!0}),b=new Mi({pixelRatio:h,width:s,height:r}),m=f.getContext(),_=b.getContext(),w=new St({width:f.width/f.pixelRatio+Math.abs(l),height:f.height/f.pixelRatio+Math.abs(o),pixelRatio:f.pixelRatio}),x=w.getContext();return b.isCache=!0,f.isCache=!0,this._cache.delete(At),this._filterUpToDate=!1,t.imageSmoothingEnabled===!1&&(f.getContext()._context.imageSmoothingEnabled=!1,p.getContext()._context.imageSmoothingEnabled=!1),m.save(),_.save(),x.save(),m.translate(-l,-o),_.translate(-l,-o),x.translate(-l,-o),w.x=l,w.y=o,this._isUnderCache=!0,this._clearSelfAndDescendantCache(On),this._clearSelfAndDescendantCache(as),this.drawScene(f,this,w),this.drawHit(b,this),this._isUnderCache=!1,m.restore(),_.restore(),d&&(m.save(),m.beginPath(),m.rect(0,0,s,r),m.closePath(),m.setAttr("strokeStyle","red"),m.setAttr("lineWidth",5),m.stroke(),m.restore()),this._cache.set(At,{scene:f,filter:p,hit:b,buffer:w,x:l,y:o}),this._requestDraw(),this}isCached(){return this._cache.has(At)}getClientRect(e){throw new Error('abstract "getClientRect" method call')}_transformedRect(e,t){const i=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}];let s=1/0,r=1/0,a=-1/0,l=-1/0;const o=this.getAbsoluteTransform(t);return i.forEach(function(c){const d=o.point(c);s===void 0&&(s=a=d.x,r=l=d.y),s=Math.min(s,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y)}),{x:s,y:r,width:a-s,height:l-r}}_drawCachedSceneCanvas(e){e.save(),e._applyOpacity(this),e._applyGlobalCompositeOperation(this);const t=this._getCanvasCache();e.translate(t.x,t.y);const i=this._getCachedSceneCanvas(),s=i.pixelRatio;e.drawImage(i._canvas,0,0,i.width/s,i.height/s),e.restore()}_drawCachedHitCanvas(e){const t=this._getCanvasCache(),i=t.hit;e.save(),e.translate(t.x,t.y),e.drawImage(i._canvas,0,0,i.width/i.pixelRatio,i.height/i.pixelRatio),e.restore()}_getCachedSceneCanvas(){let e=this.filters(),t=this._getCanvasCache(),i=t.scene,s=t.filter,r=s.getContext(),a,l,o,c;if(!e||e.length===0)return i;if(this._filterUpToDate)return s;let d=!0;for(let u=0;u<e.length;u++)if(typeof e[u]=="string"&&ns(),typeof e[u]!="string"||!ns()){d=!1;break}const h=i.pixelRatio;if(s.setSize(i.width/i.pixelRatio,i.height/i.pixelRatio),d){const u=e.join(" ");return r.save(),r.setAttr("filter",u),r.drawImage(i._canvas,0,0,i.getWidth()/h,i.getHeight()/h),r.restore(),this._filterUpToDate=!0,s}try{for(a=e.length,r.clear(),r.drawImage(i._canvas,0,0,i.getWidth()/h,i.getHeight()/h),l=r.getImageData(0,0,s.getWidth(),s.getHeight()),o=0;o<a;o++)c=e[o],typeof c=="string"&&(c=Ko(c)),c.call(this,l),r.putImageData(l,0,0)}catch(u){F.error("Unable to apply filter. "+u.message+" This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.")}return this._filterUpToDate=!0,s}on(e,t){if(this._cache&&this._cache.delete(Cn),arguments.length===3)return this._delegate.apply(this,arguments);const i=e.split(In);for(let s=0;s<i.length;s++){const a=i[s].split("."),l=a[0],o=a[1]||"";this.eventListeners[l]||(this.eventListeners[l]=[]),this.eventListeners[l].push({name:o,handler:t})}return this}off(e,t){let i=(e||"").split(In),s=i.length,r,a,l,o,c,d;if(this._cache&&this._cache.delete(Cn),!e)for(a in this.eventListeners)this._off(a);for(r=0;r<s;r++)if(l=i[r],o=l.split("."),c=o[0],d=o[1],c)this.eventListeners[c]&&this._off(c,d,t);else for(a in this.eventListeners)this._off(a,d,t);return this}dispatchEvent(e){const t={target:this,type:e.type,evt:e};return this.fire(e.type,t),this}addEventListener(e,t){return this.on(e,function(i){t.call(this,i.evt)}),this}removeEventListener(e){return this.off(e),this}_delegate(e,t,i){const s=this;this.on(e,function(r){const a=r.target.findAncestors(t,!0,s);for(let l=0;l<a.length;l++)r=F.cloneObject(r),r.currentTarget=a[l],i.call(a[l],r)})}remove(){return this.isDragging()&&this.stopDrag(),Re._dragElements.delete(this._id),this._remove(),this}_clearCaches(){this._clearSelfAndDescendantCache(ht),this._clearSelfAndDescendantCache(On),this._clearSelfAndDescendantCache(as),this._clearSelfAndDescendantCache(cs),this._clearSelfAndDescendantCache(xi),this._clearSelfAndDescendantCache(_i)}_remove(){this._clearCaches();const e=this.getParent();e&&e.children&&(e.children.splice(this.index,1),e._setChildrenIndices(),this.parent=null)}destroy(){return this.remove(),this.clearCache(),this}getAttr(e){const t="get"+F._capitalize(e);return F._isFunction(this[t])?this[t]():this.attrs[e]}getAncestors(){let e=this.getParent(),t=[];for(;e;)t.push(e),e=e.getParent();return t}getAttrs(){return this.attrs||{}}setAttrs(e){return this._batchTransformChanges(()=>{let t,i;if(!e)return this;for(t in e)t!==Zo&&(i=ls+F._capitalize(t),F._isFunction(this[i])?this[i](e[t]):this._setAttr(t,e[t]))}),this}isListening(){return this._getCache(_i,this._isListening)}_isListening(e){if(!this.listening())return!1;const i=this.getParent();return i&&i!==e&&this!==e?i._isListening(e):!0}isVisible(){return this._getCache(xi,this._isVisible)}_isVisible(e){if(!this.visible())return!1;const i=this.getParent();return i&&i!==e&&this!==e?i._isVisible(e):!0}shouldDrawHit(e,t=!1){if(e)return this._isVisible(e)&&this._isListening(e);const i=this.getLayer();let s=!1;Re._dragElements.forEach(a=>{a.dragStatus==="dragging"&&(a.node.nodeType==="Stage"||a.node.getLayer()===i)&&(s=!0)});const r=!t&&!le.hitOnDragEnabled&&(s||le.isTransforming());return this.isListening()&&this.isVisible()&&!r}show(){return this.visible(!0),this}hide(){return this.visible(!1),this}getZIndex(){return this.index||0}getAbsoluteZIndex(){let e=this.getDepth(),t=this,i=0,s,r,a,l;function o(d){for(s=[],r=d.length,a=0;a<r;a++)l=d[a],i++,l.nodeType!==os&&(s=s.concat(l.getChildren().slice())),l._id===t._id&&(a=r);s.length>0&&s[0].getDepth()<=e&&o(s)}const c=this.getStage();return t.nodeType!==lc&&c&&o(c.getChildren()),i}getDepth(){let e=0,t=this.parent;for(;t;)e++,t=t.parent;return e}_batchTransformChanges(e){this._batchingTransformChange=!0,e(),this._batchingTransformChange=!1,this._needClearTransformCache&&(this._clearCache(yt),this._clearSelfAndDescendantCache(ht)),this._needClearTransformCache=!1}setPosition(e){return this._batchTransformChanges(()=>{this.x(e.x),this.y(e.y)}),this}getPosition(){return{x:this.x(),y:this.y()}}getRelativePointerPosition(){const e=this.getStage();if(!e)return null;const t=e.getPointerPosition();if(!t)return null;const i=this.getAbsoluteTransform().copy();return i.invert(),i.point(t)}getAbsolutePosition(e){let t=!1,i=this.parent;for(;i;){if(i.isCached()){t=!0;break}i=i.parent}t&&!e&&(e=!0);const s=this.getAbsoluteTransform(e).getMatrix(),r=new Ke,a=this.offset();return r.m=s.slice(),r.translate(a.x,a.y),r.getTranslation()}setAbsolutePosition(e){const{x:t,y:i,...s}=this._clearTransform();this.attrs.x=t,this.attrs.y=i,this._clearCache(yt);const r=this._getAbsoluteTransform().copy();return r.invert(),r.translate(e.x,e.y),e={x:this.attrs.x+r.getTranslation().x,y:this.attrs.y+r.getTranslation().y},this._setTransform(s),this.setPosition({x:e.x,y:e.y}),this._clearCache(yt),this._clearSelfAndDescendantCache(ht),this}_setTransform(e){let t;for(t in e)this.attrs[t]=e[t]}_clearTransform(){const e={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,e}move(e){let t=e.x,i=e.y,s=this.x(),r=this.y();return t!==void 0&&(s+=t),i!==void 0&&(r+=i),this.setPosition({x:s,y:r}),this}_eachAncestorReverse(e,t){let i=[],s=this.getParent(),r,a;if(!(t&&t._id===this._id)){for(i.unshift(this);s&&(!t||s._id!==t._id);)i.unshift(s),s=s.parent;for(r=i.length,a=0;a<r;a++)e(i[a])}}rotate(e){return this.rotation(this.rotation()+e),this}moveToTop(){if(!this.parent)return F.warn("Node has no parent. moveToTop function is ignored."),!1;const e=this.index,t=this.parent.getChildren().length;return e<t-1?(this.parent.children.splice(e,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0):!1}moveUp(){if(!this.parent)return F.warn("Node has no parent. moveUp function is ignored."),!1;const e=this.index,t=this.parent.getChildren().length;return e<t-1?(this.parent.children.splice(e,1),this.parent.children.splice(e+1,0,this),this.parent._setChildrenIndices(),!0):!1}moveDown(){if(!this.parent)return F.warn("Node has no parent. moveDown function is ignored."),!1;const e=this.index;return e>0?(this.parent.children.splice(e,1),this.parent.children.splice(e-1,0,this),this.parent._setChildrenIndices(),!0):!1}moveToBottom(){if(!this.parent)return F.warn("Node has no parent. moveToBottom function is ignored."),!1;const e=this.index;return e>0?(this.parent.children.splice(e,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0):!1}setZIndex(e){if(!this.parent)return F.warn("Node has no parent. zIndex parameter is ignored."),this;(e<0||e>=this.parent.children.length)&&F.warn("Unexpected value "+e+" for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to "+(this.parent.children.length-1)+".");const t=this.index;return this.parent.children.splice(t,1),this.parent.children.splice(e,0,this),this.parent._setChildrenIndices(),this}getAbsoluteOpacity(){return this._getCache(On,this._getAbsoluteOpacity)}_getAbsoluteOpacity(){let e=this.opacity();const t=this.getParent();return t&&!t._isUnderCache&&(e*=t.getAbsoluteOpacity()),e}moveTo(e){return this.getParent()!==e&&(this._remove(),e.add(this)),this}toObject(){let e=this.getAttrs(),t,i,s,r,a;const l={attrs:{},className:this.getClassName()};for(t in e)i=e[t],a=F.isObject(i)&&!F._isPlainObject(i)&&!F._isArray(i),!a&&(s=typeof this[t]=="function"&&this[t],delete e[t],r=s?s.call(this):null,e[t]=i,r!==i&&(l.attrs[t]=i));return F._prepareToStringify(l)}toJSON(){return JSON.stringify(this.toObject())}getParent(){return this.parent}findAncestors(e,t,i){const s=[];t&&this._isMatch(e)&&s.push(this);let r=this.parent;for(;r;){if(r===i)return s;r._isMatch(e)&&s.push(r),r=r.parent}return s}isAncestorOf(e){return!1}findAncestor(e,t,i){return this.findAncestors(e,t,i)[0]}_isMatch(e){if(!e)return!1;if(typeof e=="function")return e(this);let t=e.replace(/ /g,"").split(","),i=t.length,s,r;for(s=0;s<i;s++)if(r=t[s],F.isValidSelector(r)||(F.warn('Selector "'+r+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),F.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),F.warn("Konva is awesome, right?")),r.charAt(0)==="#"){if(this.id()===r.slice(1))return!0}else if(r.charAt(0)==="."){if(this.hasName(r.slice(1)))return!0}else if(this.className===r||this.nodeType===r)return!0;return!1}getLayer(){const e=this.getParent();return e?e.getLayer():null}getStage(){return this._getCache(cs,this._getStage)}_getStage(){const e=this.getParent();return e?e.getStage():null}fire(e,t={},i){return t.target=t.target||this,i?this._fireAndBubble(e,t):this._fire(e,t),this}getAbsoluteTransform(e){return e?this._getAbsoluteTransform(e):this._getCache(ht,this._getAbsoluteTransform)}_getAbsoluteTransform(e){let t;if(e)return t=new Ke,this._eachAncestorReverse(function(i){const s=i.transformsEnabled();s==="all"?t.multiply(i.getTransform()):s==="position"&&t.translate(i.x()-i.offsetX(),i.y()-i.offsetY())},e),t;{t=this._cache.get(ht)||new Ke,this.parent?this.parent.getAbsoluteTransform().copyInto(t):t.reset();const i=this.transformsEnabled();if(i==="all")t.multiply(this.getTransform());else if(i==="position"){const s=this.attrs.x||0,r=this.attrs.y||0,a=this.attrs.offsetX||0,l=this.attrs.offsetY||0;t.translate(s-a,r-l)}return t.dirty=!1,t}}getAbsoluteScale(e){let t=this;for(;t;)t._isUnderCache&&(e=t),t=t.getParent();const s=this.getAbsoluteTransform(e).decompose();return{x:s.scaleX,y:s.scaleY}}getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation}getTransform(){return this._getCache(yt,this._getTransform)}_getTransform(){var e,t;const i=this._cache.get(yt)||new Ke;i.reset();const s=this.x(),r=this.y(),a=le.getAngle(this.rotation()),l=(e=this.attrs.scaleX)!==null&&e!==void 0?e:1,o=(t=this.attrs.scaleY)!==null&&t!==void 0?t:1,c=this.attrs.skewX||0,d=this.attrs.skewY||0,h=this.attrs.offsetX||0,u=this.attrs.offsetY||0;return(s!==0||r!==0)&&i.translate(s,r),a!==0&&i.rotate(a),(c!==0||d!==0)&&i.skew(c,d),(l!==1||o!==1)&&i.scale(l,o),(h!==0||u!==0)&&i.translate(-1*h,-1*u),i.dirty=!1,i}clone(e){let t=F.cloneObject(this.attrs),i,s,r,a,l;for(i in e)t[i]=e[i];const o=new this.constructor(t);for(i in this.eventListeners)for(s=this.eventListeners[i],r=s.length,a=0;a<r;a++)l=s[a],l.name.indexOf(ec)<0&&(o.eventListeners[i]||(o.eventListeners[i]=[]),o.eventListeners[i].push(l));return o}_toKonvaCanvas(e){e=e||{};const t=this.getClientRect(),i=this.getStage(),s=e.x!==void 0?e.x:Math.floor(t.x),r=e.y!==void 0?e.y:Math.floor(t.y),a=e.pixelRatio||1,l=new St({width:e.width||Math.ceil(t.width)||(i?i.width():0),height:e.height||Math.ceil(t.height)||(i?i.height():0),pixelRatio:a}),o=l.getContext(),c=new St({width:l.width/l.pixelRatio+Math.abs(s),height:l.height/l.pixelRatio+Math.abs(r),pixelRatio:l.pixelRatio});return e.imageSmoothingEnabled===!1&&(o._context.imageSmoothingEnabled=!1),o.save(),(s||r)&&o.translate(-1*s,-1*r),this.drawScene(l,void 0,c),o.restore(),l}toCanvas(e){return this._toKonvaCanvas(e)._canvas}toDataURL(e){e=e||{};const t=e.mimeType||null,i=e.quality||null,s=this._toKonvaCanvas(e).toDataURL(t,i);return e.callback&&e.callback(s),s}toImage(e){return new Promise((t,i)=>{try{const s=e?.callback;s&&delete e.callback,F._urlToImage(this.toDataURL(e),function(r){t(r),s?.(r)})}catch(s){i(s)}})}toBlob(e){return new Promise((t,i)=>{try{const s=e?.callback;s&&delete e.callback,this.toCanvas(e).toBlob(r=>{t(r),s?.(r)},e?.mimeType,e?.quality)}catch(s){i(s)}})}setSize(e){return this.width(e.width),this.height(e.height),this}getSize(){return{width:this.width(),height:this.height()}}getClassName(){return this.className||this.nodeType}getType(){return this.nodeType}getDragDistance(){return this.attrs.dragDistance!==void 0?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():le.dragDistance}_off(e,t,i){let s=this.eventListeners[e],r,a,l;for(r=0;r<s.length;r++)if(a=s[r].name,l=s[r].handler,(a!=="konva"||t==="konva")&&(!t||a===t)&&(!i||i===l)){if(s.splice(r,1),s.length===0){delete this.eventListeners[e];break}r--}}_fireChangeEvent(e,t,i){this._fire(e+Jo,{oldVal:t,newVal:i})}addName(e){if(!this.hasName(e)){const t=this.name(),i=t?t+" "+e:e;this.name(i)}return this}hasName(e){if(!e)return!1;const t=this.name();return t?(t||"").split(/\s/g).indexOf(e)!==-1:!1}removeName(e){const t=(this.name()||"").split(/\s/g),i=t.indexOf(e);return i!==-1&&(t.splice(i,1),this.name(t.join(" "))),this}setAttr(e,t){const i=this[ls+F._capitalize(e)];return F._isFunction(i)?i.call(this,t):this._setAttr(e,t),this}_requestDraw(){if(le.autoDrawEnabled){const e=this.getLayer()||this.getStage();e?.batchDraw()}}_setAttr(e,t){const i=this.attrs[e];i===t&&!F.isObject(t)||(t==null?delete this.attrs[e]:this.attrs[e]=t,this._shouldFireChangeEvents&&this._fireChangeEvent(e,i,t),this._requestDraw())}_setComponentAttr(e,t,i){let s;i!==void 0&&(s=this.attrs[e],s||(this.attrs[e]=this.getAttr(e)),this.attrs[e][t]=i,this._fireChangeEvent(e,s,i))}_fireAndBubble(e,t,i){t&&this.nodeType===os&&(t.target=this);const s=[tc,nc,ic,sc,rc,ac];if(!(s.indexOf(e)!==-1&&(i&&(this===i||this.isAncestorOf&&this.isAncestorOf(i))||this.nodeType==="Stage"&&!i))){this._fire(e,t);const a=s.indexOf(e)!==-1&&i&&i.isAncestorOf&&i.isAncestorOf(this)&&!i.isAncestorOf(this.parent);(t&&!t.cancelBubble||!t)&&this.parent&&this.parent.isListening()&&!a&&(i&&i.parent?this._fireAndBubble.call(this.parent,e,t,i):this._fireAndBubble.call(this.parent,e,t))}}_getProtoListeners(e){var t,i,s;const r=(t=this._cache.get(Cn))!==null&&t!==void 0?t:{};let a=r?.[e];if(a===void 0){a=[];let l=Object.getPrototypeOf(this);for(;l;){const o=(s=(i=l.eventListeners)===null||i===void 0?void 0:i[e])!==null&&s!==void 0?s:[];a.push(...o),l=Object.getPrototypeOf(l)}r[e]=a,this._cache.set(Cn,r)}return a}_fire(e,t){t=t||{},t.currentTarget=this,t.type=e;const i=this._getProtoListeners(e);if(i)for(let r=0;r<i.length;r++)i[r].handler.call(this,t);const s=this.eventListeners[e];if(s)for(let r=0;r<s.length;r++)s[r].handler.call(this,t)}draw(){return this.drawScene(),this.drawHit(),this}_createDragElement(e){const t=e?e.pointerId:void 0,i=this.getStage(),s=this.getAbsolutePosition();if(!i)return;const r=i._getPointerById(t)||i._changedPointerPositions[0]||s;Re._dragElements.set(this._id,{node:this,startPointerPos:r,offset:{x:r.x-s.x,y:r.y-s.y},dragStatus:"ready",pointerId:t})}startDrag(e,t=!0){Re._dragElements.has(this._id)||this._createDragElement(e);const i=Re._dragElements.get(this._id);i.dragStatus="dragging",this.fire("dragstart",{type:"dragstart",target:this,evt:e&&e.evt},t)}_setDragPosition(e,t){const i=this.getStage()._getPointerById(t.pointerId);if(!i)return;let s={x:i.x-t.offset.x,y:i.y-t.offset.y};const r=this.dragBoundFunc();if(r!==void 0){const a=r.call(this,s,e);a?s=a:F.warn("dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.")}(!this._lastPos||this._lastPos.x!==s.x||this._lastPos.y!==s.y)&&(this.setAbsolutePosition(s),this._requestDraw()),this._lastPos=s}stopDrag(e){const t=Re._dragElements.get(this._id);t&&(t.dragStatus="stopped"),Re._endDragBefore(e),Re._endDragAfter(e)}setDraggable(e){this._setAttr("draggable",e),this._dragChange()}isDragging(){const e=Re._dragElements.get(this._id);return e?e.dragStatus==="dragging":!1}_listenDrag(){this._dragCleanup(),this.on("mousedown.konva touchstart.konva",function(e){if(!(!(e.evt.button!==void 0)||le.dragButtons.indexOf(e.evt.button)>=0)||this.isDragging())return;let s=!1;Re._dragElements.forEach(r=>{this.isAncestorOf(r.node)&&(s=!0)}),s||this._createDragElement(e)})}_dragChange(){if(this.attrs.draggable)this._listenDrag();else{if(this._dragCleanup(),!this.getStage())return;const t=Re._dragElements.get(this._id),i=t&&t.dragStatus==="dragging",s=t&&t.dragStatus==="ready";i?this.stopDrag():s&&Re._dragElements.delete(this._id)}}_dragCleanup(){this.off("mousedown.konva"),this.off("touchstart.konva")}isClientRectOnScreen(e={x:0,y:0}){const t=this.getStage();if(!t)return!1;const i={x:-e.x,y:-e.y,width:t.width()+2*e.x,height:t.height()+2*e.y};return F.haveIntersection(i,this.getClientRect())}static create(e,t){return F._isString(e)&&(e=JSON.parse(e)),this._createNode(e,t)}static _createNode(e,t){let i=ie.prototype.getClassName.call(e),s=e.children,r,a,l;t&&(e.attrs.container=t),le[i]||(F.warn('Can not find a node with class name "'+i+'". Fallback to "Shape".'),i="Shape");const o=le[i];if(r=new o(e.attrs),s)for(a=s.length,l=0;l<a;l++)r.add(ie._createNode(s[l]));return r}}ie.prototype.nodeType="Node";ie.prototype._attrsAffectingSize=[];ie.prototype.eventListeners={};ie.prototype.on.call(ie.prototype,oc,function(){if(this._batchingTransformChange){this._needClearTransformCache=!0;return}this._clearCache(yt),this._clearSelfAndDescendantCache(ht)});ie.prototype.on.call(ie.prototype,"visibleChange.konva",function(){this._clearSelfAndDescendantCache(xi)});ie.prototype.on.call(ie.prototype,"listeningChange.konva",function(){this._clearSelfAndDescendantCache(_i)});ie.prototype.on.call(ie.prototype,"opacityChange.konva",function(){this._clearSelfAndDescendantCache(On)});const Oe=k.addGetterSetter;Oe(ie,"zIndex");Oe(ie,"absolutePosition");Oe(ie,"position");Oe(ie,"x",0,re());Oe(ie,"y",0,re());Oe(ie,"globalCompositeOperation","source-over",Ot());Oe(ie,"opacity",1,re());Oe(ie,"name","",Ot());Oe(ie,"id","",Ot());Oe(ie,"rotation",0,re());k.addComponentsGetterSetter(ie,"scale",["x","y"]);Oe(ie,"scaleX",1,re());Oe(ie,"scaleY",1,re());k.addComponentsGetterSetter(ie,"skew",["x","y"]);Oe(ie,"skewX",0,re());Oe(ie,"skewY",0,re());k.addComponentsGetterSetter(ie,"offset",["x","y"]);Oe(ie,"offsetX",0,re());Oe(ie,"offsetY",0,re());Oe(ie,"dragDistance",void 0,re());Oe(ie,"width",0,re());Oe(ie,"height",0,re());Oe(ie,"listening",!0,at());Oe(ie,"preventDefault",!0,at());Oe(ie,"filters",void 0,function(n){return this._filterUpToDate=!1,n});Oe(ie,"visible",!0,at());Oe(ie,"transformsEnabled","all",Ot());Oe(ie,"size");Oe(ie,"dragBoundFunc");Oe(ie,"draggable",!1,at());k.backCompat(ie,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"});class Ze extends ie{constructor(){super(...arguments),this.children=[]}getChildren(e){const t=this.children||[];return e?t.filter(e):t}hasChildren(){return this.getChildren().length>0}removeChildren(){return this.getChildren().forEach(e=>{e.parent=null,e.index=0,e.remove()}),this.children=[],this._requestDraw(),this}destroyChildren(){return this.getChildren().forEach(e=>{e.parent=null,e.index=0,e.destroy()}),this.children=[],this._requestDraw(),this}add(...e){if(e.length===0)return this;if(e.length>1){for(let i=0;i<e.length;i++)this.add(e[i]);return this}const t=e[0];return t.getParent()?(t.moveTo(this),this):(this._validateAdd(t),t.index=this.getChildren().length,t.parent=this,t._clearCaches(),this.getChildren().push(t),this._fire("add",{child:t}),this._requestDraw(),this)}destroy(){return this.hasChildren()&&this.destroyChildren(),super.destroy(),this}find(e){return this._generalFind(e,!1)}findOne(e){const t=this._generalFind(e,!0);return t.length>0?t[0]:void 0}_generalFind(e,t){const i=[];return this._descendants(s=>{const r=s._isMatch(e);return r&&i.push(s),!!(r&&t)}),i}_descendants(e){let t=!1;const i=this.getChildren();for(const s of i){if(t=e(s),t)return!0;if(s.hasChildren()&&(t=s._descendants(e),t))return!0}return!1}toObject(){const e=ie.prototype.toObject.call(this);return e.children=[],this.getChildren().forEach(t=>{e.children.push(t.toObject())}),e}isAncestorOf(e){let t=e.getParent();for(;t;){if(t._id===this._id)return!0;t=t.getParent()}return!1}clone(e){const t=ie.prototype.clone.call(this,e);return this.getChildren().forEach(function(i){t.add(i.clone())}),t}getAllIntersections(e){const t=[];return this.find("Shape").forEach(i=>{i.isVisible()&&i.intersects(e)&&t.push(i)}),t}_clearSelfAndDescendantCache(e){var t;super._clearSelfAndDescendantCache(e),!this.isCached()&&((t=this.children)===null||t===void 0||t.forEach(function(i){i._clearSelfAndDescendantCache(e)}))}_setChildrenIndices(){var e;(e=this.children)===null||e===void 0||e.forEach(function(t,i){t.index=i}),this._requestDraw()}drawScene(e,t,i){const s=this.getLayer(),r=e||s&&s.getCanvas(),a=r&&r.getContext(),l=this._getCanvasCache(),o=l&&l.scene,c=r&&r.isCache;if(!this.isVisible()&&!c)return this;if(o){a.save();const d=this.getAbsoluteTransform(t).getMatrix();a.transform(d[0],d[1],d[2],d[3],d[4],d[5]),this._drawCachedSceneCanvas(a),a.restore()}else this._drawChildren("drawScene",r,t,i);return this}drawHit(e,t){if(!this.shouldDrawHit(t))return this;const i=this.getLayer(),s=e||i&&i.hitCanvas,r=s&&s.getContext(),a=this._getCanvasCache();if(a&&a.hit){r.save();const o=this.getAbsoluteTransform(t).getMatrix();r.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this._drawCachedHitCanvas(r),r.restore()}else this._drawChildren("drawHit",s,t);return this}_drawChildren(e,t,i,s){var r;const a=t&&t.getContext(),l=this.clipWidth(),o=this.clipHeight(),c=this.clipFunc(),d=typeof l=="number"&&typeof o=="number"||c,h=i===this;if(d){a.save();const v=this.getAbsoluteTransform(i);let f=v.getMatrix();a.transform(f[0],f[1],f[2],f[3],f[4],f[5]),a.beginPath();let p;if(c)p=c.call(this,a,this);else{const b=this.clipX(),m=this.clipY();a.rect(b||0,m||0,l,o)}a.clip.apply(a,p),f=v.copy().invert().getMatrix(),a.transform(f[0],f[1],f[2],f[3],f[4],f[5])}const u=!h&&this.globalCompositeOperation()!=="source-over"&&e==="drawScene";u&&(a.save(),a._applyGlobalCompositeOperation(this)),(r=this.children)===null||r===void 0||r.forEach(function(v){v[e](t,i,s)}),u&&a.restore(),d&&a.restore()}getClientRect(e={}){var t;const i=e.skipTransform,s=e.relativeTo;let r,a,l,o,c={x:1/0,y:1/0,width:0,height:0};const d=this;(t=this.children)===null||t===void 0||t.forEach(function(v){if(!v.visible())return;const f=v.getClientRect({relativeTo:d,skipShadow:e.skipShadow,skipStroke:e.skipStroke});f.width===0&&f.height===0||(r===void 0?(r=f.x,a=f.y,l=f.x+f.width,o=f.y+f.height):(r=Math.min(r,f.x),a=Math.min(a,f.y),l=Math.max(l,f.x+f.width),o=Math.max(o,f.y+f.height)))});const h=this.find("Shape");let u=!1;for(let v=0;v<h.length;v++)if(h[v]._isVisible(this)){u=!0;break}return u&&r!==void 0?c={x:r,y:a,width:l-r,height:o-a}:c={x:0,y:0,width:0,height:0},i?c:this._transformedRect(c,s)}}k.addComponentsGetterSetter(Ze,"clip",["x","y","width","height"]);k.addGetterSetter(Ze,"clipX",void 0,re());k.addGetterSetter(Ze,"clipY",void 0,re());k.addGetterSetter(Ze,"clipWidth",void 0,re());k.addGetterSetter(Ze,"clipHeight",void 0,re());k.addGetterSetter(Ze,"clipFunc");const pn=new Map,rr=le._global.PointerEvent!==void 0;function li(n){return pn.get(n)}function Oi(n){return{evt:n,pointerId:n.pointerId}}function ar(n,e){return pn.get(n)===e}function lr(n,e){cn(n),e.getStage()&&(pn.set(n,e),rr&&e._fire("gotpointercapture",Oi(new PointerEvent("gotpointercapture"))))}function cn(n,e){const t=pn.get(n);if(!t)return;const i=t.getStage();i&&i.content,pn.delete(n),rr&&t._fire("lostpointercapture",Oi(new PointerEvent("lostpointercapture")))}const dc="Stage",hc="string",ds="px",uc="mouseout",or="mouseleave",cr="mouseover",dr="mouseenter",hr="mousemove",ur="mousedown",gr="mouseup",sn="pointermove",rn="pointerdown",Wt="pointerup",an="pointercancel",gc="lostpointercapture",kn="pointerout",ln="pointerleave",Tn="pointerover",En="pointerenter",Si="contextmenu",fr="touchstart",vr="touchend",pr="touchmove",mr="touchcancel",wi="wheel",fc=5,vc=[[dr,"_pointerenter"],[ur,"_pointerdown"],[hr,"_pointermove"],[gr,"_pointerup"],[or,"_pointerleave"],[fr,"_pointerdown"],[pr,"_pointermove"],[vr,"_pointerup"],[mr,"_pointercancel"],[cr,"_pointerover"],[wi,"_wheel"],[Si,"_contextmenu"],[rn,"_pointerdown"],[sn,"_pointermove"],[Wt,"_pointerup"],[an,"_pointercancel"],[ln,"_pointerleave"],[gc,"_lostpointercapture"]],oi={mouse:{[kn]:uc,[ln]:or,[Tn]:cr,[En]:dr,[sn]:hr,[rn]:ur,[Wt]:gr,[an]:"mousecancel",pointerclick:"click",pointerdblclick:"dblclick"},touch:{[kn]:"touchout",[ln]:"touchleave",[Tn]:"touchover",[En]:"touchenter",[sn]:pr,[rn]:fr,[Wt]:vr,[an]:mr,pointerclick:"tap",pointerdblclick:"dbltap"},pointer:{[kn]:kn,[ln]:ln,[Tn]:Tn,[En]:En,[sn]:sn,[rn]:rn,[Wt]:Wt,[an]:an,pointerclick:"pointerclick",pointerdblclick:"pointerdblclick"}},on=n=>n.indexOf("pointer")>=0?"pointer":n.indexOf("touch")>=0?"touch":"mouse",Bt=n=>{const e=on(n);if(e==="pointer")return le.pointerEventsEnabled&&oi.pointer;if(e==="touch")return oi.touch;if(e==="mouse")return oi.mouse};function hs(n={}){return(n.clipFunc||n.clipWidth||n.clipHeight)&&F.warn("Stage does not support clipping. Please use clip for Layers or Groups."),n}const pc="Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);",dn=[];class Jn extends Ze{constructor(e){super(hs(e)),this._pointerPositions=[],this._changedPointerPositions=[],this._buildDOM(),this._bindContentEvents(),dn.push(this),this.on("widthChange.konva heightChange.konva",this._resizeDOM),this.on("visibleChange.konva",this._checkVisibility),this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",()=>{hs(this.attrs)}),this._checkVisibility()}_validateAdd(e){const t=e.getType()==="Layer",i=e.getType()==="FastLayer";t||i||F.throw("You may only add layers to the stage.")}_checkVisibility(){if(!this.content)return;const e=this.visible()?"":"none";this.content.style.display=e}setContainer(e){if(typeof e===hc){let t;if(e.charAt(0)==="."){const i=e.slice(1);e=document.getElementsByClassName(i)[0]}else e.charAt(0)!=="#"?t=e:t=e.slice(1),e=document.getElementById(t);if(!e)throw"Can not find container in document with id "+t}return this._setAttr("container",e),this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),e.appendChild(this.content)),this}shouldDrawHit(){return!0}clear(){const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].clear();return this}clone(e){return e||(e={}),e.container=typeof document<"u"&&document.createElement("div"),Ze.prototype.clone.call(this,e)}destroy(){super.destroy();const e=this.content;e&&F._isInDocument(e)&&this.container().removeChild(e);const t=dn.indexOf(this);return t>-1&&dn.splice(t,1),F.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas),this}getPointerPosition(){const e=this._pointerPositions[0]||this._changedPointerPositions[0];return e?{x:e.x,y:e.y}:(F.warn(pc),null)}_getPointerById(e){return this._pointerPositions.find(t=>t.id===e)}getPointersPositions(){return this._pointerPositions}getStage(){return this}getContent(){return this.content}_toKonvaCanvas(e){e={...e},e.x=e.x||0,e.y=e.y||0,e.width=e.width||this.width(),e.height=e.height||this.height();const t=new St({width:e.width,height:e.height,pixelRatio:e.pixelRatio||1}),i=t.getContext()._context,s=this.children;return(e.x||e.y)&&i.translate(-1*e.x,-1*e.y),s.forEach(function(r){if(!r.isVisible())return;const a=r._toKonvaCanvas(e);i.drawImage(a._canvas,e.x,e.y,a.getWidth()/a.getPixelRatio(),a.getHeight()/a.getPixelRatio())}),t}getIntersection(e){if(!e)return null;const t=this.children,i=t.length,s=i-1;for(let r=s;r>=0;r--){const a=t[r].getIntersection(e);if(a)return a}return null}_resizeDOM(){const e=this.width(),t=this.height();this.content&&(this.content.style.width=e+ds,this.content.style.height=t+ds),this.bufferCanvas.setSize(e,t),this.bufferHitCanvas.setSize(e,t),this.children.forEach(i=>{i.setSize({width:e,height:t}),i.draw()})}add(e,...t){if(arguments.length>1){for(let s=0;s<arguments.length;s++)this.add(arguments[s]);return this}super.add(e);const i=this.children.length;return i>fc&&F.warn("The stage has "+i+" layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group."),e.setSize({width:this.width(),height:this.height()}),e.draw(),le.isBrowser&&this.content.appendChild(e.canvas._canvas),this}getParent(){return null}getLayer(){return null}hasPointerCapture(e){return ar(e,this)}setPointerCapture(e){lr(e,this)}releaseCapture(e){cn(e)}getLayers(){return this.children}_bindContentEvents(){le.isBrowser&&vc.forEach(([e,t])=>{this.content.addEventListener(e,i=>{this[t](i)},{passive:!1})})}_pointerenter(e){this.setPointersPositions(e);const t=Bt(e.type);t&&this._fire(t.pointerenter,{evt:e,target:this,currentTarget:this})}_pointerover(e){this.setPointersPositions(e);const t=Bt(e.type);t&&this._fire(t.pointerover,{evt:e,target:this,currentTarget:this})}_getTargetShape(e){let t=this[e+"targetShape"];return t&&!t.getStage()&&(t=null),t}_pointerleave(e){const t=Bt(e.type),i=on(e.type);if(!t)return;this.setPointersPositions(e);const s=this._getTargetShape(i),r=!(le.isDragging()||le.isTransforming())||le.hitOnDragEnabled;s&&r?(s._fireAndBubble(t.pointerout,{evt:e}),s._fireAndBubble(t.pointerleave,{evt:e}),this._fire(t.pointerleave,{evt:e,target:this,currentTarget:this}),this[i+"targetShape"]=null):r&&(this._fire(t.pointerleave,{evt:e,target:this,currentTarget:this}),this._fire(t.pointerout,{evt:e,target:this,currentTarget:this})),this.pointerPos=null,this._pointerPositions=[]}_pointerdown(e){const t=Bt(e.type),i=on(e.type);if(!t)return;this.setPointersPositions(e);let s=!1;this._changedPointerPositions.forEach(r=>{const a=this.getIntersection(r);if(Re.justDragged=!1,le["_"+i+"ListenClick"]=!0,!a||!a.isListening()){this[i+"ClickStartShape"]=void 0;return}le.capturePointerEventsEnabled&&a.setPointerCapture(r.id),this[i+"ClickStartShape"]=a,a._fireAndBubble(t.pointerdown,{evt:e,pointerId:r.id}),s=!0;const l=e.type.indexOf("touch")>=0;a.preventDefault()&&e.cancelable&&l&&e.preventDefault()}),s||this._fire(t.pointerdown,{evt:e,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id})}_pointermove(e){const t=Bt(e.type),i=on(e.type);if(!t)return;const s=e.type.indexOf("touch")>=0||e.pointerType==="touch";if(le.isDragging()&&Re.node.preventDefault()&&e.cancelable&&s&&e.preventDefault(),this.setPointersPositions(e),!(!(le.isDragging()||le.isTransforming())||le.hitOnDragEnabled))return;const a={};let l=!1;const o=this._getTargetShape(i);this._changedPointerPositions.forEach(c=>{const d=li(c.id)||this.getIntersection(c),h=c.id,u={evt:e,pointerId:h},v=o!==d;if(v&&o&&(o._fireAndBubble(t.pointerout,{...u},d),o._fireAndBubble(t.pointerleave,{...u},d)),d){if(a[d._id])return;a[d._id]=!0}d&&d.isListening()?(l=!0,v&&(d._fireAndBubble(t.pointerover,{...u},o),d._fireAndBubble(t.pointerenter,{...u},o),this[i+"targetShape"]=d),d._fireAndBubble(t.pointermove,{...u})):o&&(this._fire(t.pointerover,{evt:e,target:this,currentTarget:this,pointerId:h}),this[i+"targetShape"]=null)}),l||this._fire(t.pointermove,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id})}_pointerup(e){const t=Bt(e.type),i=on(e.type);if(!t)return;this.setPointersPositions(e);const s=this[i+"ClickStartShape"],r=this[i+"ClickEndShape"],a={};let l=!1;this._changedPointerPositions.forEach(o=>{const c=li(o.id)||this.getIntersection(o);if(c){if(c.releaseCapture(o.id),a[c._id])return;a[c._id]=!0}const d=o.id,h={evt:e,pointerId:d};let u=!1;le["_"+i+"InDblClickWindow"]?(u=!0,clearTimeout(this[i+"DblTimeout"])):Re.justDragged||(le["_"+i+"InDblClickWindow"]=!0,clearTimeout(this[i+"DblTimeout"])),this[i+"DblTimeout"]=setTimeout(function(){le["_"+i+"InDblClickWindow"]=!1},le.dblClickWindow),c&&c.isListening()?(l=!0,this[i+"ClickEndShape"]=c,c._fireAndBubble(t.pointerup,{...h}),le["_"+i+"ListenClick"]&&s&&s===c&&(c._fireAndBubble(t.pointerclick,{...h}),u&&r&&r===c&&c._fireAndBubble(t.pointerdblclick,{...h}))):(this[i+"ClickEndShape"]=null,l||(this._fire(t.pointerup,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),l=!0),le["_"+i+"ListenClick"]&&this._fire(t.pointerclick,{evt:e,target:this,currentTarget:this,pointerId:d}),u&&this._fire(t.pointerdblclick,{evt:e,target:this,currentTarget:this,pointerId:d}))}),l||this._fire(t.pointerup,{evt:e,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),le["_"+i+"ListenClick"]=!1,e.cancelable&&i!=="touch"&&i!=="pointer"&&e.preventDefault()}_contextmenu(e){this.setPointersPositions(e);const t=this.getIntersection(this.getPointerPosition());t&&t.isListening()?t._fireAndBubble(Si,{evt:e}):this._fire(Si,{evt:e,target:this,currentTarget:this})}_wheel(e){this.setPointersPositions(e);const t=this.getIntersection(this.getPointerPosition());t&&t.isListening()?t._fireAndBubble(wi,{evt:e}):this._fire(wi,{evt:e,target:this,currentTarget:this})}_pointercancel(e){this.setPointersPositions(e);const t=li(e.pointerId)||this.getIntersection(this.getPointerPosition());t&&t._fireAndBubble(Wt,Oi(e)),cn(e.pointerId)}_lostpointercapture(e){cn(e.pointerId)}setPointersPositions(e){const t=this._getContentPosition();let i=null,s=null;e=e||window.event,e.touches!==void 0?(this._pointerPositions=[],this._changedPointerPositions=[],Array.prototype.forEach.call(e.touches,r=>{this._pointerPositions.push({id:r.identifier,x:(r.clientX-t.left)/t.scaleX,y:(r.clientY-t.top)/t.scaleY})}),Array.prototype.forEach.call(e.changedTouches||e.touches,r=>{this._changedPointerPositions.push({id:r.identifier,x:(r.clientX-t.left)/t.scaleX,y:(r.clientY-t.top)/t.scaleY})})):(i=(e.clientX-t.left)/t.scaleX,s=(e.clientY-t.top)/t.scaleY,this.pointerPos={x:i,y:s},this._pointerPositions=[{x:i,y:s,id:F._getFirstPointerId(e)}],this._changedPointerPositions=[{x:i,y:s,id:F._getFirstPointerId(e)}])}_setPointerPosition(e){F.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.'),this.setPointersPositions(e)}_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect)return{top:0,left:0,scaleX:1,scaleY:1};const e=this.content.getBoundingClientRect();return{top:e.top,left:e.left,scaleX:e.width/this.content.clientWidth||1,scaleY:e.height/this.content.clientHeight||1}}_buildDOM(){if(this.bufferCanvas=new St({width:this.width(),height:this.height()}),this.bufferHitCanvas=new Mi({pixelRatio:1,width:this.width(),height:this.height()}),!le.isBrowser)return;const e=this.container();if(!e)throw"Stage has no container. A container is required.";e.innerHTML="",this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.userSelect="none",this.content.className="konvajs-content",this.content.setAttribute("role","presentation"),e.appendChild(this.content),this._resizeDOM()}cache(){return F.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes."),this}clearCache(){return this}batchDraw(){return this.getChildren().forEach(function(e){e.batchDraw()}),this}}Jn.prototype.nodeType=dc;Be(Jn);k.addGetterSetter(Jn,"container");le.isBrowser&&document.addEventListener("visibilitychange",()=>{dn.forEach(n=>{n.batchDraw()})});const br="hasShadow",yr="shadowRGBA",_r="patternImage",xr="linearGradient",Sr="radialGradient";let Pn;function ci(){return Pn||(Pn=F.createCanvasElement().getContext("2d"),Pn)}const hn={};function mc(n){const e=this.attrs.fillRule;e?n.fill(e):n.fill()}function bc(n){n.stroke()}function yc(n){const e=this.attrs.fillRule;e?n.fill(e):n.fill()}function _c(n){n.stroke()}function xc(){this._clearCache(br)}function Sc(){this._clearCache(yr)}function wc(){this._clearCache(_r)}function $c(){this._clearCache(xr)}function Cc(){this._clearCache(Sr)}class J extends ie{constructor(e){super(e);let t;for(;t=F.getRandomColor(),!(t&&!(t in hn)););this.colorKey=t,hn[t]=this}getContext(){return F.warn("shape.getContext() method is deprecated. Please do not use it."),this.getLayer().getContext()}getCanvas(){return F.warn("shape.getCanvas() method is deprecated. Please do not use it."),this.getLayer().getCanvas()}getSceneFunc(){return this.attrs.sceneFunc||this._sceneFunc}getHitFunc(){return this.attrs.hitFunc||this._hitFunc}hasShadow(){return this._getCache(br,this._hasShadow)}_hasShadow(){return this.shadowEnabled()&&this.shadowOpacity()!==0&&!!(this.shadowColor()||this.shadowBlur()||this.shadowOffsetX()||this.shadowOffsetY())}_getFillPattern(){return this._getCache(_r,this.__getFillPattern)}__getFillPattern(){if(this.fillPatternImage()){const t=ci().createPattern(this.fillPatternImage(),this.fillPatternRepeat()||"repeat");if(t&&t.setTransform){const i=new Ke;i.translate(this.fillPatternX(),this.fillPatternY()),i.rotate(le.getAngle(this.fillPatternRotation())),i.scale(this.fillPatternScaleX(),this.fillPatternScaleY()),i.translate(-1*this.fillPatternOffsetX(),-1*this.fillPatternOffsetY());const s=i.getMatrix(),r=typeof DOMMatrix>"u"?{a:s[0],b:s[1],c:s[2],d:s[3],e:s[4],f:s[5]}:new DOMMatrix(s);t.setTransform(r)}return t}}_getLinearGradient(){return this._getCache(xr,this.__getLinearGradient)}__getLinearGradient(){const e=this.fillLinearGradientColorStops();if(e){const t=ci(),i=this.fillLinearGradientStartPoint(),s=this.fillLinearGradientEndPoint(),r=t.createLinearGradient(i.x,i.y,s.x,s.y);for(let a=0;a<e.length;a+=2)r.addColorStop(e[a],e[a+1]);return r}}_getRadialGradient(){return this._getCache(Sr,this.__getRadialGradient)}__getRadialGradient(){const e=this.fillRadialGradientColorStops();if(e){const t=ci(),i=this.fillRadialGradientStartPoint(),s=this.fillRadialGradientEndPoint(),r=t.createRadialGradient(i.x,i.y,this.fillRadialGradientStartRadius(),s.x,s.y,this.fillRadialGradientEndRadius());for(let a=0;a<e.length;a+=2)r.addColorStop(e[a],e[a+1]);return r}}getShadowRGBA(){return this._getCache(yr,this._getShadowRGBA)}_getShadowRGBA(){if(!this.hasShadow())return;const e=F.colorToRGBA(this.shadowColor());if(e)return"rgba("+e.r+","+e.g+","+e.b+","+e.a*(this.shadowOpacity()||1)+")"}hasFill(){return this._calculate("hasFill",["fillEnabled","fill","fillPatternImage","fillLinearGradientColorStops","fillRadialGradientColorStops"],()=>this.fillEnabled()&&!!(this.fill()||this.fillPatternImage()||this.fillLinearGradientColorStops()||this.fillRadialGradientColorStops()))}hasStroke(){return this._calculate("hasStroke",["strokeEnabled","strokeWidth","stroke","strokeLinearGradientColorStops"],()=>this.strokeEnabled()&&this.strokeWidth()&&!!(this.stroke()||this.strokeLinearGradientColorStops()))}hasHitStroke(){const e=this.hitStrokeWidth();return e==="auto"?this.hasStroke():this.strokeEnabled()&&!!e}intersects(e){const t=this.getStage();if(!t)return!1;const i=t.bufferHitCanvas;return i.getContext().clear(),this.drawHit(i,void 0,!0),i.context.getImageData(Math.round(e.x),Math.round(e.y),1,1).data[3]>0}destroy(){return ie.prototype.destroy.call(this),delete hn[this.colorKey],delete this.colorKey,this}_useBufferCanvas(e){var t;if(!((t=this.attrs.perfectDrawEnabled)!==null&&t!==void 0?t:!0))return!1;const s=e||this.hasFill(),r=this.hasStroke(),a=this.getAbsoluteOpacity()!==1;if(s&&r&&a)return!0;const l=this.hasShadow(),o=this.shadowForStrokeEnabled();return!!(s&&r&&l&&o)}setStrokeHitEnabled(e){F.warn("strokeHitEnabled property is deprecated. Please use hitStrokeWidth instead."),e?this.hitStrokeWidth("auto"):this.hitStrokeWidth(0)}getStrokeHitEnabled(){return this.hitStrokeWidth()!==0}getSelfRect(){const e=this.size();return{x:this._centroid?-e.width/2:0,y:this._centroid?-e.height/2:0,width:e.width,height:e.height}}getClientRect(e={}){let t=!1,i=this.getParent();for(;i;){if(i.isCached()){t=!0;break}i=i.getParent()}const s=e.skipTransform,r=e.relativeTo||t&&this.getStage()||void 0,a=this.getSelfRect(),o=!e.skipStroke&&this.hasStroke()&&this.strokeWidth()||0,c=a.width+o,d=a.height+o,h=!e.skipShadow&&this.hasShadow(),u=h?this.shadowOffsetX():0,v=h?this.shadowOffsetY():0,f=c+Math.abs(u),p=d+Math.abs(v),b=h&&this.shadowBlur()||0,m=f+b*2,_=p+b*2,w={width:m,height:_,x:-(o/2+b)+Math.min(u,0)+a.x,y:-(o/2+b)+Math.min(v,0)+a.y};return s?w:this._transformedRect(w,r)}drawScene(e,t,i){const s=this.getLayer(),r=e||s.getCanvas(),a=r.getContext(),l=this._getCanvasCache(),o=this.getSceneFunc(),c=this.hasShadow();let d;const h=t===this;if(!this.isVisible()&&!h)return this;if(l){a.save();const u=this.getAbsoluteTransform(t).getMatrix();return a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),this._drawCachedSceneCanvas(a),a.restore(),this}if(!o)return this;if(a.save(),this._useBufferCanvas()){d=this.getStage();const u=i||d.bufferCanvas,v=u.getContext();v.clear(),v.save(),v._applyLineJoin(this),v._applyMiterLimit(this);const f=this.getAbsoluteTransform(t).getMatrix();v.transform(f[0],f[1],f[2],f[3],f[4],f[5]),o.call(this,v,this),v.restore();const p=u.pixelRatio;c&&a._applyShadow(this),a._applyOpacity(this),a._applyGlobalCompositeOperation(this),a.drawImage(u._canvas,u.x||0,u.y||0,u.width/p,u.height/p)}else{if(a._applyLineJoin(this),a._applyMiterLimit(this),!h){const u=this.getAbsoluteTransform(t).getMatrix();a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),a._applyOpacity(this),a._applyGlobalCompositeOperation(this)}c&&a._applyShadow(this),o.call(this,a,this)}return a.restore(),this}drawHit(e,t,i=!1){if(!this.shouldDrawHit(t,i))return this;const s=this.getLayer(),r=e||s.hitCanvas,a=r&&r.getContext(),l=this.hitFunc()||this.sceneFunc(),o=this._getCanvasCache(),c=o&&o.hit;if(this.colorKey||F.warn("Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()"),c){a.save();const h=this.getAbsoluteTransform(t).getMatrix();return a.transform(h[0],h[1],h[2],h[3],h[4],h[5]),this._drawCachedHitCanvas(a),a.restore(),this}if(!l)return this;if(a.save(),a._applyLineJoin(this),a._applyMiterLimit(this),!(this===t)){const h=this.getAbsoluteTransform(t).getMatrix();a.transform(h[0],h[1],h[2],h[3],h[4],h[5])}return l.call(this,a,this),a.restore(),this}drawHitFromCache(e=0){const t=this._getCanvasCache(),i=this._getCachedSceneCanvas(),s=t.hit,r=s.getContext(),a=s.getWidth(),l=s.getHeight();r.clear(),r.drawImage(i._canvas,0,0,a,l);try{const o=r.getImageData(0,0,a,l),c=o.data,d=c.length,h=F._hexToRgb(this.colorKey);for(let u=0;u<d;u+=4)c[u+3]>e?(c[u]=h.r,c[u+1]=h.g,c[u+2]=h.b,c[u+3]=255):c[u+3]=0;r.putImageData(o,0,0)}catch(o){F.error("Unable to draw hit graph from cached scene canvas. "+o.message)}return this}hasPointerCapture(e){return ar(e,this)}setPointerCapture(e){lr(e,this)}releaseCapture(e){cn(e)}}J.prototype._fillFunc=mc;J.prototype._strokeFunc=bc;J.prototype._fillFuncHit=yc;J.prototype._strokeFuncHit=_c;J.prototype._centroid=!1;J.prototype.nodeType="Shape";Be(J);J.prototype.eventListeners={};J.prototype.on.call(J.prototype,"shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",xc);J.prototype.on.call(J.prototype,"shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",Sc);J.prototype.on.call(J.prototype,"fillPriorityChange.konva fillPatternImageChange.konva fillPatternRepeatChange.konva fillPatternScaleXChange.konva fillPatternScaleYChange.konva fillPatternOffsetXChange.konva fillPatternOffsetYChange.konva fillPatternXChange.konva fillPatternYChange.konva fillPatternRotationChange.konva",wc);J.prototype.on.call(J.prototype,"fillPriorityChange.konva fillLinearGradientColorStopsChange.konva fillLinearGradientStartPointXChange.konva fillLinearGradientStartPointYChange.konva fillLinearGradientEndPointXChange.konva fillLinearGradientEndPointYChange.konva",$c);J.prototype.on.call(J.prototype,"fillPriorityChange.konva fillRadialGradientColorStopsChange.konva fillRadialGradientStartPointXChange.konva fillRadialGradientStartPointYChange.konva fillRadialGradientEndPointXChange.konva fillRadialGradientEndPointYChange.konva fillRadialGradientStartRadiusChange.konva fillRadialGradientEndRadiusChange.konva",Cc);k.addGetterSetter(J,"stroke",void 0,sr());k.addGetterSetter(J,"strokeWidth",2,re());k.addGetterSetter(J,"fillAfterStrokeEnabled",!1);k.addGetterSetter(J,"hitStrokeWidth","auto",Di());k.addGetterSetter(J,"strokeHitEnabled",!0,at());k.addGetterSetter(J,"perfectDrawEnabled",!0,at());k.addGetterSetter(J,"shadowForStrokeEnabled",!0,at());k.addGetterSetter(J,"lineJoin");k.addGetterSetter(J,"lineCap");k.addGetterSetter(J,"miterLimit");k.addGetterSetter(J,"sceneFunc");k.addGetterSetter(J,"hitFunc");k.addGetterSetter(J,"dash");k.addGetterSetter(J,"dashOffset",0,re());k.addGetterSetter(J,"shadowColor",void 0,Ot());k.addGetterSetter(J,"shadowBlur",0,re());k.addGetterSetter(J,"shadowOpacity",1,re());k.addComponentsGetterSetter(J,"shadowOffset",["x","y"]);k.addGetterSetter(J,"shadowOffsetX",0,re());k.addGetterSetter(J,"shadowOffsetY",0,re());k.addGetterSetter(J,"fillPatternImage");k.addGetterSetter(J,"fill",void 0,sr());k.addGetterSetter(J,"fillPatternX",0,re());k.addGetterSetter(J,"fillPatternY",0,re());k.addGetterSetter(J,"fillLinearGradientColorStops");k.addGetterSetter(J,"strokeLinearGradientColorStops");k.addGetterSetter(J,"fillRadialGradientStartRadius",0);k.addGetterSetter(J,"fillRadialGradientEndRadius",0);k.addGetterSetter(J,"fillRadialGradientColorStops");k.addGetterSetter(J,"fillPatternRepeat","repeat");k.addGetterSetter(J,"fillEnabled",!0);k.addGetterSetter(J,"strokeEnabled",!0);k.addGetterSetter(J,"shadowEnabled",!0);k.addGetterSetter(J,"dashEnabled",!0);k.addGetterSetter(J,"strokeScaleEnabled",!0);k.addGetterSetter(J,"fillPriority","color");k.addComponentsGetterSetter(J,"fillPatternOffset",["x","y"]);k.addGetterSetter(J,"fillPatternOffsetX",0,re());k.addGetterSetter(J,"fillPatternOffsetY",0,re());k.addComponentsGetterSetter(J,"fillPatternScale",["x","y"]);k.addGetterSetter(J,"fillPatternScaleX",1,re());k.addGetterSetter(J,"fillPatternScaleY",1,re());k.addComponentsGetterSetter(J,"fillLinearGradientStartPoint",["x","y"]);k.addComponentsGetterSetter(J,"strokeLinearGradientStartPoint",["x","y"]);k.addGetterSetter(J,"fillLinearGradientStartPointX",0);k.addGetterSetter(J,"strokeLinearGradientStartPointX",0);k.addGetterSetter(J,"fillLinearGradientStartPointY",0);k.addGetterSetter(J,"strokeLinearGradientStartPointY",0);k.addComponentsGetterSetter(J,"fillLinearGradientEndPoint",["x","y"]);k.addComponentsGetterSetter(J,"strokeLinearGradientEndPoint",["x","y"]);k.addGetterSetter(J,"fillLinearGradientEndPointX",0);k.addGetterSetter(J,"strokeLinearGradientEndPointX",0);k.addGetterSetter(J,"fillLinearGradientEndPointY",0);k.addGetterSetter(J,"strokeLinearGradientEndPointY",0);k.addComponentsGetterSetter(J,"fillRadialGradientStartPoint",["x","y"]);k.addGetterSetter(J,"fillRadialGradientStartPointX",0);k.addGetterSetter(J,"fillRadialGradientStartPointY",0);k.addComponentsGetterSetter(J,"fillRadialGradientEndPoint",["x","y"]);k.addGetterSetter(J,"fillRadialGradientEndPointX",0);k.addGetterSetter(J,"fillRadialGradientEndPointY",0);k.addGetterSetter(J,"fillPatternRotation",0);k.addGetterSetter(J,"fillRule",void 0,Ot());k.backCompat(J,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"});const kc="#",Tc="beforeDraw",Ec="draw",wr=[{x:0,y:0},{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],Pc=wr.length;class It extends Ze{constructor(e){super(e),this.canvas=new St,this.hitCanvas=new Mi({pixelRatio:1}),this._waitingForDraw=!1,this.on("visibleChange.konva",this._checkVisibility),this._checkVisibility(),this.on("imageSmoothingEnabledChange.konva",this._setSmoothEnabled),this._setSmoothEnabled()}createPNGStream(){return this.canvas._canvas.createPNGStream()}getCanvas(){return this.canvas}getNativeCanvasElement(){return this.canvas._canvas}getHitCanvas(){return this.hitCanvas}getContext(){return this.getCanvas().getContext()}clear(e){return this.getContext().clear(e),this.getHitCanvas().getContext().clear(e),this}setZIndex(e){super.setZIndex(e);const t=this.getStage();return t&&t.content&&(t.content.removeChild(this.getNativeCanvasElement()),e<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[e+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement())),this}moveToTop(){ie.prototype.moveToTop.call(this);const e=this.getStage();return e&&e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.appendChild(this.getNativeCanvasElement())),!0}moveUp(){if(!ie.prototype.moveUp.call(this))return!1;const t=this.getStage();return!t||!t.content?!1:(t.content.removeChild(this.getNativeCanvasElement()),this.index<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[this.index+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement()),!0)}moveDown(){if(ie.prototype.moveDown.call(this)){const e=this.getStage();if(e){const t=e.children;e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.insertBefore(this.getNativeCanvasElement(),t[this.index+1].getCanvas()._canvas))}return!0}return!1}moveToBottom(){if(ie.prototype.moveToBottom.call(this)){const e=this.getStage();if(e){const t=e.children;e.content&&(e.content.removeChild(this.getNativeCanvasElement()),e.content.insertBefore(this.getNativeCanvasElement(),t[1].getCanvas()._canvas))}return!0}return!1}getLayer(){return this}remove(){const e=this.getNativeCanvasElement();return ie.prototype.remove.call(this),e&&e.parentNode&&F._isInDocument(e)&&e.parentNode.removeChild(e),this}getStage(){return this.parent}setSize({width:e,height:t}){return this.canvas.setSize(e,t),this.hitCanvas.setSize(e,t),this._setSmoothEnabled(),this}_validateAdd(e){const t=e.getType();t!=="Group"&&t!=="Shape"&&F.throw("You may only add groups and shapes to a layer.")}_toKonvaCanvas(e){return e={...e},e.width=e.width||this.getWidth(),e.height=e.height||this.getHeight(),e.x=e.x!==void 0?e.x:this.x(),e.y=e.y!==void 0?e.y:this.y(),ie.prototype._toKonvaCanvas.call(this,e)}_checkVisibility(){this.visible()?this.canvas._canvas.style.display="block":this.canvas._canvas.style.display="none"}_setSmoothEnabled(){this.getContext()._context.imageSmoothingEnabled=this.imageSmoothingEnabled()}getWidth(){if(this.parent)return this.parent.width()}setWidth(){F.warn('Can not change width of layer. Use "stage.width(value)" function instead.')}getHeight(){if(this.parent)return this.parent.height()}setHeight(){F.warn('Can not change height of layer. Use "stage.height(value)" function instead.')}batchDraw(){return this._waitingForDraw||(this._waitingForDraw=!0,F.requestAnimFrame(()=>{this.draw(),this._waitingForDraw=!1})),this}getIntersection(e){if(!this.isListening()||!this.isVisible())return null;let t=1,i=!1;for(;;){for(let s=0;s<Pc;s++){const r=wr[s],a=this._getIntersection({x:e.x+r.x*t,y:e.y+r.y*t}),l=a.shape;if(l)return l;if(i=!!a.antialiased,!a.antialiased)break}if(i)t+=1;else return null}}_getIntersection(e){const t=this.hitCanvas.pixelRatio,i=this.hitCanvas.context.getImageData(Math.round(e.x*t),Math.round(e.y*t),1,1).data,s=i[3];if(s===255){const r=F._rgbToHex(i[0],i[1],i[2]),a=hn[kc+r];return a?{shape:a}:{antialiased:!0}}else if(s>0)return{antialiased:!0};return{}}drawScene(e,t,i){const s=this.getLayer(),r=e||s&&s.getCanvas();return this._fire(Tc,{node:this}),this.clearBeforeDraw()&&r.getContext().clear(),Ze.prototype.drawScene.call(this,r,t,i),this._fire(Ec,{node:this}),this}drawHit(e,t){const i=this.getLayer(),s=e||i&&i.hitCanvas;return i&&i.clearBeforeDraw()&&i.getHitCanvas().getContext().clear(),Ze.prototype.drawHit.call(this,s,t),this}enableHitGraph(){return this.hitGraphEnabled(!0),this}disableHitGraph(){return this.hitGraphEnabled(!1),this}setHitGraphEnabled(e){F.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening(e)}getHitGraphEnabled(e){return F.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening()}toggleHitCanvas(){if(!this.parent||!this.parent.content)return;const e=this.parent;!!this.hitCanvas._canvas.parentNode?e.content.removeChild(this.hitCanvas._canvas):e.content.appendChild(this.hitCanvas._canvas)}destroy(){return F.releaseCanvas(this.getNativeCanvasElement(),this.getHitCanvas()._canvas),super.destroy()}}It.prototype.nodeType="Layer";Be(It);k.addGetterSetter(It,"imageSmoothingEnabled",!0);k.addGetterSetter(It,"clearBeforeDraw",!0);k.addGetterSetter(It,"hitGraphEnabled",!0,at());class Ii extends It{constructor(e){super(e),this.listening(!1),F.warn('Konva.Fast layer is deprecated. Please use "new Konva.Layer({ listening: false })" instead.')}}Ii.prototype.nodeType="FastLayer";Be(Ii);class Yt extends Ze{_validateAdd(e){const t=e.getType();t!=="Group"&&t!=="Shape"&&F.throw("You may only add groups and shapes to groups.")}}Yt.prototype.nodeType="Group";Be(Yt);const di=function(){return Lt.performance&&Lt.performance.now?function(){return Lt.performance.now()}:function(){return new Date().getTime()}}();class nt{constructor(e,t){this.id=nt.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:di(),frameRate:0},this.func=e,this.setLayers(t)}setLayers(e){let t=[];return e&&(t=Array.isArray(e)?e:[e]),this.layers=t,this}getLayers(){return this.layers}addLayer(e){const t=this.layers,i=t.length;for(let s=0;s<i;s++)if(t[s]._id===e._id)return!1;return this.layers.push(e),!0}isRunning(){const t=nt.animations,i=t.length;for(let s=0;s<i;s++)if(t[s].id===this.id)return!0;return!1}start(){return this.stop(),this.frame.timeDiff=0,this.frame.lastTime=di(),nt._addAnimation(this),this}stop(){return nt._removeAnimation(this),this}_updateFrameObject(e){this.frame.timeDiff=e-this.frame.lastTime,this.frame.lastTime=e,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}static _addAnimation(e){this.animations.push(e),this._handleAnimation()}static _removeAnimation(e){const t=e.id,i=this.animations,s=i.length;for(let r=0;r<s;r++)if(i[r].id===t){this.animations.splice(r,1);break}}static _runFrames(){const e={},t=this.animations;for(let i=0;i<t.length;i++){const s=t[i],r=s.layers,a=s.func;s._updateFrameObject(di());const l=r.length;let o;if(a?o=a.call(s,s.frame)!==!1:o=!0,!!o)for(let c=0;c<l;c++){const d=r[c];d._id!==void 0&&(e[d._id]=d)}}for(const i in e)e.hasOwnProperty(i)&&e[i].batchDraw()}static _animationLoop(){const e=nt;e.animations.length?(e._runFrames(),F.requestAnimFrame(e._animationLoop)):e.animRunning=!1}static _handleAnimation(){this.animRunning||(this.animRunning=!0,F.requestAnimFrame(this._animationLoop))}}nt.animations=[];nt.animIdCounter=0;nt.animRunning=!1;const Ac={node:1,duration:1,easing:1,onFinish:1,yoyo:1},Rc=1,us=2,gs=3,fs=["fill","stroke","shadowColor"];let Lc=0;class Mc{constructor(e,t,i,s,r,a,l){this.prop=e,this.propFunc=t,this.begin=s,this._pos=s,this.duration=a,this._change=0,this.prevPos=0,this.yoyo=l,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=i,this._change=r-this.begin,this.pause()}fire(e){const t=this[e];t&&t()}setTime(e){e>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():e<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=e,this.update())}getTime(){return this._time}setPosition(e){this.prevPos=this._pos,this.propFunc(e),this._pos=e}getPosition(e){return e===void 0&&(e=this._time),this.func(e,this.begin,this._change,this.duration)}play(){this.state=us,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")}reverse(){this.state=gs,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")}seek(e){this.pause(),this._time=e,this.update(),this.fire("onSeek")}reset(){this.pause(),this._time=0,this.update(),this.fire("onReset")}finish(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")}update(){this.setPosition(this.getPosition(this._time)),this.fire("onUpdate")}onEnterFrame(){const e=this.getTimer()-this._startTime;this.state===us?this.setTime(e):this.state===gs&&this.setTime(this.duration-e)}pause(){this.state=Rc,this.fire("onPause")}getTimer(){return new Date().getTime()}}class Ne{constructor(e){const t=this,i=e.node,s=i._id,r=e.easing||un.Linear,a=!!e.yoyo;let l,o;typeof e.duration>"u"?l=.3:e.duration===0?l=.001:l=e.duration,this.node=i,this._id=Lc++;const c=i.getLayer()||(i instanceof le.Stage?i.getLayers():null);c||F.error("Tween constructor have `node` that is not in a layer. Please add node into layer first."),this.anim=new nt(function(){t.tween.onEnterFrame()},c),this.tween=new Mc(o,function(d){t._tweenFunc(d)},r,0,1,l*1e3,a),this._addListeners(),Ne.attrs[s]||(Ne.attrs[s]={}),Ne.attrs[s][this._id]||(Ne.attrs[s][this._id]={}),Ne.tweens[s]||(Ne.tweens[s]={});for(o in e)Ac[o]===void 0&&this._addAttr(o,e[o]);this.reset(),this.onFinish=e.onFinish,this.onReset=e.onReset,this.onUpdate=e.onUpdate}_addAttr(e,t){const i=this.node,s=i._id;let r,a,l,o,c;const d=Ne.tweens[s][e];d&&delete Ne.attrs[s][d][e];let h=i.getAttr(e);if(F._isArray(t))if(r=[],a=Math.max(t.length,h.length),e==="points"&&t.length!==h.length&&(t.length>h.length?(o=h,h=F._prepareArrayForTween(h,t,i.closed())):(l=t,t=F._prepareArrayForTween(t,h,i.closed()))),e.indexOf("fill")===0)for(let u=0;u<a;u++)if(u%2===0)r.push(t[u]-h[u]);else{const v=F.colorToRGBA(h[u]);c=F.colorToRGBA(t[u]),h[u]=v,r.push({r:c.r-v.r,g:c.g-v.g,b:c.b-v.b,a:c.a-v.a})}else for(let u=0;u<a;u++)r.push(t[u]-h[u]);else fs.indexOf(e)!==-1?(h=F.colorToRGBA(h),c=F.colorToRGBA(t),r={r:c.r-h.r,g:c.g-h.g,b:c.b-h.b,a:c.a-h.a}):r=t-h;Ne.attrs[s][this._id][e]={start:h,diff:r,end:t,trueEnd:l,trueStart:o},Ne.tweens[s][e]=this._id}_tweenFunc(e){const t=this.node,i=Ne.attrs[t._id][this._id];let s,r,a,l,o,c,d,h;for(s in i){if(r=i[s],a=r.start,l=r.diff,h=r.end,F._isArray(a))if(o=[],d=Math.max(a.length,h.length),s.indexOf("fill")===0)for(c=0;c<d;c++)c%2===0?o.push((a[c]||0)+l[c]*e):o.push("rgba("+Math.round(a[c].r+l[c].r*e)+","+Math.round(a[c].g+l[c].g*e)+","+Math.round(a[c].b+l[c].b*e)+","+(a[c].a+l[c].a*e)+")");else for(c=0;c<d;c++)o.push((a[c]||0)+l[c]*e);else fs.indexOf(s)!==-1?o="rgba("+Math.round(a.r+l.r*e)+","+Math.round(a.g+l.g*e)+","+Math.round(a.b+l.b*e)+","+(a.a+l.a*e)+")":o=a+l*e;t.setAttr(s,o)}}_addListeners(){this.tween.onPlay=()=>{this.anim.start()},this.tween.onReverse=()=>{this.anim.start()},this.tween.onPause=()=>{this.anim.stop()},this.tween.onFinish=()=>{const e=this.node,t=Ne.attrs[e._id][this._id];t.points&&t.points.trueEnd&&e.setAttr("points",t.points.trueEnd),this.onFinish&&this.onFinish.call(this)},this.tween.onReset=()=>{const e=this.node,t=Ne.attrs[e._id][this._id];t.points&&t.points.trueStart&&e.points(t.points.trueStart),this.onReset&&this.onReset()},this.tween.onUpdate=()=>{this.onUpdate&&this.onUpdate.call(this)}}play(){return this.tween.play(),this}reverse(){return this.tween.reverse(),this}reset(){return this.tween.reset(),this}seek(e){return this.tween.seek(e*1e3),this}pause(){return this.tween.pause(),this}finish(){return this.tween.finish(),this}destroy(){const e=this.node._id,t=this._id,i=Ne.tweens[e];this.pause(),this.anim&&this.anim.stop();for(const s in i)delete Ne.tweens[e][s];delete Ne.attrs[e][t],Ne.tweens[e]&&(Object.keys(Ne.tweens[e]).length===0&&delete Ne.tweens[e],Object.keys(Ne.attrs[e]).length===0&&delete Ne.attrs[e])}}Ne.attrs={};Ne.tweens={};ie.prototype.to=function(n){const e=n.onFinish;n.node=this,n.onFinish=function(){this.destroy(),e&&e()},new Ne(n).play()};const un={BackEaseIn(n,e,t,i){return t*(n/=i)*n*((1.70158+1)*n-1.70158)+e},BackEaseOut(n,e,t,i){return t*((n=n/i-1)*n*((1.70158+1)*n+1.70158)+1)+e},BackEaseInOut(n,e,t,i){let s=1.70158;return(n/=i/2)<1?t/2*(n*n*(((s*=1.525)+1)*n-s))+e:t/2*((n-=2)*n*(((s*=1.525)+1)*n+s)+2)+e},ElasticEaseIn(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i)===1?e+t:(r||(r=i*.3),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),-(s*Math.pow(2,10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r))+e)},ElasticEaseOut(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i)===1?e+t:(r||(r=i*.3),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),s*Math.pow(2,-10*n)*Math.sin((n*i-a)*(2*Math.PI)/r)+t+e)},ElasticEaseInOut(n,e,t,i,s,r){let a=0;return n===0?e:(n/=i/2)===2?e+t:(r||(r=i*(.3*1.5)),!s||s<Math.abs(t)?(s=t,a=r/4):a=r/(2*Math.PI)*Math.asin(t/s),n<1?-.5*(s*Math.pow(2,10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r))+e:s*Math.pow(2,-10*(n-=1))*Math.sin((n*i-a)*(2*Math.PI)/r)*.5+t+e)},BounceEaseOut(n,e,t,i){return(n/=i)<1/2.75?t*(7.5625*n*n)+e:n<2/2.75?t*(7.5625*(n-=1.5/2.75)*n+.75)+e:n<2.5/2.75?t*(7.5625*(n-=2.25/2.75)*n+.9375)+e:t*(7.5625*(n-=2.625/2.75)*n+.984375)+e},BounceEaseIn(n,e,t,i){return t-un.BounceEaseOut(i-n,0,t,i)+e},BounceEaseInOut(n,e,t,i){return n<i/2?un.BounceEaseIn(n*2,0,t,i)*.5+e:un.BounceEaseOut(n*2-i,0,t,i)*.5+t*.5+e},EaseIn(n,e,t,i){return t*(n/=i)*n+e},EaseOut(n,e,t,i){return-t*(n/=i)*(n-2)+e},EaseInOut(n,e,t,i){return(n/=i/2)<1?t/2*n*n+e:-t/2*(--n*(n-2)-1)+e},StrongEaseIn(n,e,t,i){return t*(n/=i)*n*n*n*n+e},StrongEaseOut(n,e,t,i){return t*((n=n/i-1)*n*n*n*n+1)+e},StrongEaseInOut(n,e,t,i){return(n/=i/2)<1?t/2*n*n*n*n*n+e:t/2*((n-=2)*n*n*n*n+2)+e},Linear(n,e,t,i){return t*n/i+e}},vs=F._assign(le,{Util:F,Transform:Ke,Node:ie,Container:Ze,Stage:Jn,stages:dn,Layer:It,FastLayer:Ii,Group:Yt,DD:Re,Shape:J,shapes:hn,Animation:nt,Tween:Ne,Easings:un,Context:Qn,Canvas:Li});class pt extends J{_sceneFunc(e){const t=le.getAngle(this.angle()),i=this.clockwise();e.beginPath(),e.arc(0,0,this.outerRadius(),0,t,i),e.arc(0,0,this.innerRadius(),t,0,!i),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}getSelfRect(){const e=this.innerRadius(),t=this.outerRadius(),i=this.clockwise(),s=le.getAngle(i?360-this.angle():this.angle()),r=Math.cos(Math.min(s,Math.PI)),a=1,l=Math.sin(Math.min(Math.max(Math.PI,s),3*Math.PI/2)),o=Math.sin(Math.min(s,Math.PI/2)),c=r*(r>0?e:t),d=a*t,h=l*(l>0?e:t),u=o*(o>0?t:e);return{x:c,y:i?-1*u:h,width:d-c,height:u-h}}}pt.prototype._centroid=!0;pt.prototype.className="Arc";pt.prototype._attrsAffectingSize=["innerRadius","outerRadius","angle","clockwise"];Be(pt);k.addGetterSetter(pt,"innerRadius",0,re());k.addGetterSetter(pt,"outerRadius",0,re());k.addGetterSetter(pt,"angle",0,re());k.addGetterSetter(pt,"clockwise",!1,at());function $i(n,e,t,i,s,r,a){const l=Math.sqrt(Math.pow(t-n,2)+Math.pow(i-e,2)),o=Math.sqrt(Math.pow(s-t,2)+Math.pow(r-i,2)),c=a*l/(l+o),d=a*o/(l+o),h=t-c*(s-n),u=i-c*(r-e),v=t+d*(s-n),f=i+d*(r-e);return[h,u,v,f]}function ps(n,e){const t=n.length,i=[];for(let s=2;s<t-2;s+=2){const r=$i(n[s-2],n[s-1],n[s],n[s+1],n[s+2],n[s+3],e);isNaN(r[0])||(i.push(r[0]),i.push(r[1]),i.push(n[s]),i.push(n[s+1]),i.push(r[2]),i.push(r[3]))}return i}class mt extends J{constructor(e){super(e),this.on("pointsChange.konva tensionChange.konva closedChange.konva bezierChange.konva",function(){this._clearCache("tensionPoints")})}_sceneFunc(e){const t=this.points(),i=t.length,s=this.tension(),r=this.closed(),a=this.bezier();if(!i)return;let l=0;if(e.beginPath(),e.moveTo(t[0],t[1]),s!==0&&i>4){const o=this.getTensionPoints(),c=o.length;for(l=r?0:4,r||e.quadraticCurveTo(o[0],o[1],o[2],o[3]);l<c-2;)e.bezierCurveTo(o[l++],o[l++],o[l++],o[l++],o[l++],o[l++]);r||e.quadraticCurveTo(o[c-2],o[c-1],t[i-2],t[i-1])}else if(a)for(l=2;l<i;)e.bezierCurveTo(t[l++],t[l++],t[l++],t[l++],t[l++],t[l++]);else for(l=2;l<i;l+=2)e.lineTo(t[l],t[l+1]);r?(e.closePath(),e.fillStrokeShape(this)):e.strokeShape(this)}getTensionPoints(){return this._getCache("tensionPoints",this._getTensionPoints)}_getTensionPoints(){return this.closed()?this._getTensionPointsClosed():ps(this.points(),this.tension())}_getTensionPointsClosed(){const e=this.points(),t=e.length,i=this.tension(),s=$i(e[t-2],e[t-1],e[0],e[1],e[2],e[3],i),r=$i(e[t-4],e[t-3],e[t-2],e[t-1],e[0],e[1],i),a=ps(e,i);return[s[2],s[3]].concat(a).concat([r[0],r[1],e[t-2],e[t-1],r[2],r[3],s[0],s[1],e[0],e[1]])}getWidth(){return this.getSelfRect().width}getHeight(){return this.getSelfRect().height}getSelfRect(){let e=this.points();if(e.length<4)return{x:e[0]||0,y:e[1]||0,width:0,height:0};this.tension()!==0?e=[e[0],e[1],...this._getTensionPoints(),e[e.length-2],e[e.length-1]]:e=this.points();let t=e[0],i=e[0],s=e[1],r=e[1],a,l;for(let o=0;o<e.length/2;o++)a=e[o*2],l=e[o*2+1],t=Math.min(t,a),i=Math.max(i,a),s=Math.min(s,l),r=Math.max(r,l);return{x:t,y:s,width:i-t,height:r-s}}}mt.prototype.className="Line";mt.prototype._attrsAffectingSize=["points","bezier","tension"];Be(mt);k.addGetterSetter(mt,"closed",!1);k.addGetterSetter(mt,"bezier",!1);k.addGetterSetter(mt,"tension",0,re());k.addGetterSetter(mt,"points",[],Xo());const Dc=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],Oc=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],Ic=[[1],[1,1],[1,2,1],[1,3,3,1]],ms=(n,e,t)=>{let i,s;const a=t/2;i=0;for(let l=0;l<20;l++)s=a*Dc[20][l]+a,i+=Oc[20][l]*Nc(n,e,s);return a*i},bs=(n,e,t)=>{t===void 0&&(t=1);const i=n[0]-2*n[1]+n[2],s=e[0]-2*e[1]+e[2],r=2*n[1]-2*n[0],a=2*e[1]-2*e[0],l=4*(i*i+s*s),o=4*(i*r+s*a),c=r*r+a*a;if(l===0)return t*Math.sqrt(Math.pow(n[2]-n[0],2)+Math.pow(e[2]-e[0],2));const d=o/(2*l),h=c/l,u=t+d,v=h-d*d,f=u*u+v>0?Math.sqrt(u*u+v):0,p=d*d+v>0?Math.sqrt(d*d+v):0,b=d+Math.sqrt(d*d+v)!==0?v*Math.log(Math.abs((u+f)/(d+p))):0;return Math.sqrt(l)/2*(u*f-d*p+b)};function Nc(n,e,t){const i=Ci(1,t,n),s=Ci(1,t,e),r=i*i+s*s;return Math.sqrt(r)}const Ci=(n,e,t)=>{const i=t.length-1;let s,r;if(i===0)return 0;if(n===0){r=0;for(let a=0;a<=i;a++)r+=Ic[i][a]*Math.pow(1-e,i-a)*Math.pow(e,a)*t[a];return r}else{s=new Array(i);for(let a=0;a<i;a++)s[a]=i*(t[a+1]-t[a]);return Ci(n-1,e,s)}},ys=(n,e,t)=>{let i=1,s=n/e,r=(n-t(s))/e,a=0;for(;i>.001;){const l=t(s+r),o=Math.abs(n-l)/e;if(o<i)i=o,s+=r;else{const c=t(s-r),d=Math.abs(n-c)/e;d<i?(i=d,s-=r):r/=2}if(a++,a>500)break}return s};class ze extends J{constructor(e){super(e),this.dataArray=[],this.pathLength=0,this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute()})}_readDataAttribute(){this.dataArray=ze.parsePathData(this.data()),this.pathLength=ze.getPathLength(this.dataArray)}_sceneFunc(e){const t=this.dataArray;e.beginPath();let i=!1;for(let s=0;s<t.length;s++){const r=t[s].command,a=t[s].points;switch(r){case"L":e.lineTo(a[0],a[1]);break;case"M":e.moveTo(a[0],a[1]);break;case"C":e.bezierCurveTo(a[0],a[1],a[2],a[3],a[4],a[5]);break;case"Q":e.quadraticCurveTo(a[0],a[1],a[2],a[3]);break;case"A":const l=a[0],o=a[1],c=a[2],d=a[3],h=a[4],u=a[5],v=a[6],f=a[7],p=c>d?c:d,b=c>d?1:c/d,m=c>d?d/c:1;e.translate(l,o),e.rotate(v),e.scale(b,m),e.arc(0,0,p,h,h+u,1-f),e.scale(1/b,1/m),e.rotate(-v),e.translate(-l,-o);break;case"z":i=!0,e.closePath();break}}!i&&!this.hasFill()?e.strokeShape(this):e.fillStrokeShape(this)}getSelfRect(){let e=[];this.dataArray.forEach(function(o){if(o.command==="A"){const c=o.points[4],d=o.points[5],h=o.points[4]+d;let u=Math.PI/180;if(Math.abs(c-h)<u&&(u=Math.abs(c-h)),d<0)for(let v=c-u;v>h;v-=u){const f=ze.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],v,0);e.push(f.x,f.y)}else for(let v=c+u;v<h;v+=u){const f=ze.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],v,0);e.push(f.x,f.y)}}else if(o.command==="C")for(let c=0;c<=1;c+=.01){const d=ze.getPointOnCubicBezier(c,o.start.x,o.start.y,o.points[0],o.points[1],o.points[2],o.points[3],o.points[4],o.points[5]);e.push(d.x,d.y)}else e=e.concat(o.points)});let t=e[0],i=e[0],s=e[1],r=e[1],a,l;for(let o=0;o<e.length/2;o++)a=e[o*2],l=e[o*2+1],isNaN(a)||(t=Math.min(t,a),i=Math.max(i,a)),isNaN(l)||(s=Math.min(s,l),r=Math.max(r,l));return{x:t,y:s,width:i-t,height:r-s}}getLength(){return this.pathLength}getPointAtLength(e){return ze.getPointAtLengthOfDataArray(e,this.dataArray)}static getLineLength(e,t,i,s){return Math.sqrt((i-e)*(i-e)+(s-t)*(s-t))}static getPathLength(e){let t=0;for(let i=0;i<e.length;++i)t+=e[i].pathLength;return t}static getPointAtLengthOfDataArray(e,t){let i,s=0,r=t.length;if(!r)return null;for(;s<r&&e>t[s].pathLength;)e-=t[s].pathLength,++s;if(s===r)return i=t[s-1].points.slice(-2),{x:i[0],y:i[1]};if(e<.01)return t[s].command==="M"?(i=t[s].points.slice(0,2),{x:i[0],y:i[1]}):{x:t[s].start.x,y:t[s].start.y};const a=t[s],l=a.points;switch(a.command){case"L":return ze.getPointOnLine(e,a.start.x,a.start.y,l[0],l[1]);case"C":return ze.getPointOnCubicBezier(ys(e,ze.getPathLength(t),p=>ms([a.start.x,l[0],l[2],l[4]],[a.start.y,l[1],l[3],l[5]],p)),a.start.x,a.start.y,l[0],l[1],l[2],l[3],l[4],l[5]);case"Q":return ze.getPointOnQuadraticBezier(ys(e,ze.getPathLength(t),p=>bs([a.start.x,l[0],l[2]],[a.start.y,l[1],l[3]],p)),a.start.x,a.start.y,l[0],l[1],l[2],l[3]);case"A":const o=l[0],c=l[1],d=l[2],h=l[3],u=l[5],v=l[6];let f=l[4];return f+=u*e/a.pathLength,ze.getPointOnEllipticalArc(o,c,d,h,f,v)}return null}static getPointOnLine(e,t,i,s,r,a,l){a=a??t,l=l??i;const o=this.getLineLength(t,i,s,r);if(o<1e-10)return{x:t,y:i};if(s===t)return{x:a,y:l+(r>i?e:-e)};const c=(r-i)/(s-t),d=Math.sqrt(e*e/(1+c*c))*(s<t?-1:1),h=c*d;if(Math.abs(l-i-c*(a-t))<1e-10)return{x:a+d,y:l+h};const u=((a-t)*(s-t)+(l-i)*(r-i))/(o*o),v=t+u*(s-t),f=i+u*(r-i),p=this.getLineLength(a,l,v,f),b=Math.sqrt(e*e-p*p),m=Math.sqrt(b*b/(1+c*c))*(s<t?-1:1),_=c*m;return{x:v+m,y:f+_}}static getPointOnCubicBezier(e,t,i,s,r,a,l,o,c){function d(b){return b*b*b}function h(b){return 3*b*b*(1-b)}function u(b){return 3*b*(1-b)*(1-b)}function v(b){return(1-b)*(1-b)*(1-b)}const f=o*d(e)+a*h(e)+s*u(e)+t*v(e),p=c*d(e)+l*h(e)+r*u(e)+i*v(e);return{x:f,y:p}}static getPointOnQuadraticBezier(e,t,i,s,r,a,l){function o(v){return v*v}function c(v){return 2*v*(1-v)}function d(v){return(1-v)*(1-v)}const h=a*o(e)+s*c(e)+t*d(e),u=l*o(e)+r*c(e)+i*d(e);return{x:h,y:u}}static getPointOnEllipticalArc(e,t,i,s,r,a){const l=Math.cos(a),o=Math.sin(a),c={x:i*Math.cos(r),y:s*Math.sin(r)};return{x:e+(c.x*l-c.y*o),y:t+(c.x*o+c.y*l)}}static parsePathData(e){if(!e)return[];let t=e;const i=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];t=t.replace(new RegExp(" ","g"),",");for(let h=0;h<i.length;h++)t=t.replace(new RegExp(i[h],"g"),"|"+i[h]);const s=t.split("|"),r=[],a=[];let l=0,o=0;const c=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;let d;for(let h=1;h<s.length;h++){let u=s[h],v=u.charAt(0);for(u=u.slice(1),a.length=0;d=c.exec(u);)a.push(d[0]);let f=[],p=v==="A"||v==="a"?0:-1;for(let b=0,m=a.length;b<m;b++){const _=a[b];if(_==="00"){f.push(0,0),p>=0&&(p+=2,p>=7&&(p-=7));continue}if(p>=0){if(p===3){if(/^[01]{2}\d+(?:\.\d+)?$/.test(_)){f.push(parseInt(_[0],10)),f.push(parseInt(_[1],10)),f.push(parseFloat(_.slice(2))),p+=3,p>=7&&(p-=7);continue}if(_==="11"||_==="10"||_==="01"){f.push(parseInt(_[0],10)),f.push(parseInt(_[1],10)),p+=2,p>=7&&(p-=7);continue}if(_==="0"||_==="1"){f.push(parseInt(_,10)),p+=1,p>=7&&(p-=7);continue}}else if(p===4){if(/^[01]\d+(?:\.\d+)?$/.test(_)){f.push(parseInt(_[0],10)),f.push(parseFloat(_.slice(1))),p+=2,p>=7&&(p-=7);continue}if(_==="0"||_==="1"){f.push(parseInt(_,10)),p+=1,p>=7&&(p-=7);continue}}const w=parseFloat(_);isNaN(w)?f.push(0):f.push(w),p+=1,p>=7&&(p-=7)}else{const w=parseFloat(_);isNaN(w)?f.push(0):f.push(w)}}for(;f.length>0&&!isNaN(f[0]);){let b="",m=[];const _=l,w=o;let x,C,A,M,I,z,E,R,T,U;switch(v){case"l":l+=f.shift(),o+=f.shift(),b="L",m.push(l,o);break;case"L":l=f.shift(),o=f.shift(),m.push(l,o);break;case"m":const N=f.shift(),$=f.shift();if(l+=N,o+=$,b="M",r.length>2&&r[r.length-1].command==="z"){for(let P=r.length-2;P>=0;P--)if(r[P].command==="M"){l=r[P].points[0]+N,o=r[P].points[1]+$;break}}m.push(l,o),v="l";break;case"M":l=f.shift(),o=f.shift(),b="M",m.push(l,o),v="L";break;case"h":l+=f.shift(),b="L",m.push(l,o);break;case"H":l=f.shift(),b="L",m.push(l,o);break;case"v":o+=f.shift(),b="L",m.push(l,o);break;case"V":o=f.shift(),b="L",m.push(l,o);break;case"C":m.push(f.shift(),f.shift(),f.shift(),f.shift()),l=f.shift(),o=f.shift(),m.push(l,o);break;case"c":m.push(l+f.shift(),o+f.shift(),l+f.shift(),o+f.shift()),l+=f.shift(),o+=f.shift(),b="C",m.push(l,o);break;case"S":C=l,A=o,x=r[r.length-1],x.command==="C"&&(C=l+(l-x.points[2]),A=o+(o-x.points[3])),m.push(C,A,f.shift(),f.shift()),l=f.shift(),o=f.shift(),b="C",m.push(l,o);break;case"s":C=l,A=o,x=r[r.length-1],x.command==="C"&&(C=l+(l-x.points[2]),A=o+(o-x.points[3])),m.push(C,A,l+f.shift(),o+f.shift()),l+=f.shift(),o+=f.shift(),b="C",m.push(l,o);break;case"Q":m.push(f.shift(),f.shift()),l=f.shift(),o=f.shift(),m.push(l,o);break;case"q":m.push(l+f.shift(),o+f.shift()),l+=f.shift(),o+=f.shift(),b="Q",m.push(l,o);break;case"T":C=l,A=o,x=r[r.length-1],x.command==="Q"&&(C=l+(l-x.points[0]),A=o+(o-x.points[1])),l=f.shift(),o=f.shift(),b="Q",m.push(C,A,l,o);break;case"t":C=l,A=o,x=r[r.length-1],x.command==="Q"&&(C=l+(l-x.points[0]),A=o+(o-x.points[1])),l+=f.shift(),o+=f.shift(),b="Q",m.push(C,A,l,o);break;case"A":M=f.shift(),I=f.shift(),z=f.shift(),E=f.shift(),R=f.shift(),T=l,U=o,l=f.shift(),o=f.shift(),b="A",m=this.convertEndpointToCenterParameterization(T,U,l,o,E,R,M,I,z);break;case"a":M=f.shift(),I=f.shift(),z=f.shift(),E=f.shift(),R=f.shift(),T=l,U=o,l+=f.shift(),o+=f.shift(),b="A",m=this.convertEndpointToCenterParameterization(T,U,l,o,E,R,M,I,z);break}r.push({command:b||v,points:m,start:{x:_,y:w},pathLength:this.calcLength(_,w,b||v,m)})}(v==="z"||v==="Z")&&r.push({command:"z",points:[],start:void 0,pathLength:0})}return r}static calcLength(e,t,i,s){let r,a,l,o;const c=ze;switch(i){case"L":return c.getLineLength(e,t,s[0],s[1]);case"C":return ms([e,s[0],s[2],s[4]],[t,s[1],s[3],s[5]],1);case"Q":return bs([e,s[0],s[2]],[t,s[1],s[3]],1);case"A":r=0;const d=s[4],h=s[5],u=s[4]+h;let v=Math.PI/180;if(Math.abs(d-u)<v&&(v=Math.abs(d-u)),a=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],d,0),h<0)for(o=d-v;o>u;o-=v)l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],o,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),a=l;else for(o=d+v;o<u;o+=v)l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],o,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),a=l;return l=c.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],u,0),r+=c.getLineLength(a.x,a.y,l.x,l.y),r}return 0}static convertEndpointToCenterParameterization(e,t,i,s,r,a,l,o,c){const d=c*(Math.PI/180),h=Math.cos(d)*(e-i)/2+Math.sin(d)*(t-s)/2,u=-1*Math.sin(d)*(e-i)/2+Math.cos(d)*(t-s)/2,v=h*h/(l*l)+u*u/(o*o);v>1&&(l*=Math.sqrt(v),o*=Math.sqrt(v));let f=Math.sqrt((l*l*(o*o)-l*l*(u*u)-o*o*(h*h))/(l*l*(u*u)+o*o*(h*h)));r===a&&(f*=-1),isNaN(f)&&(f=0);const p=f*l*u/o,b=f*-o*h/l,m=(e+i)/2+Math.cos(d)*p-Math.sin(d)*b,_=(t+s)/2+Math.sin(d)*p+Math.cos(d)*b,w=function(E){return Math.sqrt(E[0]*E[0]+E[1]*E[1])},x=function(E,R){return(E[0]*R[0]+E[1]*R[1])/(w(E)*w(R))},C=function(E,R){return(E[0]*R[1]<E[1]*R[0]?-1:1)*Math.acos(x(E,R))},A=C([1,0],[(h-p)/l,(u-b)/o]),M=[(h-p)/l,(u-b)/o],I=[(-1*h-p)/l,(-1*u-b)/o];let z=C(M,I);return x(M,I)<=-1&&(z=Math.PI),x(M,I)>=1&&(z=0),a===0&&z>0&&(z=z-2*Math.PI),a===1&&z<0&&(z=z+2*Math.PI),[m,_,l,o,A,z,d,a]}}ze.prototype.className="Path";ze.prototype._attrsAffectingSize=["data"];Be(ze);k.addGetterSetter(ze,"data");class Nt extends mt{_sceneFunc(e){super._sceneFunc(e);const t=Math.PI*2,i=this.points();let s=i;const r=this.tension()!==0&&i.length>4;r&&(s=this.getTensionPoints());const a=this.pointerLength(),l=i.length;let o,c;if(r){const u=[s[s.length-4],s[s.length-3],s[s.length-2],s[s.length-1],i[l-2],i[l-1]],v=ze.calcLength(s[s.length-4],s[s.length-3],"C",u),f=ze.getPointOnQuadraticBezier(Math.min(1,1-a/v),u[0],u[1],u[2],u[3],u[4],u[5]);o=i[l-2]-f.x,c=i[l-1]-f.y}else o=i[l-2]-i[l-4],c=i[l-1]-i[l-3];const d=(Math.atan2(c,o)+t)%t,h=this.pointerWidth();this.pointerAtEnding()&&(e.save(),e.beginPath(),e.translate(i[l-2],i[l-1]),e.rotate(d),e.moveTo(0,0),e.lineTo(-a,h/2),e.lineTo(-a,-h/2),e.closePath(),e.restore(),this.__fillStroke(e)),this.pointerAtBeginning()&&(e.save(),e.beginPath(),e.translate(i[0],i[1]),r?(o=(s[0]+s[2])/2-i[0],c=(s[1]+s[3])/2-i[1]):(o=i[2]-i[0],c=i[3]-i[1]),e.rotate((Math.atan2(-c,-o)+t)%t),e.moveTo(0,0),e.lineTo(-a,h/2),e.lineTo(-a,-h/2),e.closePath(),e.restore(),this.__fillStroke(e))}__fillStroke(e){const t=this.dashEnabled();t&&(this.attrs.dashEnabled=!1,e.setLineDash([])),e.fillStrokeShape(this),t&&(this.attrs.dashEnabled=!0)}getSelfRect(){const e=super.getSelfRect(),t=this.pointerWidth()/2;return{x:e.x,y:e.y-t,width:e.width,height:e.height+t*2}}}Nt.prototype.className="Arrow";Be(Nt);k.addGetterSetter(Nt,"pointerLength",10,re());k.addGetterSetter(Nt,"pointerWidth",10,re());k.addGetterSetter(Nt,"pointerAtBeginning",!1);k.addGetterSetter(Nt,"pointerAtEnding",!0);class Xt extends J{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.attrs.radius||0,0,Math.PI*2,!1),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius()!==e/2&&this.radius(e/2)}setHeight(e){this.radius()!==e/2&&this.radius(e/2)}}Xt.prototype._centroid=!0;Xt.prototype.className="Circle";Xt.prototype._attrsAffectingSize=["radius"];Be(Xt);k.addGetterSetter(Xt,"radius",0,re());class kt extends J{_sceneFunc(e){const t=this.radiusX(),i=this.radiusY();e.beginPath(),e.save(),t!==i&&e.scale(1,i/t),e.arc(0,0,t,0,Math.PI*2,!1),e.restore(),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radiusX()*2}getHeight(){return this.radiusY()*2}setWidth(e){this.radiusX(e/2)}setHeight(e){this.radiusY(e/2)}}kt.prototype.className="Ellipse";kt.prototype._centroid=!0;kt.prototype._attrsAffectingSize=["radiusX","radiusY"];Be(kt);k.addComponentsGetterSetter(kt,"radius",["x","y"]);k.addGetterSetter(kt,"radiusX",0,re());k.addGetterSetter(kt,"radiusY",0,re());class st extends J{constructor(e){super(e),this._loadListener=()=>{this._requestDraw()},this.on("imageChange.konva",t=>{this._removeImageLoad(t.oldVal),this._setImageLoad()}),this._setImageLoad()}_setImageLoad(){const e=this.image();e&&e.complete||e&&e.readyState===4||e&&e.addEventListener&&e.addEventListener("load",this._loadListener)}_removeImageLoad(e){e&&e.removeEventListener&&e.removeEventListener("load",this._loadListener)}destroy(){return this._removeImageLoad(this.image()),super.destroy(),this}_useBufferCanvas(){const e=!!this.cornerRadius(),t=this.hasShadow();return e&&t?!0:super._useBufferCanvas(!0)}_sceneFunc(e){const t=this.getWidth(),i=this.getHeight(),s=this.cornerRadius(),r=this.attrs.image;let a;if(r){const l=this.attrs.cropWidth,o=this.attrs.cropHeight;l&&o?a=[r,this.cropX(),this.cropY(),l,o,0,0,t,i]:a=[r,0,0,t,i]}(this.hasFill()||this.hasStroke()||s)&&(e.beginPath(),s?F.drawRoundedRectPath(e,t,i,s):e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)),r&&(s&&e.clip(),e.drawImage.apply(e,a))}_hitFunc(e){const t=this.width(),i=this.height(),s=this.cornerRadius();e.beginPath(),s?F.drawRoundedRectPath(e,t,i,s):e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)}getWidth(){var e,t;return(e=this.attrs.width)!==null&&e!==void 0?e:(t=this.image())===null||t===void 0?void 0:t.width}getHeight(){var e,t;return(e=this.attrs.height)!==null&&e!==void 0?e:(t=this.image())===null||t===void 0?void 0:t.height}static fromURL(e,t,i=null){const s=F.createImageElement();s.onload=function(){const r=new st({image:s});t(r)},s.onerror=i,s.crossOrigin="Anonymous",s.src=e}}st.prototype.className="Image";Be(st);k.addGetterSetter(st,"cornerRadius",0,Kn(4));k.addGetterSetter(st,"image");k.addComponentsGetterSetter(st,"crop",["x","y","width","height"]);k.addGetterSetter(st,"cropX",0,re());k.addGetterSetter(st,"cropY",0,re());k.addGetterSetter(st,"cropWidth",0,re());k.addGetterSetter(st,"cropHeight",0,re());const $r=["fontFamily","fontSize","fontStyle","padding","lineHeight","text","width","height","pointerDirection","pointerWidth","pointerHeight"],zc="Change.konva",Fc="none",ki="up",Ti="right",Ei="down",Pi="left",Gc=$r.length;class Ni extends Yt{constructor(e){super(e),this.on("add.konva",function(t){this._addListeners(t.child),this._sync()})}getText(){return this.find("Text")[0]}getTag(){return this.find("Tag")[0]}_addListeners(e){let t=this,i;const s=function(){t._sync()};for(i=0;i<Gc;i++)e.on($r[i]+zc,s)}getWidth(){return this.getText().width()}getHeight(){return this.getText().height()}_sync(){let e=this.getText(),t=this.getTag(),i,s,r,a,l,o,c;if(e&&t){switch(i=e.width(),s=e.height(),r=t.pointerDirection(),a=t.pointerWidth(),c=t.pointerHeight(),l=0,o=0,r){case ki:l=i/2,o=-1*c;break;case Ti:l=i+a,o=s/2;break;case Ei:l=i/2,o=s+c;break;case Pi:l=-1*a,o=s/2;break}t.setAttrs({x:-1*l,y:-1*o,width:i,height:s}),e.setAttrs({x:-1*l,y:-1*o})}}}Ni.prototype.className="Label";Be(Ni);class zt extends J{_sceneFunc(e){const t=this.width(),i=this.height(),s=this.pointerDirection(),r=this.pointerWidth(),a=this.pointerHeight(),l=this.cornerRadius();let o=0,c=0,d=0,h=0;typeof l=="number"?o=c=d=h=Math.min(l,t/2,i/2):(o=Math.min(l[0]||0,t/2,i/2),c=Math.min(l[1]||0,t/2,i/2),h=Math.min(l[2]||0,t/2,i/2),d=Math.min(l[3]||0,t/2,i/2)),e.beginPath(),e.moveTo(o,0),s===ki&&(e.lineTo((t-r)/2,0),e.lineTo(t/2,-1*a),e.lineTo((t+r)/2,0)),e.lineTo(t-c,0),e.arc(t-c,c,c,Math.PI*3/2,0,!1),s===Ti&&(e.lineTo(t,(i-a)/2),e.lineTo(t+r,i/2),e.lineTo(t,(i+a)/2)),e.lineTo(t,i-h),e.arc(t-h,i-h,h,0,Math.PI/2,!1),s===Ei&&(e.lineTo((t+r)/2,i),e.lineTo(t/2,i+a),e.lineTo((t-r)/2,i)),e.lineTo(d,i),e.arc(d,i-d,d,Math.PI/2,Math.PI,!1),s===Pi&&(e.lineTo(0,(i+a)/2),e.lineTo(-1*r,i/2),e.lineTo(0,(i-a)/2)),e.lineTo(0,o),e.arc(o,o,o,Math.PI,Math.PI*3/2,!1),e.closePath(),e.fillStrokeShape(this)}getSelfRect(){let e=0,t=0,i=this.pointerWidth(),s=this.pointerHeight(),r=this.pointerDirection(),a=this.width(),l=this.height();return r===ki?(t-=s,l+=s):r===Ei?l+=s:r===Pi?(e-=i*1.5,a+=i):r===Ti&&(a+=i*1.5),{x:e,y:t,width:a,height:l}}}zt.prototype.className="Tag";Be(zt);k.addGetterSetter(zt,"pointerDirection",Fc);k.addGetterSetter(zt,"pointerWidth",0,re());k.addGetterSetter(zt,"pointerHeight",0,re());k.addGetterSetter(zt,"cornerRadius",0,Kn(4));class yn extends J{_sceneFunc(e){const t=this.cornerRadius(),i=this.width(),s=this.height();e.beginPath(),t?F.drawRoundedRectPath(e,i,s,t):e.rect(0,0,i,s),e.closePath(),e.fillStrokeShape(this)}}yn.prototype.className="Rect";Be(yn);k.addGetterSetter(yn,"cornerRadius",0,Kn(4));class Tt extends J{_sceneFunc(e){const t=this._getPoints(),i=this.radius(),s=this.sides(),r=this.cornerRadius();if(e.beginPath(),r)F.drawRoundedPolygonPath(e,t,s,i,r);else{e.moveTo(t[0].x,t[0].y);for(let a=1;a<t.length;a++)e.lineTo(t[a].x,t[a].y)}e.closePath(),e.fillStrokeShape(this)}_getPoints(){const e=this.attrs.sides,t=this.attrs.radius||0,i=[];for(let s=0;s<e;s++)i.push({x:t*Math.sin(s*2*Math.PI/e),y:-1*t*Math.cos(s*2*Math.PI/e)});return i}getSelfRect(){const e=this._getPoints();let t=e[0].x,i=e[0].y,s=e[0].x,r=e[0].y;return e.forEach(a=>{t=Math.min(t,a.x),i=Math.max(i,a.x),s=Math.min(s,a.y),r=Math.max(r,a.y)}),{x:t,y:s,width:i-t,height:r-s}}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius(e/2)}setHeight(e){this.radius(e/2)}}Tt.prototype.className="RegularPolygon";Tt.prototype._centroid=!0;Tt.prototype._attrsAffectingSize=["radius"];Be(Tt);k.addGetterSetter(Tt,"radius",0,re());k.addGetterSetter(Tt,"sides",0,re());k.addGetterSetter(Tt,"cornerRadius",0,Kn(4));const _s=Math.PI*2;class Ft extends J{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.innerRadius(),0,_s,!1),e.moveTo(this.outerRadius(),0),e.arc(0,0,this.outerRadius(),_s,0,!0),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}}Ft.prototype.className="Ring";Ft.prototype._centroid=!0;Ft.prototype._attrsAffectingSize=["innerRadius","outerRadius"];Be(Ft);k.addGetterSetter(Ft,"innerRadius",0,re());k.addGetterSetter(Ft,"outerRadius",0,re());class dt extends J{constructor(e){super(e),this._updated=!0,this.anim=new nt(()=>{const t=this._updated;return this._updated=!1,t}),this.on("animationChange.konva",function(){this.frameIndex(0)}),this.on("frameIndexChange.konva",function(){this._updated=!0}),this.on("frameRateChange.konva",function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())})}_sceneFunc(e){const t=this.animation(),i=this.frameIndex(),s=i*4,r=this.animations()[t],a=this.frameOffsets(),l=r[s+0],o=r[s+1],c=r[s+2],d=r[s+3],h=this.image();if((this.hasFill()||this.hasStroke())&&(e.beginPath(),e.rect(0,0,c,d),e.closePath(),e.fillStrokeShape(this)),h)if(a){const u=a[t],v=i*2;e.drawImage(h,l,o,c,d,u[v+0],u[v+1],c,d)}else e.drawImage(h,l,o,c,d,0,0,c,d)}_hitFunc(e){const t=this.animation(),i=this.frameIndex(),s=i*4,r=this.animations()[t],a=this.frameOffsets(),l=r[s+2],o=r[s+3];if(e.beginPath(),a){const c=a[t],d=i*2;e.rect(c[d+0],c[d+1],l,o)}else e.rect(0,0,l,o);e.closePath(),e.fillShape(this)}_useBufferCanvas(){return super._useBufferCanvas(!0)}_setInterval(){const e=this;this.interval=setInterval(function(){e._updateIndex()},1e3/this.frameRate())}start(){if(this.isRunning())return;const e=this.getLayer();this.anim.setLayers(e),this._setInterval(),this.anim.start()}stop(){this.anim.stop(),clearInterval(this.interval)}isRunning(){return this.anim.isRunning()}_updateIndex(){const e=this.frameIndex(),t=this.animation(),i=this.animations(),s=i[t],r=s.length/4;e<r-1?this.frameIndex(e+1):this.frameIndex(0)}}dt.prototype.className="Sprite";Be(dt);k.addGetterSetter(dt,"animation");k.addGetterSetter(dt,"animations");k.addGetterSetter(dt,"frameOffsets");k.addGetterSetter(dt,"image");k.addGetterSetter(dt,"frameIndex",0,re());k.addGetterSetter(dt,"frameRate",17,re());k.backCompat(dt,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"});class Et extends J{_sceneFunc(e){const t=this.innerRadius(),i=this.outerRadius(),s=this.numPoints();e.beginPath(),e.moveTo(0,0-i);for(let r=1;r<s*2;r++){const a=r%2===0?i:t,l=a*Math.sin(r*Math.PI/s),o=-1*a*Math.cos(r*Math.PI/s);e.lineTo(l,o)}e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(e){this.outerRadius(e/2)}setHeight(e){this.outerRadius(e/2)}}Et.prototype.className="Star";Et.prototype._centroid=!0;Et.prototype._attrsAffectingSize=["innerRadius","outerRadius"];Be(Et);k.addGetterSetter(Et,"numPoints",5,re());k.addGetterSetter(Et,"innerRadius",0,re());k.addGetterSetter(Et,"outerRadius",0,re());function _t(n){return[...n].reduce((e,t,i,s)=>{if(new RegExp("\\p{Emoji}","u").test(t)){const r=s[i+1];r&&new RegExp("\\p{Emoji_Modifier}|\\u200D","u").test(r)?(e.push(t+r),s[i+1]=""):e.push(t)}else new RegExp("\\p{Regional_Indicator}{2}","u").test(t+(s[i+1]||""))?e.push(t+s[i+1]):i>0&&new RegExp("\\p{Mn}|\\p{Me}|\\p{Mc}","u").test(t)?e[e.length-1]+=t:t&&e.push(t);return e},[])}const Ut="auto",Bc="center",Cr="inherit",Ht="justify",Uc="Change.konva",Hc="2d",xs="-",kr="left",qc="text",Wc="Text",jc="top",Yc="bottom",Ss="middle",Tr="normal",Vc="px ",An=" ",Xc="right",ws="rtl",Qc="word",Kc="char",$s="none",hi="…",Er=["direction","fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],Jc=Er.length;function Zc(n){return n.split(",").map(e=>{e=e.trim();const t=e.indexOf(" ")>=0,i=e.indexOf('"')>=0||e.indexOf("'")>=0;return t&&!i&&(e=`"${e}"`),e}).join(", ")}let Rn;function ui(){return Rn||(Rn=F.createCanvasElement().getContext(Hc),Rn)}function ed(n){n.fillText(this._partialText,this._partialTextX,this._partialTextY)}function td(n){n.setAttr("miterLimit",2),n.strokeText(this._partialText,this._partialTextX,this._partialTextY)}function nd(n){return n=n||{},!n.fillLinearGradientColorStops&&!n.fillRadialGradientColorStops&&!n.fillPatternImage&&(n.fill=n.fill||"black"),n}class Fe extends J{constructor(e){super(nd(e)),this._partialTextX=0,this._partialTextY=0;for(let t=0;t<Jc;t++)this.on(Er[t]+Uc,this._setTextData);this._setTextData()}_sceneFunc(e){var t,i;const s=this.textArr,r=s.length;if(!this.text())return;let a=this.padding(),l=this.fontSize(),o=this.lineHeight()*l,c=this.verticalAlign(),d=this.direction(),h=0,u=this.align(),v=this.getWidth(),f=this.letterSpacing(),p=this.charRenderFunc(),b=this.fill(),m=this.textDecoration(),_=m.indexOf("underline")!==-1,w=m.indexOf("line-through")!==-1,x;d=d===Cr?e.direction:d;let C=o/2,A=Ss;if(!le.legacyTextRendering){const M=this.measureSize("M");A="alphabetic";const I=(t=M.fontBoundingBoxAscent)!==null&&t!==void 0?t:M.actualBoundingBoxAscent,z=(i=M.fontBoundingBoxDescent)!==null&&i!==void 0?i:M.actualBoundingBoxDescent;C=(I-z)/2+o/2}for(d===ws&&e.setAttr("direction",d),e.setAttr("font",this._getContextFont()),e.setAttr("textBaseline",A),e.setAttr("textAlign",kr),c===Ss?h=(this.getHeight()-r*o-a*2)/2:c===Yc&&(h=this.getHeight()-r*o-a*2),e.translate(a,h+a),x=0;x<r;x++){let M=0,I=0;const z=s[x],E=z.text,R=z.width,T=z.lastInParagraph;if(e.save(),u===Xc?M+=v-R-a*2:u===Bc&&(M+=(v-R-a*2)/2),_){e.save(),e.beginPath();const U=le.legacyTextRendering?Math.round(l/2):Math.round(l/4),N=M,$=C+I+U;e.moveTo(N,$);const P=u===Ht&&!T?v-a*2:R;e.lineTo(N+Math.round(P),$),e.lineWidth=l/15;const Q=this._getLinearGradient();e.strokeStyle=Q||b,e.stroke(),e.restore()}if(d!==ws&&(f!==0||u===Ht||p)){const U=E.split(" ").length-1,N=_t(E);for(let $=0;$<N.length;$++){const P=N[$];if(P===" "&&!T&&u===Ht&&(M+=(v-a*2-R)/U),this._partialTextX=M,this._partialTextY=C+I,this._partialText=P,p){e.save();const G=s.slice(0,x).reduce((V,q)=>V+_t(q.text).length,0),D=$+G;p({char:P,index:D,x:M,y:C+I,lineIndex:x,column:$,isLastInLine:T,width:this.measureSize(P).width,context:e})}e.fillStrokeShape(this),p&&e.restore(),M+=this.measureSize(P).width+f}}else f!==0&&e.setAttr("letterSpacing",`${f}px`),this._partialTextX=M,this._partialTextY=C+I,this._partialText=E,e.fillStrokeShape(this);if(w){e.save(),e.beginPath();const U=le.legacyTextRendering?0:-Math.round(l/4),N=u===Ht?0:M;e.moveTo(N,C+I+U);const $=u===Ht&&!T?v-a*2:R;e.lineTo(N+Math.round($),C+I+U),e.lineWidth=l/15;const P=this._getLinearGradient();e.strokeStyle=P||b,e.stroke(),e.restore()}e.restore(),r>1&&(C+=o)}}_hitFunc(e){const t=this.getWidth(),i=this.getHeight();e.beginPath(),e.rect(0,0,t,i),e.closePath(),e.fillStrokeShape(this)}setText(e){const t=F._isString(e)?e:e==null?"":e+"";return this._setAttr(qc,t),this}getWidth(){return this.attrs.width===Ut||this.attrs.width===void 0?this.getTextWidth()+this.padding()*2:this.attrs.width}getHeight(){return this.attrs.height===Ut||this.attrs.height===void 0?this.fontSize()*this.textArr.length*this.lineHeight()+this.padding()*2:this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return F.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(e){var t,i,s,r,a,l,o,c,d,h,u;let v=ui(),f=this.fontSize(),p;v.save(),v.font=this._getContextFont(),p=v.measureText(e),v.restore();const b=f/100;return{actualBoundingBoxAscent:(t=p.actualBoundingBoxAscent)!==null&&t!==void 0?t:71.58203125*b,actualBoundingBoxDescent:(i=p.actualBoundingBoxDescent)!==null&&i!==void 0?i:0,actualBoundingBoxLeft:(s=p.actualBoundingBoxLeft)!==null&&s!==void 0?s:-7.421875*b,actualBoundingBoxRight:(r=p.actualBoundingBoxRight)!==null&&r!==void 0?r:75.732421875*b,alphabeticBaseline:(a=p.alphabeticBaseline)!==null&&a!==void 0?a:0,emHeightAscent:(l=p.emHeightAscent)!==null&&l!==void 0?l:100*b,emHeightDescent:(o=p.emHeightDescent)!==null&&o!==void 0?o:-20*b,fontBoundingBoxAscent:(c=p.fontBoundingBoxAscent)!==null&&c!==void 0?c:91*b,fontBoundingBoxDescent:(d=p.fontBoundingBoxDescent)!==null&&d!==void 0?d:21*b,hangingBaseline:(h=p.hangingBaseline)!==null&&h!==void 0?h:72.80000305175781*b,ideographicBaseline:(u=p.ideographicBaseline)!==null&&u!==void 0?u:-21*b,width:p.width,height:f}}_getContextFont(){return this.fontStyle()+An+this.fontVariant()+An+(this.fontSize()+Vc)+Zc(this.fontFamily())}_addTextLine(e){this.align()===Ht&&(e=e.trim());const i=this._getTextWidth(e);return this.textArr.push({text:e,width:i,lastInParagraph:!1})}_getTextWidth(e){const t=this.letterSpacing(),i=e.length;return ui().measureText(e).width+t*i}_setTextData(){let e=this.text().split(`
`),t=+this.fontSize(),i=0,s=this.lineHeight()*t,r=this.attrs.width,a=this.attrs.height,l=r!==Ut&&r!==void 0,o=a!==Ut&&a!==void 0,c=this.padding(),d=r-c*2,h=a-c*2,u=0,v=this.wrap(),f=v!==$s,p=v!==Kc&&f,b=this.ellipsis();this.textArr=[],ui().font=this._getContextFont();const m=b?this._getTextWidth(hi):0;for(let _=0,w=e.length;_<w;++_){let x=e[_],C=this._getTextWidth(x);if(l&&C>d)for(;x.length>0;){let A=0,M=_t(x).length,I="",z=0;for(;A<M;){const E=A+M>>>1,R=_t(x),T=R.slice(0,E+1).join(""),U=this._getTextWidth(T);(b&&o&&u+s>h?U+m:U)<=d?(A=E+1,I=T,z=U):M=E}if(I){if(p){const T=_t(x),U=_t(I),N=T[U.length],$=N===An||N===xs;let P;if($&&z<=d)P=U.length;else{const Q=U.lastIndexOf(An),G=U.lastIndexOf(xs);P=Math.max(Q,G)+1}P>0&&(A=P,I=T.slice(0,A).join(""),z=this._getTextWidth(I))}if(I=I.trimRight(),this._addTextLine(I),i=Math.max(i,z),u+=s,this._shouldHandleEllipsis(u)){this._tryToAddEllipsisToLastLine();break}if(x=_t(x).slice(A).join("").trimLeft(),x.length>0&&(C=this._getTextWidth(x),C<=d)){this._addTextLine(x),u+=s,i=Math.max(i,C);break}}else break}else this._addTextLine(x),u+=s,i=Math.max(i,C),this._shouldHandleEllipsis(u)&&_<w-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),o&&u+s>h)break}this.textHeight=t,this.textWidth=i}_shouldHandleEllipsis(e){const t=+this.fontSize(),i=this.lineHeight()*t,s=this.attrs.height,r=s!==Ut&&s!==void 0,a=this.padding(),l=s-a*2;return!(this.wrap()!==$s)||r&&e+i>l}_tryToAddEllipsisToLastLine(){const e=this.attrs.width,t=e!==Ut&&e!==void 0,i=this.padding(),s=e-i*2,r=this.ellipsis(),a=this.textArr[this.textArr.length-1];!a||!r||(t&&(this._getTextWidth(a.text+hi)<s||(a.text=a.text.slice(0,a.text.length-3))),this.textArr.splice(this.textArr.length-1,1),this._addTextLine(a.text+hi))}getStrokeScaleEnabled(){return!0}_useBufferCanvas(){const e=this.textDecoration().indexOf("underline")!==-1||this.textDecoration().indexOf("line-through")!==-1,t=this.hasShadow();return e&&t?!0:super._useBufferCanvas()}}Fe.prototype._fillFunc=ed;Fe.prototype._strokeFunc=td;Fe.prototype.className=Wc;Fe.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"];Be(Fe);k.overWriteSetter(Fe,"width",Di());k.overWriteSetter(Fe,"height",Di());k.addGetterSetter(Fe,"direction",Cr);k.addGetterSetter(Fe,"fontFamily","Arial");k.addGetterSetter(Fe,"fontSize",12,re());k.addGetterSetter(Fe,"fontStyle",Tr);k.addGetterSetter(Fe,"fontVariant",Tr);k.addGetterSetter(Fe,"padding",0,re());k.addGetterSetter(Fe,"align",kr);k.addGetterSetter(Fe,"verticalAlign",jc);k.addGetterSetter(Fe,"lineHeight",1,re());k.addGetterSetter(Fe,"wrap",Qc);k.addGetterSetter(Fe,"ellipsis",!1,at());k.addGetterSetter(Fe,"letterSpacing",0,re());k.addGetterSetter(Fe,"text","",Ot());k.addGetterSetter(Fe,"textDecoration","");k.addGetterSetter(Fe,"charRenderFunc",void 0);const id="",Pr="normal";function Ar(n){n.fillText(this.partialText,0,0)}function Rr(n){n.strokeText(this.partialText,0,0)}class qe extends J{constructor(e){super(e),this.dummyCanvas=F.createCanvasElement(),this.dataArray=[],this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute(),this._setTextData()}),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_getTextPathLength(){return ze.getPathLength(this.dataArray)}_getPointAtLength(e){if(!this.attrs.data)return null;const t=this.pathLength;return e>t?null:ze.getPointAtLengthOfDataArray(e,this.dataArray)}_readDataAttribute(){this.dataArray=ze.parsePathData(this.attrs.data),this.pathLength=this._getTextPathLength()}_sceneFunc(e){e.setAttr("font",this._getContextFont()),e.setAttr("textBaseline",this.textBaseline()),e.setAttr("textAlign","left"),e.save();const t=this.textDecoration(),i=this.fill(),s=this.fontSize(),r=this.glyphInfo;t==="underline"&&e.beginPath();for(let a=0;a<r.length;a++){e.save();const l=r[a].p0;e.translate(l.x,l.y),e.rotate(r[a].rotation),this.partialText=r[a].text,e.fillStrokeShape(this),t==="underline"&&(a===0&&e.moveTo(0,s/2+1),e.lineTo(s,s/2+1)),e.restore()}t==="underline"&&(e.strokeStyle=i,e.lineWidth=s/20,e.stroke()),e.restore()}_hitFunc(e){e.beginPath();const t=this.glyphInfo;if(t.length>=1){const i=t[0].p0;e.moveTo(i.x,i.y)}for(let i=0;i<t.length;i++){const s=t[i].p1;e.lineTo(s.x,s.y)}e.setAttr("lineWidth",this.fontSize()),e.setAttr("strokeStyle",this.colorKey),e.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return F.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(e){return Fe.prototype.setText.call(this,e)}_getContextFont(){return Fe.prototype._getContextFont.call(this)}_getTextSize(e){const i=this.dummyCanvas.getContext("2d");i.save(),i.font=this._getContextFont();const s=i.measureText(e);return i.restore(),{width:s.width,height:parseInt(`${this.fontSize()}`,10)}}_setTextData(){const e=_t(this.text()),t=[];let i=0;for(let h=0;h<e.length;h++)t.push({char:e[h],width:this._getTextSize(e[h]).width}),i+=t[h].width;const{height:s}=this._getTextSize(this.attrs.text);if(this.textWidth=i,this.textHeight=s,this.glyphInfo=[],!this.attrs.data)return null;const r=this.letterSpacing(),a=this.align(),l=this.kerningFunc(),o=Math.max(this.textWidth+((this.attrs.text||"").length-1)*r,0);let c=0;a==="center"&&(c=Math.max(0,this.pathLength/2-o/2)),a==="right"&&(c=Math.max(0,this.pathLength-o));let d=c;for(let h=0;h<t.length;h++){const u=this._getPointAtLength(d);if(!u)return;const v=t[h].char;let f=t[h].width+r;if(v===" "&&a==="justify"){const x=this.text().split(" ").length-1;f+=(this.pathLength-o)/x}const p=this._getPointAtLength(d+f);if(!p)return;const b=ze.getLineLength(u.x,u.y,p.x,p.y);let m=0;if(l)try{m=l(t[h-1].char,v)*this.fontSize()}catch{m=0}u.x+=m,p.x+=m,this.textWidth+=m;const _=ze.getPointOnLine(m+b/2,u.x,u.y,p.x,p.y),w=Math.atan2(p.y-u.y,p.x-u.x);this.glyphInfo.push({transposeX:_.x,transposeY:_.y,text:e[h],rotation:w,p0:u,p1:p}),d+=f}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};const e=[];this.glyphInfo.forEach(function(c){e.push(c.p0.x),e.push(c.p0.y),e.push(c.p1.x),e.push(c.p1.y)});let t=e[0]||0,i=e[0]||0,s=e[1]||0,r=e[1]||0,a,l;for(let c=0;c<e.length/2;c++)a=e[c*2],l=e[c*2+1],t=Math.min(t,a),i=Math.max(i,a),s=Math.min(s,l),r=Math.max(r,l);const o=this.fontSize();return{x:t-o/2,y:s-o/2,width:i-t+o,height:r-s+o}}destroy(){return F.releaseCanvas(this.dummyCanvas),super.destroy()}}qe.prototype._fillFunc=Ar;qe.prototype._strokeFunc=Rr;qe.prototype._fillFuncHit=Ar;qe.prototype._strokeFuncHit=Rr;qe.prototype.className="TextPath";qe.prototype._attrsAffectingSize=["text","fontSize","data"];Be(qe);k.addGetterSetter(qe,"data");k.addGetterSetter(qe,"fontFamily","Arial");k.addGetterSetter(qe,"fontSize",12,re());k.addGetterSetter(qe,"fontStyle",Pr);k.addGetterSetter(qe,"align","left");k.addGetterSetter(qe,"letterSpacing",0,re());k.addGetterSetter(qe,"textBaseline","middle");k.addGetterSetter(qe,"fontVariant",Pr);k.addGetterSetter(qe,"text",id);k.addGetterSetter(qe,"textDecoration","");k.addGetterSetter(qe,"kerningFunc",void 0);const Lr="tr-konva",sd=["resizeEnabledChange","rotateAnchorOffsetChange","rotateEnabledChange","enabledAnchorsChange","anchorSizeChange","borderEnabledChange","borderStrokeChange","borderStrokeWidthChange","borderDashChange","anchorStrokeChange","anchorStrokeWidthChange","anchorFillChange","anchorCornerRadiusChange","ignoreStrokeChange","anchorStyleFuncChange"].map(n=>n+`.${Lr}`).join(" "),Cs="nodesRect",rd=["widthChange","heightChange","scaleXChange","scaleYChange","skewXChange","skewYChange","rotationChange","offsetXChange","offsetYChange","transformsEnabledChange","strokeWidthChange","draggableChange"],ad={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135},ld="ontouchstart"in le._global;function od(n,e,t){if(n==="rotater")return t;e+=F.degToRad(ad[n]||0);const i=(F.radToDeg(e)%360+360)%360;return F._inRange(i,315+22.5,360)||F._inRange(i,0,22.5)?"ns-resize":F._inRange(i,45-22.5,45+22.5)?"nesw-resize":F._inRange(i,90-22.5,90+22.5)?"ew-resize":F._inRange(i,135-22.5,135+22.5)?"nwse-resize":F._inRange(i,180-22.5,180+22.5)?"ns-resize":F._inRange(i,225-22.5,225+22.5)?"nesw-resize":F._inRange(i,270-22.5,270+22.5)?"ew-resize":F._inRange(i,315-22.5,315+22.5)?"nwse-resize":(F.error("Transformer has unknown angle for cursor detection: "+i),"pointer")}const jn=["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"];function cd(n){return{x:n.x+n.width/2*Math.cos(n.rotation)+n.height/2*Math.sin(-n.rotation),y:n.y+n.height/2*Math.cos(n.rotation)+n.width/2*Math.sin(n.rotation)}}function Mr(n,e,t){const i=t.x+(n.x-t.x)*Math.cos(e)-(n.y-t.y)*Math.sin(e),s=t.y+(n.x-t.x)*Math.sin(e)+(n.y-t.y)*Math.cos(e);return{...n,rotation:n.rotation+e,x:i,y:s}}function dd(n,e){const t=cd(n);return Mr(n,e,t)}function hd(n,e,t){let i=e;for(let s=0;s<n.length;s++){const r=le.getAngle(n[s]),a=Math.abs(r-e)%(Math.PI*2);Math.min(a,Math.PI*2-a)<t&&(i=r)}return i}let Ai=0;class Ee extends Yt{constructor(e){super(e),this._movingAnchorName=null,this._transforming=!1,this._createElements(),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.update=this.update.bind(this),this.on(sd,this.update),this.getNode()&&this.update()}attachTo(e){return this.setNode(e),this}setNode(e){return F.warn("tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead."),this.setNodes([e])}getNode(){return this._nodes&&this._nodes[0]}_getEventNamespace(){return Lr+this._id}setNodes(e=[]){this._nodes&&this._nodes.length&&this.detach();const t=e.filter(s=>s.isAncestorOf(this)?(F.error("Konva.Transformer cannot be an a child of the node you are trying to attach"),!1):!0);return this._nodes=e=t,e.length===1&&this.useSingleNodeRotation()?this.rotation(e[0].getAbsoluteRotation()):this.rotation(0),this._nodes.forEach(s=>{const r=()=>{this.nodes().length===1&&this.useSingleNodeRotation()&&this.rotation(this.nodes()[0].getAbsoluteRotation()),this._resetTransformCache(),!this._transforming&&!this.isDragging()&&this.update()};if(s._attrsAffectingSize.length){const a=s._attrsAffectingSize.map(l=>l+"Change."+this._getEventNamespace()).join(" ");s.on(a,r)}s.on(rd.map(a=>a+`.${this._getEventNamespace()}`).join(" "),r),s.on(`absoluteTransformChange.${this._getEventNamespace()}`,r),this._proxyDrag(s)}),this._resetTransformCache(),!!this.findOne(".top-left")&&this.update(),this}_proxyDrag(e){let t;e.on(`dragstart.${this._getEventNamespace()}`,i=>{t=e.getAbsolutePosition(),!this.isDragging()&&e!==this.findOne(".back")&&this.startDrag(i,!1)}),e.on(`dragmove.${this._getEventNamespace()}`,i=>{if(!t)return;const s=e.getAbsolutePosition(),r=s.x-t.x,a=s.y-t.y;this.nodes().forEach(l=>{if(l===e||l.isDragging())return;const o=l.getAbsolutePosition();l.setAbsolutePosition({x:o.x+r,y:o.y+a}),l.startDrag(i)}),t=null})}getNodes(){return this._nodes||[]}getActiveAnchor(){return this._movingAnchorName}detach(){this._nodes&&this._nodes.forEach(e=>{e.off("."+this._getEventNamespace())}),this._nodes=[],this._resetTransformCache()}_resetTransformCache(){this._clearCache(Cs),this._clearCache("transform"),this._clearSelfAndDescendantCache("absoluteTransform")}_getNodeRect(){return this._getCache(Cs,this.__getNodeRect)}__getNodeShape(e,t=this.rotation(),i){const s=e.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),r=e.getAbsoluteScale(i),a=e.getAbsolutePosition(i),l=s.x*r.x-e.offsetX()*r.x,o=s.y*r.y-e.offsetY()*r.y,c=(le.getAngle(e.getAbsoluteRotation())+Math.PI*2)%(Math.PI*2),d={x:a.x+l*Math.cos(c)+o*Math.sin(-c),y:a.y+o*Math.cos(c)+l*Math.sin(c),width:s.width*r.x,height:s.height*r.y,rotation:c};return Mr(d,-le.getAngle(t),{x:0,y:0})}__getNodeRect(){if(!this.getNode())return{x:-1e8,y:-1e8,width:0,height:0,rotation:0};const t=[];this.nodes().map(c=>{const d=c.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),h=[{x:d.x,y:d.y},{x:d.x+d.width,y:d.y},{x:d.x+d.width,y:d.y+d.height},{x:d.x,y:d.y+d.height}],u=c.getAbsoluteTransform();h.forEach(function(v){const f=u.point(v);t.push(f)})});const i=new Ke;i.rotate(-le.getAngle(this.rotation()));let s=1/0,r=1/0,a=-1/0,l=-1/0;t.forEach(function(c){const d=i.point(c);s===void 0&&(s=a=d.x,r=l=d.y),s=Math.min(s,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y)}),i.invert();const o=i.point({x:s,y:r});return{x:o.x,y:o.y,width:a-s,height:l-r,rotation:le.getAngle(this.rotation())}}getX(){return this._getNodeRect().x}getY(){return this._getNodeRect().y}getWidth(){return this._getNodeRect().width}getHeight(){return this._getNodeRect().height}_createElements(){this._createBack(),jn.forEach(e=>{this._createAnchor(e)}),this._createAnchor("rotater")}_createAnchor(e){const t=new yn({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:e+" _anchor",dragDistance:0,draggable:!0,hitStrokeWidth:ld?10:"auto"}),i=this;t.on("mousedown touchstart",function(s){i._handleMouseDown(s)}),t.on("dragstart",s=>{t.stopDrag(),s.cancelBubble=!0}),t.on("dragend",s=>{s.cancelBubble=!0}),t.on("mouseenter",()=>{const s=le.getAngle(this.rotation()),r=this.rotateAnchorCursor(),a=od(e,s,r);t.getStage().content&&(t.getStage().content.style.cursor=a),this._cursorChange=!0}),t.on("mouseout",()=>{t.getStage().content&&(t.getStage().content.style.cursor=""),this._cursorChange=!1}),this.add(t)}_createBack(){const e=new J({name:"back",width:0,height:0,sceneFunc(t,i){const s=i.getParent(),r=s.padding();t.beginPath(),t.rect(-r,-r,i.width()+r*2,i.height()+r*2),t.moveTo(i.width()/2,-r),s.rotateEnabled()&&s.rotateLineVisible()&&t.lineTo(i.width()/2,-s.rotateAnchorOffset()*F._sign(i.height())-r),t.fillStrokeShape(i)},hitFunc:(t,i)=>{if(!this.shouldOverdrawWholeArea())return;const s=this.padding();t.beginPath(),t.rect(-s,-s,i.width()+s*2,i.height()+s*2),t.fillStrokeShape(i)}});this.add(e),this._proxyDrag(e),e.on("dragstart",t=>{t.cancelBubble=!0}),e.on("dragmove",t=>{t.cancelBubble=!0}),e.on("dragend",t=>{t.cancelBubble=!0}),this.on("dragmove",t=>{this.update()})}_handleMouseDown(e){if(this._transforming)return;this._movingAnchorName=e.target.name().split(" ")[0];const t=this._getNodeRect(),i=t.width,s=t.height,r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2));this.sin=Math.abs(s/r),this.cos=Math.abs(i/r),typeof window<"u"&&(window.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("touchmove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp,!0),window.addEventListener("touchend",this._handleMouseUp,!0)),this._transforming=!0;const a=e.target.getAbsolutePosition(),l=e.target.getStage().getPointerPosition();this._anchorDragOffset={x:l.x-a.x,y:l.y-a.y},Ai++,this._fire("transformstart",{evt:e.evt,target:this.getNode()}),this._nodes.forEach(o=>{o._fire("transformstart",{evt:e.evt,target:o})})}_handleMouseMove(e){let t,i,s;const r=this.findOne("."+this._movingAnchorName),a=r.getStage();a.setPointersPositions(e);const l=a.getPointerPosition();let o={x:l.x-this._anchorDragOffset.x,y:l.y-this._anchorDragOffset.y};const c=r.getAbsolutePosition();this.anchorDragBoundFunc()&&(o=this.anchorDragBoundFunc()(c,o,e)),r.setAbsolutePosition(o);const d=r.getAbsolutePosition();if(c.x===d.x&&c.y===d.y)return;if(this._movingAnchorName==="rotater"){const _=this._getNodeRect();t=r.x()-_.width/2,i=-r.y()+_.height/2;let w=Math.atan2(-i,t)+Math.PI/2;_.height<0&&(w-=Math.PI);const C=le.getAngle(this.rotation())+w,A=le.getAngle(this.rotationSnapTolerance()),I=hd(this.rotationSnaps(),C,A)-_.rotation,z=dd(_,I);this._fitNodesInto(z,e);return}const h=this.shiftBehavior();let u;h==="inverted"?u=this.keepRatio()&&!e.shiftKey:h==="none"?u=this.keepRatio():u=this.keepRatio()||e.shiftKey;let v=this.centeredScaling()||e.altKey;if(this._movingAnchorName==="top-left"){if(u){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()};s=Math.sqrt(Math.pow(_.x-r.x(),2)+Math.pow(_.y-r.y(),2));const w=this.findOne(".top-left").x()>_.x?-1:1,x=this.findOne(".top-left").y()>_.y?-1:1;t=s*this.cos*w,i=s*this.sin*x,this.findOne(".top-left").x(_.x-t),this.findOne(".top-left").y(_.y-i)}}else if(this._movingAnchorName==="top-center")this.findOne(".top-left").y(r.y());else if(this._movingAnchorName==="top-right"){if(u){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()};s=Math.sqrt(Math.pow(r.x()-_.x,2)+Math.pow(_.y-r.y(),2));const w=this.findOne(".top-right").x()<_.x?-1:1,x=this.findOne(".top-right").y()>_.y?-1:1;t=s*this.cos*w,i=s*this.sin*x,this.findOne(".top-right").x(_.x+t),this.findOne(".top-right").y(_.y-i)}var f=r.position();this.findOne(".top-left").y(f.y),this.findOne(".bottom-right").x(f.x)}else if(this._movingAnchorName==="middle-left")this.findOne(".top-left").x(r.x());else if(this._movingAnchorName==="middle-right")this.findOne(".bottom-right").x(r.x());else if(this._movingAnchorName==="bottom-left"){if(u){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()};s=Math.sqrt(Math.pow(_.x-r.x(),2)+Math.pow(r.y()-_.y,2));const w=_.x<r.x()?-1:1,x=r.y()<_.y?-1:1;t=s*this.cos*w,i=s*this.sin*x,r.x(_.x-t),r.y(_.y+i)}f=r.position(),this.findOne(".top-left").x(f.x),this.findOne(".bottom-right").y(f.y)}else if(this._movingAnchorName==="bottom-center")this.findOne(".bottom-right").y(r.y());else if(this._movingAnchorName==="bottom-right"){if(u){const _=v?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()};s=Math.sqrt(Math.pow(r.x()-_.x,2)+Math.pow(r.y()-_.y,2));const w=this.findOne(".bottom-right").x()<_.x?-1:1,x=this.findOne(".bottom-right").y()<_.y?-1:1;t=s*this.cos*w,i=s*this.sin*x,this.findOne(".bottom-right").x(_.x+t),this.findOne(".bottom-right").y(_.y+i)}}else console.error(new Error("Wrong position argument of selection resizer: "+this._movingAnchorName));if(v=this.centeredScaling()||e.altKey,v){const _=this.findOne(".top-left"),w=this.findOne(".bottom-right"),x=_.x(),C=_.y(),A=this.getWidth()-w.x(),M=this.getHeight()-w.y();w.move({x:-x,y:-C}),_.move({x:A,y:M})}const p=this.findOne(".top-left").getAbsolutePosition();t=p.x,i=p.y;const b=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),m=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodesInto({x:t,y:i,width:b,height:m,rotation:le.getAngle(this.rotation())},e)}_handleMouseUp(e){this._removeEvents(e)}getAbsoluteTransform(){return this.getTransform()}_removeEvents(e){var t;if(this._transforming){this._transforming=!1,typeof window<"u"&&(window.removeEventListener("mousemove",this._handleMouseMove),window.removeEventListener("touchmove",this._handleMouseMove),window.removeEventListener("mouseup",this._handleMouseUp,!0),window.removeEventListener("touchend",this._handleMouseUp,!0));const i=this.getNode();Ai--,this._fire("transformend",{evt:e,target:i}),(t=this.getLayer())===null||t===void 0||t.batchDraw(),i&&this._nodes.forEach(s=>{var r;s._fire("transformend",{evt:e,target:s}),(r=s.getLayer())===null||r===void 0||r.batchDraw()}),this._movingAnchorName=null}}_fitNodesInto(e,t){const i=this._getNodeRect(),s=1;if(F._inRange(e.width,-this.padding()*2-s,s)){this.update();return}if(F._inRange(e.height,-this.padding()*2-s,s)){this.update();return}const r=new Ke;if(r.rotate(le.getAngle(this.rotation())),this._movingAnchorName&&e.width<0&&this._movingAnchorName.indexOf("left")>=0){const u=r.point({x:-this.padding()*2,y:0});e.x+=u.x,e.y+=u.y,e.width+=this.padding()*2,this._movingAnchorName=this._movingAnchorName.replace("left","right"),this._anchorDragOffset.x-=u.x,this._anchorDragOffset.y-=u.y}else if(this._movingAnchorName&&e.width<0&&this._movingAnchorName.indexOf("right")>=0){const u=r.point({x:this.padding()*2,y:0});this._movingAnchorName=this._movingAnchorName.replace("right","left"),this._anchorDragOffset.x-=u.x,this._anchorDragOffset.y-=u.y,e.width+=this.padding()*2}if(this._movingAnchorName&&e.height<0&&this._movingAnchorName.indexOf("top")>=0){const u=r.point({x:0,y:-this.padding()*2});e.x+=u.x,e.y+=u.y,this._movingAnchorName=this._movingAnchorName.replace("top","bottom"),this._anchorDragOffset.x-=u.x,this._anchorDragOffset.y-=u.y,e.height+=this.padding()*2}else if(this._movingAnchorName&&e.height<0&&this._movingAnchorName.indexOf("bottom")>=0){const u=r.point({x:0,y:this.padding()*2});this._movingAnchorName=this._movingAnchorName.replace("bottom","top"),this._anchorDragOffset.x-=u.x,this._anchorDragOffset.y-=u.y,e.height+=this.padding()*2}if(this.boundBoxFunc()){const u=this.boundBoxFunc()(i,e);u?e=u:F.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const a=1e7,l=new Ke;l.translate(i.x,i.y),l.rotate(i.rotation),l.scale(i.width/a,i.height/a);const o=new Ke,c=e.width/a,d=e.height/a;this.flipEnabled()===!1?(o.translate(e.x,e.y),o.rotate(e.rotation),o.translate(e.width<0?e.width:0,e.height<0?e.height:0),o.scale(Math.abs(c),Math.abs(d))):(o.translate(e.x,e.y),o.rotate(e.rotation),o.scale(c,d));const h=o.multiply(l.invert());this._nodes.forEach(u=>{var v;if(!u.getStage())return;const f=u.getParent().getAbsoluteTransform(),p=u.getTransform().copy();p.translate(u.offsetX(),u.offsetY());const b=new Ke;b.multiply(f.copy().invert()).multiply(h).multiply(f).multiply(p);const m=b.decompose();u.setAttrs(m),(v=u.getLayer())===null||v===void 0||v.batchDraw()}),this.rotation(F._getRotation(e.rotation)),this._nodes.forEach(u=>{this._fire("transform",{evt:t,target:u}),u._fire("transform",{evt:t,target:u})}),this._resetTransformCache(),this.update(),this.getLayer().batchDraw()}forceUpdate(){this._resetTransformCache(),this.update()}_batchChangeChild(e,t){this.findOne(e).setAttrs(t)}update(){var e;const t=this._getNodeRect();this.rotation(F._getRotation(t.rotation));const i=t.width,s=t.height,r=this.enabledAnchors(),a=this.resizeEnabled(),l=this.padding(),o=this.anchorSize(),c=this.find("._anchor");c.forEach(h=>{h.setAttrs({width:o,height:o,offsetX:o/2,offsetY:o/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius()})}),this._batchChangeChild(".top-left",{x:0,y:0,offsetX:o/2+l,offsetY:o/2+l,visible:a&&r.indexOf("top-left")>=0}),this._batchChangeChild(".top-center",{x:i/2,y:0,offsetY:o/2+l,visible:a&&r.indexOf("top-center")>=0}),this._batchChangeChild(".top-right",{x:i,y:0,offsetX:o/2-l,offsetY:o/2+l,visible:a&&r.indexOf("top-right")>=0}),this._batchChangeChild(".middle-left",{x:0,y:s/2,offsetX:o/2+l,visible:a&&r.indexOf("middle-left")>=0}),this._batchChangeChild(".middle-right",{x:i,y:s/2,offsetX:o/2-l,visible:a&&r.indexOf("middle-right")>=0}),this._batchChangeChild(".bottom-left",{x:0,y:s,offsetX:o/2+l,offsetY:o/2-l,visible:a&&r.indexOf("bottom-left")>=0}),this._batchChangeChild(".bottom-center",{x:i/2,y:s,offsetY:o/2-l,visible:a&&r.indexOf("bottom-center")>=0}),this._batchChangeChild(".bottom-right",{x:i,y:s,offsetX:o/2-l,offsetY:o/2-l,visible:a&&r.indexOf("bottom-right")>=0}),this._batchChangeChild(".rotater",{x:i/2,y:-this.rotateAnchorOffset()*F._sign(s)-l,visible:this.rotateEnabled()}),this._batchChangeChild(".back",{width:i,height:s,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),draggable:this.nodes().some(h=>h.draggable()),x:0,y:0});const d=this.anchorStyleFunc();d&&c.forEach(h=>{d(h)}),(e=this.getLayer())===null||e===void 0||e.batchDraw()}isTransforming(){return this._transforming}stopTransform(){if(this._transforming){this._removeEvents();const e=this.findOne("."+this._movingAnchorName);e&&e.stopDrag()}}destroy(){return this.getStage()&&this._cursorChange&&this.getStage().content&&(this.getStage().content.style.cursor=""),Yt.prototype.destroy.call(this),this.detach(),this._removeEvents(),this}toObject(){return ie.prototype.toObject.call(this)}clone(e){return ie.prototype.clone.call(this,e)}getClientRect(){return this.nodes().length>0?super.getClientRect():{x:0,y:0,width:0,height:0}}}Ee.isTransforming=()=>Ai>0;function ud(n){return n instanceof Array||F.warn("enabledAnchors value should be an array"),n instanceof Array&&n.forEach(function(e){jn.indexOf(e)===-1&&F.warn("Unknown anchor name: "+e+". Available names are: "+jn.join(", "))}),n||[]}Ee.prototype.className="Transformer";Be(Ee);k.addGetterSetter(Ee,"enabledAnchors",jn,ud);k.addGetterSetter(Ee,"flipEnabled",!0,at());k.addGetterSetter(Ee,"resizeEnabled",!0);k.addGetterSetter(Ee,"anchorSize",10,re());k.addGetterSetter(Ee,"rotateEnabled",!0);k.addGetterSetter(Ee,"rotateLineVisible",!0);k.addGetterSetter(Ee,"rotationSnaps",[]);k.addGetterSetter(Ee,"rotateAnchorOffset",50,re());k.addGetterSetter(Ee,"rotateAnchorCursor","crosshair");k.addGetterSetter(Ee,"rotationSnapTolerance",5,re());k.addGetterSetter(Ee,"borderEnabled",!0);k.addGetterSetter(Ee,"anchorStroke","rgb(0, 161, 255)");k.addGetterSetter(Ee,"anchorStrokeWidth",1,re());k.addGetterSetter(Ee,"anchorFill","white");k.addGetterSetter(Ee,"anchorCornerRadius",0,re());k.addGetterSetter(Ee,"borderStroke","rgb(0, 161, 255)");k.addGetterSetter(Ee,"borderStrokeWidth",1,re());k.addGetterSetter(Ee,"borderDash");k.addGetterSetter(Ee,"keepRatio",!0);k.addGetterSetter(Ee,"shiftBehavior","default");k.addGetterSetter(Ee,"centeredScaling",!1);k.addGetterSetter(Ee,"ignoreStroke",!1);k.addGetterSetter(Ee,"padding",0,re());k.addGetterSetter(Ee,"nodes");k.addGetterSetter(Ee,"node");k.addGetterSetter(Ee,"boundBoxFunc");k.addGetterSetter(Ee,"anchorDragBoundFunc");k.addGetterSetter(Ee,"anchorStyleFunc");k.addGetterSetter(Ee,"shouldOverdrawWholeArea",!1);k.addGetterSetter(Ee,"useSingleNodeRotation",!0);k.backCompat(Ee,{lineEnabled:"borderEnabled",rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"});class bt extends J{_sceneFunc(e){e.beginPath(),e.arc(0,0,this.radius(),0,le.getAngle(this.angle()),this.clockwise()),e.lineTo(0,0),e.closePath(),e.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(e){this.radius(e/2)}setHeight(e){this.radius(e/2)}}bt.prototype.className="Wedge";bt.prototype._centroid=!0;bt.prototype._attrsAffectingSize=["radius"];Be(bt);k.addGetterSetter(bt,"radius",0,re());k.addGetterSetter(bt,"angle",0,re());k.addGetterSetter(bt,"clockwise",!1);k.backCompat(bt,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"});function ks(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}const gd=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],fd=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function vd(n,e){const t=n.data,i=n.width,s=n.height;let r,a,l,o,c,d,h,u,v,f,p,b,m,_,w,x,C,A,M,I;const z=e+e+1,E=i-1,R=s-1,T=e+1,U=T*(T+1)/2,N=new ks,$=gd[e],P=fd[e];let Q=null,G=N,D=null,V=null;for(let q=1;q<z;q++)G=G.next=new ks,q===T&&(Q=G);G.next=N,l=a=0;for(let q=0;q<s;q++){b=m=_=w=o=c=d=h=0,u=T*(x=t[a]),v=T*(C=t[a+1]),f=T*(A=t[a+2]),p=T*(M=t[a+3]),o+=U*x,c+=U*C,d+=U*A,h+=U*M,G=N;for(let W=0;W<T;W++)G.r=x,G.g=C,G.b=A,G.a=M,G=G.next;for(let W=1;W<T;W++)r=a+((E<W?E:W)<<2),o+=(G.r=x=t[r])*(I=T-W),c+=(G.g=C=t[r+1])*I,d+=(G.b=A=t[r+2])*I,h+=(G.a=M=t[r+3])*I,b+=x,m+=C,_+=A,w+=M,G=G.next;D=N,V=Q;for(let W=0;W<i;W++)t[a+3]=M=h*$>>P,M!==0?(M=255/M,t[a]=(o*$>>P)*M,t[a+1]=(c*$>>P)*M,t[a+2]=(d*$>>P)*M):t[a]=t[a+1]=t[a+2]=0,o-=u,c-=v,d-=f,h-=p,u-=D.r,v-=D.g,f-=D.b,p-=D.a,r=l+((r=W+e+1)<E?r:E)<<2,b+=D.r=t[r],m+=D.g=t[r+1],_+=D.b=t[r+2],w+=D.a=t[r+3],o+=b,c+=m,d+=_,h+=w,D=D.next,u+=x=V.r,v+=C=V.g,f+=A=V.b,p+=M=V.a,b-=x,m-=C,_-=A,w-=M,V=V.next,a+=4;l+=i}for(let q=0;q<i;q++){m=_=w=b=c=d=h=o=0,a=q<<2,u=T*(x=t[a]),v=T*(C=t[a+1]),f=T*(A=t[a+2]),p=T*(M=t[a+3]),o+=U*x,c+=U*C,d+=U*A,h+=U*M,G=N;for(let j=0;j<T;j++)G.r=x,G.g=C,G.b=A,G.a=M,G=G.next;let W=i;for(let j=1;j<=e;j++)a=W+q<<2,o+=(G.r=x=t[a])*(I=T-j),c+=(G.g=C=t[a+1])*I,d+=(G.b=A=t[a+2])*I,h+=(G.a=M=t[a+3])*I,b+=x,m+=C,_+=A,w+=M,G=G.next,j<R&&(W+=i);a=q,D=N,V=Q;for(let j=0;j<s;j++)r=a<<2,t[r+3]=M=h*$>>P,M>0?(M=255/M,t[r]=(o*$>>P)*M,t[r+1]=(c*$>>P)*M,t[r+2]=(d*$>>P)*M):t[r]=t[r+1]=t[r+2]=0,o-=u,c-=v,d-=f,h-=p,u-=D.r,v-=D.g,f-=D.b,p-=D.a,r=q+((r=j+T)<R?r:R)*i<<2,o+=b+=D.r=t[r],c+=m+=D.g=t[r+1],d+=_+=D.b=t[r+2],h+=w+=D.a=t[r+3],D=D.next,u+=x=V.r,v+=C=V.g,f+=A=V.b,p+=M=V.a,b-=x,m-=C,_-=A,w-=M,V=V.next,a+=i}}const pd=function(e){const t=Math.round(this.blurRadius());t>0&&vd(e,t)};k.addGetterSetter(ie,"blurRadius",0,re(),k.afterSetFilter);const md=function(n){const e=this.brightness()*255,t=n.data,i=t.length;for(let s=0;s<i;s+=4)t[s]+=e,t[s+1]+=e,t[s+2]+=e};k.addGetterSetter(ie,"brightness",0,re(),k.afterSetFilter);const bd=function(n){const e=this.brightness(),t=n.data,i=t.length;for(let s=0;s<i;s+=4)t[s]=Math.min(255,t[s]*e),t[s+1]=Math.min(255,t[s+1]*e),t[s+2]=Math.min(255,t[s+2]*e)},yd=function(n){const e=Math.pow((this.contrast()+100)/100,2),t=n.data,i=t.length;let s=150,r=150,a=150;for(let l=0;l<i;l+=4)s=t[l],r=t[l+1],a=t[l+2],s/=255,s-=.5,s*=e,s+=.5,s*=255,r/=255,r-=.5,r*=e,r+=.5,r*=255,a/=255,a-=.5,a*=e,a+=.5,a*=255,s=s<0?0:s>255?255:s,r=r<0?0:r>255?255:r,a=a<0?0:a>255?255:a,t[l]=s,t[l+1]=r,t[l+2]=a};k.addGetterSetter(ie,"contrast",0,re(),k.afterSetFilter);const _d=function(n){var e,t,i,s,r,a,l,o,c;const d=n.data,h=n.width,u=n.height,v=Math.min(1,Math.max(0,(t=(e=this.embossStrength)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:.5)),f=Math.min(1,Math.max(0,(s=(i=this.embossWhiteLevel)===null||i===void 0?void 0:i.call(this))!==null&&s!==void 0?s:.5)),b=(l={"top-left":315,top:270,"top-right":225,right:180,"bottom-right":135,bottom:90,"bottom-left":45,left:0}[(a=(r=this.embossDirection)===null||r===void 0?void 0:r.call(this))!==null&&a!==void 0?a:"top-left"])!==null&&l!==void 0?l:315,m=!!((c=(o=this.embossBlend)===null||o===void 0?void 0:o.call(this))!==null&&c!==void 0&&c),_=v*10,w=f*255,x=b*Math.PI/180,C=Math.cos(x),A=Math.sin(x),M=128/1020*_,I=new Uint8ClampedArray(d),z=new Float32Array(h*u);for(let N=0,$=0;$<d.length;$+=4,N++)z[N]=.2126*I[$]+.7152*I[$+1]+.0722*I[$+2];const E=[-1,0,1,-2,0,2,-1,0,1],R=[-1,-2,-1,0,0,0,1,2,1],T=[-h-1,-h,-h+1,-1,0,1,h-1,h,h+1],U=N=>N<0?0:N>255?255:N;for(let N=1;N<u-1;N++)for(let $=1;$<h-1;$++){const P=N*h+$;let Q=0,G=0;Q+=z[P+T[0]]*E[0],G+=z[P+T[0]]*R[0],Q+=z[P+T[1]]*E[1],G+=z[P+T[1]]*R[1],Q+=z[P+T[2]]*E[2],G+=z[P+T[2]]*R[2],Q+=z[P+T[3]]*E[3],G+=z[P+T[3]]*R[3],Q+=z[P+T[5]]*E[5],G+=z[P+T[5]]*R[5],Q+=z[P+T[6]]*E[6],G+=z[P+T[6]]*R[6],Q+=z[P+T[7]]*E[7],G+=z[P+T[7]]*R[7],Q+=z[P+T[8]]*E[8],G+=z[P+T[8]]*R[8];const D=C*Q+A*G,V=U(w+D*M),q=P*4;if(m){const W=V-w;d[q]=U(I[q]+W),d[q+1]=U(I[q+1]+W),d[q+2]=U(I[q+2]+W),d[q+3]=I[q+3]}else d[q]=d[q+1]=d[q+2]=V,d[q+3]=I[q+3]}for(let N=0;N<h;N++){let $=N*4,P=((u-1)*h+N)*4;d[$]=I[$],d[$+1]=I[$+1],d[$+2]=I[$+2],d[$+3]=I[$+3],d[P]=I[P],d[P+1]=I[P+1],d[P+2]=I[P+2],d[P+3]=I[P+3]}for(let N=1;N<u-1;N++){let $=N*h*4,P=(N*h+(h-1))*4;d[$]=I[$],d[$+1]=I[$+1],d[$+2]=I[$+2],d[$+3]=I[$+3],d[P]=I[P],d[P+1]=I[P+1],d[P+2]=I[P+2],d[P+3]=I[P+3]}return n};k.addGetterSetter(ie,"embossStrength",.5,re(),k.afterSetFilter);k.addGetterSetter(ie,"embossWhiteLevel",.5,re(),k.afterSetFilter);k.addGetterSetter(ie,"embossDirection","top-left",void 0,k.afterSetFilter);k.addGetterSetter(ie,"embossBlend",!1,void 0,k.afterSetFilter);function gi(n,e,t,i,s){const r=t-e,a=s-i;if(r===0)return i+a/2;if(a===0)return i;let l=(n-e)/r;return l=a*l+i,l}const xd=function(n){const e=n.data,t=e.length;let i=e[0],s=i,r,a=e[1],l=a,o,c=e[2],d=c,h;const u=this.enhance();if(u===0)return;for(let w=0;w<t;w+=4)r=e[w+0],r<i?i=r:r>s&&(s=r),o=e[w+1],o<a?a=o:o>l&&(l=o),h=e[w+2],h<c?c=h:h>d&&(d=h);s===i&&(s=255,i=0),l===a&&(l=255,a=0),d===c&&(d=255,c=0);let v,f,p,b,m,_;if(u>0)v=s+u*(255-s),f=i-u*(i-0),p=l+u*(255-l),b=a-u*(a-0),m=d+u*(255-d),_=c-u*(c-0);else{const w=(s+i)*.5;v=s+u*(s-w),f=i+u*(i-w);const x=(l+a)*.5;p=l+u*(l-x),b=a+u*(a-x);const C=(d+c)*.5;m=d+u*(d-C),_=c+u*(c-C)}for(let w=0;w<t;w+=4)e[w+0]=gi(e[w+0],i,s,f,v),e[w+1]=gi(e[w+1],a,l,b,p),e[w+2]=gi(e[w+2],c,d,_,m)};k.addGetterSetter(ie,"enhance",0,re(),k.afterSetFilter);const Sd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4){const s=.34*e[i]+.5*e[i+1]+.16*e[i+2];e[i]=s,e[i+1]=s,e[i+2]=s}};k.addGetterSetter(ie,"hue",0,re(),k.afterSetFilter);k.addGetterSetter(ie,"saturation",0,re(),k.afterSetFilter);k.addGetterSetter(ie,"luminance",0,re(),k.afterSetFilter);const wd=function(n){const e=n.data,t=e.length,i=1,s=Math.pow(2,this.saturation()),r=Math.abs(this.hue()+360)%360,a=this.luminance()*127,l=i*s*Math.cos(r*Math.PI/180),o=i*s*Math.sin(r*Math.PI/180),c=.299*i+.701*l+.167*o,d=.587*i-.587*l+.33*o,h=.114*i-.114*l-.497*o,u=.299*i-.299*l-.328*o,v=.587*i+.413*l+.035*o,f=.114*i-.114*l+.293*o,p=.299*i-.3*l+1.25*o,b=.587*i-.586*l-1.05*o,m=.114*i+.886*l-.2*o;let _,w,x,C;for(let A=0;A<t;A+=4)_=e[A+0],w=e[A+1],x=e[A+2],C=e[A+3],e[A+0]=c*_+d*w+h*x+a,e[A+1]=u*_+v*w+f*x+a,e[A+2]=p*_+b*w+m*x+a,e[A+3]=C},$d=function(n){const e=n.data,t=e.length,i=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),r=Math.abs(this.hue()+360)%360,a=i*s*Math.cos(r*Math.PI/180),l=i*s*Math.sin(r*Math.PI/180),o=.299*i+.701*a+.167*l,c=.587*i-.587*a+.33*l,d=.114*i-.114*a-.497*l,h=.299*i-.299*a-.328*l,u=.587*i+.413*a+.035*l,v=.114*i-.114*a+.293*l,f=.299*i-.3*a+1.25*l,p=.587*i-.586*a-1.05*l,b=.114*i+.886*a-.2*l;for(let m=0;m<t;m+=4){const _=e[m+0],w=e[m+1],x=e[m+2],C=e[m+3];e[m+0]=o*_+c*w+d*x,e[m+1]=h*_+u*w+v*x,e[m+2]=f*_+p*w+b*x,e[m+3]=C}};k.addGetterSetter(ie,"hue",0,re(),k.afterSetFilter);k.addGetterSetter(ie,"saturation",0,re(),k.afterSetFilter);k.addGetterSetter(ie,"value",0,re(),k.afterSetFilter);const Cd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4)e[i]=255-e[i],e[i+1]=255-e[i+1],e[i+2]=255-e[i+2]},kd=function(n,e,t){const i=n.data,s=e.data,r=n.width,a=n.height,l=t.polarCenterX||r/2,o=t.polarCenterY||a/2;let c=Math.sqrt(l*l+o*o),d=r-l,h=a-o;const u=Math.sqrt(d*d+h*h);c=u>c?u:c;const v=a,f=r,p=360/f*Math.PI/180;for(let b=0;b<f;b+=1){const m=Math.sin(b*p),_=Math.cos(b*p);for(let w=0;w<v;w+=1){d=Math.floor(l+c*w/v*_),h=Math.floor(o+c*w/v*m);let x=(h*r+d)*4;const C=i[x+0],A=i[x+1],M=i[x+2],I=i[x+3];x=(b+w*r)*4,s[x+0]=C,s[x+1]=A,s[x+2]=M,s[x+3]=I}}},Td=function(n,e,t){const i=n.data,s=e.data,r=n.width,a=n.height,l=t.polarCenterX||r/2,o=t.polarCenterY||a/2;let c=Math.sqrt(l*l+o*o),d=r-l,h=a-o;const u=Math.sqrt(d*d+h*h);c=u>c?u:c;const v=a,f=r,p=0;let b,m;for(d=0;d<r;d+=1)for(h=0;h<a;h+=1){const _=d-l,w=h-o,x=Math.sqrt(_*_+w*w)*v/c;let C=(Math.atan2(w,_)*180/Math.PI+360+p)%360;C=C*f/360,b=Math.floor(C),m=Math.floor(x);let A=(m*r+b)*4;const M=i[A+0],I=i[A+1],z=i[A+2],E=i[A+3];A=(h*r+d)*4,s[A+0]=M,s[A+1]=I,s[A+2]=z,s[A+3]=E}},Ed=function(n){const e=n.width,t=n.height;let i,s,r,a,l,o,c,d,h,u,v=Math.round(this.kaleidoscopePower());const f=Math.round(this.kaleidoscopeAngle()),p=Math.floor(e*(f%360)/360);if(v<1)return;const b=F.createCanvasElement();b.width=e,b.height=t;const m=b.getContext("2d").getImageData(0,0,e,t);F.releaseCanvas(b),kd(n,m,{polarCenterX:e/2,polarCenterY:t/2});let _=e/Math.pow(2,v);for(;_<=8;)_=_*2,v-=1;_=Math.ceil(_);let w=_,x=0,C=w,A=1;for(p+_>e&&(x=w,C=0,A=-1),s=0;s<t;s+=1)for(i=x;i!==C;i+=A)r=Math.round(i+p)%e,h=(e*s+r)*4,l=m.data[h+0],o=m.data[h+1],c=m.data[h+2],d=m.data[h+3],u=(e*s+i)*4,m.data[u+0]=l,m.data[u+1]=o,m.data[u+2]=c,m.data[u+3]=d;for(s=0;s<t;s+=1)for(w=Math.floor(_),a=0;a<v;a+=1){for(i=0;i<w+1;i+=1)h=(e*s+i)*4,l=m.data[h+0],o=m.data[h+1],c=m.data[h+2],d=m.data[h+3],u=(e*s+w*2-i-1)*4,m.data[u+0]=l,m.data[u+1]=o,m.data[u+2]=c,m.data[u+3]=d;w*=2}Td(m,n,{})};k.addGetterSetter(ie,"kaleidoscopePower",2,re(),k.afterSetFilter);k.addGetterSetter(ie,"kaleidoscopeAngle",0,re(),k.afterSetFilter);function Ln(n,e,t){let i=(t*n.width+e)*4;const s=[];return s.push(n.data[i++],n.data[i++],n.data[i++],n.data[i++]),s}function tn(n,e){return Math.sqrt(Math.pow(n[0]-e[0],2)+Math.pow(n[1]-e[1],2)+Math.pow(n[2]-e[2],2))}function Pd(n){const e=[0,0,0];for(let t=0;t<n.length;t++)e[0]+=n[t][0],e[1]+=n[t][1],e[2]+=n[t][2];return e[0]/=n.length,e[1]/=n.length,e[2]/=n.length,e}function Ad(n,e){const t=Ln(n,0,0),i=Ln(n,n.width-1,0),s=Ln(n,0,n.height-1),r=Ln(n,n.width-1,n.height-1),a=e||10;if(tn(t,i)<a&&tn(i,r)<a&&tn(r,s)<a&&tn(s,t)<a){const l=Pd([i,t,r,s]),o=[];for(let c=0;c<n.width*n.height;c++){const d=tn(l,[n.data[c*4],n.data[c*4+1],n.data[c*4+2]]);o[c]=d<a?0:255}return o}}function Rd(n,e){for(let t=0;t<n.width*n.height;t++)n.data[4*t+3]=e[t]}function Ld(n,e,t){const i=[1,1,1,1,0,1,1,1,1],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let h=0;h<s;h++)for(let u=0;u<s;u++){const v=l+h-r,f=o+u-r;if(v>=0&&v<t&&f>=0&&f<e){const p=v*e+f,b=i[h*s+u];d+=n[p]*b}}a[c]=d===255*8?255:0}return a}function Md(n,e,t){const i=[1,1,1,1,1,1,1,1,1],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let h=0;h<s;h++)for(let u=0;u<s;u++){const v=l+h-r,f=o+u-r;if(v>=0&&v<t&&f>=0&&f<e){const p=v*e+f,b=i[h*s+u];d+=n[p]*b}}a[c]=d>=255*4?255:0}return a}function Dd(n,e,t){const i=[.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111],s=Math.round(Math.sqrt(i.length)),r=Math.floor(s/2),a=[];for(let l=0;l<t;l++)for(let o=0;o<e;o++){const c=l*e+o;let d=0;for(let h=0;h<s;h++)for(let u=0;u<s;u++){const v=l+h-r,f=o+u-r;if(v>=0&&v<t&&f>=0&&f<e){const p=v*e+f,b=i[h*s+u];d+=n[p]*b}}a[c]=d}return a}const Od=function(n){const e=this.threshold();let t=Ad(n,e);return t&&(t=Ld(t,n.width,n.height),t=Md(t,n.width,n.height),t=Dd(t,n.width,n.height),Rd(n,t)),n};k.addGetterSetter(ie,"threshold",0,re(),k.afterSetFilter);const Id=function(n){const e=this.noise()*255,t=n.data,i=t.length,s=e/2;for(let r=0;r<i;r+=4)t[r+0]+=s-2*s*Math.random(),t[r+1]+=s-2*s*Math.random(),t[r+2]+=s-2*s*Math.random()};k.addGetterSetter(ie,"noise",.2,re(),k.afterSetFilter);const Nd=function(n){let e=Math.ceil(this.pixelSize()),t=n.width,i=n.height,s=Math.ceil(t/e),r=Math.ceil(i/e),a=n.data;if(e<=0){F.error("pixelSize value can not be <= 0");return}for(let l=0;l<s;l+=1)for(let o=0;o<r;o+=1){let c=0,d=0,h=0,u=0;const v=l*e,f=v+e,p=o*e,b=p+e;let m=0;for(let _=v;_<f;_+=1)if(!(_>=t))for(let w=p;w<b;w+=1){if(w>=i)continue;const x=(t*w+_)*4;c+=a[x+0],d+=a[x+1],h+=a[x+2],u+=a[x+3],m+=1}c=c/m,d=d/m,h=h/m,u=u/m;for(let _=v;_<f;_+=1)if(!(_>=t))for(let w=p;w<b;w+=1){if(w>=i)continue;const x=(t*w+_)*4;a[x+0]=c,a[x+1]=d,a[x+2]=h,a[x+3]=u}}};k.addGetterSetter(ie,"pixelSize",8,re(),k.afterSetFilter);const zd=function(n){const e=Math.round(this.levels()*254)+1,t=n.data,i=t.length,s=255/e;for(let r=0;r<i;r+=1)t[r]=Math.floor(t[r]/s)*s};k.addGetterSetter(ie,"levels",.5,re(),k.afterSetFilter);const Fd=function(n){const e=n.data,t=e.length,i=this.red(),s=this.green(),r=this.blue();for(let a=0;a<t;a+=4){const l=(.34*e[a]+.5*e[a+1]+.16*e[a+2])/255;e[a]=l*i,e[a+1]=l*s,e[a+2]=l*r,e[a+3]=e[a+3]}};k.addGetterSetter(ie,"red",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});k.addGetterSetter(ie,"green",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});k.addGetterSetter(ie,"blue",0,ir,k.afterSetFilter);const Gd=function(n){const e=n.data,t=e.length,i=this.red(),s=this.green(),r=this.blue(),a=this.alpha();for(let l=0;l<t;l+=4){const o=1-a;e[l]=i*a+e[l]*o,e[l+1]=s*a+e[l+1]*o,e[l+2]=r*a+e[l+2]*o}};k.addGetterSetter(ie,"red",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});k.addGetterSetter(ie,"green",0,function(n){return this._filterUpToDate=!1,n>255?255:n<0?0:Math.round(n)});k.addGetterSetter(ie,"blue",0,ir,k.afterSetFilter);k.addGetterSetter(ie,"alpha",1,function(n){return this._filterUpToDate=!1,n>1?1:n<0?0:n});const Bd=function(n){const e=n.data,t=e.length;for(let i=0;i<t;i+=4){const s=e[i+0],r=e[i+1],a=e[i+2];e[i+0]=Math.min(255,s*.393+r*.769+a*.189),e[i+1]=Math.min(255,s*.349+r*.686+a*.168),e[i+2]=Math.min(255,s*.272+r*.534+a*.131)}},Ud=function(n){const t=n.data;for(let i=0;i<t.length;i+=4){const s=t[i],r=t[i+1],a=t[i+2];.2126*s+.7152*r+.0722*a>=128&&(t[i]=255-s,t[i+1]=255-r,t[i+2]=255-a)}return n},Hd=function(n){const e=this.threshold()*255,t=n.data,i=t.length;for(let s=0;s<i;s+=1)t[s]=t[s]<e?0:255};k.addGetterSetter(ie,"threshold",.5,re(),k.afterSetFilter);const Qe=vs.Util._assign(vs,{Arc:pt,Arrow:Nt,Circle:Xt,Ellipse:kt,Image:st,Label:Ni,Tag:zt,Line:mt,Path:ze,Rect:yn,RegularPolygon:Tt,Ring:Ft,Sprite:dt,Star:Et,Text:Fe,TextPath:qe,Transformer:Ee,Wedge:bt,Filters:{Blur:pd,Brightness:bd,Brighten:md,Contrast:yd,Emboss:_d,Enhance:xd,Grayscale:Sd,HSL:wd,HSV:$d,Invert:Cd,Kaleidoscope:Ed,Mask:Od,Noise:Id,Pixelate:Nd,Posterize:zd,RGB:Fd,RGBA:Gd,Sepia:Bd,Solarize:Ud,Threshold:Hd}});class qd{stage;layer;elements;backgroundLayer;constructor(e,t={}){if(this.stage=new Qe.Stage({container:e,width:t.width||e.clientWidth,height:t.height||e.clientHeight}),this.backgroundLayer=new Qe.Layer,this.stage.add(this.backgroundLayer),t.background){const i=new Qe.Rect({x:0,y:0,width:this.stage.width(),height:this.stage.height(),fill:t.background});this.backgroundLayer.add(i)}this.layer=new Qe.Layer,this.stage.add(this.layer),this.elements=new Map}render(e){this.layer.destroyChildren(),this.elements.clear();const t=performance.now();e.forEach(s=>{const r=this.createElement(s);r&&(this.layer.add(r),this.elements.set(s.id,r))}),this.layer.batchDraw();const i=performance.now()-t;console.log(`✨ Konva渲染完成: ${e.length}个元素, 耗时${i.toFixed(2)}ms`)}createElement(e){const t=e.content.type;switch(t){case"Text":return this.createText(e);case"Rectangle":return this.createRectangle(e);case"Image":return this.createImage(e);case"Line":return this.createLine(e);case"DataField":return this.createDataField(e);default:return console.warn(`未知元素类型: ${t}`),null}}createText(e){if(e.content.type!=="Text")return new Qe.Text({});const t=e.content,i=t.style;return new Qe.Text({id:e.id,x:e.position.x,y:e.position.y,text:t.content||"文本",fontSize:i.font_size||14,fontFamily:i.font_family||"Arial",fontStyle:i.font_weight==="bold"?"bold":"normal",fill:i.color||"#000000",width:e.size.width,align:i.align==="Center"?"center":i.align==="Right"?"right":"left",verticalAlign:"top",wrap:"word",ellipsis:!0})}createRectangle(e){if(e.content.type!=="Rectangle")return new Qe.Rect({});const t=e.content;return new Qe.Rect({id:e.id,x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,fill:t.fill_color||"transparent",stroke:t.border?.color||"#000000",strokeWidth:t.border?.width||0,cornerRadius:t.corner_radius||0,opacity:t.opacity||1})}createImage(e){const t=new Qe.Rect({id:e.id+"_placeholder",x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,fill:"#f0f0f0",stroke:"#cccccc",strokeWidth:1});if(e.content.type==="Image"){const i=e.content,s=new window.Image;s.onload=()=>{const r=new Qe.Image({id:e.id,x:e.position.x,y:e.position.y,width:e.size.width,height:e.size.height,image:s});t.destroy(),this.layer.add(r),this.elements.set(e.id,r),this.layer.batchDraw()},s.onerror=()=>{console.error(`图片加载失败: ${i.src}`)},s.src=i.src}return t}createLine(e){const i=e.size.height<e.size.width?[0,0,e.size.width,0]:[0,0,0,e.size.height];if(e.content.type!=="Line")return new Qe.Line({});const s=e.content,r=s.line_style==="Dashed"?[5,5]:s.line_style==="Dotted"?[2,2]:s.line_style==="DashDot"?[5,2,2,2]:void 0,a={id:e.id,x:e.position.x,y:e.position.y,points:i,stroke:s.color||"#000000",strokeWidth:s.width||1,lineCap:"round",lineJoin:"round"};return r&&(a.dash=r),new Qe.Line(a)}createDataField(e){if(e.content.type!=="DataField")return new Qe.Text({});const t=e.content,i=t.style;return new Qe.Text({id:e.id,x:e.position.x,y:e.position.y,text:t.expression||"[Data Field]",fontSize:i.font_size||14,fontFamily:i.font_family||"Arial",fontStyle:i.font_weight==="bold"?"bold":"normal",fill:i.color||"#000000",width:e.size.width,align:i.align==="Center"?"center":i.align==="Right"?"right":"left",verticalAlign:"top",wrap:"word",ellipsis:!0})}setScale(e){this.stage.scale({x:e,y:e}),this.stage.batchDraw()}getScale(){return this.stage.scaleX()}setPosition(e,t){this.stage.position({x:e,y:t}),this.stage.batchDraw()}getPosition(){return this.stage.position()}fitToContainer(){const t=this.stage.container().getBoundingClientRect();this.stage.width(t.width),this.stage.height(t.height);const i=this.backgroundLayer.findOne("Rect");i&&(i.width(t.width),i.height(t.height)),this.stage.batchDraw()}async toDataURL(e={}){return this.stage.toDataURL({pixelRatio:e.pixelRatio||2,mimeType:e.mimeType||"image/png"})}destroy(){this.elements.clear(),this.stage.destroy()}getStats(){return{elementsCount:this.elements.size,layersCount:this.stage.getLayers().length,stageSize:{width:this.stage.width(),height:this.stage.height()},scale:this.getScale(),position:this.getPosition()}}}var Wd=S('<div class="floating-toolbar fixed top-4 left-1/2 transform -translate-x-1/2 z-50"><div class="toolbar-container flex items-center gap-2 px-4 py-2 bg-gray-900 rounded-lg shadow-2xl"><div class="page-nav flex items-center gap-1"><button class="nav-btn p-1 text-white hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"title=上一页><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 19l-7-7 7-7"></path></svg></button><div class="page-display flex items-center gap-1 text-white text-sm"><input type=number class="page-input w-12 px-1 py-0.5 bg-gray-800 text-center rounded outline-none focus:bg-gray-700"min=1><span>/</span><span></span></div><button class="nav-btn p-1 text-white hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"title=下一页><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"></path></svg></button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="zoom-controls flex items-center gap-1"><button class="zoom-btn p-1 text-white hover:bg-gray-700 rounded"title=缩小><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M20 12H4"></path></svg></button><div class="zoom-display flex items-center gap-1 text-white text-sm"><input type=number class="zoom-input w-14 px-1 py-0.5 bg-gray-800 text-center rounded outline-none focus:bg-gray-700"min=10 max=500 step=10><span>%</span></div><button class="zoom-btn p-1 text-white hover:bg-gray-700 rounded"title=放大><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M12 4v16m8-8H4"></path></svg></button><button class="fit-btn p-1 text-white hover:bg-gray-700 rounded"title=适应屏幕><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg></button><button class="actual-btn p-1 text-white hover:bg-gray-700 rounded"title=实际大小><span class="text-xs font-bold">1:1</span></button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="mode-controls flex items-center gap-1"><button title=演示模式>演示</button><button title=开发模式>开发</button><button title=打印模式>打印</button></div><div class="divider w-px h-6 bg-gray-600"></div><div class="quick-actions flex items-center gap-1"><button class="action-btn p-1 text-white hover:bg-gray-700 rounded"title=导出><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button><button class="action-btn p-1 text-white hover:bg-gray-700 rounded"title=打印><svg class="w-5 h-5"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button><button class="exit-btn px-2 py-1 text-xs bg-red-600 text-white hover:bg-red-700 rounded"title="退出预览 (ESC)">退出');const jd=n=>{const[e,t]=Z(1),[i,s]=Z(!1);let r=null;const a=()=>{r&&clearTimeout(r),r=window.setTimeout(()=>{i()||t(.3)},3e3)},l=()=>{r&&(clearTimeout(r),r=null),t(1)};et(()=>{a()}),$t(()=>{r&&clearTimeout(r)});const o=()=>{s(!0),l()},c=()=>{s(!1),a()},d=()=>{n.currentPage>1&&n.onPageChange(n.currentPage-1)},h=()=>{n.currentPage<n.totalPages&&n.onPageChange(n.currentPage+1)},u=()=>{const b=Math.min(500,n.zoom+25);n.onZoomChange(b)},v=()=>{const b=Math.max(10,n.zoom-25);n.onZoomChange(b)},f=b=>{const m=b.target,_=parseInt(m.value);!isNaN(_)&&_>=1&&_<=n.totalPages&&n.onPageChange(_)},p=b=>{const m=b.target,_=parseInt(m.value);!isNaN(_)&&_>=10&&_<=500&&n.onZoomChange(_)};return(()=>{var b=Wd(),m=b.firstChild,_=m.firstChild,w=_.firstChild,x=w.nextSibling,C=x.firstChild,A=C.nextSibling,M=A.nextSibling,I=x.nextSibling,z=_.nextSibling,E=z.nextSibling,R=E.firstChild,T=R.nextSibling,U=T.firstChild,N=T.nextSibling,$=N.nextSibling,P=$.nextSibling,Q=E.nextSibling,G=Q.nextSibling,D=G.firstChild,V=D.nextSibling,q=V.nextSibling,W=G.nextSibling,j=W.nextSibling,he=j.firstChild,_e=he.nextSibling,pe=_e.nextSibling;return b.addEventListener("mouseleave",c),b.addEventListener("mouseenter",o),b.style.setProperty("transition","opacity 0.3s ease"),w.$$click=d,C.$$input=f,g(M,()=>n.totalPages),I.$$click=h,R.$$click=v,U.$$input=p,N.$$click=u,Le($,"click",n.onFitScreen),Le(P,"click",n.onActualSize),D.$$click=()=>n.onModeChange("presentation"),V.$$click=()=>n.onModeChange("development"),q.$$click=()=>n.onModeChange("print"),Le(he,"click",n.onExport),Le(_e,"click",n.onPrint),Le(pe,"click",n.onExit),B(se=>{var ce=e(),ue=n.currentPage<=1,ve=n.totalPages,ne=n.currentPage>=n.totalPages,ee=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="presentation"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,ge=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="development"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,be=`mode-btn px-2 py-1 text-xs rounded ${n.mode==="print"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`;return ce!==se.e&&((se.e=ce)!=null?b.style.setProperty("opacity",ce):b.style.removeProperty("opacity")),ue!==se.t&&(w.disabled=se.t=ue),ve!==se.a&&X(C,"max",se.a=ve),ne!==se.o&&(I.disabled=se.o=ne),ee!==se.i&&Se(D,se.i=ee),ge!==se.n&&Se(V,se.n=ge),be!==se.s&&Se(q,se.s=be),se},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),B(()=>C.value=n.currentPage),B(()=>U.value=n.zoom),b})()};He(["click","input"]);var Yd=S('<div class="preview-viewport w-full h-full bg-gray-100 relative overflow-hidden"><div class="preview-container w-full h-full"></div><div class="shortcuts-hint absolute bottom-4 left-1/2 transform -translate-x-1/2 text-gray-500 text-sm animate-fade-out"><span class="bg-white px-3 py-1 rounded shadow">ESC 退出 • Shift+拖动 平移 • Ctrl+滚轮 缩放 • F 适应屏幕');const Vd=n=>{let e,t=null;const{state:i}=ct(),{actions:s}=Xn(),[r,a]=Z(1),[l,o]=Z(100),[c,d]=Z("presentation"),[h,u]=Z(!1),[v,f]=Z({x:0,y:0}),[p,b]=Z({x:0,y:0}),m=()=>n.elements||i.elements,_=()=>n.pageCount||1;et(()=>{e&&(console.log("🎨 初始化Konva渲染器"),t=new qd(e,{width:n.pageSize?.width||794,height:n.pageSize?.height||1123,background:"#ffffff"}),w(),Q(),window.addEventListener("resize",T))}),$t(()=>{t&&(t.destroy(),t=null),window.removeEventListener("resize",T),document.removeEventListener("keydown",G)}),mn(()=>{const D=m();t&&D&&w()});const w=()=>{if(!t)return;const D=m(),V=r();t.render([...D]),console.log(`📄 渲染第 ${V} 页，共 ${D.length} 个元素`)},x=D=>{a(D),w()},C=D=>{o(D),t&&t.setScale(D/100)},A=()=>{if(!t||!e)return;const D=e.getBoundingClientRect(),V=n.pageSize?.width||794,q=n.pageSize?.height||1123,W=(D.width-100)/V,j=(D.height-100)/q,he=Math.min(W,j,1);C(Math.round(he*100));const _e=(D.width-V*he)/2,pe=(D.height-q*he)/2;t.setPosition(_e,pe),b({x:_e,y:pe})},M=()=>{C(100),t&&(t.setPosition(0,0),b({x:0,y:0}))},I=async()=>{if(console.log("📤 导出预览"),t)try{const D=await t.toDataURL({pixelRatio:2}),V=document.createElement("a");V.download=`preview-page-${r()}.png`,V.href=D,V.click()}catch(D){console.error("导出失败:",D)}},z=()=>{console.log("🖨️ 打印预览"),window.print()},E=()=>{console.log("🚪 退出预览模式"),s.setMode("design")},R=D=>{d(D),console.log(`🔄 切换到${D}模式`)},T=()=>{t&&t.fitToContainer()},U=D=>{D.button===0&&D.shiftKey&&(u(!0),f({x:D.clientX,y:D.clientY}),D.preventDefault())},N=D=>{if(!h()||!t)return;const V=D.clientX-v().x,q=D.clientY-v().y,W={x:p().x+V,y:p().y+q};t.setPosition(W.x,W.y),b(W),f({x:D.clientX,y:D.clientY})},$=()=>{u(!1)},P=D=>{if(!D.ctrlKey&&!D.metaKey)return;D.preventDefault();const V=D.deltaY>0?-10:10,q=Math.max(10,Math.min(500,l()+V));C(q)},Q=()=>{document.addEventListener("keydown",G)},G=D=>{switch(D.key){case"Escape":E();break;case"f":case"F":!D.ctrlKey&&!D.metaKey&&A();break;case"1":!D.ctrlKey&&!D.metaKey&&M();break;case"+":case"=":C(Math.min(500,l()+25));break;case"-":case"_":C(Math.max(10,l()-25));break;case"ArrowLeft":r()>1&&x(r()-1);break;case"ArrowRight":r()<_()&&x(r()+1);break;case"Home":x(1);break;case"End":x(_());break;case"p":case"P":(D.ctrlKey||D.metaKey)&&(D.preventDefault(),z());break;case"e":case"E":(D.ctrlKey||D.metaKey)&&(D.preventDefault(),I());break;case"d":case"D":!D.ctrlKey&&!D.metaKey&&R("development");break}};return(()=>{var D=Yd(),V=D.firstChild;g(D,y(jd,{get currentPage(){return r()},get totalPages(){return _()},get zoom(){return l()},get mode(){return c()},onPageChange:x,onZoomChange:C,onExport:I,onPrint:z,onModeChange:R,onFitScreen:A,onActualSize:M,onExit:E}),V),V.addEventListener("wheel",P),V.addEventListener("mouseleave",$),V.$$mouseup=$,V.$$mousemove=N,V.$$mousedown=U;var q=e;return typeof q=="function"?Vn(q,V):e=V,B(W=>(W=h()?"grabbing":"default")!=null?V.style.setProperty("cursor",W):V.style.removeProperty("cursor")),D})()};He(["mousedown","mousemove","mouseup"]);var Xd=S('<div class="preview-renderer w-full h-full relative">');const Qd=()=>{const{state:n}=ct();return(()=>{var e=Xd();return g(e,y(Vd,{get elements(){return[...n.elements]},pageSize:{width:794,height:1123},pageCount:1})),e})()};var Kd=S("<div class=wizard-errors>"),Jd=S("<div class=data-source-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>添加JSON数据源</h3><p></p></div></div><div class=wizard-content>"),Zd=S("<div class=error-message>"),eh=S("<div class=wizard-progress>"),th=S("<div><div class=step-indicator><span class=step-number></span></div><div class=step-info><div class=step-title></div><div class=step-description>"),nh=S("<div class=source-type-step><div class=step-header><h4>选择JSON数据的输入方式</h4><p>请选择最适合您使用场景的数据输入方式</p></div><div class=source-options>"),ih=S("<div><div class=option-header><div class=option-title></div><div class=option-description></div></div><div class=option-features></div><div class=option-example></div><div class=option-selector><input type=radio>"),sh=S("<span class=feature-tag>"),rh=S("<div class=data-input-step><div class=step-header><h4></h4><p>"),ah=S("<div class=selected-file><span class=file-icon>📄</span><span class=file-name></span><button class=remove-file>✕"),lh=S("<div class=file-error>"),oh=S('<div class=file-selection-panel><div><div class=drop-zone-content><div class=drop-icon>📁</div><div class=drop-text><div>将JSON文件拖拽到此处</div><div>或者点击下方按钮选择文件</div></div></div></div><div class=file-input-section><label class=file-select-btn><input type=file accept=.json>选择JSON文件</label></div><div class=file-help><div class=help-title>📝 支持的文件格式:</div><ul class=help-list><li>JSON对象: <code>{"name": "value"}</code></li><li>JSON数组: <code>[{"id": 1}, {"id": 2}]</code></li><li>文件大小: 最大10MB</li><li>编码格式: UTF-8'),ch=S("<div class=field-error>"),dh=S("<div class=form-field><label class=field-label>刷新间隔 (秒)</label><div class=interval-input-group><input type=range class=interval-slider min=10 max=3600 step=10><input type=number class=interval-number min=10 max=3600><span class=interval-unit>秒</span></div><div class=field-hint>推荐设置: 5分钟 (300秒) 适合大多数场景"),hh=S('<div class=form-section><div class=section-title><span class=title-icon>🔄</span><h5>自动刷新设置</h5></div><div class=form-field><label class="field-label checkbox-label"><input type=checkbox class=refresh-checkbox><span class=checkbox-text>启用自动刷新</span></label><div class=field-hint>当JSON文件发生变化时，自动重新加载数据'),uh=S('<div class=summary-item><span class=summary-label>文件路径:</span><span class="summary-value file-path">'),gh=S("<div class=summary-item><span class=summary-label>自动刷新:</span><span class=summary-value>"),fh=S("<div class=summary-item><span class=summary-label>内容长度:</span><span class=summary-value> 字符"),vh=S('<div class=configuration-step><div class=step-header><h4>⚙️ 配置数据源</h4><p>为您的数据源设置名称和基本选项</p></div><div class=config-form><div class=form-section><div class=section-title><span class=title-icon>🏷️</span><h5>基本信息</h5></div><div class=form-field><label class=field-label>数据源名称 <span class=required>*</span></label><input type=text placeholder="请输入数据源名称，如: 客户数据、销售报表等"maxlength=50><div class=field-hint>为您的数据源起一个容易识别的名称，方便后续使用和管理</div></div></div><div class=form-section><div class=section-title><span class=title-icon>📋</span><h5>配置概览</h5></div><div class=config-summary><div class=summary-item><span class=summary-label>数据来源:</span><span class=summary-value></span></div></div></div><div class=form-section><div class=usage-tips><div class=tips-title>💡 使用建议:</div><ul class=tips-list><li>使用具有描述性的名称，如"2024年销售数据"而不是"data1"</li><li>对于经常变化的文件，建议启用自动刷新功能</li><li>较大的JSON文件建议设置较长的刷新间隔以避免性能问题</li><li>直接输入的JSON内容会保存在应用中，不会自动更新'),ph=S("<span class=status-success>✅ JSON格式正确"),mh=S("<span class=status-error>❌ 格式错误"),bh=S("<div class=template-selector><div class=template-header>选择JSON模板:</div><div class=template-list>"),yh=S("<div class=syntax-error><div class=error-title>❌ JSON格式错误:</div><div class=error-message>"),_h=S(`<div class=content-editing-panel><div class=editor-toolbar><button class=template-btn>📋 使用模板</button><button class=clear-btn>🗑️ 清空</button><div class=editor-status></div></div><div class=json-editor><textarea placeholder="请输入或粘贴JSON内容...

示例:
{
  &quot;name&quot;: &quot;示例数据&quot;,
  &quot;value&quot;: 123
}"rows=15></textarea></div><div class=editor-help><div class=help-title>💡 使用提示:</div><ul class=help-list><li>支持JSON对象和数组格式</li><li>字符串需要用双引号包围</li><li>可以使用Ctrl+A全选，Ctrl+V粘贴</li><li>系统会自动验证JSON格式`),xh=S("<div class=template-item><div class=template-name></div><div class=template-description>"),Sh=S("<div class=error-details><div class=error-title>错误详情:</div><div class=error-content>"),wh=S("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),$h=S('<div class=info-item><span class=info-label>文件路径:</span><span class="info-value file-path">'),Ch=S("<div class=info-item><span class=info-label>自动刷新:</span><span class=info-value>"),kh=S("<div class=advanced-content><div class=info-grid><div class=info-item><span class=info-label>数据源类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>预览限制:</span><span class=info-value>最多显示5条记录"),Th=S("<div class=data-preview><div class=preview-header><div class=preview-title><span class=preview-icon>📊</span><h5>数据预览</h5></div><div class=preview-stats><span class=stat-item><span class=stat-label>记录数:</span><span class=stat-value></span></span><span class=stat-item><span class=stat-label>字段数:</span><span class=stat-value></span></span></div></div><div class=fields-info><div class=fields-title>📋 检测到的字段:</div><div class=fields-grid></div></div><div class=preview-table-container><div class=table-title>🔍 示例数据 (前5条):</div><div class=preview-table><table><thead><tr></tr></thead><tbody></tbody></table></div></div><div class=advanced-info><button class=advanced-toggle><span class=toggle-icon></span><span class=toggle-text>高级信息"),Eh=S("<li>首次配置数据源时，建议先测试连接确保配置正确"),Ph=S("<li>测试过程会验证JSON格式和文件访问权限"),Ah=S("<li>预览功能可以帮助您确认数据结构是否符合预期"),Rh=S("<li>✅ 连接测试成功！您可以继续创建数据源"),Lh=S("<li>预览显示的是实际数据，创建后可用于报表设计"),Mh=S("<li>字段名称将用于数据绑定表达式"),Dh=S("<li>❌ 请检查JSON格式是否正确"),Oh=S("<li>如果是文件类型，请确认文件路径存在且可访问"),Ih=S("<li>可以返回上一步修改配置后重新测试"),Nh=S("<div class=security-notice><div class=notice-icon>🔒</div><div class=notice-content><div class=notice-title>安全提示</div><div class=notice-text>应用将读取指定的JSON文件。请确保文件内容安全，避免包含敏感信息。 启用自动刷新时，应用会定期检查文件变化。"),zh=S("<div class=test-preview-step><div class=step-header><h4>🧪 测试与预览</h4><p>验证数据源配置并预览数据内容</p></div><div class=test-section><div class=test-connection><div class=test-header><div class=test-title><span class=test-icon></span><span class=test-text></span></div><button></button></div></div><div class=test-suggestions><div class=suggestions-title>💡 测试建议:</div><ul class=suggestions-list>"),Fh=S("<span class=loading-spinner>⏳"),Gh=S("<span class=test-button-icon>🔌"),Bh=S("<div class=field-tag><span class=field-name>"),Uh=S("<th>"),Hh=S("<tr>"),qh=S("<td><div class=cell-content>"),Wh=S("<span class=validation-hint><span class=hint-icon>⚠️</span>请完成当前步骤的必填项"),jh=S('<button class="control-btn next-btn"><span class=btn-text>下一步</span><span class=btn-icon>→'),Yh=S('<button class="control-btn finish-btn">'),Vh=S("<span class=hint-text>选择您的JSON数据来源方式"),Ts=S("<span class=hint-text>"),Xh=S("<span class=hint-text>设置数据源名称和选项"),Qh=S('<div class=wizard-controls><div class=controls-info><span class=current-step-info>步骤 <!> / 4: </span></div><div class=control-buttons><button class="control-btn back-btn"><span class=btn-icon>←</span><span class=btn-text>上一步</span></button></div><div class=progress-hints>'),Kh=S("<span class=btn-loading>⏳"),Jh=S("<span class=btn-text>创建中..."),Zh=S("<span class=btn-icon>✓"),eu=S("<span class=btn-text>创建数据源");function Dr(n){const[e,t]=Z({currentStep:1,sourceType:null,name:"",config:{source_type:"content",auto_refresh:!1,refresh_interval:300},validation:{isValid:!1,errors:[],warnings:[]},testResult:null,loading:!1}),i=[{step:1,title:"选择数据来源",description:"选择JSON数据的输入方式"},{step:2,title:"输入数据",description:"提供具体的JSON数据"},{step:3,title:"基础配置",description:"设置数据源名称和选项"},{step:4,title:"测试预览",description:"验证数据源并预览效果"}],s=Me(()=>{const f=e();switch(f.currentStep){case 1:return f.sourceType!==null;case 2:return r(f);case 3:return a(f);case 4:return l(f);default:return!1}}),r=f=>{if(f.sourceType==="file")return!!f.config.file_path?.trim();if(f.sourceType==="content"){const p=f.config.json_content?.trim();if(!p)return!1;try{return JSON.parse(p),!0}catch{return!1}}return!1},a=f=>{const p=f.name.trim();return!(p.length<2||p.length>50||!/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(p))},l=f=>!!f.testResult?.success,o=f=>{const p=e();t(b=>({...b,validation:{...b.validation,errors:[]}})),p.currentStep===1&&p.sourceType?t(b=>({...b,currentStep:f,config:{...b.config,source_type:p.sourceType}})):t(b=>({...b,currentStep:f}))},c=()=>{const f=e();f.currentStep<4&&s()&&o(f.currentStep+1)},d=()=>{const f=e();f.currentStep>1&&(f.currentStep===4?t(p=>({...p,currentStep:p.currentStep-1,testResult:null})):o(f.currentStep-1))},h=f=>{t(p=>({...p,...f}))},u=async()=>{const f=e();h({loading:!0,testResult:null});try{console.log("🔄 开始测试连接...");const p={...f.config,source_type:f.sourceType};if(await Ae.testConnection("json",p)){console.log("✅ 连接测试成功，获取预览数据...");const m=await Ae.discoverSchema("json",p),_=`temp_${Date.now()}`,w=await Ae.createDataSource(_,"json",p),x=await Ae.getPreview(w,void 0,5);await Ae.deleteDataSource(w),h({testResult:{success:!0,message:"连接测试成功！数据格式正确。",preview:{record_count:x.totalCount??x.total_rows??x.total_count??0,fields:m.columns.map(C=>C.name),sample_data:x.rows}},loading:!1})}}catch(p){console.error("❌ 连接测试失败:",p),h({testResult:{success:!1,message:"连接测试失败",error:p instanceof Error?p.message:String(p)},loading:!1})}},v=async()=>{const f=e();h({loading:!0});try{console.log("🔄 开始创建数据源...");const p={...f.config,source_type:f.sourceType},b=await Ae.createDataSource(f.name,"json",p);console.log("✅ 数据源创建成功，ID:",b);try{await Je.setActiveDataSource(b),console.log("✅ 数据源自动激活成功")}catch(m){console.warn("⚠️ 数据源激活失败，但创建成功:",m)}n.onSuccess(),n.onBack()}catch(p){console.error("❌ 创建数据源失败:",p),h({validation:{isValid:!1,errors:[`创建失败: ${p}`],warnings:[]},loading:!1})}};return(()=>{var f=Jd(),p=f.firstChild,b=p.firstChild,m=b.nextSibling,_=m.firstChild,w=_.nextSibling,x=p.nextSibling;return Le(b,"click",n.onBack),g(w,()=>i[e().currentStep-1]?.description),g(f,y(tu,{get currentStep(){return e().currentStep},stepInfo:i,onStepClick:o}),x),g(x,y(H,{get when(){return e().currentStep===1},get children(){return y(nu,{get selectedType(){return e().sourceType},onSelect:C=>h({sourceType:C,config:{...e().config,source_type:C}})})}}),null),g(x,y(H,{get when(){return e().currentStep===2},get children(){return y(iu,{get sourceType(){return e().sourceType},get config(){return e().config},onConfigUpdate:C=>h({config:{...e().config,...C}})})}}),null),g(x,y(H,{get when(){return e().currentStep===3},get children(){return y(ru,{get name(){return e().name},get config(){return e().config},onNameChange:C=>h({name:C}),onConfigUpdate:C=>h({config:{...e().config,...C}})})}}),null),g(x,y(H,{get when(){return e().currentStep===4},get children(){return y(lu,{get config(){return e().config},get testResult(){return e().testResult},get loading(){return e().loading},onTest:u})}}),null),g(f,y(ou,{get currentStep(){return e().currentStep},get canProceed(){return s()},get loading(){return e().loading},get testResult(){return e().testResult},onPrevious:d,onNext:c,onFinish:v}),null),g(f,y(H,{get when(){return e().validation.errors.length>0},get children(){var C=Kd();return g(C,y(fe,{get each(){return e().validation.errors},children:A=>(()=>{var M=Zd();return g(M,A),M})()})),C}}),null),f})()}function tu(n){return(()=>{var e=eh();return g(e,y(fe,{get each(){return n.stepInfo},children:t=>{const i=n.currentStep===t.step,s=n.currentStep>t.step,r=n.currentStep>=t.step;return(()=>{var a=th(),l=a.firstChild,o=l.firstChild,c=l.nextSibling,d=c.firstChild,h=d.nextSibling;return a.$$click=()=>r&&n.onStepClick(t.step),Se(a,`progress-step ${i?"active":""} ${s?"completed":""}`),g(o,()=>s?"✓":t.step),g(d,()=>t.title),g(h,()=>t.description),a})()}})),e})()}function nu(n){const e=[{type:"file",title:"📁 从文件加载",description:"从本地JSON文件导入数据",features:["支持大文件","自动刷新","适合静态数据"],example:"适合：本地配置文件、导出数据等"},{type:"content",title:"✏️ 直接输入内容",description:"粘贴或输入JSON内容",features:["快速测试","动态编辑","适合小数据"],example:"适合：API响应、临时数据、测试数据等"}];return(()=>{var t=nh(),i=t.firstChild,s=i.nextSibling;return g(s,y(fe,{each:e,children:r=>(()=>{var a=ih(),l=a.firstChild,o=l.firstChild,c=o.nextSibling,d=l.nextSibling,h=d.nextSibling,u=h.nextSibling,v=u.firstChild;return a.$$click=()=>n.onSelect(r.type),g(o,()=>r.title),g(c,()=>r.description),g(d,y(fe,{get each(){return r.features},children:f=>(()=>{var p=sh();return g(p,f),p})()})),g(h,()=>r.example),v.addEventListener("change",()=>n.onSelect(r.type)),B(()=>Se(a,`source-option ${n.selectedType===r.type?"selected":""}`)),B(()=>v.checked=n.selectedType===r.type),a})()})),t})()}function iu(n){return(()=>{var e=rh(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return g(i,()=>n.sourceType==="file"?"📁 选择JSON文件":"✏️ 输入JSON内容"),g(s,()=>n.sourceType==="file"?"请选择要导入的JSON文件，支持拖拽上传":"请粘贴或输入您的JSON数据内容"),g(e,y(H,{get when(){return n.sourceType==="file"},get children(){return y(su,{get filePath(){return n.config.file_path||""},onFileSelect:r=>n.onConfigUpdate({file_path:r})})}}),null),g(e,y(H,{get when(){return n.sourceType==="content"},get children(){return y(au,{get content(){return n.config.json_content||""},onContentChange:r=>n.onConfigUpdate({json_content:r})})}}),null),e})()}function su(n){const[e,t]=Z(!1),[i,s]=Z(null),r=o=>{const d=o.target.files?.[0];d&&l(d)},a=o=>{o.preventDefault(),t(!1);const c=o.dataTransfer?.files?.[0];c&&l(c)},l=o=>{if(s(null),!o.name.endsWith(".json")){s("请选择JSON文件（.json格式）");return}if(o.size>10*1024*1024){s("文件大小不能超过10MB");return}const c=new FileReader;c.onload=d=>{try{const h=d.target?.result;JSON.parse(h),n.onFileSelect(o.name),console.log("✅ 文件选择成功:",o.name)}catch{s("文件内容不是有效的JSON格式")}},c.readAsText(o)};return(()=>{var o=oh(),c=o.firstChild,d=c.nextSibling,h=d.firstChild,u=h.firstChild,v=d.nextSibling;return c.addEventListener("drop",a),c.addEventListener("dragleave",()=>t(!1)),c.addEventListener("dragover",f=>{f.preventDefault(),t(!0)}),u.addEventListener("change",r),g(d,y(H,{get when(){return n.filePath},get children(){var f=ah(),p=f.firstChild,b=p.nextSibling,m=b.nextSibling;return g(b,()=>n.filePath),m.$$click=()=>n.onFileSelect(""),f}}),null),g(o,y(H,{get when(){return i()},get children(){var f=lh();return g(f,i),f}}),v),B(()=>Se(c,`file-drop-zone ${e()?"active":""}`)),o})()}function ru(n){const[e,t]=Z(null),i=r=>{n.onNameChange(r),r.trim().length===0?t("数据源名称不能为空"):r.trim().length<2?t("数据源名称至少需要2个字符"):r.trim().length>50?t("数据源名称不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_]+$/.test(r.trim())?t(null):t("数据源名称只能包含中文、英文、数字、空格、连字符和下划线")},s=r=>{const a=parseInt(r);!isNaN(a)&&a>=10&&a<=3600&&n.onConfigUpdate({refresh_interval:a})};return(()=>{var r=vh(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.firstChild,d=c.nextSibling,h=d.firstChild,u=h.nextSibling,v=u.nextSibling,f=o.nextSibling,p=f.firstChild,b=p.nextSibling,m=b.firstChild,_=m.firstChild,w=_.nextSibling;return u.$$input=x=>i(x.currentTarget.value),g(d,y(H,{get when(){return e()},get children(){var x=ch();return g(x,e),x}}),v),g(l,y(H,{get when(){return n.config.source_type==="file"},get children(){var x=hh(),C=x.firstChild,A=C.nextSibling,M=A.firstChild,I=M.firstChild;return I.addEventListener("change",z=>n.onConfigUpdate({auto_refresh:z.currentTarget.checked})),g(x,y(H,{get when(){return n.config.auto_refresh},get children(){var z=dh(),E=z.firstChild,R=E.nextSibling,T=R.firstChild,U=T.nextSibling;return T.$$input=N=>s(N.currentTarget.value),U.addEventListener("change",N=>s(N.currentTarget.value)),B(()=>T.value=n.config.refresh_interval),B(()=>U.value=n.config.refresh_interval),z}}),null),B(()=>I.checked=n.config.auto_refresh),x}}),f),g(w,()=>n.config.source_type==="file"?"📁 从文件加载":"✏️ 直接输入内容"),g(b,y(H,{get when(){return n.config.source_type==="file"},get children(){return[(()=>{var x=uh(),C=x.firstChild,A=C.nextSibling;return g(A,()=>n.config.file_path||"(未选择文件)"),x})(),(()=>{var x=gh(),C=x.firstChild,A=C.nextSibling;return g(A,()=>n.config.auto_refresh?`✅ 每 ${n.config.refresh_interval} 秒检查一次`:"❌ 已关闭"),x})()]}}),null),g(b,y(H,{get when(){return n.config.source_type==="content"},get children(){var x=fh(),C=x.firstChild,A=C.nextSibling,M=A.firstChild;return g(A,()=>n.config.json_content?.length||0,M),x}}),null),B(()=>Se(u,`name-input ${e()?"error":""}`)),B(()=>u.value=n.name),r})()}function au(n){const[e,t]=Z(null),[i,s]=Z(!1),r=[{name:"简单对象",description:"单个JSON对象",content:`{
  "name": "示例数据",
  "value": 123,
  "active": true,
  "created_at": "2024-12-21"
}`},{name:"对象数组",description:"多条记录数据",content:`[
  {
    "id": 1,
    "name": "张三",
    "age": 25,
    "department": "技术部"
  },
  {
    "id": 2,
    "name": "李四", 
    "age": 30,
    "department": "销售部"
  }
]`},{name:"复杂嵌套",description:"包含嵌套对象和数组",content:`{
  "company": "示例公司",
  "employees": [
    {
      "name": "张三",
      "position": "工程师",
      "skills": ["JavaScript", "Python"],
      "contact": {
        "email": "zhang@example.com",
        "phone": "138****1234"
      }
    }
  ],
  "metadata": {
    "total": 1,
    "updated": "2024-12-21T10:30:00Z"
  }
}`}],a=o=>{if(n.onContentChange(o),o.trim())try{JSON.parse(o),t(null)}catch(c){t(c instanceof Error?c.message:"无效的JSON格式")}else t(null)},l=o=>{n.onContentChange(o.content),t(null),s(!1)};return(()=>{var o=_h(),c=o.firstChild,d=c.firstChild,h=d.nextSibling,u=h.nextSibling,v=c.nextSibling,f=v.firstChild,p=v.nextSibling;return d.$$click=()=>s(!i()),h.$$click=()=>n.onContentChange(""),g(u,y(H,{get when(){return Ce(()=>!e())()&&n.content.trim()},get children(){return ph()}}),null),g(u,y(H,{get when(){return e()},get children(){return mh()}}),null),g(o,y(H,{get when(){return i()},get children(){var b=bh(),m=b.firstChild,_=m.nextSibling;return g(_,y(fe,{each:r,children:w=>(()=>{var x=xh(),C=x.firstChild,A=C.nextSibling;return x.$$click=()=>l(w),g(C,()=>w.name),g(A,()=>w.description),x})()})),b}}),v),f.$$input=b=>a(b.currentTarget.value),g(o,y(H,{get when(){return e()},get children(){var b=yh(),m=b.firstChild,_=m.nextSibling;return g(_,e),b}}),p),B(b=>{var m=!n.content,_=`json-textarea ${e()?"error":""}`;return m!==b.e&&(h.disabled=b.e=m),_!==b.t&&Se(f,b.t=_),b},{e:void 0,t:void 0}),B(()=>f.value=n.content),o})()}function lu(n){const[e,t]=Z(!1),i=()=>n.loading?"🔄":n.testResult?n.testResult.success?"✅":"❌":"⚡",s=()=>n.loading?"测试连接中...":n.testResult?n.testResult.success?"连接测试成功":"连接测试失败":"点击测试连接",r=()=>n.loading?"testing":n.testResult?n.testResult.success?"success":"error":"ready",a=l=>typeof l=="object"?JSON.stringify(l,null,2):String(l);return(()=>{var l=zh(),o=l.firstChild,c=o.nextSibling,d=c.firstChild,h=d.firstChild,u=h.firstChild,v=u.firstChild,f=v.nextSibling,p=u.nextSibling,b=d.nextSibling,m=b.firstChild,_=m.nextSibling;return g(v,i),g(f,s),Le(p,"click",n.onTest),g(p,(()=>{var w=Ce(()=>!!n.loading);return()=>w()?[Fh(),"测试中..."]:[Gh(),"测试连接"]})()),g(d,y(H,{get when(){return n.testResult},get children(){var w=wh(),x=w.firstChild,C=x.firstChild,A=C.nextSibling;return g(C,i),g(A,()=>n.testResult.message),g(w,y(H,{get when(){return n.testResult.error},get children(){var M=Sh(),I=M.firstChild,z=I.nextSibling;return g(z,()=>n.testResult.error),M}}),null),B(()=>Se(w,`test-result ${r()}`)),w}}),null),g(c,y(H,{get when(){return n.testResult?.success&&n.testResult.preview},get children(){var w=Th(),x=w.firstChild,C=x.firstChild,A=C.nextSibling,M=A.firstChild,I=M.firstChild,z=I.nextSibling,E=M.nextSibling,R=E.firstChild,T=R.nextSibling,U=x.nextSibling,N=U.firstChild,$=N.nextSibling,P=U.nextSibling,Q=P.firstChild,G=Q.nextSibling,D=G.firstChild,V=D.firstChild,q=V.firstChild,W=V.nextSibling,j=P.nextSibling,he=j.firstChild,_e=he.firstChild;return g(z,()=>n.testResult.preview.record_count),g(T,()=>n.testResult.preview.fields.length),g($,y(fe,{get each(){return n.testResult.preview.fields},children:pe=>(()=>{var se=Bh(),ce=se.firstChild;return g(ce,pe),se})()})),g(q,y(fe,{get each(){return n.testResult.preview.fields},children:pe=>(()=>{var se=Uh();return g(se,pe),se})()})),g(W,y(fe,{get each(){return n.testResult.preview.sample_data},children:pe=>(()=>{var se=Hh();return g(se,y(fe,{get each(){return n.testResult.preview.fields},children:ce=>(()=>{var ue=qh(),ve=ue.firstChild;return g(ve,(()=>{var ne=Ce(()=>pe[ce]!==void 0);return()=>ne()?a(pe[ce]):"-"})()),ue})()})),se})()})),he.$$click=()=>t(!e()),g(_e,()=>e()?"▼":"▶"),g(j,y(H,{get when(){return e()},get children(){var pe=kh(),se=pe.firstChild,ce=se.firstChild,ue=ce.firstChild,ve=ue.nextSibling,ne=ce.nextSibling;return g(ve,()=>n.config.source_type==="file"?"JSON文件":"JSON内容"),g(se,y(H,{get when(){return n.config.source_type==="file"},get children(){return[(()=>{var ee=$h(),ge=ee.firstChild,be=ge.nextSibling;return g(be,()=>n.config.file_path),ee})(),(()=>{var ee=Ch(),ge=ee.firstChild,be=ge.nextSibling;return g(be,()=>n.config.auto_refresh?"已启用":"已禁用"),ee})()]}}),ne),pe}}),null),w}}),b),g(_,y(H,{get when(){return!n.testResult},get children(){return[Eh(),Ph(),Ah()]}}),null),g(_,y(H,{get when(){return n.testResult?.success},get children(){return[Rh(),Lh(),Mh()]}}),null),g(_,y(H,{get when(){return n.testResult&&!n.testResult.success},get children(){return[Dh(),Oh(),Ih()]}}),null),g(c,y(H,{get when(){return n.config.source_type==="file"},get children(){return Nh()}}),null),B(w=>{var x=`test-button ${r()}`,C=n.loading;return x!==w.e&&Se(p,w.e=x),C!==w.t&&(p.disabled=w.t=C),w},{e:void 0,t:void 0}),l})()}function ou(n){const e=r=>{switch(r){case 1:return"选择来源";case 2:return"输入数据";case 3:return"基础配置";case 4:return"测试预览";default:return`步骤${r}`}},t=()=>n.currentStep>1,i=()=>n.currentStep<4&&n.canProceed,s=()=>n.currentStep===4&&n.canProceed;return(()=>{var r=Qh(),a=r.firstChild,l=a.firstChild,o=l.firstChild,c=o.nextSibling;c.nextSibling;var d=a.nextSibling,h=d.firstChild,u=d.nextSibling;return g(l,()=>n.currentStep,c),g(l,()=>e(n.currentStep),null),g(a,y(H,{get when(){return!n.canProceed&&n.currentStep<4},get children(){return Wh()}}),null),Le(h,"click",n.onPrevious),g(d,y(H,{get when(){return n.currentStep<4},get children(){var v=jh();return Le(v,"click",n.onNext),B(()=>v.disabled=!i()||n.loading),v}}),null),g(d,y(H,{get when(){return n.currentStep===4},get children(){var v=Yh();return Le(v,"click",n.onFinish),g(v,(()=>{var f=Ce(()=>!!n.loading);return()=>f()?[Kh(),Jh()]:[Zh(),eu()]})()),B(()=>v.disabled=!s()||n.loading),v}}),null),g(u,y(H,{get when(){return n.currentStep===1},get children(){return Vh()}}),null),g(u,y(H,{get when(){return n.currentStep===2},get children(){var v=Ts();return g(v,()=>n.testResult?.success?"数据格式验证成功":"请提供JSON数据内容"),v}}),null),g(u,y(H,{get when(){return n.currentStep===3},get children(){return Xh()}}),null),g(u,y(H,{get when(){return n.currentStep===4},get children(){var v=Ts();return g(v,()=>n.testResult?.success?"一切就绪，可以创建数据源":"建议先测试连接以确保配置正确"),v}}),null),B(()=>h.disabled=!t()||n.loading),r})()}He(["click","input"]);var cu=S("<div class=data-sources-panel role=dialog aria-modal=true aria-labelledby=data-panel-title aria-describedby=data-panel-description><a href=#data-panel-content class=skip-to-content>跳转到内容</a><div class=panel-header><h2 id=data-panel-title>数据源管理</h2><span id=data-panel-description class=sr-only>管理JSON数据源，包括创建、编辑、测试和预览功能</span><button class=close-btn aria-label=关闭数据源面板 title=关闭数据源面板>×</button></div><div class=panel-content id=data-panel-content>"),du=S("<div class=error-message>"),hu=S("<div class=loading-message>加载中..."),uu=S("<div class=empty-state><p>尚未配置任何数据源</p><button>添加第一个数据源"),gu=S("<div class=sources-grid>"),fu=S("<div class=data-sources-list><div class=list-header><div class=list-title><h3>已配置的数据源 (<!>)</h3><button class=refresh-btn>🔄 刷新</button></div><button class=add-btn aria-label=添加新的数据源 title=创建新的JSON数据源>+ 添加数据源"),vu=S("<span class=active-badge title=当前激活>当前"),pu=S('<div class=source-card><div class=source-header><div class=source-info><h4></h4><span class=source-type></span></div><div class=source-status></div></div><div class=source-meta><div class=meta-item><span>创建时间:</span><span></span></div><div class=meta-item><span>最后更新:</span><span></span></div></div><div class=source-actions><button class="action-btn preview-btn">👁️ 预览</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn test-btn">🔌 测试</button><button class="action-btn edit-btn">✏️ 编辑</button><button class="action-btn delete-btn">🗑️ 删除'),mu=S("<span class=changes-indicator>● 有未保存的更改"),bu=S("<div class=error-details>"),yu=S("<div><div class=result-message> "),_u=S("<div class=error-message>❌ "),xu=S("<button type=button class=reset-btn>重置更改"),Su=S('<div class=edit-data-source-form><div class=form-header><button class=back-btn>← 返回</button><div class=header-info><h3>编辑数据源</h3><div class=source-meta><span class=source-type></span><span class=source-id>ID: </span></div></div></div><div class=edit-content><div class=edit-section><div class=section-header><h4>🏷️ 基本信息</h4></div><div class=form-field><label>数据源名称</label><input type=text placeholder=请输入数据源名称></div></div><div class=edit-section><div class=section-header><h4>⚙️ 配置信息</h4></div><div class=form-field><label>数据源配置</label><textarea rows=12 placeholder="数据源配置 (JSON格式)"></textarea><div class=config-hint>💡 修改配置后建议先测试连接，确保配置有效</div></div></div><div class=edit-section><div class=section-header><h4>🔌 连接测试</h4><button class=test-connection-btn></button></div></div><div class=edit-section><div class=section-header><h4>📊 数据源状态</h4></div><div class=status-grid><div class=status-item><span class=status-label>当前状态:</span><span></span></div><div class=status-item><span class=status-label>创建时间:</span><span class=status-value></span></div><div class=status-item><span class=status-label>最后更新:</span><span class=status-value></span></div></div></div><div class=form-actions><button type=button class=cancel-btn>取消</button><button type=button></button></div><div class=edit-tips><div class=tips-title>💡 编辑提示:</div><ul><li>修改配置后建议先测试连接确保有效性</li><li>保存更改后可能需要重新激活数据源</li><li>JSON配置格式错误会阻止保存</li><li>重置更改可恢复到保存前的状态'),wu=S("<div class=data-preview><div class=preview-header><button class=back-btn>← 返回</button><h3>数据预览: </h3><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table><table><thead><tr></tr></thead><tbody>"),$u=S("<th>"),Cu=S("<tr>"),ku=S("<td>");const Tu=n=>{const e=(n.type_name||n.provider_type||n.providerType||"").toLowerCase();return e.includes("database_mysql")?"MySQL":e.includes("database_postgresql")?"PostgreSQL":e==="json"?"JSON":e==="csv"?"CSV":e==="excel"?"Excel":e.startsWith("api")?"API":e.startsWith("database")?"Database":n.type_name||n.provider_type||n.providerType||"Unknown"};function Eu(n){const[e,t]=Z([]),[i,s]=Z([]),[r,a]=Z("list"),[l,o]=Z(null),[c,d]=Z(null),[h,u]=Z(!1),[v,f]=Z(null),[p,b]=Z(null);et(async()=>{try{await m(),await _();const z=Je.subscribe(E=>{b(E?.dataSource.id||null)});b(Je.getCurrentContext()?.dataSource.id||null),$t(z)}catch(z){console.error("🚨 DataSourcesPanel初始化失败:",z),f(`数据源模块初始化失败: ${z}`)}});const m=async()=>{try{u(!0),console.log("🔄 开始加载数据源列表...");const z=await Ae.listDataSources();console.log("✅ 数据源列表加载成功:",z),t(z),f(null)}catch(z){console.error("❌ 加载数据源失败:",z),f(`加载数据源失败: ${z}`)}finally{u(!1)}},_=async()=>{try{console.log("🔄 开始加载可用数据源类型...");const z=await Ae.getAvailableTypes();console.log("✅ 数据源类型加载成功:",z),s(z)}catch(z){console.error("❌ 加载数据源类型失败:",z)}},w=()=>{a("add"),o(null)},x=z=>{o(z),a("edit")},C=async z=>{try{u(!0),f(null),o(z),console.log("🔄 开始预览数据源:",z.name),z.status!=="active"&&(console.log("⚠️  数据源状态不是激活状态:",z.status),f(`数据源状态为 ${z.status}，可能无法预览数据`));const E=await Ae.getPreview(z.id);d(E),a("preview"),console.log("✅ 数据预览加载成功:",E)}catch(E){console.error("❌ 数据预览失败:",E);const R=`预览数据源 "${z.name}" 失败: ${E}`;f(R);const T={connection:"连接失败，请检查数据源配置",permission:"权限不足，请检查认证信息",not_found:"数据源或数据不存在",timeout:"请求超时，请稍后重试"},U=String(E).toLowerCase(),N=Object.keys(T).find($=>U.includes($));N&&f(`预览失败: ${T[N]}`)}finally{u(!1)}},A=async z=>{if(confirm("确定要删除这个数据源吗？"))try{await Ae.deleteDataSource(z),await m()}catch(E){f(`删除数据源失败: ${E}`)}},M=async z=>{try{u(!0),f(null),await Je.setActiveDataSource(z.id)}catch(E){console.error("❌ 激活数据源失败:",E),f(`激活数据源失败: ${E}`)}finally{u(!1)}},I=async z=>{try{u(!0),f(null),console.log("🔄 开始测试数据源连接:",z);const E=e().find(U=>U.id===z);if(!E){const U=`数据源不存在: ${z}`;console.error("❌",U),f(U);return}console.log("📋 数据源信息:",{id:E.id,name:E.name,providerType:E.providerType||E.provider_type,config:E.config});let R=E.providerType||E.provider_type||E.type_name;(E.name.includes("MySQL")||E.name.includes("数据库")||JSON.stringify(E.config).includes("mysql")||JSON.stringify(E.config).includes("3306"))&&(R="database",console.log("🗄️ 检测到数据库类型，使用provider_type: database")),console.log("🔍 调用测试连接API:",{providerType:R,config:E.config});const T=await Ae.testConnection(R,E.config||{});console.log("📨 API返回结果:",T),T?(console.log("✅ 数据源连接测试成功:",z),alert(`✅ 数据源 "${E.name}" 连接测试成功！

🎉 数据库连接正常，可以正常使用`)):(console.log("❌ 数据源连接测试失败:",z),alert(`❌ 数据源 "${E.name}" 连接测试失败

请检查配置信息是否正确`))}catch(E){console.error("❌ 测试连接时发生错误:",E),console.error("❌ 错误详情:",{error:E,errorType:typeof E,errorString:String(E),errorJSON:JSON.stringify(E,null,2)});const R=e().find(U=>U.id===z),T=`测试连接失败: ${E}`;f(T),!E||String(E)===""||String(E)==="null"?alert(`❌ 数据源 "${R?.name||z}" 连接测试遇到未知错误

请检查：
• 开发者工具控制台的详细错误信息
• 后端服务是否正常运行
• 配置参数是否正确`):alert(`❌ 数据源 "${R?.name||z}" 连接测试失败:

${E}

💡 如果是空错误，请检查开发者工具控制台获取详细信息`)}finally{u(!1)}};return y(H,{get when(){return n.isOpen},get children(){var z=cu(),E=z.firstChild,R=E.nextSibling,T=R.firstChild,U=T.nextSibling,N=U.nextSibling,$=R.nextSibling;return Le(N,"click",n.onClose),g($,y(H,{get when(){return r()==="list"},get children(){return y(Pu,{get dataSources(){return e()},get loading(){return h()},get error(){return v()},onAdd:w,onEdit:x,onPreview:C,onDelete:A,onActivate:M,onTestConnection:I,onRefresh:m,get activeId(){return p()}})}}),null),g($,y(H,{get when(){return r()==="add"},get children(){return y(Dr,{get availableTypes(){return i()},onBack:()=>a("list"),onSuccess:m})}}),null),g($,y(H,{get when(){return Ce(()=>r()==="edit")()&&l()},get children(){return y(Au,{get dataSource(){return l()},onBack:()=>a("list"),onSuccess:m})}}),null),g($,y(H,{get when(){return Ce(()=>!!(r()==="preview"&&l()))()&&c()},get children(){return y(Ru,{get dataSource(){return l()},get data(){return c()},onBack:()=>a("list")})}}),null),z}})}function Pu(n){const e=i=>{switch(i){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},t=i=>new Date(i).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(()=>{var i=fu(),s=i.firstChild,r=s.firstChild,a=r.firstChild,l=a.firstChild,o=l.nextSibling;o.nextSibling;var c=a.nextSibling,d=r.nextSibling;return g(a,()=>n.dataSources.length,o),Le(c,"click",n.onRefresh),Le(d,"click",n.onAdd),g(i,y(H,{get when(){return n.error},get children(){var h=du();return g(h,()=>n.error),h}}),null),g(i,y(H,{get when(){return n.loading},get children(){return hu()}}),null),g(i,y(H,{get when(){return!n.loading&&n.dataSources.length===0},get children(){var h=uu(),u=h.firstChild,v=u.nextSibling;return Le(v,"click",n.onAdd),h}}),null),g(i,y(H,{get when(){return!n.loading&&n.dataSources.length>0},get children(){var h=gu();return g(h,y(fe,{get each(){return n.dataSources},children:u=>(()=>{var v=pu(),f=v.firstChild,p=f.firstChild,b=p.firstChild,m=b.nextSibling,_=p.nextSibling,w=f.nextSibling,x=w.firstChild,C=x.firstChild,A=C.nextSibling,M=x.nextSibling,I=M.firstChild,z=I.nextSibling,E=w.nextSibling,R=E.firstChild,T=R.nextSibling,U=T.nextSibling,N=U.nextSibling,$=N.nextSibling;return g(b,()=>u.name,null),g(b,y(H,{get when(){return n.activeId===u.id},get children(){return vu()}}),null),g(m,()=>Tu(u)),g(A,()=>t(u.createdAt||u.created_at)),g(z,()=>t(u.lastUpdated||u.last_updated)),R.$$click=()=>n.onPreview(u),T.$$click=()=>n.onActivate(u),U.$$click=()=>n.onTestConnection(u.id),N.$$click=()=>n.onEdit(u),$.$$click=()=>n.onDelete(u.id),B(P=>{var Q=n.activeId===u.id?"true":"false",G=e(u.status),D=`状态: ${u.status}`,V=u.status!=="active",q=n.activeId===u.id;return Q!==P.e&&X(v,"data-active",P.e=Q),G!==P.t&&((P.t=G)!=null?_.style.setProperty("background-color",G):_.style.removeProperty("background-color")),D!==P.a&&X(_,"title",P.a=D),V!==P.o&&(R.disabled=P.o=V),q!==P.i&&(T.disabled=P.i=q),P},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),v})()})),h}}),null),B(h=>{var u=n.loading,v=n.loading?"正在刷新数据源列表":"刷新数据源列表",f=n.loading?"正在刷新...":"刷新数据源列表";return u!==h.e&&(c.disabled=h.e=u),v!==h.t&&X(c,"aria-label",h.t=v),f!==h.a&&X(c,"title",h.a=f),h},{e:void 0,t:void 0,a:void 0}),i})()}function Au(n){const[e,t]=Z({name:n.dataSource.name,config:n.dataSource.config||{},loading:!1,error:null,testResult:null,hasChanges:!1}),[i]=Z(JSON.stringify(n.dataSource.config||{})),s=()=>{const d=e(),h=d.name!==n.dataSource.name,u=JSON.stringify(d.config)!==i();t(v=>({...v,hasChanges:h||u}))},r=d=>{t(h=>({...h,name:d})),s()},a=d=>{t(h=>({...h,config:d})),s()},l=async()=>{const d=e();t(h=>({...h,loading:!0,testResult:null}));try{console.log("🔄 测试连接配置..."),await Ae.testConnection(n.dataSource.providerType||n.dataSource.provider_type,d.config)&&(console.log("✅ 连接测试成功"),t(u=>({...u,testResult:{success:!0,message:"连接测试成功！配置有效。"},loading:!1})))}catch(h){console.error("❌ 连接测试失败:",h),t(u=>({...u,testResult:{success:!1,message:"连接测试失败",error:h instanceof Error?h.message:String(h)},loading:!1}))}},o=async()=>{const d=e();if(!d.hasChanges){n.onBack();return}if(!d.name.trim()){t(h=>({...h,error:"数据源名称不能为空"}));return}try{t(h=>({...h,loading:!0,error:null})),console.log("🔄 更新数据源配置..."),await Ae.updateConfig(n.dataSource.id,d.config),d.name!==n.dataSource.name?(console.log("⚠️  名称更新功能待实现，当前只更新了配置"),t(h=>({...h,error:"配置已更新，但名称更新功能待实现"}))):console.log("✅ 数据源配置更新成功"),n.onSuccess(),n.onBack()}catch(h){console.error("❌ 更新数据源失败:",h),t(u=>({...u,error:`更新失败: ${h}`,loading:!1}))}},c=()=>{t(d=>({...d,name:n.dataSource.name,config:n.dataSource.config||{},hasChanges:!1,error:null,testResult:null}))};return(()=>{var d=Su(),h=d.firstChild,u=h.firstChild,v=u.nextSibling,f=v.firstChild,p=f.nextSibling,b=p.firstChild,m=b.nextSibling;m.firstChild;var _=h.nextSibling,w=_.firstChild,x=w.firstChild,C=x.nextSibling,A=C.firstChild,M=A.nextSibling,I=w.nextSibling,z=I.firstChild;z.firstChild;var E=z.nextSibling,R=E.firstChild,T=R.nextSibling,U=I.nextSibling,N=U.firstChild,$=N.firstChild,P=$.nextSibling,Q=U.nextSibling,G=Q.firstChild,D=G.nextSibling,V=D.firstChild,q=V.firstChild,W=q.nextSibling,j=V.nextSibling,he=j.firstChild,_e=he.nextSibling,pe=j.nextSibling,se=pe.firstChild,ce=se.nextSibling,ue=Q.nextSibling,ve=ue.firstChild,ne=ve.nextSibling;return Le(u,"click",n.onBack),g(b,()=>n.dataSource.providerType||n.dataSource.type_name),g(m,()=>n.dataSource.id,null),M.$$input=ee=>r(ee.currentTarget.value),g(z,y(H,{get when(){return e().hasChanges},get children(){return mu()}}),null),T.$$input=ee=>{try{const ge=JSON.parse(ee.currentTarget.value);a(ge),t(be=>({...be,error:null}))}catch{t(be=>({...be,error:"配置格式错误，请检查JSON语法"}))}},P.$$click=l,g(P,()=>e().loading?"测试中...":"测试连接"),g(U,y(H,{get when(){return e().testResult},get children(){var ee=yu(),ge=ee.firstChild,be=ge.firstChild;return g(ge,()=>e().testResult?.success?"✅":"❌",be),g(ge,()=>e().testResult?.message,null),g(ee,y(H,{get when(){return e().testResult?.error},get children(){var ke=bu();return g(ke,()=>e().testResult?.error),ke}}),null),B(()=>Se(ee,`test-result ${e().testResult?.success?"success":"error"}`)),ee}}),null),g(W,()=>n.dataSource.status==="active"?"✅ 活跃":n.dataSource.status==="error"?"❌ 错误":"⚠️ 未知"),g(_e,()=>new Date(n.dataSource.createdAt||n.dataSource.created_at).toLocaleString("zh-CN")),g(ce,()=>new Date(n.dataSource.lastUpdated||n.dataSource.last_updated).toLocaleString("zh-CN")),g(_,y(H,{get when(){return e().error},get children(){var ee=_u();return ee.firstChild,g(ee,()=>e().error,null),ee}}),ue),Le(ve,"click",n.onBack),g(ue,y(H,{get when(){return e().hasChanges},get children(){var ee=xu();return ee.$$click=c,B(()=>ee.disabled=e().loading),ee}}),ne),ne.$$click=o,g(ne,(()=>{var ee=Ce(()=>!!e().loading);return()=>ee()?"保存中...":e().hasChanges?"保存更改":"无更改"})()),B(ee=>{var ge=e().error&&!e().name.trim()?"error":"",be=e().error&&e().error?.includes("配置格式")?"error":"",ke=e().loading,ye=`status-value status-${n.dataSource.status}`,Pe=`save-btn ${e().hasChanges?"has-changes":""}`,de=e().loading;return ge!==ee.e&&Se(M,ee.e=ge),be!==ee.t&&Se(T,ee.t=be),ke!==ee.a&&(P.disabled=ee.a=ke),ye!==ee.o&&Se(W,ee.o=ye),Pe!==ee.i&&Se(ne,ee.i=Pe),de!==ee.n&&(ne.disabled=ee.n=de),ee},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),B(()=>M.value=e().name),B(()=>T.value=JSON.stringify(e().config,null,2)),d})()}function Ru(n){return(()=>{var e=wu(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;s.firstChild;var r=s.nextSibling,a=r.firstChild,l=a.nextSibling,o=l.nextSibling,c=o.nextSibling;c.nextSibling;var d=t.nextSibling,h=d.firstChild,u=h.firstChild,v=u.firstChild,f=u.nextSibling;return Le(i,"click",n.onBack),g(s,()=>n.dataSource.name,null),g(r,()=>n.data.totalCount??n.data.total_rows,l),g(r,()=>n.data.rows.length,c),g(v,y(fe,{get each(){return n.data.columns},children:p=>(()=>{var b=$u();return g(b,p),b})()})),g(f,y(fe,{get each(){return n.data.rows.slice(0,50)},children:p=>(()=>{var b=Cu();return g(b,y(fe,{get each(){return n.data.columns},children:m=>(()=>{var _=ku();return g(_,(()=>{var w=Ce(()=>typeof p[m]=="object");return()=>w()?JSON.stringify(p[m]):String(p[m]||"")})()),_})()})),b})()})),e})()}He(["click","input"]);var Lu=S("<div class=empty-context><div class=empty-icon>📭</div><div class=empty-title>暂无数据源</div><div class=empty-description>请在数据源面板中创建并选择一个数据源"),Mu=S("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>加载中..."),Du=S("<div class=data-context-panel><div class=panel-header><h3 class=panel-title>📋 数据上下文</h3><div class=status-indicator><span class=status-icon></span><span class=status-text>"),Ou=S("<div class=current-record>"),Iu=S("<div class=empty-record>暂无记录数据"),Nu=S("<div class=available-fields>"),zu=S("<div class=no-fields>暂无可用字段"),Fu=S('<div class=context-content><div class=section><div class=section-header><h4 class=section-title>🗄️ 数据源信息</h4></div><div class=data-source-info><div class=info-item><span class=info-label>名称:</span><span class=info-value></span></div><div class=info-item><span class=info-label>类型:</span><span class=info-value></span></div><div class=info-item><span class=info-label>ID:</span><span class="info-value info-id"></span></div></div></div><div class=section><div class=section-header><h4 class=section-title>🔢 记录导航</h4></div><div class=navigation-controls><button class=nav-button title=上一条记录>⬅️</button><span class=record-info> / </span><button class=nav-button title=下一条记录>➡️</button></div></div><div class=section><div class=section-header><h4 class=section-title>📋 当前记录</h4></div></div><div class=section><div class=section-header><h4 class=section-title>🔍 可用字段</h4><div class=field-count>(<!> 个字段)'),Gu=S("<div class=record-field><div class=field-key>:</div><div class=field-value>"),Bu=S("<div class=field-display-name>"),Uu=S("<div class=field-sample>示例: "),Hu=S("<div class=field-item><div class=field-header><span class=field-name></span><span class=field-type>(<!>)</span></div><div class=field-expression>表达式: <code>"),qu=S("<details class=error-details><summary>详细信息</summary><pre class=error-details-content>"),Wu=S('<div class="section error-section"><div class=section-header><h4 class="section-title error-title">❌ 错误信息</h4></div><div class=error-content><div class=error-type>错误类型: </div><div class=error-message>错误描述: ');const Es=()=>{const[n,e]=Z(null),[t,i]=Z(!1);mn(()=>{const c=Je.subscribe(d=>{e(d)});return e(Je.getCurrentContext()),c});const s=Me(()=>{const c=n();if(!c)return{text:"未选择数据源",color:"#666",icon:"📂"};switch(c.dataSource.status){case"ready":return{text:`数据已就绪 - ${c.dataSource.name}`,color:"#52c41a",icon:"✅"};case"loading":return{text:"正在加载数据...",color:"#1890ff",icon:"⏳"};case"error":return{text:"数据加载失败",color:"#ff4d4f",icon:"❌"};case"empty":return{text:"数据源为空",color:"#faad14",icon:"📭"};default:return{text:"未知状态",color:"#666",icon:"❓"}}}),r=async()=>{i(!0);try{await Je.navigateNext()}catch(c){console.error("导航到下一记录失败:",c)}finally{i(!1)}},a=async()=>{i(!0);try{await Je.navigatePrevious()}catch(c){console.error("导航到上一记录失败:",c)}finally{i(!1)}},l=c=>c==null?"(空)":typeof c=="string"?`"${c}"`:typeof c=="object"?JSON.stringify(c,null,2):String(c),o=c=>({string:"文本",number:"数字",boolean:"布尔",date:"日期",object:"对象",array:"数组"})[c]||c;return(()=>{var c=Du(),d=c.firstChild,h=d.firstChild,u=h.nextSibling,v=u.firstChild,f=v.nextSibling;return g(v,()=>s().icon),g(f,()=>s().text),g(c,y(H,{get when(){return n()},children:p=>(()=>{var b=Fu(),m=b.firstChild,_=m.firstChild,w=_.nextSibling,x=w.firstChild,C=x.firstChild,A=C.nextSibling,M=x.nextSibling,I=M.firstChild,z=I.nextSibling,E=M.nextSibling,R=E.firstChild,T=R.nextSibling,U=m.nextSibling,N=U.firstChild,$=N.nextSibling,P=$.firstChild,Q=P.nextSibling,G=Q.firstChild,D=Q.nextSibling,V=U.nextSibling;V.firstChild;var q=V.nextSibling,W=q.firstChild,j=W.firstChild,he=j.nextSibling,_e=he.firstChild,pe=_e.nextSibling;return pe.nextSibling,g(A,()=>p().dataSource.name),g(z,()=>p().dataSource.type.toUpperCase()),g(T,()=>p().dataSource.id),P.$$click=a,g(Q,()=>p().currentRecord.index+1,G),g(Q,()=>p().currentRecord.total,null),D.$$click=r,g(V,y(H,{get when(){return Object.keys(p().currentRecord.data).length>0},get children(){var se=Ou();return g(se,y(fe,{get each(){return Object.entries(p().currentRecord.data)},children:([ce,ue])=>(()=>{var ve=Gu(),ne=ve.firstChild,ee=ne.firstChild,ge=ne.nextSibling;return g(ne,ce,ee),g(ge,()=>l(ue)),ve})()})),se}}),null),g(V,y(H,{get when(){return Object.keys(p().currentRecord.data).length===0},get children(){return Iu()}}),null),g(he,()=>p().fields.length,pe),g(q,y(H,{get when(){return p().fields.length>0},get children(){var se=Nu();return g(se,y(fe,{get each(){return p().fields},children:ce=>(()=>{var ue=Hu(),ve=ue.firstChild,ne=ve.firstChild,ee=ne.nextSibling,ge=ee.firstChild,be=ge.nextSibling;be.nextSibling;var ke=ve.nextSibling,ye=ke.firstChild,Pe=ye.nextSibling;return g(ne,()=>ce.name),g(ee,()=>o(ce.type),be),g(ue,y(H,{get when(){return ce.displayName&&ce.displayName!==ce.name},get children(){var de=Bu();return g(de,()=>ce.displayName),de}}),ke),g(ue,y(H,{get when(){return ce.sample!==void 0},get children(){var de=Uu();return de.firstChild,g(de,()=>l(ce.sample),null),de}}),ke),g(Pe,()=>`{${ce.name}}`),ue})()})),se}}),null),g(q,y(H,{get when(){return p().fields.length===0},get children(){return zu()}}),null),g(b,y(H,{get when(){return p().error},children:se=>(()=>{var ce=Wu(),ue=ce.firstChild,ve=ue.nextSibling,ne=ve.firstChild;ne.firstChild;var ee=ne.nextSibling;return ee.firstChild,g(ne,()=>se().type,null),g(ee,()=>se().message,null),g(ve,y(H,{get when(){return se().details},get children(){var ge=qu(),be=ge.firstChild,ke=be.nextSibling;return g(ke,()=>JSON.stringify(se().details,null,2)),ge}}),null),ce})()}),null),B(se=>{var ce=t()||p().currentRecord.index<=0,ue=t()||p().currentRecord.index>=p().currentRecord.total-1;return ce!==se.e&&(P.disabled=se.e=ce),ue!==se.t&&(D.disabled=se.t=ue),se},{e:void 0,t:void 0}),b})()}),null),g(c,y(H,{get when(){return!n()},get children(){return Lu()}}),null),g(c,y(H,{get when(){return t()},get children(){return Mu()}}),null),B(p=>(p=s().color)!=null?f.style.setProperty("color",p):f.style.removeProperty("color")),c})()};He(["click"]);var ju=S(`<div class=sql-editor><div class=editor-toolbar><div class=toolbar-left><span class=editor-label>SQL编辑器</span><span class=database-type>(<!>)</span></div><div class=toolbar-right><span class=cursor-position>行 <!>, 列 </span><span class=character-count> 字符</span></div></div><div class=template-toolbar><span class=template-label>模板:</span></div><div><textarea class=sql-textarea placeholder="请输入SQL查询语句...

示例:
SELECT u.username, u.email, COUNT(o.id) as order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at >= '2024-01-01'
GROUP BY u.id, u.username, u.email
ORDER BY order_count DESC
LIMIT 10;"rows=15></textarea><div class=line-numbers></div></div><div class=editor-help><div class=help-item><kbd>Tab</kbd> 缩进</div><div class=help-item><kbd>Ctrl+F</kbd> 格式化</div><div class=help-item><kbd>Enter</kbd> 自动缩进</div></div><style>
        .sql-editor {
          display: flex;
          flex-direction: column;
          border: 1px solid #ddd;
          border-radius: 6px;
          background: white;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .editor-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          background: #f8f9fa;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .toolbar-left {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .editor-label {
          font-weight: bold;
          color: #2c3e50;
        }

        .database-type {
          background: #3498db;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
          gap: 12px;
          color: #666;
        }

        .template-toolbar {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f1f3f5;
          border-bottom: 1px solid #ddd;
          font-size: 12px;
        }

        .template-label {
          color: #666;
          font-weight: bold;
        }

        .template-btn {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 4px;
          padding: 4px 8px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .template-btn:hover:not(:disabled) {
          background: #dee2e6;
          border-color: #adb5bd;
        }

        .template-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .editor-container {
          position: relative;
          flex: 1;
          min-height: 300px;
        }

        .editor-container.focused {
          box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editor-container.disabled {
          opacity: 0.6;
          pointer-events: none;
        }

        .sql-textarea {
          width: 100%;
          height: 100%;
          padding: 12px 12px 12px 48px;
          border: none;
          outline: none;
          resize: vertical;
          font-family: inherit;
          font-size: 14px;
          line-height: 1.5;
          background: transparent;
        }

        .line-numbers {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 36px;
          background: #f8f9fa;
          border-right: 1px solid #e9ecef;
          padding: 12px 4px;
          user-select: none;
          overflow: hidden;
        }

        .line-number {
          text-align: right;
          font-size: 12px;
          color: #6c757d;
          line-height: 1.5;
          padding-right: 8px;
        }

        .editor-help {
          display: flex;
          justify-content: center;
          gap: 16px;
          padding: 6px;
          background: #f8f9fa;
          border-top: 1px solid #ddd;
          font-size: 11px;
          color: #666;
        }

        .help-item {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        kbd {
          background: #e9ecef;
          border: 1px solid #ced4da;
          border-radius: 3px;
          padding: 2px 4px;
          font-size: 10px;
          font-family: inherit;
        }
      `),Yu=S("<button class=template-btn>"),Vu=S("<div class=line-number>");function Xu(n){let e;const[t,i]=Z(!1),[s,r]=Z({line:1,column:1}),a=u=>{const v=u.target;n.onSQLChange(v.value),l()},l=()=>{if(!e)return;const u=e.selectionStart,f=n.sql.substring(0,u).split(`
`);r({line:f.length,column:(f[f.length-1]||"").length+1})},o=u=>{if(!e||n.disabled)return;const v=u.target,f=v.selectionStart,p=v.selectionEnd;if(u.key==="Tab"){u.preventDefault();const b=n.sql.substring(0,f)+"  "+n.sql.substring(p);n.onSQLChange(b),setTimeout(()=>{e&&(e.selectionStart=e.selectionEnd=f+2,l())},0)}else if(u.key==="Enter"){const b=n.sql.substring(0,f).split(`
`),m=b[b.length-1],_=m?.match(/^\s*/)?.[0]||"",w=m?.trim().toUpperCase()||"",C=["SELECT","FROM","WHERE","GROUP BY","ORDER BY","HAVING"].some(A=>w.endsWith(A)||w.includes(A+" "))?_+"  ":_;if(C){u.preventDefault();const A=n.sql.substring(0,f)+`
`+C+n.sql.substring(p);n.onSQLChange(A),setTimeout(()=>{if(e){const M=f+1+C.length;e.selectionStart=e.selectionEnd=M,l()}},0)}}},c=u=>{(u.ctrlKey||u.metaKey)&&u.key==="f"&&(u.preventDefault(),console.log("格式化快捷键触发"))},d=u=>{if(!e||n.disabled)return;const v=e.selectionStart,f=e.selectionEnd,p=n.sql.substring(0,v)+u+n.sql.substring(f);n.onSQLChange(p),setTimeout(()=>{e&&(e.focus(),e.selectionStart=e.selectionEnd=v+u.length,l())},0)};et(()=>{l(),e&&(e.addEventListener("selectionchange",l),e.addEventListener("click",l))});const h=[{name:"基础查询",template:"SELECT * FROM table_name WHERE condition;"},{name:"联表查询",template:`SELECT t1.*, t2.*
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.table1_id
WHERE condition;`},{name:"聚合查询",template:`SELECT column, COUNT(*), AVG(value)
FROM table_name
GROUP BY column
HAVING COUNT(*) > 1
ORDER BY column;`},{name:"子查询",template:`SELECT *
FROM table1
WHERE column IN (
  SELECT column
  FROM table2
  WHERE condition
);`}];return(()=>{var u=ju(),v=u.firstChild,f=v.firstChild,p=f.firstChild,b=p.nextSibling,m=b.firstChild,_=m.nextSibling;_.nextSibling;var w=f.nextSibling,x=w.firstChild,C=x.firstChild,A=C.nextSibling;A.nextSibling;var M=x.nextSibling,I=M.firstChild,z=v.nextSibling;z.firstChild;var E=z.nextSibling,R=E.firstChild,T=R.nextSibling;g(b,()=>n.databaseType.toUpperCase(),_),g(x,()=>s().line,A),g(x,()=>s().column,null),g(M,()=>n.sql.length,I),g(z,()=>h.map(N=>(()=>{var $=Yu();return $.$$click=()=>d(N.template),g($,()=>N.name),B(P=>{var Q=n.disabled,G=`插入${N.name}模板`;return Q!==P.e&&($.disabled=P.e=Q),G!==P.t&&X($,"title",P.t=G),P},{e:void 0,t:void 0}),$})()),null),R.addEventListener("blur",()=>i(!1)),R.addEventListener("focus",()=>i(!0)),R.addEventListener("keypress",c),R.$$keydown=o,R.$$input=a;var U=e;return typeof U=="function"?Vn(U,R):e=R,X(R,"spellcheck",!1),g(T,()=>n.sql.split(`
`).map((N,$)=>(()=>{var P=Vu();return g(P,$+1),P})())),B(N=>{var $=`editor-container ${t()?"focused":""} ${n.disabled?"disabled":""}`,P=n.disabled;return $!==N.e&&Se(E,N.e=$),P!==N.t&&(R.disabled=N.t=P),N},{e:void 0,t:void 0}),B(()=>R.value=n.sql),u})()}He(["input","keydown","click"]);var Qu=S("<div class=empty-message><p>请选择要查询的字段</p><button>自动选择字段"),Ku=S("<div class=builder-section><div class=section-header><h4>🔗 表关联 (JOIN)</h4><button class=add-btn>+ 添加关联</button></div><div class=joins-list>"),Ju=S(`<div class=visual-query-builder><div class=query-options><label class=option-checkbox><input type=checkbox><span>去重查询 (DISTINCT)</span></label></div><div class=builder-section><div class=section-header><h4>📋 选择字段 (SELECT)</h4><button class=add-btn>+ 添加字段</button></div><div class=fields-list></div></div><div class=builder-section><div class=section-header><h4>🔍 筛选条件 (WHERE)</h4><button class=add-btn>+ 添加条件</button></div><div class=where-list></div></div><div class=builder-section><div class=section-header><h4>⚙️ 其他选项</h4></div><div class=options-grid><div class=option-group><label>限制行数 (LIMIT):</label><input type=number placeholder=无限制 min=1 max=10000></div></div></div><style>
        .visual-query-builder {
          display: flex;
          flex-direction: column;
          gap: 20px;
          padding: 16px;
          background: #f8f9fa;
          border-radius: 8px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .query-options {
          display: flex;
          gap: 16px;
        }

        .option-checkbox {
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
        }

        .builder-section {
          background: white;
          border-radius: 6px;
          padding: 16px;
          border: 1px solid #dee2e6;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e9ecef;
        }

        .section-header h4 {
          margin: 0;
          color: #2c3e50;
          font-size: 14px;
        }

        .add-btn {
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
        }

        .add-btn:hover:not(:disabled) {
          background: #218838;
        }

        .field-item, .join-item, .where-item {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
          padding: 8px;
          background: #f8f9fa;
          border-radius: 4px;
          flex-wrap: wrap;
        }

        .join-condition {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .separator {
          font-weight: bold;
          color: #6c757d;
        }

        select, input {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          border-radius: 3px;
          font-size: 13px;
        }

        select {
          background: white;
        }

        input[type="text"] {
          min-width: 100px;
          flex: 1;
        }

        input[type="number"] {
          width: 100px;
        }

        .remove-btn {
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          cursor: pointer;
          font-size: 14px;
        }

        .remove-btn:hover:not(:disabled) {
          background: #c82333;
        }

        .empty-message {
          text-align: center;
          padding: 20px;
          color: #6c757d;
        }

        .empty-message button {
          background: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 8px 16px;
          cursor: pointer;
          margin-top: 8px;
        }

        .options-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
        }

        .option-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .option-group label {
          font-weight: bold;
          color: #495057;
          font-size: 13px;
        }

        button:disabled, select:disabled, input:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      `),Zu=S('<div class=field-item><select></select><span class=separator>.</span><select></select><select><option value>无聚合</option><option value=COUNT>COUNT</option><option value=SUM>SUM</option><option value=AVG>AVG</option><option value=MIN>MIN</option><option value=MAX>MAX</option><option value=DISTINCT>DISTINCT</option></select><input type=text placeholder="别名 (可选)"><button class=remove-btn>×'),Rt=S("<option>"),eg=S("<option> (<!>)"),tg=S("<div class=join-item><select><option value=INNER>INNER JOIN</option><option value=LEFT>LEFT JOIN</option><option value=RIGHT>RIGHT JOIN</option><option value=FULL>FULL JOIN</option></select><div class=join-condition><select></select><select></select><span>=</span><select></select><select></select></div><button class=remove-btn>×"),ng=S("<select><option value=AND>AND</option><option value=OR>OR"),ig=S("<input type=text>"),sg=S('<div class=where-item><select></select><select></select><select><option value="=">=</option><option value="!=">!=</option><option value=">">&gt;</option><option value="<">&lt;</option><option value=">=">&gt;=</option><option value="<=">&lt;=</option><option value=LIKE>LIKE</option><option value=IN>IN</option><option value="IS NULL">IS NULL</option><option value="IS NOT NULL">IS NOT NULL</option></select><button class=remove-btn>×');function rg(n){const[e,t]=Z([]),[i,s]=Z([]),[r,a]=Z([]),[l]=Z([]),[o]=Z([]),[c,d]=Z(void 0),[h,u]=Z(!1),v=Me(()=>n.schema?.schemas?.[0]?.tables?n.schema.schemas[0].tables.filter(R=>n.selectedTables.includes(R.name)):[]),f=R=>v().find(U=>U.name===R)?.columns||[],p=Me(()=>{const R=v();if(R.length===0||e().length===0)return"";let T="";T+=h()?"SELECT DISTINCT ":"SELECT ";const U=e().map(G=>{let D=`${G.table}.${G.column}`;return G.aggregate&&(G.aggregate==="DISTINCT"?D=`DISTINCT ${D}`:D=`${G.aggregate}(${D})`),G.alias&&(D+=` AS ${G.alias}`),D});T+=U.join(`,
       `),T+=`
FROM ${R[0]?.name||"table1"}`;const N=i();for(const G of N)T+=`
${G.joinType} JOIN ${G.rightTable} ON ${G.leftTable}.${G.leftColumn} = ${G.rightTable}.${G.rightColumn}`;const $=r();if($.length>0){T+=`
WHERE `;const G=$.map((D,V)=>{let q="";return V>0&&(q+=`${D.logicalOperator} `),q+=`${D.table}.${D.column} ${D.operator}`,["IS NULL","IS NOT NULL"].includes(D.operator)||(D.operator==="IN"?q+=` (${D.value})`:D.operator==="LIKE"?q+=` '%${D.value}%'`:q+=` '${D.value}'`),q});T+=G.join(" ")}const P=o();P.length>0&&(T+=`
GROUP BY ${P.join(", ")}`);const Q=l();if(Q.length>0){const G=Q.map(D=>`${D.table}.${D.column} ${D.direction}`);T+=`
ORDER BY ${G.join(", ")}`}return c()&&(T+=`
LIMIT ${c()}`),T});et(()=>{m()});const b=()=>{n.onQueryChange(p())},m=()=>{const R=v();if(R.length===0)return;const T=[];R.forEach(U=>{(U.columns?.slice(0,3)||[]).forEach($=>{T.push({table:U.name,column:$.name})})}),t(T),b()},_=()=>{const R=v();if(R.length===0)return;const T=R[0];if(!T)return;const U=T.columns?.[0]?.name||"id";t(N=>[...N,{table:T.name,column:U}]),b()},w=R=>{t(T=>T.filter((U,N)=>N!==R)),b()},x=(R,T)=>{t(U=>U.map((N,$)=>{if($===R){const P={...N,...T};return T.hasOwnProperty("aggregate")&&T.aggregate===void 0&&delete P.aggregate,T.hasOwnProperty("alias")&&T.alias===void 0&&delete P.alias,P}return N})),b()},C=()=>{const R=v();if(R.length<2)return;const T=R[0],U=R[1];if(!T||!U)return;const N=T.columns?.[0]?.name||"id",$=U.columns?.[0]?.name||"id",P={id:Date.now().toString(),leftTable:T.name,leftColumn:N,rightTable:U.name,rightColumn:$,joinType:"INNER"};s(Q=>[...Q,P]),b()},A=R=>{s(T=>T.filter(U=>U.id!==R)),b()},M=(R,T)=>{s(U=>U.map(N=>N.id===R?{...N,...T}:N)),b()},I=()=>{const R=v();if(R.length===0)return;const T=R[0];if(!T)return;const U=T.columns?.[0]?.name||"id",N={id:Date.now().toString(),table:T.name,column:U,operator:"=",value:"",logicalOperator:"AND"};a($=>[...$,N]),b()},z=R=>{a(T=>T.filter(U=>U.id!==R)),b()},E=(R,T)=>{a(U=>U.map(N=>N.id===R?{...N,...T}:N)),b()};return(()=>{var R=Ju(),T=R.firstChild,U=T.firstChild,N=U.firstChild,$=T.nextSibling,P=$.firstChild,Q=P.firstChild,G=Q.nextSibling,D=P.nextSibling,V=$.nextSibling,q=V.firstChild,W=q.firstChild,j=W.nextSibling,he=q.nextSibling,_e=V.nextSibling,pe=_e.firstChild,se=pe.nextSibling,ce=se.firstChild,ue=ce.firstChild,ve=ue.nextSibling;return N.addEventListener("change",ne=>{u(ne.currentTarget.checked),b()}),G.$$click=_,g(D,y(fe,{get each(){return e()},children:(ne,ee)=>(()=>{var ge=Zu(),be=ge.firstChild,ke=be.nextSibling,ye=ke.nextSibling,Pe=ye.nextSibling,de=Pe.nextSibling,xe=de.nextSibling;return be.addEventListener("change",L=>{const Y=v().find(te=>te.name===L.currentTarget.value)?.columns?.[0]?.name||"id";x(ee(),{table:L.currentTarget.value,column:Y})}),g(be,y(fe,{get each(){return v()},children:L=>(()=>{var O=Rt();return g(O,()=>L.name),B(()=>O.value=L.name),O})()})),ye.addEventListener("change",L=>x(ee(),{column:L.currentTarget.value})),g(ye,y(fe,{get each(){return f(ne.table)},children:L=>(()=>{var O=eg(),K=O.firstChild,Y=K.nextSibling;return Y.nextSibling,g(O,()=>L.name,K),g(O,()=>L.data_type,Y),B(()=>O.value=L.name),O})()})),Pe.addEventListener("change",L=>{const O=L.currentTarget.value;O===""?x(ee(),{aggregate:void 0}):x(ee(),{aggregate:O})}),de.$$input=L=>{const O=L.currentTarget.value;O===""?x(ee(),{alias:void 0}):x(ee(),{alias:O})},xe.$$click=()=>w(ee()),B(L=>{var O=n.disabled,K=n.disabled,Y=n.disabled,te=n.disabled,oe=n.disabled;return O!==L.e&&(be.disabled=L.e=O),K!==L.t&&(ye.disabled=L.t=K),Y!==L.a&&(Pe.disabled=L.a=Y),te!==L.o&&(de.disabled=L.o=te),oe!==L.i&&(xe.disabled=L.i=oe),L},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),B(()=>be.value=ne.table),B(()=>ye.value=ne.column),B(()=>Pe.value=ne.aggregate||""),B(()=>de.value=ne.alias||""),ge})()}),null),g(D,y(H,{get when(){return e().length===0},get children(){var ne=Qu(),ee=ne.firstChild,ge=ee.nextSibling;return ge.$$click=m,B(()=>ge.disabled=n.disabled),ne}}),null),g(R,y(H,{get when(){return v().length>1},get children(){var ne=Ku(),ee=ne.firstChild,ge=ee.firstChild,be=ge.nextSibling,ke=ee.nextSibling;return be.$$click=C,g(ke,y(fe,{get each(){return i()},children:ye=>(()=>{var Pe=tg(),de=Pe.firstChild,xe=de.nextSibling,L=xe.firstChild,O=L.nextSibling,K=O.nextSibling,Y=K.nextSibling,te=Y.nextSibling,oe=xe.nextSibling;return de.addEventListener("change",ae=>M(ye.id,{joinType:ae.currentTarget.value})),L.addEventListener("change",ae=>M(ye.id,{leftTable:ae.currentTarget.value})),g(L,y(fe,{get each(){return v()},children:ae=>(()=>{var $e=Rt();return g($e,()=>ae.name),B(()=>$e.value=ae.name),$e})()})),O.addEventListener("change",ae=>M(ye.id,{leftColumn:ae.currentTarget.value})),g(O,y(fe,{get each(){return f(ye.leftTable)},children:ae=>(()=>{var $e=Rt();return g($e,()=>ae.name),B(()=>$e.value=ae.name),$e})()})),Y.addEventListener("change",ae=>M(ye.id,{rightTable:ae.currentTarget.value})),g(Y,y(fe,{get each(){return v()},children:ae=>(()=>{var $e=Rt();return g($e,()=>ae.name),B(()=>$e.value=ae.name),$e})()})),te.addEventListener("change",ae=>M(ye.id,{rightColumn:ae.currentTarget.value})),g(te,y(fe,{get each(){return f(ye.rightTable)},children:ae=>(()=>{var $e=Rt();return g($e,()=>ae.name),B(()=>$e.value=ae.name),$e})()})),oe.$$click=()=>A(ye.id),B(ae=>{var $e=n.disabled,Ie=n.disabled,Te=n.disabled,Ye=n.disabled,We=n.disabled,lt=n.disabled;return $e!==ae.e&&(de.disabled=ae.e=$e),Ie!==ae.t&&(L.disabled=ae.t=Ie),Te!==ae.a&&(O.disabled=ae.a=Te),Ye!==ae.o&&(Y.disabled=ae.o=Ye),We!==ae.i&&(te.disabled=ae.i=We),lt!==ae.n&&(oe.disabled=ae.n=lt),ae},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),B(()=>de.value=ye.joinType),B(()=>L.value=ye.leftTable),B(()=>O.value=ye.leftColumn),B(()=>Y.value=ye.rightTable),B(()=>te.value=ye.rightColumn),Pe})()})),B(()=>be.disabled=n.disabled),ne}}),V),j.$$click=I,g(he,y(fe,{get each(){return r()},children:(ne,ee)=>(()=>{var ge=sg(),be=ge.firstChild,ke=be.nextSibling,ye=ke.nextSibling,Pe=ye.nextSibling;return g(ge,y(H,{get when(){return ee()>0},get children(){var de=ng();return de.addEventListener("change",xe=>E(ne.id,{logicalOperator:xe.currentTarget.value})),B(()=>de.disabled=n.disabled),B(()=>de.value=ne.logicalOperator),de}}),be),be.addEventListener("change",de=>E(ne.id,{table:de.currentTarget.value})),g(be,y(fe,{get each(){return v()},children:de=>(()=>{var xe=Rt();return g(xe,()=>de.name),B(()=>xe.value=de.name),xe})()})),ke.addEventListener("change",de=>E(ne.id,{column:de.currentTarget.value})),g(ke,y(fe,{get each(){return f(ne.table)},children:de=>(()=>{var xe=Rt();return g(xe,()=>de.name),B(()=>xe.value=de.name),xe})()})),ye.addEventListener("change",de=>E(ne.id,{operator:de.currentTarget.value})),g(ge,y(H,{get when(){return!["IS NULL","IS NOT NULL"].includes(ne.operator)},get children(){var de=ig();return de.$$input=xe=>E(ne.id,{value:xe.currentTarget.value}),B(xe=>{var L=ne.operator==="IN"?"值1,值2,值3":"值",O=n.disabled;return L!==xe.e&&X(de,"placeholder",xe.e=L),O!==xe.t&&(de.disabled=xe.t=O),xe},{e:void 0,t:void 0}),B(()=>de.value=ne.value),de}}),Pe),Pe.$$click=()=>z(ne.id),B(de=>{var xe=n.disabled,L=n.disabled,O=n.disabled,K=n.disabled;return xe!==de.e&&(be.disabled=de.e=xe),L!==de.t&&(ke.disabled=de.t=L),O!==de.a&&(ye.disabled=de.a=O),K!==de.o&&(Pe.disabled=de.o=K),de},{e:void 0,t:void 0,a:void 0,o:void 0}),B(()=>be.value=ne.table),B(()=>ke.value=ne.column),B(()=>ye.value=ne.operator),ge})()})),ve.$$input=ne=>{const ee=parseInt(ne.currentTarget.value)||void 0;d(ee),b()},B(ne=>{var ee=n.disabled,ge=n.disabled,be=n.disabled,ke=n.disabled;return ee!==ne.e&&(N.disabled=ne.e=ee),ge!==ne.t&&(G.disabled=ne.t=ge),be!==ne.a&&(j.disabled=ne.a=be),ke!==ne.o&&(ve.disabled=ne.o=ke),ne},{e:void 0,t:void 0,a:void 0,o:void 0}),B(()=>N.checked=h()),B(()=>ve.value=c()||""),R})()}He(["click","input"]);var ag=S('<button class="action-btn close-btn"title=关闭预览>✕'),lg=S("<table class=result-table><thead><tr></tr></thead><tbody>"),og=S("<div class=pagination><div class=pagination-info>显示 <!> - <!>/ <!> 行</div><div class=pagination-controls><select><option value=10>10行/页</option><option value=25>25行/页</option><option value=50>50行/页</option><option value=100>100行/页</option></select><div class=page-buttons><button>首页</button><button>上一页</button><span class=page-info> / </span><button>下一页</button><button>末页"),cg=S(`<div class=query-preview><div class=preview-header><div class=header-info><h4>📊 查询结果预览</h4><div class=result-stats><span class=stat-item>📋 <!> 行数据</span><span class=stat-item>📊 <!> 列</span><span class=stat-item>⏱️ <!>ms</span></div></div><div class=header-actions><button class="action-btn export-btn"title=导出为CSV文件>📤 导出CSV</button></div></div><div class=query-info><details><summary>🔍 查询详情</summary><div class=query-details><div class=query-sql><strong>SQL查询:</strong><pre class=sql-code></pre></div><div class=query-metadata><div class=metadata-item><strong>执行时间:</strong> <!>ms</div><div class=metadata-item><strong>返回行数:</strong> </div><div class=metadata-item><strong>列数量:</strong> </div></div></div></details></div><div class=table-container></div><style>
        .query-preview {
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          overflow: hidden;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .preview-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          padding: 16px;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
        }

        .header-info h4 {
          margin: 0 0 8px 0;
          color: #2c3e50;
        }

        .result-stats {
          display: flex;
          gap: 16px;
          font-size: 13px;
        }

        .stat-item {
          color: #6c757d;
        }

        .header-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border: 1px solid #ced4da;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s;
        }

        .export-btn:hover {
          background: #28a745;
          color: white;
          border-color: #28a745;
        }

        .close-btn:hover {
          background: #dc3545;
          color: white;
          border-color: #dc3545;
        }

        .query-info {
          padding: 12px 16px;
          border-bottom: 1px solid #e9ecef;
        }

        .query-details {
          margin-top: 8px;
        }

        .query-sql {
          margin-bottom: 12px;
        }

        .sql-code {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 12px;
          font-family: 'Monaco', 'Consolas', monospace;
          font-size: 12px;
          overflow-x: auto;
          margin: 4px 0;
        }

        .query-metadata {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
          font-size: 13px;
        }

        .metadata-item {
          color: #495057;
        }

        .table-container {
          overflow: auto;
          max-height: 500px;
        }

        .result-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .result-table th {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 8px 12px;
          text-align: left;
          font-weight: 600;
          position: sticky;
          top: 0;
          z-index: 1;
        }

        .result-table th.sortable {
          cursor: pointer;
          user-select: none;
        }

        .result-table th.sortable:hover {
          background: #e9ecef;
        }

        .column-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .sort-indicator {
          opacity: 0.5;
          font-size: 12px;
        }

        .result-table th.sorted-asc .sort-indicator,
        .result-table th.sorted-desc .sort-indicator {
          opacity: 1;
          color: #007bff;
        }

        .result-table td {
          border: 1px solid #dee2e6;
          padding: 6px 12px;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .result-table tr.even {
          background: #f8f9fa;
        }

        .result-table tr:hover {
          background: #e3f2fd;
        }

        .cell-null {
          color: #6c757d;
          font-style: italic;
        }

        .cell-boolean {
          text-align: center;
          font-weight: bold;
        }

        .cell-integer, .cell-float {
          text-align: right;
          font-family: 'Monaco', 'Consolas', monospace;
        }

        .cell-datetime {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #6f42c1;
        }

        .cell-object {
          font-family: 'Monaco', 'Consolas', monospace;
          color: #e83e8c;
        }

        .empty-result {
          text-align: center;
          padding: 40px 20px;
          color: #6c757d;
        }

        .empty-icon {
          font-size: 48px;
          margin-bottom: 16px;
        }

        .empty-text {
          font-size: 18px;
          font-weight: 500;
          margin-bottom: 8px;
        }

        .empty-hint {
          font-size: 14px;
        }

        .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          background: #f8f9fa;
          border-top: 1px solid #dee2e6;
          font-size: 13px;
        }

        .pagination-controls {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .page-buttons {
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .page-buttons button {
          padding: 4px 8px;
          border: 1px solid #ced4da;
          background: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }

        .page-buttons button:hover:not(:disabled) {
          background: #e9ecef;
        }

        .page-buttons button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .page-info {
          margin: 0 8px;
          font-weight: 500;
        }

        details summary {
          cursor: pointer;
          font-weight: 500;
          color: #495057;
        }

        details[open] summary {
          margin-bottom: 8px;
        }
      `),dg=S("<div class=empty-result><div class=empty-icon>📭</div><div class=empty-text>查询未返回任何数据</div><div class=empty-hint>请检查查询条件或数据源"),hg=S("<th><div class=column-header><span class=column-name></span><span class=sort-indicator>"),ug=S("<tr>"),gg=S("<td>");function fg(n){const[e,t]=Z(1),[i,s]=Z(10),[r,a]=Z(null),[l,o]=Z("asc"),c=Me(()=>{let f=[...n.result.rows];if(r()){const m=r();f.sort((_,w)=>{const x=_[m],C=w[m];if(x==null)return 1;if(C==null)return-1;const A=String(x).localeCompare(String(C),void 0,{numeric:!0});return l()==="asc"?A:-A})}const p=(e()-1)*i(),b=p+i();return{data:f.slice(p,b),totalPages:Math.ceil(f.length/i()),totalRows:f.length}}),d=f=>{r()===f?o(p=>p==="asc"?"desc":"asc"):(a(f),o("asc"))},h=f=>{if(f==null)return"";if(typeof f=="object")return JSON.stringify(f);if(typeof f=="boolean")return f?"✓":"✗";if(typeof f=="number")return Number.isInteger(f)?f.toLocaleString():f.toFixed(2);const p=String(f);if(p.match(/^\d{4}-\d{2}-\d{2}/)||p.includes("T"))try{const b=new Date(p);if(!isNaN(b.getTime()))return b.toLocaleString("zh-CN")}catch{}return p.length>50?p.substring(0,47)+"...":p},u=f=>{if(f==null)return"null";if(typeof f=="boolean")return"boolean";if(typeof f=="number")return Number.isInteger(f)?"integer":"float";if(typeof f=="object")return"object";const p=String(f);if(p.match(/^\d{4}-\d{2}-\d{2}/)||p.includes("T"))try{const b=new Date(p);if(!isNaN(b.getTime()))return"datetime"}catch{}return"string"},v=()=>{const f=n.result.columns.join(","),p=n.result.rows.map(x=>n.result.columns.map(C=>{const A=x[C],M=h(A);return M.includes(",")||M.includes('"')||M.includes(`
`)?`"${M.replace(/"/g,'""')}"`:M}).join(",")).join(`
`),b=f+`
`+p,m=new Blob([b],{type:"text/csv;charset=utf-8;"}),_=document.createElement("a"),w=URL.createObjectURL(m);_.setAttribute("href",w),_.setAttribute("download",`query_result_${Date.now()}.csv`),document.body.appendChild(_),_.click(),document.body.removeChild(_)};return(()=>{var f=cg(),p=f.firstChild,b=p.firstChild,m=b.firstChild,_=m.nextSibling,w=_.firstChild,x=w.firstChild,C=x.nextSibling;C.nextSibling;var A=w.nextSibling,M=A.firstChild,I=M.nextSibling;I.nextSibling;var z=A.nextSibling,E=z.firstChild,R=E.nextSibling;R.nextSibling;var T=b.nextSibling,U=T.firstChild,N=p.nextSibling,$=N.firstChild,P=$.firstChild,Q=P.nextSibling,G=Q.firstChild,D=G.firstChild,V=D.nextSibling,q=G.nextSibling,W=q.firstChild,j=W.firstChild,he=j.nextSibling,_e=he.nextSibling;_e.nextSibling;var pe=W.nextSibling,se=pe.firstChild;se.nextSibling;var ce=pe.nextSibling,ue=ce.firstChild;ue.nextSibling;var ve=N.nextSibling,ne=ve.nextSibling;return g(w,()=>n.result.totalCount??n.result.total_rows,C),g(A,()=>n.result.columns.length,I),g(z,()=>n.result.execution_time,R),U.$$click=v,g(T,y(H,{get when(){return n.onClose},get children(){var ee=ag();return Le(ee,"click",n.onClose),ee}}),null),g(V,()=>n.result.query),g(W,()=>n.result.execution_time,_e),g(pe,()=>n.result.totalCount??n.result.total_rows,null),g(ce,()=>n.result.columns.length,null),g(ve,y(H,{get when(){return n.result.rows.length>0},get fallback(){return dg()},get children(){var ee=lg(),ge=ee.firstChild,be=ge.firstChild,ke=ge.nextSibling;return g(be,y(fe,{get each(){return n.result.columns},children:ye=>(()=>{var Pe=hg(),de=Pe.firstChild,xe=de.firstChild,L=xe.nextSibling;return Pe.$$click=()=>d(ye),X(Pe,"title",`点击排序 ${ye}`),g(xe,ye),g(L,(()=>{var O=Ce(()=>r()===ye);return()=>O()?l()==="asc"?"↑":"↓":"↕"})()),B(()=>Se(Pe,`sortable ${r()===ye?`sorted-${l()}`:""}`)),Pe})()})),g(ke,y(fe,{get each(){return c().data},children:(ye,Pe)=>(()=>{var de=ug();return g(de,y(fe,{get each(){return n.result.columns},children:xe=>(()=>{var L=gg();return g(L,()=>h(ye[xe])),B(O=>{var K=`cell-${u(ye[xe])}`,Y=`${xe}: ${h(ye[xe])}`;return K!==O.e&&Se(L,O.e=K),Y!==O.t&&X(L,"title",O.t=Y),O},{e:void 0,t:void 0}),L})()})),B(()=>Se(de,Pe()%2===0?"even":"odd")),de})()})),ee}})),g(f,y(H,{get when(){return c().totalPages>1},get children(){var ee=og(),ge=ee.firstChild,be=ge.firstChild,ke=be.nextSibling,ye=ke.nextSibling,Pe=ye.nextSibling,de=Pe.nextSibling,xe=de.nextSibling;xe.nextSibling;var L=ge.nextSibling,O=L.firstChild,K=O.nextSibling,Y=K.firstChild,te=Y.nextSibling,oe=te.nextSibling,ae=oe.firstChild,$e=oe.nextSibling,Ie=$e.nextSibling;return g(ge,()=>(e()-1)*i()+1,ke),g(ge,()=>Math.min(e()*i(),c().totalRows),Pe),g(ge,()=>c().totalRows,xe),O.addEventListener("change",Te=>{s(parseInt(Te.currentTarget.value)),t(1)}),Y.$$click=()=>t(1),te.$$click=()=>t(Te=>Math.max(1,Te-1)),g(oe,e,ae),g(oe,()=>c().totalPages,null),$e.$$click=()=>t(Te=>Math.min(c().totalPages,Te+1)),Ie.$$click=()=>t(c().totalPages),B(Te=>{var Ye=e()===1,We=e()===1,lt=e()===c().totalPages,Pt=e()===c().totalPages;return Ye!==Te.e&&(Y.disabled=Te.e=Ye),We!==Te.t&&(te.disabled=Te.t=We),lt!==Te.a&&($e.disabled=Te.a=lt),Pt!==Te.o&&(Ie.disabled=Te.o=Pt),Te},{e:void 0,t:void 0,a:void 0,o:void 0}),B(()=>O.value=i()),ee}}),ne),f})()}He(["click"]);var vg=S("<span>通过可视化界面构建查询，适合初学者使用"),pg=S("<span>直接编写SQL语句，适合有经验的用户"),mg=S("<div class=error-message>❌ "),bg=S("<div class=validation-errors><strong>错误:</strong><ul>"),yg=S("<div class=validation-warnings><strong>警告:</strong><ul>"),_g=S("<div class=validation-suggestions><strong>建议:</strong><ul>"),xg=S("<div><div class=validation-header><span class=validation-status></span><span class=security-status>"),Sg=S('<div class=sql-query-builder><div class=query-mode-selector><div class=mode-tabs><button>🎯 可视化构建</button><button>💻 自定义SQL</button></div><div class=mode-description></div></div><div class=query-content></div><div class=query-preview-section><div class=preview-header><h4>📋 SQL查询预览</h4><div class=preview-actions><button class="action-btn format-btn"title=格式化SQL代码>🎨 格式化</button><button class="action-btn validate-btn"title=验证SQL语法>✓ 验证语法</button><button class="action-btn copy-btn"title=复制SQL到剪贴板>📋 复制</button><button class="action-btn execute-btn"title=执行查询预览></button></div></div><div class=sql-display><pre class=sql-code><code></code></pre></div></div><div class=query-help><details><summary>💡 查询构建帮助</summary><div class=help-content><div class=help-section><h5>可视化构建:</h5><ul><li>选择表和字段来自动生成查询</li><li>支持JOIN关联、WHERE条件、ORDER BY排序</li><li>适合SQL初学者使用</li></ul></div><div class=help-section><h5>自定义SQL:</h5><ul><li>直接编写SQL语句，支持复杂查询</li><li>提供语法验证和格式化功能</li><li>适合有经验的用户</li></ul></div><div class=help-section><h5>安全提示:</h5><ul><li>系统会自动检测SQL注入风险</li><li>预览查询限制返回行数，避免性能问题</li><li>建议先验证语法，再执行预览'),fi=S("<li>");function wg(n){const[e,t]=Z("visual"),[i,s]=Z(!1),[r,a]=Z(null),[l,o]=Z(null),[c,d]=Z(null),[h,u]=Z(""),v=Me(()=>e()==="visual"?h():n.sql),f=Me(()=>l()),p=async()=>{const x=v().trim();if(!x){o(null),n.onValidationChange(null);return}try{if(s(!0),a(null),console.log("🔍 验证SQL语法:",x),console.log("🔍 SQLQueryBuilder config对象:",n.config),console.log("🔍 config对象的键:",Object.keys(n.config)),console.log("🔍 database_type字段:",n.config.database_type),["database_type","databaseType","dbType","type"].forEach(M=>{n.config[M]&&console.log(`🔍 找到字段 ${M}:`,n.config[M])}),!n.config.database_type)throw new Error(`database_type字段缺失，config内容: ${JSON.stringify(n.config)}`);const A=await Ae.validateSqlSyntax(x,n.config.database_type);o(A),n.onValidationChange(A),console.log("✅ SQL验证结果:",A)}catch(C){console.error("❌ SQL验证失败:",C);const A={valid:!1,errors:[`验证失败: ${C}`],warnings:[],suggestions:[],is_safe:!1,security_issues:["无法验证查询安全性"]};o(A),n.onValidationChange(A),a(`SQL验证失败: ${C}`)}finally{s(!1)}},b=async()=>{const x=v().trim();if(x)try{s(!0),a(null),console.log("🎨 格式化SQL:",x);const C=await Ae.formatSql(x,n.config.database_type);e()==="visual"?u(C):n.onSQLChange(C),console.log("✅ SQL格式化完成")}catch(C){console.error("❌ SQL格式化失败:",C),a(`格式化失败: ${C}`)}finally{s(!1)}},m=async()=>{const x=v().trim();if(!x){a("请输入SQL查询语句");return}try{s(!0),a(null),console.log("▶️ 执行查询预览:",x),await p();const C=l();if(C&&!C.valid){a("SQL语法验证失败，请修正后重试");return}const A=await Ae.executeDatabasePreview(n.config,x,50);d(A),n.onQueryResult(A),console.log("✅ 查询预览成功:",A)}catch(C){console.error("❌ 查询预览失败:",C),a(`查询执行失败: ${C}`),d(null),n.onQueryResult(null)}finally{s(!1)}},_=async()=>{const x=v();if(x)try{await navigator.clipboard.writeText(x),console.log("📋 SQL已复制到剪贴板")}catch(C){console.error("❌ 复制失败:",C),a(`复制失败: ${C}`)}},w=x=>{t(x),a(null),x==="custom"&&h()&&n.onSQLChange(h())};return(()=>{var x=Sg(),C=x.firstChild,A=C.firstChild,M=A.firstChild,I=M.nextSibling,z=A.nextSibling,E=C.nextSibling,R=E.nextSibling,T=R.firstChild,U=T.firstChild,N=U.nextSibling,$=N.firstChild,P=$.nextSibling,Q=P.nextSibling,G=Q.nextSibling,D=T.nextSibling,V=D.firstChild,q=V.firstChild;return M.$$click=()=>w("visual"),I.$$click=()=>w("custom"),g(z,y(H,{get when(){return e()==="visual"},get children(){return vg()}}),null),g(z,y(H,{get when(){return e()==="custom"},get children(){return pg()}}),null),g(x,y(H,{get when(){return r()},get children(){var W=mg();return W.firstChild,g(W,r,null),W}}),E),g(E,y(H,{get when(){return e()==="visual"},get children(){return y(rg,{get selectedTables(){return n.selectedTables},get schema(){return n.schema},onQueryChange:u,get disabled(){return i()}})}}),null),g(E,y(H,{get when(){return e()==="custom"},get children(){return y(Xu,{get sql(){return n.sql},get onSQLChange(){return n.onSQLChange},get databaseType(){return n.config.database_type},get disabled(){return i()}})}}),null),$.$$click=b,P.$$click=p,Q.$$click=_,G.$$click=m,g(G,()=>i()?"⏳ 执行中...":"▶️ 预览查询"),g(q,()=>v()||"-- 请构建或输入SQL查询语句"),g(R,y(H,{get when(){return f()},get children(){var W=xg(),j=W.firstChild,he=j.firstChild,_e=he.nextSibling;return g(he,()=>f().valid?"✅ 语法正确":"❌ 语法错误"),g(_e,()=>f().is_safe?"🔒 查询安全":"⚠️ 安全警告"),g(W,y(H,{get when(){return Ce(()=>!!f().errors)()&&f().errors.length>0},get children(){var pe=bg(),se=pe.firstChild,ce=se.nextSibling;return g(ce,y(fe,{get each(){return f().errors},children:ue=>(()=>{var ve=fi();return g(ve,ue),ve})()})),pe}}),null),g(W,y(H,{get when(){return Ce(()=>!!f()?.warnings)()&&f().warnings.length>0},get children(){var pe=yg(),se=pe.firstChild,ce=se.nextSibling;return g(ce,y(fe,{get each(){return f().warnings},children:ue=>(()=>{var ve=fi();return g(ve,ue),ve})()})),pe}}),null),g(W,y(H,{get when(){return Ce(()=>!!f()?.suggestions)()&&f().suggestions.length>0},get children(){var pe=_g(),se=pe.firstChild,ce=se.nextSibling;return g(ce,y(fe,{get each(){return f().suggestions},children:ue=>(()=>{var ve=fi();return g(ve,ue),ve})()})),pe}}),null),B(()=>Se(W,`validation-result ${f()?.valid?"valid":"invalid"}`)),W}}),null),g(R,y(H,{get when(){return c()},get children(){return y(fg,{get result(){return c()},onClose:()=>{d(null),n.onQueryResult(null)}})}}),null),B(W=>{var j=`mode-tab ${e()==="visual"?"active":""}`,he=i(),_e=`mode-tab ${e()==="custom"?"active":""}`,pe=i(),se=i()||!v(),ce=i()||!v(),ue=i()||!v(),ve=i()||!v();return j!==W.e&&Se(M,W.e=j),he!==W.t&&(M.disabled=W.t=he),_e!==W.a&&Se(I,W.a=_e),pe!==W.o&&(I.disabled=W.o=pe),se!==W.i&&($.disabled=W.i=se),ce!==W.n&&(P.disabled=W.n=ce),ue!==W.s&&(Q.disabled=W.s=ue),ve!==W.h&&(G.disabled=W.h=ve),W},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),x})()}He(["click"]);var $g=S("<div class=error-messages>"),Cg=S("<div class=loading-overlay><div class=loading-spinner>⏳</div><div class=loading-text>处理中..."),kg=S('<div class=form-row><div class="form-group flex-2"><label>主机地址</label><input type=text placeholder=localhost></div><div class="form-group flex-1"><label>端口</label><input type=number>'),Tg=S("<div class=form-group><label>数据库文件路径</label><input type=text placeholder=/path/to/database.db>"),Eg=S("<div class=form-group><label>数据库名</label><input type=text placeholder=myapp_production>"),Pg=S("<div class=form-row><div class=form-group><label>用户名</label><input type=text></div><div class=form-group><label>密码</label><input type=password>"),Or=S("<div><div class=result-message><span class=result-icon></span><span class=result-text>"),Ag=S("<div class=connection-step><div class=step-header><h4>🔌 数据库连接配置</h4><p>请填写数据库连接信息</p></div><div class=form-section><div class=form-group><label>数据库类型</label><select><option value=mysql>MySQL</option><option value=postgresql>PostgreSQL</option><option value=sqlite>SQLite</option><option value=sqlserver>SQL Server</option><option value=oracle>Oracle</option></select></div><div class=connection-test><button class=test-connection-btn>"),Rg=S("<div class=schema-loading><button class=load-schema-btn>🔄 加载表结构</button><p class=loading-hint>点击按钮加载数据库的表结构信息"),Lg=S("<div class=views-section><h5>👁️ 数据视图列表</h5><div class=views-list>"),Mg=S("<div class=schema-content><div class=schema-summary><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>表数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>视图数量:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>加载时间:</span><span class=summary-value></span></div></div><div class=tables-section><h5>📋 数据表列表</h5><div class=tables-grid>"),Dg=S("<div class=schema-step><div class=step-header><h4>🗂️ 数据库表结构</h4><p>选择要查询的数据表和字段"),Og=S('<div class=database-wizard><div class=wizard-header><button class=back-btn>← 返回</button><div class=wizard-title><h3>🗄️ 创建数据库数据源</h3><p>连接数据库并配置查询语句</p></div></div><div class=wizard-progress><div><div class=step-indicator>1</div><div class=step-info><div class=step-title>数据库连接</div><div class=step-description>配置连接信息</div></div></div><div><div class=step-indicator>2</div><div class=step-info><div class=step-title>表结构</div><div class=step-description>选择数据表</div></div></div><div><div class=step-indicator>3</div><div class=step-info><div class=step-title>查询构建</div><div class=step-description>编写SQL查询</div></div></div><div><div class=step-indicator>4</div><div class=step-info><div class=step-title>预览保存</div><div class=step-description>测试并保存</div></div></div></div><div class=wizard-content></div><div class=wizard-controls><div class=control-buttons><button class="control-btn back-btn">← 上一步</button><button class="control-btn next-btn">下一步 →'),Ig=S("<div class=error-message>❌ "),Ng=S("<span class=view-comment>"),zg=S("<div class=view-item><div class=view-info><span class=view-name></span><span class=view-schema>"),Fg=S("<div class=table-comment>"),Gg=S("<div class=more-columns>+<!> 个字段..."),Bg=S("<span class=more-indexes>+"),Ug=S("<div class=table-indexes><h6>索引 (<!>)</h6><div class=indexes-list>"),Hg=S("<span class=more-relations>+"),qg=S("<div class=table-relations><h6>关联 (<!>)</h6><div class=relations-list>"),Wg=S("<div><div class=table-card-header><div class=table-card-title><label class=table-checkbox><input type=checkbox><span class=table-name>📋 </span></label></div><div class=table-card-stats><span class=row-count title=预估行数> 行</span><span class=table-size title=预估大小></span></div></div><div class=table-columns><h6>字段 (<!>)</h6><div class=columns-preview>"),jg=S("<span class=pk-badge title=主键>🔑"),Yg=S("<span class=fk-badge title=外键>🔗"),Vg=S("<div class=column-item><span class=column-icon></span><span class=column-name></span><span class=column-type>"),Xg=S("<span> "),Qg=S("<span class=relation-badge>🔗 "),Kg=S('<div class=preview-step><div class=step-header><h4>👁️ 预览和保存</h4><p>验证配置、预览数据并保存数据源</p></div><div class=basic-info-section><h5>📝 基本信息</h5><div class=form-row><div class="form-group flex-2"><label>数据源名称 *</label><input type=text placeholder=输入数据源名称... required></div><div class="form-group flex-1"><label>标签</label><input type=text placeholder="标签1, 标签2"></div></div><div class=form-group><label>描述</label><textarea placeholder=描述这个数据源的用途... rows=3>'),Jg=S("<div class=config-summary><h5>⚙️ 配置摘要</h5><div class=summary-grid><div class=summary-item><span class=summary-label>数据库类型:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>连接地址:</span><span class=summary-value>:</span></div><div class=summary-item><span class=summary-label>数据库:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>用户名:</span><span class=summary-value></span></div><div class=summary-item><span class=summary-label>选中表:</span><span class=summary-value> 个表</span></div><div class=summary-item><span class=summary-label>查询长度:</span><span class=summary-value> 字符</span></div></div><div class=sql-preview><h6>SQL查询预览:</h6><pre class=sql-code>"),Zg=S("<div class=validation-warnings><h6>⚠️ 警告"),ef=S("<div class=validation-errors><h6>❌ 错误"),tf=S("<div class=validation-suggestions><h6>💡 建议"),nf=S("<div class=validation-results><div class=validation-checks>"),sf=S("<div class=validation-section><div class=section-header><h5>✅ 验证状态</h5><button class=validate-btn>"),rf=S("<div class=warning-item>"),af=S("<div class=error-item>"),lf=S("<div class=suggestion-item>"),of=S("<div><span class=check-icon></span><span class=check-label></span><span>"),cf=S("<div class=no-data>没有查询到数据"),df=S("<div class=preview-results><div class=preview-stats><div class=stat-item><span class=stat-label>样本行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>预估总行数:</span><span class=stat-value></span></div><div class=stat-item><span class=stat-label>执行时间:</span><span class=stat-value>ms</span></div></div><div class=preview-data>"),hf=S("<div class=data-preview-section><div class=section-header><h5>📊 数据预览</h5><button class=preview-btn>"),uf=S("<div class=no-data>没有数据"),gf=S("<div class=table-footer>显示前10行，共 <!> 行数据"),ff=S("<div class=data-table-container><table class=data-table><thead><tr></tr></thead><tbody>"),vf=S("<th>"),pf=S("<tr>"),mf=S("<td>"),bf=S('<div class=save-requirements><div class=requirements-header>❗ 保存要求检查：</div><div class=requirements-list><div class=requirement-item>数据源名称: <!> "<!>"</div><div class=requirement-item>自定义SQL: <!> </div><div class=requirement-item>测试连接: <!> </div><div class=requirement-item>保存状态: </div></div><div class=requirements-note>'),yf=S("<div class=result-details><div class=detail-item><span class=detail-label>数据源ID:</span><span class=detail-value>"),_f=S("<div class=result-warnings>"),xf=S("<div class=result-errors>"),Sf=S("<div class=save-requirements><h6>保存前需要完成:</h6><ul><li>填写数据源名称</li><li>确保SQL查询有效</li><li>通过基本验证检查"),wf=S("<div class=save-section><div class=section-header><h5>💾 保存数据源</h5><button>"),$f=S("<div class=warning-item>⚠️ "),Cf=S("<div class=error-item>❌ ");const kf={database_type:"mysql",host:"localhost",port:3306,database:"",username:"",password:"",ssl_enabled:!1,max_connections:10,min_connections:1,connection_timeout:30,idle_timeout:600,sql:"",use_custom_sql:!1,query_timeout:60,default_limit:1e3,enable_caching:!0,cache_ttl:300};function Tf(n){const[e,t]=Z({currentStep:"connection",name:"",description:"",tags:[],config:{...kf},schema:null,selectedTables:[],generatedSQL:"",customSQL:"",useCustomSQL:!1,testResult:null,queryResult:null,validation:null,dataSourceValidation:null,dataPreview:null,loading:!1,errors:[],isSaving:!1,saveResult:null}),i=Me(()=>{const v=e();return{connection:v.testResult?.success||!1,schema:v.schema!==null&&v.selectedTables.length>0,query:v.customSQL.trim().length>0,preview:v.name.trim().length>0&&v.customSQL.trim().length>0}}),s=v=>{t(f=>({...f,...v}))},r=v=>{t(f=>({...f,config:{...f.config,...v}}))},a=async()=>{s({loading:!0,errors:[]});try{const v=await Ae.testDatabaseConnection(e().config);s({testResult:v,loading:!1,errors:v.success?[]:[v.message]}),v.success&&setTimeout(()=>{s({currentStep:"schema"}),l()},1e3)}catch(v){s({loading:!1,errors:[`连接测试失败: ${v}`],testResult:{success:!1,message:String(v)}})}},l=async()=>{s({loading:!0,errors:[]});try{const v=await Ae.loadDatabaseSchema(e().config);s({schema:v,loading:!1,errors:[]})}catch(v){s({loading:!1,errors:[`架构加载失败: ${v}`],schema:null})}},o=async()=>{s({loading:!0,errors:[]});try{const v={name:e().name,config:e().config,selected_tables:e().selectedTables,sql:e().customSQL,description:e().description,tags:e().tags,validate_before_save:!0},f=await Ae.validateDataSourceBeforeSave(v);return s({dataSourceValidation:f,loading:!1,errors:f.errors}),f}catch(v){return s({loading:!1,errors:[`验证失败: ${v}`]}),null}},c=async()=>{s({loading:!0,errors:[]});try{const v=await Ae.captureDataPreview(e().config,e().customSQL);return s({dataPreview:v,loading:!1}),v}catch(v){return s({loading:!1,errors:[`数据预览失败: ${v}`]}),null}},d=async()=>{s({isSaving:!0,errors:[]});try{console.log("🔍 DatabaseWizard 保存前状态:",{selectedTables:e().selectedTables,selectedTables_type:typeof e().selectedTables,selectedTables_length:e().selectedTables?.length,customSQL_length:e().customSQL?.length,name:e().name});const v={name:e().name,config:e().config,selected_tables:e().selectedTables,sql:e().customSQL,description:e().description,tags:e().tags,validate_before_save:!0,capture_schema_snapshot:!0,capture_data_preview:!0,preview_row_limit:10};console.log("🔍 构建的 SaveDataSourceRequest:",{selected_tables:v.selected_tables,selected_tables_type:typeof v.selected_tables,selected_tables_length:v.selected_tables?.length});const f=await Ae.saveDataSource(v);return s({saveResult:f,isSaving:!1}),f.success&&setTimeout(()=>{n.onSuccess()},2e3),f}catch(v){return s({isSaving:!1,errors:[`保存失败: ${v}`]}),null}},h=v=>{s({currentStep:v})},u=()=>{switch(e().currentStep){case"schema":s({currentStep:"connection"});break;case"query":s({currentStep:"schema"});break;case"preview":s({currentStep:"query"});break;default:n.onBack()}};return(()=>{var v=Og(),f=v.firstChild,p=f.firstChild,b=f.nextSibling,m=b.firstChild,_=m.nextSibling,w=_.nextSibling,x=w.nextSibling,C=b.nextSibling,A=C.nextSibling,M=A.firstChild,I=M.firstChild,z=I.nextSibling;return p.$$click=u,m.$$click=()=>h("connection"),_.$$click=()=>i().connection&&h("schema"),w.$$click=()=>i().schema&&h("query"),x.$$click=()=>i().query&&h("preview"),g(C,y(H,{get when(){return e().errors.length>0},get children(){var E=$g();return g(E,y(fe,{get each(){return e().errors},children:R=>(()=>{var T=Ig();return T.firstChild,g(T,R,null),T})()})),E}}),null),g(C,y(H,{get when(){return e().loading},get children(){return Cg()}}),null),g(C,y(H,{get when(){return e().currentStep==="connection"},get children(){var E=Ag(),R=E.firstChild,T=R.nextSibling,U=T.firstChild,N=U.firstChild,$=N.nextSibling,P=U.nextSibling,Q=P.firstChild;return $.addEventListener("change",G=>{const D=G.currentTarget.value,V={mysql:3306,postgresql:5432,sqlserver:1433,oracle:1521,sqlite:0}[D];r({database_type:D,port:V})}),g(T,y(H,{get when(){return e().config.database_type!=="sqlite"},get children(){var G=kg(),D=G.firstChild,V=D.firstChild,q=V.nextSibling,W=D.nextSibling,j=W.firstChild,he=j.nextSibling;return q.addEventListener("change",_e=>r({host:_e.currentTarget.value})),he.addEventListener("change",_e=>r({port:parseInt(_e.currentTarget.value)||3306})),B(()=>q.value=e().config.host),B(()=>he.value=e().config.port),G}}),P),g(T,y(H,{get when(){return e().config.database_type==="sqlite"},get children(){var G=Tg(),D=G.firstChild,V=D.nextSibling;return V.addEventListener("change",q=>r({database:q.currentTarget.value})),B(()=>V.value=e().config.database),G}}),P),g(T,y(H,{get when(){return e().config.database_type!=="sqlite"},get children(){return[(()=>{var G=Eg(),D=G.firstChild,V=D.nextSibling;return V.addEventListener("change",q=>r({database:q.currentTarget.value})),B(()=>V.value=e().config.database),G})(),(()=>{var G=Pg(),D=G.firstChild,V=D.firstChild,q=V.nextSibling,W=D.nextSibling,j=W.firstChild,he=j.nextSibling;return q.addEventListener("change",_e=>r({username:_e.currentTarget.value})),he.addEventListener("change",_e=>r({password:_e.currentTarget.value})),B(()=>q.value=e().config.username),B(()=>he.value=e().config.password),G})()]}}),P),Q.$$click=a,g(Q,()=>e().loading?"⏳ 测试中...":"🔗 测试连接"),g(P,y(H,{get when(){return e().testResult},get children(){var G=Or(),D=G.firstChild,V=D.firstChild,q=V.nextSibling;return g(V,()=>e().testResult?.success?"✅":"❌"),g(q,()=>e().testResult?.message),B(()=>Se(G,`test-result ${e().testResult?.success?"success":"error"}`)),G}}),null),B(()=>Q.disabled=e().loading),B(()=>$.value=e().config.database_type),E}}),null),g(C,y(H,{get when(){return e().currentStep==="schema"},get children(){var E=Dg();return E.firstChild,g(E,y(H,{get when(){return Ce(()=>!e().schema)()&&!e().loading},get children(){var R=Rg(),T=R.firstChild;return T.$$click=l,R}}),null),g(E,y(H,{get when(){return e().schema},get children(){var R=Mg(),T=R.firstChild,U=T.firstChild,N=U.firstChild,$=N.nextSibling,P=U.nextSibling,Q=P.firstChild,G=Q.nextSibling,D=P.nextSibling,V=D.firstChild,q=V.nextSibling,W=D.nextSibling,j=W.firstChild,he=j.nextSibling,_e=T.nextSibling,pe=_e.firstChild,se=pe.nextSibling;return g($,()=>e().schema?.database_name),g(G,()=>e().schema?.schemas[0]?.tables?.length||0),g(q,()=>e().schema?.schemas[0]?.views?.length||0),g(he,()=>new Date(e().schema?.loaded_at||"").toLocaleString("zh-CN")),g(se,y(fe,{get each(){return e().schema?.schemas[0]?.tables||[]},children:ce=>y(Ef,{table:ce,get selected(){return e().selectedTables.includes(ce.name)},onToggle:(ue,ve)=>{const ne=e().selectedTables;s(ve?{selectedTables:[...ne,ue]}:{selectedTables:ne.filter(ee=>ee!==ue)})}})})),g(R,y(H,{get when(){return Ce(()=>!!e().schema?.schemas[0]?.views)()&&e().schema.schemas[0].views.length>0},get children(){var ce=Lg(),ue=ce.firstChild,ve=ue.nextSibling;return g(ve,y(fe,{get each(){return e().schema?.schemas[0]?.views||[]},children:ne=>(()=>{var ee=zg(),ge=ee.firstChild,be=ge.firstChild,ke=be.nextSibling;return g(be,()=>ne.name),g(ke,()=>ne.schema),g(ee,y(H,{get when(){return ne.comment},get children(){var ye=Ng();return g(ye,()=>ne.comment),ye}}),null),ee})()})),ce}}),null),R}}),null),E}}),null),g(C,y(H,{get when(){return e().currentStep==="query"},get children(){return y(wg,{get selectedTables(){return e().selectedTables},get schema(){return e().schema},get config(){return e().config},get sql(){return e().customSQL},onSQLChange:E=>s({customSQL:E}),onQueryResult:E=>s({queryResult:E}),onValidationChange:E=>s({validation:E})})}}),null),g(C,y(H,{get when(){return e().currentStep==="preview"},get children(){return y(Pf,{get state(){return e()},onStateUpdate:s,onSave:d,onValidate:o,onPreviewData:c})}}),null),I.$$click=u,z.$$click=()=>{const E=e();E.currentStep==="connection"&&E.testResult?.success?(s({currentStep:"schema"}),E.schema||l()):E.currentStep==="schema"?s({currentStep:"query"}):E.currentStep==="query"&&s({currentStep:"preview"})},B(E=>{var R=`progress-step ${e().currentStep==="connection"?"active":""} ${i().connection?"completed":""}`,T=`progress-step ${e().currentStep==="schema"?"active":""} ${i().schema?"completed":""}`,U=`progress-step ${e().currentStep==="query"?"active":""} ${i().query?"completed":""}`,N=`progress-step ${e().currentStep==="preview"?"active":""} ${i().preview?"completed":""}`,$=e().loading;return R!==E.e&&Se(m,E.e=R),T!==E.t&&Se(_,E.t=T),U!==E.a&&Se(w,E.a=U),N!==E.o&&Se(x,E.o=N),$!==E.i&&(z.disabled=E.i=$),E},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),v})()}function Ef(n){const e=i=>i<1e3?i.toString():i<1e6?`${(i/1e3).toFixed(1)}K`:`${(i/1e6).toFixed(1)}M`,t=i=>{const s=i.toLowerCase();return s.includes("int")||s.includes("number")||s.includes("decimal")?"🔢":s.includes("varchar")||s.includes("text")||s.includes("char")?"📝":s.includes("date")||s.includes("time")?"📅":s.includes("bool")?"✅":"📋"};return(()=>{var i=Wg(),s=i.firstChild,r=s.firstChild,a=r.firstChild,l=a.firstChild,o=l.nextSibling;o.firstChild;var c=r.nextSibling,d=c.firstChild,h=d.firstChild,u=d.nextSibling,v=s.nextSibling,f=v.firstChild,p=f.firstChild,b=p.nextSibling;b.nextSibling;var m=f.nextSibling;return l.addEventListener("change",_=>n.onToggle(n.table.name,_.currentTarget.checked)),g(o,()=>n.table.name,null),g(d,()=>e(n.table.row_count_estimate),h),g(u,()=>n.table.size_estimate),g(i,y(H,{get when(){return n.table.comment},get children(){var _=Fg();return g(_,()=>n.table.comment),_}}),v),g(f,()=>n.table.columns?.length||0,b),g(m,y(fe,{get each(){return(n.table.columns||[]).slice(0,6)},children:_=>(()=>{var w=Vg(),x=w.firstChild,C=x.nextSibling,A=C.nextSibling;return g(x,()=>t(_.data_type)),g(C,()=>_.name),g(A,()=>_.data_type),g(w,y(H,{get when(){return _.is_primary_key},get children(){return jg()}}),null),g(w,y(H,{get when(){return _.is_foreign_key},get children(){return Yg()}}),null),w})()}),null),g(m,y(H,{get when(){return(n.table.columns?.length||0)>6},get children(){var _=Gg(),w=_.firstChild,x=w.nextSibling;return x.nextSibling,g(_,()=>(n.table.columns?.length||0)-6,x),_}}),null),g(i,y(H,{get when(){return n.table.indexes&&n.table.indexes.length>0},get children(){var _=Ug(),w=_.firstChild,x=w.firstChild,C=x.nextSibling;C.nextSibling;var A=w.nextSibling;return g(w,()=>n.table.indexes.length,C),g(A,y(fe,{get each(){return n.table.indexes.slice(0,3)},children:M=>(()=>{var I=Xg(),z=I.firstChild;return g(I,()=>M.unique?"🔐":"📇",z),g(I,()=>M.name,null),B(E=>{var R=`index-badge ${M.unique?"unique":""}`,T=M.columns.join(", ");return R!==E.e&&Se(I,E.e=R),T!==E.t&&X(I,"title",E.t=T),E},{e:void 0,t:void 0}),I})()}),null),g(A,y(H,{get when(){return n.table.indexes.length>3},get children(){var M=Bg();return M.firstChild,g(M,()=>n.table.indexes.length-3,null),M}}),null),_}}),null),g(i,y(H,{get when(){return n.table.foreign_keys&&n.table.foreign_keys.length>0},get children(){var _=qg(),w=_.firstChild,x=w.firstChild,C=x.nextSibling;C.nextSibling;var A=w.nextSibling;return g(w,()=>n.table.foreign_keys.length,C),g(A,y(fe,{get each(){return n.table.foreign_keys.slice(0,2)},children:M=>(()=>{var I=Qg();return I.firstChild,g(I,()=>M.referenced_table,null),B(()=>X(I,"title",`${M.column_name} → ${M.referenced_table}.${M.referenced_column}`)),I})()}),null),g(A,y(H,{get when(){return n.table.foreign_keys.length>2},get children(){var M=Hg();return M.firstChild,g(M,()=>n.table.foreign_keys.length-2,null),M}}),null),_}}),null),B(()=>Se(i,`table-card ${n.selected?"selected":""}`)),B(()=>l.checked=n.selected),i})()}function Pf(n){return(()=>{var e=Kg(),t=e.firstChild,i=t.nextSibling,s=i.firstChild,r=s.nextSibling,a=r.firstChild,l=a.firstChild,o=l.nextSibling,c=a.nextSibling,d=c.firstChild,h=d.nextSibling,u=r.nextSibling,v=u.firstChild,f=v.nextSibling;return o.$$input=p=>n.onStateUpdate({name:p.currentTarget.value}),h.$$input=p=>{const b=p.currentTarget.value.split(",").map(m=>m.trim()).filter(m=>m);n.onStateUpdate({tags:b})},f.$$input=p=>n.onStateUpdate({description:p.currentTarget.value}),g(e,y(Af,{get state(){return n.state}}),null),g(e,y(Rf,{get validation(){return n.state.dataSourceValidation},get onValidate(){return n.onValidate},get loading(){return n.state.loading}}),null),g(e,y(Lf,{get preview(){return n.state.dataPreview},get onPreviewData(){return n.onPreviewData},get loading(){return n.state.loading}}),null),g(e,y(Df,{get state(){return n.state},get saveResult(){return n.state.saveResult},get onSave(){return n.onSave},get isSaving(){return n.state.isSaving},get canSave(){return Of(n.state)}}),null),B(()=>o.value=n.state.name),B(()=>h.value=n.state.tags.join(", ")),B(()=>f.value=n.state.description),e})()}function Af(n){return(()=>{var e=Jg(),t=e.firstChild,i=t.nextSibling,s=i.firstChild,r=s.firstChild,a=r.nextSibling,l=s.nextSibling,o=l.firstChild,c=o.nextSibling,d=c.firstChild,h=l.nextSibling,u=h.firstChild,v=u.nextSibling,f=h.nextSibling,p=f.firstChild,b=p.nextSibling,m=f.nextSibling,_=m.firstChild,w=_.nextSibling,x=w.firstChild,C=m.nextSibling,A=C.firstChild,M=A.nextSibling,I=M.firstChild,z=i.nextSibling,E=z.firstChild,R=E.nextSibling;return g(a,()=>n.state.config.database_type.toUpperCase()),g(c,()=>n.state.config.host,d),g(c,()=>n.state.config.port,null),g(v,()=>n.state.config.database),g(b,()=>n.state.config.username),g(w,()=>n.state.selectedTables.length,x),g(M,()=>n.state.customSQL.length,I),g(R,()=>n.state.customSQL.slice(0,200),null),g(R,()=>n.state.customSQL.length>200?"...":"",null),e})()}function Rf(n){return(()=>{var e=sf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Le(s,"click",n.onValidate),g(s,()=>n.loading?"⏳ 验证中...":"🔍 开始验证"),g(e,y(H,{get when(){return n.validation},get children(){var r=nf(),a=r.firstChild;return g(a,y(Mn,{label:"数据库连接",get status(){return n.validation?.connection_valid?"success":"error"},get icon(){return n.validation?.connection_valid?"✅":"❌"}}),null),g(a,y(Mn,{label:"SQL语法",get status(){return n.validation?.sql_valid?"success":"error"},get icon(){return n.validation?.sql_valid?"✅":"❌"}}),null),g(a,y(Mn,{label:"安全检查",get status(){return n.validation?.security_passed?"success":"warning"},get icon(){return n.validation?.security_passed?"✅":"⚠️"}}),null),g(a,y(Mn,{label:"性能评估",get status(){return n.validation?.performance_acceptable?"success":"info"},get icon(){return n.validation?.performance_acceptable?"✅":"ℹ️"}}),null),g(r,y(H,{get when(){return n.validation&&n.validation.warnings.length>0},get children(){var l=Zg();return l.firstChild,g(l,y(fe,{get each(){return n.validation.warnings||[]},children:o=>(()=>{var c=rf();return g(c,o),c})()}),null),l}}),null),g(r,y(H,{get when(){return n.validation&&n.validation.errors.length>0},get children(){var l=ef();return l.firstChild,g(l,y(fe,{get each(){return n.validation.errors||[]},children:o=>(()=>{var c=af();return g(c,o),c})()}),null),l}}),null),g(r,y(H,{get when(){return n.validation&&n.validation.suggestions&&n.validation.suggestions.length>0},get children(){var l=tf();return l.firstChild,g(l,y(fe,{get each(){return n.validation.suggestions||[]},children:o=>(()=>{var c=lf();return g(c,o),c})()}),null),l}}),null),r}}),null),B(()=>s.disabled=n.loading),e})()}function Mn(n){return(()=>{var e=of(),t=e.firstChild,i=t.nextSibling,s=i.nextSibling;return g(t,()=>n.icon),g(i,()=>n.label),g(s,()=>n.status==="success"?"通过":n.status==="error"?"失败":n.status==="warning"?"警告":"信息"),B(r=>{var a=`validation-check ${n.status}`,l=`check-status ${n.status}`;return a!==r.e&&Se(e,r.e=a),l!==r.t&&Se(s,r.t=l),r},{e:void 0,t:void 0}),e})()}function Lf(n){return(()=>{var e=hf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Le(s,"click",n.onPreviewData),g(s,()=>n.loading?"⏳ 加载中...":"👁️ 预览数据"),g(e,y(H,{get when(){return n.preview},get children(){var r=df(),a=r.firstChild,l=a.firstChild,o=l.firstChild,c=o.nextSibling,d=l.nextSibling,h=d.firstChild,u=h.nextSibling,v=d.nextSibling,f=v.firstChild,p=f.nextSibling,b=p.firstChild,m=a.nextSibling;return g(c,()=>n.preview?.sample_data.length||0),g(u,()=>n.preview?.total_estimated_rows.toLocaleString()||"未知"),g(p,()=>n.preview?.execution_stats.execution_time||0,b),g(m,y(H,{get when(){return n.preview&&n.preview.sample_data.length>0},get children(){return y(Mf,{get data(){return n.preview.sample_data||[]}})}}),null),g(m,y(H,{get when(){return!n.preview||n.preview.sample_data.length===0},get children(){return cf()}}),null),r}}),null),B(()=>s.disabled=n.loading),e})()}function Mf(n){if(!n.data||n.data.length===0)return uf();const e=Object.keys(n.data[0]);return(()=>{var t=ff(),i=t.firstChild,s=i.firstChild,r=s.firstChild,a=s.nextSibling;return g(r,y(fe,{each:e,children:l=>(()=>{var o=vf();return g(o,l),o})()})),g(a,y(fe,{get each(){return n.data.slice(0,10)},children:l=>(()=>{var o=pf();return g(o,y(fe,{each:e,children:c=>(()=>{var d=mf();return g(d,()=>If(l[c])),d})()})),o})()})),g(t,y(H,{get when(){return n.data.length>10},get children(){var l=gf(),o=l.firstChild,c=o.nextSibling;return c.nextSibling,g(l,()=>n.data.length,c),l}}),null),t})()}function Df(n){return(()=>{var e=wf(),t=e.firstChild,i=t.firstChild,s=i.nextSibling;return Le(s,"click",n.onSave),g(s,()=>n.isSaving?"💾 保存中...":"💾 保存数据源"),g(e,y(H,{get when(){return!n.canSave&&!n.isSaving},get children(){var r=bf(),a=r.firstChild,l=a.nextSibling,o=l.firstChild,c=o.firstChild,d=c.nextSibling,h=d.nextSibling,u=h.nextSibling;u.nextSibling;var v=o.nextSibling,f=v.firstChild,p=f.nextSibling;p.nextSibling;var b=v.nextSibling,m=b.firstChild,_=m.nextSibling;_.nextSibling;var w=b.nextSibling;w.firstChild;var x=l.nextSibling;return g(o,()=>n.state.name?"✅":"❌",d),g(o,()=>n.state.name,u),g(v,()=>n.state.customSQL?"✅":"❌",p),g(v,()=>n.state.customSQL?`(${n.state.customSQL.length} 字符)`:"(空)",null),g(b,()=>n.state.testResult?.success?"✅":"❌",_),g(b,()=>n.state.testResult?.success?"成功":n.state.testResult?`失败: ${n.state.testResult.message}`:"未测试",null),g(w,()=>n.isSaving?"❌ 正在保存中":"✅ 空闲",null),g(x,()=>n.state.testResult?.success?"所有条件都已满足，但按钮仍然禁用。这可能是一个bug。":"请返回第1步完成连接测试，然后才能保存数据源。"),r}}),null),g(e,y(H,{get when(){return n.saveResult},get children(){var r=Or(),a=r.firstChild,l=a.firstChild,o=l.nextSibling;return g(l,()=>n.saveResult?.success?"✅":"❌"),g(o,()=>n.saveResult?.message),g(r,y(H,{get when(){return n.saveResult?.success&&n.saveResult.data_source_id},get children(){var c=yf(),d=c.firstChild,h=d.firstChild,u=h.nextSibling;return g(u,()=>n.saveResult.data_source_id),c}}),null),g(r,y(H,{get when(){return n.saveResult&&n.saveResult.warnings&&n.saveResult.warnings.length>0},get children(){var c=_f();return g(c,y(fe,{get each(){return n.saveResult.warnings||[]},children:d=>(()=>{var h=$f();return h.firstChild,g(h,d,null),h})()})),c}}),null),g(r,y(H,{get when(){return n.saveResult&&n.saveResult.errors&&n.saveResult.errors.length>0},get children(){var c=xf();return g(c,y(fe,{get each(){return n.saveResult.errors||[]},children:d=>(()=>{var h=Cf();return h.firstChild,g(h,d,null),h})()})),c}}),null),B(()=>Se(r,`save-result ${n.saveResult?.success?"success":"error"}`)),r}}),null),g(e,y(H,{get when(){return!n.canSave},get children(){return Sf()}}),null),B(r=>{var a=`save-btn ${n.canSave?"primary":"disabled"}`,l=n.isSaving||!n.canSave;return a!==r.e&&Se(s,r.e=a),l!==r.t&&(s.disabled=r.t=l),r},{e:void 0,t:void 0}),e})()}function Of(n){const e=n.name.trim().length>0,t=n.customSQL.trim().length>0,i=n.testResult?.success,s=!n.isSaving;return console.log("🔍 保存条件检查:",{hasName:e,hasSQL:t,hasSuccessfulTest:i,notSaving:s,testResult:n.testResult,name:n.name,sql:n.customSQL}),!!(e&&t&&i&&s)}function If(n){return n==null?"(null)":typeof n=="string"&&n.length>50?n.substring(0,47)+"...":String(n)}He(["click","input"]);var Nf=S("<input type=text class=search-input placeholder=搜索数据源...>"),zf=S("<div class=add-buttons-group><button class=add-data-source-btn>📄 文件数据源</button><button class=add-database-source-btn>🗄️ 数据库数据源"),Ff=S("<div class=error-message>"),Gf=S("<div class=loading-message>加载中..."),Bf=S("<div class=empty-state><p></p><button>添加第一个数据源"),Uf=S("<div class=data-source-grid>"),Hf=S("<div class=main-view><div class=sidebar><div class=sidebar-section><h3>分类导航</h3><ul class=nav-list><li><button>📁 全部数据源 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按状态分类</h3><ul class=nav-list><li><button>🟢 活跃使用 (<!>)</button></li><li><button>🔴 连接异常 (<!>)</button></li><li><button>🟡 空闲状态 (<!>)</button></li></ul></div><div class=sidebar-section><h3>按类型分类</h3><ul class=nav-list><li><button>📋 所有类型</button></li></ul></div></div><div class=main-content>"),qf=S("<div class=edit-view><div class=edit-header><button>← 返回</button><h2>编辑数据源: </h2></div><p>编辑功能将在后续版本中完善..."),Wf=S("<div class=preview-view><div class=preview-header><button>← 返回</button><h2>数据预览: </h2><div class=preview-info>共 <!> 行数据，显示前 <!> 行</div></div><div class=preview-table-container><table class=preview-table><thead><tr></tr></thead><tbody>"),jf=S("<div class=data-source-management-center><div class=management-header><button class=back-to-designer-btn>← 返回设计器</button><h1>数据源管理中心</h1><div class=header-actions></div></div><div class=management-content>"),Yf=S("<li><button> <!> (<!>)"),Vf=S("<th>"),Xf=S("<tr>"),Qf=S("<td>"),Kf=S("<span class=active-badge title=当前激活>当前"),Jf=S('<div class=data-source-card><div class=card-header><div class=card-title><span class=type-icon></span><h4></h4></div><div class=status-indicator></div></div><div class=card-meta><div class=meta-row><span class=meta-label>类型:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>状态:</span><span class=meta-value></span></div><div class=meta-row><span class=meta-label>最后更新:</span><span class=meta-value></span></div></div><div class=card-actions><button class="action-btn preview-btn"title=预览数据>👁️ 预览</button><button class="action-btn test-btn"title=测试连接>🔌 测试</button><button class="action-btn edit-btn"title=编辑配置>✏️ 编辑</button><button class="action-btn test-btn"title=设为当前数据源>⭐ 设为当前</button><button class="action-btn delete-btn"title=删除数据源>🗑️ 删除');function Zf(n){console.log("🏗️  DataSourceManagementCenter 组件渲染，isOpen:",n.isOpen);const[e,t]=Z([]),[i,s]=Z([]),[r,a]=Z("main"),[l,o]=Z(null),[c,d]=Z(null),[h,u]=Z(!1),[v,f]=Z(null),[p,b]=Z(null),[m,_]=Z(""),[w,x]=Z("all"),[C,A]=Z("all");et(async()=>{try{await M(),await I();const q=Je.subscribe(W=>{b(W?.dataSource.id||null)});b(Je.getCurrentContext()?.dataSource.id||null),$t(q)}catch(q){console.error("🚨 数据源管理中心初始化失败:",q),f(`初始化失败: ${q}`)}});const M=async()=>{try{u(!0),console.log("🔄 加载数据源列表...");const q=await Ae.listDataSources();console.log("✅ 数据源列表加载成功:",q),t(q),f(null)}catch(q){console.error("❌ 加载数据源失败:",q),f(`加载数据源失败: ${q}`)}finally{u(!1)}},I=async()=>{try{console.log("🔄 加载可用数据源类型...");const q=await Ae.getAvailableTypes();console.log("✅ 数据源类型加载成功:",q),s(q)}catch(q){console.error("❌ 加载数据源类型失败:",q)}},z=q=>{const W=(q.providerType||"").toLowerCase();return W.includes("database_mysql")?"mysql":W.includes("database_postgresql")?"postgresql":W.includes("database")?"database":W.includes("json")?"json":W.includes("csv")?"csv":W.includes("excel")?"excel":W.includes("api")?"api":W||"unknown"},E=()=>{let q=e();if(m()){const W=m().toLowerCase();q=q.filter(j=>(j.name||"").toLowerCase().includes(W)||z(j).includes(W))}return w()!=="all"&&(q=q.filter(W=>W.status===w())),C()!=="all"&&(q=q.filter(W=>z(W)===C())),q},R=q=>e().filter(W=>W.status===q).length,T=q=>e().filter(W=>z(W)===q).length,U=()=>{a("add"),o(null)},N=()=>{a("add-database"),o(null)},$=q=>{o(q),a("edit")},P=async q=>{try{u(!0),f(null),o(q),console.log("🔄 开始预览数据源:",q.name);const W=await Ae.getPreview(q.id);d(W),a("preview"),console.log("✅ 数据预览加载成功:",W)}catch(W){console.error("❌ 数据预览失败:",W),f(`预览数据源 "${q.name}" 失败: ${W}`)}finally{u(!1)}},Q=async q=>{try{u(!0),await Je.setActiveDataSource(q.id)}catch(W){console.error("❌ 激活数据源失败:",W),f(`激活数据源失败: ${W}`)}finally{u(!1)}},G=async q=>{try{u(!0);const W=e().find(he=>he.id===q);if(!W){f(`数据源不存在: ${q}`);return}const j=await Ae.testConnection(W.providerType||W.provider_type,W.config||{});alert(j?`✅ 数据源 "${W.name}" 连接测试成功！`:`❌ 数据源 "${W.name}" 连接测试失败`)}catch(W){console.error("❌ 测试连接失败:",W);const j=e().find(he=>he.id===q);alert(`❌ 数据源 "${j?.name||q}" 连接测试失败:
${W}`)}finally{u(!1)}},D=async q=>{const W=e().find(j=>j.id===q);if(confirm(`确定要删除数据源 "${W?.name}" 吗？`))try{await Ae.deleteDataSource(q),await M()}catch(j){f(`删除数据源失败: ${j}`)}},V=()=>{a("main"),o(null),d(null),f(null)};return y(H,{get when(){return n.isOpen},get children(){var q=jf(),W=q.firstChild,j=W.firstChild,he=j.nextSibling,_e=he.nextSibling,pe=W.nextSibling;return Le(j,"click",n.onClose),g(_e,y(H,{get when(){return r()==="main"},get children(){return[(()=>{var se=Nf();return se.$$input=ce=>_(ce.currentTarget.value),B(()=>se.value=m()),se})(),(()=>{var se=zf(),ce=se.firstChild,ue=ce.nextSibling;return ce.$$click=U,ue.$$click=N,se})()]}})),g(pe,y(H,{get when(){return r()==="main"},get children(){var se=Hf(),ce=se.firstChild,ue=ce.firstChild,ve=ue.firstChild,ne=ve.nextSibling,ee=ne.firstChild,ge=ee.firstChild,be=ge.firstChild,ke=be.nextSibling;ke.nextSibling;var ye=ue.nextSibling,Pe=ye.firstChild,de=Pe.nextSibling,xe=de.firstChild,L=xe.firstChild,O=L.firstChild,K=O.nextSibling;K.nextSibling;var Y=xe.nextSibling,te=Y.firstChild,oe=te.firstChild,ae=oe.nextSibling;ae.nextSibling;var $e=Y.nextSibling,Ie=$e.firstChild,Te=Ie.firstChild,Ye=Te.nextSibling;Ye.nextSibling;var We=ye.nextSibling,lt=We.firstChild,Pt=lt.nextSibling,rt=Pt.firstChild,Ir=rt.firstChild,_n=ce.nextSibling;return ge.$$click=()=>x("all"),g(ge,()=>e().length,ke),L.$$click=()=>x("active"),g(L,()=>R("active"),K),te.$$click=()=>x("error"),g(te,()=>R("error"),ae),Ie.$$click=()=>x("disabled"),g(Ie,()=>R("disabled"),Ye),Ir.$$click=()=>A("all"),g(Pt,y(fe,{get each(){return i()},children:De=>(()=>{var je=Yf(),ot=je.firstChild,Qt=ot.firstChild,Kt=Qt.nextSibling,xn=Kt.nextSibling,zi=xn.nextSibling;return zi.nextSibling,ot.$$click=()=>A(De.typeName),g(ot,()=>De.category==="file"?"📄":De.category==="api"?"🌐":De.category==="database"?"🗄️":"📊",Qt),g(ot,()=>De.displayName,Kt),g(ot,()=>T(De.typeName),zi),B(()=>Se(je,C()===De.typeName?"active":"")),je})()}),null),g(_n,y(H,{get when(){return v()},get children(){var De=Ff();return g(De,v),De}}),null),g(_n,y(H,{get when(){return h()},get children(){return Gf()}}),null),g(_n,y(H,{get when(){return Ce(()=>!h())()&&E().length===0},get children(){var De=Bf(),je=De.firstChild,ot=je.nextSibling;return g(je,()=>m()||w()!=="all"||C()!=="all"?"没有找到匹配的数据源":"尚未配置任何数据源"),ot.$$click=U,De}}),null),g(_n,y(H,{get when(){return Ce(()=>!h())()&&E().length>0},get children(){var De=Uf();return g(De,y(fe,{get each(){return E()},children:je=>y(e0,{source:je,onPreview:()=>P(je),onTest:()=>G(je.id),onEdit:()=>$(je),onDelete:()=>D(je.id),onActivate:()=>Q(je),get active(){return p()===je.id}})})),De}}),null),B(De=>{var je=w()==="all"?"active":"",ot=w()==="active"?"active":"",Qt=w()==="error"?"active":"",Kt=w()==="disabled"?"active":"",xn=C()==="all"?"active":"";return je!==De.e&&Se(ee,De.e=je),ot!==De.t&&Se(xe,De.t=ot),Qt!==De.a&&Se(Y,De.a=Qt),Kt!==De.o&&Se($e,De.o=Kt),xn!==De.i&&Se(rt,De.i=xn),De},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),se}}),null),g(pe,y(H,{get when(){return r()==="add"},get children(){return y(Dr,{get availableTypes(){return i()},onBack:V,onSuccess:()=>{M(),V()}})}}),null),g(pe,y(H,{get when(){return r()==="add-database"},get children(){return y(Tf,{onBack:V,onSuccess:()=>{M(),V()}})}}),null),g(pe,y(H,{get when(){return Ce(()=>r()==="edit")()&&l()},get children(){var se=qf(),ce=se.firstChild,ue=ce.firstChild,ve=ue.nextSibling;return ve.firstChild,ue.$$click=V,g(ve,()=>l()?.name,null),se}}),null),g(pe,y(H,{get when(){return Ce(()=>!!(r()==="preview"&&l()))()&&c()},get children(){var se=Wf(),ce=se.firstChild,ue=ce.firstChild,ve=ue.nextSibling;ve.firstChild;var ne=ve.nextSibling,ee=ne.firstChild,ge=ee.nextSibling,be=ge.nextSibling,ke=be.nextSibling;ke.nextSibling;var ye=ce.nextSibling,Pe=ye.firstChild,de=Pe.firstChild,xe=de.firstChild,L=de.nextSibling;return ue.$$click=V,g(ve,()=>l()?.name,null),g(ne,()=>c()?.totalCount??c()?.total_rows,ge),g(ne,()=>c()?.rows.length,ke),g(xe,y(fe,{get each(){return c()?.columns},children:O=>(()=>{var K=Vf();return g(K,O),K})()})),g(L,y(fe,{get each(){return c()?.rows.slice(0,50)},children:O=>(()=>{var K=Xf();return g(K,y(fe,{get each(){return c()?.columns||[]},children:Y=>(()=>{var te=Qf();return g(te,(()=>{var oe=Ce(()=>typeof O[Y]=="object");return()=>oe()?JSON.stringify(O[Y]):String(O[Y]||"")})()),te})()})),K})()})),se}}),null),q}})}function e0(n){const e=a=>{switch(a){case"active":return"#22c55e";case"error":return"#ef4444";case"disabled":return"#6b7280";default:return"#6b7280"}},t=a=>{switch(a){case"active":return"已连接";case"error":return"连接异常";case"disabled":return"未启用";default:return"未知"}},i=a=>{const l=new Date,o=new Date(a),c=l.getTime()-o.getTime(),d=Math.floor(c/(1e3*60*60));return d<1?"刚刚更新":d<24?`${d}小时前`:o.toLocaleDateString("zh-CN")},s=a=>{const l=(a||"").toLowerCase();return l.includes("json")?"📄":l.includes("api")?"🌐":l.includes("csv")?"📊":l.includes("database")?"🗄️":"📋"},r=a=>{const l=(a.providerType||a.provider_type||"").toLowerCase();return l.includes("database_mysql")?"MySQL":l.includes("database_postgresql")?"PostgreSQL":l==="json"?"JSON":l==="csv"?"CSV":l==="excel"?"Excel":l.startsWith("api")?"API":l.startsWith("database")?"Database":a.providerType||a.provider_type||"Unknown"};return(()=>{var a=Jf(),l=a.firstChild,o=l.firstChild,c=o.firstChild,d=c.nextSibling,h=o.nextSibling,u=l.nextSibling,v=u.firstChild,f=v.firstChild,p=f.nextSibling,b=v.nextSibling,m=b.firstChild,_=m.nextSibling,w=b.nextSibling,x=w.firstChild,C=x.nextSibling,A=u.nextSibling,M=A.firstChild,I=M.nextSibling,z=I.nextSibling,E=z.nextSibling,R=E.nextSibling;return g(c,()=>s(n.source.providerType)),g(d,()=>n.source.name,null),g(d,y(H,{get when(){return n.active},get children(){return Kf()}}),null),g(p,()=>r(n.source)),g(_,()=>t(n.source.status)),g(C,()=>i(n.source.lastUpdated)),Le(M,"click",n.onPreview),Le(I,"click",n.onTest),Le(z,"click",n.onEdit),Le(E,"click",n.onActivate),Le(R,"click",n.onDelete),B(T=>{var U=n.active?"true":"false",N=e(n.source.status),$=`状态: ${t(n.source.status)}`,P=n.source.status!=="active",Q=n.active;return U!==T.e&&X(a,"data-active",T.e=U),N!==T.t&&((T.t=N)!=null?h.style.setProperty("background-color",N):h.style.removeProperty("background-color")),$!==T.a&&X(h,"title",T.a=$),P!==T.o&&(M.disabled=T.o=P),Q!==T.i&&(E.disabled=T.i=Q),T},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),a})()}He(["click","input"]);var t0=S("<div class=flex-1>"),Ps=S('<div class="w-80 bg-primary border-r border-default flex flex-col">'),As=S('<div class="flex-1 flex flex-col bg-tertiary">'),n0=S('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class=min-h-fit></div><div class="border-t border-default min-h-fit">'),i0=S('<div class="w-80 bg-primary border-l border-default flex flex-col"><div class="flex-1 overflow-y-auto custom-scrollbar"><div class="border-b border-default min-h-fit"></div><div class=min-h-fit>'),s0=S('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden">');const r0=()=>{const{state:n}=Xn(),[e,t]=Z(!1),[i,s]=Z(!1);console.log("🖥️  MainLayout渲染，当前模式:",n().mode);const r=()=>{console.log("🔄 数据源按钮被点击，准备打开管理中心"),console.log("📊 当前管理中心状态:",i()),s(!0),console.log("✅ 管理中心状态已设置为 true"),console.log("📊 设置后的管理中心状态:",i())},a=()=>t(!1),l=()=>s(!1);return(()=>{var o=s0(),c=o.firstChild;return g(o,y(_a,{onOpenDataSources:r}),c),g(c,y(Us,{get children(){return[y(xt,{get when(){return n().mode==="preview"},get children(){var d=t0();return g(d,y(Qd,{})),d}}),y(xt,{get when(){return n().mode==="design"},get children(){return[(()=>{var d=Ps();return g(d,y(qi,{})),d})(),(()=>{var d=As();return g(d,y(Ki,{})),d})(),(()=>{var d=n0(),h=d.firstChild,u=h.firstChild,v=u.nextSibling;return g(u,y(Xi,{})),g(v,y(Es,{})),d})()]}}),y(xt,{get when(){return n().mode==="data"},get children(){return[(()=>{var d=Ps();return g(d,y(qi,{})),d})(),(()=>{var d=As();return g(d,y(Ki,{})),d})(),(()=>{var d=i0(),h=d.firstChild,u=h.firstChild,v=u.nextSibling;return g(u,y(Es,{})),g(v,y(Xi,{})),d})()]}})]}})),g(o,y(Zf,{get isOpen(){return i()},onClose:l}),null),g(o,y(Eu,{get isOpen(){return e()},onClose:a}),null),o})()},a0=()=>y(ta,{get children(){return y(r0,{})}}),l0={copy:{action:"copy",combination:{key:"c",ctrl:!0}},paste:{action:"paste",combination:{key:"v",ctrl:!0}},cut:{action:"cut",combination:{key:"x",ctrl:!0}},delete:{action:"delete",combination:{key:"Delete"}},deleteAlt:{action:"delete",combination:{key:"Backspace"}},undo:{action:"undo",combination:{key:"z",ctrl:!0}},redo:{action:"redo",combination:{key:"y",ctrl:!0}},redoAlt:{action:"redo",combination:{key:"z",ctrl:!0,shift:!0}},selectAll:{action:"selectAll",combination:{key:"a",ctrl:!0}},clearSelection:{action:"clearSelection",combination:{key:"Escape"}},duplicate:{action:"duplicate",combination:{key:"d",ctrl:!0}},moveUp:{action:"moveUp",combination:{key:"ArrowUp"}},moveDown:{action:"moveDown",combination:{key:"ArrowDown"}},moveLeft:{action:"moveLeft",combination:{key:"ArrowLeft"}},moveRight:{action:"moveRight",combination:{key:"ArrowRight"}},moveFastUp:{action:"moveFastUp",combination:{key:"ArrowUp",shift:!0}},moveFastDown:{action:"moveFastDown",combination:{key:"ArrowDown",shift:!0}},moveFastLeft:{action:"moveFastLeft",combination:{key:"ArrowLeft",shift:!0}},moveFastRight:{action:"moveFastRight",combination:{key:"ArrowRight",shift:!0}}},o0=()=>{const{state:n,copySelectedElements:e,pasteElements:t,deleteElements:i,undo:s,redo:r,selectAllElements:a,clearSelection:l,moveElements:o}=ct(),c=(f,p)=>{const b=f.key.toLowerCase()===p.key.toLowerCase()||f.key===p.key,m=!!p.ctrl===(f.ctrlKey||f.metaKey),_=!!p.alt===f.altKey,w=!!p.shift===f.shiftKey;return b&&m&&_&&w},d=async f=>{console.log("🎯 执行快捷键:",f);try{switch(f){case"copy":n.selected_ids.length>0&&(await e(),u("复制成功","✅"));break;case"paste":const p={x:20,y:20},b=await t(p.x,p.y);b.length>0&&u(`粘贴 ${b.length} 个元素`,"📋");break;case"cut":n.selected_ids.length>0&&(await e(),await i([...n.selected_ids]),u("剪切成功","✂️"));break;case"delete":if(n.selected_ids.length>0){const m=n.selected_ids.length;await i([...n.selected_ids]),u(`删除 ${m} 个元素`,"🗑️")}break;case"undo":await s(),u("撤销","↶");break;case"redo":await r(),u("重做","↷");break;case"selectAll":await a(),u(`全选 ${n.elements.length} 个元素`,"🎯");break;case"clearSelection":n.selected_ids.length>0&&(l(),u("清除选择","⭕"));break;case"duplicate":if(n.selected_ids.length>0){await e();const m=await t(20,20);u(`复制 ${m.length} 个元素`,"📄")}break;case"moveUp":case"moveDown":case"moveLeft":case"moveRight":case"moveFastUp":case"moveFastDown":case"moveFastLeft":case"moveFastRight":await h(f);break;default:console.warn("未知的快捷键动作:",f)}}catch(p){console.error("快捷键执行失败:",p),u("操作失败","❌")}},h=async f=>{if(n.selected_ids.length===0)return;const p=f.includes("Fast"),b=p?10:1;let m=0,_=0;switch(f){case"moveUp":case"moveFastUp":_=-b;break;case"moveDown":case"moveFastDown":_=b;break;case"moveLeft":case"moveFastLeft":m=-b;break;case"moveRight":case"moveFastRight":m=b;break}(m!==0||_!==0)&&(await o([...n.selected_ids],m,_),p&&u(`快速移动 ${b}px`,"🔄"))},u=(f,p)=>{const b=document.createElement("div");b.className="keyboard-feedback",b.innerHTML=`
      <div class="feedback-content">
        <span class="feedback-icon">${p}</span>
        <span class="feedback-text">${f}</span>
      </div>
    `,document.body.appendChild(b),setTimeout(()=>{b.parentNode&&b.parentNode.removeChild(b)},2e3)},v=f=>{const p=f.target;if(!(p.tagName==="INPUT"||p.tagName==="TEXTAREA"||p.contentEditable==="true")){for(const[m,_]of Object.entries(l0))if(c(f,_.combination)){f.preventDefault(),f.stopPropagation(),console.log("🎹 快捷键触发:",m,_.action),d(_.action);return}}};return et(()=>{if(document.addEventListener("keydown",v,!0),console.log("🎹 键盘快捷键管理器已启动"),!document.getElementById("keyboard-feedback-styles")){const f=document.createElement("style");f.id="keyboard-feedback-styles",f.textContent=`
        .keyboard-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s;
          pointer-events: none;
        }

        .feedback-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .feedback-icon {
          font-size: 16px;
        }

        .feedback-text {
          font-size: 14px;
          font-weight: 500;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
      `,document.head.appendChild(f)}}),$t(()=>{document.removeEventListener("keydown",v,!0),console.log("🎹 键盘快捷键管理器已停止")}),null},c0=()=>(et(()=>{document.addEventListener("contextmenu",n=>n.preventDefault());try{const n=typeof window<"u"?window.localStorage.getItem("jasper.activeDataSourceId"):null;n&&Je.setActiveDataSource(n).catch(e=>{console.warn("恢复激活数据源失败:",e)})}catch(n){console.warn("读取本地激活数据源失败:",n)}}),y(ca,{get children(){return[y(o0,{}),y(a0,{})]}})),d0=document.getElementById("root");Xr(()=>y(c0,{}),d0);
