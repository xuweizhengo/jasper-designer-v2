(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(n){if(n.ep)return;n.ep=!0;const l=i(n);fetch(n.href,l)}})();const jt=!1,Ht=(e,t)=>e===t,$e=Symbol("solid-proxy"),ot=Symbol("solid-track"),Ve={equals:Ht};let wt=St;const we=1,qe=2,pt={owned:null,cleanups:null,context:null,owner:null};var Z=null;let nt=null,Gt=null,X=null,re=null,ve=null,et=0;function Be(e,t){const i=X,o=Z,n=e.length===0,l=t===void 0?o:t,r=n?pt:{owned:null,cleanups:null,context:l?l.context:null,owner:l},s=n?e:()=>e(()=>ae(()=>Oe(r)));Z=r,X=null;try{return Me(s,!0)}finally{X=i,Z=o}}function Q(e,t){t=t?Object.assign({},Ve,t):Ve;const i={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},o=n=>(typeof n=="function"&&(n=n(i.value)),$t(i,n));return[_t.bind(i),o]}function k(e,t,i){const o=ut(e,t,!1,we);Ge(o)}function Bt(e,t,i){wt=Jt;const o=ut(e,t,!1,we);o.user=!0,ve?ve.push(o):Ge(o)}function le(e,t,i){i=i?Object.assign({},Ve,i):Ve;const o=ut(e,t,!0,0);return o.observers=null,o.observerSlots=null,o.comparator=i.equals||void 0,Ge(o),_t.bind(o)}function Vt(e){return Me(e,!1)}function ae(e){if(X===null)return e();const t=X;X=null;try{return e()}finally{X=t}}function tt(e){Bt(()=>ae(e))}function dt(e){return Z===null||(Z.cleanups===null?Z.cleanups=[e]:Z.cleanups.push(e)),e}function it(){return X}function qt(e,t){const i=Symbol("context");return{id:i,Provider:Yt(i),defaultValue:e}}function Kt(e){let t;return Z&&Z.context&&(t=Z.context[e.id])!==void 0?t:e.defaultValue}function xt(e){const t=le(e),i=le(()=>rt(t()));return i.toArray=()=>{const o=i();return Array.isArray(o)?o:o!=null?[o]:[]},i}function _t(){if(this.sources&&this.state)if(this.state===we)Ge(this);else{const e=re;re=null,Me(()=>We(this),!1),re=e}if(X){const e=this.observers?this.observers.length:0;X.sources?(X.sources.push(this),X.sourceSlots.push(e)):(X.sources=[this],X.sourceSlots=[e]),this.observers?(this.observers.push(X),this.observerSlots.push(X.sources.length-1)):(this.observers=[X],this.observerSlots=[X.sources.length-1])}return this.value}function $t(e,t,i){let o=e.value;return(!e.comparator||!e.comparator(o,t))&&(e.value=t,e.observers&&e.observers.length&&Me(()=>{for(let n=0;n<e.observers.length;n+=1){const l=e.observers[n],r=nt&&nt.running;r&&nt.disposed.has(l),(r?!l.tState:!l.state)&&(l.pure?re.push(l):ve.push(l),l.observers&&Ct(l)),r||(l.state=we)}if(re.length>1e6)throw re=[],new Error},!1)),t}function Ge(e){if(!e.fn)return;Oe(e);const t=et;Wt(e,e.value,t)}function Wt(e,t,i){let o;const n=Z,l=X;X=Z=e;try{o=e.fn(t)}catch(r){return e.pure&&(e.state=we,e.owned&&e.owned.forEach(Oe),e.owned=null),e.updatedAt=i+1,kt(r)}finally{X=l,Z=n}(!e.updatedAt||e.updatedAt<=i)&&(e.updatedAt!=null&&"observers"in e?$t(e,o):e.value=o,e.updatedAt=i)}function ut(e,t,i,o=we,n){const l={fn:e,state:o,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:Z,context:Z?Z.context:null,pure:i};return Z===null||Z!==pt&&(Z.owned?Z.owned.push(l):Z.owned=[l]),l}function Ke(e){if(e.state===0)return;if(e.state===qe)return We(e);if(e.suspense&&ae(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<et);)e.state&&t.push(e);for(let i=t.length-1;i>=0;i--)if(e=t[i],e.state===we)Ge(e);else if(e.state===qe){const o=re;re=null,Me(()=>We(e,t[0]),!1),re=o}}function Me(e,t){if(re)return e();let i=!1;t||(re=[]),ve?i=!0:ve=[],et++;try{const o=e();return Zt(i),o}catch(o){i||(ve=null),re=null,kt(o)}}function Zt(e){if(re&&(St(re),re=null),e)return;const t=ve;ve=null,t.length&&Me(()=>wt(t),!1)}function St(e){for(let t=0;t<e.length;t++)Ke(e[t])}function Jt(e){let t,i=0;for(t=0;t<e.length;t++){const o=e[t];o.user?e[i++]=o:Ke(o)}for(t=0;t<i;t++)Ke(e[t])}function We(e,t){e.state=0;for(let i=0;i<e.sources.length;i+=1){const o=e.sources[i];if(o.sources){const n=o.state;n===we?o!==t&&(!o.updatedAt||o.updatedAt<et)&&Ke(o):n===qe&&We(o,t)}}}function Ct(e){for(let t=0;t<e.observers.length;t+=1){const i=e.observers[t];i.state||(i.state=qe,i.pure?re.push(i):ve.push(i),i.observers&&Ct(i))}}function Oe(e){let t;if(e.sources)for(;e.sources.length;){const i=e.sources.pop(),o=e.sourceSlots.pop(),n=i.observers;if(n&&n.length){const l=n.pop(),r=i.observerSlots.pop();o<n.length&&(l.sourceSlots[r]=o,n[o]=l,i.observerSlots[o]=r)}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)Oe(e.tOwned[t]);delete e.tOwned}if(e.owned){for(t=e.owned.length-1;t>=0;t--)Oe(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function Qt(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function kt(e,t=Z){throw Qt(e)}function rt(e){if(typeof e=="function"&&!e.length)return rt(e());if(Array.isArray(e)){const t=[];for(let i=0;i<e.length;i++){const o=rt(e[i]);Array.isArray(o)?t.push.apply(t,o):t.push(o)}return t}return e}function Yt(e,t){return function(o){let n;return k(()=>n=ae(()=>(Z.context={...Z.context,[e]:o.value},xt(()=>o.children))),void 0),n}}const Xt=Symbol("fallback");function ft(e){for(let t=0;t<e.length;t++)e[t]()}function en(e,t,i={}){let o=[],n=[],l=[],r=0,s=t.length>1?[]:null;return dt(()=>ft(l)),()=>{let c=e()||[],a=c.length,v,h;return c[ot],ae(()=>{let M,T,A,q,z,P,D,B,G;if(a===0)r!==0&&(ft(l),l=[],o=[],n=[],r=0,s&&(s=[])),i.fallback&&(o=[Xt],n[0]=Be(ee=>(l[0]=ee,i.fallback())),r=1);else if(r===0){for(n=new Array(a),h=0;h<a;h++)o[h]=c[h],n[h]=Be(C);r=a}else{for(A=new Array(a),q=new Array(a),s&&(z=new Array(a)),P=0,D=Math.min(r,a);P<D&&o[P]===c[P];P++);for(D=r-1,B=a-1;D>=P&&B>=P&&o[D]===c[B];D--,B--)A[B]=n[D],q[B]=l[D],s&&(z[B]=s[D]);for(M=new Map,T=new Array(B+1),h=B;h>=P;h--)G=c[h],v=M.get(G),T[h]=v===void 0?-1:v,M.set(G,h);for(v=P;v<=D;v++)G=o[v],h=M.get(G),h!==void 0&&h!==-1?(A[h]=n[v],q[h]=l[v],s&&(z[h]=s[v]),h=T[h],M.set(G,h)):l[v]();for(h=P;h<a;h++)h in A?(n[h]=A[h],l[h]=q[h],s&&(s[h]=z[h],s[h](h))):n[h]=Be(C);n=n.slice(0,r=a),o=c.slice(0)}return n});function C(M){if(l[h]=M,s){const[T,A]=Q(h);return s[h]=A,t(c[h],T)}return t(c[h])}}}function y(e,t){return ae(()=>e(t||{}))}const Et=e=>`Stale read from <${e}>.`;function _e(e){const t="fallback"in e&&{fallback:()=>e.fallback};return le(en(()=>e.each,e.children,t||void 0))}function Re(e){const t=e.keyed,i=le(()=>e.when,void 0,void 0),o=t?i:le(i,void 0,{equals:(n,l)=>!n==!l});return le(()=>{const n=o();if(n){const l=e.children;return typeof l=="function"&&l.length>0?ae(()=>l(t?n:()=>{if(!ae(o))throw Et("Show");return i()})):l}return e.fallback},void 0,void 0)}function tn(e){const t=xt(()=>e.children),i=le(()=>{const o=t(),n=Array.isArray(o)?o:[o];let l=()=>{};for(let r=0;r<n.length;r++){const s=r,c=n[r],a=l,v=le(()=>a()?void 0:c.when,void 0,void 0),h=c.keyed?v:le(v,void 0,{equals:(C,M)=>!C==!M});l=()=>a()||(h()?[s,v,c]:void 0)}return l});return le(()=>{const o=i()();if(!o)return e.fallback;const[n,l,r]=o,s=r.children;return typeof s=="function"&&s.length>0?ae(()=>s(r.keyed?l():()=>{var a;if(((a=ae(i)())==null?void 0:a[0])!==n)throw Et("Match");return l()})):s},void 0,void 0)}function Ie(e){return e}const fe=e=>le(()=>e());function nn(e,t,i){let o=i.length,n=t.length,l=o,r=0,s=0,c=t[n-1].nextSibling,a=null;for(;r<n||s<l;){if(t[r]===i[s]){r++,s++;continue}for(;t[n-1]===i[l-1];)n--,l--;if(n===r){const v=l<o?s?i[s-1].nextSibling:i[l-s]:c;for(;s<l;)e.insertBefore(i[s++],v)}else if(l===s)for(;r<n;)(!a||!a.has(t[r]))&&t[r].remove(),r++;else if(t[r]===i[l-1]&&i[s]===t[n-1]){const v=t[--n].nextSibling;e.insertBefore(i[s++],t[r++].nextSibling),e.insertBefore(i[--l],v),t[n]=i[l]}else{if(!a){a=new Map;let h=s;for(;h<l;)a.set(i[h],h++)}const v=a.get(t[r]);if(v!=null)if(s<v&&v<l){let h=r,C=1,M;for(;++h<n&&h<l&&!((M=a.get(t[h]))==null||M!==v+C);)C++;if(C>v-s){const T=t[r];for(;s<v;)e.insertBefore(i[s++],T)}else e.replaceChild(i[s++],t[r++])}else r++;else t[r++].remove()}}}const ht="_$DX_DELEGATE";function ln(e,t,i,o={}){let n;return Be(l=>{n=l,t===document?e():u(t,e(),t.firstChild?null:void 0,i)},o.owner),()=>{n(),t.textContent=""}}function _(e,t,i,o){let n;const l=()=>{const s=o?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return s.innerHTML=e,i?s.content.firstChild.firstChild:o?s.firstChild:s.content.firstChild},r=t?()=>ae(()=>document.importNode(n||(n=l()),!0)):()=>(n||(n=l())).cloneNode(!0);return r.cloneNode=r,r}function Se(e,t=window.document){const i=t[ht]||(t[ht]=new Set);for(let o=0,n=e.length;o<n;o++){const l=e[o];i.has(l)||(i.add(l),t.addEventListener(l,rn))}}function x(e,t,i){i==null?e.removeAttribute(t):e.setAttribute(t,i)}function Pe(e,t){t==null?e.removeAttribute("class"):e.className=t}function st(e,t,i,o){Array.isArray(i)?(e[`$$${t}`]=i[0],e[`$$${t}Data`]=i[1]):e[`$$${t}`]=i}function on(e,t,i){if(!t)return i?x(e,"style"):t;const o=e.style;if(typeof t=="string")return o.cssText=t;typeof i=="string"&&(o.cssText=i=void 0),i||(i={}),t||(t={});let n,l;for(l in i)t[l]==null&&o.removeProperty(l),delete i[l];for(l in t)n=t[l],n!==i[l]&&(o.setProperty(l,n),i[l]=n);return i}function zt(e,t,i){return ae(()=>e(t,i))}function u(e,t,i,o){if(i!==void 0&&!o&&(o=[]),typeof t!="function")return Ze(e,t,o,i);k(n=>Ze(e,t(),n,i),o)}function rn(e){let t=e.target;const i=`$$${e.type}`,o=e.target,n=e.currentTarget,l=c=>Object.defineProperty(e,"target",{configurable:!0,value:c}),r=()=>{const c=t[i];if(c&&!t.disabled){const a=t[`${i}Data`];if(a!==void 0?c.call(t,a,e):c.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&l(t.host),!0},s=()=>{for(;r()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const c=e.composedPath();l(c[0]);for(let a=0;a<c.length-2&&(t=c[a],!!r());a++){if(t._$host){t=t._$host,s();break}if(t.parentNode===n)break}}else s();l(o)}function Ze(e,t,i,o,n){for(;typeof i=="function";)i=i();if(t===i)return i;const l=typeof t,r=o!==void 0;if(e=r&&i[0]&&i[0].parentNode||e,l==="string"||l==="number"){if(l==="number"&&(t=t.toString(),t===i))return i;if(r){let s=i[0];s&&s.nodeType===3?s.data!==t&&(s.data=t):s=document.createTextNode(t),i=ze(e,i,o,s)}else i!==""&&typeof i=="string"?i=e.firstChild.data=t:i=e.textContent=t}else if(t==null||l==="boolean")i=ze(e,i,o);else{if(l==="function")return k(()=>{let s=t();for(;typeof s=="function";)s=s();i=Ze(e,s,i,o)}),()=>i;if(Array.isArray(t)){const s=[],c=i&&Array.isArray(i);if(at(s,t,i,n))return k(()=>i=Ze(e,s,i,o,!0)),()=>i;if(s.length===0){if(i=ze(e,i,o),r)return i}else c?i.length===0?gt(e,s,o):nn(e,i,s):(i&&ze(e),gt(e,s));i=s}else if(t.nodeType){if(Array.isArray(i)){if(r)return i=ze(e,i,o,t);ze(e,i,null,t)}else i==null||i===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);i=t}}return i}function at(e,t,i,o){let n=!1;for(let l=0,r=t.length;l<r;l++){let s=t[l],c=i&&i[e.length],a;if(!(s==null||s===!0||s===!1))if((a=typeof s)=="object"&&s.nodeType)e.push(s);else if(Array.isArray(s))n=at(e,s,c)||n;else if(a==="function")if(o){for(;typeof s=="function";)s=s();n=at(e,Array.isArray(s)?s:[s],Array.isArray(c)?c:[c])||n}else e.push(s),n=!0;else{const v=String(s);c&&c.nodeType===3&&c.data===v?e.push(c):e.push(document.createTextNode(v))}}return n}function gt(e,t,i=null){for(let o=0,n=t.length;o<n;o++)e.insertBefore(t[o],i)}function ze(e,t,i,o){if(i===void 0)return e.textContent="";const n=o||document.createTextNode("");if(t.length){let l=!1;for(let r=t.length-1;r>=0;r--){const s=t[r];if(n!==s){const c=s.parentNode===e;!l&&!r?c?e.replaceChild(n,s):e.insertBefore(n,i):c&&s.remove()}else l=!0}}else e.insertBefore(n,i);return[n]}const ct=Symbol("store-raw"),Ae=Symbol("store-node"),ge=Symbol("store-has"),Pt=Symbol("store-self");function At(e){let t=e[$e];if(!t&&(Object.defineProperty(e,$e,{value:t=new Proxy(e,cn)}),!Array.isArray(e))){const i=Object.keys(e),o=Object.getOwnPropertyDescriptors(e);for(let n=0,l=i.length;n<l;n++){const r=i[n];o[r].get&&Object.defineProperty(e,r,{enumerable:o[r].enumerable,get:o[r].get.bind(t)})}}return t}function Je(e){let t;return e!=null&&typeof e=="object"&&(e[$e]||!(t=Object.getPrototypeOf(e))||t===Object.prototype||Array.isArray(e))}function Fe(e,t=new Set){let i,o,n,l;if(i=e!=null&&e[ct])return i;if(!Je(e)||t.has(e))return e;if(Array.isArray(e)){Object.isFrozen(e)?e=e.slice(0):t.add(e);for(let r=0,s=e.length;r<s;r++)n=e[r],(o=Fe(n,t))!==n&&(e[r]=o)}else{Object.isFrozen(e)?e=Object.assign({},e):t.add(e);const r=Object.keys(e),s=Object.getOwnPropertyDescriptors(e);for(let c=0,a=r.length;c<a;c++)l=r[c],!s[l].get&&(n=e[l],(o=Fe(n,t))!==n&&(e[l]=o))}return e}function Qe(e,t){let i=e[t];return i||Object.defineProperty(e,t,{value:i=Object.create(null)}),i}function Ne(e,t,i){if(e[t])return e[t];const[o,n]=Q(i,{equals:!1,internal:!0});return o.$=n,e[t]=o}function sn(e,t){const i=Reflect.getOwnPropertyDescriptor(e,t);return!i||i.get||!i.configurable||t===$e||t===Ae||(delete i.value,delete i.writable,i.get=()=>e[$e][t]),i}function Mt(e){it()&&Ne(Qe(e,Ae),Pt)()}function an(e){return Mt(e),Reflect.ownKeys(e)}const cn={get(e,t,i){if(t===ct)return e;if(t===$e)return i;if(t===ot)return Mt(e),i;const o=Qe(e,Ae),n=o[t];let l=n?n():e[t];if(t===Ae||t===ge||t==="__proto__")return l;if(!n){const r=Object.getOwnPropertyDescriptor(e,t);it()&&(typeof l!="function"||e.hasOwnProperty(t))&&!(r&&r.get)&&(l=Ne(o,t,l)())}return Je(l)?At(l):l},has(e,t){return t===ct||t===$e||t===ot||t===Ae||t===ge||t==="__proto__"?!0:(it()&&Ne(Qe(e,ge),t)(),t in e)},set(){return!0},deleteProperty(){return!0},ownKeys:an,getOwnPropertyDescriptor:sn};function Ye(e,t,i,o=!1){if(!o&&e[t]===i)return;const n=e[t],l=e.length;i===void 0?(delete e[t],e[ge]&&e[ge][t]&&n!==void 0&&e[ge][t].$()):(e[t]=i,e[ge]&&e[ge][t]&&n===void 0&&e[ge][t].$());let r=Qe(e,Ae),s;if((s=Ne(r,t,n))&&s.$(()=>i),Array.isArray(e)&&e.length!==l){for(let c=e.length;c<l;c++)(s=r[c])&&s.$();(s=Ne(r,"length",l))&&s.$(e.length)}(s=r[Pt])&&s.$()}function Dt(e,t){const i=Object.keys(t);for(let o=0;o<i.length;o+=1){const n=i[o];Ye(e,n,t[n])}}function dn(e,t){if(typeof t=="function"&&(t=t(e)),t=Fe(t),Array.isArray(t)){if(e===t)return;let i=0,o=t.length;for(;i<o;i++){const n=t[i];e[i]!==n&&Ye(e,i,n)}Ye(e,"length",o)}else Dt(e,t)}function Te(e,t,i=[]){let o,n=e;if(t.length>1){o=t.shift();const r=typeof o,s=Array.isArray(e);if(Array.isArray(o)){for(let c=0;c<o.length;c++)Te(e,[o[c]].concat(t),i);return}else if(s&&r==="function"){for(let c=0;c<e.length;c++)o(e[c],c)&&Te(e,[c].concat(t),i);return}else if(s&&r==="object"){const{from:c=0,to:a=e.length-1,by:v=1}=o;for(let h=c;h<=a;h+=v)Te(e,[h].concat(t),i);return}else if(t.length>1){Te(e[o],t,[o].concat(i));return}n=e[o],i=[o].concat(i)}let l=t[0];typeof l=="function"&&(l=l(n,i),l===n)||o===void 0&&l==null||(l=Fe(l),o===void 0||Je(n)&&Je(l)&&!Array.isArray(l)?Dt(n,l):Ye(e,o,l))}function un(...[e,t]){const i=Fe(e||{}),o=Array.isArray(i),n=At(i);function l(...r){Vt(()=>{o&&r.length===1?dn(i,r[0]):Te(i,r)})}return[n,l]}function fn(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function vt(e,t=!1){const i=fn(),o=`_${i}`;return Object.defineProperty(window,o,{value:n=>(t&&Reflect.deleteProperty(window,o),e==null?void 0:e(n)),writable:!1,configurable:!0}),i}async function te(e,t={}){return new Promise((i,o)=>{const n=vt(r=>{i(r),Reflect.deleteProperty(window,`_${l}`)},!0),l=vt(r=>{o(r),Reflect.deleteProperty(window,`_${n}`)},!0);window.__TAURI_IPC__({cmd:e,callback:n,error:l,...t})})}const Lt=qt(),hn=e=>{const[t,i]=un({elements:[],selected_ids:[],canvas_config:{width:595,height:842,zoom:1,offset_x:0,offset_y:0,show_grid:!0,show_rulers:!0,grid_size:10,snap_to_grid:!0,background_color:"#ffffff"},can_undo:!1,can_redo:!1,dirty:!1}),[o,n]=Q(!1),[l,r]=Q(null),[s,c]=Q(!1),a=async()=>{try{n(!0),console.log("🔄 Loading app state...");const b=await te("get_app_state");console.log("🔄 App state loaded, selected_ids:",b.selected_ids),i(b)}catch(b){console.error("Failed to load app state:",b)}finally{n(!1)}};tt(()=>{a()});const E={state:t,createElement:async(b,m,$,L={})=>{try{n(!0);const p=await te("create_element",{request:{element_type:b,position:m,size:$,content_data:L}});return await a(),p}catch(p){throw console.error("Failed to create element:",p),p}finally{n(!1)}},updateElement:async(b,m)=>{try{n(!0),await te("update_element",{request:{id:b,updates:m}}),await a()}catch($){throw console.error("Failed to update element:",$),$}finally{n(!1)}},batchUpdatePositions:async b=>{try{n(!0),await te("batch_update_positions",{request:{updates:b}}),i(m=>{const $=m.elements.map(L=>{const p=b.find(F=>F.element_id===L.id);return p?{...L,position:p.new_position}:L});return{...m,elements:$,dirty:!0}}),console.log("🚀 Optimized batch position update completed without full reload")}catch(m){throw console.error("Failed to batch update positions:",m),await a(),m}finally{n(!1)}},deleteElement:async b=>{try{n(!0),await te("delete_element",{elementId:b}),await a()}catch(m){throw console.error("Failed to delete element:",m),m}finally{n(!1)}},selectElement:async b=>{try{console.log("Selecting element:",b),await te("select_element",{elementId:b}),console.log("Select command completed, reloading state..."),await a(),console.log("State reloaded, selected_ids:",t.selected_ids)}catch(m){throw console.error("Failed to select element:",m),m}},selectMultiple:async b=>{try{console.log("Selecting multiple elements:",b),b.length>0?(await te("select_multiple",{elementIds:b}),console.log("✅ Multi-select completed for:",b.length,"elements")):await te("clear_selection"),await a()}catch(m){throw console.error("Failed to select multiple elements:",m),m}},addToSelection:async b=>{try{console.log("Adding to selection:",b),await te("add_to_selection",{elementId:b}),await a()}catch(m){throw console.error("Failed to add to selection:",m),m}},removeFromSelection:async b=>{try{console.log("Removing from selection:",b),await te("remove_from_selection",{elementId:b}),await a()}catch(m){throw console.error("Failed to remove from selection:",m),m}},toggleSelection:async b=>{try{console.log("Toggling selection:",b),await te("toggle_selection",{elementId:b}),await a()}catch(m){throw console.error("Failed to toggle selection:",m),m}},clearSelection:async()=>{try{await te("clear_selection"),await a()}catch(b){throw console.error("Failed to clear selection:",b),b}},copySelected:async()=>{try{await te("copy_selected")}catch(b){throw console.error("Failed to copy selected elements:",b),b}},pasteElements:async(b,m)=>{try{n(!0);const $=await te("paste_elements",{offsetX:b,offsetY:m});return await a(),$}catch($){throw console.error("Failed to paste elements:",$),$}finally{n(!1)}},undo:async()=>{try{n(!0),await te("undo"),await a()}catch(b){throw console.error("Failed to undo:",b),b}finally{n(!1)}},redo:async()=>{try{n(!0),await te("redo"),await a()}catch(b){throw console.error("Failed to redo:",b),b}finally{n(!1)}},updateCanvasConfig:async b=>{try{n(!0),await te("update_canvas_config",{request:b}),await a()}catch(m){throw console.error("Failed to update canvas config:",m),m}finally{n(!1)}},getElementsAtPoint:async(b,m)=>{try{return await te("get_elements_at_point",{x:b,y:m})}catch($){return console.error("Failed to get elements at point:",$),[]}},isLoading:o,setLoading:n,dragOperation:l,setDragOperation:r,resizeOperation:s,setResizeOperation:c};return y(Lt.Provider,{value:E,get children(){return e.children}})},Ce=()=>{const e=Kt(Lt);if(!e)throw new Error("useAppContext must be used within an AppProvider");return e};var gn=_("<span class=text-warning>●"),vn=_("<span class=ml-2> 个元素"),yn=_('<span class="ml-2 text-primary">已选择 <!> 个'),mn=_('<div class="h-12 bg-primary border-b border-default flex items-center justify-between px-4"><div class="flex items-center gap-2"><button class=toolbar-btn title="新建 (Ctrl+N)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>新建</span></button><button class=toolbar-btn title="打开 (Ctrl+O)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>打开</span></button><button class=toolbar-btn title="保存 (Ctrl+S)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg><span>保存</span></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn title=预览><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg><span>预览</span></button></div><div class="flex items-center gap-2"><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button><button><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class=toolbar-btn-icon title="缩小 (Ctrl+-)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button><select class=zoom-select><option value=25%>25%</option><option value=50%>50%</option><option value=75%>75%</option><option value=100%>100%</option><option value=125%>125%</option><option value=150%>150%</option><option value=200%>200%</option><option value=fit>适应窗口</option></select><button class=toolbar-btn-icon title="放大 (Ctrl++)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button title="显示网格 (Ctrl+G)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></button><button title="显示标尺 (Ctrl+R)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v14a2 2 0 01-2 2H7zM20 3v18l-4-4V7l4-4z"></path></svg></button><div class="w-px h-6 bg-border-default mx-2"></div><button class="toolbar-btn-icon bg-yellow-100 hover:bg-yellow-200 text-yellow-800"title="开启/关闭开发者工具 (F12)"><svg class="w-4 h-4"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><div class="flex items-center gap-2 text-secondary text-sm"><span>');const bn=()=>{const{state:e,undo:t,redo:i,updateCanvasConfig:o}=Ce(),[n,l]=Q(e.canvas_config.zoom*100),r=async C=>{const M=C/100;l(C);try{await o({zoom:M})}catch(T){console.error("Failed to update zoom:",T)}},s=()=>{const C=Math.min(n()+25,500);r(C)},c=()=>{const C=Math.max(n()-25,25);r(C)},a=async()=>{try{await o({show_grid:!e.canvas_config.show_grid})}catch(C){console.error("Failed to toggle grid:",C)}},v=async()=>{try{await o({show_rulers:!e.canvas_config.show_rulers})}catch(C){console.error("Failed to toggle rulers:",C)}},h=async()=>{try{await te("toggle_devtools"),console.log("🔧 DevTools toggled")}catch(C){console.error("Failed to toggle DevTools:",C)}};return(()=>{var C=mn(),M=C.firstChild,T=M.nextSibling,A=T.firstChild,q=A.nextSibling,z=q.nextSibling,P=z.nextSibling,D=P.nextSibling,B=D.nextSibling,G=B.nextSibling,ee=G.nextSibling,J=ee.nextSibling,O=J.nextSibling,W=O.nextSibling,E=T.nextSibling,b=E.firstChild;return st(A,"click",t),st(q,"click",i),P.$$click=c,D.addEventListener("change",m=>{const $=m.target.value;if($==="fit")console.log("Fit to window");else{const L=parseInt($.replace("%",""));r(L)}}),B.$$click=s,ee.$$click=a,J.$$click=v,W.$$click=h,u(E,y(Re,{get when(){return e.dirty},get children(){return gn()}}),b),u(b,()=>e.template_name||"未命名模板"),u(E,y(Re,{get when(){return e.elements.length>0},get children(){var m=vn(),$=m.firstChild;return u(m,()=>e.elements.length,$),m}}),null),u(E,y(Re,{get when(){return e.selected_ids.length>0},get children(){var m=yn(),$=m.firstChild,L=$.nextSibling;return L.nextSibling,u(m,()=>e.selected_ids.length,L),m}}),null),k(m=>{var $=`toolbar-btn-icon ${e.can_undo?"":"opacity-50 cursor-not-allowed"}`,L=!e.can_undo,p=`撤销${e.undo_description?` (${e.undo_description})`:""} (Ctrl+Z)`,F=`toolbar-btn-icon ${e.can_redo?"":"opacity-50 cursor-not-allowed"}`,N=!e.can_redo,j=`重做${e.redo_description?` (${e.redo_description})`:""} (Ctrl+Y)`,H=`toolbar-btn-icon ${e.canvas_config.show_grid?"active":""}`,V=`toolbar-btn-icon ${e.canvas_config.show_rulers?"active":""}`;return $!==m.e&&Pe(A,m.e=$),L!==m.t&&(A.disabled=m.t=L),p!==m.a&&x(A,"title",m.a=p),F!==m.o&&Pe(q,m.o=F),N!==m.i&&(q.disabled=m.i=N),j!==m.n&&x(q,"title",m.n=j),H!==m.s&&Pe(ee,m.s=H),V!==m.h&&Pe(J,m.h=V),m},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),k(()=>D.value=`${Math.round(n())}%`),C})()};Se(["click"]);var wn=_('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary mb-3">组件库</h2><input type=text placeholder=搜索组件... class=component-search></div><div class="flex-1 overflow-y-auto custom-scrollbar p-4"><div class=space-y-4><div><h3 class="text-sm font-medium text-secondary mb-2">基础组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">数据组件</h3><div class="grid grid-cols-2 gap-2"></div></div><div><h3 class="text-sm font-medium text-secondary mb-2">银行组件</h3><div class="grid grid-cols-2 gap-2">'),pn=_('<div class=component-item><div class=text-center><div class="text-lg mb-1"></div><div class="text-xs font-medium text-primary">');const xn=()=>{const{createElement:e}=Ce(),[t,i]=Q(""),o=[{id:"text",name:"文字",category:"basic",icon:"📝",description:"静态文字标签",default_size:{width:100,height:24},create_content:a=>({type:"Text",content:(a==null?void 0:a.text)||"文字内容",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left"}})},{id:"data_field",name:"数据字段",category:"data",icon:"🔗",description:"动态数据字段",default_size:{width:120,height:24},create_content:a=>({type:"DataField",expression:(a==null?void 0:a.expression)||"${fieldName}",format:a==null?void 0:a.format,style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left"}})},{id:"rectangle",name:"矩形",category:"basic",icon:"▭",description:"矩形框架",default_size:{width:100,height:60},create_content:a=>({type:"Rectangle",fill_color:(a==null?void 0:a.fill_color)||"transparent",border:{color:(a==null?void 0:a.border_color)||"#000000",width:(a==null?void 0:a.border_width)||1,style:"Solid"}})},{id:"line",name:"线条",category:"basic",icon:"━",description:"分隔线",default_size:{width:200,height:2},create_content:a=>({type:"Line",color:(a==null?void 0:a.color)||"#000000",width:(a==null?void 0:a.width)||1})},{id:"image",name:"图片",category:"basic",icon:"🖼️",description:"图片占位符",default_size:{width:100,height:80},create_content:a=>({type:"Image",src:(a==null?void 0:a.src)||"",alt:(a==null?void 0:a.alt)||"图片"})}],n=[{id:"bank_header",name:"银行抬头",category:"bank",icon:"🏦",description:"银行标题和Logo区域",default_size:{width:300,height:60},create_content:()=>({type:"Text",content:"中国工商银行电子回单",style:{font_family:"SimHei",font_size:18,font_weight:"bold",color:"#000000",align:"Center"}})},{id:"amount_field",name:"金额字段",category:"bank",icon:"💰",description:"格式化金额显示",default_size:{width:120,height:24},create_content:()=>({type:"DataField",expression:"${amount}",format:"currency",style:{font_family:"SimSun",font_size:14,font_weight:"bold",color:"#000000",align:"Right"}})},{id:"customer_info",name:"客户信息",category:"bank",icon:"👤",description:"客户姓名和账号",default_size:{width:150,height:24},create_content:()=>({type:"DataField",expression:"${customerName}",style:{font_family:"SimSun",font_size:12,font_weight:"normal",color:"#000000",align:"Left"}})}],l=[...o,...n],r=()=>{const a=t().toLowerCase();return a?l.filter(v=>v.name.toLowerCase().includes(a)||v.description.toLowerCase().includes(a)):l},s=(a,v)=>{if(console.log("Starting drag for component:",a.id),v.dataTransfer){v.dataTransfer.effectAllowed="copy",v.dataTransfer.setData("application/json",JSON.stringify({type:"component",component:a}));const h=document.createElement("div");h.innerHTML=`
        <div style="
          background: #f3f4f6; 
          border: 2px solid #3b82f6; 
          border-radius: 8px; 
          padding: 8px 12px; 
          font-size: 12px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ">
          ${a.icon} ${a.name}
        </div>
      `,h.style.position="absolute",h.style.top="-1000px",document.body.appendChild(h),v.dataTransfer.setDragImage(h,50,20),setTimeout(()=>{document.body.removeChild(h)},0)}},c=async a=>{try{const v=await e(a.id,{x:100,y:100},a.default_size,a.create_content());console.log("Created element:",v)}catch(v){console.error("Failed to create element:",v)}};return(()=>{var a=wn(),v=a.firstChild,h=v.firstChild,C=h.nextSibling,M=v.nextSibling,T=M.firstChild,A=T.firstChild,q=A.firstChild,z=q.nextSibling,P=A.nextSibling,D=P.firstChild,B=D.nextSibling,G=P.nextSibling,ee=G.firstChild,J=ee.nextSibling;return C.$$input=O=>i(O.target.value),u(z,y(_e,{get each(){return r().filter(O=>O.category==="basic")},children:O=>y(lt,{component:O,onDrag:W=>s(O,W),onClick:()=>c(O)})})),u(B,y(_e,{get each(){return r().filter(O=>O.category==="data")},children:O=>y(lt,{component:O,onDrag:W=>s(O,W),onClick:()=>c(O)})})),u(J,y(_e,{get each(){return r().filter(O=>O.category==="bank")},children:O=>y(lt,{component:O,onDrag:W=>s(O,W),onClick:()=>c(O)})})),k(()=>C.value=t()),a})()},lt=e=>(()=>{var t=pn(),i=t.firstChild,o=i.firstChild,n=o.nextSibling;return st(t,"click",e.onClick),t.addEventListener("dragstart",l=>e.onDrag(l)),x(t,"draggable",!0),u(o,()=>e.component.icon),u(n,()=>e.component.name),k(()=>x(t,"title",e.component.description)),t})();Se(["input","click"]);var _n=_('<div class="flex flex-col h-full"><div class="p-4 border-b border-default"><h2 class="text-lg font-semibold text-primary">属性面板</h2></div><div class="flex-1 overflow-y-auto custom-scrollbar">'),$n=_('<div class="p-4 text-center text-muted"><svg class="w-12 h-12 mx-auto mb-2 opacity-50"fill=none stroke=currentColor viewBox="0 0 24 24"><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg><p class=text-sm>选择元素以查看属性'),Sn=_("<span class=property-value>"),Cn=_('<span class="property-value text-xs text-muted">'),Xe=_("<div class=space-y-2>"),Ue=_("<input type=number class=property-input>"),kn=_('<div class="grid grid-cols-2 gap-2">'),yt=_("<input type=checkbox class=property-checkbox>"),En=_('<div class="p-4 space-y-4">'),zn=_("<div class=property-group><div class=property-group-title><span></span><span></span></div><div class=property-group-content>"),Pn=_("<div class=property-field><label class=property-label>"),An=_("<textarea class=property-textarea rows=2 placeholder=输入文本内容...>"),It=_('<select class=property-select><option value=SimSun>宋体</option><option value=SimHei>黑体</option><option value="Microsoft YaHei">微软雅黑</option><option value=KaiTi>楷体</option><option value=Arial>Arial</option><option value="Times New Roman">Times New Roman</option><option value=Helvetica>Helvetica'),Ut=_("<select class=property-select><option value=normal>正常</option><option value=bold>粗体</option><option value=lighter>细体</option><option value=100>100</option><option value=200>200</option><option value=300>300</option><option value=400>400</option><option value=500>500</option><option value=600>600</option><option value=700>700</option><option value=800>800</option><option value=900>900"),Tt=_('<div class=space-y-3><div class="grid grid-cols-2 gap-2"></div><div class="grid grid-cols-2 gap-2">'),Mn=_("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线"),Rt=_('<div class="flex gap-2 items-center"><input type=range class="property-slider flex-1"min=0 max=100 step=1><span class="property-value w-12 text-center">%'),Dn=_('<div class=space-y-3><div class=space-y-2><div class="grid grid-cols-2 gap-2">'),Ln=_("<select class=property-select><option value=Solid>实线</option><option value=Dashed>虚线</option><option value=Dotted>点线</option><option value=DashDot>点划线"),mt=_("<select class=property-select><option value=None>无</option><option value=Arrow>箭头</option><option value=Circle>圆点</option><option value=Square>方块"),In=_('<div class=space-y-3><div class="grid grid-cols-2 gap-2">'),Un=_("<input type=text class=property-input placeholder=https://example.com/image.jpg>"),Tn=_("<input type=text class=property-input placeholder=图片描述文字>"),Rn=_("<div class=property-image-preview><div class=property-image-placeholder><span>📷 无图片"),On=_("<div class=space-y-3>"),Fn=_("<img class=property-image>"),Nn=_("<input type=text class=property-input placeholder=${fieldName}>"),jn=_("<select class=property-select><option value=default>默认</option><option value=currency>货币</option><option value=date>日期</option><option value=datetime>日期时间</option><option value=number>数字"),Hn=_("<div class=space-y-4>"),Gn=_('<div class=flex><input type=number class="property-input flex-1">'),Bn=_("<span class=property-unit>"),Vn=_('<div class="flex gap-2"><div class=property-color-wrapper><input type=color class=property-color><div class=property-color-preview></div></div><input type=text class="property-input flex-1"placeholder=#000000>'),qn=_("<div class=property-alignment-group>"),Kn=_("<button>");const Wn=()=>{const{state:e,updateElement:t}=Ce(),i=le(()=>{const l=new Set(e.selected_ids);return e.elements.filter(r=>l.has(r.id))}),o=le(()=>i()[0]),n=async(l,r,s)=>{try{await t(l,{[r]:s})}catch(c){console.error("Failed to update element property:",c)}};return(()=>{var l=_n(),r=l.firstChild,s=r.nextSibling;return u(s,y(Re,{get when(){return o()},get fallback(){return $n()},get children(){return y(Zn,{get element(){return o()},onUpdate:n})}})),l})()},Zn=e=>{const t=(o,n)=>{const l={...e.element.position,[o]:n};e.onUpdate(e.element.id,"position",l)},i=(o,n)=>{const l={...e.element.size,[o]:Math.max(1,n)};e.onUpdate(e.element.id,"size",l)};return(()=>{var o=En();return u(o,y(ye,{title:"元素信息",icon:"ℹ️",get children(){var n=Xe();return u(n,y(R,{label:"类型",get children(){var l=Sn();return u(l,()=>e.element.content.type),l}}),null),u(n,y(R,{label:"ID",get children(){var l=Cn();return u(l,()=>e.element.id),l}}),null),n}}),null),u(o,y(ye,{title:"位置和大小",icon:"📐",get children(){var n=kn();return u(n,y(R,{label:"X",get children(){var l=Ue();return l.$$input=r=>t("x",parseFloat(r.target.value)||0),k(()=>l.value=e.element.position.x),l}}),null),u(n,y(R,{label:"Y",get children(){var l=Ue();return l.$$input=r=>t("y",parseFloat(r.target.value)||0),k(()=>l.value=e.element.position.y),l}}),null),u(n,y(R,{label:"宽度",get children(){var l=Ue();return l.$$input=r=>i("width",parseFloat(r.target.value)||1),k(()=>l.value=e.element.size.width),l}}),null),u(n,y(R,{label:"高度",get children(){var l=Ue();return l.$$input=r=>i("height",parseFloat(r.target.value)||1),k(()=>l.value=e.element.size.height),l}}),null),n}}),null),u(o,y(ye,{title:"状态",icon:"👁️",get children(){var n=Xe();return u(n,y(R,{label:"可见",get children(){var l=yt();return l.addEventListener("change",r=>e.onUpdate(e.element.id,"visible",r.target.checked)),k(()=>l.checked=e.element.visible),l}}),null),u(n,y(R,{label:"锁定",get children(){var l=yt();return l.addEventListener("change",r=>e.onUpdate(e.element.id,"locked",r.target.checked)),k(()=>l.checked=e.element.locked),l}}),null),u(n,y(R,{label:"层级",get children(){var l=Ue();return l.$$input=r=>e.onUpdate(e.element.id,"z_index",parseInt(r.target.value)||0),k(()=>l.value=e.element.z_index),l}}),null),n}}),null),u(o,y(tn,{get children(){return[y(Ie,{get when(){return e.element.content.type==="Text"&&e.element.content},children:n=>y(Jn,{get content(){return n()},onUpdate:l=>{console.log("Text content update:",l),e.onUpdate(e.element.id,"content",l)}})}),y(Ie,{get when(){return e.element.content.type==="Rectangle"&&e.element.content},children:n=>y(Qn,{get content(){return n()},onUpdate:l=>{console.log("Rectangle content update:",l),e.onUpdate(e.element.id,"content",l)}})}),y(Ie,{get when(){return e.element.content.type==="Line"&&e.element.content},children:n=>y(Yn,{get content(){return n()},onUpdate:l=>{console.log("Line content update:",l),e.onUpdate(e.element.id,"content",l)}})}),y(Ie,{get when(){return e.element.content.type==="Image"&&e.element.content},children:n=>y(Xn,{get content(){return n()},onUpdate:l=>{console.log("Image content update:",l),e.onUpdate(e.element.id,"content",l)}})}),y(Ie,{get when(){return e.element.content.type==="DataField"&&e.element.content},children:n=>y(el,{get content(){return n()},onUpdate:l=>{console.log("DataField content update:",l),e.onUpdate(e.element.id,"content",l)}})})]}}),null),o})()},ye=e=>(()=>{var t=zn(),i=t.firstChild,o=i.firstChild,n=o.nextSibling,l=i.nextSibling;return u(o,()=>e.icon),u(n,()=>e.title),u(l,()=>e.children),t})(),R=e=>(()=>{var t=Pn(),i=t.firstChild;return u(i,()=>e.label),u(t,()=>e.children,null),t})(),Jn=e=>y(ye,{title:"文字样式",icon:"🔤",get children(){var t=Tt(),i=t.firstChild,o=i.nextSibling;return u(t,y(R,{label:"内容",get children(){var n=An();return n.$$input=l=>e.onUpdate({content:l.target.value}),k(()=>n.value=e.content.content),n}}),i),u(i,y(R,{label:"字体",get children(){var n=It();return n.addEventListener("change",l=>e.onUpdate({style:{...e.content.style,font_family:l.target.value}})),k(()=>n.value=e.content.style.font_family),n}}),null),u(i,y(R,{label:"大小",get children(){return y(je,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:n=>e.onUpdate({style:{...e.content.style,font_size:n}})})}}),null),u(o,y(R,{label:"字重",get children(){var n=Ut();return n.addEventListener("change",l=>e.onUpdate({style:{...e.content.style,font_weight:l.target.value}})),k(()=>n.value=e.content.style.font_weight),n}}),null),u(o,y(R,{label:"对齐",get children(){return y(Ot,{get value(){return e.content.style.align},onUpdate:n=>e.onUpdate({style:{...e.content.style,align:n}})})}}),null),u(t,y(R,{label:"颜色",get children(){return y(He,{get value(){return e.content.style.color},onUpdate:n=>e.onUpdate({style:{...e.content.style,color:n}})})}}),null),t}}),Qn=e=>y(ye,{title:"矩形样式",icon:"▭",get children(){var t=Dn(),i=t.firstChild,o=i.firstChild;return u(t,y(R,{label:"填充颜色",get children(){return y(He,{get value(){return e.content.fill_color||"#ffffff"},onUpdate:n=>e.onUpdate({fill_color:n})})}}),i),u(i,y(R,{label:"边框",get children(){var n=Xe();return u(n,y(He,{get value(){var l;return((l=e.content.border)==null?void 0:l.color)||"#000000"},onUpdate:l=>e.onUpdate({border:{...e.content.border,color:l}})})),n}}),o),u(o,y(R,{label:"宽度",get children(){return y(je,{get value(){var n;return((n=e.content.border)==null?void 0:n.width)||1},min:0,max:20,step:.5,unit:"px",onUpdate:n=>e.onUpdate({border:{...e.content.border,width:n}})})}}),null),u(o,y(R,{label:"样式",get children(){var n=Mn();return n.addEventListener("change",l=>e.onUpdate({border:{...e.content.border,style:l.target.value}})),k(()=>{var l;return n.value=((l=e.content.border)==null?void 0:l.style)||"Solid"}),n}}),null),u(t,y(R,{label:"圆角半径",get children(){return y(je,{get value(){return e.content.corner_radius||0},min:0,max:50,step:1,unit:"px",onUpdate:n=>e.onUpdate({corner_radius:n})})}}),null),u(t,y(R,{label:"透明度",get children(){var n=Rt(),l=n.firstChild,r=l.nextSibling,s=r.firstChild;return l.$$input=c=>e.onUpdate({opacity:parseFloat(c.target.value)/100}),u(r,()=>Math.round((e.content.opacity||1)*100),s),k(()=>l.value=(e.content.opacity||1)*100),n}}),null),t}}),Yn=e=>y(ye,{title:"线条样式",icon:"━",get children(){var t=In(),i=t.firstChild;return u(t,y(R,{label:"颜色",get children(){return y(He,{get value(){return e.content.color},onUpdate:o=>e.onUpdate({color:o})})}}),i),u(t,y(R,{label:"宽度",get children(){return y(je,{get value(){return e.content.width},min:.5,max:20,step:.5,unit:"px",onUpdate:o=>e.onUpdate({width:o})})}}),i),u(t,y(R,{label:"样式",get children(){var o=Ln();return o.addEventListener("change",n=>e.onUpdate({line_style:n.target.value})),k(()=>o.value=e.content.line_style||"Solid"),o}}),i),u(i,y(R,{label:"起点",get children(){var o=mt();return o.addEventListener("change",n=>e.onUpdate({start_cap:n.target.value})),k(()=>o.value=e.content.start_cap||"None"),o}}),null),u(i,y(R,{label:"终点",get children(){var o=mt();return o.addEventListener("change",n=>e.onUpdate({end_cap:n.target.value})),k(()=>o.value=e.content.end_cap||"None"),o}}),null),u(t,y(R,{label:"透明度",get children(){var o=Rt(),n=o.firstChild,l=n.nextSibling,r=l.firstChild;return n.$$input=s=>e.onUpdate({opacity:parseFloat(s.target.value)/100}),u(l,()=>Math.round((e.content.opacity||1)*100),r),k(()=>n.value=(e.content.opacity||1)*100),o}}),null),t}}),Xn=e=>y(ye,{title:"图片属性",icon:"🖼️",get children(){var t=On();return u(t,y(R,{label:"图片地址",get children(){var i=Un();return i.$$input=o=>e.onUpdate({src:o.target.value}),k(()=>i.value=e.content.src),i}}),null),u(t,y(R,{label:"替代文本",get children(){var i=Tn();return i.$$input=o=>e.onUpdate({alt:o.target.value}),k(()=>i.value=e.content.alt||""),i}}),null),u(t,y(R,{label:"预览",get children(){var i=Rn(),o=i.firstChild;return u(i,(()=>{var n=fe(()=>!!e.content.src);return()=>n()?(()=>{var l=Fn();return l.addEventListener("load",r=>{const s=r.target,c=s.nextElementSibling;s&&(s.style.display="block"),c&&(c.style.display="none")}),l.addEventListener("error",r=>{const s=r.target,c=s.nextElementSibling;s&&(s.style.display="none"),c&&(c.style.display="flex")}),k(r=>{var s=e.content.src,c=e.content.alt||"图片预览";return s!==r.e&&x(l,"src",r.e=s),c!==r.t&&x(l,"alt",r.t=c),r},{e:void 0,t:void 0}),l})():null})(),o),k(n=>(n=e.content.src?"none":"flex")!=null?o.style.setProperty("display",n):o.style.removeProperty("display")),i}}),null),t}}),el=e=>(()=>{var t=Hn();return u(t,y(ye,{title:"数据字段",icon:"🔗",get children(){var i=Xe();return u(i,y(R,{label:"表达式",get children(){var o=Nn();return o.$$input=n=>e.onUpdate({expression:n.target.value}),k(()=>o.value=e.content.expression),o}}),null),u(i,y(R,{label:"格式",get children(){var o=jn();return o.addEventListener("change",n=>e.onUpdate({format:n.target.value==="default"?void 0:n.target.value})),k(()=>o.value=e.content.format||"default"),o}}),null),i}}),null),u(t,y(ye,{title:"字段样式",icon:"🎨",get children(){var i=Tt(),o=i.firstChild,n=o.nextSibling;return u(o,y(R,{label:"字体",get children(){var l=It();return l.addEventListener("change",r=>e.onUpdate({style:{...e.content.style,font_family:r.target.value}})),k(()=>l.value=e.content.style.font_family),l}}),null),u(o,y(R,{label:"大小",get children(){return y(je,{get value(){return e.content.style.font_size},min:6,max:72,step:1,unit:"px",onUpdate:l=>e.onUpdate({style:{...e.content.style,font_size:l}})})}}),null),u(n,y(R,{label:"字重",get children(){var l=Ut();return l.addEventListener("change",r=>e.onUpdate({style:{...e.content.style,font_weight:r.target.value}})),k(()=>l.value=e.content.style.font_weight),l}}),null),u(n,y(R,{label:"对齐",get children(){return y(Ot,{get value(){return e.content.style.align},onUpdate:l=>e.onUpdate({style:{...e.content.style,align:l}})})}}),null),u(i,y(R,{label:"颜色",get children(){return y(He,{get value(){return e.content.style.color},onUpdate:l=>e.onUpdate({style:{...e.content.style,color:l}})})}}),null),i}}),null),t})(),je=e=>(()=>{var t=Gn(),i=t.firstChild;return i.addEventListener("blur",o=>{const n=parseFloat(o.target.value)||e.value,l=Math.max(e.min||-1/0,Math.min(e.max||1/0,n));l!==n&&(o.target.value=l.toString(),e.onUpdate(l))}),i.$$input=o=>{const n=parseFloat(o.target.value);if(!isNaN(n)){const l=Math.max(e.min||-1/0,Math.min(e.max||1/0,n));e.onUpdate(l)}},u(t,(()=>{var o=fe(()=>!!e.unit);return()=>o()&&(()=>{var n=Bn();return u(n,()=>e.unit),n})()})(),null),k(o=>{var n=e.min,l=e.max,r=e.step||1;return n!==o.e&&x(i,"min",o.e=n),l!==o.t&&x(i,"max",o.t=l),r!==o.a&&x(i,"step",o.a=r),o},{e:void 0,t:void 0,a:void 0}),k(()=>i.value=e.value),t})(),He=e=>(()=>{var t=Vn(),i=t.firstChild,o=i.firstChild,n=o.nextSibling,l=i.nextSibling;return o.$$input=r=>e.onUpdate(r.target.value),l.$$input=r=>{const s=r.target.value;(/^#[0-9A-Fa-f]{6}$/.test(s)||/^#[0-9A-Fa-f]{3}$/.test(s))&&e.onUpdate(s)},k(r=>(r=e.value)!=null?n.style.setProperty("background-color",r):n.style.removeProperty("background-color")),k(()=>o.value=e.value),k(()=>l.value=e.value),t})(),Ot=e=>{const t=[{value:"Left",icon:"⬅️",label:"左对齐"},{value:"Center",icon:"↔️",label:"居中"},{value:"Right",icon:"➡️",label:"右对齐"}];return(()=>{var i=qn();return u(i,()=>t.map(o=>(()=>{var n=Kn();return n.$$click=()=>e.onUpdate(o.value),u(n,()=>o.icon),k(l=>{var r=`property-alignment-btn ${e.value===o.value?"active":""}`,s=o.label;return r!==l.e&&Pe(n,l.e=r),s!==l.t&&x(n,"title",l.t=s),l},{e:void 0,t:void 0}),n})())),i})()};Se(["input","click"]);var tl=_("<svg><defs><pattern id=canvas-grid patternUnits=userSpaceOnUse><line y1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></line><line x1=0 stroke=#cbd5e1 stroke-width=0.5 opacity=0.8></svg>",!1,!0,!1),nl=_("<svg><rect fill=url(#canvas-grid)></svg>",!1,!0,!1);const ll=e=>y(Re,{get when(){return e.config.show_grid},get children(){return[(()=>{var t=tl(),i=t.firstChild,o=i.firstChild,n=o.nextSibling;return k(l=>{var r=e.config.grid_size,s=e.config.grid_size,c=e.config.grid_size,a=e.config.grid_size,v=e.config.grid_size,h=e.config.grid_size,C=e.config.grid_size,M=e.config.grid_size;return r!==l.e&&x(i,"width",l.e=r),s!==l.t&&x(i,"height",l.t=s),c!==l.a&&x(o,"x1",l.a=c),a!==l.o&&x(o,"x2",l.o=a),v!==l.i&&x(o,"y2",l.i=v),h!==l.n&&x(n,"y1",l.n=h),C!==l.s&&x(n,"x2",l.s=C),M!==l.h&&x(n,"y2",l.h=M),l},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),t})(),(()=>{var t=nl();return k(i=>{var o=e.config.width,n=e.config.height;return o!==i.e&&x(t,"width",i.e=o),n!==i.t&&x(t,"height",i.t=n),i},{e:void 0,t:void 0}),t})()]}});var ol=_("<svg><g class=resize-handles></svg>",!1,!0,!1),il=_("<svg><g><circle r=6 fill=white stroke=#cccccc stroke-width=1 pointer-events=none></circle><rect class=resize-handle width=8 height=8 rx=1 fill=#007bff stroke=white stroke-width=1></svg>",!1,!0,!1);const rl=e=>{const{updateElement:t,setResizeOperation:i}=Ce(),[o,n]=Q(!1),[l,r]=Q(null),[s,c]=Q({x:0,y:0}),[a,v]=Q({width:0,height:0}),[h,C]=Q({x:0,y:0}),[M,T]=Q({width:0,height:0}),[A,q]=Q({x:0,y:0}),[z,P]=Q(!1),D=le(()=>{const{position:E,size:b}=e.element,$=8/2,L=E.x,p=E.y,F=E.x+b.width,N=E.y+b.height,j=E.x+b.width/2,H=E.y+b.height/2;return[{position:"nw",cursor:"nw-resize",x:L-$,y:p-$},{position:"ne",cursor:"ne-resize",x:F-$,y:p-$},{position:"sw",cursor:"sw-resize",x:L-$,y:N-$},{position:"se",cursor:"se-resize",x:F-$,y:N-$},{position:"n",cursor:"n-resize",x:j-$,y:p-$},{position:"s",cursor:"s-resize",x:j-$,y:N-$},{position:"w",cursor:"w-resize",x:L-$,y:H-$},{position:"e",cursor:"e-resize",x:F-$,y:H-$}]}),B=(E,b,m,$=!1,L=!1)=>{const p=a(),F=h();let N=p.width,j=p.height,H=F.x,V=F.y;switch(E){case"nw":N=p.width-b,j=p.height-m,H=F.x+b,V=F.y+m;break;case"ne":N=p.width+b,j=p.height-m,V=F.y+m;break;case"sw":N=p.width-b,j=p.height+m,H=F.x+b;break;case"se":N=p.width+b,j=p.height+m;break;case"n":j=p.height-m,V=F.y+m;break;case"s":j=p.height+m;break;case"w":N=p.width-b,H=F.x+b;break;case"e":N=p.width+b;break}if($&&(E==="nw"||E==="ne"||E==="sw"||E==="se")){const ne=p.width/p.height;N/j>ne?(N=j*ne,(E==="nw"||E==="sw")&&(H=F.x+(p.width-N))):(j=N/ne,(E==="nw"||E==="ne")&&(V=F.y+(p.height-j)))}if(L){const ne=F.x+p.width/2,ce=F.y+p.height/2;H=ne-N/2,V=ce-j/2}const I=20;return N=Math.max(I,N),j=Math.max(I,j),{size:{width:N,height:j},position:{x:H,y:V}}},G=E=>(E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation(),!1),ee=(E,b)=>{var m;i(!0),document.addEventListener("click",G,{capture:!0}),n(!0),r(E),c({x:b.clientX,y:b.clientY}),v({width:e.element.size.width,height:e.element.size.height}),C({x:e.element.position.x,y:e.element.position.y}),T(e.element.size),q(e.element.position),P(!1),document.addEventListener("mousemove",O),document.addEventListener("mouseup",W),document.body.style.cursor=((m=D().find($=>$.position===E))==null?void 0:m.cursor)||"default"};let J=0;const O=E=>{if(!o())return;const b=l();if(!b)return;const m=s(),$=E.clientX-m.x,L=E.clientY-m.y,p=B(b,$,L,E.shiftKey,E.altKey);T(p.size),q(p.position),P(Math.abs($)>2||Math.abs(L)>2);const F=Date.now();if(F-J>50)try{t(e.element.id,{size:p.size,position:p.position}),J=F}catch{}},W=()=>{if(!o()||!l())return;const b=()=>{document.removeEventListener("click",G,{capture:!0}),i(!1),n(!1),r(null),document.body.style.cursor="default",document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",W)};if(z()){const m=M(),$=A();t(e.element.id,{size:m,position:$}).catch(L=>{t(e.element.id,{size:a(),position:h()}).catch(p=>{})})}b()};return dt(()=>{i(!1),document.removeEventListener("click",G,{capture:!0}),document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",W),document.body.style.cursor="default"}),(()=>{var E=ol();return u(E,()=>D().map(b=>(()=>{var m=il(),$=m.firstChild,L=$.nextSibling;return L.addEventListener("mouseleave",p=>{o()||(document.body.style.cursor="default")}),L.addEventListener("mouseenter",p=>{o()||(document.body.style.cursor=b.cursor)}),L.$$mousedown=p=>{p.stopPropagation(),p.preventDefault(),ee(b.position,p)},L.style.setProperty("pointer-events","all"),k(p=>{var F=b.x+4,N=b.y+4,j=b.x,H=b.y,V=b.cursor;return F!==p.e&&x($,"cx",p.e=F),N!==p.t&&x($,"cy",p.t=N),j!==p.a&&x(L,"x",p.a=j),H!==p.o&&x(L,"y",p.o=H),V!==p.i&&((p.i=V)!=null?L.style.setProperty("cursor",V):L.style.removeProperty("cursor")),p},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),m})())),E})()};Se(["mousedown"]);var se=(e=>(e.IDLE="idle",e.SELECTING="selecting",e.DRAGGING="dragging",e))(se||{});const sl={dragThreshold:3,updateThrottle:50};var al=_("<div tabindex=0>"),cl=_("<div>"),dl=_("<div><div>🎯 统一交互层</div><div>模式: </div><div>选中: </div><div>悬停: "),ul=_("<div>拖拽: <!>个元素"),fl=_("<div>[<!>]");const hl=e=>{const{resizeOperation:t,setResizeOperation:i}=Ce(),o=sl;let n;const[l,r]=Q(se.IDLE),[s,c]=Q([]),[a,v]=Q(null),[h,C]=Q(null),[M,T]=Q(null),A=(d,...f)=>{console.log(`🎯 [InteractionLayer] ${d}`,...f)},q=d=>{if(!n)return{x:0,y:0};const f=n.getBoundingClientRect();return{x:d.clientX-f.left,y:d.clientY-f.top}},z=(d,f)=>d.x>=f.position.x&&d.x<=f.position.x+f.size.width&&d.y>=f.position.y&&d.y<=f.position.y+f.size.height,P=d=>{const f=e.getAllElements();for(let w=f.length-1;w>=0;w--){const g=f[w];if(g&&g.visible&&z(d,g))return g}return null},D=()=>{const d=[],f=s(),w=e.getAllElements();return f.forEach(g=>{const S=w.find(Ee=>Ee.id===g);if(!S||!S.visible)return;const K=8,U=K/2,oe=S.position.x,ie=S.position.y,Y=S.position.x+S.size.width,xe=S.position.y+S.size.height,he=S.position.x+S.size.width/2,Le=S.position.y+S.size.height/2;[{position:"nw",cursor:"nw-resize",x:oe-U,y:ie-U},{position:"ne",cursor:"ne-resize",x:Y-U,y:ie-U},{position:"sw",cursor:"sw-resize",x:oe-U,y:xe-U},{position:"se",cursor:"se-resize",x:Y-U,y:xe-U},{position:"n",cursor:"n-resize",x:he-U,y:ie-U},{position:"s",cursor:"s-resize",x:he-U,y:xe-U},{position:"w",cursor:"w-resize",x:oe-U,y:Le-U},{position:"e",cursor:"e-resize",x:Y-U,y:Le-U}].forEach(Ee=>{d.push({elementId:S.id,position:Ee.position,cursor:Ee.cursor,bounds:{x:Ee.x,y:Ee.y,width:K,height:K}})})}),d},B=d=>{const f=D();for(let w=f.length-1;w>=0;w--){const g=f[w];if(!g)continue;const S=g.bounds;if(d.x>=S.x&&d.x<=S.x+S.width&&d.y>=S.y&&d.y<=S.y+S.height)return g}return null},G=d=>e.getAllElements().filter(w=>{if(!w.visible)return!1;const g={x:w.position.x,y:w.position.y,width:w.size.width,height:w.size.height};return!(g.x>d.x+d.width||g.x+g.width<d.x||g.y>d.y+d.height||g.y+g.height<d.y)}),ee=d=>{const f=q(d),w=B(f);if(w){A("点击ResizeHandle",{elementId:w.elementId,position:w.position}),W(w,f);return}if(t()){A("调整大小操作进行中，跳过交互处理");return}const g=P(f);A("鼠标按下",{point:f,elementId:g==null?void 0:g.id,currentMode:l()}),g?$(g,f,d):L(f)},[J,O]=Q(null),W=(d,f,w)=>{const g=e.getAllElements().find(S=>S.id===d.elementId);g&&(A("开始resize操作",{elementId:d.elementId,position:d.position}),i(!0),O({elementId:d.elementId,handlePosition:d.position,startPoint:f,initialSize:{width:g.size.width,height:g.size.height},initialPosition:{x:g.position.x,y:g.position.y},cursor:d.cursor}),de(d.cursor),A("resize状态已设置",J()))},E=(d,f,w,g,S)=>{let K=g.width,U=g.height,oe=S.x,ie=S.y;switch(d){case"nw":K=g.width-f,U=g.height-w,oe=S.x+f,ie=S.y+w;break;case"ne":K=g.width+f,U=g.height-w,ie=S.y+w;break;case"sw":K=g.width-f,U=g.height+w,oe=S.x+f;break;case"se":K=g.width+f,U=g.height+w;break;case"n":U=g.height-w,ie=S.y+w;break;case"s":U=g.height+w;break;case"w":K=g.width-f,oe=S.x+f;break;case"e":K=g.width+f;break}const Y=10;return K=Math.max(Y,K),U=Math.max(Y,U),{size:{width:K,height:U},position:{x:oe,y:ie}}},b=d=>{const f=J();if(!f)return;const w=d.x-f.startPoint.x,g=d.y-f.startPoint.y,S=E(f.handlePosition,w,g,f.initialSize,f.initialPosition);V(()=>{e.onElementResize&&e.onElementResize(f.elementId,S.size,S.position)})},m=()=>{const d=J();d&&(A("完成resize操作",{elementId:d.elementId}),i(!1),O(null),de())},$=(d,f,w)=>{const g=s().includes(d.id);w.ctrlKey?p(d.id):w.shiftKey&&s().length>0?F(d.id):g?j(s(),f):N(d.id,f)},L=(d,f)=>{var w;A("开始框选",{point:d}),c([]),(w=e.onElementsSelect)==null||w.call(e,[]),r(se.SELECTING),T({startPoint:d,currentPoint:d,selectedIds:[]})},p=d=>{var g;const f=s(),w=f.includes(d)?f.filter(S=>S!==d):[...f,d];A("切换选择",{elementId:d,newSelection:w}),c(w),(g=e.onElementsSelect)==null||g.call(e,w)},F=d=>{var w;const f=s();if(!f.includes(d)){const g=[...f,d];A("添加到选择",{elementId:d,newSelection:g}),c(g),(w=e.onElementsSelect)==null||w.call(e,g)}},N=(d,f,w)=>{var g;A("选择并准备拖拽",{elementId:d,point:f}),c([d]),(g=e.onElementsSelect)==null||g.call(e,[d]),j([d],f)},j=(d,f,w)=>{A("准备拖拽操作",{elementIds:d,startPoint:f});const g=e.getAllElements(),S=new Map;d.forEach(K=>{const U=g.find(oe=>oe.id===K);U&&S.set(K,{x:U.position.x,y:U.position.y})}),C({elementIds:d,startPoint:f,startPositions:S,currentOffset:{x:0,y:0},isDragging:!1})};let H=0;const V=d=>{const f=Date.now();f-H>=o.updateThrottle&&(d(),H=f)},I=d=>{const f=q(d),w=l();if(J()){b(f);return}w===se.IDLE&&h()?ce(f):w===se.DRAGGING?ue(f):w===se.SELECTING?me(f):ne(f)},ne=d=>{const f=B(d);if(f){de(f.cursor),v(null);return}const w=P(d),g=(w==null?void 0:w.id)||null;g!==a()&&(v(g),de())},ce=d=>{const f=h();if(!f)return;const w=Math.sqrt(Math.pow(d.x-f.startPoint.x,2)+Math.pow(d.y-f.startPoint.y,2));w>o.dragThreshold&&(A("开始拖拽",{distance:w,threshold:o.dragThreshold}),r(se.DRAGGING),C({...f,isDragging:!0}),de("grabbing"))},ue=d=>{const f=h();if(!f)return;const w={x:d.x-f.startPoint.x,y:d.y-f.startPoint.y};C({...f,currentOffset:w}),V(()=>{f.elementIds.forEach(g=>{const S=f.startPositions.get(g);S&&e.onElementMove&&e.onElementMove(g,{x:S.x+w.x,y:S.y+w.y})})})},me=d=>{const f=M();if(!f)return;const w={...f,currentPoint:d};T(w);const g={x:Math.min(f.startPoint.x,d.x),y:Math.min(f.startPoint.y,d.y),width:Math.abs(d.x-f.startPoint.x),height:Math.abs(d.y-f.startPoint.y)},K=G(g).map(U=>U.id);T({...w,selectedIds:K}),c(K)},de=d=>{if(!n)return;if(d){n.style.cursor=d;return}const f=l(),w=a();f===se.DRAGGING?n.style.cursor="grabbing":f===se.SELECTING?n.style.cursor="crosshair":w&&s().includes(w)?n.style.cursor="grab":w?n.style.cursor="pointer":n.style.cursor="default"},be=()=>{const d=l();if(A("鼠标释放",{currentMode:d,hasResizeState:!!J()}),J()){m();return}d===se.DRAGGING?ke():d===se.SELECTING&&pe(),Ft()},ke=()=>{const d=h();if(!d||!d.isDragging&&d.currentOffset.x===0&&d.currentOffset.y===0){A("拖拽完成，无实际移动");return}d.elementIds.forEach(f=>{const w=d.startPositions.get(f);if(w&&e.onElementMove){const g={x:w.x+d.currentOffset.x,y:w.y+d.currentOffset.y};e.onElementMove(f,g),A("拖拽完成",{elementId:f,finalPosition:g})}})},pe=()=>{const d=M();d&&(A("框选完成",{selectedCount:d.selectedIds.length}),e.onElementsSelect&&e.onElementsSelect(d.selectedIds))},Ft=()=>{r(se.IDLE),C(null),T(null),de()},Nt=()=>{};tt(()=>{document.addEventListener("mousemove",I),document.addEventListener("mouseup",be),A("统一交互层已初始化")}),dt(()=>{document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",be),A("统一交互层已清理")});const De=()=>{const d=M();if(!d||l()!==se.SELECTING)return null;const{startPoint:f,currentPoint:w}=d;return{x:Math.min(f.x,w.x),y:Math.min(f.y,w.y),width:Math.abs(w.x-f.x),height:Math.abs(w.y-f.y)}};return(()=>{var d=al();d.$$click=Nt,d.$$mousedown=ee;var f=n;return typeof f=="function"?zt(f,d):n=d,d.style.setProperty("position","absolute"),d.style.setProperty("top","0"),d.style.setProperty("left","0"),d.style.setProperty("width","100%"),d.style.setProperty("height","100%"),d.style.setProperty("z-index","10"),d.style.setProperty("pointer-events","all"),d.style.setProperty("background","transparent"),d.style.setProperty("user-select","none"),u(d,(()=>{var w=fe(()=>!!De());return()=>w()&&(()=>{var g=cl();return g.style.setProperty("position","absolute"),g.style.setProperty("border","1px dashed #007acc"),g.style.setProperty("background","rgba(0, 122, 204, 0.1)"),g.style.setProperty("pointer-events","none"),k(S=>{var K=`${De().x}px`,U=`${De().y}px`,oe=`${De().width}px`,ie=`${De().height}px`;return K!==S.e&&((S.e=K)!=null?g.style.setProperty("left",K):g.style.removeProperty("left")),U!==S.t&&((S.t=U)!=null?g.style.setProperty("top",U):g.style.removeProperty("top")),oe!==S.a&&((S.a=oe)!=null?g.style.setProperty("width",oe):g.style.removeProperty("width")),ie!==S.o&&((S.o=ie)!=null?g.style.setProperty("height",ie):g.style.removeProperty("height")),S},{e:void 0,t:void 0,a:void 0,o:void 0}),g})()})(),null),u(d,(()=>{var w=fe(()=>!!e.enableDebugMode);return()=>w()&&(()=>{var g=dl(),S=g.firstChild,K=S.nextSibling;K.firstChild;var U=K.nextSibling;U.firstChild;var oe=U.nextSibling;return oe.firstChild,g.style.setProperty("position","fixed"),g.style.setProperty("top","10px"),g.style.setProperty("right","10px"),g.style.setProperty("padding","8px"),g.style.setProperty("background","rgba(0, 0, 0, 0.8)"),g.style.setProperty("color","white"),g.style.setProperty("font-family","monospace"),g.style.setProperty("font-size","12px"),g.style.setProperty("border-radius","4px"),g.style.setProperty("z-index","9999"),g.style.setProperty("pointer-events","none"),u(K,l,null),u(U,()=>s().length,null),u(oe,()=>a()||"无",null),u(g,(()=>{var ie=fe(()=>{var Y;return!!((Y=h())!=null&&Y.isDragging)});return()=>ie()&&(()=>{var Y=ul(),xe=Y.firstChild,he=xe.nextSibling;return he.nextSibling,Y.style.setProperty("color","#ffeb3b"),u(Y,()=>{var Le;return(Le=h())==null?void 0:Le.elementIds.length},he),Y})()})(),null),u(g,(()=>{var ie=fe(()=>s().length>0);return()=>ie()&&(()=>{var Y=fl(),xe=Y.firstChild,he=xe.nextSibling;return he.nextSibling,Y.style.setProperty("font-size","10px"),Y.style.setProperty("color","#ccc"),u(Y,()=>s().slice(0,3).join(", "),he),u(Y,()=>s().length>3&&"...",he),Y})()})(),null),g})()})(),null),d})()};Se(["mousedown","click"]);var gl=_('<div class="flex-1 flex flex-col overflow-hidden"><div class="h-12 bg-primary border-b border-default flex items-center px-4"><div class="text-sm text-secondary">Canvas: <!> × <!>px<span class="ml-4 px-2 py-1 bg-blue-100 rounded text-xs">元素: <!> | 选中: </span></div></div><div class="flex-1 overflow-auto custom-scrollbar bg-tertiary p-4"><div class="flex items-center justify-center min-h-full"><div class="bg-canvas-bg shadow-lg rounded-lg overflow-hidden"><svg class=block><rect></rect><rect fill=none stroke=var(--color-border) stroke-width=1></rect><g class=elements-layer></g><g class=resize-handles-layer>'),vl=_("<span class=ml-2>Zoom: <!>%"),bt=_("<svg><text dominant-baseline=hanging></svg>",!1,!0,!1),yl=_("<svg><tspan></svg>",!1,!0,!1),ml=_("<svg><rect x=0 y=0></svg>",!1,!0,!1),bl=_("<svg><line x1=0></svg>",!1,!0,!1),wl=_('<svg><rect x=0 y=0 fill="rgba(59, 130, 246, 0.1)"stroke="rgba(59, 130, 246, 0.3)"stroke-width=1 stroke-dasharray=2,2></svg>',!1,!0,!1),pl=_("<svg><rect x=0 y=0 fill=#f0f0f0 stroke=#ccc stroke-width=1 stroke-dasharray=5,5></svg>",!1,!0,!1),xl=_("<svg><g></svg>",!1,!0,!1);const _l=()=>{const{state:e,selectElement:t,clearSelection:i,createElement:o,selectMultiple:n,updateElement:l}=Ce();let r;const[s,c]=Q([]),a=le(()=>e.elements.filter(z=>z.visible)),v=(z,P)=>{if(!r)return{x:0,y:0};const D=r.getBoundingClientRect(),B=(z-D.left)/e.canvas_config.zoom,G=(P-D.top)/e.canvas_config.zoom;return{x:B,y:G}},h=async z=>{console.log("🎯 选择元素",z),c([...z]);try{z.length===0?await i():z.length===1?await t(z[0]):await n([...z])}catch(P){console.error("❌ 选择元素失败:",P)}},C=async(z,P)=>{console.log("🚚 移动元素",z,P);try{await l(z,{position:{x:P.x,y:P.y}})}catch(D){console.error("❌ 移动元素失败:",D)}},M=async(z,P,D)=>{console.log("📏 调整元素大小",z,P,D);try{await l(z,{size:P,position:D})}catch(B){console.error("❌ 调整大小失败:",B)}},T=async z=>{console.log("🖱️ 画布点击",z)},A=async z=>{var P;z.preventDefault();try{const D=(P=z.dataTransfer)==null?void 0:P.getData("application/json");if(!D)return;const{type:B,component:G}=JSON.parse(D);if(B==="component"){const{x:ee,y:J}=v(z.clientX,z.clientY),O=Math.max(0,ee-G.default_size.width/2),W=Math.max(0,J-G.default_size.height/2);console.log("🎯 通过拖放创建组件:",G.name,"at",O,W);const E=await o(G.id,{x:O,y:W},G.default_size,G.create_content());console.log("✅ 通过拖放创建元素成功:",E),c([E]),await t(E)}}catch(D){console.error("拖放处理失败:",D)}};tt(()=>{c([...e.selected_ids])}),le(()=>{c([...e.selected_ids])});const q=le(()=>{const{width:z,height:P}=e.canvas_config;return`0 0 ${z} ${P}`});return(()=>{var z=gl(),P=z.firstChild,D=P.firstChild,B=D.firstChild,G=B.nextSibling,ee=G.nextSibling,J=ee.nextSibling,O=J.nextSibling,W=O.nextSibling,E=W.firstChild,b=E.nextSibling;b.nextSibling;var m=P.nextSibling,$=m.firstChild,L=$.firstChild,p=L.firstChild,F=p.firstChild,N=F.nextSibling,j=N.nextSibling,H=j.nextSibling;u(D,()=>e.canvas_config.width,G),u(D,()=>e.canvas_config.height,J),u(D,(()=>{var I=fe(()=>e.canvas_config.zoom!==1);return()=>I()&&(()=>{var ne=vl(),ce=ne.firstChild,ue=ce.nextSibling;return ue.nextSibling,u(ne,()=>Math.round(e.canvas_config.zoom*100),ue),ne})()})(),W),u(W,()=>e.elements.length,b),u(W,()=>s().length,null),L.style.setProperty("position","relative"),p.addEventListener("drop",A),p.addEventListener("dragover",I=>{I.preventDefault(),I.dataTransfer.dropEffect="copy"}),p.$$contextmenu=I=>I.preventDefault();var V=r;return typeof V=="function"?zt(V,p):r=p,u(p,y(ll,{get config(){return e.canvas_config}}),N),u(j,y(_e,{get each(){return a()},children:I=>y($l,{element:I,get selected(){return s().includes(I.id)}})})),u(H,y(_e,{get each(){return a().filter(I=>s().includes(I.id))},children:I=>y(rl,{element:I})})),u(L,y(hl,{canvasRef:r,getAllElements:()=>[...e.elements],onElementsSelect:h,onElementMove:C,onElementResize:M,onCanvasClick:T,get enableDebugMode(){return!1}}),null),k(I=>{var ne=e.canvas_config.width*e.canvas_config.zoom,ce=e.canvas_config.height*e.canvas_config.zoom,ue=q(),me=e.canvas_config.width,de=e.canvas_config.height,be=e.canvas_config.background_color,ke=e.canvas_config.width,pe=e.canvas_config.height;return ne!==I.e&&x(p,"width",I.e=ne),ce!==I.t&&x(p,"height",I.t=ce),ue!==I.a&&x(p,"viewBox",I.a=ue),me!==I.o&&x(F,"width",I.o=me),de!==I.i&&x(F,"height",I.i=de),be!==I.n&&x(F,"fill",I.n=be),ke!==I.s&&x(N,"width",I.s=ke),pe!==I.h&&x(N,"height",I.h=pe),I},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),z})()},$l=e=>{const t=le(()=>{const{position:o}=e.element;return{transform:`translate(${o.x}px, ${o.y}px)`,opacity:e.element.visible?1:.5}}),i=()=>{const{content:o,size:n}=e.element;if(o.type==="Text"&&o.content&&o.style){const l=o.style.align,r=l==="Center"?"middle":l==="Right"?"end":"start",s=l==="Center"?n.width/2:l==="Right"?n.width:0;return(()=>{var c=bt();return x(c,"x",s),x(c,"text-anchor",r),u(c,()=>o.content.split(`
`).map((a,v)=>(()=>{var h=yl();return x(h,"x",s),u(h,a),k(()=>x(h,"dy",v===0?0:o.style.font_size*1.2)),h})())),k(a=>{var v=o.style.font_size*.75,h=o.style.font_family,C=`${o.style.font_size}`,M=o.style.font_weight,T=o.style.color;return v!==a.e&&x(c,"y",a.e=v),h!==a.t&&x(c,"font-family",a.t=h),C!==a.a&&x(c,"font-size",a.a=C),M!==a.o&&x(c,"font-weight",a.o=M),T!==a.i&&x(c,"fill",a.i=T),a},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),c})()}if(o.type==="Rectangle"){const l=o.opacity!==void 0?o.opacity:1,r=o.corner_radius||0;return(()=>{var s=ml();return x(s,"rx",r),x(s,"ry",r),x(s,"fill-opacity",l),x(s,"stroke-opacity",l),k(c=>{var A,q,z,P;var a=n.width,v=n.height,h=o.fill_color||"transparent",C=((A=o.border)==null?void 0:A.color)||"#000000",M=((q=o.border)==null?void 0:q.width)||1,T=((z=o.border)==null?void 0:z.style)==="Dashed"?"5,5":((P=o.border)==null?void 0:P.style)==="Dotted"?"2,2":"none";return a!==c.e&&x(s,"width",c.e=a),v!==c.t&&x(s,"height",c.t=v),h!==c.a&&x(s,"fill",c.a=h),C!==c.o&&x(s,"stroke",c.o=C),M!==c.i&&x(s,"stroke-width",c.i=M),T!==c.n&&x(s,"stroke-dasharray",c.n=T),c},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),s})()}if(o.type==="Line"){const l=o.opacity!==void 0?o.opacity:1,r=o.line_style||"Solid",s=r==="Dashed"?"8,4":r==="Dotted"?"2,2":r==="DashDot"?"8,4,2,4":"none";return(()=>{var c=bl();return x(c,"stroke-opacity",l),x(c,"stroke-dasharray",s),k(a=>{var v=n.height/2,h=n.width,C=n.height/2,M=o.color,T=o.width;return v!==a.e&&x(c,"y1",a.e=v),h!==a.t&&x(c,"x2",a.t=h),C!==a.a&&x(c,"y2",a.a=C),M!==a.o&&x(c,"stroke",a.o=M),T!==a.i&&x(c,"stroke-width",a.i=T),a},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),c})()}return o.type==="DataField"&&o.style?[(()=>{var l=wl();return k(r=>{var s=n.width,c=n.height;return s!==r.e&&x(l,"width",r.e=s),c!==r.t&&x(l,"height",r.t=c),r},{e:void 0,t:void 0}),l})(),(()=>{var l=bt();return u(l,()=>o.expression||"[数据字段]"),k(r=>{var s=o.style.align==="Center"?n.width/2:o.style.align==="Right"?n.width-4:4,c=o.style.font_size*.8,a=o.style.font_family,v=`${o.style.font_size}`,h=o.style.font_weight,C=o.style.color,M=o.style.align==="Center"?"middle":o.style.align==="Right"?"end":"start";return s!==r.e&&x(l,"x",r.e=s),c!==r.t&&x(l,"y",r.t=c),a!==r.a&&x(l,"font-family",r.a=a),v!==r.o&&x(l,"font-size",r.o=v),h!==r.i&&x(l,"font-weight",r.i=h),C!==r.n&&x(l,"fill",r.n=C),M!==r.s&&x(l,"text-anchor",r.s=M),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),l})()]:(()=>{var l=pl();return k(r=>{var s=n.width,c=n.height;return s!==r.e&&x(l,"width",r.e=s),c!==r.t&&x(l,"height",r.t=c),r},{e:void 0,t:void 0}),l})()};return(()=>{var o=xl();return u(o,i),k(n=>{var l=`element ${e.selected?"element-selected":""}`,r=t(),s=e.element.id,c=e.element.content.type;return l!==n.e&&x(o,"class",n.e=l),n.t=on(o,r,n.t),s!==n.a&&x(o,"data-element-id",n.a=s),c!==n.o&&x(o,"data-element-type",n.o=c),n},{e:void 0,t:void 0,a:void 0,o:void 0}),o})()};Se(["contextmenu"]);var Sl=_('<button class="fixed top-20 right-4 z-50 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg shadow-lg text-sm font-medium"title=开启/关闭测试面板>🧪 测试'),Cl=_('<div class="fixed top-16 right-4 z-40 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-80 max-h-96 overflow-y-auto"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-800">🧪 测试面板</h3><button class="text-gray-500 hover:text-gray-700">✕</button></div><div class="mb-4 p-3 bg-gray-50 rounded-lg"><div class="text-sm text-gray-600"><div>元素总数: <span class=font-medium></span></div><div>已选择: <span class=font-medium></span></div><div>可撤销: <span class=font-medium></span></div><div>可重做: <span class=font-medium></span></div></div></div><div class="space-y-2 mb-4"><button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded text-sm">🚀 运行所有测试</button><button class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded text-sm">🧹 清理元素</button></div><div class=space-y-2><h4 class="text-sm font-medium text-gray-700 mb-2">单独测试:</h4></div><div class=mt-4><h4 class="text-sm font-medium text-gray-700 mb-2">当前元素:</h4><div class="max-h-32 overflow-y-auto">'),kl=_('<button class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded text-sm text-left">'),El=_('<div><div class=font-medium></div><div class="text-gray-500 truncate">ID: <!>...</div><div class=text-gray-500>位置: (<!>, <!>)'),zl=_('<div class="text-xs text-gray-500 p-2">暂无元素');const Pl=()=>{const{state:e,createElement:t,selectElement:i,clearSelection:o}=Ce(),[n,l]=Q(!1),r=[{name:"创建文字元素",action:async()=>{const v=await t("text",{x:100,y:100},{width:100,height:24},{type:"Text",content:"测试文字",style:{font_family:"SimSun",font_size:14,font_weight:"normal",color:"#000000",align:"Left"}});return console.log("✅ 测试文字元素创建成功:",v),v}},{name:"创建矩形元素",action:async()=>{const v=await t("rectangle",{x:250,y:100},{width:100,height:60},{type:"Rectangle",fill_color:"rgba(59, 130, 246, 0.2)",border:{color:"#3b82f6",width:2,style:"Solid"}});return console.log("✅ 测试矩形元素创建成功:",v),v}},{name:"创建线条元素",action:async()=>{const v=await t("line",{x:400,y:130},{width:150,height:2},{type:"Line",color:"#ef4444",width:3});return console.log("✅ 测试线条元素创建成功:",v),v}},{name:"创建数据字段",action:async()=>{const v=await t("data_field",{x:100,y:200},{width:120,height:24},{type:"DataField",expression:"${测试数据}",format:void 0,style:{font_family:"SimSun",font_size:12,font_weight:"bold",color:"#059669",align:"Left"}});return console.log("✅ 测试数据字段创建成功:",v),v}}],s=async v=>{try{console.log(`🧪 开始测试: ${v.name}`);const h=await v.action();await i(h),console.log(`✅ 测试完成: ${v.name}, 元素ID: ${h}`)}catch(h){console.error(`❌ 测试失败: ${v.name}`,h)}},c=async()=>{console.log("🚀 开始运行所有测试案例..."),await o();for(const v of r)await s(v),await new Promise(h=>setTimeout(h,500));console.log("🎉 所有测试案例运行完成!")},a=async()=>{try{console.log("🧹 清理所有测试元素..."),await o(),console.log("✅ 清理完成")}catch(v){console.error("❌ 清理失败:",v)}};return[(()=>{var v=Sl();return v.$$click=()=>l(!n()),v})(),fe(()=>fe(()=>!!n())()&&(()=>{var v=Cl(),h=v.firstChild,C=h.firstChild,M=C.nextSibling,T=h.nextSibling,A=T.firstChild,q=A.firstChild,z=q.firstChild,P=z.nextSibling,D=q.nextSibling,B=D.firstChild,G=B.nextSibling,ee=D.nextSibling,J=ee.firstChild,O=J.nextSibling,W=ee.nextSibling,E=W.firstChild,b=E.nextSibling,m=T.nextSibling,$=m.firstChild,L=$.nextSibling,p=m.nextSibling;p.firstChild;var F=p.nextSibling,N=F.firstChild,j=N.nextSibling;return M.$$click=()=>l(!1),u(P,()=>e.elements.length),u(G,()=>e.selected_ids.length),u(O,()=>e.can_undo?"是":"否"),u(b,()=>e.can_redo?"是":"否"),$.$$click=c,L.$$click=a,u(p,y(_e,{each:r,children:H=>(()=>{var V=kl();return V.$$click=()=>s(H),u(V,()=>H.name),V})()}),null),u(j,y(_e,{get each(){return e.elements},children:H=>(()=>{var V=El(),I=V.firstChild,ne=I.nextSibling,ce=ne.firstChild,ue=ce.nextSibling;ue.nextSibling;var me=ne.nextSibling,de=me.firstChild,be=de.nextSibling,ke=be.nextSibling,pe=ke.nextSibling;return pe.nextSibling,V.$$click=()=>i(H.id),u(I,()=>H.content.type),u(ne,()=>H.id.slice(0,8),ue),u(me,()=>Math.round(H.position.x),be),u(me,()=>Math.round(H.position.y),pe),k(()=>Pe(V,`text-xs p-2 mb-1 rounded cursor-pointer ${e.selected_ids.includes(H.id)?"bg-blue-100 border border-blue-300":"bg-gray-50 hover:bg-gray-100"}`)),V})()}),null),u(j,(()=>{var H=fe(()=>e.elements.length===0);return()=>H()&&zl()})(),null),v})())]};Se(["click"]);var Al=_('<div class="h-full flex flex-col bg-secondary"><div class="flex-1 flex overflow-hidden"><div class="w-80 bg-primary border-r border-default flex flex-col"></div><div class="flex-1 flex flex-col bg-tertiary"></div><div class="w-80 bg-primary border-l border-default flex flex-col">');const Ml=()=>(()=>{var e=Al(),t=e.firstChild,i=t.firstChild,o=i.nextSibling,n=o.nextSibling;return u(e,y(bn,{}),t),u(i,y(xn,{})),u(o,y(_l,{})),u(n,y(Wn,{})),u(e,y(Pl,{}),null),e})(),Dl=()=>(tt(()=>{document.addEventListener("contextmenu",e=>e.preventDefault())}),y(hn,{get children(){return y(Ml,{})}})),Ll=document.getElementById("root");ln(()=>y(Dl,{}),Ll);
