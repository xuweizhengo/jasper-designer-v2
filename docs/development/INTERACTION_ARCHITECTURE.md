# ğŸ—ï¸ äº¤äº’ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ¯ è®¾è®¡ç›®æ ‡

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜
1. **é¼ æ ‡å…‰æ ‡å†²çª** - ResizeHandleså’ŒElementRendereräº‰å¤ºå…‰æ ‡æ§åˆ¶
2. **äº‹ä»¶ç³»ç»Ÿæ··ä¹±** - å¤šä¸ªç»„ä»¶ç‹¬ç«‹å¤„ç†é¼ æ ‡äº‹ä»¶
3. **çŠ¶æ€ç®¡ç†åˆ†æ•£** - äº¤äº’çŠ¶æ€æ•£å¸ƒåœ¨ä¸åŒç»„ä»¶ä¸­
4. **ç”¨æˆ·ä½“éªŒé—®é¢˜** - å…‰æ ‡é—ªçƒã€æ“ä½œä¸ä¸€è‡´

### è®¾è®¡åŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ç‰¹å®šåŠŸèƒ½
- **ä¼˜å…ˆçº§é©±åŠ¨**: åŸºäºä¼˜å…ˆçº§çš„å†²çªè§£å†³æœºåˆ¶
- **çŠ¶æ€é›†ä¸­**: ç»Ÿä¸€çš„äº¤äº’çŠ¶æ€ç®¡ç†
- **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„ç³»ç»Ÿåˆ†å±‚

## ğŸ¢ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº¤äº’ç³»ç»Ÿæ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¨ å±•ç¤ºå±‚ (Presentation Layer)                             â”‚
â”‚  â”œâ”€ InteractionLayer.tsx        (äº‹ä»¶æ•è·å’Œåˆ†å‘)             â”‚
â”‚  â”œâ”€ SelectionIndicator.tsx      (é€‰æ‹©å¯è§†åŒ–)               â”‚
â”‚  â”œâ”€ BoxSelectionIndicator.tsx   (æ¡†é€‰æŒ‡ç¤ºå™¨)               â”‚
â”‚  â””â”€ DebugOverlay.tsx           (è°ƒè¯•ç•Œé¢)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ§  ç®¡ç†å±‚ (Management Layer)                              â”‚
â”‚  â”œâ”€ InteractionManager.tsx      (æ ¸å¿ƒäº¤äº’ç®¡ç†)             â”‚
â”‚  â”œâ”€ SelectionManager.tsx        (é€‰æ‹©çŠ¶æ€ç®¡ç†)             â”‚
â”‚  â””â”€ CursorManager.tsx          (å…‰æ ‡ä¼˜å…ˆçº§ç®¡ç†)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”§ å¼•æ“å±‚ (Engine Layer)                                  â”‚
â”‚  â””â”€ HitTestEngine.tsx          (ç¢°æ’æ£€æµ‹å¼•æ“)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ› ï¸ å·¥å…·å±‚ (Utility Layer)                                â”‚
â”‚  â”œâ”€ GeometryUtils.ts           (å‡ ä½•è®¡ç®—)                  â”‚
â”‚  â”œâ”€ BoundsCalculator.ts        (è¾¹ç•Œè®¡ç®—)                  â”‚
â”‚  â””â”€ HitTestUtils.ts           (ç¢°æ’æ£€æµ‹å·¥å…·)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‹ ç±»å‹å±‚ (Type Layer)                                    â”‚
â”‚  â”œâ”€ geometry-types.ts          (å‡ ä½•ç±»å‹å®šä¹‰)              â”‚
â”‚  â”œâ”€ interaction-types.ts       (äº¤äº’ç±»å‹å®šä¹‰)              â”‚
â”‚  â””â”€ state-types.ts            (çŠ¶æ€ç±»å‹å®šä¹‰)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›ï¸ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. InteractionManager - äº¤äº’ç®¡ç†å™¨

**èŒè´£**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰äº¤äº’çŠ¶æ€å’Œæ“ä½œæ¨¡å¼

**æ ¸å¿ƒåŠŸèƒ½**:
- äº¤äº’æ¨¡å¼çŠ¶æ€æœº (IDLE â†’ SELECTED â†’ DRAGGING â†’ ...)
- é¼ æ ‡äº‹ä»¶ç»Ÿä¸€åˆ†å‘
- é”®ç›˜å¿«æ·é”®å¤„ç†
- æ“ä½œç”Ÿå‘½å‘¨æœŸç®¡ç†

**çŠ¶æ€è½¬æ¢å›¾**:
```
     IDLE â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
       â†“             â”‚
  HOVER_ELEMENT      â”‚
       â”‚             â”‚
       â†“             â”‚
   SELECTED â†â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚    â”‚           â”‚
    â†“    â†“           â”‚
DRAGGING RESIZING    â”‚
    â”‚    â”‚           â”‚
    â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   BOX_SELECTING
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
```

### 2. HitTestEngine - ç¢°æ’æ£€æµ‹å¼•æ“

**èŒè´£**: ä¼˜å…ˆçº§é©±åŠ¨çš„é¼ æ ‡ç¢°æ’æ£€æµ‹

**æ£€æµ‹ä¼˜å…ˆçº§**:
```
1. Resize Controls (ä¼˜å…ˆçº§ 1) â”€â”€ æœ€é«˜ä¼˜å…ˆçº§
   â””â”€ 8ä¸ªresizeæ§åˆ¶ç‚¹çš„hitAreaæ£€æµ‹

2. Drag Zones (ä¼˜å…ˆçº§ 2) â”€â”€â”€â”€ ä¸­ç­‰ä¼˜å…ˆçº§  
   â””â”€ å…ƒç´ å†…éƒ¨ä½†é¿å¼€resizeåŒºåŸŸ

3. Elements (ä¼˜å…ˆçº§ 3) â”€â”€â”€â”€â”€â”€ ä½ä¼˜å…ˆçº§
   â””â”€ å…ƒç´ è¾¹ç•Œæ£€æµ‹

4. Canvas Background (ä¼˜å…ˆçº§ 4) â”€â”€ é»˜è®¤
   â””â”€ èƒŒæ™¯åŒºåŸŸ
```

**æ€§èƒ½ä¼˜åŒ–**:
- 16msç¼“å­˜æœºåˆ¶é¿å…é‡å¤è®¡ç®—
- æ—©æœŸå‰ªæ - é«˜ä¼˜å…ˆçº§åŒ¹é…åç«‹å³è¿”å›
- ç©ºé—´ç´¢å¼• - å¿«é€Ÿæ’é™¤ä¸å¯èƒ½çš„å€™é€‰é¡¹

### 3. SelectionManager - é€‰æ‹©ç®¡ç†å™¨

**èŒè´£**: ç®¡ç†å…ƒç´ é€‰æ‹©çŠ¶æ€å’Œå¤šé€‰é€»è¾‘

**é€‰æ‹©æ¨¡å¼**:
- **å•é€‰**: ç›´æ¥æ›¿æ¢å½“å‰é€‰æ‹©
- **å¤šé€‰**: Ctrl+ç‚¹å‡»æ·»åŠ /ç§»é™¤
- **èŒƒå›´é€‰æ‹©**: Shift+ç‚¹å‡»èŒƒå›´é€‰æ‹©
- **æ¡†é€‰**: æ‹–æ‹½é€‰æ‹©çŸ©å½¢å†…å…ƒç´ 

**çŠ¶æ€è¿½è¸ª**:
- `selectedIds` - é€‰ä¸­å…ƒç´ IDé›†åˆ
- `primaryId` - ä¸»é€‰æ‹©å…ƒç´ (æœ€åé€‰ä¸­çš„)
- `lastSelectedId` - ç”¨äºèŒƒå›´é€‰æ‹©çš„é”šç‚¹

### 4. CursorManager - å…‰æ ‡ç®¡ç†å™¨

**èŒè´£**: è§£å†³å…‰æ ‡å†²çªï¼Œæä¾›ä¼˜å…ˆçº§é©±åŠ¨çš„å…‰æ ‡ç®¡ç†

**å…‰æ ‡ä¼˜å…ˆçº§è¡¨**:
```typescript
const PRIORITIES = {
  'not-allowed': 10,  // ç¦æ­¢æ“ä½œ
  'wait': 9,          // ç­‰å¾…çŠ¶æ€
  'grabbing': 8,      // æ‹–æ‹½ä¸­
  '*-resize': 7,      // è°ƒæ•´å¤§å°
  'grab': 6,          // å¯æ‹–æ‹½
  'crosshair': 5,     // æ¡†é€‰
  'pointer': 2,       // å¯ç‚¹å‡»
  'default': 1        // é»˜è®¤
}
```

**å †æ ˆæœºåˆ¶**:
- æ¯ä¸ªå…‰æ ‡è®¾ç½®åŒ…å«ï¼šç±»å‹ã€ä¼˜å…ˆçº§ã€æ¥æº
- è‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§æ’åº
- ç§»é™¤ç‰¹å®šæ¥æºçš„å…‰æ ‡è®¾ç½®
- é”å®šæœºåˆ¶é˜²æ­¢æ„å¤–è¦†ç›–

## ğŸ”„ æ•°æ®æµæ¶æ„

```
ç”¨æˆ·æ“ä½œ â†’ InteractionLayer â†’ InteractionManager
    â†“               â†“
  äº‹ä»¶åˆ†å‘      HitTestEngine â†â”€â”
    â†“               â†“           â”‚
çŠ¶æ€æ›´æ–°       ç¢°æ’æ£€æµ‹ç»“æœ      â”‚
    â†“               â†“           â”‚
SelectionManager  CursorManager â”‚
    â†“               â†“           â”‚
  é€‰æ‹©å˜åŒ–        å…‰æ ‡æ›´æ–°       â”‚
    â†“               â†“           â”‚
   å›è°ƒ           DOMæ›´æ–°       â”‚
    â†“                           â”‚
ä¸šåŠ¡é€»è¾‘æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ ç»„ä»¶é›†æˆç­–ç•¥

### åŸæœ‰æ¶æ„ (æœ‰å†²çª)
```
Canvas
â”œâ”€â”€ ElementRenderer (ç‹¬ç«‹äº‹ä»¶å¤„ç†)
â”‚   â”œâ”€â”€ onMouseDown âŒ
â”‚   â”œâ”€â”€ onMouseMove âŒ  
â”‚   â””â”€â”€ cursorè®¾ç½® âŒ
â””â”€â”€ ResizeHandles (ç‹¬ç«‹äº‹ä»¶å¤„ç†)
    â”œâ”€â”€ onMouseDown âŒ
    â”œâ”€â”€ onMouseMove âŒ
    â””â”€â”€ cursorè®¾ç½® âŒ
```

### æ–°æ¶æ„ (ç»Ÿä¸€ç®¡ç†)
```
Canvas
â”œâ”€â”€ ElementRenderer (ä»…æ¸²æŸ“)
â”œâ”€â”€ SelectionIndicator (è§†è§‰æŒ‡ç¤º)
â””â”€â”€ InteractionLayer (ç»Ÿä¸€äº‹ä»¶å¤„ç†) âœ…
    â”œâ”€â”€ äº‹ä»¶æ•è· âœ…
    â”œâ”€â”€ çŠ¶æ€ç®¡ç† âœ…
    â””â”€â”€ å…‰æ ‡æ§åˆ¶ âœ…
```

## ğŸ” ç¢°æ’æ£€æµ‹ç®—æ³•

### ç®—æ³•æµç¨‹
```typescript
function performHitTest(point: Point): HitTestResult {
  // 1. æ£€æŸ¥ç¼“å­˜
  const cached = getCache(point);
  if (cached && !expired(cached)) return cached.result;
  
  // 2. ä¼˜å…ˆçº§æ£€æµ‹
  if (hasSelectedElements()) {
    // 2.1 Resize handles (æœ€é«˜ä¼˜å…ˆçº§)
    const handleHit = testResizeHandles(point);
    if (handleHit) return cacheAndReturn(handleHit);
    
    // 2.2 Drag zones (ä¸­ç­‰ä¼˜å…ˆçº§)
    const dragHit = testDragZones(point);  
    if (dragHit) return cacheAndReturn(dragHit);
  }
  
  // 2.3 Elements (ä½ä¼˜å…ˆçº§)
  const elementHit = testElements(point);
  if (elementHit) return cacheAndReturn(elementHit);
  
  // 2.4 Canvas background (é»˜è®¤)
  return cacheAndReturn({ type: 'canvas' });
}
```

### Resize Handleæ£€æµ‹
```typescript
// ä¸ºæ¯ä¸ªé€‰ä¸­å…ƒç´ è®¡ç®—8ä¸ªæ§åˆ¶ç‚¹
const handles = calculateResizeHandles(bounds);
const ordered = ['nw', 'ne', 'sw', 'se', 'n', 'e', 's', 'w'];

for (const direction of ordered) {
  const handle = handles[direction];
  if (pointInRect(point, handle.hitArea)) {
    return {
      type: 'resize-handle',
      direction,
      cursor: handle.cursor,
      priority: 1
    };
  }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¢°æ’æ£€æµ‹ä¼˜åŒ–
- **ç¼“å­˜æœºåˆ¶**: 16mså†…é‡å¤æŸ¥è¯¢ç›´æ¥è¿”å›ç¼“å­˜
- **ç©ºé—´åˆ†å‰²**: å¤§é‡å…ƒç´ æ—¶ä½¿ç”¨ç©ºé—´ç´¢å¼•
- **æ—©æœŸå‰ªæ**: ä¼˜å…ˆçº§åŒ¹é…åç«‹å³è¿”å›
- **è¾¹ç•Œé¢„è®¡ç®—**: resize handleä½ç½®é¢„è®¡ç®—å¹¶ç¼“å­˜

### 2. äº‹ä»¶å¤„ç†ä¼˜åŒ–  
- **äº‹ä»¶èŠ‚æµ**: mousemoveäº‹ä»¶é™åˆ¶åœ¨60fps
- **æ‰¹é‡æ›´æ–°**: çŠ¶æ€å˜åŒ–æ‰¹é‡æäº¤
- **é¿å…é‡æ’**: ä½¿ç”¨transformè€Œélayoutå±æ€§

### 3. å†…å­˜ç®¡ç†
- **è‡ªåŠ¨æ¸…ç†**: è¿‡æœŸç¼“å­˜è‡ªåŠ¨æ¸…ç†
- **å¼±å¼•ç”¨**: DOMå…ƒç´ ä½¿ç”¨WeakMapå­˜å‚¨
- **äº‹ä»¶è§£ç»‘**: ç»„ä»¶å¸è½½æ—¶æ¸…ç†ç›‘å¬å™¨

## ğŸ”’ ç±»å‹å®‰å…¨

### æ ¸å¿ƒç±»å‹å®šä¹‰
```typescript
// å‡ ä½•ç±»å‹
interface Point { x: number; y: number; }
interface Rectangle { x: number; y: number; width: number; height: number; }

// äº¤äº’çŠ¶æ€
enum InteractionMode {
  IDLE, HOVER_ELEMENT, SELECTED, 
  DRAGGING, RESIZING, BOX_SELECTING
}

// ç¢°æ’æ£€æµ‹ç»“æœ
interface HitTestResult {
  type: 'canvas' | 'element' | 'resize-handle' | 'drag-zone';
  priority: number;
  cursor: string;
  elementId?: string;
  direction?: HandleDirection;
  data?: any;
}
```

### ç±»å‹å®ˆå«
```typescript
function isResizeHandle(hit: HitTestResult): hit is ResizeHandleHit {
  return hit.type === 'resize-handle' && hit.direction != null;
}

function isDragZone(hit: HitTestResult): hit is DragZoneHit {
  return hit.type === 'drag-zone';
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- GeometryUtilså‡ ä½•è®¡ç®—å‡½æ•°
- BoundsCalculatorè¾¹ç•Œè®¡ç®—
- HitTestUtilsç¢°æ’æ£€æµ‹é€»è¾‘
- SelectionManageré€‰æ‹©çŠ¶æ€ç®¡ç†

### é›†æˆæµ‹è¯•  
- InteractionManagerçŠ¶æ€è½¬æ¢
- HitTestEngineä¼˜å…ˆçº§æ£€æµ‹
- CursorManagerå…‰æ ‡ç®¡ç†

### E2Eæµ‹è¯•
- æ‹–æ‹½æ“ä½œæµç¨‹
- å¤šé€‰å’Œæ¡†é€‰
- é”®ç›˜å¿«æ·é”®
- å…‰æ ‡çŠ¶æ€éªŒè¯

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### è°ƒè¯•æ¨¡å¼
```typescript
<InteractionLayer enableDebugMode={true} />
```

æ˜¾ç¤ºä¿¡æ¯:
- å½“å‰äº¤äº’æ¨¡å¼
- é¼ æ ‡ä½ç½®å’ŒçŠ¶æ€  
- ç¢°æ’æ£€æµ‹ç»“æœ
- é€‰æ‹©çŠ¶æ€
- å…‰æ ‡å †æ ˆ
- æ€§èƒ½æŒ‡æ ‡

### æ€§èƒ½ç›‘æ§
- ç¢°æ’æ£€æµ‹è€—æ—¶
- ç¼“å­˜å‘½ä¸­ç‡
- äº‹ä»¶å¤„ç†é¢‘ç‡
- å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ”® æœªæ¥æ‰©å±•

### è®¡åˆ’ä¸­çš„åŠŸèƒ½
1. **è§¦æ‘¸è®¾å¤‡æ”¯æŒ** - é€‚é…ç§»åŠ¨ç«¯äº¤äº’
2. **é”®ç›˜å¯¼èˆª** - æ— é¼ æ ‡æ“ä½œæ”¯æŒ
3. **æ’¤é”€é‡åš** - æ“ä½œå†å²ç®¡ç†
4. **å¸é™„å¯¹é½** - æ™ºèƒ½å¸é™„ç³»ç»Ÿ
5. **åä½œå†²çª** - å¤šç”¨æˆ·åä½œå¤„ç†

### æ‰©å±•ç‚¹
- è‡ªå®šä¹‰äº¤äº’æ¨¡å¼
- æ’ä»¶åŒ–ç¢°æ’æ£€æµ‹
- å¯é…ç½®çš„å¿«æ·é”®
- ä¸»é¢˜åŒ–å…‰æ ‡æ ·å¼

---

è¿™ä¸ªæ¶æ„æä¾›äº†ä¸€ä¸ªå¯æ‰©å±•ã€é«˜æ€§èƒ½ã€ç±»å‹å®‰å…¨çš„äº¤äº’ç³»ç»Ÿï¼Œå½»åº•è§£å†³äº†åŸæœ‰çš„äº‹ä»¶å†²çªå’Œå…‰æ ‡é—ªçƒé—®é¢˜ã€‚ğŸ‰