/**
 * ÂØπÈΩêÂàÜÂ∏ÉÂ∑•ÂÖ∑Ê†èÁªÑ‰ª∂
 * Êèê‰æõÊâÄÊúâÂØπÈΩêÂíåÂàÜÂ∏ÉÂäüËÉΩÁöÑUIÁïåÈù¢
 */

import { createSignal, Show } from 'solid-js';
import type { Component } from 'solid-js';
import { useAppContext } from '../../stores/AppContext';

// ÂÜÖËÅîÂØπÈΩêÁ±ªÂûãÂÆö‰πâÔºåÈÅøÂÖçÂ§ñÈÉ®ÂØºÂÖ•
enum AlignmentType {
  LEFT = 'left',
  RIGHT = 'right',
  TOP = 'top',
  BOTTOM = 'bottom',
  H_CENTER = 'h_center',
  V_CENTER = 'v_center',
  DISTRIBUTE_H = 'distribute_h',
  DISTRIBUTE_V = 'distribute_v'
}

// ÂÜÖËÅîÁÆÄÂåñÁöÑÂØπÈΩêÁÆóÊ≥ï
const calculateAlignment = (elements: any[], alignmentType: AlignmentType) => {
  if (elements.length < 2) return [];
  
  const bounds = elements.map(el => ({
    x: el.position.x,
    y: el.position.y,
    width: el.size.width,
    height: el.size.height
  }));
  
  return bounds.map((bound, index) => {
    let newX = bound.x;
    let newY = bound.y;
    
    switch (alignmentType) {
      case AlignmentType.LEFT:
        newX = Math.min(...bounds.map(b => b.x));
        break;
      case AlignmentType.RIGHT:
        const maxRight = Math.max(...bounds.map(b => b.x + b.width));
        newX = maxRight - bound.width;
        break;
      case AlignmentType.TOP:
        newY = Math.min(...bounds.map(b => b.y));
        break;
      case AlignmentType.BOTTOM:
        const maxBottom = Math.max(...bounds.map(b => b.y + b.height));
        newY = maxBottom - bound.height;
        break;
      case AlignmentType.H_CENTER:
        const centerX = bounds.reduce((sum, b) => sum + b.x + b.width/2, 0) / bounds.length;
        newX = centerX - bound.width/2;
        break;
      case AlignmentType.V_CENTER:
        const centerY = bounds.reduce((sum, b) => sum + b.y + b.height/2, 0) / bounds.length;
        newY = centerY - bound.height/2;
        break;
    }
    
    return {
      element_id: elements[index].id,
      new_position: { x: newX, y: newY }
    };
  });
};

interface AlignmentToolbarProps {
  selectedElementIds: () => string[];
  onAlignmentComplete?: (results: any) => void;
  onAlignmentPreview?: (alignmentType: AlignmentType) => void;
  onPreviewCancel?: () => void;
}

export const AlignmentToolbar: Component<AlignmentToolbarProps> = (props) => {
  const { batchUpdatePositions, state } = useAppContext();
  const [isAligning, setIsAligning] = createSignal(false);

  // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÊâßË°åÂØπÈΩêÊìç‰Ωú
  const canAlign = () => props.selectedElementIds().length >= 2;

  // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂÖÉÁ¥†
  const getSelectedElements = () => {
    const selectedIds = props.selectedElementIds();
    return state.elements.filter(el => selectedIds.includes(el.id));
  };

  // ÊâßË°åÂØπÈΩêÊìç‰Ωú
  const performAlignment = async (alignmentType: AlignmentType) => {
    const selectedElements = getSelectedElements();
    if (selectedElements.length < 2) {
      console.warn('ÂØπÈΩêÂäüËÉΩÈúÄË¶ÅËá≥Â∞ë2‰∏™ÂÖÉÁ¥†');
      return;
    }

    try {
      setIsAligning(true);
      console.log(`üéØ ÊâßË°å${alignmentType}ÂØπÈΩê:`, selectedElements.length, '‰∏™ÂÖÉÁ¥†');

      // ‰ΩøÁî®ÂÜÖËÅîÁÆóÊ≥ïËÆ°ÁÆóÂØπÈΩêÁªìÊûú
      const positionUpdates = calculateAlignment(selectedElements, alignmentType);
      
      // ÊâßË°åÊâπÈáè‰ΩçÁΩÆÊõ¥Êñ∞
      await batchUpdatePositions(positionUpdates);
      
      console.log('‚úÖ ÂØπÈΩêÊìç‰ΩúÂÆåÊàê');
      
      // ÈÄöÁü•Â§ñÈÉ®ÁªÑ‰ª∂
      if (props.onAlignmentComplete) {
        props.onAlignmentComplete(positionUpdates);
      }

    } catch (error) {
      console.error('‚ùå ÂØπÈΩêÊìç‰ΩúÂ§±Ë¥•:', error);
    } finally {
      setIsAligning(false);
    }
  };

  // Ëé∑ÂèñÊô∫ËÉΩÂØπÈΩêÂª∫ËÆÆÔºàÁÆÄÂåñÁâàÊú¨Ôºâ
  const getSmartSuggestion = () => {
    const selectedElements = getSelectedElements();
    if (selectedElements.length < 2) return null;

    return {
      recommended: AlignmentType.LEFT,
      reason: 'Âª∫ËÆÆÂ∑¶ÂØπÈΩê',
      results: []
    };
  };

  const smartSuggestion = () => getSmartSuggestion();

  return (
    <div class="alignment-toolbar">
      <div class="toolbar-section">
        <div class="section-title">ÂØπÈΩê</div>
        <div class="button-group">
          {/* Â∑¶ÂØπÈΩê */}
          <button
            class="align-button left"
            disabled={!canAlign() || isAligning()}
            onClick={() => performAlignment(AlignmentType.LEFT)}
            title="Â∑¶ÂØπÈΩê"
          >
            <div class="align-icon">
              <div class="line left-line"></div>
              <div class="shapes">
                <div class="shape"></div>
                <div class="shape"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>

          {/* Ê∞¥Âπ≥Â±Ö‰∏≠ÂØπÈΩê */}
          <button
            class="align-button h-center"
            disabled={!canAlign() || isAligning()}
            onClick={() => performAlignment(AlignmentType.H_CENTER)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.H_CENTER)}
            title="Ê∞¥Âπ≥Â±Ö‰∏≠ÂØπÈΩê"
          >
            <div class="align-icon">
              <div class="line center-line"></div>
              <div class="shapes">
                <div class="shape"></div>
                <div class="shape"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>

          {/* Âè≥ÂØπÈΩê */}
          <button
            class="align-button right"
            disabled={!canAlign() || isAligning()}
            onClick={() => performAlignment(AlignmentType.RIGHT)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.RIGHT)}
            title="Âè≥ÂØπÈΩê"
          >
            <div class="align-icon">
              <div class="line right-line"></div>
              <div class="shapes">
                <div class="shape"></div>
                <div class="shape"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>
        </div>
      </div>

      <div class="toolbar-section">
        <div class="section-title">ÂûÇÁõ¥ÂØπÈΩê</div>
        <div class="button-group">
          {/* È°∂ÈÉ®ÂØπÈΩê */}
          <button
            class="align-button top"
            disabled={!canAlign() || isAligning()}
            onClick={() => performAlignment(AlignmentType.TOP)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.TOP)}
            title="È°∂ÈÉ®ÂØπÈΩê"
          >
            <div class="align-icon vertical">
              <div class="line top-line"></div>
              <div class="shapes vertical">
                <div class="shape"></div>
                <div class="shape"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>

          {/* ÂûÇÁõ¥Â±Ö‰∏≠ÂØπÈΩê */}
          <button
            class="align-button v-center"
            disabled={!canAlign() || isAligning()}
            onClick={() => performAlignment(AlignmentType.V_CENTER)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.V_CENTER)}
            title="ÂûÇÁõ¥Â±Ö‰∏≠ÂØπÈΩê"
          >
            <div class="align-icon vertical">
              <div class="line v-center-line"></div>
              <div class="shapes vertical">
                <div class="shape"></div>
                <div class="shape"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>

          {/* Â∫ïÈÉ®ÂØπÈΩê */}
          <button
            class="align-button bottom"
            disabled={!canAlign() || isAligning()}
            onClick={() => performAlignment(AlignmentType.BOTTOM)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.BOTTOM)}
            title="Â∫ïÈÉ®ÂØπÈΩê"
          >
            <div class="align-icon vertical">
              <div class="line bottom-line"></div>
              <div class="shapes vertical">
                <div class="shape"></div>
                <div class="shape"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>
        </div>
      </div>

      <div class="toolbar-section">
        <div class="section-title">ÂàÜÂ∏É</div>
        <div class="button-group">
          {/* Ê∞¥Âπ≥ÂàÜÂ∏É */}
          <button
            class="align-button distribute-h"
            disabled={props.selectedElementIds().length < 3 || isAligning()}
            onClick={() => performAlignment(AlignmentType.DISTRIBUTE_H)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.DISTRIBUTE_H)}
            title="Ê∞¥Âπ≥ÂùáÂåÄÂàÜÂ∏É"
          >
            <div class="align-icon">
              <div class="shapes distribute">
                <div class="shape"></div>
                <div class="spacer"></div>
                <div class="shape"></div>
                <div class="spacer"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>

          {/* ÂûÇÁõ¥ÂàÜÂ∏É */}
          <button
            class="align-button distribute-v"
            disabled={props.selectedElementIds().length < 3 || isAligning()}
            onClick={() => performAlignment(AlignmentType.DISTRIBUTE_V)}
            onMouseEnter={() => props.onAlignmentPreview?.(AlignmentType.DISTRIBUTE_V)}
            title="ÂûÇÁõ¥ÂùáÂåÄÂàÜÂ∏É"
          >
            <div class="align-icon vertical">
              <div class="shapes distribute vertical">
                <div class="shape"></div>
                <div class="spacer"></div>
                <div class="shape"></div>
                <div class="spacer"></div>
                <div class="shape"></div>
              </div>
            </div>
          </button>
        </div>
      </div>

      {/* Êô∫ËÉΩÂª∫ËÆÆ */}
      <Show when={canAlign() && smartSuggestion()}>
        <div class="toolbar-section">
          <div class="section-title">Êô∫ËÉΩÂª∫ËÆÆ</div>
          <button
            class="smart-align-button"
            disabled={isAligning()}
            onClick={() => performAlignment(smartSuggestion()!.recommended)}
            title={smartSuggestion()!.reason}
          >
            <div class="smart-icon">üéØ</div>
            <div class="smart-text">
              {smartSuggestion()!.recommended === AlignmentType.LEFT && 'Â∑¶ÂØπÈΩê'}
              {smartSuggestion()!.recommended === AlignmentType.RIGHT && 'Âè≥ÂØπÈΩê'}
              {smartSuggestion()!.recommended === AlignmentType.TOP && 'È°∂ÂØπÈΩê'}
              {smartSuggestion()!.recommended === AlignmentType.BOTTOM && 'Â∫ïÂØπÈΩê'}
              {smartSuggestion()!.recommended === AlignmentType.H_CENTER && 'Ê∞¥Âπ≥Â±Ö‰∏≠'}
              {smartSuggestion()!.recommended === AlignmentType.V_CENTER && 'ÂûÇÁõ¥Â±Ö‰∏≠'}
            </div>
          </button>
          <div class="smart-reason">{smartSuggestion()!.reason}</div>
        </div>
      </Show>

      {/* Áä∂ÊÄÅÊåáÁ§∫ */}
      <Show when={!canAlign()}>
        <div class="toolbar-status">
          <div class="status-text">
            ÈÄâÊã©Ëá≥Â∞ë2‰∏™ÂÖÉÁ¥†‰ª•‰ΩøÁî®ÂØπÈΩêÂäüËÉΩ
            {props.selectedElementIds().length < 3 && "ÔºåËá≥Â∞ë3‰∏™ÂÖÉÁ¥†‰ª•‰ΩøÁî®ÂàÜÂ∏ÉÂäüËÉΩ"}
          </div>
        </div>
      </Show>

      <Show when={isAligning()}>
        <div class="toolbar-status">
          <div class="status-text aligning">
            <div class="spinner"></div>
            Ê≠£Âú®ÊâßË°åÂØπÈΩêÊìç‰Ωú...
          </div>
        </div>
      </Show>

    </div>
  );
};

// CSSÊ†∑ÂºèÔºàÂÜÖÂµåÔºâ
const alignmentStyles = `
.alignment-toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 280px;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.button-group {
  display: flex;
  gap: 4px;
}

.align-button {
  width: 36px;
  height: 36px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

.align-button:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.align-button:active:not(:disabled) {
  transform: translateY(0);
  background: #e5e7eb;
}

.align-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.align-icon {
  position: relative;
  width: 20px;
  height: 16px;
}

.align-icon.vertical {
  width: 16px;
  height: 20px;
}

.line {
  position: absolute;
  background: #3b82f6;
  z-index: 2;
}

.left-line, .right-line, .center-line {
  width: 2px;
  height: 16px;
  top: 0;
}

.left-line { left: 2px; }
.right-line { right: 2px; }
.center-line { left: 9px; }

.top-line, .bottom-line, .v-center-line {
  height: 2px;
  width: 16px;
  left: 0;
}

.top-line { top: 2px; }
.bottom-line { bottom: 2px; }
.v-center-line { top: 9px; }

.shapes {
  display: flex;
  gap: 2px;
  align-items: flex-start;
}

.shapes.vertical {
  flex-direction: column;
  height: 100%;
  align-items: flex-start;
}

.shapes.distribute {
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.shapes.distribute.vertical {
  height: 100%;
  width: auto;
}

.shape {
  width: 4px;
  height: 6px;
  background: #6b7280;
  border-radius: 1px;
}

.shapes.vertical .shape {
  width: 6px;
  height: 4px;
}

.spacer {
  width: 2px;
  height: 1px;
  background: #d1d5db;
}

.shapes.distribute.vertical .spacer {
  width: 1px;
  height: 2px;
}

.smart-align-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.smart-align-button:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.smart-align-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.smart-icon {
  font-size: 16px;
}

.smart-text {
  font-size: 14px;
  font-weight: 500;
}

.smart-reason {
  font-size: 11px;
  color: #6b7280;
  font-style: italic;
  margin-top: 4px;
}

.toolbar-status {
  padding: 8px;
  border-radius: 4px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
}

.status-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.status-text.aligning {
  color: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.spinner {
  width: 12px;
  height: 12px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.preview-info {
  padding: 6px 8px;
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
}

.preview-text {
  font-size: 11px;
  color: #1d4ed8;
  text-align: center;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;

// Ê≥®ÂÖ•Ê†∑Âºè
if (typeof document !== 'undefined') {
  const styleElement = document.createElement('style');
  styleElement.textContent = alignmentStyles;
  document.head.appendChild(styleElement);
}